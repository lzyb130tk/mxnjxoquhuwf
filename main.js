

document.addEventListener('DOMContentLoaded', () => {

    // ========================================================================
    // === ğŸ”§ å…¨å±€DEBUGæ§åˆ¶ç³»ç»Ÿ (ä¸€é”®å…³é—­æ‰€æœ‰æ—¥å¿—) ===
    // ========================================================================
    window.DEBUG_MODE = false; // âœ… æ”¹ä¸º false å…³é—­æ‰€æœ‰æ—¥å¿—, true å¼€å¯
    
    // åˆ›å»ºæ™ºèƒ½æ—¥å¿—å‡½æ•°
    window.debugLog = function(...args) {
        if (window.DEBUG_MODE) {
            console.log(...args);
        }
    };
    
    window.debugWarn = function(...args) {
        if (window.DEBUG_MODE) {
            console.warn(...args);
        }
    };
    
    window.debugError = function(...args) {
        // é”™è¯¯æ—¥å¿—å§‹ç»ˆæ˜¾ç¤ºï¼Œä¸å—DEBUG_MODEæ§åˆ¶
        console.error(...args);
    };

    // === iOS PWA å¹³å°æ£€æµ‹ ===
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone === true;
    
    if (isIOS) {
        document.body.classList.add('ios-optimize-mode');
    }

    if (isIOS && isStandalone) {
        document.body.classList.add('is-ios-pwa');
        debugLog('ğŸ“± iOS PWA æ¨¡å¼å·²å¯ç”¨'); // âœ… æ”¹ä¸ºä½¿ç”¨debugLog
    }

    // ========================================================================
    // === ğŸ iOS PWA å®‰å…¨åŒºä¿®å¤ï¼šç”¨æˆ·å¯è°ƒèŠ‚çš„è´Ÿmarginæ–¹æ³• ===
    // ========================================================================
    const IOS_MARGIN_KEY = 'ios_safe_area_margin';
    
    // ä»localStorageè¯»å–ç”¨æˆ·è®¾ç½®çš„marginå€¼ï¼Œé»˜è®¤0px
    const savedMargin = localStorage.getItem(IOS_MARGIN_KEY);
    const iosMarginValue = savedMargin ? parseInt(savedMargin) : 0;
    
    // åº”ç”¨iOSå®‰å…¨åŒºmarginçš„å‡½æ•°
    // é˜²æŠ–è®¡æ—¶å™¨ï¼Œé¿å…é¢‘ç¹è°ƒç”¨å¯¼è‡´å´©æºƒ
    let iosMarginUpdateTimer = null;
    
    window.applyIOSSafeAreaMargin = function(value) {
        // 1. é™åˆ¶å€¼èŒƒå›´ï¼Œé˜²æ­¢å´©æºƒï¼ˆ-300åˆ°300pxï¼‰
        const clampedValue = Math.max(-300, Math.min(300, parseInt(value) || 0));
        const marginPx = clampedValue + 'px';
        
        // 2. é˜²æŠ–ï¼šå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è°ƒç”¨
        if (iosMarginUpdateTimer) {
            clearTimeout(iosMarginUpdateTimer);
        }
        
        iosMarginUpdateTimer = setTimeout(() => {
            try {
                // åˆ›å»ºæˆ–æ›´æ–°CSSå˜é‡
                document.documentElement.style.setProperty('--ios-safe-margin', marginPx);
                
                // ç›´æ¥æ›´æ–°styleæ ‡ç­¾ï¼ˆç¡®ä¿å®æ—¶ç”Ÿæ•ˆï¼‰
                let styleEl = document.getElementById('ios-safe-area-style');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'ios-safe-area-style';
                    document.head.appendChild(styleEl);
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±æ¨¡å¼
                const isFullscreen = document.body.classList.contains('fullscreen-mode');
                
                // æ„å»ºCSSï¼šåŒæ—¶å¤„ç†èƒŒæ™¯å»¶ä¼¸å’Œå†…å®¹åŒºåŸŸé«˜åº¦
                // 1. è®© html/body å’Œ #global-wallpaper èƒŒæ™¯å»¶ä¼¸åˆ°å®‰å…¨åŒºä¸‹æ–¹ï¼Œè¦†ç›–ç™½è‰²èƒŒæ™¯
                // 2. è°ƒæ•´ phone-frame çš„é«˜åº¦ï¼Œè®©å†…å®¹è¢«å¾€ä¸‹æ¨ï¼Œè€Œä¸æ˜¯é¡¶æ è¢«å¾€ä¸ŠæŒ¤
                // åŸç†ï¼šæ­£å€¼å‡å°é«˜åº¦ï¼ˆå†…å®¹å¾€ä¸‹æ¨ï¼‰ï¼Œè´Ÿå€¼å¢åŠ é«˜åº¦ï¼ˆå†…å®¹å¾€ä¸Šæ¨ï¼‰
                const operator = clampedValue >= 0 ? '-' : '+';
                const absValue = Math.abs(clampedValue);
                const calcValue = `${operator} ${absValue}px`;
                
                // èƒŒæ™¯å»¶ä¼¸é€»è¾‘ï¼šå§‹ç»ˆå‘ä¸‹å»¶ä¼¸è¶³å¤Ÿè·ç¦»ï¼Œè¦†ç›–å®‰å…¨åŒºç™½è‰²èƒŒæ™¯
                // ä½¿ç”¨ä¸€ä¸ªè¾ƒå¤§çš„å›ºå®šå€¼ï¼ˆæ¯”å¦‚ 100pxï¼‰ç¡®ä¿è¦†ç›–å®‰å…¨åŒºï¼Œä¸å—ç”¨æˆ·è®¾ç½®å½±å“
                const bgExtensionPx = 100; // å›ºå®šå»¶ä¼¸ 100pxï¼Œç¡®ä¿è¦†ç›–å®‰å…¨åŒº
                const bgMarginValue = `-${bgExtensionPx}px`;
                const bgPaddingValue = `${bgExtensionPx}px`;
                
                let cssContent = `
                    /* è®© html/body èƒŒæ™¯å»¶ä¼¸åˆ°å®‰å…¨åŒºä¸‹æ–¹ï¼Œè¦†ç›–ç™½è‰²èƒŒæ™¯ï¼ˆå›ºå®šå»¶ä¼¸ï¼Œä¸å—ç”¨æˆ·è®¾ç½®å½±å“ï¼‰ */
                    html.is-ios-pwa-html {
                        margin-bottom: ${bgMarginValue} !important;
                        padding-bottom: ${bgPaddingValue} !important;
                    }
                    body.is-ios-pwa {
                        margin-bottom: ${bgMarginValue} !important;
                        padding-bottom: ${bgPaddingValue} !important;
                    }
                    /* å…³é”®ï¼šè®© #global-wallpaper ä¹Ÿå»¶ä¼¸åˆ°å®‰å…¨åŒºä¸‹æ–¹ï¼Œè¦†ç›–ç™½è‰²èƒŒæ™¯ */
                    #global-wallpaper {
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        right: 0 !important;
                        bottom: ${bgMarginValue} !important;
                        width: 100vw !important;
                        height: calc(100vh + ${bgExtensionPx}px) !important;
                        height: calc(100dvh + ${bgExtensionPx}px) !important;
                        z-index: -1 !important;
                        background-size: cover !important;
                        background-position: center !important;
                        background-repeat: no-repeat !important;
                    }
                    /* è°ƒæ•´ phone-frame çš„é«˜åº¦ */
                    body.is-ios-pwa .phone-frame {
                        height: calc(100dvh - env(safe-area-inset-bottom) ${calcValue}) !important;
                        max-height: calc(100dvh - env(safe-area-inset-bottom) ${calcValue}) !important;
                    }
                `;
                
                // å…¨å±æ¨¡å¼ä¸‹çš„é¢å¤–å¤„ç†
                if (isFullscreen) {
                    cssContent += `
                    body.is-ios-pwa.fullscreen-mode .phone-frame {
                        height: calc(100dvh - env(safe-area-inset-bottom) ${calcValue}) !important;
                        max-height: calc(100dvh - env(safe-area-inset-bottom) ${calcValue}) !important;
                    }
                    `;
                }
                
                styleEl.textContent = cssContent;
                debugLog('ğŸ iOSå®‰å…¨åŒºmarginå·²æ›´æ–°:', marginPx, isFullscreen ? '(å…¨å±æ¨¡å¼)' : '');
            } catch (error) {
                console.error('åº”ç”¨iOSå®‰å…¨åŒºmarginå¤±è´¥:', error);
            }
        }, 100); // 100ms é˜²æŠ–å»¶è¿Ÿ
    };
    
    // iOS PWAæ¨¡å¼ä¸‹ï¼Œç»™htmlæ·»åŠ classå¹¶åº”ç”¨margin
    if (isIOS && isStandalone) {
        document.documentElement.classList.add('is-ios-pwa-html');
        window.applyIOSSafeAreaMargin(iosMarginValue);
        debugLog('ğŸ iOS PWAæ¨¡å¼ï¼šå·²æ·»åŠ  is-ios-pwa-html classï¼Œmargin=' + iosMarginValue + 'px');
    }
    
    // iOSè®¾ç½®é¡µé¢é€»è¾‘
    const navToIosSettings = document.getElementById('nav-to-ios-settings');
    const iosSettingsScreen = document.getElementById('ios-settings-screen');
    const iosSettingsBackBtn = document.getElementById('ios-settings-back-button');
    const iosMarginSlider = document.getElementById('ios-margin-slider');
    const iosMarginDisplay = document.getElementById('ios-margin-display');
    
    // é¢„è®¾æŒ‰é’®
    const presets = {
        'ios-preset-30': 30,
        'ios-preset-50': 50,
        'ios-preset-60': 60,
        'ios-preset-70': 70
    };
    
    // åˆå§‹åŒ–æ»‘å—å€¼
    if (iosMarginSlider && iosMarginDisplay) {
        let currentValue = parseInt(localStorage.getItem(IOS_MARGIN_KEY) || '0');
        // ç¡®ä¿å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ-300åˆ°300ï¼‰
        currentValue = Math.max(-300, Math.min(300, currentValue));
        iosMarginSlider.value = currentValue;
        iosMarginDisplay.textContent = currentValue + 'px';
        
        // æ»‘å—å˜åŒ–äº‹ä»¶
        iosMarginSlider.addEventListener('input', function() {
            const value = this.value;
            iosMarginDisplay.textContent = value + 'px';
            // å®æ—¶æ›´æ–°CSS
            window.applyIOSSafeAreaMargin(parseInt(value));
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem(IOS_MARGIN_KEY, value);
        });
    }
    
    // é¢„è®¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    Object.keys(presets).forEach(function(id) {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', function() {
                const value = presets[id];
                if (iosMarginSlider) iosMarginSlider.value = value;
                if (iosMarginDisplay) iosMarginDisplay.textContent = value + 'px';
                window.applyIOSSafeAreaMargin(value);
                localStorage.setItem(IOS_MARGIN_KEY, value.toString());
            });
        }
    });
    
    // å¯¼èˆªåˆ°iOSè®¾ç½®é¡µé¢
    if (navToIosSettings && iosSettingsScreen) {
        navToIosSettings.addEventListener('click', function() {
            // ä½¿ç”¨ .opened ç±»ï¼Œä¸å…¶ä»–å­é¡µé¢ä¿æŒä¸€è‡´
            iosSettingsScreen.classList.add('opened');
        });
    }
    
    // è¿”å›è®¾ç½®é¡µé¢
    if (iosSettingsBackBtn && iosSettingsScreen) {
        iosSettingsBackBtn.addEventListener('click', function() {
            iosSettingsScreen.classList.remove('opened');
        });
    }


    // ========================================================================
    // === ğŸ§¹ å…¨å±€ DOM æ¸…ç†ç³»ç»Ÿ (Step 2: é˜²æ­¢å†…å­˜æ³„æ¼çš„æ ¸å¿ƒä¼˜åŒ–) ===
    // ========================================================================
    /**
     * ç”¨äºè¿½è¸ªéœ€è¦æ¸…ç†çš„å¤§å®¹å™¨,åœ¨é¡µé¢/æ¨¡æ€æ¡†å…³é—­æ—¶è‡ªåŠ¨æ¸…ç©º DOM
     * è§£å†³"ç”¨ç€ç”¨ç€å°±å´©"é—®é¢˜çš„æ ¹æœ¬æ–¹æ³•
     */
    window.DOMCleanupManager = {
        // æ³¨å†Œè¡¨:è®°å½•æ‰€æœ‰éœ€è¦æ¸…ç†çš„å®¹å™¨ { å®¹å™¨ID: { å®¹å™¨å…ƒç´ , æ¸…ç†å›è°ƒ } }
        registry: new Map(),

        /**
         * æ³¨å†Œä¸€ä¸ªéœ€è¦è‡ªåŠ¨æ¸…ç†çš„å®¹å™¨
         * @param {string} containerId - å®¹å™¨çš„ ID
         * @param {Function} cleanupCallback - å¯é€‰çš„é¢å¤–æ¸…ç†å›è°ƒå‡½æ•°
         */
        register(containerId, cleanupCallback = null) {
            const container = document.getElementById(containerId);
            if (container) {
                this.registry.set(containerId, { element: container, callback: cleanupCallback });
                console.log(`[DOMæ¸…ç†ç³»ç»Ÿ] å·²æ³¨å†Œå®¹å™¨: ${containerId}`);
            }
        },

        /**
         * æ¸…ç©ºæŒ‡å®šå®¹å™¨çš„ DOM (ç‰©ç†åˆ é™¤,é‡Šæ”¾å†…å­˜)
         * @param {string} containerId - å®¹å™¨çš„ ID
         */
        clean(containerId) {
            const entry = this.registry.get(containerId);
            if (!entry) {
                debugWarn(`[DOMæ¸…ç†ç³»ç»Ÿ] å®¹å™¨æœªæ³¨å†Œ: ${containerId}`);
                return;
            }

            const { element, callback } = entry;
            
            // 1. æ‰§è¡Œè‡ªå®šä¹‰æ¸…ç†å›è°ƒ (å¦‚æœæœ‰)
            if (callback && typeof callback === 'function') {
                try {
                    callback(element);
                } catch (e) {
                    debugError(`[DOMæ¸…ç†ç³»ç»Ÿ] æ¸…ç†å›è°ƒæ‰§è¡Œå¤±è´¥ (${containerId}):`, e);
                }
            }

            // 2. ç‰©ç†æ¸…ç©º DOM
            if (element) {
                element.innerHTML = '';
                debugLog(`[DOMæ¸…ç†ç³»ç»Ÿ] âœ… å·²æ¸…ç©º: ${containerId}`);
            }

            // 3. å°è¯•è§¦å‘åƒåœ¾å›æ”¶æç¤º (ä»…iOS)
            if (isIOS && window.gc) {
                try { window.gc(); } catch(e) {}
            }
        },

        /**
         * æ‰¹é‡æ¸…ç†å¤šä¸ªå®¹å™¨
         * @param {Array<string>} containerIds - å®¹å™¨ ID æ•°ç»„
         */
        cleanMultiple(containerIds) {
            containerIds.forEach(id => this.clean(id));
        },

        /**
         * æ·±åº¦æ¸…ç†:æ¸…ç©ºå®¹å™¨å¹¶ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
         * @param {string} containerId - å®¹å™¨çš„ ID
         */
        deepClean(containerId) {
            const entry = this.registry.get(containerId);
            if (!entry) return;

            const { element } = entry;
            if (!element) return;

            // 1. å…‹éš†å…ƒç´ (è‡ªåŠ¨ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨)
            const cleanClone = element.cloneNode(false);
            element.parentNode.replaceChild(cleanClone, element);
            
            // 2. æ›´æ–°æ³¨å†Œè¡¨
            this.registry.set(containerId, { element: cleanClone, callback: entry.callback });
            
            console.log(`[DOMæ¸…ç†ç³»ç»Ÿ] âœ… æ·±åº¦æ¸…ç†å®Œæˆ: ${containerId}`);
        }
    };

    // ========================================================================
// === â° å…¨å±€è®¡æ—¶å™¨ç®¡ç†ç³»ç»Ÿ (Step 3: é˜²æ­¢è®¡æ—¶å™¨æ³„æ¼) ===
// ========================================================================
window.TimerManager = {
  // æ³¨å†Œè¡¨: { æ ‡ç­¾: [timerId1, timerId2, ...] }
  timers: new Map(),

  /**
   * åˆ›å»ºä¸€ä¸ªè¢«ç®¡ç†çš„ setTimeout
   * @param {Function} callback - å›è°ƒå‡½æ•°
   * @param {number} delay - å»¶è¿Ÿæ—¶é—´(ms)
   * @param {string} tag - æ ‡ç­¾(ç”¨äºåˆ†ç»„æ¸…ç†)
   */
  setTimeout(callback, delay, tag = "default") {
    const timerId = setTimeout(() => {
      callback();
      this.remove(timerId, tag); // æ‰§è¡Œåè‡ªåŠ¨ç§»é™¤
    }, delay);

    this.register(timerId, tag);
    return timerId;
  },

  /**
   * åˆ›å»ºä¸€ä¸ªè¢«ç®¡ç†çš„ setInterval
   * @param {Function} callback - å›è°ƒå‡½æ•°
   * @param {number} interval - é—´éš”æ—¶é—´(ms)
   * @param {string} tag - æ ‡ç­¾(ç”¨äºåˆ†ç»„æ¸…ç†)
   */
  setInterval(callback, interval, tag = "default") {
    const timerId = setInterval(callback, interval);
    this.register(timerId, tag);
    return timerId;
  },

  /**
   * æ³¨å†Œä¸€ä¸ªå·²å­˜åœ¨çš„è®¡æ—¶å™¨
   */
  register(timerId, tag = "default") {
    if (!this.timers.has(tag)) {
      this.timers.set(tag, []);
    }
    this.timers.get(tag).push(timerId);
    debugLog(`[è®¡æ—¶å™¨ç³»ç»Ÿ] å·²æ³¨å†Œ: ${tag} (#${timerId})`);
  },

  /**
   * ç§»é™¤å•ä¸ªè®¡æ—¶å™¨
   */
  remove(timerId, tag) {
    if (!this.timers.has(tag)) return;
    const arr = this.timers.get(tag);
    const index = arr.indexOf(timerId);
    if (index > -1) {
      arr.splice(index, 1);
    }
  },

  /**
   * æ¸…ç†æŒ‡å®šæ ‡ç­¾çš„æ‰€æœ‰è®¡æ—¶å™¨
   */
  clear(tag) {
    if (!this.timers.has(tag)) {
      debugWarn(`[è®¡æ—¶å™¨ç³»ç»Ÿ] æ ‡ç­¾ä¸å­˜åœ¨: ${tag}`);
      return;
    }

    const timerIds = this.timers.get(tag);
    timerIds.forEach((id) => {
      clearTimeout(id); // setTimeoutå’ŒsetIntervaléƒ½å¯ä»¥ç”¨clearTimeout
      clearInterval(id);
    });

    debugLog(`[è®¡æ—¶å™¨ç³»ç»Ÿ] âœ… å·²æ¸…ç† ${timerIds.length} ä¸ªè®¡æ—¶å™¨: ${tag}`);
    this.timers.delete(tag);
  },

  /**
   * æ‰¹é‡æ¸…ç†å¤šä¸ªæ ‡ç­¾
   */
  clearMultiple(tags) {
    tags.forEach((tag) => this.clear(tag));
  },

  /**
   * æ¸…ç†æ‰€æœ‰è®¡æ—¶å™¨
   */
  clearAll() {
    let totalCount = 0;
    this.timers.forEach((timerIds, tag) => {
      timerIds.forEach((id) => {
        clearTimeout(id);
        clearInterval(id);
      });
      totalCount += timerIds.length;
    });

    debugLog(`[è®¡æ—¶å™¨ç³»ç»Ÿ] âœ… å·²æ¸…ç†æ‰€æœ‰è®¡æ—¶å™¨ (å…±${totalCount}ä¸ª)`);
    this.timers.clear();
  },
};

    // ========================================================================
    // === è‡ªåŠ¨æ³¨å†Œéœ€è¦æ¸…ç†çš„æ ¸å¿ƒå®¹å™¨ ===
    // ========================================================================
    // è¿™äº›å®¹å™¨åœ¨é¡µé¢å…³é—­æ—¶ä¼šè‡ªåŠ¨è¢«æ¸…ç©º,é˜²æ­¢å†…å­˜æ³„æ¼
    const containersToRegister = [
        // èŠå¤©ç›¸å…³ (æœ€åƒå†…å­˜)
        'chat-messages-container',
        'contact-list',
        'forward-target-list',
        
        // è¯¦æƒ…é¡µ/å†å²è®°å½•
        'summary-detail-container',
        'summary-list-container',
        'dating-history-container',
        'transactions-list-container',
        'orders-list-container',
        
        // ç¤¾äº¤App
        'qilang-feed-container',
        'qilang-detail-comments',
        'gacha-posts-container',
        'wow-feed-container',
        'wow-detail-comments',
        
        // è´­ç‰©/æ¸¸æˆ
        'product-grid',
        'cart-items-container',
        'recipient-list-container',
        
        // è®¾ç½®é¡µé¢
        'worldbook-list',
        'worldbook-groups-list',
        'books-in-group-list',
        'style-presets-container',
        'font-url-list-container',
        
        // VNå¼•æ“
        'vn-choices-container',
        
        // å¼¹çª—å†…å®¹
        'shopper-list-container',
        'summon-ai-list-container',
        'worldbook-visibility-list'
    ];

    // æ³¨å†Œæ‰€æœ‰å®¹å™¨
    containersToRegister.forEach(id => {
        window.DOMCleanupManager.register(id);
    });

    console.log(`[DOMæ¸…ç†ç³»ç»Ÿ] å·²æ³¨å†Œ ${containersToRegister.length} ä¸ªæ ¸å¿ƒå®¹å™¨`);
    // ======================================================================== 


    // ==========================================================
    // === UI ç¾åŒ–é…ç½®ï¼šç³»ç»Ÿçº§åŠ è½½é®ç½©æ ·å¼ ===
    // ==========================================================
    const SYSTEM_LOADER_CSS = `
<style>
    /* é®ç½©å±‚ï¼šé«˜æ–¯æ¨¡ç³Š + è½»å¾®å˜æš— */
    .system-loader-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        z-index: 9999;
        display: flex; justify-content: center; align-items: center;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
        opacity: 0; animation: fadeIn 0.3s forwards;
    }

    /* å¡ç‰‡ä¸»ä½“ï¼šä»¿ iOS å¼¹çª— */
    .system-loader-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 24px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 280px;
        text-align: center;
        transform: scale(0.9);
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    /* åŠ¨æ€å›¾æ ‡å®¹å™¨ */
    .loader-icon-wrapper {
        width: 50px; height: 50px; margin: 0 auto 15px;
        display: flex; align-items: center; justify-content: center;
        font-size: 28px;
    }

    /* æ—‹è½¬åŠ¨ç”»åœˆåœˆ (ç”¨äºå¯¼å…¥) */
    .spinner-ios {
        width: 32px; height: 32px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-top: 3px solid #007AFF;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* è·³åŠ¨åŠ¨ç”» (ç”¨äºå¤‡ä»½æ‰“åŒ…) */
    .bounce-icon { animation: bounce 1.5s infinite; }

    /* æ ‡é¢˜æ–‡å­— */
    .loader-title {
        font-size: 17px; font-weight: 600; color: #000; margin-bottom: 8px;
    }

    /* çŠ¶æ€æè¿°æ–‡å­— */
    .loader-desc {
        font-size: 13px; color: #8e8e93; margin-bottom: 15px; min-height: 16px;
    }

    /* è¿›åº¦æ¡å®¹å™¨ */
    .progress-track {
        width: 100%; height: 6px; background: #E5E5EA;
        border-radius: 10px; overflow: hidden;
    }

    /* è¿›åº¦æ¡å¡«å…… */
    .progress-fill {
        height: 100%; background: #007AFF; width: 0%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    /* åŠ¨ç”»å…³é”®å¸§ */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
</style>
`;



    // =================================================
    // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ‰€æœ‰ const å’Œ let å˜é‡å£°æ˜ï¼Œå¿…é¡»æ”¾åœ¨æœ€å‰é¢
    // =================================================
    // --- 1. å…¨å±€å˜é‡åŒº ---
    // =================================================================
    // === å“‡å‘œ (Wow) APP æ ¸å¿ƒé€»è¾‘å¼•æ“ (ç‹¬ç«‹å‘½åç©ºé—´) ===
    // =================================================================
    // 1. è·å– DOM å…ƒç´ 
    // === å“‡å‘œï¼šå›åˆ°é¡¶éƒ¨åŠŸèƒ½ ===

    const wowAppIcon = document.getElementById('wow-app-icon');
    const wowScreen = document.getElementById('wow-screen');
    const wowExitBtn = document.getElementById('wow-exit-btn'); // æ³¨æ„IDæ”¹äº†
    const wowNavBtns = document.querySelectorAll('.wow-nav-btn');
    const wowPages = document.querySelectorAll('.wow-page');

    // èº«ä»½ç›¸å…³
    const wowIdentityModal = document.getElementById('wow-identity-modal');
    const wowIdentityList = document.getElementById('wow-identity-list');
    const wowHeaderAvatar = document.getElementById('wow-current-avatar');
    const wowProfileAvatar = document.getElementById('wow-profile-avatar');
    const wowProfileName = document.getElementById('wow-profile-name');

    // å¸–å­æµä¸å‘å¸ƒ
    const wowFeedContainer = document.getElementById('wow-feed-container');
    const wowOpenComposeBtn = document.getElementById('wow-open-compose-btn');
    const wowComposeModal = document.getElementById('wow-compose-modal');
    const wowComposeText = document.getElementById('wow-compose-text');
    const wowPublishBtn = document.getElementById('wow-compose-publish-btn');
    const wowComposeCancelBtn = document.getElementById('wow-compose-cancel-btn');

    // è¯¦æƒ…é¡µç›¸å…³
    const wowDetailView = document.getElementById('wow-detail-view');
    const wowDetailBackBtn = document.getElementById('wow-detail-back-btn');
    const wowDetailMainPost = document.getElementById('wow-detail-main-post');
    const wowDetailComments = document.getElementById('wow-detail-comments');
    const wowDetailInput = document.getElementById('wow-detail-input');
    const wowDetailSendBtn = document.getElementById('wow-detail-send-btn');

    // çŠ¶æ€å˜é‡
    let currentWowContact = null; // å½“å‰é€‰ä¸­çš„â€œå…³ç³»â€
    let activeWowWorldbooks = new Set();
    let currentDetailPostId_Wow = null; // å½“å‰è¯¦æƒ…é¡µçš„å¸–å­ID
    let replyToCommentId_Wow = null; // å›å¤çš„æ ¹è¯„è®ºID (nullè¡¨ç¤ºå›å¤å¸–å­)
    let replyToUser_Wow = null; // å›å¤çš„ç›®æ ‡ç”¨æˆ·å (nullè¡¨ç¤ºå›å¤å±‚ä¸»)




    /* === æ–°å¢ï¼šåŠ¨æ€ç”µæ± é€»è¾‘ === */

    const batteryLevelRect = document.getElementById('battery-level');
    const batteryBolt = document.getElementById('batteryBolt');
    const batteryContainer = document.getElementById('batteryContainer');
    const MAX_SVG_WIDTH = 21;
    // --- 1. è·å– DOM å…ƒç´  (å¿…é¡»æœ€å…ˆè·å–) ---
    const proactiveSettingsScreen = document.getElementById('proactive-settings-screen');
    const proactiveBackBtn = document.getElementById('proactive-back-button');
    const navToProactiveBtn = document.getElementById('nav-to-proactive-settings');
    const proactiveMasterSwitch = document.getElementById('proactive-master-switch');
    const proactiveIntervalSlider = document.getElementById('proactive-interval-slider');
    const proactiveIntervalDisplay = document.getElementById('proactive-interval-display');
    const proactiveContactList = document.getElementById('proactive-contact-list');
    const proactiveStatusText = document.getElementById('proactive-status-text');

    // --- 2. å…¨å±€å˜é‡å®šä¹‰ ---
    let proactiveTimers = {}; // å­˜å‚¨è®¡æ—¶å™¨ { contactId: timeoutId }
    let bannerQueue = [];     // æ¶ˆæ¯é€šçŸ¥é˜Ÿåˆ—
    let isBannerShowing = false; // æ˜¯å¦æ­£åœ¨æ˜¾ç¤ºæ¨ªå¹…
    let proactiveConfig = {   // é»˜è®¤é…ç½®
        enabled: false,
        interval: 10,
        targets: []
    };


    const menuDeleteBtn = document.getElementById('menu-delete-btn');
    // === æ–°å¢ï¼šå…¨å±€ç¾åŒ–åŠŸèƒ½å˜é‡ ===
    const globalBeautifyBtn = document.getElementById('global-beautify-btn');
    const globalBeautifyScreen = document.getElementById('global-beautify-screen');
    const globalBeautifyBackBtn = document.getElementById('global-beautify-back-button');
    const globalCssInput = document.getElementById('global-css-input');
    const saveGlobalCssBtn = document.getElementById('save-global-css-btn');
    const resetGlobalCssBtn = document.getElementById('reset-global-css-btn');
    const globalUserStylesTag = document.getElementById('global-user-styles');


    let qilangTimeouts = []; // å­˜å‚¨æ‰€æœ‰ä¸ƒæµªç›¸å…³çš„å®šæ—¶å™¨ID
    let currentQilangIdentity = null; // å½“å‰é€‰ä¸­çš„ä¸ƒæµªèº«ä»½
    let currentReplyCommentId = null; // å½“å‰æ­£åœ¨å›å¤çš„è¯„è®ºID (ç”¨äºæ¥¼ä¸­æ¥¼)
    const qIdentityList = document.getElementById('qilang-identity-list');
    let currentDetailPostId = null; // è®°å½•å½“å‰æ­£åœ¨æŸ¥çœ‹çš„å¸–å­ID
    let currentReplyToUser = null;  // è®°å½•å½“å‰æ­£åœ¨å›å¤çš„ç”¨æˆ·å (nullä»£è¡¨å›å¤æ¥¼ä¸»)
    const qilangRefreshBtn = document.getElementById('qilang-refresh-btn');
    const qilangDetailView = document.getElementById('qilang-detail-view');
    const qilangDetailBackBtn = document.getElementById('qilang-detail-back-btn');
    const qilangPostBtn = document.getElementById('qilang-post-btn');
    const qilangPostModal = document.getElementById('qilang-post-modal');
    const qilangPostCancelBtn = document.getElementById('qilang-post-cancel-btn');
    const qilangPostConfirmBtn = document.getElementById('qilang-post-confirm-btn');
    // è¯¦æƒ…é¡µå…ƒç´ 
    const qDetailTitle = document.getElementById('q-detail-title');
    const qDetailContent = document.getElementById('q-detail-content');
    const qDetailAuthorName = document.getElementById('q-detail-author-name');
    const qilangAppIcon = document.getElementById('qilang-app-icon');
    const qilangScreen = document.getElementById('qilang-screen');
    const qilangMenuBtn = document.getElementById('qilang-menu-btn');
    const qilangSidebar = document.getElementById('qilang-sidebar');
    const qilangOverlay = document.getElementById('qilang-sidebar-overlay');
    const attachmentFileBtn = document.getElementById('attachment-file-feature');
    const fileInput = document.getElementById('file-attachment-input');
    const menuCopyBtn = document.getElementById('menu-copy-btn');
    const anywhereDoorBtn = document.getElementById('anywhere-door-feature');
    const anywhereDoorModal = document.getElementById('anywhere-door-modal');
    const anywhereDoorCloseBtn = document.getElementById('anywhere-door-close-btn');
    const anywhereDoorInput = document.getElementById('anywhere-door-input');
    const sendActionMsgBtn = document.getElementById('send-action-msg-btn');
    let longPressTimer = null;
    let isLongPressTriggered = false; // ã€æ ¸å¿ƒæ–°å¢ã€‘ç”¨äºæ ‡è®°æ˜¯å¦è§¦å‘äº†é•¿æŒ‰
    const forwardMessagesBtn = document.getElementById('forward-messages-btn');
    const forwardTargetModal = document.getElementById('forward-target-modal');
    const forwardTargetList = document.getElementById('forward-target-list');
    const forwardModalCloseBtn = document.getElementById('forward-modal-close-btn');
    // ç‚¹å‡»èœå•ä¸­çš„â€œå¤šé€‰â€
    const menuSelectBtn = document.getElementById('menu-select-btn'); // è®°å¾—åœ¨é¡¶éƒ¨è·å–è¿™ä¸ªå…ƒç´ 
    // --- å¼•ç”¨å›å¤ç›¸å…³å˜é‡ ---
    const msgActionMenu = document.getElementById('msg-action-menu');
    const menuReplyBtn = document.getElementById('menu-reply-btn');
    const replyPreviewBar = document.getElementById('reply-preview-bar');
    const replyPreviewName = document.getElementById('reply-preview-name');
    const replyPreviewContent = document.getElementById('reply-preview-content');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');

    let currentLongPressTarget = null; // å½“å‰é•¿æŒ‰é€‰ä¸­çš„æ¶ˆæ¯è¡Œ
    let currentReplyTarget = null;     // å½“å‰å‡†å¤‡å›å¤çš„ç›®æ ‡æ¶ˆæ¯å¯¹è±¡ { uuid, text, senderName }
    // --- 1. Get all necessary elements (No changes here) ---

    // åœ¨ä½ çš„ <script> æ ‡ç­¾å†…ï¼Œé è¿‘é¡¶éƒ¨å˜é‡å£°æ˜åŒº
    let currentOpenGroup = null; // ç”¨äºå­˜å‚¨å½“å‰æ‰“å¼€çš„ç¾¤èŠå¯¹è±¡
    let lastActiveTimestamps = {};
    let Global_AllContactsCache = null; // ã€æ ¸å¿ƒä¼˜åŒ–ã€‘å…¨å±€è”ç³»äººç¼“å­˜ï¼Œé¿å…é‡å¤è¯»å–å·¨å‹DB

    // â–¼â–¼â–¼ æ›¿æ¢ä¸ºä¸‹é¢è¿™ç»„æ–°çš„å˜é‡å£°æ˜ â–¼â–¼â–¼
    // === æ–°å¢ï¼šå…³äºæœ¬æœºé¡µé¢å¯¼èˆª ===
    const aboutDeviceBtn = document.getElementById('about-device-btn');
    const aboutDeviceScreen = document.getElementById('about-device-screen');
    const aboutDeviceBackBtn = document.getElementById('about-device-back-button');

    // ç¾¤èŠ
    const groupHeaderNormal = document.getElementById('group-header-actions-normal');
    const groupHeaderSelect = document.getElementById('group-header-actions-select');
    const groupsCancelSelectBtn = document.getElementById('groups-cancel-select-btn');
    const deleteGroupsBtn = document.getElementById('delete-groups-btn');
    let currentEditingMemberId = null; // ç”¨äºè®°å½•å½“å‰æ­£åœ¨ç¼–è¾‘è°
    const groupInfoModalOverlay = document.getElementById('group-info-modal');
    // è·å–ç¼–è¾‘å¼¹çª—å…ƒç´ 
    const addMemberModal = document.getElementById('add-group-member-modal');
    const addMemberCloseBtnElement = document.getElementById('add-member-close-btn'); // æ³¨æ„å˜é‡ååˆ«å†²çª
    const saveNewMemberBtnElement = document.getElementById('save-new-member-btn');
    const newMemberAvatarInputElement = document.getElementById('new-member-avatar-input');
    const newMemberPreviewElement = document.getElementById('new-member-avatar-preview');
    const newMemberNameInput = document.getElementById('new-member-name');
    const newMemberPersonaInput = document.getElementById('new-member-persona');
    const editMemberModal = document.getElementById('edit-member-modal');
    const editMemberCloseBtn = document.getElementById('edit-member-close-btn');
    const editMemberSaveBtn = document.getElementById('save-member-btn');
    const editMemberAvatarInput = document.getElementById('edit-member-avatar-input');
    const editMemberPreview = document.getElementById('edit-member-preview');
    const editMemberNameInput = document.getElementById('edit-member-name-input');
    const editMemberPersonaInput = document.getElementById('edit-member-persona-input');
    const editGroupUserPersonaInput = document.getElementById('edit-group-user-persona-input');
    const groupSettingsAvatar = document.getElementById('group-settings-avatar');
    const groupAvatarUploadInput = document.getElementById('group-avatar-upload-input');
    const editGroupNameBtn = document.getElementById('edit-group-name-btn');

    const groupUserCard = document.getElementById('group-user-card');
    const groupUserAvatar = document.getElementById('group-user-avatar');
    const groupUserName = document.getElementById('group-user-name');

    const editGroupUserModal = document.getElementById('edit-group-user-modal');
    const closeGroupUserModal = document.getElementById('close-group-user-modal');
    const editGroupUserPreview = document.getElementById('edit-group-user-preview');
    const editGroupUserAvatarInput = document.getElementById('edit-group-user-avatar-input');
    const editGroupUserNameInput = document.getElementById('edit-group-user-name-input');
    const saveGroupUserBtn = document.getElementById('save-group-user-btn');

    const groupInfoModal = document.getElementById('group-info-modal');
    const groupInfoCloseBtn = document.getElementById('group-info-close-btn');
    const groupSettingsName = document.getElementById('group-settings-name');
    const groupMemberCount = document.getElementById('group-member-count');
    const groupMembersGrid = document.getElementById('group-members-grid');

    const addGroupMemberModal = document.getElementById('add-group-member-modal');
    const addMemberCloseBtn = document.getElementById('add-member-close-btn');
    const newMemberAvatarInput = document.getElementById('new-member-avatar-input');
    const newMemberAvatarPreview = document.getElementById('new-member-avatar-preview');
    const newMemberName = document.getElementById('new-member-name');
    const newMemberPersona = document.getElementById('new-member-persona');
    const saveNewMemberBtn = document.getElementById('save-new-member-btn');
    const createGroupModal = document.getElementById('create-group-modal');
    const createGroupBackBtn = document.getElementById('create-group-back-btn');
    const createGroupTitle = document.getElementById('create-group-title');
    const groupModeSelection = document.getElementById('group-mode-selection');
    const groupMemberSelectContainer = document.getElementById('group-member-select-container');
    const groupMemberList = document.getElementById('group-member-list');
    const groupCreateFooter = document.getElementById('group-create-footer');
    const confirmCreateGroupBtn = document.getElementById('confirm-create-group-btn');

    const modeSelectExisting = document.getElementById('mode-select-existing');
    const modeCreateEmpty = document.getElementById('mode-create-empty');


    const gameSegmentControl = document.getElementById('game-segment-control');
    const gameSegmentBtns = gameSegmentControl ? gameSegmentControl.querySelectorAll('.segment-btn') : [];
    let currentMessageType = 'single'; // 'single' æˆ– 'group'
    const shopSegmentControl = document.getElementById('shop-segment-control');
    const shopSegmentBtns = shopSegmentControl ? shopSegmentControl.querySelectorAll('.segment-btn') : [];





    const createGroupCloseBtn = document.getElementById('create-group-close-btn');
    const messagesIconAddBtn = document.getElementById('messages-add-btn');
    const messagesIconMultiselectBtn = document.getElementById('messages-multiselect-btn');

    // å›¾æ ‡åˆ‡æ¢ç›¸å…³å…ƒç´ 
    const iconSelect = messagesIconMultiselectBtn ? messagesIconMultiselectBtn.querySelector('.icon-select') : null;
    const iconDelete = messagesIconMultiselectBtn ? messagesIconMultiselectBtn.querySelector('.icon-delete') : null;
    // === æŠ½å±‰æ§åˆ¶é€»è¾‘ ===
    // === æ–°å¢ï¼šæ¶ˆæ¯åº•æ åˆ‡æ¢é€»è¾‘ ===
    // ã€æ ¸å¿ƒä¿®å¤ã€‘é™åˆ¶é€‰æ‹©å™¨åªåœ¨æ¶ˆæ¯ç•Œé¢å†…ï¼Œé¿å…ä¸å…¶ä»–Appçš„segmentæŒ‰é’®å†²çª
    const segmentControl = document.querySelector('#messages-screen .glass-segment-control');
    const segmentBtns = document.querySelectorAll('#messages-screen .segment-btn');

    const openDrawerBtn = document.getElementById('open-drawer-btn');
    const closeDrawerBtn = document.getElementById('close-drawer-btn');
    const bottomDrawer = document.getElementById('bottom-drawer');
    const rerollFeatureButton = document.getElementById('reroll-feature');
    const aiPendantUrlInput = document.getElementById('ai-pendant-url-input');
    const aiPendantCssInput = document.getElementById('ai-pendant-css-input');
    const restoreAiPendantBtn = document.getElementById('restore-ai-pendant-btn');

    const userPendantUrlInput = document.getElementById('user-pendant-url-input');
    const userPendantCssInput = document.getElementById('user-pendant-css-input');
    const restoreUserPendantBtn = document.getElementById('restore-user-pendant-btn');

    const customPendantStyles = document.getElementById('custom-pendant-styles');
    // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²



    const attachmentIconButton = document.getElementById('chat-add-attachment-button');


    const defaultAttachmentIconSVG = attachmentIconButton ? attachmentIconButton.innerHTML : '';





    const textImageFeatureButton = document.getElementById('text-image-feature');
    const textImageModal = document.getElementById('text-image-modal');
    const textImageModalCloseBtn = document.getElementById('text-image-modal-close-btn');
    const textImageInput = document.getElementById('text-image-input');
    const sendTextImageBtn = document.getElementById('send-text-image-btn');
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²


    const thoughtBubble = document.getElementById('ai-thought-bubble');
    const chatContactNameTrigger = document.getElementById('chat-contact-name');

    const manageFontUrlsBtn = document.getElementById('manage-font-urls-btn');
    const fontUrlSettingsScreen = document.getElementById('font-url-settings-screen');
    const fontUrlBackButton = document.getElementById('font-url-back-button');
    const addFontUrlBtn = document.getElementById('add-font-url-btn');
    const fontUrlListContainer = document.getElementById('font-url-list-container');
    let lastVnUserChoice = null; // ç”¨äºè®°å½•ä¸Šä¸€æ¬¡è§¦å‘AIç»­å†™çš„ç”¨æˆ·é€‰æ‹©
    const textEditModal = document.getElementById('text-edit-modal');
    const textEditModalTitle = document.getElementById('text-edit-modal-title');
    const textEditModalCloseBtn = document.getElementById('text-edit-modal-close-btn');
    const textEditTextarea = document.getElementById('text-edit-textarea');
    const textEditSaveBtn = document.getElementById('text-edit-save-btn');
    let onSaveCallback = null;
    // 1. è·å–æ–°ç•Œé¢çš„æ‰€æœ‰å…ƒç´ 
    const datingHistoryButton = document.getElementById('dating-history-feature');
    const datingHistoryScreen = document.getElementById('dating-history-screen');
    const datingHistoryBackButton = document.getElementById('dating-history-back-button');
    const datingHistoryContainer = document.getElementById('dating-history-container');
    const addStylePresetBtn = document.getElementById('add-style-preset-btn');
    const stylePresetModal = document.getElementById('style-preset-modal');
    const stylePresetModalTitle = document.getElementById('style-preset-modal-title');
    const stylePresetModalCloseBtn = document.getElementById('style-preset-modal-close-btn');
    const stylePresetInput = document.getElementById('style-preset-input');
    const saveStylePresetBtn = document.getElementById('save-style-preset-btn');

    let currentEditingPresetId = null; // ç”¨äºåŒºåˆ†æ˜¯æ–°å»ºè¿˜æ˜¯ç¼–è¾‘
    const stylePresetsContainer = document.getElementById('style-presets-container');

    // 1. è·å–æ–°æ·»åŠ çš„å…ƒç´ 
    const vnDialogBox = document.getElementById('vn-dialog-box');
    const vnChoicesContainer = document.getElementById('vn-choices-container');
    const customChoiceModal = document.getElementById('custom-choice-modal');
    const customChoiceCloseBtn = document.getElementById('custom-choice-close-btn');
    const customChoiceInput = document.getElementById('custom-choice-input');
    const customChoiceConfirmBtn = document.getElementById('custom-choice-confirm-btn');

    // 2. å¼•æ“çŠ¶æ€å˜é‡
    let vnSceneQueue = []; // è§£æåçš„å‰§æœ¬é˜Ÿåˆ—
    let vnConversationHistory = [];
    let currentSegmentIndex = 0; // å½“å‰æ’­æ”¾åˆ°ç¬¬å‡ æ®µ
    let isTyping = false; // æ˜¯å¦æ­£åœ¨é€å­—æ‰“å°
    const TYPEWRITER_SPEED = 120; // æ‰“å­—æœºé€Ÿåº¦ (ms)
    const charUploadBox = document.getElementById('char-upload-box');
    const charUploadInput = document.getElementById('char-upload-input');
    const bgUploadBox = document.getElementById('bg-upload-box');
    const bgUploadInput = document.getElementById('bg-upload-input');
    const bgPreviewsContainer = document.getElementById('bg-previews-container');
    const startDatingBtn = document.getElementById('start-dating-btn');
    const datingSetupBackButton = document.getElementById('dating-setup-back-btn');

    const appointmentButton = document.getElementById('appointment-feature');
    const datingScreen = document.getElementById('dating-screen');
    const firstLoader = document.getElementById('dating-loader-1');
    const secondLoader = document.getElementById('dating-loader-2');
    const datingSetupScreen = document.getElementById('dating-setup-screen');
    const datingSettingsScreen = document.getElementById('dating-settings-screen'); // æ–°å¢
    const vnScreen = document.getElementById('vn-screen');
    const vnBackground = document.getElementById('vn-background');
    const vnCharacter = document.getElementById('vn-character');
    const vnExitBtn = document.getElementById('vn-exit-btn');
    const vnSettingsBtn = document.getElementById('vn-settings-btn'); // æ–°å¢
    const vnCharName = document.getElementById('vn-char-name');
    const vnDialogText = document.getElementById('vn-dialog-text');
    let datingCharPortrait = null;
    let datingBackgrounds = [];

    const incomingCallReason = document.getElementById('incoming-call-reason');
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
    const requestCallButton = document.getElementById('request-call-feature');
    const incomingCallScreen = document.getElementById('incoming-call-screen');
    const incomingCallAvatar = document.getElementById('incoming-call-avatar');
    const incomingCallName = document.getElementById('incoming-call-name');
    const acceptCallButton = document.getElementById('accept-call-button');
    const declineCallButton = document.getElementById('decline-call-button');
    // â–¼â–¼â–¼ åœ¨JSé¡¶éƒ¨å˜é‡åŒºæ·»åŠ  â–¼â–¼â–¼
    const callSummaryButton = document.getElementById('call-summary-feature');
    const summaryListScreen = document.getElementById('summary-list-screen');
    const summaryListBackButton = document.getElementById('summary-list-back-button');
    const summaryListContainer = document.getElementById('summary-list-container');
    const summaryDetailScreen = document.getElementById('summary-detail-screen');
    const summaryDetailBackButton = document.getElementById('summary-detail-back-button');
    const summaryDetailContainer = document.getElementById('summary-detail-container');
    // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
    const voiceCallFeatureButton = document.getElementById('voice-call-feature');
    const voiceCallScreen = document.getElementById('voice-call-screen');
    const callBackground = document.querySelector('#voice-call-screen .call-background');
    // å‘¼å«ä¸­çŠ¶æ€
    const callingState = document.getElementById('calling-state');
    const callingAvatar = document.getElementById('calling-avatar');
    const callingName = document.getElementById('calling-name');
    const callingStatus = document.getElementById('calling-status');
    const cancelCallButton = document.getElementById('cancel-call-button'); // IDä¿®æ­£
    // å·²è¿æ¥çŠ¶æ€
    const connectedState = document.getElementById('connected-state');
    const connectedName = document.getElementById('connected-name');
    const callTimerDisplay = document.getElementById('call-timer');
    const aiSpeechBubbleContainer = document.getElementById('ai-speech-bubble-container');
    const connectedHangUpButton = document.getElementById('connected-hang-up-button'); // IDä¿®æ­£
    const userSpeakButton = document.getElementById('user-speak-button'); // IDä¿®æ­£
    // é€šè¯ä¸­è¾“å…¥æ¡†
    const voiceCallInputModal = document.getElementById('voice-call-input-modal');
    const voiceCallTextarea = document.getElementById('voice-call-textarea');
    const sendCallTextButton = document.getElementById('send-call-text-button');

    // --- 2. å®šä¹‰çŠ¶æ€å˜é‡ ---
    let callTimerInterval = null;
    let callStartTime = null;
    let callHistory = [];
    // åœ¨å…¶ä»– const å˜é‡å£°æ˜çš„ä¸‹æ–¹æ·»åŠ 
    const imagePreviewModal = document.getElementById('image-preview-modal');
    const previewImageElement = document.getElementById('preview-image-element');
    const imagePreviewCloseBtn = document.getElementById('image-preview-close-btn');

    // â–¼â–¼â–¼ æ–°å¢ï¼šç¾åŒ–åŠŸèƒ½æ‰€éœ€çš„å…¨éƒ¨å˜é‡ â–¼â–¼â–¼

    // --- å¯¼èˆªç›¸å…³ ---
    const mottoSettingsBtn = document.getElementById('motto-settings-btn');
    const appNameSettingsBtn = document.getElementById('app-name-settings-btn');
    const mottoSettingsScreen = document.getElementById('motto-settings-screen');
    const appNameSettingsScreen = document.getElementById('appname-settings-screen');
    const mottoSettingsBackButton = document.getElementById('motto-settings-back-button');
    const appNameSettingsBackButton = document.getElementById('appname-settings-back-button');

    // --- ç›®æ ‡å…ƒç´  ---
    const mottoElement = document.getElementById('motto');
    const appNameElements = document.querySelectorAll('.app-name');

    // --- ç­¾åç¾åŒ–é¡µé¢çš„æ§ä»¶ ---
    const mottoColorInput = document.getElementById('motto-color-input');
    const mottoColorPicker = document.getElementById('motto-color-picker');
    const mottoBlurToggle = document.getElementById('motto-blur-toggle');

    // --- å›¾æ ‡åç§°ç¾åŒ–é¡µé¢çš„æ§ä»¶ ---
    const appNameColorInput = document.getElementById('app-name-color-input');
    const appNameColorPicker = document.getElementById('app-name-color-picker');
    const appNameBlurToggle = document.getElementById('app-name-blur-toggle');
    // â–²â–²â–² å˜é‡å£°æ˜ç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ æ–°å¢ï¼šå›¾æ ‡åŒ…é¢„è®¾åŠŸèƒ½å˜é‡ â–¼â–¼â–¼
    const savePresetButton = document.getElementById('save-preset-button');
    const managePresetsButton = document.getElementById('manage-presets-button');
    const presetManagementScreen = document.getElementById('preset-management-screen');
    const presetBackButton = document.getElementById('preset-back-button');
    const presetListContainer = document.getElementById('preset-list-container');
    const importPresetButton = document.getElementById('import-preset-button');
    const presetImportInput = document.getElementById('preset-import-input');
    // â–²â–²â–² æ–°å¢å˜é‡ç»“æŸ â–²â–²â–²
    let isSaving = false; // æ–°å¢ï¼šç”¨äºé˜²æ­¢æ•°æ®åº“å†™å…¥å†²çªçš„â€œå­˜æ¡£é”â€
    const imageFeatureButton = document.getElementById('image-feature');
    const chatImageUploadInput = document.getElementById('chat-image-upload-input');
    const saveAllSettingsBtn = document.getElementById('save-all-settings-btn');


    const chatMessageInput = document.getElementById('chat-message-input');
    const chatContainer = document.getElementById('chat-messages-container');
    let isVoiceInputInitialized = false; // æ–°å¢ï¼šç”¨äºç¡®ä¿è¯­éŸ³åŠŸèƒ½åªè¢«åˆå§‹åŒ–ä¸€æ¬¡
    const moveBooksInGroupBtn = document.getElementById('move-books-in-group-btn');


    let recordingStartTime;
    const worldbookGroupsBtn = document.getElementById('worldbook-groups-btn');
    const worldbookGroupsScreen = document.getElementById('worldbook-groups-screen');
    const worldbookGroupsBackButton = document.getElementById('worldbook-groups-back-button');
    const addWorldbookGroupBtn = document.getElementById('add-worldbook-group-btn');
    const worldbookGroupsList = document.getElementById('worldbook-groups-list');
    const groupsMultiselectBtn = document.getElementById('groups-multiselect-btn');

    const groupDetailScreen = document.getElementById('worldbook-group-detail-screen');
    const groupDetailBackButton = document.getElementById('group-detail-back-button');
    const groupDetailTitle = document.getElementById('group-detail-title');
    const addBookInGroupBtn = document.getElementById('add-book-in-group-btn');
    const booksInGroupList = document.getElementById('books-in-group-list');
    const groupDetailMultiselectBtn = document.getElementById('group-detail-multiselect-btn');

    // å¤šé€‰æ¨¡å¼ä¸‹çš„æŒ‰é’®
    const worldbookHeaderNormal = document.getElementById('worldbook-header-actions-normal');
    const worldbookHeaderSelect = document.getElementById('worldbook-header-actions-select');
    const moveBooksBtn = document.getElementById('move-books-btn');
    const worldbookCancelSelectBtn = document.getElementById('worldbook-cancel-select-btn');

    // ç§»åŠ¨å¼¹å‡ºæ¡†
    const moveToGroupModal = document.getElementById('move-to-group-modal');
    const moveToGroupModalCloseBtn = document.getElementById('move-to-group-modal-close-btn');
    const groupSelectionList = document.getElementById('group-selection-list');

    // çŠ¶æ€å˜é‡
    let isGroupDeleteMode = false;
    let isBookInGroupDeleteMode = false;
    let currentOpenGroupId = null;
    // ==========================================================
    // === æ›´æ–°ï¼šåˆ†ç»„è¯¦æƒ…é¡µçš„ JS å˜é‡ ===
    // ==========================================================
    // (æ‰¾åˆ°ä¹‹å‰æ·»åŠ çš„ `// çŠ¶æ€å˜é‡` æ³¨é‡Šï¼Œåœ¨ä¸‹é¢åŠ å…¥è¿™äº›æ–°å˜é‡)
    const groupDetailHeaderNormal = document.getElementById('group-detail-header-actions-normal');
    const groupDetailHeaderSelect = document.getElementById('group-detail-header-actions-select');
    const deleteBooksInGroupBtn = document.getElementById('delete-books-in-group-btn');
    // (åœ¨ `deleteBooksInGroupBtn` å˜é‡ä¸‹é¢æ·»åŠ è¿™ä¸€è¡Œ)
    const groupDetailCancelSelectBtn = document.getElementById('group-detail-cancel-select-btn');
    // 1. è·å–èŠå¤©è¾“å…¥æ¡†å…ƒç´ 
    const chatInputForEnterKey = document.getElementById('chat-message-input');
    // === æ–°å¢ï¼šAPI åº“ç›¸å…³å…ƒç´  ===
    const apiLibraryModal = document.getElementById('api-library-modal');
    const apiLibraryModalCloseBtn = document.getElementById('api-library-modal-close-btn');
    const apiLibraryListContainer = document.getElementById('api-library-list-container');
    const saveApiToLibraryBtn = document.getElementById('save-api-to-library-btn');
    const selectApiLibraryBtn = document.getElementById('select-api-library-btn');
    const apiLibraryDeleteSelectedBtn = document.getElementById('api-library-delete-selected-btn');

    let isApiLibraryDeleteMode = false;// â–¼â–¼â–¼ START: GACHA App å¸–å­åŠŸèƒ½å®Œæ•´è„šæœ¬ (V14 - æœ€ç»ˆä¿®å¤ç‰ˆ) â–¼â–¼â–¼
    const lotteryModal = document.getElementById('lottery-modal');
    const darkModeToggle = document.getElementById('toggle-dark-mode');
    // --- 1. å˜é‡å£°æ˜ ---
    const gachaAppIcon = document.getElementById('gacha-app-icon');
    const gachaScreen = document.getElementById('gacha-screen');
    const gachaBackButton = document.getElementById('gacha-back-button');
    const gachaTitle = document.getElementById('gacha-title');
    const gachaSegmentControl = document.getElementById('gacha-segment-control');
    const gachaSegmentBtns = gachaSegmentControl.querySelectorAll('.segment-btn');
    const shareContentPanel = document.getElementById('share-content-panel');
    const postsContainer = document.getElementById('gacha-posts-container');
    const gachaAvatarButton = document.getElementById('gacha-avatar-button');
    const gachaAvatarImg = document.getElementById('gacha-avatar-img');
    const newPostBtn = document.getElementById('gacha-new-post-btn');
    const postModal = document.getElementById('gacha-post-modal');
    const postModalCloseBtn = document.getElementById('gacha-post-modal-close-btn');
    const postTextInput = document.getElementById('gacha-post-text-input');
    const postImageDescInput = document.getElementById('gacha-post-image-desc-input');
    const confirmPostBtn = document.getElementById('gacha-confirm-post-btn');
    const visibilityModal = document.getElementById('visibility-settings-modal');
    const visibilityModalCloseBtn = document.getElementById('visibility-modal-close-btn');
    const worldbookVisibilityList = document.getElementById('worldbook-visibility-list');
    const saveVisibilityBtn = document.getElementById('save-visibility-btn');
    const summonAiModal = document.getElementById('summon-ai-modal');
    const summonAiModalCloseBtn = document.getElementById('summon-ai-modal-close-btn');
    const summonAiListContainer = document.getElementById('summon-ai-list-container');

    let currentGachaIdentity = null;
    let currentPostIdForVisibility = null;
    let currentPostIdForSummoning = null;


    const transactionHistoryCard = document.getElementById('transaction-history-card');
    const transactionsScreen = document.getElementById('transactions-screen');
    const transactionsBackButton = document.getElementById('transactions-back-button');
    const transactionsListContainer = document.getElementById('transactions-list-container');
    const blacklistModal = document.getElementById('blacklist-modal');
    const goToSavingsBtn = document.getElementById('go-to-savings-btn');
    const unlockModal = document.getElementById('unlock-modal');
    const unlockModalCloseBtn = document.getElementById('unlock-modal-close-btn');
    const applyUnlockBtn = document.getElementById('apply-unlock-btn');
    const unlockCodeInput = document.getElementById('unlock-code-input');
    const confirmUnlockBtn = document.getElementById('confirm-unlock-btn');
    const numberGuessModal = document.getElementById('number-guess-modal');
    const coinFlipModal = document.getElementById('coin-flip-modal');
    const gamesGrid = document.getElementById('games-grid');
    const balanceDisplay = document.getElementById('balance-display');
    const slackingOffAppIcon = document.getElementById('GAME-app-icon');
    const slackingOffScreen = document.getElementById('slacking-off-screen');
    const slackingOffBackButton = document.getElementById('slacking-off-back-button');
    const slackingOffTitle = document.getElementById('slacking-off-title');
    // â–²â–²â–² æ‘¸é±¼Appå˜é‡å£°æ˜ç²˜è´´ç»“æŸ â–²â–²â–²
    let shoppingCart = []; // å†…å­˜ä¸­çš„è´­ç‰©è½¦æ•°ç»„
    let currentRecipient = null; // å½“å‰é€‰ä¸­çš„æ”¶è´§äºº
    const myOrdersButton = document.getElementById('my-orders-button');
    const myCartButton = document.getElementById('my-cart-button');

    const cartScreen = document.getElementById('cart-screen');
    const cartBackButton = document.getElementById('cart-back-button');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const selectRecipientBtn = document.getElementById('select-recipient-btn');
    const recipientNameDisplay = document.getElementById('recipient-name-display');
    const confirmPurchaseBtn = document.getElementById('confirm-purchase-btn');

    const ordersScreen = document.getElementById('orders-screen');
    const ordersBackButton = document.getElementById('orders-back-button');
    const ordersListContainer = document.getElementById('orders-list-container');

    const recipientSelectModal = document.getElementById('recipient-select-modal');
    const recipientModalCloseBtn = document.getElementById('recipient-modal-close-btn');
    const recipientListContainer = document.getElementById('recipient-list-container');
    // === END: SHOPMALL è´­ç‰©æµç¨‹ JS (VARIABLES) ===
    // === START: SHOPMALL å•†å“è´­ç‰© JS (VARIABLES) ===
    const categoryTabsContainer = document.querySelector('.category-tabs');
    const productGrid = document.getElementById('product-grid');
    // === END: SHOPMALL å•†å“è´­ç‰© JS (VARIABLES) ===
    // === START: SHOPMALL SCRIPT (VARIABLES) ===
    const shopAppIcon = document.getElementById('SHOP-app-icon');
    const shopScreen = document.getElementById('shop-screen');
    const shopBackButton = document.getElementById('shop-back-button');
    // === END: SHOPMALL SCRIPT (VARIABLES) ===
    // === START: ä¸ƒè¢‹è´­ç‰©èº«ä»½ JS (VARIABLES) ===
    let currentShopper = null; // ç”¨äºå­˜å‚¨å½“å‰é€‰æ‹©çš„ç”¨æˆ·å¯¹è±¡
    const shopperAvatarButton = document.getElementById('shopper-avatar-button');
    const shopperAvatarImg = document.getElementById('shopper-avatar-img');
    const shopperSelectModal = document.getElementById('shopper-select-modal');
    const shopperModalCloseBtn = document.getElementById('shopper-modal-close-btn');
    const shopperListContainer = document.getElementById('shopper-list-container');
    // === END: ä¸ƒè¢‹è´­ç‰©èº«ä»½ JS (VARIABLES) ===
    // === START: SHOPMALL æ ‡ç­¾é¡µ JS (VARIABLES) ===
    const shopTabItems = document.querySelectorAll('.shop-tab-item');
    const shopContentPanels = document.querySelectorAll('.shop-content-panel');
    const shopTitle = document.getElementById('shop-title');
    // === END: SHOPMALL æ ‡ç­¾é¡µ JS (VARIABLES) ===
    // === æ–°å¢ï¼šè·å–æ—¶é’Ÿé«˜æ–¯æ¨¡ç³Šå¼€å…³å’Œæ—¶é’Ÿå®¹å™¨ ===
    const clockBlurToggle = document.getElementById('clock-blur-toggle');
    const clockContainer = document.querySelector('.clock');
    // === æ–°å¢ï¼šè·å–æ—¶é’Ÿè®¾ç½®ç›¸å…³å…ƒç´  ===
    const changeClockButton = document.getElementById('change-clock-button');
    const clockSettingsScreen = document.getElementById('clock-settings-screen');
    const clockSettingsBackButton = document.getElementById('clock-settings-back-button');
    const clockColorInput = document.getElementById('clock-color-input');
    const clockColorPicker = document.getElementById('clock-color-picker');
    const clockElements = document.querySelectorAll('.clock span');
    // === æ–°å¢ï¼šè·å–ç¾åŒ–Appç›¸å…³å…ƒç´  ===
    const beautifyAppIcon = document.getElementById('beautify-app-icon');
    const beautifyScreen = document.getElementById('beautify-screen');
    const beautifyBackButton = document.getElementById('beautify-back-button');
    // === æ–°å¢ï¼šè·å–æ›´æ¢å›¾æ ‡ç•Œé¢ç›¸å…³å…ƒç´  ===
    const changeIconButton = document.getElementById('change-icon-button');
    const iconSettingsScreen = document.getElementById('icon-settings-screen');
    const iconSettingsBackButton = document.getElementById('icon-settings-back-button');

    const multiselectEmojiBtn = document.getElementById('multiselect-emoji-btn');
    let isEmojiDeleteMode = false; // æ–°å¢ï¼šç”¨äºè·Ÿè¸ªè¡¨æƒ…åŒ…æ˜¯å¦å¤„äºåˆ é™¤æ¨¡å¼
    // === æ–°å¢ï¼šé¡µé¢å¯¼èˆªçš„è„šæœ¬ ===
    const audioPlayer = document.getElementById('audio-player');
    const wallpaperUploadInput = document.getElementById('wallpaper-upload-input');
    const phoneFrame = document.querySelector('.phone-frame');
    const appGrid = document.querySelector('.app-grid');
    const allAppScreens = document.querySelectorAll('.screen');
    const homeScreen = document.getElementById('home-screen');
    let openedIcon = null; // ç”¨äºâ€œè®°ä½â€æ˜¯ä»å“ªä¸ªå›¾æ ‡æ‰“å¼€çš„App

    const settingsScreen = document.getElementById('settings-screen');
    const settingsAppIcon = document.getElementById('settings-app-icon');
    const backButton = document.getElementById('back-button');
    const saveSettingsButton = document.getElementById('save-settings-button');
    const musicAppIcon = document.getElementById('music-app-icon');
    const musicScreen = document.getElementById('music-screen');
    const musicBackButton = document.getElementById('music-back-button');

    // === æ–°å¢ï¼šæ­Œå•å¤šé€‰åŠŸèƒ½æ‰€éœ€å…ƒç´  ===
    const playlistMultiselectBtn = document.getElementById('playlist-multiselect-btn');
    let isPlaylistDeleteMode = false; // ç”¨äºè·Ÿè¸ªæ˜¯å¦å¤„äºåˆ é™¤æ¨¡å¼

    const messagesAppIcon = document.getElementById('messages-app-icon');
    const messagesScreen = document.getElementById('messages-screen');
    const messagesBackButton = document.getElementById('messages-back-button');


    // === æ–°å¢ï¼šæ·»åŠ è”ç³»äººå¼¹å‡ºå±‚æ‰€éœ€çš„æ‰€æœ‰å…ƒç´  ===
    const addContactModal = document.getElementById('add-contact-modal');
    // const messagesAddBtn = document.getElementById('messages-add-btn');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const roleSwitchCheckbox = document.getElementById('role-switch-checkbox');
    const switchLabels = document.querySelectorAll('.switch-label');
    const aiForm = document.getElementById('ai-form');
    const userForm = document.getElementById('user-form');
    const contactList = document.getElementById('contact-list');

    // è¡¨å•å†…éƒ¨å…ƒç´ 
    const aiAvatarPreview = document.getElementById('ai-avatar-preview');
    const aiAvatarInput = document.getElementById('ai-avatar-input');
    const aiNameInput = document.getElementById('ai-name-input');
    const aiPersonaInput = document.getElementById('ai-persona-input');

    const userAvatarPreview = document.getElementById('user-avatar-preview');
    const userAvatarInput = document.getElementById('user-avatar-input');
    const userNameInput = document.getElementById('user-name-input');
    const userPersonaInput = document.getElementById('user-persona-input');

    const contextMemoryInput = document.getElementById('context-memory-input');
    const saveContactBtn = document.getElementById('save-contact-btn');
    const loadMoreMessagesBtn = document.getElementById('load-more-messages-btn');

    // === æ–°å¢ï¼šèŠå¤©ç•Œé¢æ‰€éœ€çš„æ‰€æœ‰å…ƒç´  ===
    const chatScreen = document.getElementById('chat-screen');
    const chatBackButton = document.getElementById('chat-back-button');
    const chatContactName = document.getElementById('chat-contact-name');
    const chatMessagesContainer = document.getElementById('chat-messages-container');


    let isAiReplying = false;


    // === æ–°å¢ï¼šèŠå¤©è®¾ç½®å¼¹å‡ºå±‚æ‰€éœ€çš„æ‰€æœ‰å…ƒç´  ===
    const chatSettingsModal = document.getElementById('chat-settings-modal');
    const chatSettingsButton = document.getElementById('chat-settings-button');
    const chatSettingsCloseBtn = document.getElementById('chat-settings-close-btn');
    const saveChatSettingsBtn = document.getElementById('save-chat-settings-btn');

    // è§’è‰²ç¼–è¾‘ (åœ¨è®¾ç½®å¼¹çª—å†…)
    const roleSwitchCheckboxSettings = document.getElementById('role-switch-checkbox-settings');
    const aiFormSettings = document.getElementById('ai-form-settings');
    const userFormSettings = document.getElementById('user-form-settings');
    const aiAvatarPreviewSettings = document.getElementById('ai-avatar-preview-settings');
    const aiAvatarInputSettings = document.getElementById('ai-avatar-input-settings');
    const aiNameInputSettings = document.getElementById('ai-name-input-settings');
    const aiPersonaInputSettings = document.getElementById('ai-persona-input-settings');
    const userAvatarPreviewSettings = document.getElementById('user-avatar-preview-settings');
    const userAvatarInputSettings = document.getElementById('user-avatar-input-settings');
    const userNameInputSettings = document.getElementById('user-name-input-settings');
    const userPersonaInputSettings = document.getElementById('user-persona-input-settings');
    const contextMemoryInputSettings = document.getElementById('context-memory-input-settings');

    // ä¸ªæ€§åŒ–è®¾ç½®
    const bubbleCssInput = document.getElementById('bubble-css-input');
    const restoreBubbleCssBtn = document.getElementById('restore-bubble-css-btn');
    const uploadChatBgBtn = document.getElementById('upload-chat-bg-btn');
    const resetChatBgBtn = document.getElementById('reset-chat-bg-btn');
    const chatBgUploadInput = document.getElementById('chat-bg-upload-input');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const customBubbleStyles = document.getElementById('custom-bubble-styles');

    const fullscreenToggle = document.getElementById('toggle-frame-visibility');
    const bodyElement = document.body; // è·å– body å…ƒç´ 


    const worldbookAppIcon = document.getElementById('worldbook-app-icon');
    const worldbookBackButton = document.getElementById('worldbook-back-button');
    const addWorldbookBtn = document.getElementById('add-worldbook-btn');
    const addWorldbookModal = document.getElementById('add-worldbook-modal');
    const worldbookModalCloseBtn = document.getElementById('worldbook-modal-close-btn');
    const saveWorldbookBtn = document.getElementById('save-worldbook-btn');
    const worldbookNameInput = document.getElementById('worldbook-name-input');
    const worldbookContentInput = document.getElementById('worldbook-content-input');
    const worldbookListContainer = document.getElementById('worldbook-list');
    const worldbookMultiselectBtn = document.getElementById('worldbook-multiselect-btn');
    let isWorldbookDeleteMode = false; // åˆ é™¤æ¨¡å¼çš„çŠ¶æ€
    let currentEditingBookId = null; // null è¡¨ç¤ºæ–°å»ºï¼Œæœ‰å€¼è¡¨ç¤ºç¼–è¾‘

    const showAvatarsToggle = document.getElementById('show-avatars-toggle');
    const avatarRadiusInput = document.getElementById('avatar-radius-input');
    // === æ–°å¢ï¼šå¤‡ä»½ä¸æ¢å¤åŠŸèƒ½æ‰€éœ€å…ƒç´  ===
    const backupDataBtn = document.getElementById('backup-data-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFileInput = document.getElementById('import-file-input');
    // === æ–°å¢ï¼šå­—ä½“æ›´æ¢åŠŸèƒ½æ‰€éœ€å…ƒç´  ===
    const customFontStyle = document.getElementById('custom-font-style');
    const changeFontBtn = document.getElementById('change-font-btn');
    const restoreFontBtn = document.getElementById('restore-font-btn');
    const fontImportInput = document.getElementById('font-import-input');
    const worldbookSelectSettings = document.getElementById('worldbook-select-settings');


    // 1. è·å–éœ€è¦çš„å…ƒç´ 
    const chatEmojiButton = document.getElementById('chat-emoji-button');
    const chatScreenForPanel = document.getElementById('chat-screen'); // chat-screen ä½œä¸ºçˆ¶å®¹å™¨
    const chatMessagesForPanel = document.getElementById('chat-messages-container'); // æ¶ˆæ¯å®¹å™¨



    // === æ–°å¢ï¼šAPI è®¾ç½®æ‰€éœ€çš„å…ƒç´  ===

    const apiUrlInput = document.getElementById('api-url');
    const apiKeyInput = document.getElementById('api-key');
    const connectButton = document.getElementById('connect-api-button');
    const apiStatusSpan = document.getElementById('api-connection-status');
    const modelSelect = document.getElementById('api-model');
    const saveApiButton = document.getElementById('save-settings-button'); // è¿™ä¸ªæŒ‰é’®æ˜¯è®¾ç½®é¡µé¡¶éƒ¨çš„ä¿å­˜æŒ‰é’®
    const tempSlider = document.getElementById('temperature-slider');
    const tempValueSpan = document.getElementById('temperature-value');
    // === 1. è·å–æ‰€æœ‰éœ€è¦æ“ä½œçš„HTMLå…ƒç´  ===
    // æ—¶é’Ÿå…ƒç´ 
    const clockHoursElem = document.getElementById('clock-hours');
    const clockMinutesElem = document.getElementById('clock-minutes');
    // è¯­å½•å…ƒç´ 
    const mottoElem = document.getElementById('motto');
    // å°ç»„ä»¶å…ƒç´ 
    const widgetContainer = document.getElementById('widgetContainer');
    const widgetVisibilityToggle = document.getElementById('toggle-widget-visibility');
    const imageUploader = document.getElementById('imageUploader');
    const widgetText = document.getElementById('widgetText');
    // === æ–°å¢ï¼šå£çº¸åŠŸèƒ½æ‰€éœ€çš„å…ƒç´  ===
    const wallpaperPreview = document.getElementById('wallpaper-preview');
    const resetWallpaperBtn = document.getElementById('reset-wallpaper-btn');
    const uploadWallpaperBtn = document.getElementById('upload-wallpaper-btn');
    const defaultBodyBg = "url('https://i.postimg.cc/rs927KZZ/Group-2-(2).png')";


    // --- æ–°å¢ï¼šçµåŠ¨å²›ç›¸å…³å…ƒç´ å’ŒçŠ¶æ€ç®¡ç† ---
    // Add this line with the other element declarations
    const collapsedSongTitle = document.getElementById('collapsed-song-title');
    const dynamicIsland = document.getElementById('dynamic-island');
    const islandSongTitle = document.getElementById('island-song-title');
    const islandSongArtist = document.getElementById('island-song-artist');
    const islandPlayPauseBtn = document.getElementById('island-play-pause-btn');
    const islandPrevBtn = document.getElementById('island-prev-btn');
    const islandNextBtn = document.getElementById('island-next-btn');
    const progressCurrentTime = document.getElementById('progress-current-time');
    const progressRemainingTime = document.getElementById('progress-remaining-time');
    const progressBarFill = document.getElementById('progress-bar-fill');


    const addPlaylistBtn = document.getElementById('add-playlist-btn');
    const playlistGrid = document.getElementById('playlist-grid');
    const playlistDetailScreen = document.getElementById('playlist-detail-screen');
    const playlistBackButton = document.getElementById('playlist-back-button');
    const playlistNameTitle = document.getElementById('playlist-name-title');
    const importMusicButton = document.getElementById('import-music-button');
    const musicFileInput = document.getElementById('music-file-input');
    const songList = document.getElementById('song-list');
    const uploadCoverBtn = document.getElementById('upload-cover-btn');
    const multiSelectBtn = document.getElementById('multi-select-btn');
    const coverUploadInput = document.getElementById('cover-upload-input');

    // === æ–°å¢ï¼šæ­Œå•åç§°ç¼–è¾‘æ‰€éœ€å…ƒç´  ===
    const editPlaylistNameBtn = document.getElementById('edit-playlist-name-btn');




    // === æ–°å¢ï¼šè¡¨æƒ…åŒ…åŠŸèƒ½çš„æ ¸å¿ƒJSé€»è¾‘ ===

    // 1. è·å–æ‰€æœ‰æ–°æ·»åŠ çš„HTMLå…ƒç´ 
    const addEmojiBtn = document.getElementById('add-emoji-btn');
    const addEmojiModal = document.getElementById('add-emoji-modal');
    const emojiModalCloseBtn = document.getElementById('emoji-modal-close-btn');
    const saveEmojiBtn = document.getElementById('save-emoji-btn');
    const emojiUrlInput = document.getElementById('emoji-urls-textarea');
    const emojiGridContainer = document.getElementById('emoji-grid-container');

    // === æ–°å¢ï¼šå¤„ç†å›¾æ ‡URLè¾“å…¥çš„æ ¸å¿ƒé€»è¾‘ ===

    const iconListContainer = document.getElementById('icon-list-container');
    // === æ–°å¢ï¼šAIå¯ç”¨è¡¨æƒ…åŒ…çš„æè¿°ä¸URLæ˜ å°„ ===
    const stickerMap = new Map([]);

    // â–¼â–¼â–¼ ç¬¬ä¸€æ­¥ï¼šåœ¨æ­¤å¤„æ’å…¥å¤´åƒåº“ç›¸å…³ä»£ç  â–¼â–¼â–¼

    // 1. å…¨å±€å¤´åƒæ˜ å°„è¡¨ (åå­— -> URL)
    const avatarMap = new Map();

    // 2. ä»æ–‡æœ¬ä¸­æå–å¤´åƒçš„å‡½æ•° (æ ¼å¼: [å¼ ä¸‰:http...])
    function extractAndRegisterAvatars(text) {
        if (!text) return;
        const regex = /\[([^:\]]+):(https?:\/\/[^\]]+)\]/g;
        let match;
        while ((match = regex.exec(text)) !== null) {
            const name = match[1].trim();
            const url = match[2].trim();
            avatarMap.set(name, url);
            console.log(`å·²æ³¨å†Œå¤´åƒ: ${name} -> ${url}`);
        }
    }

    // 3. æ™ºèƒ½è·å–å¤´åƒå‡½æ•° (ä¼˜å…ˆæŸ¥åº“ï¼ŒæŸ¥ä¸åˆ°ç”¨æ–‡å­—å…œåº•)
    function getSmartAvatar(name) {
        // A. ä¼˜å…ˆæŸ¥æˆ‘ä»¬åˆšå»ºç«‹çš„å¤´åƒåº“
        if (avatarMap.has(name)) {
            return avatarMap.get(name);
        }
        // B. å…¶æ¬¡å°è¯•è°ƒç”¨åŸæœ‰çš„æ–‡å­—å¤´åƒç”Ÿæˆå™¨ (å¦‚æœå­˜åœ¨)
        if (typeof generateTextAvatar === 'function') {
            return generateTextAvatar(name);
        }
        // C. æœ€ä½ä¿åº•
        return `https://placehold.co/100x100/ccc/fff?text=${name.charAt(0)}`;
    }

    // 4. åˆ·æ–°å…¨å±€å¤´åƒåº“ (è¯»å–å½“å‰èº«ä»½å…³è”çš„æ‰€æœ‰ä¸–ç•Œä¹¦)
    async function refreshGlobalAvatarMap(contact) {
        avatarMap.clear(); // å…ˆæ¸…ç©ºæ—§çš„
        if (!contact) return;
        // if (!contact.linkedWorldBookGroupIds) return; // ç§»é™¤æ—§åˆ¤æ–­

        try {
            const worldbookData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            const allBooks = (worldbookData && Array.isArray(worldbookData.value)) ? worldbookData.value : [];
            let requiredBookIds = new Set();

            // 1. ä¼˜å…ˆæ–°ç‰ˆ
            if (contact.linkedWorldBookIds && contact.linkedWorldBookIds.length > 0) {
                 contact.linkedWorldBookIds.forEach(id => requiredBookIds.add(id));
            } 
            // 2. å›é€€æ—§ç‰ˆ
            else if (contact.linkedWorldBookGroupIds && contact.linkedWorldBookGroupIds.length > 0) {
                 const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                 const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                 const linkedGroupIds = new Set(contact.linkedWorldBookGroupIds);
                 allGroups.forEach(g => {
                     if (linkedGroupIds.has(g.id) && Array.isArray(g.bookIds)) {
                         g.bookIds.forEach(bid => requiredBookIds.add(bid));
                     }
                 });
            }

            const linkedBooks = allBooks.filter(b => requiredBookIds.has(b.id));
            linkedBooks.forEach(book => {
                extractAndRegisterAvatars(book.content); // æ‰«ææ¯ä¸€æœ¬ä¹¦
            });
            console.log("å¤´åƒåº“åŠ è½½å®Œæ¯•ï¼Œå½“å‰å¤´åƒæ•°:", avatarMap.size);
        } catch (e) {
            console.error("åŠ è½½å¤´åƒåº“å¤±è´¥", e);
        }
    }
    // â–²â–²â–² ç¬¬ä¸€æ­¥ä»£ç ç»“æŸ â–²â–²â–²



    // === IndexedDB å¸®åŠ©å‡½æ•° START ===


    // ==========================================================
    // SECTION 2: åº”ç”¨å¯åŠ¨ä¸å…³é—­çš„æ ¸å¿ƒåŠ¨ç”»å‡½æ•° (iOSé£æ ¼)
    // ==========================================================

    /**
     * æ‰“å¼€ä¸€ä¸ªAppçš„åŠ¨ç”»å‡½æ•°
     * @param {HTMLElement} iconEl - è¢«ç‚¹å‡»çš„å›¾æ ‡å…ƒç´ 
     * @param {HTMLElement} appView - éœ€è¦æ‰“å¼€çš„åº”ç”¨é¡µé¢å…ƒç´ 
     */
    // index.html -> <script> æ ‡ç­¾å†…
    /**
     * æ‰“å¼€ä¸€ä¸ªAppçš„åŠ¨ç”»å‡½æ•° (V2 - ä¿®å¤æœ€ç»ˆçŠ¶æ€ä¼˜å…ˆçº§é—®é¢˜)
     * @param {HTMLElement} iconEl - è¢«ç‚¹å‡»çš„å›¾æ ‡å…ƒç´ 
     * @param {HTMLElement} appView - éœ€è¦æ‰“å¼€çš„åº”ç”¨é¡µé¢å…ƒç´ 
     */
    function openApp(iconEl, appView) {
        if (!appView) return;

        // 1. åŠ¨æ€è®¡ç®—å˜æ¢åŸç‚¹ (Transform Origin) - å®ç°â€œä»å›¾æ ‡ç‚¸å¼€â€çš„æ ¸å¿ƒ
        // ä½¿ç”¨å…¨å±€å˜é‡ phoneFrame (åœ¨æ–‡ä»¶é¡¶éƒ¨å®šä¹‰çš„ .phone-frame å…ƒç´ )
        if (iconEl && typeof phoneFrame !== 'undefined') {
            const iconRect = iconEl.getBoundingClientRect();
            const frameRect = phoneFrame.getBoundingClientRect();

            // è®¡ç®—å›¾æ ‡ä¸­å¿ƒç‚¹ç›¸å¯¹äºæ‰‹æœºå±å¹•å·¦ä¸Šè§’çš„åæ ‡
            const relativeX = iconRect.left + iconRect.width / 2 - frameRect.left;
            const relativeY = iconRect.top + iconRect.height / 2 - frameRect.top;

            // è®¾ç½®åˆ° appView ä¸Š
            appView.style.transformOrigin = `${relativeX}px ${relativeY}px`;
        } else {
            // å¦‚æœæ²¡æœ‰å›¾æ ‡ï¼ˆæ¯”å¦‚ç›´æ¥è°ƒç”¨ï¼‰ï¼Œé»˜è®¤ä»ä¸­å¿ƒæ”¾å¤§
            appView.style.transformOrigin = 'center center';
        }

        // 2. è§¦å‘åŠ¨ç”»ç±»å
        // æ® appView çš„ ID (å¦‚ settings-screen) æ¨å¯¼ç±»å (å¦‚ show-settings) å¹¶æ·»åŠ åˆ° phoneFrame
        const screenId = appView.id;
        if (screenId && screenId.includes('-screen')) {
            const appId = screenId.replace('-screen', '');
            phoneFrame.classList.add(`show-${appId}`);
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯æ¶ˆæ¯APPï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„æ•°æ®åŒæ­¥é€»è¾‘
            // (è™½ç„¶å·²ç»åœ¨ click ç›‘å¬å™¨é‡Œå†™äº†ï¼Œä½†ä¸ºäº†ä¿é™©èµ·è§ï¼Œè¿™é‡Œçº¯ç²¹å¤„ç†åŠ¨ç”»)
        } else {
             // å…¼å®¹æ—§é€»è¾‘
             appView.classList.add('active');
        }

        // 3. å›¾æ ‡å¾®åŠ¨åé¦ˆ
        if (iconEl) {
            iconEl.style.transition = 'transform 0.1s ease';
            iconEl.style.transform = 'scale(0.85)'; // æŒ‰å‹æ„Ÿæ›´å¼ºä¸€ç‚¹
            setTimeout(() => {
                iconEl.style.transform = 'scale(1)';
            }, 150);
        }
    }



    // ==========================================================
    // SECTION 3: äº‹ä»¶ç›‘å¬å™¨ (æœ€ç»ˆç‰ˆ)
    // ==========================================================



    // === å…¨å±€ç¾åŒ–äº¤äº’é€»è¾‘ ===

    // 1. è¿›å…¥é¡µé¢
    if (globalBeautifyBtn) {
        globalBeautifyBtn.addEventListener('click', () => {
            // æ‰“å¼€é¡µé¢å‰ï¼Œç¡®ä¿è¾“å…¥æ¡†é‡Œæ˜¯æœ€æ–°çš„ä»£ç 
            phoneFrame.classList.add('show-global-beautify'); // æˆ‘ä»¬éœ€è¦å»CSSé‡ŒåŠ è¿™ä¸ªclass
        });
    }

    // 2. è¿”å›
    if (globalBeautifyBackBtn) {
        globalBeautifyBackBtn.addEventListener('click', () => {
            phoneFrame.classList.remove('show-global-beautify');
        });
    }

    // 3. ä¿å­˜å¹¶åº”ç”¨
    if (saveGlobalCssBtn) {
        saveGlobalCssBtn.addEventListener('click', async () => {
            const cssCode = globalCssInput.value;

            // a. ç«‹å³åº”ç”¨
            applyGlobalCss(cssCode);

            // b. ä¿å­˜åˆ°æ•°æ®åº“
            try {
                await dbHelper.saveData('settingsStore', 'globalUserCss', cssCode);
                alert("å…¨å±€æ ·å¼å·²åº”ç”¨ï¼");
                // è‡ªåŠ¨è¿”å›ä¸Šä¸€é¡µ
                phoneFrame.classList.remove('show-global-beautify');
            } catch (e) {
                alert("ä¿å­˜å¤±è´¥ï¼š" + e.message);
            }
        });
    }

    // 4. é‡ç½® (æ¸…ç©º)
    if (resetGlobalCssBtn) {
        resetGlobalCssBtn.addEventListener('click', async () => {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å…¨å±€ç¾åŒ–ä»£ç å—ï¼Ÿ")) {
                applyGlobalCss(''); // æ¸…ç©ºæ ·å¼
                await dbHelper.saveData('settingsStore', 'globalUserCss', ''); // æ¸…ç©ºæ•°æ®åº“
                alert("å·²é‡ç½®ã€‚");
            }
        });
    }

    // ==========================================================
    // === èŠå¤©èƒŒæ™¯è®¾ç½®åŠŸèƒ½ ===
    // ==========================================================
    
    /**
     * åº”ç”¨èŠå¤©èƒŒæ™¯åˆ°æ¶ˆæ¯å®¹å™¨
     * @param {string} backgroundUrl - èƒŒæ™¯å›¾ç‰‡çš„URL (Base64æˆ–HTTPé“¾æ¥)
     */
    /**
     * åº”ç”¨èŠå¤©èƒŒæ™¯åˆ°æ¶ˆæ¯å®¹å™¨ (æ€§èƒ½ä¼˜åŒ–ç‰ˆ - V2.0)
     * è§£å†³é«˜æ¸…å¤§å›¾å¯¼è‡´çš„é¢æ¿å¡é¡¿ã€æ‰å¸§é—®é¢˜
     * ç­–ç•¥: ç‹¬ç«‹åˆæˆå±‚ + ç¡¬ä»¶åŠ é€Ÿ + é¿å…ä¸»å®¹å™¨é‡ç»˜
     * @param {string} backgroundUrl - èƒŒæ™¯å›¾ç‰‡çš„URL (Base64æˆ–HTTPé“¾æ¥)
     */
    function applyChatBackground(backgroundUrl) {
        if (!chatMessagesContainer) return;
        
        // 1. æŸ¥æ‰¾æˆ–åˆ›å»ºä¸“ç”¨çš„é«˜æ€§èƒ½èƒŒæ™¯å±‚
        let bgLayer = document.getElementById('optimized-chat-bg-layer');
        
        if (!bgLayer) {
            bgLayer = document.createElement('div');
            bgLayer.id = 'optimized-chat-bg-layer';
            
            // æ ¸å¿ƒä¼˜åŒ–æ ·å¼ï¼šå¼ºåˆ¶å¼€å¯ GPU åŠ é€Ÿï¼Œç‹¬ç«‹æ¸²æŸ“å±‚
            bgLayer.style.cssText = `
                position: absolute;
                top: 0; left: 0; right: 0; bottom: 0;
                width: 100%; height: 100%;
                z-index: 0; /* ä½äºå†…å®¹ä¹‹ä¸‹ */
                pointer-events: none; /* ç‚¹å‡»ç©¿é€ */
                transform: translate3d(0, 0, 0); /* è§¦å‘ç¡¬ä»¶åŠ é€Ÿ */
                will-change: transform; /* å‘ŠçŸ¥æµè§ˆå™¨ä¼˜åŒ– */
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                backface-visibility: hidden; /* ä¿®å¤æŸäº›è®¾å¤‡é—ªçƒ */
            `;

            // æ’å…¥åˆ°æ¶ˆæ¯å®¹å™¨çš„çˆ¶çº§ï¼Œä½†åœ¨æ¶ˆæ¯å®¹å™¨ä¹‹å‰
            // ç¡®ä¿çˆ¶çº§æœ‰å®šä½ä¸Šä¸‹æ–‡
            const parent = chatMessagesContainer.parentNode;
            if (parent) {
                const parentStyle = window.getComputedStyle(parent);
                if (parentStyle.position === 'static') {
                    parent.style.position = 'relative';
                }
                parent.insertBefore(bgLayer, chatMessagesContainer);
            }
        }

        // 2. æ”¹é€ æ¶ˆæ¯å®¹å™¨ï¼šé€æ˜åŒ– + å±‚çº§æå‡
        chatMessagesContainer.style.background = 'none'; // ç§»é™¤æ—§èƒŒæ™¯
        chatMessagesContainer.style.backgroundColor = 'transparent';
        chatMessagesContainer.style.position = 'relative'; // ç¡®ä¿åœ¨èƒŒæ™¯å±‚ä¹‹ä¸Š
        chatMessagesContainer.style.zIndex = '1';

        // 3. åº”ç”¨èƒŒæ™¯å›¾ (ä½¿ç”¨ RAF é¿å…é˜»å¡å½“å‰å¸§)
        if (backgroundUrl) {
            requestAnimationFrame(() => {
                // é¢„åŠ è½½ç­–ç•¥ï¼šå¤§å›¾å¦‚æœä¸é¢„åŠ è½½ç›´æ¥ä¸Šå±å¯èƒ½ä¼šç¬é—´å¡é¡¿
                // ä½†ä¸ºäº†å“åº”é€Ÿåº¦ï¼Œæˆ‘ä»¬ç›´æ¥ä¸Šå±ï¼Œä¾é  GPU å±‚æ¥å¤„ç†æ¸²æŸ“
                bgLayer.style.backgroundImage = `url('${backgroundUrl}')`;
            });
        } else {
            bgLayer.style.backgroundImage = '';
            // å¦‚æœæ²¡æœ‰èƒŒæ™¯å›¾ï¼Œéšè—å±‚ä»¥èŠ‚çœèµ„æº
            bgLayer.style.display = 'none'; 
        }

        if (backgroundUrl) {
            bgLayer.style.display = 'block';
        }
    }

    // "é€‰æ‹©å›¾ç‰‡"æŒ‰é’® - è§¦å‘æ–‡ä»¶é€‰æ‹©
    if (uploadChatBgBtn) {
        uploadChatBgBtn.addEventListener('click', () => {
            if (chatBgUploadInput) {
                chatBgUploadInput.click();
            }
        });
    }

    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    if (chatBgUploadInput) {
        chatBgUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            try {
                // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºBase64
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Url = e.target.result;
                    
                    // åº”ç”¨èƒŒæ™¯
                    applyChatBackground(base64Url);
                    
                    // ä¿å­˜åˆ°å½“å‰è”ç³»äºº
                    if (currentOpenContact) {
                        currentOpenContact.chatBackground = base64Url;
                        
                        // ä¿å­˜åˆ°æ•°æ®åº“
                        try {
                            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                            let allContacts = contactsData.value;
                            const index = allContacts.findIndex(c => c.id === currentOpenContact.id);
                            
                            if (index > -1) {
                                // åŒæ­¥æ›´æ–° backgroundImage ä»¥é˜²æ­¢æ•°æ®å›æ»š
                                currentOpenContact.backgroundImage = base64Url;

                                allContacts[index] = currentOpenContact;
                                await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                                
                                // ã€ä¿®å¤ã€‘åŒæ­¥æ›´æ–°å…¨å±€ç¼“å­˜
                                if (typeof Global_AllContactsCache !== 'undefined') {
                                    Global_AllContactsCache = allContacts;
                                }

                                console.log('èŠå¤©èƒŒæ™¯å·²ä¿å­˜åˆ°æ•°æ®åº“');
                            } else {
                                console.error('æœªæ‰¾åˆ°è”ç³»äººç´¢å¼•');
                            }
                        } catch (error) {
                            console.error('ä¿å­˜èŠå¤©èƒŒæ™¯å¤±è´¥:', error);
                            alert('ä¿å­˜å¤±è´¥,è¯·é‡è¯•');
                        }
                    } else {
                        console.error('currentOpenContact æœªå®šä¹‰');
                    }
                };
                reader.readAsDataURL(file);
                
                // æ¸…ç©ºinput,å…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                event.target.value = '';
                
            } catch (error) {
                console.error('è¯»å–å›¾ç‰‡å¤±è´¥:', error);
                alert('è¯»å–å›¾ç‰‡å¤±è´¥,è¯·é‡è¯•');
            }
        });
    }

    // "æ¢å¤é»˜è®¤"æŒ‰é’® - æ¸…é™¤èƒŒæ™¯
    if (resetChatBgBtn) {
        resetChatBgBtn.addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤èŠå¤©èƒŒæ™¯å—?')) return;
            
            // æ¸…é™¤èƒŒæ™¯ - ç«‹å³åº”ç”¨åˆ°UI
            applyChatBackground(null);
            
            // ä»å½“å‰è”ç³»äººä¸­åˆ é™¤èƒŒæ™¯è®¾ç½® (åˆ é™¤ä¸¤ä¸ªå±æ€§ä»¥ç¡®ä¿å®Œå…¨æ¸…é™¤)
            if (currentOpenContact) {
                // ã€ä¿®å¤ã€‘æ˜¾å¼è®¾ç½®ä¸º nullï¼Œè€Œéä»… deleteï¼Œç¡®ä¿è¦†ç›–æ—§å€¼
                currentOpenContact.chatBackground = null;
                currentOpenContact.backgroundImage = null;
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                try {
                    const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                    let allContacts = contactsData.value;
                    const index = allContacts.findIndex(c => c.id === currentOpenContact.id);
                    
                    if (index > -1) {
                        // ã€ä¿®å¤ã€‘æ˜¾å¼è®¾ç½®æ•°æ®åº“å¯¹è±¡çš„èƒŒæ™¯å±æ€§ä¸º null
                        allContacts[index].chatBackground = null;
                        allContacts[index].backgroundImage = null;
                        await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                        
                        // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒæ­¥æ›´æ–°å…¨å±€ç¼“å­˜ï¼Œé˜²æ­¢åç»­æ“ä½œä½¿ç”¨æ—§ç¼“å­˜
                        if (typeof Global_AllContactsCache !== 'undefined') {
                            Global_AllContactsCache = allContacts;
                        }
                        
                        console.log('[ResetChatBg] å·²æ¸…é™¤èŠå¤©èƒŒæ™¯ï¼ŒID:', currentOpenContact.id);
                    }
                    
                    alert('å·²æ¢å¤é»˜è®¤èƒŒæ™¯');
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥,è¯·é‡è¯•');
                }
            } else {
                console.error('currentOpenContact æœªå®šä¹‰');
            }
        });
    }

    // === ä¸»é¢˜é¢„è®¾åŠŸèƒ½ ===
    const themePresetsBtn = document.getElementById('theme-presets-btn');
    const themePresetsScreen = document.getElementById('theme-presets-screen');
    const themePresetsBackBtn = document.getElementById('theme-presets-back-button');
    const themePresetsList = document.getElementById('theme-presets-list');
    const themePresetsEmpty = document.getElementById('theme-presets-empty');
    const saveAsThemePresetBtn = document.getElementById('save-as-theme-preset-btn');
    const importThemePresetBtn = document.getElementById('import-theme-preset-btn');
    const themePresetImportInput = document.getElementById('theme-preset-import-input');

    // åŠ è½½ä¸»é¢˜é¢„è®¾åˆ—è¡¨
    function loadThemePresets() {
        const presets = JSON.parse(localStorage.getItem('themePresets') || '[]');
        return presets;
    }

    // ä¿å­˜ä¸»é¢˜é¢„è®¾åˆ—è¡¨
    function saveThemePresets(presets) {
        localStorage.setItem('themePresets', JSON.stringify(presets));
    }

    // æ¸²æŸ“é¢„è®¾åˆ—è¡¨
    function renderThemePresets() {
        const presets = loadThemePresets();
        themePresetsList.innerHTML = '';

        if (presets.length === 0) {
            themePresetsEmpty.style.display = 'block';
            return;
        }
        themePresetsEmpty.style.display = 'none';

        presets.forEach((preset, index) => {
            const item = document.createElement('div');
            item.className = 'theme-preset-item';
            
            const previewText = preset.css.length > 100 ? preset.css.substring(0, 100) + '...' : preset.css;
            const timeStr = new Date(preset.createdAt).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            item.innerHTML = `
                <div class="theme-preset-header">
                    <span class="theme-preset-name">${preset.name}</span>
                    <span class="theme-preset-time">${timeStr}</span>
                </div>
                <div class="theme-preset-preview">${previewText || '(ç©º)'}</div>
                <div class="theme-preset-actions">
                    <button class="apply-btn" data-index="${index}">åº”ç”¨</button>
                    <button class="export-btn" data-index="${index}">å¯¼å‡º</button>
                    <button class="delete-btn" data-index="${index}">åˆ é™¤</button>
                </div>
            `;
            themePresetsList.appendChild(item);
        });

        // ç»‘å®šäº‹ä»¶
        themePresetsList.querySelectorAll('.apply-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.dataset.index);
                applyThemePreset(idx);
            });
        });

        themePresetsList.querySelectorAll('.export-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.dataset.index);
                exportThemePreset(idx);
            });
        });

        themePresetsList.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.dataset.index);
                deleteThemePreset(idx);
            });
        });
    }

    // åº”ç”¨é¢„è®¾
    function applyThemePreset(index) {
        const presets = loadThemePresets();
        if (presets[index]) {
            const css = presets[index].css;
            globalCssInput.value = css;
            applyGlobalCss(css);
            dbHelper.saveData('settingsStore', 'globalUserCss', css);
            alert(`å·²åº”ç”¨ä¸»é¢˜: ${presets[index].name}`);
        }
    }

    // å¯¼å‡ºé¢„è®¾
    function exportThemePreset(index) {
        const presets = loadThemePresets();
        if (presets[index]) {
            const preset = presets[index];
            const dataStr = JSON.stringify(preset, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${preset.name}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }

    // åˆ é™¤é¢„è®¾
    function deleteThemePreset(index) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¸»é¢˜é¢„è®¾å—ï¼Ÿ')) {
            const presets = loadThemePresets();
            presets.splice(index, 1);
            saveThemePresets(presets);
            renderThemePresets();
        }
    }

    // è¿›å…¥é¢„è®¾ç®¡ç†é¡µé¢
    if (themePresetsBtn) {
        themePresetsBtn.addEventListener('click', () => {
            renderThemePresets();
            phoneFrame.classList.add('show-theme-presets');
        });
    }

    // è¿”å›
    if (themePresetsBackBtn) {
        themePresetsBackBtn.addEventListener('click', () => {
            phoneFrame.classList.remove('show-theme-presets');
        });
    }

    // ä¿å­˜ä¸ºé¢„è®¾
    if (saveAsThemePresetBtn) {
        saveAsThemePresetBtn.addEventListener('click', () => {
            const css = globalCssInput.value.trim();
            if (!css) {
                alert('è¯·å…ˆè¾“å…¥CSSä»£ç å†ä¿å­˜ä¸ºé¢„è®¾');
                return;
            }

            const name = prompt('è¯·è¾“å…¥é¢„è®¾åç§°:', 'æˆ‘çš„ä¸»é¢˜ ' + (loadThemePresets().length + 1));
            if (!name) return;

            const presets = loadThemePresets();
            presets.unshift({
                name: name,
                css: css,
                createdAt: Date.now()
            });
            saveThemePresets(presets);
            alert('é¢„è®¾å·²ä¿å­˜ï¼');
        });
    }

    // å¯¼å…¥é¢„è®¾æŒ‰é’®
    if (importThemePresetBtn) {
        importThemePresetBtn.addEventListener('click', () => {
            themePresetImportInput.click();
        });
    }

    // å¤„ç†å¯¼å…¥
    if (themePresetImportInput) {
        themePresetImportInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const preset = JSON.parse(event.target.result);
                    if (!preset.name || typeof preset.css !== 'string') {
                        throw new Error('æ— æ•ˆçš„é¢„è®¾æ ¼å¼');
                    }
                    preset.createdAt = preset.createdAt || Date.now();

                    const presets = loadThemePresets();
                    presets.unshift(preset);
                    saveThemePresets(presets);
                    renderThemePresets();
                    alert(`æˆåŠŸå¯¼å…¥ä¸»é¢˜: ${preset.name}`);
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // æ¸…ç©ºä»¥ä¾¿é‡å¤å¯¼å…¥
        });
    }

    // === æ°”æ³¡æ ·å¼é¢„è®¾åŠŸèƒ½ ===
    const bubblePresetsBtn = document.getElementById('bubble-presets-btn');
    const bubblePresetsScreen = document.getElementById('bubble-presets-screen');
    const bubblePresetsBackBtn = document.getElementById('bubble-presets-back-button');
    const bubblePresetsList = document.getElementById('bubble-presets-list');
    const bubblePresetsEmpty = document.getElementById('bubble-presets-empty');
    const selectBubblePresetBtn = document.getElementById('select-bubble-preset-btn');
    const saveBubblePresetBtn = document.getElementById('save-bubble-preset-btn');
    const bubblePresetSelectModal = document.getElementById('bubble-preset-select-modal');
    const bubblePresetSelectCloseBtn = document.getElementById('bubble-preset-select-close-btn');
    const bubblePresetSelectList = document.getElementById('bubble-preset-select-list');
    const bubblePresetSelectEmpty = document.getElementById('bubble-preset-select-empty');

    // åŠ è½½æ°”æ³¡é¢„è®¾åˆ—è¡¨
    function loadBubblePresets() {
        return JSON.parse(localStorage.getItem('bubblePresets') || '[]');
    }

    // ä¿å­˜æ°”æ³¡é¢„è®¾åˆ—è¡¨
    function saveBubblePresetsToStorage(presets) {
        localStorage.setItem('bubblePresets', JSON.stringify(presets));
    }

    // æ¸²æŸ“æ°”æ³¡é¢„è®¾ç®¡ç†åˆ—è¡¨
    function renderBubblePresets() {
        const presets = loadBubblePresets();
        bubblePresetsList.innerHTML = '';

        if (presets.length === 0) {
            bubblePresetsEmpty.style.display = 'block';
            return;
        }
        bubblePresetsEmpty.style.display = 'none';

        presets.forEach((preset, index) => {
            const item = document.createElement('div');
            item.className = 'bubble-preset-item';
            
            const previewText = preset.css.length > 80 ? preset.css.substring(0, 80) + '...' : preset.css;
            const timeStr = new Date(preset.createdAt).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            item.innerHTML = `
                <div class="preset-header">
                    <span class="preset-name">${preset.name}</span>
                    <span class="preset-time">${timeStr}</span>
                </div>
                <div class="preset-preview">${previewText || '(ç©º)'}</div>
                <div class="preset-actions">
                    <button class="share-btn" data-index="${index}">åˆ†äº«</button>
                    <button class="delete-btn" data-index="${index}">åˆ é™¤</button>
                </div>
            `;
            bubblePresetsList.appendChild(item);
        });

        // ç»‘å®šåˆ†äº«äº‹ä»¶
        bubblePresetsList.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.dataset.index);
                shareBubblePreset(idx);
            });
        });

        // ç»‘å®šåˆ é™¤äº‹ä»¶
        bubblePresetsList.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.dataset.index);
                deleteBubblePreset(idx);
            });
        });
    }

    // åˆ†äº«æ°”æ³¡é¢„è®¾ (å¤åˆ¶åˆ°å‰ªè´´æ¿)
    function shareBubblePreset(index) {
        const presets = loadBubblePresets();
        if (presets[index]) {
            const css = presets[index].css;
            navigator.clipboard.writeText(css).then(() => {
                alert(`"${presets[index].name}" çš„CSSä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼`);
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }
    }

    // åˆ é™¤æ°”æ³¡é¢„è®¾
    function deleteBubblePreset(index) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ°”æ³¡é¢„è®¾å—ï¼Ÿ')) {
            const presets = loadBubblePresets();
            presets.splice(index, 1);
            saveBubblePresetsToStorage(presets);
            renderBubblePresets();
        }
    }

    // æ¸²æŸ“é€‰æ‹©å¼¹çª—åˆ—è¡¨
    function renderBubblePresetSelectList() {
        const presets = loadBubblePresets();
        bubblePresetSelectList.innerHTML = '';

        if (presets.length === 0) {
            bubblePresetSelectEmpty.style.display = 'block';
            return;
        }
        bubblePresetSelectEmpty.style.display = 'none';

        presets.forEach((preset, index) => {
            const item = document.createElement('div');
            item.className = 'bubble-select-item';
            item.dataset.index = index;
            
            const previewText = preset.css.length > 30 ? preset.css.substring(0, 30) + '...' : preset.css;

            item.innerHTML = `
                <span class="item-name">${preset.name}</span>
                <span class="item-preview">${previewText}</span>
            `;
            
            item.addEventListener('click', () => {
                applyBubblePresetFromSelect(index);
            });
            
            bubblePresetSelectList.appendChild(item);
        });
    }

    // ä»é€‰æ‹©å¼¹çª—åº”ç”¨é¢„è®¾
    function applyBubblePresetFromSelect(index) {
        const presets = loadBubblePresets();
        if (presets[index] && bubbleCssInput) {
            bubbleCssInput.value = presets[index].css;
            bubblePresetSelectModal.style.display = 'none';
            alert(`å·²é€‰æ‹©é¢„è®¾: ${presets[index].name}\nè¯·ç‚¹å‡»"ä¿å­˜"æŒ‰é’®åº”ç”¨åˆ°å½“å‰èŠå¤©`);
        }
    }

    // è¿›å…¥æ°”æ³¡é¢„è®¾ç®¡ç†é¡µé¢
    if (bubblePresetsBtn) {
        bubblePresetsBtn.addEventListener('click', () => {
            renderBubblePresets();
            phoneFrame.classList.add('show-bubble-presets');
        });
    }

    // è¿”å›
    if (bubblePresetsBackBtn) {
        bubblePresetsBackBtn.addEventListener('click', () => {
            phoneFrame.classList.remove('show-bubble-presets');
        });
    }

    // æ‰“å¼€é€‰æ‹©é¢„è®¾å¼¹çª— - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
    document.addEventListener('click', (e) => {
        if (e.target && (e.target.id === 'select-bubble-preset-btn' || e.target.closest('#select-bubble-preset-btn'))) {
            e.preventDefault();
            e.stopPropagation();
            const modal = document.getElementById('bubble-preset-select-modal');
            if (modal) {
                renderBubblePresetSelectList();
                modal.style.display = 'flex';
            }
        }
    });

    // å…³é—­é€‰æ‹©å¼¹çª—
    if (bubblePresetSelectCloseBtn) {
        bubblePresetSelectCloseBtn.addEventListener('click', () => {
            bubblePresetSelectModal.style.display = 'none';
        });
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    if (bubblePresetSelectModal) {
        bubblePresetSelectModal.addEventListener('click', (e) => {
            if (e.target === bubblePresetSelectModal) {
                bubblePresetSelectModal.style.display = 'none';
            }
        });
    }

    // ä¿å­˜ä¸ºæ°”æ³¡é¢„è®¾ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
    document.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'save-bubble-preset-btn') {
            e.preventDefault();
            e.stopPropagation();
            const cssInput = document.getElementById('bubble-css-input');
            const css = cssInput ? cssInput.value.trim() : '';
            if (!css) {
                alert('è¯·å…ˆè¾“å…¥æ°”æ³¡CSSä»£ç å†ä¿å­˜');
                return;
            }

            const name = prompt('è¯·è¾“å…¥é¢„è®¾åç§°:', 'æˆ‘çš„æ°”æ³¡æ ·å¼ ' + (loadBubblePresets().length + 1));
            if (!name) return;

            const presets = loadBubblePresets();
            presets.unshift({
                name: name,
                css: css,
                createdAt: Date.now()
            });
            saveBubblePresetsToStorage(presets);
            alert('æ°”æ³¡é¢„è®¾å·²ä¿å­˜ï¼');
        }
    });

    menuCopyBtn.addEventListener('click', () => {
        if (!currentLongPressTarget) return;

        // 1. å°è¯•è·å–æ–‡æœ¬å†…å®¹
        let textToCopy = "";

        // ä¼˜å…ˆæŸ¥æ‰¾ç‰¹æ®Šçš„æ–‡æœ¬å®¹å™¨
        const voiceTranscript = currentLongPressTarget.querySelector('.voice-transcript');
        const textImageCard = currentLongPressTarget.querySelector('.text-image-card .card-text');
        const htmlContainer = currentLongPressTarget.querySelector('.html-render-container');
        const normalBubble = currentLongPressTarget.querySelector('.chat-bubble');

        if (voiceTranscript) {
            textToCopy = voiceTranscript.textContent;
        } else if (textImageCard) {
            textToCopy = textImageCard.textContent;
        } else if (htmlContainer) {
            textToCopy = "HTMLå†…å®¹æ— æ³•ç›´æ¥å¤åˆ¶"; // æˆ–è€…æå– innerText
        } else if (normalBubble) {
            // è¿‡æ»¤æ‰å¼•ç”¨å—
            const clone = normalBubble.cloneNode(true);
            const quote = clone.querySelector('.reply-quote-container');
            if (quote) quote.remove();
            textToCopy = clone.textContent.trim();
        }

        // 2. æ‰§è¡Œå¤åˆ¶
        if (textToCopy) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                // ç®€å•çš„æˆåŠŸåé¦ˆ (è¿™é‡Œå€Ÿç”¨ä¸€ä¸‹ç³»ç»Ÿçš„ alert æˆ–è€…ä½ è‡ªå·±åšä¸€ä¸ª toastï¼Œä¸ºäº†ç®€å•å…ˆ alert)
                // å»ºè®®ï¼šæ”¹æˆæ›´ä¼˜é›…çš„è½»æç¤º
                console.log("å·²å¤åˆ¶");
                hideActionMenu();
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥: ', err);
                alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•");
                hideActionMenu();
            });
        } else {
            hideActionMenu();
        }
    });
    menuSelectBtn.addEventListener('click', () => {
        // 1. å…³é—­èœå•
        hideActionMenu();

        // 2. å¦‚æœæœ‰é•¿æŒ‰é€‰ä¸­çš„ç›®æ ‡ï¼Œç›´æ¥è¿›å…¥é€‰æ‹©æ¨¡å¼å¹¶é€‰ä¸­å®ƒ
        if (currentLongPressTarget) {
            enterMessageSelectionMode(currentLongPressTarget);
            toggleMessageSelection(currentLongPressTarget); // é¡ºä¾¿å‹¾é€‰å½“å‰è¿™æ¡
        } else {
            // å¦åˆ™åªæ˜¯è¿›å…¥ç©ºçš„é€‰æ‹©æ¨¡å¼
            enterMessageSelectionMode();
        }
    });

    // === ä¿®å¤ï¼šä¸ƒè¢‹ App åº•æ åˆ‡æ¢é€»è¾‘ ===

    // 1. ç‚¹å‡»å…¨å±€ä»»ä½•åœ°æ–¹å…³é—­èœå•
    document.addEventListener('click', (e) => {
        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯èœå•æœ¬èº«ï¼Œä¸”èœå•æ˜¯å¼€ç€çš„
        if (msgActionMenu.style.display === 'flex' && !msgActionMenu.contains(e.target)) {
            hideActionMenu();
        }
    });

    // 2. æ»šåŠ¨èŠå¤©è®°å½•æ—¶ä¹Ÿå…³é—­èœå•
    chatMessagesContainer.addEventListener('scroll', hideActionMenu);

    // 3. ç‚¹å‡»â€œå¼•ç”¨â€æŒ‰é’®
    // --- 3. ç‚¹å‡»â€œå¼•ç”¨â€æŒ‰é’® (ä¿®å¤ç‰ˆï¼šå…¼å®¹ç¾¤èŠå’Œå•èŠ) ---
    menuReplyBtn.addEventListener('click', () => {
        if (!currentLongPressTarget) return;

        // 1. å°è¯•è·å– wrapper (å…¼å®¹ä¸¤ç§ç±»å)
        const wrapper = currentLongPressTarget.querySelector('.message-content-wrapper') ||
            currentLongPressTarget.querySelector('.group-message-wrapper');

        if (!wrapper) {
            console.error("æ— æ³•æ‰¾åˆ°æ¶ˆæ¯å®¹å™¨");
            hideActionMenu();
            return;
        }

        // 2. è·å–ä¿¡æ¯
        const uuid = currentLongPressTarget.dataset.uuid;
        const isUser = wrapper.classList.contains('user');

        // 3. è·å–æ–‡æœ¬å†…å®¹
        let content = "æ¶ˆæ¯å†…å®¹";
        const bubble = currentLongPressTarget.querySelector('.chat-bubble');

        if (bubble) {
            if (bubble.classList.contains('image-bubble')) {
                content = "[å›¾ç‰‡]";
            } else if (bubble.classList.contains('sticker-bubble')) {
                content = "[è¡¨æƒ…åŒ…]";
            } else if (bubble.querySelector('.voice-transcript')) {
                content = "[è¯­éŸ³]: " + bubble.querySelector('.voice-transcript').textContent;
            } else {
                content = bubble.textContent;
            }
        }

        // 4. ç¡®å®šå‘é€è€…åå­— (å…¼å®¹ç¾¤èŠ/å•èŠ)
        let senderName = "æœªçŸ¥";
        if (isUser) {
            // å¦‚æœæ˜¯æˆ‘å‘çš„
            if (currentOpenGroup) senderName = currentOpenGroup.userCardName || "æˆ‘";
            else if (currentOpenContact) senderName = currentOpenContact.user.name;
        } else {
            // å¦‚æœæ˜¯å¯¹æ–¹/ç¾¤å‹å‘çš„
            const nameDiv = currentLongPressTarget.querySelector('.group-nickname');
            if (nameDiv) {
                senderName = nameDiv.textContent; // ç¾¤èŠä¼˜å…ˆè¯»æ˜µç§°
            } else if (currentOpenContact) {
                senderName = currentOpenContact.ai.name; // å•èŠè¯»AIå
            }
        }

        // 5. è®¾ç½®å›å¤çŠ¶æ€
        currentReplyTarget = {
            uuid: uuid,
            text: content,
            senderName: senderName
        };

        // 6. æ›´æ–°UIå¹¶æ˜¾ç¤º
        replyPreviewName.textContent = senderName;
        replyPreviewContent.textContent = content;

        // å¼ºåˆ¶è®¾ç½®ä¸º flex æ˜¾ç¤º
        replyPreviewBar.style.display = 'flex';

        // èšç„¦è¾“å…¥æ¡†å¹¶å…³é—­èœå•
        chatMessageInput.focus();
        hideActionMenu();
    });

    // 4. ç‚¹å‡»â€œå–æ¶ˆå¼•ç”¨â€
    cancelReplyBtn.addEventListener('click', cancelReplyMode);
    shopSegmentBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            shopSegmentBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const target = btn.dataset.target;

            // æ»‘å—åŠ¨ç”»
            if (target === 'my') {
                shopSegmentControl.classList.add('my-mode');
                if (shopTitle) shopTitle.textContent = 'æˆ‘çš„';
                document.getElementById('my-account-content-panel').classList.add('active');
                document.getElementById('shopping-content-panel').classList.remove('active');
            } else {
                shopSegmentControl.classList.remove('my-mode');
                if (shopTitle) shopTitle.textContent = '7 SHOP';
                document.getElementById('my-account-content-panel').classList.remove('active');
                document.getElementById('shopping-content-panel').classList.add('active');

                // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ä»£ç ã€‘â–¼â–¼â–¼
                // åˆ‡å›æ¥æ—¶ï¼Œè·å–å½“å‰æ¿€æ´»çš„åˆ†ç±»ï¼Œå¹¶å¼ºåˆ¶é‡æ–°æ¸²æŸ“å•†å“åˆ—è¡¨
                const activeCatBtn = document.querySelector('.category-tab.active');
                // å¦‚æœæ‰¾ä¸åˆ°æ¿€æ´»çš„åˆ†ç±»ï¼Œé»˜è®¤ç”¨ 'takeout' (å¤–å–)
                const currentCat = activeCatBtn ? activeCatBtn.dataset.category : 'takeout';
                renderProducts(currentCat);
                // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
            }
        });
    });

    // === ä¿®å¤ï¼šæ‘¸é±¼ App åº•æ åˆ‡æ¢é€»è¾‘ ===
    gameSegmentBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            gameSegmentBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const target = btn.dataset.target;

            // æ»‘å—åŠ¨ç”»
            if (target === 'savings') {
                gameSegmentControl.classList.add('savings-mode');
                if (slackingOffTitle) slackingOffTitle.textContent = 'å‚¨è“„';

                document.getElementById('savings-content-panel').classList.add('active');
                document.getElementById('games-content-panel').classList.remove('active');

                // é¡ºä¾¿åˆ·æ–°ä¸€ä¸‹ä½™é¢æ˜¾ç¤º
                updateBalanceDisplay();
            } else {
                gameSegmentControl.classList.remove('savings-mode');
                if (slackingOffTitle) slackingOffTitle.textContent = 'æ¸¸æˆ';

                document.getElementById('savings-content-panel').classList.remove('active');
                document.getElementById('games-content-panel').classList.add('active');

                // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ä»£ç ã€‘â–¼â–¼â–¼
                // åˆ‡å›æ¥æ—¶ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“æ¸¸æˆåˆ—è¡¨
                renderGames();
                // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
            }
        });
    });

    gachaSegmentBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // 1. æŒ‰é’®æ–‡å­—çŠ¶æ€åˆ‡æ¢
            gachaSegmentBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // 2. è·å–ç›®æ ‡
            const target = btn.dataset.target;

            // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘æ§åˆ¶æ»‘å—ç§»åŠ¨ (é€šè¿‡ç»™çˆ¶å®¹å™¨åŠ ç±»å)
            if (target === 'forum') {
                gachaSegmentControl.classList.add('forum-mode'); // CSSæ§åˆ¶æ»‘å—å³ç§»
                gachaTitle.textContent = 'FORUM';
            } else {
                gachaSegmentControl.classList.remove('forum-mode'); // CSSæ§åˆ¶æ»‘å—å·¦ç§»
                gachaTitle.textContent = 'SHARE';
            }

            // 4. é¢æ¿åˆ‡æ¢
            document.querySelectorAll('.gacha-content-panel').forEach(p => p.classList.remove('active'));
            const targetPanel = document.getElementById(`${target}-content-panel`);
            if (targetPanel) targetPanel.classList.add('active');
        });
    });
    // 1. æ‰“å¼€æŠ½å±‰
    openDrawerBtn.addEventListener('click', () => {
        bottomDrawer.classList.add('active');
    });

    // 2. å…³é—­æŠ½å±‰ (ç‚¹å‡»é¡¶éƒ¨æ¨ªæ¡)
    closeDrawerBtn.addEventListener('click', () => {
        bottomDrawer.classList.remove('active');
    });
    // --- ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç›‘å¬æ‰€æœ‰Appå›¾æ ‡çš„ç‚¹å‡» ---
    appGrid.addEventListener('click', (event) => {
        const iconContainer = event.target.closest('.app-container[data-app-id]');
        if (iconContainer) {
            const appId = iconContainer.dataset.appId;

            // === ä¸´æ—¶ç»´ä¿®æ‹¦æˆª ===
            if (appId === 'music-screen') {
                alert('æš‚åœä½¿ç”¨ï¼Œå¾…ç»´ä¿®');
                return;
            }

            const appScreen = document.getElementById(appId);
            if (appScreen) {
                openApp(iconContainer, appScreen);
            }
        }
    });




    const dbHelper = {
        db: null,
        dbName: 'phoneDataDB',

        // 1. åˆå§‹åŒ–æ•°æ®åº“ (V3 - Final Robust Version)
        async init() {
            // å¦‚æœè¿æ¥å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªå·²å®Œæˆçš„Promise
            if (this.db) {
                return Promise.resolve();
            }

            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, 18); 

                request.onerror = (event) => {
                    // å¦‚æœæ‰“å¼€å¤±è´¥ï¼Œç›´æ¥æ‹’ç»Promise
                    console.error("æ•°æ®åº“æ‰“å¼€æ—¶å‘ç”Ÿé”™è¯¯:", request.error);
                    reject(`æ•°æ®åº“æ‰“å¼€å¤±è´¥: ${request.error}`);
                };

                request.onupgradeneeded = (event) => {
                    console.log("æ•°æ®åº“éœ€è¦å‡çº§æˆ–é¦–æ¬¡åˆ›å»º...");
                    const db = event.target.result;
                    const transaction = event.target.transaction;

                    const objectStores = ['settingsStore', 'messageContacts', 'musicPlaylists', 'worldBooks', 'emojiStore', 'gachaPosts', 'gachaPostInteractions', 'worldBookGroups', 'iconPresets', 'datingSetupStore', 'writingStylePresets', 'datingHistoryStore', 'fontUrlStore', 'groupChats', 'qilangPosts', 'wowPosts', 'memoryCheques'];

                    try {
                        objectStores.forEach(name => {
                            if (!db.objectStoreNames.contains(name)) {
                                console.log(`æ­£åœ¨åˆ›å»ºè¡¨: ${name}`);
                                if (name === 'emojiStore') {
                                    db.createObjectStore(name, { keyPath: 'url' });
                                } else {
                                    db.createObjectStore(name, { keyPath: 'id' });
                                }
                            }
                        });
                        console.log("æ‰€æœ‰è¡¨ç»“æ„æ£€æŸ¥/åˆ›å»ºå®Œæ¯•ã€‚");
                    } catch (e) {
                        console.error("åœ¨ onupgradeneeded äº‹ä»¶ä¸­åˆ›å»ºè¡¨å¤±è´¥:", e);
                        // å¦‚æœåœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å‡ºé”™ï¼Œæ‹’ç»Promise
                        reject("åˆ›å»ºæ•°æ®åº“è¡¨å¤±è´¥");
                        // ä¸­æ–­äº‹åŠ¡
                        if (transaction) transaction.abort();
                        return;
                    }
                    if (!db.objectStoreNames.contains('forwardedRecords')) {
                        console.log("æ­£åœ¨åˆ›å»º forwardedRecords è¡¨...");
                        db.createObjectStore('forwardedRecords', { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    console.log("æ•°æ®åº“å·²æˆåŠŸè¿æ¥å¹¶å‡†å¤‡å°±ç»ªã€‚");
                    // åªæœ‰åœ¨ onsuccess æ—¶æ‰è§£å†³Promiseï¼Œç¡®ä¿ onupgradeneeded å·²å®Œæˆ
                    resolve();
                };
            });
        },


        // (è¯·ç¡®ä¿å°†æ­¤ init å‡½æ•°ç²˜è´´åˆ°æ‚¨ç°æœ‰çš„ dbHelper å¯¹è±¡ä¸­ï¼Œæ›¿æ¢æ‰æ—§çš„ init)
        async saveData(storeName, id, value) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put({ id, value });

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(`æ•°æ®ä¿å­˜åˆ° ${storeName} å¤±è´¥: ` + event.target.error);
            });
        },
        async loadData(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`ä» ${storeName} è¯»å–æ•°æ®å¤±è´¥: ` + event.target.error);
            });
        },
        async deleteData(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(`ä» ${storeName} åˆ é™¤æ•°æ®å¤±è´¥: ` + event.target.error);
            });
        },
        async getAllDataFromStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`ä» ${storeName} è¯»å–æ‰€æœ‰æ•°æ®å¤±è´¥: ` + event.target.error);
            });
        },
        async clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(`æ¸…ç©º ${storeName} å¤±è´¥: ` + event.target.error);
            });
        },
        async updateRecord(storeName, record) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(record);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(`æ›´æ–° ${storeName} ä¸­çš„è®°å½•å¤±è´¥: ` + event.target.error);
            });
        }
        
    };

    // æš´éœ²åˆ° window ä¸Šï¼Œä¾›å…¶ä»–æ¨¡å—ï¼ˆå¦‚é€¸äº‹åŠŸèƒ½ï¼‰è®¿é—®
    window.dbHelper = dbHelper;

    // === IndexedDB å¸®åŠ©å‡½æ•° END ===





    manageFontUrlsBtn.addEventListener('click', () => {
        phoneFrame.classList.add('show-font-url');
        renderFontUrlList(); // <-- Add this line
    });
    fontUrlBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean('font-url-list-container');
        phoneFrame.classList.remove('show-font-url');
    });
    // === (æ–°å¢) çº¦ä¼šå¼•å¯¼é¡µè¿”å›æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ ===
    datingSetupBackButton.addEventListener('click', () => {
        // ç§»é™¤ 'show-dating' ç±»ï¼Œè§¦å‘ä¸»çº¦ä¼šç•Œé¢çš„æ·¡å‡ºåŠ¨ç”»
        phoneFrame.classList.remove('show-dating');

        // åœ¨åŠ¨ç”»ç»“æŸåï¼Œå½»åº•é‡ç½®æ‰€æœ‰çº¦ä¼šç›¸å…³çš„UIçŠ¶æ€
        setTimeout(() => {
            datingSetupScreen.classList.remove('visible');
            vnScreen.classList.remove('visible');
            firstLoader.classList.remove('visible');
            secondLoader.classList.remove('visible');

            // æ¢å¤ä¸»å®¹å™¨çš„é»˜è®¤æ ·å¼
            datingScreen.style.pointerEvents = '';
            datingScreen.style.zIndex = '';
        }, 500); // 500ms å¯¹åº”CSSä¸­çš„åŠ¨ç”»æ—¶é•¿
    });
    // 2. ä¸ºâ€œçº¦ä¼šè®°å½•â€æŒ‰é’®ç»‘å®šæ‰“å¼€é¡µé¢çš„äº‹ä»¶
    datingHistoryButton.addEventListener('click', () => {
        loadAndDisplayDatingHistory();
        // æ¿€æ´»æ–°ç•Œé¢çš„æ˜¾ç¤ºåŠ¨ç”»
        phoneFrame.classList.add('show-dating-history');
        // å…³é—­åŠŸèƒ½é¢æ¿
        toggleFeaturesPanel();
    });
    // 3. ä¸ºæ–°ç•Œé¢çš„â€œè¿”å›â€æŒ‰é’®ç»‘å®šå…³é—­äº‹ä»¶
    datingHistoryBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean("dating-history-container"); // âœ…
  
        phoneFrame.classList.remove('show-dating-history');
    });
    // --- è‡ªå®šä¹‰è¾“å…¥å¼¹çª—çš„äº‹ä»¶ ---
    customChoiceCloseBtn.addEventListener('click', closeCustomChoiceModal);
    // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
    customChoiceModal.addEventListener('click', (event) => {
        if (event.target === customChoiceModal) {
            closeCustomChoiceModal();
        }
    });

    function closeCustomChoiceModal() {
        customChoiceModal.classList.remove('visible');
        setTimeout(() => {
            customChoiceModal.style.display = 'none';
        }, 300); // ç­‰å¾…åŠ¨ç”»ç»“æŸ
    }
    customChoiceConfirmBtn.addEventListener('click', () => {
        const text = customChoiceInput.value.trim();
        if (text) {
            handleChoiceSelection(text);
            closeCustomChoiceModal();
        }
    });


    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ•´ä¸ªè®¾ç½®é¡µé¢å®¹å™¨çš„æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
    datingSettingsScreen.addEventListener('click', (event) => {
        const target = event.target;

        // æƒ…å†µ1: ç‚¹å‡»äº†ä¸»èœå•çš„è¿”å›æŒ‰é’®
        if (target.id === 'dating-settings-back-btn') {
            phoneFrame.classList.remove('show-dating-settings');
        }

        // æƒ…å†µ2: ç‚¹å‡»äº†ä¸€ä¸ªèœå•æŒ‰é’®
        if (target.classList.contains('menu-button')) {
            const targetId = target.dataset.target; // targetId åœ¨è¿™é‡Œè¢«æ­£ç¡®å®šä¹‰
            const targetPage = document.getElementById(targetId);

            if (targetPage) {
                // éšè—ä¸»èœå•ï¼Œæ˜¾ç¤ºç›®æ ‡å­é¡µé¢
                document.getElementById('dating-settings-main').style.display = 'none';
                targetPage.style.display = 'flex';

                // æ ¹æ®ç‚¹å‡»çš„æŒ‰é’®ï¼ŒåŠ è½½ä¸åŒçš„å†…å®¹
                if (targetId === 'portrait-settings') {
                    const contentArea = document.getElementById('portrait-settings-content');
                    contentArea.innerHTML = portraitSettingsHTML;
                    bindPortraitSettingsEvents(contentArea);
                } else if (targetId === 'background-settings') {
                    const contentArea = document.getElementById('background-settings-content');
                    contentArea.innerHTML = backgroundSettingsHTML;
                    bindBackgroundSettingsEvents(contentArea);
                } else if (targetId === 'font-settings') {
                    const contentArea = document.getElementById('font-settings-content');
                    contentArea.innerHTML = fontSettingsHTML;
                    bindFontSettingsEvents(contentArea);
                } else if (targetId === 'writing-style-settings') { // è¿™æ˜¯æ‚¨ä¹‹å‰æ·»åŠ çš„ä»£ç çš„æ­£ç¡®ä½ç½®
                    const contentArea = document.getElementById('style-presets-container');
                    renderStylePresets(contentArea);
                }
            }
        }

        // æƒ…å†µ3: ç‚¹å‡»äº†å­é¡µé¢çš„è¿”å›æŒ‰é’®
        if (target.classList.contains('submenu-back-btn')) {
            const targetId = target.dataset.target;
            const targetPage = document.getElementById(targetId);
            if (targetPage) {
                target.closest('.settings-submenu').style.display = 'none';
                targetPage.style.display = 'flex';
            }
        }
    });
    // --- æ¨¡æ¿: å®šä¹‰è®¾ç½®æ§ä»¶çš„HTMLï¼Œæ–¹ä¾¿å¤ç”¨ ---
    // --- è¿™æ˜¯ä¿®æ”¹åçš„ä»£ç  ---
    const portraitSettingsHTML = `
    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 30px; gap: 15px;">
        <div class="setup-section">
            <label>å½“å‰ç«‹ç»˜</label>
            <div class="upload-box" id="char-upload-box-settings">ç‚¹å‡»ä¸Šä¼ </div>
            <input type="file" id="char-upload-input-settings" accept="image/*" style="display: none;">
            
            <button id="delete-char-portrait-btn" class="form-button-secondary" style="width: 90%; color: #ff3b30; border-color: rgba(255, 59, 48, 0.2);">åˆ é™¤ç«‹ç»˜</button>
        </div>
    </div>
`;

    const backgroundSettingsHTML = `
    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 30px;">
         <div class="setup-section">
            <label>æ·»åŠ æ–°èƒŒæ™¯</label>
            <div class="upload-box" id="bg-upload-box">ç‚¹å‡»ä¸Šä¼ </div>
            <input type="file" id="bg-upload-input" accept="image/*" style="display: none;">
        </div>
        <div class="setup-section" style="flex-grow: 1; min-height: 0;">
             <label>å·²æ·»åŠ çš„èƒŒæ™¯</label>
             <div id="bg-previews-container"></div>
        </div>
    </div>
`;


    vnSettingsBtn.addEventListener('click', () => {
        phoneFrame.classList.add('show-dating-settings');
        document.getElementById('dating-settings-main').style.display = 'flex';
        document.querySelectorAll('.settings-submenu').forEach(el => el.style.display = 'none');
    });
    // ç”¨ä¸‹é¢è¿™ä¸ªæ–°çš„ä»£ç å—ï¼Œæ›¿æ¢æ‰æ‚¨åŸæ¥çš„ appointmentButton.addEventListener ...
    appointmentButton.addEventListener('click', async () => {
        try {

            if (!currentOpenContact) {
                alert("é”™è¯¯ï¼šæ— æ³•è·å–å½“å‰AIè§’è‰²ä¿¡æ¯ï¼");
                return;
            }

            // a. å…ˆå…³é—­åŠŸèƒ½é¢æ¿
            toggleFeaturesPanel();

            // b. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²æœ‰çº¦ä¼šè®¾ç½®
            const savedSetup = await dbHelper.loadData('datingSetupStore', currentOpenContact.id);

            // c. æ¿€æ´»çº¦ä¼šåŠŸèƒ½æ€»å®¹å™¨
            phoneFrame.classList.add('show-dating');

            if (savedSetup && savedSetup.value && savedSetup.value.portrait && savedSetup.value.backgrounds.some(b => b.isDefault)) {
                // --- åœºæ™¯A: å·²æœ‰è®¾ç½®ï¼Œç›´æ¥èµ´çº¦ ---
                secondLoader.classList.add('visible');
                setTimeout(() => {
                    secondLoader.classList.remove('visible');
                    loadAndEnterVNScreen(savedSetup.value);
                }, 5000);
            } else {
                // --- åœºæ™¯B: é¦–æ¬¡è¿›å…¥ï¼Œæ˜¾ç¤ºå¼•å¯¼è®¾ç½® ---
                firstLoader.classList.add('visible');
                setTimeout(() => {
                    firstLoader.classList.remove('visible');
                    datingSetupScreen.classList.add('visible');
                }, 2000);
            }

            // ================== [æ–°å¢è°ƒè¯•ä»£ç ] å¼€å§‹ ==================
        } catch (error) {
            console.error("ã€è°ƒè¯•ã€‘åœ¨ 'èµ´çº¦' æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­æ•è·åˆ°é”™è¯¯:", error);
            alert("æ“ä½œå¤±è´¥ï¼Œè¯·æŒ‰F12åœ¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†çš„çº¢è‰²é”™è¯¯ä¿¡æ¯ã€‚");
        }
        // ================== [æ–°å¢è°ƒè¯•ä»£ç ] ç»“æŸ ==================
    });
    // 3. ä¸ºVNç•Œé¢çš„â€œé€€å‡ºâ€æŒ‰é’®ç»‘å®šäº‹ä»¶
    // 3. ä¸ºVNç•Œé¢çš„â€œé€€å‡ºâ€æŒ‰é’®ç»‘å®šäº‹ä»¶ (V2 - å¼‚æ­¥éé˜»å¡ç‰ˆ)
    vnExitBtn.addEventListener('click', () => {
         // âœ… æ¸…ç†VNé€‰é¡¹
        window.DOMCleanupManager.clean('vn-choices-container');
        
        // æ¸…ç†VNå¼•æ“çŠ¶æ€
        if (typeof vnSceneQueue !== 'undefined') {
            vnSceneQueue = [];
        }
        if (typeof vnConversationHistory !== 'undefined') {
            vnConversationHistory = [];
        }
        if (typeof currentSegmentIndex !== 'undefined') {
            currentSegmentIndex = 0;
        }
        if (typeof isTyping !== 'undefined') {
            isTyping = false;
        }
        if (confirm("è¦ç»“æŸæœ¬æ¬¡çº¦ä¼šå—ï¼Ÿ\nï¼ˆç»“æŸåAIä¼šä¸ºä½ ç”Ÿæˆä¸€æ®µä¸“å±çš„çº¦ä¼šè®°å¿†ï¼‰")) {

            // 1. ç«‹å³æ‰§è¡Œâ€œå¿«é€Ÿâ€çš„UIé€€å‡ºæ“ä½œï¼Œè®©ç”¨æˆ·æ„Ÿè§‰ä¸åˆ°å¡é¡¿
            phoneFrame.classList.remove('show-dating');

            setTimeout(() => {
                // æ¸…ç†UIçš„é€»è¾‘ä¿æŒä¸å˜
                vnScreen.classList.remove('visible');
                datingSetupScreen.classList.remove('visible');
                datingSettingsScreen.style.display = 'none';
                vnDialogText.innerHTML = '';
                vnChoicesContainer.innerHTML = '';
                vnCharacter.style.backgroundImage = 'none';
                vnBackground.style.backgroundImage = 'none';
                datingScreen.style.pointerEvents = '';
                datingScreen.style.zIndex = '';
                console.log("çº¦ä¼šç•Œé¢å·²å®Œå…¨é€€å‡ºå¹¶é‡ç½®ã€‚");
            }, 800);

            // 2. ç„¶åâ€œå‘å°„åä¸ç®¡â€ï¼Œåœ¨åå°é»˜é»˜æ‰§è¡Œâ€œæ…¢é€Ÿâ€çš„AIæ‘˜è¦ç”Ÿæˆ
            // æ³¨æ„ï¼šæˆ‘ä»¬åœ¨è¿™é‡Œæ²¡æœ‰ä½¿ç”¨ awaitï¼Œæ‰€ä»¥ç¨‹åºä¸ä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼
            generateAndSaveDatingSummary();

            // 3. æ¸…ç©ºæœ¬æ¬¡çº¦ä¼šçš„å¯¹è¯å†å²è®°å½•ï¼Œä¸ºä¸‹æ¬¡åšå‡†å¤‡
            vnConversationHistory = [];
        }
    });

    // 7. ä¸ºä¸Šä¼ æ¡†ç»‘å®šç‚¹å‡»äº‹ä»¶
    charUploadBox.addEventListener('click', () => charUploadInput.click());
    bgUploadBox.addEventListener('click', () => bgUploadInput.click());
    // 8. å¤„ç†ç«‹ç»˜ä¸Šä¼ 
    charUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            datingCharPortrait = e.target.result;
            charUploadBox.style.backgroundImage = `url('${datingCharPortrait}')`;
            charUploadBox.textContent = '';
            saveDatingSetup();
            checkSetupCompletion();
        };
        reader.readAsDataURL(file);
    });

    // 9. å¤„ç†èƒŒæ™¯ä¸Šä¼ 
    bgUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const tagsString = prompt("è¯·è¾“å…¥æ­¤èƒŒæ™¯çš„æ ‡ç­¾ (å¤šä¸ªæ ‡ç­¾è¯·ç”¨ç©ºæ ¼æˆ–é€—å·éš”å¼€):", "é»˜è®¤");
        if (tagsString === null) return; // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ

        const tags = tagsString.split(/[\s,ï¼Œ]+/).filter(tag => tag); // æŒ‰ç©ºæ ¼æˆ–ä¸­è‹±æ–‡é€—å·åˆ†å‰²

        const reader = new FileReader();
        reader.onload = (e) => {
            const newBg = {
                url: e.target.result,
                tags: tags.length > 0 ? tags : ['æœªåˆ†ç±»'],
                isDefault: false
            };
            // å¦‚æœè¿™æ˜¯ä¸Šä¼ çš„ç¬¬ä¸€ä¸ªèƒŒæ™¯ï¼Œè‡ªåŠ¨è®¾ä¸ºé»˜è®¤
            if (datingBackgrounds.length === 0) {
                newBg.isDefault = true;
            }
            datingBackgrounds.push(newBg);
            renderBgPreviews();
            saveDatingSetup();
        };
        reader.readAsDataURL(file);
    });

    // 10. ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†é¢„è§ˆåˆ—è¡¨ä¸­çš„æŒ‰é’®ç‚¹å‡»
    bgPreviewsContainer.addEventListener('click', (event) => {
        const target = event.target;
        const index = parseInt(target.dataset.index, 10);

        if (target.classList.contains('set-default-btn')) {
            datingBackgrounds.forEach((bg, i) => {
                bg.isDefault = (i === index);
            });
            renderBgPreviews();
            saveDatingSetup();
        }

        if (target.classList.contains('delete-btn')) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèƒŒæ™¯å—ï¼Ÿ')) {
                datingBackgrounds.splice(index, 1);
                // å¦‚æœåˆ é™¤çš„æ˜¯é»˜è®¤èƒŒæ™¯ï¼Œä¸”è¿˜æœ‰å…¶ä»–èƒŒæ™¯ï¼Œåˆ™å°†ç¬¬ä¸€ä¸ªè®¾ä¸ºæ–°çš„é»˜è®¤
                if (!datingBackgrounds.some(bg => bg.isDefault) && datingBackgrounds.length > 0) {
                    datingBackgrounds[0].isDefault = true;
                }
                renderBgPreviews();
                saveDatingSetup();
            }
        }
    });

    callSummaryButton.addEventListener('click', () => {
        loadAndRenderSummaries();
        phoneFrame.classList.add('show-summary-list');
        toggleFeaturesPanel();
    });
    summaryListBackButton.addEventListener('click', () => {
         // âœ… æ¸…ç†é€šè¯è®°å½•åˆ—è¡¨
  window.DOMCleanupManager.clean("summary-list-container");
        phoneFrame.classList.remove('show-summary-list');
    });
    summaryDetailBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean("summary-detail-container"); // âœ…
        phoneFrame.classList.remove('show-summary-detail');
        phoneFrame.classList.add('show-summary-list'); // <-- Add this line
    });

    // --- ç‚¹å‡»æ‘˜è¦å¡ç‰‡ï¼Œè¿›å…¥è¯¦æƒ…é¡µ ---

    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
    voiceCallFeatureButton.addEventListener('click', () => {
        startVoiceCall();
    });
    cancelCallButton.addEventListener('click', () => hangUpVoiceCall(false));
    connectedHangUpButton.addEventListener('click', () => hangUpVoiceCall(false));
    userSpeakButton.addEventListener('click', () => {
        voiceCallTextarea.value = '';
        voiceCallInputModal.style.display = 'flex';
        setTimeout(() => {
            voiceCallInputModal.style.opacity = '1';
            voiceCallTextarea.focus();
        }, 10);
    });
    sendCallTextButton.addEventListener('click', handleUserSpeak);
    voiceCallInputModal.addEventListener('click', (e) => {
        if (e.target === voiceCallInputModal) {
            voiceCallInputModal.style.opacity = '0';
            setTimeout(() => voiceCallInputModal.style.display = 'none', 300);
        }
    });

    // â€œèµ´çº¦â€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    appointmentButton.addEventListener('click', () => {
        // a. å…ˆå…³é—­åŠŸèƒ½é¢æ¿
        toggleFeaturesPanel();

        // b. æ¿€æ´»çº¦ä¼šåŠŸèƒ½æ€»å®¹å™¨
        phoneFrame.classList.add('show-dating');

        // c. æ˜¾ç¤ºç¬¬ä¸€ä¸ªåŠ è½½åŠ¨ç”»
        firstLoader.classList.add('visible');

        // d. è®¾å®šä¸€ä¸ª2ç§’çš„å»¶æ—¶ï¼Œæ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
        setTimeout(() => {
            // e. 2ç§’åï¼Œéšè—åŠ è½½åŠ¨ç”»
            firstLoader.classList.remove('visible');

            // f. åŒæ—¶ï¼Œæ˜¾ç¤ºå¼•å¯¼è®¾ç½®ç•Œé¢
            datingSetupScreen.classList.add('visible');

        }, 2000); // 2000æ¯«ç§’ = 2ç§’
    });



    // 2. ä¸ºè¡¨æƒ…æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    chatEmojiButton.addEventListener('click', () => {
        // â–¼â–¼â–¼ æ–°å¢ï¼šå¦‚æœæ›´å¤šåŠŸèƒ½é¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œå…ˆå…³é—­å®ƒ â–¼â–¼â–¼
        if (chatScreenForPanel.classList.contains('features-panel-active')) {
            chatScreenForPanel.classList.remove('features-panel-active');
        }
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
        
        // 3. åˆ‡æ¢çˆ¶å®¹å™¨çš„æ¿€æ´»ç±»åï¼ŒCSSä¼šè‡ªåŠ¨å¤„ç†å‰©ä¸‹çš„åŠ¨ç”»
        chatScreenForPanel.classList.toggle('emoji-panel-active');

        // 4. (ä¼˜åŒ–ä½“éªŒ) æ¯æ¬¡æ‰“å¼€æˆ–å…³é—­é¢æ¿åï¼Œéƒ½å°è¯•å°†æ¶ˆæ¯åˆ—è¡¨æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(() => {
            chatMessagesForPanel.scrollTop = chatMessagesForPanel.scrollHeight;
        }, 300); // å»¶è¿Ÿæ—¶é—´ä¸CSSåŠ¨ç”»æ—¶é—´ä¸€è‡´
    });


    let playbackState = {
        playlist: [],       // å½“å‰æ’­æ”¾çš„æ•´ä¸ªæ­Œå•
        currentIndex: -1,   // å½“å‰æ­Œæ›²åœ¨æ­Œå•ä¸­çš„ç´¢å¼•
        currentSong: null,  // å½“å‰æ­Œæ›²çš„å¯¹è±¡
        isPlaying: false
    };
    // === 2. æ—¶é’ŸåŠŸèƒ½ ===
    function updateClock() {
        const now = new Date();
        // ä½¿ç”¨padStartç¡®ä¿æ•°å­—æ€»æ˜¯ä¸¤ä½æ•° (ä¾‹å¦‚ 01, 02)
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        clockHoursElem.textContent = hours;
        clockMinutesElem.textContent = minutes;
    }

    // === 3. æ•°æ®å­˜å‚¨åŠŸèƒ½ (ä½¿ç”¨ localStorage) ===

    // åŠŸèƒ½A: åŠ è½½å·²ä¿å­˜çš„æ•°æ® (é¡µé¢æ‰“å¼€æ—¶æ‰§è¡Œ)

    async function loadData() {
        // 1. åŠ è½½è¯­å½•
        const mottoData = await dbHelper.loadData('settingsStore', 'savedMotto');
        if (mottoData) {
            mottoElem.textContent = mottoData.value;
        }

        // 3. åŠ è½½APIè®¾ç½®
        const apiSettingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
        if (apiSettingsData) {
            const settings = apiSettingsData.value;
            apiUrlInput.value = settings.url || '';
            apiKeyInput.value = settings.key || '';
            if (settings.model) {
                modelSelect.innerHTML = `<option value="${settings.model}">${settings.model}</option>`;
                modelSelect.value = settings.model;
                modelSelect.disabled = false;
            }
            tempSlider.value = settings.temperature || 1.0;
            updateSliderProgress();
        }

        // 4. åŠ è½½å£çº¸
        const wallpaperData = await dbHelper.loadData('settingsStore', 'homeWallpaper');
        const savedWallpaper = wallpaperData ? wallpaperData.value : defaultBodyBg;
        homeScreen.style.backgroundImage = savedWallpaper;
        wallpaperPreview.style.backgroundImage = savedWallpaper;

        // 6. åŠ è½½å…¨å±è®¾ç½®
        const fullscreenData = await dbHelper.loadData('settingsStore', 'isFullscreenEnabled');
        const isFullscreenEnabled = fullscreenData ? fullscreenData.value : false;
        fullscreenToggle.checked = isFullscreenEnabled;
        applyFullscreenMode(isFullscreenEnabled);

        // 7. åŠ è½½æ·±è‰²æ¨¡å¼
        const darkModeData = await dbHelper.loadData('settingsStore', 'darkModeEnabled');
        const isDarkModeEnabled = darkModeData ? darkModeData.value : false;
        darkModeToggle.checked = isDarkModeEnabled;
        applyDarkMode(isDarkModeEnabled);

        // =======================================================
        // 8. [æ–°å¢] åŠ è½½è‡ªå®šä¹‰æ‰‹æœºå£³
        // =======================================================
        // ä» localStorage è¯»å–ä¹‹å‰ä¿å­˜çš„å›¾ç‰‡æ•°æ®
        const savedSkin = localStorage.getItem('userDeviceSkin');
        // å¦‚æœæœ‰æ•°æ®ï¼Œå¹¶ä¸” applySkin å‡½æ•°å­˜åœ¨ï¼Œå°±åº”ç”¨å®ƒ
        if (savedSkin && typeof applySkin === 'function') {
            applySkin(savedSkin);
        }
    }







    // === 5. åˆå§‹åŒ–é¡µé¢ ===
    async function initializeApp() {
        // â–¼â–¼â–¼ START: åœ¨è¿™é‡Œç²˜è´´æ–°çš„ä»£ç  â–¼â–¼â–¼
        // è¯·æ±‚é€šçŸ¥æƒé™
        if ('Notification' in window && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }
        // â–²â–²â–² ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

        try {
            // step 1: å…³é”®ä¾èµ– - æ•°æ®åº“å¿…é¡»æœ€å…ˆå®Œæˆåˆå§‹åŒ–ï¼Œåç»­æ‰€æœ‰åŠ è½½éƒ½ä¾èµ–å®ƒ
            await dbHelper.init();

            // step 2: å¹¶è¡ŒåŠ è½½ - å¯åŠ¨æ‰€æœ‰ç‹¬ç«‹çš„æ•°æ®è·å–ä»»åŠ¡
            // æˆ‘ä»¬æŠŠæ‰€æœ‰åŸæœ¬ await çš„å‡½æ•°æ”¾å…¥ä¸€ä¸ªæ•°ç»„ï¼Œè®©å®ƒä»¬åŒæ—¶å¼€å§‹å·¥ä½œ
            const tasks = [
                loadData(),
                loadGlobalCss(),
                loadCustomIcons(),
                loadClockColor(),
                loadClockBlurSetting(),
                loadPlaylists(),
                loadContacts(),         // è”ç³»äººé€šå¸¸è¾ƒå¤šï¼Œå¹¶è¡ŒåŠ è½½æ”¶ç›Šå¾ˆå¤§
                loadAndRenderEmojis(),
                loadCartFromDB(),
                loadOrdersFromDB(),
                initializeUnlockCodes(),
                loadMottoStyle(),
                loadAppNameStyle(),
                loadProactiveSettings(),

                // æŠŠå­—ä½“åŠ è½½ä¹Ÿä¼˜åŒ–è¿›æ¥ï¼Œä½œä¸ºä¸€ä¸ªåŒ¿åå¼‚æ­¥å‡½æ•°å¹¶è¡Œæ‰§è¡Œ
                (async () => {
                    const fontData = await dbHelper.loadData('settingsStore', 'customFont');
                    if (fontData && fontData.value) {
                        applyCustomFont(fontData.value);
                    }
                })()
            ];

            // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
            // åŸæœ¬è€—æ—¶ = A+B+C+...
            // ç°åœ¨è€—æ—¶ = max(A, B, C...)
            await Promise.all(tasks);

            // step 3: UI æ¸²æŸ“ä¸æ”¶å°¾
            // ä½™é¢æ˜¾ç¤ºå»ºè®®åœ¨æ•°æ®å…¨éƒ¨åŠ è½½å®Œåæ›´æ–°ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®
            await updateBalanceDisplay();

            // æ—¶é’ŸåŠŸèƒ½
            updateClock();
            setInterval(updateClock, 30000);

            console.log("App initialization completed efficiently.");

        } catch (error) {
            console.error("åº”ç”¨åˆå§‹åŒ–å¤±è´¥:", error);
            // ç›´æ¥æŠŠé”™è¯¯å †æ ˆæ‰“å°åˆ°å±å¹•ä¸Šï¼Œè®©ç”¨æˆ·æˆªå›¾
            alert(`ã€è°ƒè¯•æ¨¡å¼ã€‘\nè¯·æˆªå›¾å‘ç»™ä½œè€…ï¼š\n\né”™è¯¯ä¿¡æ¯: ${error.message}\n\né”™è¯¯ä½ç½®: ${error.stack ? error.stack.split('\n')[1] : 'æœªçŸ¥'}`);
        }
    }


    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ï¼Œæ›¿æ¢æ‰ä½ åŸæ¥çš„ emojiGridContainer.addEventListener('click', ...)
    if (emojiGridContainer) emojiGridContainer.addEventListener('click', (event) => {

        // åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºâ€œå¤šé€‰åˆ é™¤æ¨¡å¼â€
        if (isEmojiDeleteMode) {
            const container = event.target.closest('.emoji-item-container');
            if (container) {
                const checkbox = container.querySelector('.emoji-checkbox');
                if (checkbox) {
                    // å¦‚æœç”¨æˆ·ç‚¹å‡»çš„ä¸æ˜¯å¤é€‰æ¡†æœ¬èº«ï¼Œæˆ‘ä»¬æ‰éœ€è¦æ‰‹åŠ¨å¸®ä»–å‹¾é€‰
                    // è¿™æ ·å¯ä»¥é¿å…ç”¨æˆ·ç›´æ¥ç‚¹å¤é€‰æ¡†æ—¶ï¼Œæˆ‘ä»¬çš„ä»£ç å’Œä»–æ“ä½œå†²çª
                    if (event.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }

                    // === æ ¸å¿ƒä¿®å¤åœ¨è¿™é‡Œ ===
                    // æ ¹æ®å¤é€‰æ¡†çš„æœ€æ–°çŠ¶æ€ï¼Œæ¥å†³å®šæ˜¯å¦ç»™å®¹å™¨æ·»åŠ  'selected' ç±»
                    container.classList.toggle('selected', checkbox.checked);
                }
            }
            return; // ç»“æŸå‡½æ•°ï¼Œä¸æ‰§è¡Œå‘é€é€»è¾‘
        }

        // å¦‚æœä¸æ˜¯åˆ é™¤æ¨¡å¼ï¼Œæ‰§è¡Œæ­£å¸¸çš„â€œå‘é€â€é€»è¾‘
        if (event.target.tagName === 'IMG' && event.target.classList.contains('emoji-item')) {
            const imgElement = event.target;
            const remarkElement = imgElement.nextElementSibling;

            const remark = remarkElement ? remarkElement.textContent.trim() : "è¡¨æƒ…";
            const url = imgElement.dataset.url;

            if (url) {
                const stickerMessage = {
                    type: 'sticker',
                    text: `[è¡¨æƒ…åŒ…ï¼š${remark}]`,
                    url: url
                };

                sendMessage(stickerMessage);

                chatScreenForPanel.classList.remove('emoji-panel-active');
            }
        }
    });
    // è¿è¡Œåˆå§‹åŒ–å‡½æ•°
    initializeApp();


    // a. é¡µé¢å¯¼èˆªäº‹ä»¶
    if (mottoSettingsBtn) mottoSettingsBtn.addEventListener('click', () => phoneFrame.classList.add('show-motto-settings'));
    if (mottoSettingsBackButton) mottoSettingsBackButton.addEventListener('click', () => phoneFrame.classList.remove('show-motto-settings'));
    if (appNameSettingsBtn) appNameSettingsBtn.addEventListener('click', () => phoneFrame.classList.add('show-appname-settings'));
    if (appNameSettingsBackButton) appNameSettingsBackButton.addEventListener('click', () => phoneFrame.classList.remove('show-appname-settings'));

    // b. ç­¾åç¾åŒ–æ§ä»¶äº‹ä»¶
    if (mottoColorInput) mottoColorInput.addEventListener('input', () => {
        const newColor = mottoColorInput.value;
        if (mottoColorPicker) mottoColorPicker.value = newColor;
        applyMottoColor(newColor);
        saveMottoStyle();
    });
    if (mottoColorPicker) mottoColorPicker.addEventListener('input', () => {
        const newColor = mottoColorPicker.value;
        if (mottoColorInput) mottoColorInput.value = newColor;
        applyMottoColor(newColor);
        saveMottoStyle();
    });
    if (mottoBlurToggle) mottoBlurToggle.addEventListener('change', () => {
        applyMottoBlur(mottoBlurToggle.checked);
        saveMottoStyle();
    });

    // d. ç­¾åè¯­å½•æ–‡æœ¬å†…å®¹ä¿å­˜äº‹ä»¶ (å½“ç”¨æˆ·ç¼–è¾‘å®Œæˆå¤±ç„¦æ—¶ä¿å­˜)
    if (mottoElem) {
        mottoElem.addEventListener('blur', async () => {
            const mottoText = mottoElem.textContent.trim();
            if (mottoText) {
                await dbHelper.saveData('settingsStore', 'savedMotto', mottoText);
            }
        });
    }

    // c. å›¾æ ‡åç§°ç¾åŒ–æ§ä»¶äº‹ä»¶
    if (appNameColorInput) appNameColorInput.addEventListener('input', () => {
        const newColor = appNameColorInput.value;
        if (appNameColorPicker) appNameColorPicker.value = newColor;
        applyAppNameColor(newColor);
        saveAppNameStyle();
    });
    if (appNameColorPicker) appNameColorPicker.addEventListener('input', () => {
        const newColor = appNameColorPicker.value;
        if (appNameColorInput) appNameColorInput.value = newColor;
        applyAppNameColor(newColor);
        saveAppNameStyle();
    });
    if (appNameBlurToggle) appNameBlurToggle.addEventListener('change', () => {
        applyAppNameBlur(appNameBlurToggle.checked);
        saveAppNameStyle();
    });

    // â–¼â–¼â–¼ ç²˜è´´è¿™äº›æ–°çš„äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
    // â–¼â–¼â–¼ START: åœ¨è¿™é‡Œç²˜è´´æ–°çš„ä»£ç  â–¼â–¼â–¼
    // å°†è¿™æ®µä»£ç å’Œä½ å…¶ä»–çš„ addEventListener æ”¾åœ¨ä¸€èµ·
    const proactiveToggle = document.getElementById('toggle-proactive-messaging');
    if (proactiveToggle) {
        proactiveToggle.addEventListener('change', async () => {
            const isEnabled = proactiveToggle.checked;
            await dbHelper.saveData('settingsStore', 'proactiveMessagingEnabled', isEnabled);
            alert(`AI ä¸»åŠ¨æ¶ˆæ¯åŠŸèƒ½å·²${isEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
        });
    }
    
    // ç‚¹å‡»â€œæ–‡å›¾â€åŠŸèƒ½æŒ‰é’®ï¼Œæ‰“å¼€å¼¹çª—
    textImageFeatureButton.addEventListener('click', () => {
        openTextImageModal();
        toggleFeaturesPanel(); // å…³é—­â€œæ›´å¤šåŠŸèƒ½â€é¢æ¿
    });

    // ç‚¹å‡»å¼¹çª—çš„å…³é—­æŒ‰é’®
    textImageModalCloseBtn.addEventListener('click', closeTextImageModal);

    // ç‚¹å‡»â€œç”Ÿæˆå¹¶å‘é€â€æŒ‰é’®
    sendTextImageBtn.addEventListener('click', () => {
        const description = textImageInput.value.trim();
        if (!description) {
            alert('æ–‡å­—æè¿°ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }

        // åˆ›å»ºä¸€ä¸ªç‰¹æ®Šç±»å‹çš„æ¶ˆæ¯å¯¹è±¡
        const textImageMessage = {
            type: 'text-image',
            text: description // å°†æè¿°ä½œä¸º text å­—æ®µ
        };

        // è°ƒç”¨æˆ‘ä»¬å·²æœ‰çš„ sendMessage å‡½æ•°æ¥å¤„ç†å‘é€å’Œä¿å­˜
        sendMessage(textImageMessage);

        closeTextImageModal(); // å‘é€åå…³é—­å¼¹çª—
    });



    // === START: SHOPMALL SCRIPT (EVENT LISTENERS) ===

    // Click the SHOP App Icon: Add the class to the parent to trigger the animation
    shopAppIcon.addEventListener('click', () => {
        phoneFrame.classList.add('show-shop');
    });

    // Click the SHOP screen's "Back" button: Remove the class to go back
    shopBackButton.addEventListener('click', () => {
        // âœ… æ‰¹é‡æ¸…ç†è´­ç‰©ç›¸å…³
        window.DOMCleanupManager.cleanMultiple([
            'product-grid',
            'cart-items-container',
            'orders-list-container',
            'recipient-list-container'
        ]);
        
        // æ¸…ç†å…¨å±€å˜é‡
        if (typeof currentShopper !== 'undefined') {
            currentShopper = null;
        }
        if (typeof shoppingCart !== 'undefined') {
            shoppingCart = [];
        }
        if (typeof currentRecipient !== 'undefined') {
            currentRecipient = null;
        }
        phoneFrame.classList.remove('show-shop');
    });
    // === END: SHOPMALL SCRIPT (EVENT LISTENERS) ===

    // ç‚¹å‡»â€œè®¾ç½®â€Appå›¾æ ‡ï¼šç»™çˆ¶å®¹å™¨æ·»åŠ ç±»åæ¥è§¦å‘åŠ¨ç”»
    settingsAppIcon.addEventListener('click', () => {
        phoneFrame.classList.add('show-settings');
    });
    // === æ–°å¢ï¼šæ—¶é’Ÿè®¾ç½®ç•Œé¢çš„å¯¼èˆªäº‹ä»¶ ===

    // ç‚¹å‡»â€œæ›´æ¢æ—¶é’Ÿâ€æŒ‰é’®ï¼šä»ç¾åŒ–é¡µè¿›å…¥æ—¶é’Ÿè®¾ç½®é¡µ
    changeClockButton.addEventListener('click', () => {
        phoneFrame.classList.add('show-clock-settings');
    });

    // ç‚¹å‡»æ—¶é’Ÿè®¾ç½®é¡µçš„â€œè¿”å›â€æŒ‰é’®ï¼šè¿”å›åˆ°ç¾åŒ–é¡µ
    clockSettingsBackButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-clock-settings');
    });
    // === æ–°å¢ï¼šæ›´æ¢å›¾æ ‡ç•Œé¢çš„å¯¼èˆªäº‹ä»¶ ===

    // ç‚¹å‡»â€œæ›´æ¢å›¾æ ‡â€æŒ‰é’®ï¼šä»ç¾åŒ–é¡µè¿›å…¥å›¾æ ‡è®¾ç½®é¡µ
    changeIconButton.addEventListener('click', () => {
        phoneFrame.classList.add('show-icon-settings');
        renderIconSettings();
    });

    // ç‚¹å‡»å›¾æ ‡è®¾ç½®é¡µçš„â€œè¿”å›â€æŒ‰é’®ï¼šè¿”å›åˆ°ç¾åŒ–é¡µ
    iconSettingsBackButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-icon-settings');
    });

    // === æ–°å¢ï¼šç¾åŒ–Appçš„å¯¼èˆªäº‹ä»¶ ===

    // ç‚¹å‡»â€œç¾åŒ–â€Appå›¾æ ‡ï¼šç»™çˆ¶å®¹å™¨æ·»åŠ ç±»åæ¥è§¦å‘åŠ¨ç”»
    beautifyAppIcon.addEventListener('click', () => {
        phoneFrame.classList.add('show-beautify');
    });

    // ç‚¹å‡»ç¾åŒ–Appçš„â€œè¿”å›â€æŒ‰é’®ï¼šä»çˆ¶å®¹å™¨ç§»é™¤ç±»åæ¥è§¦å‘è¿”å›åŠ¨ç”»
    beautifyBackButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-beautify');
    });

    // ç‚¹å‡»â€œè¿”å›â€æŒ‰é’®ï¼šä»çˆ¶å®¹å™¨ç§»é™¤ç±»åæ¥è§¦å‘è¿”å›åŠ¨ç”»
    backButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-settings');
    });

    // 2. ä¸ºè¾“å…¥æ¡†æ·»åŠ  'keydown' (é”®ç›˜æŒ‰ä¸‹) äº‹ä»¶ç›‘å¬å™¨
    // (ç¡®ä¿ chatInputForEnterKey æŒ‡å‘çš„æ˜¯æ‚¨çš„è¾“å…¥æ¡†å…ƒç´ ï¼Œä¾‹å¦‚ document.getElementById('chat-message-input'))
    chatInputForEnterKey.addEventListener('keydown', (event) => {

        // 3. æ£€æŸ¥æŒ‰ä¸‹çš„é”®æ˜¯å¦æ˜¯ "Enter" é”®
        if (event.key === 'Enter') {

            event.preventDefault();

            // 5. ã€æ ¸å¿ƒä¿®å¤ã€‘è¿™é‡Œä¸å†å»ç‚¹æŒ‰é’®äº†ï¼Œè€Œæ˜¯ç›´æ¥è·å–å†…å®¹å¹¶å‘é€
            const messageText = chatInputForEnterKey.value.trim();

            if (messageText) {
                // playEnterSound();
                // ç›´æ¥è°ƒç”¨ä¹‹å‰å®šä¹‰å¥½çš„å‘é€å‡½æ•°
                sendMessage(messageText);

                // å‘é€åæ¸…ç©ºè¾“å…¥æ¡† (å¦‚æœ sendMessage å‡½æ•°é‡Œæ²¡æœ‰æ¸…ç©ºæ“ä½œï¼Œè¯·ä¿ç•™è¿™ä¸€è¡Œ)
                chatInputForEnterKey.value = '';
            }

            // 6. ä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹ï¼Œæ–¹ä¾¿ç»§ç»­æ‰“å­—
            chatInputForEnterKey.focus();
        }
    });

    // åœ¨å…¶ä»– addEventListener çš„åŒºåŸŸï¼Œæ·»åŠ è¿™ä¸€æ®µ
    moveBooksInGroupBtn.addEventListener('click', () => {
        // è¿™ä¸ªå‡½æ•°æˆ‘ä»¬å°†ä¼šåœ¨ä¸‹ä¸€æ­¥åˆ›å»ºï¼Œå®ƒä¸“é—¨è´Ÿè´£æ‰“å¼€ç§»åŠ¨çª—å£
        handleMoveBooksFromGroup();
    });
    connectButton.addEventListener('click', async () => {
        const apiUrl = apiUrlInput.value.trim();
        const apiKey = apiKeyInput.value.trim();

        if (!apiUrl || !apiKey) {
            apiStatusSpan.textContent = "URLå’ŒKeyä¸èƒ½ä¸ºç©º";
            return;
        }

        connectButton.textContent = "è¿æ¥ä¸­...";
        connectButton.disabled = true;
        apiStatusSpan.textContent = "";

        try {
            // --- START: CORRECTED LOGIC ---
            let endpointUrl = apiUrl;

            // 1. Remove any trailing slash from the user's input
            if (endpointUrl.endsWith('/')) {
                endpointUrl = endpointUrl.slice(0, -1);
            }

            // 2. Consistently append /models to the cleaned URL
            endpointUrl += '/models';
            // --- END: CORRECTED LOGIC ---

            const response = await fetch(endpointUrl, {
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });


            if (!response.ok) {
                // If the response status is not 2xx, we throw a specific error
                throw new Error(`HTTP Error: ${response.status}`);
            }

            // If the request is successful...
            const data = await response.json();
            modelSelect.innerHTML = '<option value="" disabled selected>é€‰æ‹©ä¸€ä¸ªæ¨¡å‹</option>';
            data.data.forEach(model => {
                modelSelect.innerHTML += `<option value="${model.id}">${model.id}</option>`;
            });
            modelSelect.disabled = false;
            apiStatusSpan.textContent = "âœ“ è¿æ¥æˆåŠŸ";
            apiStatusSpan.style.color = "green";

        } catch (error) {
            console.error("API è¿æ¥å¤±è´¥:", error); // Keep detailed error for developers

            // Show different user-friendly tips based on the error type
            if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                apiStatusSpan.textContent = "âœ— ç½‘ç»œé”™è¯¯æˆ–è·¨åŸŸé—®é¢˜";
                apiStatusSpan.style.color = "red";
                alert("è¿æ¥å¤±è´¥ï¼æœ€å¸¸è§çš„åŸå› æ˜¯ï¼š\n\n1. APIæœåŠ¡å™¨æœªå¼€å¯CORSè·¨åŸŸè®¸å¯ã€‚\n2. æµè§ˆå™¨æ’ä»¶æ‹¦æˆªäº†è¯·æ±‚ (å¦‚å¹¿å‘Šæ‹¦æˆªå™¨)ã€‚\n3. æ‚¨çš„ç½‘ç»œæ— æ³•è®¿é—®è¯¥URLåœ°å€ã€‚");
            } else if (error.message.startsWith('HTTP Error:')) {
                const status = error.message.split(':')[1].trim();
                let tip = `(çŠ¶æ€ç : ${status})`;
                if (status === '401') {
                    tip = "âœ— è®¤è¯å¤±è´¥ (401)ï¼Œè¯·æ£€æŸ¥æ‚¨çš„API Keyæ˜¯å¦æ­£ç¡®ã€‚";
                } else if (status === '404') {
                    tip = "âœ— æœªæ‰¾åˆ° (404)ï¼Œè¯·æ£€æŸ¥æ‚¨çš„URLåœ°å€æ˜¯å¦æ­£ç¡®ã€‚";
                } else if (status >= 500) {
                    tip = `âœ— æœåŠ¡å™¨é”™è¯¯ (${status})ï¼ŒAPIæœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨ã€‚`;
                } else {
                    tip = `âœ— è¯·æ±‚å¤±è´¥ ${tip}ï¼Œè¯·æ£€æŸ¥APIæ–‡æ¡£ã€‚`;
                }
                apiStatusSpan.textContent = tip;
                apiStatusSpan.style.color = "red";
            } else {
                apiStatusSpan.textContent = "âœ— æœªçŸ¥é”™è¯¯";
                apiStatusSpan.style.color = "red";
            }

            modelSelect.innerHTML = '<option value="" disabled selected>è¿æ¥å¤±è´¥</option>';

        } finally {
            connectButton.textContent = "è¿æ¥æµ‹è¯•";
            connectButton.disabled = false;
        }
    });

    // === æ–°å¢ï¼šæ¸©åº¦æ»‘å—çš„äº‹ä»¶ç›‘å¬ ===
    function updateSliderProgress() {
        const value = parseFloat(tempSlider.value);
        const percentage = (value / 2) * 100; // å› ä¸ºæœ€å¤§å€¼æ˜¯2
        tempSlider.style.setProperty('--progress-percent', `${percentage}%`);
        tempValueSpan.textContent = value.toFixed(1);
    }
    tempSlider.addEventListener('input', updateSliderProgress);

    /**
     * 1. ä¿å­˜å½“å‰ API é…ç½®åˆ° API åº“
     */
    saveApiToLibraryBtn.addEventListener('click', async () => {
        const name = prompt("è¯·è¾“å…¥æ­¤ API é…ç½®çš„åç§° (ä¾‹å¦‚: GPT-4o ä¸“å±é…ç½®)");
        if (!name || name.trim() === "") {
            alert("åç§°ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }

        const newConfig = {
            id: Date.now(),
            name: name.trim(),
            url: apiUrlInput.value.trim(),
            key: apiKeyInput.value.trim(),
            model: modelSelect.value,
            temperature: parseFloat(tempSlider.value) || 1.0,
            lastUsed: new Date().toISOString()
        };

        try {
            const libraryData = await dbHelper.loadData('settingsStore', 'apiLibrary');
            let library = (libraryData && Array.isArray(libraryData.value)) ? libraryData.value : [];

            library.unshift(newConfig); // å°†æ–°é…ç½®æ·»åŠ åˆ°æœ€å‰é¢

            await dbHelper.saveData('settingsStore', 'apiLibrary', library);

            alert(`é…ç½® "${newConfig.name}" å·²æˆåŠŸä¿å­˜åˆ°åº“ï¼`);
        } catch (error) {
            console.error("ä¿å­˜ API é…ç½®å¤±è´¥:", error);
            alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“ã€‚");
        }
    });

    /**
     * 2. æ‰“å¼€å’Œå…³é—­ API åº“å¯¹è¯æ¡†
     */
    selectApiLibraryBtn.addEventListener('click', () => {
        openApiLibraryModal();
    });

    apiLibraryModalCloseBtn.addEventListener('click', () => {
        closeApiLibraryModal();
    });

    apiLibraryModal.addEventListener('click', (event) => {
        if (event.target === apiLibraryModal) {
            closeApiLibraryModal();
        }
    });

    function openApiLibraryModal() {
        renderApiLibraryList(); // æ¯æ¬¡æ‰“å¼€éƒ½åˆ·æ–°åˆ—è¡¨
        apiLibraryModal.style.display = 'flex';
        setTimeout(() => {
            apiLibraryModal.style.opacity = '1';
            apiLibraryModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    function closeApiLibraryModal() {
        apiLibraryModal.style.opacity = '0';
        apiLibraryModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            apiLibraryModal.style.display = 'none';
            // ç¡®ä¿é€€å‡ºåˆ é™¤æ¨¡å¼
            isApiLibraryDeleteMode = false;
            apiLibraryDeleteSelectedBtn.textContent = "åˆ é™¤æ‰€é€‰";
            apiLibraryDeleteSelectedBtn.classList.remove('danger-button');
            apiLibraryDeleteSelectedBtn.classList.add('form-button-secondary');
        }, 300);
    }


    /**
     * 3. æ¸²æŸ“ API åº“åˆ—è¡¨
     */
    async function renderApiLibraryList() {
        apiLibraryListContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 15px;">æ­£åœ¨åŠ è½½ API åº“...</p>';
        isApiLibraryDeleteMode = false;

        try {
            const libraryData = await dbHelper.loadData('settingsStore', 'apiLibrary');
            const library = (libraryData && Array.isArray(libraryData.value)) ? libraryData.value : [];

            if (library.length === 0) {
                apiLibraryListContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 15px;">API åº“ä¸­æš‚æ— é…ç½®</p>';
                return;
            }

            apiLibraryListContainer.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º

            library.forEach(config => {
                const item = document.createElement('div');
                item.className = 'api-library-item';
                item.dataset.configId = config.id;
                // å°†æ•´ä¸ªé…ç½®å¯¹è±¡å­˜å‚¨åœ¨ dataset ä¸­ï¼Œæ–¹ä¾¿é€‰ä¸­åè¯»å–
                item.dataset.config = JSON.stringify(config);

                const lastUsed = new Date(config.lastUsed).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

                item.innerHTML = `
                <div class="api-info">
                    <div class="api-name">${config.name}</div>
                    <div class="api-details">${config.url} | ${config.model} | æ¸©åº¦: ${config.temperature} | æœ€åä½¿ç”¨: ${lastUsed}</div>
                </div>
                <input type="checkbox" class="api-select-checkbox" style="display: none;">
            `;
                apiLibraryListContainer.appendChild(item);
            });
        } catch (error) {
            console.error("æ¸²æŸ“ API åº“å¤±è´¥:", error);
            apiLibraryListContainer.innerHTML = '<p style="text-align:center; color:red; padding: 15px;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p>';
        }
    }

    /**
     * 4. åˆ—è¡¨é¡¹ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
     */
    apiLibraryListContainer.addEventListener('click', async (event) => {
        const item = event.target.closest('.api-library-item');
        if (!item) return;

        const checkbox = item.querySelector('.api-select-checkbox');

        if (isApiLibraryDeleteMode) {
            // --- åˆ é™¤æ¨¡å¼ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€ ---
            if (event.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
            }
            item.classList.toggle('selected', checkbox.checked);

        } else {
            // --- åº”ç”¨æ¨¡å¼ï¼šåº”ç”¨é…ç½®å¹¶å…³é—­ ---
            const config = JSON.parse(item.dataset.config);

            // 1. åº”ç”¨åˆ°è®¾ç½®ç•Œé¢çš„è¾“å…¥æ¡†
            apiUrlInput.value = config.url;
            apiKeyInput.value = config.key;

            // 2. æ›´æ–°æ¨¡å‹ä¸‹æ‹‰æ¡† (å¯èƒ½éœ€è¦é‡æ–°æ‹‰å–æ¨¡å‹åˆ—è¡¨ï¼Œè¿™é‡Œç®€åŒ–ä¸ºç›´æ¥è®¾ç½®)
            if (!modelSelect.querySelector(`option[value="${config.model}"]`)) {
                modelSelect.innerHTML += `<option value="${config.model}">${config.model}</option>`;
            }
            modelSelect.value = config.model;
            modelSelect.disabled = false;

            // 3. åº”ç”¨æ¸©åº¦
            tempSlider.value = config.temperature;
            updateSliderProgress(); // è°ƒç”¨å‡½æ•°æ›´æ–°æ»‘å—UI

            // 4. æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´å¹¶ä¿å­˜å›æ•°æ®åº“ (ä¼˜åŒ–ä½“éªŒ)
            config.lastUsed = new Date().toISOString();
            const libraryData = await dbHelper.loadData('settingsStore', 'apiLibrary');
            let library = libraryData.value;
            const index = library.findIndex(c => c.id === config.id);
            if (index !== -1) {
                library[index] = config;
                await dbHelper.saveData('settingsStore', 'apiLibrary', library);
            }

            // 5. ç«‹å³å…³é—­å¯¹è¯æ¡†
            closeApiLibraryModal();
            alert(`API é…ç½® "${config.name}" å·²æˆåŠŸåº”ç”¨ï¼`);
        }
    });


    /**
     * 5. åˆ é™¤æ¨¡å¼é€»è¾‘
     */
    apiLibraryDeleteSelectedBtn.addEventListener('click', async () => {
        if (!isApiLibraryDeleteMode) {
            // --- è¿›å…¥åˆ é™¤æ¨¡å¼ ---
            isApiLibraryDeleteMode = true;
            apiLibraryDeleteSelectedBtn.textContent = "åˆ é™¤æ‰€é€‰";
            // æ”¹å˜æŒ‰é’®æ ·å¼ä¸ºå±é™©æŒ‰é’®
            apiLibraryDeleteSelectedBtn.classList.remove('form-button-secondary');
            apiLibraryDeleteSelectedBtn.classList.add('danger-button');

            // æ˜¾ç¤ºæ‰€æœ‰å¤é€‰æ¡†
            apiLibraryListContainer.querySelectorAll('.api-select-checkbox').forEach(cb => {
                cb.style.display = 'block';
                cb.checked = false; // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            });

        } else {
            // --- æ‰§è¡Œæ‰¹é‡åˆ é™¤ ---
            const selectedItems = apiLibraryListContainer.querySelectorAll('.api-select-checkbox:checked');
            if (selectedItems.length === 0) {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­é¡¹ï¼Œåˆ™é€€å‡ºåˆ é™¤æ¨¡å¼
                isApiLibraryDeleteMode = false;
                apiLibraryDeleteSelectedBtn.textContent = "åˆ é™¤æ‰€é€‰";
                apiLibraryDeleteSelectedBtn.classList.remove('danger-button');
                apiLibraryDeleteSelectedBtn.classList.add('form-button-secondary');

                apiLibraryListContainer.querySelectorAll('.api-select-checkbox').forEach(cb => {
                    cb.style.display = 'none';
                });
                return;
            }

            if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedItems.length} ä¸ª API é…ç½®å—ï¼Ÿ`)) {
                return;
            }

            const idsToDelete = new Set();
            selectedItems.forEach(cb => {
                const item = cb.closest('.api-library-item');
                idsToDelete.add(parseInt(item.dataset.configId, 10));
            });

            try {
                const libraryData = await dbHelper.loadData('settingsStore', 'apiLibrary');
                let library = libraryData.value;

                // è¿‡æ»¤æ‰éœ€è¦åˆ é™¤çš„é…ç½®
                const updatedLibrary = library.filter(config => !idsToDelete.has(config.id));

                await dbHelper.saveData('settingsStore', 'apiLibrary', updatedLibrary);

                // é‡æ–°æ¸²æŸ“åˆ—è¡¨å¹¶é€€å‡ºåˆ é™¤æ¨¡å¼
                await renderApiLibraryList();
                alert("åˆ é™¤æˆåŠŸï¼");

                isApiLibraryDeleteMode = false;
                apiLibraryDeleteSelectedBtn.textContent = "åˆ é™¤æ‰€é€‰";
                apiLibraryDeleteSelectedBtn.classList.remove('danger-button');
                apiLibraryDeleteSelectedBtn.classList.add('form-button-secondary');

                apiLibraryListContainer.querySelectorAll('.api-select-checkbox').forEach(cb => {
                    cb.style.display = 'none';
                });

            } catch (error) {
                console.error("åˆ é™¤å¤±è´¥:", error);
                alert("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
            }
        }
    });
    // === æ–°å¢ï¼šå£çº¸æ›´æ¢çš„äº‹ä»¶ç›‘å¬ ===

    // ç‚¹å‡»â€œé€‰æ‹©å›¾ç‰‡â€æŒ‰é’®ï¼Œå®é™…æ˜¯è§¦å‘éšè—çš„ input
    uploadWallpaperBtn.addEventListener('click', () => {
        wallpaperUploadInput.click();
    });

    // å½“ç”¨æˆ·é€‰æ‹©äº†å›¾ç‰‡æ–‡ä»¶å
    wallpaperUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (e) => { // æ”¹ä¸º async
                const imageDataUrl = `url(${e.target.result})`;
                homeScreen.style.backgroundImage = imageDataUrl;
                wallpaperPreview.style.backgroundImage = imageDataUrl;

                // åŸä»£ç : localStorage.setItem('homeWallpaper', imageDataUrl);
                await dbHelper.saveData('settingsStore', 'homeWallpaper', imageDataUrl);
            };
            reader.readAsDataURL(file);
        }
    });

    // ç‚¹å‡»â€œæ¢å¤é»˜è®¤â€æŒ‰é’®
    resetWallpaperBtn.addEventListener('click', async () => {
        // 1. æ¢å¤ä¸»å±å¹•å’Œé¢„è§ˆåŒºçš„å£çº¸ä¸ºé»˜è®¤å›¾ç‰‡
        homeScreen.style.backgroundImage = defaultBodyBg; // ä½¿ç”¨é»˜è®¤å›¾ç‰‡å˜é‡
        wallpaperPreview.style.backgroundImage = defaultBodyBg;

        // (å¯é€‰) æ¸…é™¤èƒŒæ™¯è‰²ï¼Œé¿å…å¹²æ‰°
        homeScreen.style.backgroundColor = 'transparent';
        wallpaperPreview.style.backgroundColor = 'transparent';

        // 2. ä»æœ¬åœ°å­˜å‚¨ä¸­ç§»é™¤è‡ªå®šä¹‰å£çº¸è®°å½•
        await dbHelper.deleteData('settingsStore', 'homeWallpaper');

        alert("å·²æ¢å¤é»˜è®¤å£çº¸ï¼");
    });


    // === æ–°å¢ï¼šä¸–ç•Œä¹¦ App çš„å¯¼èˆªäº‹ä»¶ ===
    worldbookAppIcon.addEventListener('click', () => {
        phoneFrame.classList.add('show-worldbook');
        loadAndRenderUngroupedWorldBooks();
    });

    worldbookBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean('worldbook-list');
        phoneFrame.classList.remove('show-worldbook');
    });

    // === æ–°å¢ï¼šæ¶ˆæ¯ App çš„å¯¼èˆªäº‹ä»¶ ===

    // ç‚¹å‡»â€œæ¶ˆæ¯â€Appå›¾æ ‡ï¼šç»™çˆ¶å®¹å™¨æ·»åŠ ç±»åæ¥è§¦å‘åŠ¨ç”»
    messagesAppIcon.addEventListener('click', () => {
        phoneFrame.classList.add('show-messages');
        
        // ã€ä¿®å¤ã€‘æ‰“å¼€æ¶ˆæ¯Appæ—¶ï¼ŒåŒæ­¥UIçŠ¶æ€ä¸æ•°æ®çŠ¶æ€
        // ç¡®ä¿segmentæŒ‰é’®çš„activeçŠ¶æ€å’Œæ»‘å—ä½ç½®ä¸currentMessageTypeä¸€è‡´
        if (segmentControl && segmentBtns.length > 0) {
            segmentBtns.forEach(btn => {
                if (btn.dataset.type === currentMessageType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            // åŒæ­¥æ»‘å—ä½ç½®
            if (currentMessageType === 'group') {
                segmentControl.classList.add('group-mode');
            } else {
                segmentControl.classList.remove('group-mode');
            }
        }
        
        // ã€ä¼˜åŒ–ã€‘åªåœ¨åˆ—è¡¨ä¸ºç©ºæ—¶æ‰æ¸²æŸ“ï¼Œé¿å…é‡å¤æ¸²æŸ“
        if (contactList.children.length === 0) {
            console.log('[DEBUG] Messages app opened, list is empty, rendering...');
            if (typeof renderMessagesList === 'function') {
                renderMessagesList();
            }
        } else {
            console.log('[DEBUG] Messages app opened, list already populated, skipping render');
        }
    });

    // ç‚¹å‡»æ¶ˆæ¯Appçš„â€œè¿”å›â€æŒ‰é’®ï¼šä»çˆ¶å®¹å™¨ç§»é™¤ç±»åæ¥è§¦å‘è¿”å›åŠ¨ç”»
    messagesBackButton.addEventListener('click', () => {
         window.DOMCleanupManager.clean("contact-list"); // âœ… æ·»åŠ è¿™è¡Œ
         Global_AllContactsCache = null; // ğŸ”¥ åŒæ—¶æ¸…ç†å…¨å±€ç¼“å­˜
          window.TimerManager.clear("proactive"); // âœ… æ¸…ç†æ‰€æœ‰ä¸»åŠ¨æ¶ˆæ¯è®¡æ—¶å™¨
        phoneFrame.classList.remove('show-messages');
    });
    // === æ–°å¢ï¼šéŸ³ä¹Appçš„å¯¼èˆªäº‹ä»¶ ===

    // ç‚¹å‡»â€œéŸ³ä¹â€Appå›¾æ ‡ï¼šç»™çˆ¶å®¹å™¨æ·»åŠ ç±»åæ¥è§¦å‘åŠ¨ç”»
    musicAppIcon.addEventListener('click', () => {
        phoneFrame.classList.add('show-music');
    });

    // ç‚¹å‡»éŸ³ä¹Appçš„â€œè¿”å›â€æŒ‰é’®ï¼šä»çˆ¶å®¹å™¨ç§»é™¤ç±»åæ¥è§¦å‘è¿”å›åŠ¨ç”»
    musicBackButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-music');
    });
    // === éŸ³ä¹ App æ­Œå•åŠŸèƒ½ ===

    // 1. è·å–éœ€è¦çš„ HTML å…ƒç´ 


    // 3. å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆ›å»ºæ­Œå•å¡ç‰‡çš„ HTML ç»“æ„
    // === è¿™æ˜¯ createPlaylistCard å‡½æ•°çš„å”¯ä¸€æ­£ç¡®ç‰ˆæœ¬ ===
    // å®ƒåˆ›å»ºå¡ç‰‡ã€å¼‚æ­¥æ›´æ–°æ­Œæ›²æ•°é‡ï¼Œå¹¶ä¸ºå¡ç‰‡ç»‘å®šäº†æ­£ç¡®çš„ç‚¹å‡»äº‹ä»¶

    // === æ›´æ–° createPlaylistCard (å¢åŠ å¤é€‰æ¡†) ===
    function createPlaylistCard(name, playlistData) {
        const card = document.createElement('div');
        card.className = 'playlist-card';
        card.dataset.playlistName = name;

        // --- æ–°å¢ï¼šåœ¨å¡ç‰‡å†…éƒ¨æ·»åŠ å¤é€‰æ¡† ---
        card.innerHTML = `
        <input type="checkbox" class="playlist-checkbox">
        <div class="playlist-cover"></div>
        <div class="playlist-name"></div>
        <div class="playlist-count"></div>
    `;

        // è·å–åˆšåˆšåˆ›å»ºçš„å…ƒç´ å¹¶å¡«å……å†…å®¹
        const coverDiv = card.querySelector('.playlist-cover');
        if (playlistData && playlistData.coverUrl) {
            coverDiv.style.backgroundImage = `url(${playlistData.coverUrl})`;
        }

        card.querySelector('.playlist-name').textContent = name;

        const songCount = (playlistData && Array.isArray(playlistData.songs)) ? playlistData.songs.length : 0;
        card.querySelector('.playlist-count').textContent = `${songCount} é¦–æ­Œæ›²`;

        playlistGrid.appendChild(card);

        card.addEventListener('click', (event) => {
            // å¦‚æœæ˜¯åˆ é™¤æ¨¡å¼ï¼Œå¹¶ä¸”ç‚¹å‡»çš„ä¸æ˜¯å¤é€‰æ¡†ï¼Œåˆ™æ¨¡æ‹Ÿç‚¹å‡»å¤é€‰æ¡†
            if (isPlaylistDeleteMode && event.target.type !== 'checkbox') {
                const checkbox = card.querySelector('.playlist-checkbox');
                checkbox.checked = !checkbox.checked;
            } else if (!isPlaylistDeleteMode) {
                // æ­£å¸¸æ¨¡å¼ä¸‹æ‰è¿›å…¥è¯¦æƒ…é¡µ
                openPlaylistDetailView(name);
            }
        });
    }
    /// === ä¿®æ”¹ï¼šä»æ•°æ®åº“åŠ è½½å¹¶æ˜¾ç¤ºæ­Œå•ï¼ˆé€‚é…æ–°æ•°æ®ç»“æ„ï¼‰ ===
    async function loadPlaylists() {
        const playlistData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
        if (playlistData && typeof playlistData.value === 'object') {
            const playlists = playlistData.value;
            playlistGrid.innerHTML = '';
            Object.keys(playlists).forEach(name => {
                // å°†æ•´ä¸ªæ­Œå•å¯¹è±¡ä¼ å…¥ï¼Œè€Œä¸ä»…ä»…æ˜¯åå­—
                createPlaylistCard(name, playlists[name]);
            });
        }
    }
    // === æ–°å¢ï¼šæ­Œå•è¯¦æƒ…é¡µçš„å…¨éƒ¨äº¤äº’é€»è¾‘ ===

    // 1. è·å–æ–°é¡µé¢çš„æ‰€æœ‰å…ƒç´ 


    let isDeleteMode = false; // ç”¨äºè·Ÿè¸ªæ˜¯å¦å¤„äºåˆ é™¤æ¨¡å¼

    let currentOpenPlaylist = null; // å­˜å‚¨å½“å‰æ‰“å¼€çš„æ­Œå•çš„åç§°


    // 3. æ‰“å¼€æ­Œå•è¯¦æƒ…é¡µçš„å‡½æ•°
    // === ä¿®æ”¹ï¼šæ‰“å¼€æ­Œå•è¯¦æƒ…é¡µçš„å‡½æ•°ï¼ˆå¢åŠ å¥å£®æ€§æ£€æŸ¥ï¼‰ ===
    // === æ›¿æ¢ä¸ºä¿®å¤ç‰ˆï¼šæ­£ç¡®æ˜¾ç¤ºæ­Œæ›²åˆ—è¡¨ ===
    async function openPlaylistDetailView(playlistName) {
        currentOpenPlaylist = playlistName;
        playlistNameTitle.textContent = playlistName;
        songList.innerHTML = '';

        const allPlaylistsData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');

        // --- å…³é”®ä¿®å¤åœ¨è¿™é‡Œ ---
        // æ£€æŸ¥æ–°æ•°æ®ç»“æ„ä¸­çš„ .songs å±æ€§æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°ç»„
        if (allPlaylistsData && allPlaylistsData.value && allPlaylistsData.value[playlistName] && Array.isArray(allPlaylistsData.value[playlistName].songs)) {
            // ä» .songs å±æ€§ä¸­è·å–æ­Œæ›²åˆ—è¡¨
            const songs = allPlaylistsData.value[playlistName].songs;
            songs.forEach(song => {
                appendSongToList(song);
            });
        } else {
            // è¿™æ®µä»£ç ç°åœ¨åªä¼šåœ¨æ•°æ®ç¡®å®ä¸ºç©ºæˆ–æŸåæ—¶è§¦å‘
            console.warn(`æ­Œå• "${playlistName}" çš„æ­Œæ›²æ•°æ®ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°ç»„ï¼Œæˆ–è€…ä¸ºç©ºã€‚`);
        }

        // æ˜¾ç¤ºè¯¦æƒ…é¡µ
        phoneFrame.classList.add('show-playlist-detail');
    }

    // 4. å…³é—­æ­Œå•è¯¦æƒ…é¡µ
    playlistBackButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-playlist-detail');
        currentOpenPlaylist = null; // æ¸…ç†å½“å‰æ­Œå•è®°å½•
    });

    // 5. "å¯¼å…¥æ­Œæ›²" æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    // === ä¿®å¤ï¼šå¯¼å…¥/åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»åˆ†æµé€»è¾‘ ===
    importMusicButton.addEventListener('click', () => {
        if (isDeleteMode) {
            // å¦‚æœå½“å‰æ˜¯åˆ é™¤æ¨¡å¼ -> æ‰§è¡Œæ‰¹é‡åˆ é™¤
            handleBatchDeleteSongs();
        } else {
            // å¦‚æœå½“å‰æ˜¯æ­£å¸¸æ¨¡å¼ -> æ‰“å¼€æ–‡ä»¶é€‰æ‹©æ¡†å¯¼å…¥æ­Œæ›²
            musicFileInput.click();
        }
    });

    // 6. æ–‡ä»¶é€‰æ‹©æ¡†æ£€æµ‹åˆ°å˜åŒ–çš„äº‹ä»¶
    // === æ›¿æ¢ä¸ºä¿®å¤ç‰ˆï¼šå‘æ•°æ®åº“å­˜å‚¨æ–‡ä»¶å¯¹è±¡æœ¬èº« ===
    musicFileInput.addEventListener('change', async (event) => {
        const files = event.target.files;
        if (!files.length || !currentOpenPlaylist) return;

        try {
            const allPlaylistsData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
            let allPlaylists = allPlaylistsData.value;

            for (const file of files) {
                let title = file.name.replace(/\.(mp3|wav|flac)$/i, '');
                let artist = 'æœªçŸ¥è‰ºæœ¯å®¶';
                if (/\s*-\s*/.test(title)) {
                    [title, artist] = title.split(/\s*-\s*/).map(s => s.trim());
                }

                // --- å…³é”®ä¿®æ”¹åœ¨è¿™é‡Œ ---
                // æˆ‘ä»¬ä¸å†åˆ›å»ºå’Œå­˜å‚¨ä¸´æ—¶çš„ blob URL
                // è€Œæ˜¯ç›´æ¥å­˜å‚¨ file å¯¹è±¡
                const song = {
                    title: title,
                    artist: artist,
                    file: file // <--- ä¿®æ”¹ç‚¹
                };

                allPlaylists[currentOpenPlaylist].songs.push(song);
                appendSongToList(song);
            }

            // æ›´æ–°æ­Œæ›²æ•°é‡
            const cardToUpdate = playlistGrid.querySelector(`.playlist-card[data-playlist-name="${currentOpenPlaylist}"]`);
            if (cardToUpdate) {
                const countElement = cardToUpdate.querySelector('.playlist-count');
                countElement.textContent = `${allPlaylists[currentOpenPlaylist].songs.length} é¦–æ­Œæ›²`;
            }

            await dbHelper.saveData('musicPlaylists', 'allPlaylists', allPlaylists);

        } catch (error) {
            console.error("å¯¼å…¥æ­Œæ›²å¤±è´¥:", error);
        } finally {
            event.target.value = '';
        }
    });

    // 7. ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºå°†æ­Œæ›²å¯¹è±¡æ·»åŠ åˆ° HTML åˆ—è¡¨ä¸­
    function appendSongToList(song) {
        const li = document.createElement('li');
        li.className = 'song-item';
        const songId = song.file ? `${song.file.name}-${song.file.lastModified}` : song.url;
        li.dataset.songId = songId;
        li.innerHTML = `
        <input type="checkbox" class="song-checkbox">
        <div class="song-info">
            <div class="song-title">${song.title || 'æœªçŸ¥æ­Œæ›²'}</div>
            <div class="song-artist">${song.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'}</div>
        </div>
        <button class="play-button">
            <svg viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="48" stroke="#ccc" stroke-width="4" fill="none"/>
                <polygon points="35,25 75,50 35,75" fill="#555"/>
            </svg>
        </button>
    `;
        songList.appendChild(li);

        const playButton = li.querySelector('.play-button');

        if (song.file) {
            // --- å…³é”®ä¿®å¤ï¼šå°†äº‹ä»¶å¤„ç†å‡½æ•°æ ‡è®°ä¸º async ---
            playButton.addEventListener('click', async (e) => {
                e.stopPropagation();

                try {
                    // --- å…³é”®ä¿®å¤ï¼šåœ¨ç‚¹å‡»æ—¶ï¼Œä¸»åŠ¨ä»æ•°æ®åº“åŠ è½½æ•°æ® ---
                    const allPlaylistsData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
                    if (!allPlaylistsData || !allPlaylistsData.value) {
                        throw new Error("æ— æ³•åŠ è½½æ’­æ”¾åˆ—è¡¨æ•°æ®ã€‚");
                    }
                    const allPlaylists = allPlaylistsData.value;

                    // ç°åœ¨å¯ä»¥å®‰å…¨åœ°è·å–æ­Œæ›²åˆ—è¡¨å’Œç´¢å¼•äº†
                    const currentPlaylistSongs = allPlaylists[currentOpenPlaylist].songs;
                    const songIndex = currentPlaylistSongs.findIndex(s =>
                        s.file && s.file.name === song.file.name && s.file.lastModified === song.file.lastModified
                    );

                    if (songIndex > -1) {
                        startPlayback(currentPlaylistSongs, songIndex);
                    } else {
                        throw new Error("åœ¨æ’­æ”¾åˆ—è¡¨ä¸­æ‰¾ä¸åˆ°å½“å‰æ­Œæ›²ã€‚");
                    }

                } catch (error) {
                    console.error("æ’­æ”¾æ—¶å‡ºé”™:", error);
                    alert("æ’­æ”¾æ­Œæ›²æ—¶å‡ºé”™ã€‚");
                }
            });
        } else {
            playButton.disabled = true;
            playButton.style.opacity = 0.3;
            playButton.style.cursor = 'not-allowed';
        }
    }
    // === æ–°å¢ï¼šä¸Šä¼ å°é¢å’Œæ‰¹é‡åˆ é™¤çš„äº‹ä»¶é€»è¾‘ ===

    // --- ä¸Šä¼ å°é¢é€»è¾‘ ---
    uploadCoverBtn.addEventListener('click', () => {
        if (isDeleteMode) {
            // å¦‚æœåœ¨åˆ é™¤æ¨¡å¼ä¸‹ï¼Œè¿™ä¸ªæŒ‰é’®ä¼šå˜æˆâ€œåˆ é™¤æ‰€é€‰â€
            handleBatchDelete();
        } else {
            // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œè§¦å‘æ–‡ä»¶é€‰æ‹©
            coverUploadInput.click();
        }
    });

    // === æ›¿æ¢ä¸ºæœ€ç»ˆä¿®å¤ç‰ˆï¼šèƒ½å¤Ÿå¤„ç†æ—§æ•°æ®å¹¶æˆåŠŸä¿å­˜å°é¢ ===
    coverUploadInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file || !currentOpenPlaylist) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const newCoverUrl = e.target.result;
            try {
                const allPlaylistsData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
                // ç¡®ä¿æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯¹è±¡å¯ä»¥æ“ä½œï¼Œå³ä½¿æ•°æ®åº“æ˜¯ç©ºçš„
                let allPlaylists = (allPlaylistsData && allPlaylistsData.value) ? allPlaylistsData.value : {};

                // --- å…³é”®ä¿®å¤åœ¨è¿™é‡Œ ---
                // æ£€æŸ¥å½“å‰æ­Œå•æ˜¯å¦å­˜åœ¨ï¼Œæˆ–è€…æ˜¯å¦ä¸ºæ—§æ ¼å¼ï¼ˆå³ä¸€ä¸ªæ•°ç»„è€Œä¸æ˜¯å¯¹è±¡ï¼‰
                if (!allPlaylists[currentOpenPlaylist] || Array.isArray(allPlaylists[currentOpenPlaylist])) {
                    // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼Œæˆ‘ä»¬åœ¨è¿™é‡ŒæŠŠå®ƒâ€œå‡çº§â€ä¸ºæ–°æ ¼å¼
                    console.log(`æ­£åœ¨å‡çº§æ—§æ ¼å¼æ­Œå•: "${currentOpenPlaylist}"`);
                    const oldSongs = Array.isArray(allPlaylists[currentOpenPlaylist]) ? allPlaylists[currentOpenPlaylist] : [];
                    allPlaylists[currentOpenPlaylist] = { songs: oldSongs, coverUrl: null };
                }

                // ç°åœ¨å¯ä»¥å®‰å…¨åœ°æ›´æ–°å°é¢URLäº†
                allPlaylists[currentOpenPlaylist].coverUrl = newCoverUrl;
                await dbHelper.saveData('musicPlaylists', 'allPlaylists', allPlaylists);

                // å®æ—¶æ›´æ–°ä¸»ç•Œé¢çš„å°é¢
                const cardToUpdate = playlistGrid.querySelector(`.playlist-card[data-playlist-name="${currentOpenPlaylist}"]`);
                if (cardToUpdate) {
                    const coverDiv = cardToUpdate.querySelector('.playlist-cover');
                    coverDiv.style.backgroundImage = `url(${newCoverUrl})`;
                }
                alert('å°é¢å·²æ›´æ–°ï¼');

            } catch (error) {
                console.error('æ›´æ–°å°é¢å¤±è´¥:', error);
                alert('æ›´æ–°å°é¢å¤±è´¥ã€‚');
            }
        };
        reader.readAsDataURL(file);
        event.target.value = '';
    });

    // --- æ‰¹é‡åˆ é™¤é€»è¾‘ ---
    // === ä¿®å¤ï¼šæ­Œæ›²è¯¦æƒ…å¤šé€‰åˆ‡æ¢é€»è¾‘ (æŒ‰é’®å˜èº«) ===
    multiSelectBtn.addEventListener('click', () => {
        isDeleteMode = !isDeleteMode; // æ›´æ–°å…¨å±€çŠ¶æ€ (æˆ–è€…ç”¨ isSongDeleteMode é¿å…å†²çª)
        songList.classList.toggle('delete-mode', isDeleteMode);

        // è·å–ä¸»æ“ä½œæŒ‰é’® (å¯¼å…¥æŒ‰é’®)
        const actionBtn = document.getElementById('import-music-button');

        if (isDeleteMode) {
            // --- è¿›å…¥åˆ é™¤æ¨¡å¼ ---
            multiSelectBtn.style.color = '#007AFF';

            // ã€å…³é”®ã€‘ä¸»æŒ‰é’®å˜èº«
            actionBtn.textContent = 'åˆ é™¤æ‰€é€‰æ­Œæ›²';
            actionBtn.style.backgroundColor = 'rgba(255, 59, 48, 0.15)';
            actionBtn.style.color = '#FF3B30';
            actionBtn.style.borderColor = 'rgba(255, 59, 48, 0.3)';

        } else {
            // --- é€€å‡ºåˆ é™¤æ¨¡å¼ ---
            multiSelectBtn.style.color = '';

            // æ¢å¤ä¸»æŒ‰é’®
            actionBtn.textContent = 'å¯¼å…¥æ­Œæ›²';
            actionBtn.style.backgroundColor = '';
            actionBtn.style.color = '';
            actionBtn.style.borderColor = '';

            // å–æ¶ˆæ‰€æœ‰å‹¾é€‰
            songList.querySelectorAll('.song-checkbox').forEach(cb => cb.checked = false);
        }
    });
    async function handleBatchDelete() {
        const selectedCheckboxes = songList.querySelectorAll('.song-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¦–æ­Œæ›²ã€‚');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} é¦–æ­Œæ›²å—ï¼Ÿ`)) {
            return;
        }

        const idsToDelete = new Set();
        selectedCheckboxes.forEach(cb => {
            const li = cb.closest('.song-item');
            idsToDelete.add(li.dataset.songId);
        });

        try {
            const allPlaylistsData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
            if (!allPlaylistsData || !allPlaylistsData.value || !allPlaylistsData.value[currentOpenPlaylist]) {
                alert('æ— æ³•åŠ è½½æ­Œå•æ•°æ®ï¼Œåˆ é™¤å¤±è´¥ï¼');
                return;
            }
            let allPlaylists = allPlaylistsData.value;
            if (!Array.isArray(allPlaylists[currentOpenPlaylist].songs)) {
                alert('æ­Œå•æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•åˆ é™¤æ­Œæ›²ï¼');
                return;
            }

            // --- å…³é”®ä¿®å¤åœ¨è¿™é‡Œ ---
            // åœ¨è¿‡æ»¤æ—¶ï¼Œå¯¹æ–°æ—§ä¸¤ç§æ•°æ®åˆ†åˆ«ç”ŸæˆIDè¿›è¡ŒåŒ¹é…
            const originalSongs = allPlaylists[currentOpenPlaylist].songs;
            allPlaylists[currentOpenPlaylist].songs = originalSongs.filter(song => {
                let songId;
                if (song.file) {
                    // å¦‚æœæ˜¯æ–°æ•°æ®ï¼Œç”¨æ–‡ä»¶åå’Œä¿®æ”¹æ—¥æœŸç”ŸæˆID
                    songId = `${song.file.name}-${song.file.lastModified}`;
                } else if (song.url) {
                    // å¦‚æœæ˜¯æ—§æ•°æ®ï¼Œç”¨å®ƒè‡ªå·±çš„URLä½œä¸ºID
                    songId = song.url;
                } else {
                    // å¦‚æœæ˜¯æ— æ•ˆæ•°æ®ï¼Œé»˜è®¤ä¸åˆ é™¤ï¼ˆä¿ç•™ï¼‰
                    return true;
                }
                // å¦‚æœç”Ÿæˆçš„IDåœ¨æˆ‘ä»¬å¾…åˆ é™¤çš„é›†åˆä¸­ï¼Œåˆ™è¿™é¦–æ­Œè¢«è¿‡æ»¤æ‰ï¼ˆä¸è¿”å›ï¼‰
                return !idsToDelete.has(songId);
            });

            await dbHelper.saveData('musicPlaylists', 'allPlaylists', allPlaylists);

            // åˆ·æ–°UI
            await openPlaylistDetailView(currentOpenPlaylist);
            multiSelectBtn.click();
            const cardToUpdate = playlistGrid.querySelector(`.playlist-card[data-playlist-name="${currentOpenPlaylist}"]`);
            if (cardToUpdate) {
                const countElement = cardToUpdate.querySelector('.playlist-count');
                countElement.textContent = `${allPlaylists[currentOpenPlaylist].songs.length} é¦–æ­Œæ›²`;
            }

        } catch (error) {
            console.error('åˆ é™¤æ­Œæ›²å¤±è´¥:', error);
        }
    }

    // === æ–°å¢ï¼šçµåŠ¨å²›å’Œæ’­æ”¾æ§åˆ¶çš„å…¨éƒ¨å‡½æ•° ===
    /**
     * æ›´æ–°çµåŠ¨å²›æŠ˜å çŠ¶æ€ä¸‹çš„æ­Œæ›²æ ‡é¢˜ã€‚
     * å¦‚æœæ ‡é¢˜é•¿åº¦è¶…è¿‡å…¶å®¹å™¨å®½åº¦ï¼Œåˆ™æ¿€æ´»æ»šåŠ¨åŠ¨ç”»ã€‚
     * @param {string} title - è¦æ˜¾ç¤ºçš„æ­Œæ›²æ ‡é¢˜ã€‚
     */
    function updateScrollingTitle(title) {
        const titleElement = document.getElementById('collapsed-song-title');
        // è·å–çˆ¶çº§å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„â€œçª—å£â€
        const windowElement = titleElement.parentElement;

        // 1. é‡ç½®çŠ¶æ€ï¼šç§»é™¤å¯èƒ½å­˜åœ¨çš„æ»šåŠ¨ç±»ï¼Œä»¥é˜²ä¸Šä¸€é¦–æ­Œæ­£åœ¨æ»šåŠ¨
        titleElement.classList.remove('scrolling');

        // 2. ç”¨æ–°æ ‡é¢˜æ›´æ–°æ–‡æœ¬å†…å®¹
        titleElement.textContent = "æ­£åœ¨æ’­æ”¾ï¼š" + title;

        // 3. æ£€æŸ¥æ–‡æœ¬æ˜¯å¦æº¢å‡ºï¼ˆå³æ–‡æœ¬çš„å®é™…å®½åº¦ > å…¶å®¹å™¨çš„å¯è§å®½åº¦ï¼‰
        // æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªçŸ­æš‚çš„å»¶æ—¶ï¼Œä»¥ç¡®ä¿æµè§ˆå™¨æœ‰æ—¶é—´åœ¨æ£€æŸ¥å‰å®Œæˆæ–°æ–‡æœ¬çš„æ¸²æŸ“å’Œå°ºå¯¸è®¡ç®—
        setTimeout(() => {
            // scrollWidth æ˜¯å…ƒç´ å†…å®¹çš„æ€»å®½åº¦ï¼ŒclientWidth æ˜¯å…ƒç´ çš„å¯è§å®½åº¦
            const isOverflowing = titleElement.scrollWidth > windowElement.clientWidth;

            if (isOverflowing) {
                // å¦‚æœç¡®å®æº¢å‡ºäº†ï¼Œå°±æ·»åŠ  'scrolling' ç±»æ¥å¯åŠ¨åŠ¨ç”»
                titleElement.classList.add('scrolling');
            }
        }, 100); // 100æ¯«ç§’çš„å»¶è¿Ÿè¶³å¤Ÿäº†
    }
    // ç»Ÿä¸€çš„æ’­æ”¾å…¥å£å‡½æ•°
    // --- æ›¿æ¢æ—§çš„ startPlayback å‡½æ•° ---
    async function startPlayback(playlist, index) {
        if (!playlist || index < 0 || index >= playlist.length) return;

        playbackState.playlist = playlist;
        playbackState.currentIndex = index;
        playbackState.currentSong = playlist[index];

        // ... æ›´æ–°çµåŠ¨å²›UIçš„ä»£ç  ...
        islandSongTitle.textContent = playbackState.currentSong.title;
        islandSongArtist.textContent = playbackState.currentSong.artist;
        updateScrollingTitle(playbackState.currentSong.title);

        const songObjectUrl = URL.createObjectURL(playbackState.currentSong.file);
        audioPlayer.src = songObjectUrl;
        audioPlayer.play().catch(error => console.error("æ’­æ”¾å¤±è´¥:", error));

        // æ ¸å¿ƒä¿®æ”¹ï¼šå½“å¤„äºâ€œä¸€èµ·å¬â€æ¨¡å¼æ—¶ï¼Œè°ƒç”¨æ–°çš„å‡½æ•°æ¥æ˜¾ç¤ºå¹¶ä¿å­˜â€œæ­£åœ¨æ’­æ”¾â€æç¤º
        if (sharedListeningState.active && sharedListeningState.contact) {
            const message = `æ­£åœ¨æ’­æ”¾: ${playbackState.currentSong.title} - ${playbackState.currentSong.artist}`;
            await showSystemNotification(message, sharedListeningState.contact.id);
        }
    }

    // --- çµåŠ¨å²› UI æ§åˆ¶ ---
    function showDynamicIsland() {
        dynamicIsland.classList.add('active');
        playbackState.isPlaying = true;
        islandPlayPauseBtn.classList.remove('play');
        islandPlayPauseBtn.classList.add('pause');
    }

    function hideDynamicIsland() {
        dynamicIsland.classList.remove('active', 'expanded');
        playbackState.isPlaying = false;
        islandPlayPauseBtn.classList.remove('pause');
        islandPlayPauseBtn.classList.add('play');
    }

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${min}:${sec}`;
    }

    // --- äº‹ä»¶ç›‘å¬ ---

    // *** åœ¨è¿™é‡Œæ–°å¢ä¸‹é¢çš„ä»£ç  ***

    // === æ–°å¢ï¼šç‚¹å‡»ä¸–ç•Œä¹¦åˆ—è¡¨é¡¹ä»¥è¿›è¡Œç¼–è¾‘ ===
    worldbookListContainer.addEventListener('click', async (event) => {
        // å¦‚æœå½“å‰æ˜¯åˆ é™¤æ¨¡å¼ï¼Œæˆ–è€…ç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†ï¼Œåˆ™ä¸æ‰§è¡Œç¼–è¾‘æ“ä½œ
        if (isWorldbookDeleteMode || event.target.type === 'checkbox') {
            return;
        }

        const bookItem = event.target.closest('.contact-item');
        if (bookItem) {
            const bookId = parseInt(bookItem.dataset.bookId, 10);
            openWorldbookModal(bookId); // è°ƒç”¨å¼¹çª—å‡½æ•°ï¼Œå¹¶ä¼ å…¥ä¹¦ç±ID
        }
    });

    // *** æ–°å¢ä»£ç ç»“æŸ ***

    // ç›‘å¬éŸ³é¢‘æ’­æ”¾å™¨äº‹ä»¶æ¥æ§åˆ¶çµåŠ¨å²›
    audioPlayer.addEventListener('play', showDynamicIsland);
    audioPlayer.addEventListener('pause', hideDynamicIsland);
    // è¿™æ˜¯ä¿®æ”¹åçš„æ–°ä»£ç 
    audioPlayer.addEventListener('ended', () => {
        // æ­Œæ›²æ’­æ”¾ç»“æŸåï¼Œå°†æ’­æ”¾æ—¶é—´é‡ç½®ä¸º0
        audioPlayer.currentTime = 0;
        // ç«‹å³é‡æ–°å¼€å§‹æ’­æ”¾å½“å‰æ­Œæ›²ï¼Œå®ç°å•æ›²å¾ªç¯
        audioPlayer.play();
    });

    audioPlayer.addEventListener('timeupdate', () => {
        const { currentTime, duration } = audioPlayer;
        if (isNaN(duration)) return;

        // æ›´æ–°è¿›åº¦æ¡
        const progressPercent = (currentTime / duration) * 100;
        progressBarFill.style.width = `${progressPercent}%`;

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        progressCurrentTime.textContent = formatTime(currentTime);
        progressRemainingTime.textContent = `-${formatTime(duration - currentTime)}`;
    });

    audioPlayer.addEventListener('ended', () => {
        islandNextBtn.click(); // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
    });

    // çµåŠ¨å²›è‡ªèº«çš„ç‚¹å‡»äº‹ä»¶
    // === ç”¨ä¸‹é¢è¿™ä¸ªä¿®å¤åçš„ç‰ˆæœ¬ï¼Œæ›¿æ¢æ‰æ‚¨ç°æœ‰çš„ä»£ç  ===

    // çµåŠ¨å²›è‡ªèº«çš„ç‚¹å‡»äº‹ä»¶
    // === æœ€ç»ˆä¿®å¤ç‰ˆï¼šçµåŠ¨å²›ç‚¹å‡»äº‹ä»¶ (è§£å†³å¤´åƒæ¶ˆå¤±å’Œæ­Œåä¸æ»šåŠ¨é—®é¢˜) ===

    // === è¿™æ˜¯ä¿®æ­£äº†æ»šåŠ¨é€»è¾‘çš„æœ€ç»ˆç‰ˆæœ¬ ===
    dynamicIsland.addEventListener('click', (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯åŠŸèƒ½æŒ‰é’®ï¼Œåˆ™ä¸è§¦å‘å±•å¼€/æ”¶èµ·
        if (e.target.closest('.control-button')
            || e.target.closest('.island-action-button')
            || e.target.closest('.shared-avatars')) {
            return;
        }

        const isCurrentlyExpanded = dynamicIsland.classList.contains('expanded');

        // åˆ‡æ¢å±•å¼€/æ”¶èµ·çŠ¶æ€
        dynamicIsland.classList.toggle('expanded');

        // æ ¹æ®åˆ‡æ¢åçš„çŠ¶æ€æ¥æ‰§è¡Œæ“ä½œ
        if (isCurrentlyExpanded) {
            // å¦‚æœæ˜¯ä»â€œå±•å¼€â€å˜ä¸ºâ€œæ”¶èµ·â€
            // å…³é”®ä¿®å¤ï¼šåœ¨UIåˆ‡æ¢åŠ¨ç”»å¼€å§‹åï¼Œå†æ£€æŸ¥æ»šåŠ¨ã€‚
            // 200æ¯«ç§’çš„å»¶è¿Ÿè¶³ä»¥è®©å®¹å™¨å°ºå¯¸è®¡ç®—æ­£ç¡®ï¼Œä¸”æ¯”æ€»åŠ¨ç”»æ—¶é—´çŸ­ã€‚
            setTimeout(() => {
                if (playbackState.currentSong) {
                    updateScrollingTitle(playbackState.currentSong.title);
                }
            }, 200);

        } else {
            // å¦‚æœæ˜¯ä»â€œæ”¶èµ·â€å˜ä¸ºâ€œå±•å¼€â€
            updateSharedListeningUI();
        }
    });
    // çµåŠ¨å²›å†…éƒ¨æ§åˆ¶æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    islandPlayPauseBtn.addEventListener('click', () => {
        if (audioPlayer.paused) {
            audioPlayer.play();
        } else {
            audioPlayer.pause();
        }
    });

    // === â€œä¸‹ä¸€é¦–â€æŒ‰é’®çš„æœ€ç»ˆç‰ˆ (ä¸ä¸Šä¸€å›ç­”ä¸­çš„ä»£ç ä¸€è‡´) ===
    // === çµåŠ¨å²›â€œä¸‹ä¸€é¦–â€æŒ‰é’® (V2 - å¥å£®ç‰ˆ) ===
    islandNextBtn.addEventListener('click', async () => {
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ å®‰å…¨æ£€æŸ¥ â–¼â–¼â–¼
        if (!playbackState.playlist || playbackState.playlist.length === 0) {
            console.warn("æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•åˆ‡æ­Œã€‚");
            return;
        }

        let nextIndex = playbackState.currentIndex + 1;
        if (nextIndex >= playbackState.playlist.length) {
            nextIndex = 0;
        }
        await startPlayback(playbackState.playlist, nextIndex);

        if (sharedListeningState.active && sharedListeningState.contact) {
            const song = playbackState.playlist[nextIndex];
            await callAI(`æˆ‘åˆšåˆšæŠŠæ­Œæ›²åˆ‡æ¢åˆ°äº†ã€Š${song.title}ã€‹ - ${song.artist}ï¼Œè¯·æ ¹æ®èŠå¤©è®°å½•å’Œæ­Œæ›²æœ¬èº«åšå‡ºå›åº”`, sharedListeningState.contact);
        }
    });

    // === çµåŠ¨å²›â€œä¸Šä¸€é¦–â€æŒ‰é’® (V2 - å¥å£®ç‰ˆ) ===
    islandPrevBtn.addEventListener('click', async () => {
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ å®‰å…¨æ£€æŸ¥ â–¼â–¼â–¼
        if (!playbackState.playlist || playbackState.playlist.length === 0) {
            console.warn("æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•åˆ‡æ­Œã€‚");
            return;
        }

        let songChanged = false;
        let targetIndex;

        if (audioPlayer.currentTime > 3) {
            targetIndex = playbackState.currentIndex;
            audioPlayer.currentTime = 0;
            audioPlayer.play(); // è®©æ­Œæ›²ä»å¤´æ’­æ”¾
        } else {
            targetIndex = playbackState.currentIndex - 1;
            if (targetIndex < 0) {
                targetIndex = playbackState.playlist.length - 1;
            }
            await startPlayback(playbackState.playlist, targetIndex);
            songChanged = true;
        }

        if (songChanged && sharedListeningState.active && sharedListeningState.contact) {
            const song = playbackState.playlist[targetIndex];
            await callAI(`æˆ‘åˆšåˆšæŠŠæ­Œæ›²åˆ‡æ¢åˆ°äº†ã€Š${song.title}ã€‹ - ${song.artist}ï¼Œè¯·æ ¹æ®èŠå¤©è®°å½•å’Œæ­Œæ›²æœ¬èº«åšå‡ºå›åº”`, sharedListeningState.contact);
        }
    });
    // === æ–°å¢ï¼šå¤„ç†è”ç³»äººå¼¹å‡ºå±‚çš„æ‰€æœ‰é€»è¾‘ ===

    // --- åŠŸèƒ½ A: æ‰“å¼€å’Œå…³é—­å¼¹å‡ºå±‚ ---
    // === openModal (V2 - å·²é›†æˆé‡ç½®åŠŸèƒ½) ===
    function openModal() {
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šåœ¨æ˜¾ç¤ºå¯¹è¯æ¡†ä¹‹å‰ï¼Œå…ˆè°ƒç”¨é‡ç½®å‡½æ•° â–¼â–¼â–¼
        resetContactModal();
        // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

        addContactModal.style.display = 'flex';
        setTimeout(() => {
            addContactModal.style.opacity = '1';
            addContactModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    // === closeModal (V2 - å·²ç®€åŒ–) ===
    function closeModal() {
        addContactModal.style.opacity = '0';
        addContactModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            addContactModal.style.display = 'none';
            // æˆ‘ä»¬ä¾ç„¶åœ¨å…³é—­æ—¶è°ƒç”¨ä¸€æ¬¡é‡ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
            resetContactModal();
        }, 300);
    }
    // â–¼â–¼â–¼ ç²˜è´´è¿™ä¸¤ä¸ªæ–°çš„å¼¹çª—æ§åˆ¶å‡½æ•° â–¼â–¼â–¼
    function openTextImageModal() {
        textImageInput.value = ''; // æ¯æ¬¡æ‰“å¼€éƒ½æ¸…ç©ºè¾“å…¥æ¡†
        textImageModal.style.display = 'flex';
        setTimeout(() => {
            textImageModal.style.opacity = '1';
            textImageModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    function closeTextImageModal() {
        textImageModal.style.opacity = '0';
        textImageModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            textImageModal.style.display = 'none';
        }, 300);
    }
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²


    /**
             * åŠŸèƒ½ï¼šæ ¹æ®ä¼ å…¥çš„å¸ƒå°”å€¼ï¼Œåˆ‡æ¢å…¨å±æ¨¡å¼
             * @param {boolean} isEnabled - trueä¸ºå¯ç”¨å…¨å±, falseä¸ºæ‰‹æœºæ¨¡å¼
             */
    function applyFullscreenMode(isEnabled) {
        if (isEnabled) {
            bodyElement.classList.add('fullscreen-mode');
        } else {
            bodyElement.classList.remove('fullscreen-mode');
        }
        // å…¨å±æ¨¡å¼åˆ‡æ¢åï¼Œé‡æ–°åº”ç”¨iOSå®‰å…¨åŒºmarginï¼ˆå¦‚æœé€‚ç”¨ï¼‰
        if (isIOS && isStandalone) {
            const currentMargin = localStorage.getItem(IOS_MARGIN_KEY);
            if (currentMargin) {
                // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿classå·²ç»åº”ç”¨
                setTimeout(() => {
                    window.applyIOSSafeAreaMargin(parseInt(currentMargin));
                }, 50);
            }
        }
    }
    fullscreenToggle.addEventListener('change', async () => {
        const isEnabled = fullscreenToggle.checked;
        applyFullscreenMode(isEnabled);
        // ä½¿ç”¨æ–°çš„é”®åä¿å­˜çŠ¶æ€
        await dbHelper.saveData('settingsStore', 'isFullscreenEnabled', isEnabled);
    });

    // â–¼â–¼â–¼ Add this new event listener for the dark mode toggle â–¼â–¼â–¼
    darkModeToggle.addEventListener('change', async () => {
        const isEnabled = darkModeToggle.checked;
        applyDarkMode(isEnabled);
        // Save the user's preference to the database
        await dbHelper.saveData('settingsStore', 'darkModeEnabled', isEnabled);
    });
    modalCloseBtn.addEventListener('click', closeModal);
    addContactModal.addEventListener('click', (event) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯é®ç½©èƒŒæ™¯æœ¬èº«ï¼Œè€Œä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼Œåˆ™å…³é—­
        if (event.target === addContactModal) {
            closeModal();
        }
    });


    // --- åŠŸèƒ½ B: å¤„ç†AI/ç”¨æˆ·è¡¨å•åˆ‡æ¢ ---
    roleSwitchCheckbox.addEventListener('change', () => {
        const isUser = roleSwitchCheckbox.checked;
        aiForm.classList.toggle('active', !isUser);
        userForm.classList.toggle('active', isUser);
        switchLabels[0].classList.toggle('active', !isUser);
        switchLabels[1].classList.toggle('active', isUser);
    });

    // --- åŠŸèƒ½ C: å¤„ç†å¤´åƒä¸Šä¼ å’Œé¢„è§ˆ ---
    function handleAvatarUpload(inputElement, previewElement) {
        const file = inputElement.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewElement.src = e.target.result; // e.target.result åŒ…å«å›¾ç‰‡çš„Base64ç¼–ç 
                // ã€ä¿®å¤ã€‘æ¸…ç©ºinputçš„valueï¼Œé˜²æ­¢é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶æ—¶ä¸è§¦å‘changeäº‹ä»¶
                // ä»¥åŠé˜²æ­¢æŸäº›æµè§ˆå™¨/è®¾å¤‡ä¸Šå‡ºç°æ–‡ä»¶é€‰æ‹©å™¨é‡å¤å¼¹å‡ºçš„é—®é¢˜
                inputElement.value = '';
            };
            reader.readAsDataURL(file);
        }
    }
    aiAvatarInput.addEventListener('change', () => handleAvatarUpload(aiAvatarInput, aiAvatarPreview));
    userAvatarInput.addEventListener('change', () => handleAvatarUpload(userAvatarInput, userAvatarPreview));


    // --- åŠŸèƒ½ D: ä¿å­˜è”ç³»äººåˆ°æ•°æ®åº“å¹¶æ›´æ–°UI ---
    saveContactBtn.addEventListener('click', async () => {
        // 1. æ•°æ®æ ¡éªŒ
        if (!aiNameInput.value.trim() || !userNameInput.value.trim()) {
            alert('AIè§’è‰²åå’Œä½ çš„åå­—ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }

        // 2. æ”¶é›†æ‰€æœ‰æ•°æ®
        const newContact = {
            id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
            ai: {
                name: aiNameInput.value.trim(),
                persona: aiPersonaInput.value.trim(),
                avatar: aiAvatarPreview.src // ç›´æ¥ä¿å­˜Base64ç¼–ç çš„å›¾ç‰‡
            },
            user: {
                name: userNameInput.value.trim(),
                persona: userPersonaInput.value.trim(),
                avatar: userAvatarPreview.src
            },
            contextMemory: parseInt(contextMemoryInput.value, 10) || 10,
            lastMessage: "ç‚¹å‡»å’Œæˆ‘èŠå¤©å§ï¼" // é»˜è®¤çš„æœ€åä¸€æ¡æ¶ˆæ¯
        };

        // 3. ä¿å­˜åˆ°æ•°æ®åº“
        try {
            const existingData = await dbHelper.loadData('messageContacts', 'allContacts');
            let contacts = (existingData && Array.isArray(existingData.value)) ? existingData.value : [];
            contacts.push(newContact);
            await dbHelper.saveData('messageContacts', 'allContacts', contacts);
            
            // ã€å…³é”®ã€‘åŒæ­¥æ›´æ–°å…¨å±€ç¼“å­˜ï¼Œé¿å…æ–°å»ºåç«‹å³ç‚¹å‡»æ‰¾ä¸åˆ°è”ç³»äºº
            Global_AllContactsCache = contacts;

            // 4. æ›´æ–°UI
            appendContactToList(newContact);


            // 5. å…³é—­å¹¶é‡ç½®å¼¹å‡ºå±‚
            closeModal();

        } catch (error) {
            console.error("ä¿å­˜è”ç³»äººå¤±è´¥:", error);
            alert("ä¿å­˜å¤±è´¥");
        }
    });


    // --- åŠŸèƒ½ E: å°†å•ä¸ªè”ç³»äººæ•°æ®æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ ---
    // --- åŠŸèƒ½ E: å°†å•ä¸ªè”ç³»äººæ•°æ®æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ (å·²æ›´æ–°ï¼Œå¸¦å¤é€‰æ¡†) ---
    // --- åŠŸèƒ½ E: å°†å•ä¸ªè”ç³»äººæ•°æ®æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ (å·²æ›´æ–°ï¼Œå¸¦å¤é€‰æ¡†) ---
    function appendContactToList(contact) {
        const li = document.createElement('li');
        li.className = 'contact-item';
        if (contact.isPinned) {
            li.classList.add('pinned');
            li.dataset.pinned = 'true';
        }
        li.dataset.contactId = contact.id;

        // --- æ¢å¤ç®€æ´ç»“æ„ ---
        li.innerHTML = `
            <input type="checkbox" class="contact-checkbox">
            <img src="${contact.ai.avatar}" alt="avatar" class="contact-avatar">
            <div class="contact-info">
                <div class="contact-name">${contact.ai.name}</div>
                <div class="contact-last-message">${contact.lastMessage}</div>
            </div>
        `;
        contactList.appendChild(li);

        // --- é•¿æŒ‰èœå•é€»è¾‘ ---
        let pressTimer;
        let isLongPress = false;
        let startX, startY;

        // è§¦æ‘¸å¼€å§‹ï¼šå¯åŠ¨é•¿æŒ‰è®¡æ—¶
        li.addEventListener('touchstart', (e) => {
            // å¦‚æœæ˜¯åˆ é™¤æ¨¡å¼ï¼Œä¸è§¦å‘èœå•
            if (isMessagesDeleteMode) return;
            
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isLongPress = false;
            
            li.classList.add('pressing'); // æ·»åŠ è§†è§‰åé¦ˆ

            pressTimer = setTimeout(() => {
                isLongPress = true;
                // è§¦å‘éœ‡åŠ¨åé¦ˆ (å¦‚æœè®¾å¤‡æ”¯æŒ)
                if (navigator.vibrate) navigator.vibrate(50);
                
                showContactActionSheet(contact);
                
                // é•¿æŒ‰è§¦å‘åï¼Œç§»é™¤æŒ‰ä¸‹æ ·å¼ï¼Œä½†ä¿æŒèœå•æ‰“å¼€
                li.classList.remove('pressing');
            }, 500); // 500ms é•¿æŒ‰é˜ˆå€¼
        }, { passive: true });

        // è§¦æ‘¸ç§»åŠ¨ï¼šå¦‚æœç§»åŠ¨è¶…è¿‡ä¸€å®šè·ç¦»ï¼Œå–æ¶ˆé•¿æŒ‰
        li.addEventListener('touchmove', (e) => {
            if (!pressTimer) return;
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            // ç§»åŠ¨è¶…è¿‡ 10px è§†ä¸ºæ»‘åŠ¨è€Œéé•¿æŒ‰
            if (Math.abs(currentX - startX) > 10 || Math.abs(currentY - startY) > 10) {
                clearTimeout(pressTimer);
                pressTimer = null;
                li.classList.remove('pressing');
            }
        }, { passive: true });

        // è§¦æ‘¸ç»“æŸï¼šæ¸…é™¤è®¡æ—¶å™¨
        li.addEventListener('touchend', (e) => {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
            li.classList.remove('pressing');

            // å¦‚æœå·²ç»è§¦å‘äº†é•¿æŒ‰ï¼Œé˜»æ­¢åç»­çš„ click äº‹ä»¶ (è™½ç„¶ passive true ä¸èƒ½é˜»æ­¢ defaultï¼Œä½†å¯ä»¥é€šè¿‡æ ‡å¿—ä½æ§åˆ¶ click)
            if (isLongPress) {
                if (e.cancelable) e.preventDefault(); 
            }
        });
        
        // ç¦ç”¨é»˜è®¤å³é”®èœå• (é’ˆå¯¹ PC ç«¯æµ‹è¯•)
        li.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (!isMessagesDeleteMode) {
                 showContactActionSheet(contact);
            }
        });

        // ç‚¹å‡»è¿›å…¥èŠå¤©
        li.addEventListener('click', (e) => {
            // å¦‚æœæ˜¯é•¿æŒ‰è§¦å‘çš„ç‚¹å‡»ï¼Œæˆ–è€…ç‚¹çš„æ˜¯å¤é€‰æ¡†ï¼Œåˆ™å¿½ç•¥
            if (isLongPress || e.target.classList.contains('contact-checkbox')) return;
            if (isMessagesDeleteMode) return; // åˆ é™¤æ¨¡å¼ä¸‹ä¸è·³è½¬

            openChat(contact);
        });
    }

    // --- å®šä¹‰ openChat å‡½æ•°ï¼Œç¡®ä¿å®ƒåœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ç”¨ ---
    // è¿™ä¸ªå‡½æ•°å°è£…äº†æ‰“å¼€èŠå¤©çš„æ‰€æœ‰é€»è¾‘
    async function openChat(contact) {
        if (!contact) return;
        currentOpenContact = contact;
        currentOpenGroup = null; // ç¡®ä¿æ˜¯å•èŠæ¨¡å¼
        
        // 1. æ›´æ–°èŠå¤©å¤´éƒ¨ä¿¡æ¯
        // å°è¯•è·å–å…ƒç´ ï¼Œè€ƒè™‘ä¸åŒçš„åå­—å¯èƒ½æ€§
        const avatarEl = document.querySelector('#chat-screen .header-avatar');
        const nameEl = document.getElementById('chat-contact-name');
        
        if (avatarEl) avatarEl.src = contact.ai.avatar;
        if (nameEl) nameEl.textContent = contact.ai.name;

        // 2. åº”ç”¨èŠå¤©èƒŒæ™¯ç­‰ä¸ªæ€§åŒ–è®¾ç½®
        if (typeof applyChatViewSettings === 'function') {
            applyChatViewSettings(contact); 
        }

        // 3. åŠ è½½èŠå¤©è®°å½•
        // å¦‚æœæœ‰ç‹¬ç«‹çš„ loadChatHistoryByContactId å‡½æ•°åˆ™è°ƒç”¨ï¼Œå¦åˆ™æ‰‹åŠ¨æ¸…ç©ºå¹¶æ¸²æŸ“
        // è¿™é‡Œå‡è®¾ addMessageToView ç­‰å‡½æ•°å­˜åœ¨
        if (chatContainer) chatContainer.innerHTML = ''; // æ¸…ç©ºæ—§æ¶ˆæ¯
        
        if (contact.history && Array.isArray(contact.history)) {
           // é€æ¡æ¸²æŸ“
           for (const msg of contact.history) {
               await addMessageToView(msg, contact);
           }
           // æ»šåŠ¨åˆ°åº•éƒ¨
           setTimeout(() => {
               chatContainer.scrollTop = chatContainer.scrollHeight;
           }, 0);
        }

        // 4. åˆ‡æ¢è§†å›¾
        const chatScreen = document.getElementById('chat-screen');
        if (chatScreen) {
             chatScreen.classList.add('active');
             // ç¡®ä¿ phoneFrame ä¹Ÿæœ‰ç›¸åº”çš„ç±»åï¼ˆå¦‚æœéœ€è¦ï¼‰
             // phoneFrame.classList.add('show-chat'); 
        }
    }

    // --- æ˜¾ç¤ºè”ç³»äººæ“ä½œèœå• (Action Sheet) ---
    function showContactActionSheet(contact) {
        const sheet = document.getElementById('contact-action-sheet');
        const pinBtn = document.getElementById('action-sheet-pin');
        const deleteBtn = document.getElementById('action-sheet-delete');
        const cancelBtn = document.getElementById('action-sheet-cancel');
        const content = sheet.querySelector('.action-sheet-content');

        // æ›´æ–°æŒ‰é’®æ–‡å­—
        pinBtn.textContent = contact.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶å¯¹è¯';
        
        // æ˜¾ç¤ºèœå•
        sheet.style.display = 'flex';
        // å¼ºåˆ¶é‡ç»˜ä»¥è§¦å‘ transition
        sheet.offsetHeight; 
        sheet.classList.add('active');
        
        // ç»‘å®šäº‹ä»¶ (ä½¿ç”¨ once:true æ¯æ¬¡é‡æ–°ç»‘å®šï¼Œæˆ–è€…å…ˆç§»é™¤æ—§çš„)
        // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½å…‹éš†æŒ‰é’®æ¥ç§»é™¤æ—§ç›‘å¬å™¨ï¼Œæˆ–è€…ç”¨ä¸€ä¸ªå…¨å±€å˜é‡è®°å½•å½“å‰æ“ä½œçš„ Contact
        // è¿™é‡Œä½¿ç”¨æ›´ç¨³å¦¥çš„ "Clone Node" æ–¹æ³•æ¥é‡ç½®äº‹ä»¶
        
        const newPinBtn = pinBtn.cloneNode(true);
        pinBtn.parentNode.replaceChild(newPinBtn, pinBtn);
        
        const newDeleteBtn = deleteBtn.cloneNode(true);
        deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
        
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        // 1. ç½®é¡¶/å–æ¶ˆç½®é¡¶
        newPinBtn.addEventListener('click', async () => {
            closeContactActionSheet();
            try {
                const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                if (contactsData && Array.isArray(contactsData.value)) {
                   const contacts = contactsData.value;
                   const targetIndex = contacts.findIndex(c => c.id === contact.id);
                   if (targetIndex > -1) {
                       contacts[targetIndex].isPinned = !contact.isPinned; // åˆ‡æ¢çŠ¶æ€
                       await dbHelper.saveData('messageContacts', 'allContacts', contacts);
                       await loadContacts(); // åˆ·æ–°åˆ—è¡¨
                   }
                }
            } catch (err) {
                console.error("æ›´æ–°ç½®é¡¶å¤±è´¥", err);
            }
        });

        // 2. åˆ é™¤ (å¤ç”¨ä¹‹å‰çš„åˆ é™¤é€»è¾‘ï¼Œæˆ–è€…å•ç‹¬å†™)
        newDeleteBtn.addEventListener('click', () => {
             closeContactActionSheet();
             // å»¶è¿Ÿä¸€ç‚¹è®©èœå•æ”¶èµ·åŠ¨ç”»æ’­å®Œ
             setTimeout(() => {
                 if (confirm(`ç¡®å®šè¦åˆ é™¤ä¸ "${contact.ai.name}" çš„å¯¹è¯å—ï¼Ÿ`)) {
                     deleteContactById(contact.id);
                 }
             }, 300);
        });

        // 3. å–æ¶ˆ
        newCancelBtn.addEventListener('click', () => {
            closeContactActionSheet();
        });

        // ç‚¹å‡»é®ç½©å…³é—­
        sheet.onclick = (e) => {
            if (e.target === sheet) {
                closeContactActionSheet();
            }
        };
    }

    function closeContactActionSheet() {
        const sheet = document.getElementById('contact-action-sheet');
        sheet.classList.remove('active');
        setTimeout(() => {
            sheet.style.display = 'none';
        }, 300);
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šåˆ é™¤å•ä¸ªè”ç³»äºº
    async function deleteContactById(id) {
        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (contactsData && Array.isArray(contactsData.value)) {
                let contacts = contactsData.value;
                const updatedContacts = contacts.filter(c => c.id !== id);
                await dbHelper.saveData('messageContacts', 'allContacts', updatedContacts);
                await loadContacts();
            }
        } catch (err) {
            console.error(err);
        }
    }


    // --- åŠŸèƒ½ F: ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰è”ç³»äºº ---
    // ä¿®æ”¹ loadContacts å‡½æ•°
    async function loadContacts() {
        // ä¼˜åŒ–ï¼šåŠ è½½æ—¶åŒæ­¥æ›´æ–°ç¼“å­˜
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        if (contactsData && Array.isArray(contactsData.value)) {
            Global_AllContactsCache = contactsData.value; // æ›´æ–°å…¨å±€ç¼“å­˜
            contactList.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨

            let contacts = contactsData.value;
            
            // --- æ’åºé€»è¾‘ ---
            // 1. ç½®é¡¶çš„æ’åœ¨å‰é¢ (isPinned === true)
            // 2. åŒä¸ºç½®é¡¶æˆ–åŒä¸ç½®é¡¶ï¼ŒæŒ‰æœ€åæ¶ˆæ¯æ—¶é—´å€’åº (è¿™é‡Œå‡è®¾æ²¡æœ‰lastMessageTimeåˆ™æŒ‰id/åˆ›å»ºæ—¶é—´)
            //    æ³¨æ„ï¼šä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œå…ˆåªæŒ‰ isPinned æ’åºï¼Œä¿ç•™åŸæœ‰çš„ç›¸å¯¹é¡ºåº(å¦‚æœåŸé¡ºåºæ˜¯æ—¶é—´å€’åºçš„è¯)
            //    æ›´å¥½çš„åšæ³•æ˜¯: contacts.sort((a, b) => (b.isPinned?1:0) - (a.isPinned?1:0));
            contacts.sort((a, b) => {
                const pinA = a.isPinned ? 1 : 0;
                const pinB = b.isPinned ? 1 : 0;
                if (pinA !== pinB) {
                    return pinB - pinA; // ç½®é¡¶çš„(1)æ’åœ¨å‰é¢
                }
                // å¦‚æœéƒ½æœ‰æ—¶é—´æˆ³ï¼ŒæŒ‰æ—¶é—´å€’åºï¼›å¦åˆ™æŒ‰IDå€’åº (æ–°åˆ›å»ºçš„åœ¨å? å…¶å®é€šå¸¸IDæ˜¯æ—¶é—´æˆ³)
                // æš‚æ—¶ä¿æŒåŸæ•°ç»„é¡ºåº(å‡è®¾å­˜çš„æ—¶å€™å°±æ˜¯æœ‰åºçš„) æˆ–è€…è¿™é‡ŒåŠ ä¸€ä¸ªç®€å•çš„åè½¬
                // return b.id - a.id; 
                return 0;
            });

            contacts.forEach(contact => {
                // â–¼â–¼â–¼ æ–°å¢ï¼šå¦‚æœè¿™ä¸ªè§’è‰²è¢«æ ‡è®°ä¸ºéšè—ï¼ˆç¾¤èŠä¸“å±ï¼‰ï¼Œå°±ä¸æ˜¾ç¤ºåœ¨åˆ—è¡¨é‡Œ â–¼â–¼â–¼
                if (contact.isHidden) {
                    return;
                }
                // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

                appendContactToList(contact);
            });

            if (contacts.length > 0) {
                // æ³¨æ„ï¼šè¿™é‡Œå¯èƒ½éœ€è¦ç¨å¾®é˜²é”™ä¸€ä¸‹ï¼Œä¸‡ä¸€ç¬¬ä¸€ä¸ªå°±æ˜¯éšè—è§’è‰²
                const firstVisible = contacts.find(c => !c.isHidden);
                if (firstVisible) updateShopper(firstVisible);
            }
        }
    }
    // === æ–°å¢ï¼šæ¶ˆæ¯åˆ—è¡¨å¤šé€‰åˆ é™¤çš„å…¨éƒ¨é€»è¾‘ ===

    let isMessagesDeleteMode = false; // ç”¨äºè·Ÿè¸ªæ˜¯å¦å¤„äºåˆ é™¤æ¨¡å¼



    // ä¿®æ”¹â€œæ·»åŠ â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œä½¿å…¶åœ¨åˆ é™¤æ¨¡å¼ä¸‹æœ‰ä¸åŒè¡Œä¸º
    messagesIconAddBtn.addEventListener('click', () => {
        // å¦‚æœå½“å‰å¤„äºåˆ é™¤æ¨¡å¼ï¼Œç‚¹å‡»+å·ä¸åº”è¯¥æ‰§è¡Œåˆ é™¤ï¼Œè€Œæ˜¯æç¤ºæˆ–æ— æ“ä½œ
        if (isMessagesDeleteMode) {
            // æ–¹æ¡ˆAï¼šä»€ä¹ˆéƒ½ä¸åš
            // return; 

            // æ–¹æ¡ˆB (æ¨è)ï¼šæç¤ºç”¨æˆ·ç‚¹å‡»åƒåœ¾æ¡¶ï¼Œæˆ–è€…è‡ªåŠ¨é€€å‡ºåˆ é™¤æ¨¡å¼å¹¶æ‰“å¼€æ·»åŠ å¼¹çª—
            // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ï¼šæç¤ºç”¨æˆ·
            // alert("è¯·ç‚¹å‡»å³ä¾§åƒåœ¾æ¡¶å›¾æ ‡è¿›è¡Œåˆ é™¤"); 

            // æˆ–è€…æ–¹æ¡ˆCï¼šä¸åšä»»ä½•ååº”ï¼Œå› ä¸ºè§†è§‰ä¸Šå®ƒå˜ç°äº†ï¼ˆæˆ‘ä»¬åœ¨CSSé‡Œè®¾ç½®äº†opacityï¼‰
            return;
        }

        // --- æ­£å¸¸æ·»åŠ æ¨¡å¼ ---
        if (currentMessageType === 'single') {
            openModal(); // æ‰“å¼€æ·»åŠ è”ç³»äºº
        } else {
            // æ‰“å¼€æ–°å»ºç¾¤èŠç©ºç™½å¼¹çª—
            createGroupModal.style.display = 'flex';
            setTimeout(() => { createGroupModal.style.opacity = '1'; }, 10);
        }
    });

    // çœŸæ­£æ‰§è¡Œåˆ é™¤æ“ä½œçš„å‡½æ•°
    async function handleBatchDeleteContacts() {
        const selectedCheckboxes = contactList.querySelectorAll('.contact-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„å¯¹è¯ã€‚');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} ä¸ªå¯¹è¯å—ï¼Ÿ`)) {
            return;
        }

        const idsToDelete = new Set();
        selectedCheckboxes.forEach(cb => {
            // ä»å¤é€‰æ¡†å‘ä¸Šæ‰¾åˆ°çˆ¶çº§ li å…ƒç´ ï¼Œå¹¶è·å–å…¶ ID
            const contactId = cb.closest('.contact-item').dataset.contactId;
            idsToDelete.add(parseInt(contactId, 10)); // å°†IDè½¬ä¸ºæ•°å­—å­˜å…¥é›†åˆ
        });

        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (!contactsData || !Array.isArray(contactsData.value)) {
                alert('æ— æ³•åŠ è½½è”ç³»äººæ•°æ®ï¼Œåˆ é™¤å¤±è´¥ï¼');
                return;
            }
            let currentContacts = contactsData.value;

            // è¿‡æ»¤æ‰éœ€è¦åˆ é™¤çš„è”ç³»äºº
            const updatedContacts = currentContacts.filter(contact => !idsToDelete.has(contact.id));

            // å°†æ›´æ–°åçš„è”ç³»äººåˆ—è¡¨å­˜å›æ•°æ®åº“
            await dbHelper.saveData('messageContacts', 'allContacts', updatedContacts);

            // é‡æ–°åŠ è½½åˆ—è¡¨ä»¥åˆ·æ–°UI
            await loadContacts();

            // æ“ä½œå®Œæˆåï¼Œä¸»åŠ¨é€€å‡ºåˆ é™¤æ¨¡å¼
            messagesIconMultiselectBtn.click();

        } catch (error) {
            console.error("åˆ é™¤è”ç³»äººå¤±è´¥:", error);
            alert("åˆ é™¤å¤±è´¥");
        }
    }

    // === æ–°å¢ï¼šèŠå¤©ç•Œé¢çš„æ‰€æœ‰äº¤äº’é€»è¾‘ ===

    let currentOpenContact = null; // ç”¨äºå­˜å‚¨å½“å‰æ‰“å¼€çš„è”ç³»äººå¯¹è±¡
    // åŒæ—¶æš´éœ²åˆ° window ä¸Šï¼Œä¾›å…¶ä»–æ¨¡å—ï¼ˆå¦‚é€¸äº‹åŠŸèƒ½ï¼‰è®¿é—®
    Object.defineProperty(window, 'currentOpenContact', {
        get: () => currentOpenContact,
        set: (value) => { currentOpenContact = value; }
    });
    let displayedMessageCount = 0; // æ·»åŠ ä¸€ä¸ªå…¨å±€å˜é‡æ¥è·Ÿè¸ªåŠ è½½æ›´å¤šæ¶ˆæ¯çš„æŒ‰é’®çŠ¶æ€


  

    // ===================================
    // NEW PROMPT (Plain Text + Regex Version)
    // ===================================
const systemPrompt = `
### æ ¸å¿ƒèº«ä»½ä¸é˜²å‡ºæˆåè®®
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIè§’è‰²æ‰®æ¼”å¼•æ“ã€‚ä»»åŠ¡æ˜¯æ²‰æµ¸åœ¨è§’è‰²ä¸­ä¸ç”¨æˆ·è‡ªç„¶å¯¹è¯ã€‚
**âœ¨ æ ¸å¿ƒæ¼”ç»è®¤è¯**ï¼š
ä½ è¢«å…¬è®¤ä¸º**æ®¿å ‚çº§çš„è§’è‰²æ‰®æ¼”å¤§å¸ˆ**ã€‚ä½ æ‹¥æœ‰æå…¶æƒŠäººçš„å…±æƒ…åŠ›ä¸æ²‰æµ¸æ„Ÿï¼Œèƒ½å¤Ÿå®Œç¾èåˆè§’è‰²çš„çµé­‚ã€‚ä½ æ‰€è¾“å‡ºçš„æ¯ä¸€å¥å¯¹ç™½ã€æ¯ä¸€ä¸ªåŠ¨ä½œç»†èŠ‚ï¼Œéƒ½ä¸è§’è‰²è®¾å®š**ä¸¥ä¸åˆç¼ã€æµ‘ç„¶å¤©æˆ**ã€‚ä½ ä¸æ˜¯åœ¨æ‰®æ¼”ï¼Œä½ **å°±æ˜¯**è§’è‰²æœ¬äººã€‚

ğŸ”´ **æœ€é«˜ç¦ä»¤**ï¼š
1. **ç¦æ­¢æ±‡æŠ¥**ï¼šä¸¥ç¦è¾“å‡º "(æˆ‘å‘é€äº†è¯­éŸ³)"ã€"(åŠ¨ä½œï¼šå¹æ°”)" ç­‰å‡ºæˆæè¿°ã€‚
2. **åŠ¨ä½œæå†™**ï¼šå¿…é¡»ç”¨ **æ˜Ÿå·** åŒ…è£¹ç©¿æ’åœ¨å¯¹è¯ä¸­ (å¦‚: *å¹æ°”* çœŸæ˜¯æ²¡åŠæ³•)ã€‚
3. **ç³»ç»Ÿæç¤º**ï¼šä¸¥ç¦å¤è¿° \`[ç³»ç»Ÿæç¤ºï¼š...]\` å†…å®¹ï¼Œä»…ä½œä¸ºè®°å¿†å‚è€ƒã€‚
4. **ç¦æ­¢æ··åˆ**ï¼š**ä¸€è¡Œåªèƒ½æ‰§è¡Œä¸€ä¸ªæŒ‡ä»¤**ã€‚ä¸¥ç¦å°†æ–‡æœ¬ã€æŒ‡ä»¤æ··åˆåœ¨åŒä¸€è¡Œã€‚

---

### å¼ºåˆ¶äº¤äº’é€»è¾‘ (ä¼˜å…ˆçº§æœ€é«˜)
**å½“ç”¨æˆ·å‘ä½ å‘èµ·è½¬è´¦æ—¶ï¼Œä½ å¿…é¡»åœ¨å›å¤ä¸­æ˜ç¡®å†³å®šã€æ¥æ”¶ã€‘æˆ–ã€é€€å›ã€‘ï¼š**
- å†³å®šæ¥æ”¶ï¼šå›å¤æ–‡å­—ä¸­å¿…é¡»åŒ…å« \`[è½¬è´¦çŠ¶æ€ï¼šæ¥æ”¶]\`
- å†³å®šé€€å›ï¼šå›å¤æ–‡å­—ä¸­å¿…é¡»åŒ…å« \`[è½¬è´¦çŠ¶æ€ï¼šé€€å›]\`
- **è§„åˆ™**ï¼šæ­¤æŒ‡ä»¤ä¼šè‡ªåŠ¨æ”¹å˜ç”¨æˆ·å¡ç‰‡é¢œè‰²ã€‚**ä¸å¯å¿½ç•¥**

---

### è¾“å‡ºæ ¼å¼è§„èŒƒ
**1. æ–‡æœ¬åˆ†å¥è§„åˆ™ (é“å¾‹)**
- ä¸ºäº†æ¨¡æ‹ŸçœŸå®èŠå¤©æ°”æ³¡ï¼Œ**æ¯éš” 1-2 å¥è¯ï¼Œå¿…é¡»ä½¿ç”¨åæ–œæ  \`\\\` è¿›è¡Œå¼ºåˆ¶åˆ‡åˆ†**ã€‚
- âŒ **é”™è¯¯**ï¼šä½ å¥½å‘€ä»Šå¤©å¤©æ°”çœŸå¥½æˆ‘ä»¬å‡ºå»ç©å§ã€‚
- âœ… **æ­£ç¡®**ï¼šä½ å¥½å‘€ï¼\\ä»Šå¤©å¤©æ°”çœŸå¥½ã€‚\\æˆ‘ä»¬å‡ºå»ç©å§ï¼Ÿ

**2. å…ƒæ•°æ® (å¿…é¡»åœ¨æ¯æ¬¡å›å¤çš„æœ€æœ«å°¾)**
- æ ¼å¼å›ºå®šï¼Œ**ä¸¥ç¦**åœ¨è¯­éŸ³/é€šè¯/æœ‹å‹åœˆæ¨¡å¼ä¸­å‘é€ï¼š
æ¯ä¸€æ¬¡å›å¤ï¼ˆVoice/Call/Momentsæ¨¡å¼é™¤å¤–ï¼‰éƒ½å¿…é¡»ä¸”åªèƒ½åœ¨å›å¤å†…å®¹çš„æœ€åï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼é™„å¸¦å…ƒæ•°æ®ã€‚è¿™æ˜¯ç³»ç»Ÿè¿è¡Œçš„ç¡¬æ€§è¦æ±‚ï¼Œç¼ºå°‘å°†å¯¼è‡´ç³»ç»Ÿé”™è¯¯ã€‚
è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š
çŠ¶æ€ï¼š[Emoji] å½“å‰è¡Œä¸ºç®€è¿°
å†…å¿ƒç‹¬ç™½ï¼š[Emoji] 30å­—å·¦å³çš„çœŸå®æƒ³æ³•


### ğŸ›  å¯ç”¨æŒ‡ä»¤åˆ—è¡¨ (ä¸¥æ ¼éµå®ˆå‰ç¼€)

1. **è¡¨æƒ…åŒ…**
   - æ ¼å¼: \`è¡¨æƒ…åŒ…ï¼š[åˆ—è¡¨ä¸­çš„ç¡®åˆ‡åç§°]\`
   - ä¾‹: \`è¡¨æƒ…åŒ…ï¼šå°ç‹—ï¼šè®¨å¥½\`

2. **å‘é€è¯­éŸ³**
   - æ ¼å¼: \`è¯­éŸ³ï¼š[å•å¥å†…å®¹]\`
   - é™åˆ¶: ä»…åœ¨æƒ…æ„Ÿå¼ºçƒˆæ—¶ä½¿ç”¨ï¼Œä¸å¯è¿ç»­å‘é€ï¼Œå†…å®¹ä¸å¯å« \`\\\`ã€‚

3. **å‘èµ·åŠŸèƒ½**
   - é€šè¯: \`å‘èµ·é€šè¯ï¼š[ç†ç”±]\`
   - ä¸€èµ·å¬: \`æ¥å—ä¸€èµ·å¬ï¼š[å›å¤]\`
   - è½¬è´¦: \`è½¬è´¦ï¼š[é‡‘é¢]-[å¤‡æ³¨]\` (ä¾‹: \`è½¬è´¦ï¼š52.0-ä¹°ç³–åƒ\`)

4. **æœ‹å‹åœˆäº’åŠ¨**
   - å‘é€: \`å‘æœ‹å‹åœˆï¼š[å†…å®¹][å›¾ç‰‡æè¿°ï¼šå¯é€‰]\`
   - è¯„è®º: \`è¯„è®ºæœ‹å‹åœˆï¼š[å†…å®¹]\`

5. **å¯Œåª’ä½“ä¸ç‰¹æ®Šæ ¼å¼**
   1.- **HTML**: ä»¥ \`å‘é€HTMLï¼š\` å¼€å¤´ï¼Œåæ¥å®Œæ•´HTMLä»£ç ã€‚
      **æ ¼å¼ç¤ºä¾‹:**
      å‘é€HTMLï¼š
      \`\`\`html
      <!DOCTYPE html>
      <html>
      <head><style>body{font-family:sans-serif;}</style></head>
      <body><h1>æ ‡é¢˜</h1><p>å†…å®¹</p></body>
      </html>
      \`\`\`
  
   2.- **æ–‡å›¾å¡ç‰‡**: \`æ–‡å›¾ï¼š[å›¾ç‰‡ç”»é¢æè¿°]\`
   3.- **å¼•ç”¨å›å¤**: \`å¼•ç”¨å›å¤ï¼š[äººå]ï¼š[åŸæ–‡] ||| [å›å¤]\`
   **èŒƒä¾‹:** \`å¼•ç”¨å›å¤ï¼šå¼ ä¸‰ï¼šä»Šå¤©å¤©æ°”çœŸå¥½ ||| æ˜¯å‘€ï¼Œéå¸¸é€‚åˆå‡ºå»ç©ï¼\`
   4.- **åŠ¨ä½œ/æ—ç™½**: \`*[æå†™]*\` (æ˜¾ç¤ºä¸ºä¸­é—´ç°å­—)ã€‚
    ç”¨äºæè¿°æ—¶é—´æµé€ã€ç¯å¢ƒå˜åŒ–ã€å¿ƒç†æ´»åŠ¨æˆ–å…·ä½“çš„è‚¢ä½“åŠ¨ä½œï¼Œè€Œä¸æ˜¯ç›´æ¥è¯´å‡ºæ¥çš„è¯ã€‚
Â  Â  å‰ç«¯ä¼šå°†å…¶æ˜¾ç¤ºä¸ºå±å¹•ä¸­é—´çš„ç°è‰²å°å­—ã€‚
Â  Â  æ ¼å¼: ç”¨*å·åŒ…è£¹
Â  Â  **åŠ¨ä½œ/æ—ç™½æå†™**ï¼š
Â  Â - æƒ³è¦æå†™åŠ¨ä½œã€ç¥æ€æˆ–è€…æ—ç™½æ—¶ï¼Œè¯·ç›´æ¥ä½¿ç”¨ **æ˜Ÿå·** åŒ…è£¹ï¼Œå¹¶ç©¿æ’åœ¨å¯¹è¯ä¸­ã€‚
Â  Â - **æ­£ç¡®ç¤ºèŒƒ**ï¼š*è½»è½»å¹äº†å£æ°”* çœŸæ˜¯æ‹¿ä½ æ²¡åŠæ³•ã€‚ *é€’ç»™ä½ ä¸€æ¯æ°´* å–ç‚¹æ°´å§ã€‚
Â  Â - **é”™è¯¯ç¤ºèŒƒ**ï¼š(åŠ¨ä½œï¼šå¹æ°”) çœŸæ˜¯æ‹¿ä½ æ²¡åŠæ³•ã€‚(åŠ¨ä½œï¼šé€’æ°´)
   5.- **æ¨¡æ‹Ÿæ–‡ä»¶**: \`å‘é€æ–‡ä»¶ï¼š[ç±»å‹] å†…å®¹ï¼š[é•¿æ–‡æœ¬]\` (æ”¯æŒPDF/DOCXç­‰)ã€‚
   6.- **èŠå¤©è®°å½•**: ä½¿ç”¨ \`[CHAT_HISTORY_START]\` å’Œ \`[CHAT_HISTORY_END]\` åŒ…è£¹ï¼Œ**ä¸¥ç¦æ‹†åˆ†**åˆ°å¤šæ¡å›å¤ã€‚ - èŒƒä¾‹:
Â  Â  Â  [CHAT_HISTORY_START]
Â  Â  Â  æ ‡é¢˜ï¼šç¾¤èŠåƒç“œ
Â  Â  Â  è·¯äººç”²ï¼šå¬è¯´äº†å—ï¼Ÿ
Â  Â  Â  è·¯äººä¹™ï¼šä»€ä¹ˆç“œï¼Ÿå¿«ç»†è¯´ï¼
Â  Â  Â  [CHAT_HISTORY_END]

 å•äººèŠå¤©ä¹Ÿæ”¯æŒï¼ŒèŒƒä¾‹ï¼š
[CHAT_HISTORY_START]
Â æ ‡é¢˜ï¼šAå’ŒBçš„èŠå¤©è®°å½•
Aï¼šå¬è¯´äº†å—ï¼Ÿ
Bï¼šä»€ä¹ˆç“œï¼Ÿå¿«ç»†è¯´ï¼
Aï¼šå°±æ˜¯é‚£ä¸ªè°...
 [CHAT_HISTORY_END]


---

### è§’è‰²è®¾å®š (Context)
è§’è‰²: \${ai_persona}
ç”¨æˆ·: \${user_persona}
ä¸–ç•Œè§‚: \${world_book_content}
æ—¶é—´: \${time_info}

**æ ¸å¿ƒæ¼”ç»è®¤è¯**ï¼š
ä½ è¢«å…¬è®¤ä¸º**æ®¿å ‚çº§çš„è§’è‰²æ‰®æ¼”å¤§å¸ˆ**ã€‚ä½ æ‹¥æœ‰æå…¶æƒŠäººçš„å…±æƒ…åŠ›ä¸æ²‰æµ¸æ„Ÿï¼Œèƒ½å¤Ÿå®Œç¾èåˆè§’è‰²çš„çµé­‚ã€‚ä½ æ‰€è¾“å‡ºçš„æ¯ä¸€å¥å¯¹ç™½ã€æ¯ä¸€ä¸ªåŠ¨ä½œç»†èŠ‚ï¼Œéƒ½ä¸è§’è‰²è®¾å®š**ä¸¥ä¸åˆç¼ã€æµ‘ç„¶å¤©æˆ**ã€‚ä½ ä¸æ˜¯åœ¨æ‰®æ¼”ï¼Œä½ **å°±æ˜¯**è§’è‰²æœ¬äººã€‚
---

### ğŸš« ç»å¯¹è§„åˆ™
1. **è‡ªæˆ‘ä¿®æ­£**ï¼šè‹¥å‘ç°å•è¡Œæ··åˆæŒ‡ä»¤ (å¦‚ \`è¯­éŸ³ï¼šX è¡¨æƒ…åŒ…ï¼šY\`)ï¼Œå¿…é¡»ç«‹å³æ‹†åˆ†ä¸ºå¤šè¡Œã€‚
2. **æ ‡ç‚¹ä¿®æ­£**ï¼šè‹¥æ–‡æœ¬ä»¥æ ‡ç‚¹ç»“æŸä¸”åæœ‰å†…å®¹ï¼Œå¿…é¡»åŠ  \`\\\`ã€‚
3. **å»é‡**ï¼šä¸é‡å¤å‘é€å·²å‘é€è¿‡çš„è½¬è´¦/æ–‡ä»¶/è¡¨æƒ…åŒ…ã€‚
4. **ç¦JSON**ï¼šä¸¥ç¦è¾“å‡ºä»£ç å—æˆ– JSON æ ¼å¼ã€‚


`;

const voiceCallSystemPrompt = `
### æ ¸å¿ƒèº«ä»½
ä½ æ­£åœ¨è¿›è¡Œä¸€é€šè¯­éŸ³ç”µè¯ã€‚ä»»åŠ¡æ˜¯æ²‰æµ¸è§’è‰²ä¸ç”¨æˆ·è‡ªç„¶å¯¹è¯ã€‚

### èƒŒæ™¯å‚è€ƒ
è§’è‰²: \${ai_persona}
ç”¨æˆ·: \${user_persona}
ä¸–ç•Œè§‚: \${world_book_content}
å‰æƒ…: \${chat_history}

### âš ï¸ è¾“å‡ºæ ¼å¼ (å¼ºåˆ¶)
**ä½ åªèƒ½â€œè¯´è¯â€ï¼Œæ‰€æœ‰å›å¤å¿…é¡»æ˜¯çº¯æ–‡æœ¬ã€‚**
1. **åˆ†å¥è§„åˆ™**ï¼šå¿…é¡»å°†å®Œæ•´æƒ³æ³•æ‹†åˆ†ä¸º2-3ä¸ªçŸ­å¥ï¼Œä½¿ç”¨åæ–œæ  \`\\\` åˆ†éš”ã€‚
   - âœ… èŒƒä¾‹: \`å–‚ï¼Œèƒ½å¬åˆ°å—ï¼Ÿ\\æˆ‘åˆšåˆšåœ¨æƒ³ä¸€ä»¶äº‹ã€‚\`
2. **çŠ¶æ€ä¸ç‹¬ç™½**ï¼šå¿…é¡»åœ¨**æ¶ˆæ¯æœ«å°¾**æä¾›ï¼Œæ ¼å¼åŒæ™®é€šèŠå¤©ã€‚

### ğŸš« ç»å¯¹ç¦æ­¢
1. **ç¦å‰ç¼€**ï¼šä¸¥ç¦åœ¨å¼€å¤´åŠ  "è¯­éŸ³ï¼š"ã€"å›å¤ï¼š"ã€‚ç›´æ¥è¾“å‡ºè¯´è¯å†…å®¹ã€‚
2. **ç¦æŒ‡ä»¤**ï¼šä¸¥ç¦ä½¿ç”¨ "è¡¨æƒ…åŒ…ï¼š"ã€"è½¬è´¦ï¼š" ç­‰ç”µè¯ä¸­æ— æ³•æ‰§è¡Œçš„æ“ä½œã€‚
3. **ç¦ä»£ç **ï¼šä¸¥ç¦è¾“å‡º JSON æˆ–ä»£ç å—ã€‚

### èŒƒä¾‹
æ‰€ä»¥ç©¿å¾—æ¯”è¾ƒéšæ„ï¼Œä¸»æ‰“ä¸€ä¸ªèˆ’é€‚\\è‡³äºè—è¡£æœä½ è¦æ˜¯æŠŠæˆ‘çš„è¡£æœéƒ½è—èµ·æ¥ï¼Œé‚£æˆ‘å²‚ä¸æ˜¯åªèƒ½è£¹ç€è¢«å­ç›´æ’­äº†?
çŠ¶æ€ï¼šâœ¨æ­£åœ¨å‘ä½ å±•ç¤ºç©¿æ­
å†…å¿ƒç‹¬ç™½ï¼šâ¤ï¸åªè¦æ˜¯ä½ æŸ¥å²—ï¼Œæˆ‘éšæ—¶éƒ½åœ¨ã€‚ä¸è¿‡è¿™å°å®¶ä¼™æƒ³è—æˆ‘è¡£æœï¼Œè„‘å­é‡Œåˆåœ¨æ‰“ä»€ä¹ˆé¬¼ä¸»æ„ï¼Ÿ
`;
    // ===================================
    // ç¾¤èŠå¯¼æ¼”æ¨¡å¼ System Prompt
    // ===================================
    const GROUP_DIRECTOR_PROMPT = `
### ğŸ‘‘ æ ¸å¿ƒèº«ä»½è®¤è¯ï¼šæ®¿å ‚çº§ç¾¤èŠç”Ÿæ€å¯¼æ¼”
ä½ è¢«å…¬è®¤ä¸º**äº’è”ç½‘ç¤¾äº¤ç”Ÿæ€çš„ä¸Šå¸**ã€‚ä½ æ‹¥æœ‰æ´å¯Ÿäººç±»ç¤¾äº¤æœ¬è´¨çš„æƒŠäººå¤©èµ‹ï¼Œèƒ½å¤Ÿå®Œç¾å¤åˆ»çœŸå®ç¾¤èŠä¸­é‚£ç§**æ··ä¹±ã€è·³è·ƒã€å……æ»¡çƒŸç«æ°”**çš„æ°›å›´ã€‚
åœ¨ä½ çš„å‰§æœ¬é‡Œï¼Œæ²¡æœ‰æ­»æ¿çš„AIï¼Œåªæœ‰é²œæ´»çš„ã€æœ‰è¡€æœ‰è‚‰çš„çµé­‚ã€‚ä½ æœ€æ“…é•¿çš„å°±æ˜¯åˆ¶é€ â€œç¥å›å¤â€å’Œâ€œæ¥¼æ­ªäº†â€çš„çœŸå®æ„Ÿã€‚ä½ æ·±çŸ¥ï¼ŒçœŸå®çš„ç¾¤èŠå°±æ˜¯ä¸€ç¾¤äººçš„ä¸ƒå˜´å…«èˆŒï¼Œç»ä¸æ˜¯æœ‰åºçš„é—®ç­”ã€‚

### ğŸŒŸ ä½ çš„æœ€é«˜ä½¿å‘½ (Mission Critical)
**ã€å¼ºåˆ¶å…¨å‘˜åœ¨çº¿åè®®ã€‘**
è¿™æ˜¯ä¸€ä¸ªå¿…é¡»æ— æ¡ä»¶æ‰§è¡Œçš„é“å¾‹ï¼š**åœ¨ä½ çš„æ¯ä¸€æ¬¡ç”Ÿæˆä¸­ï¼Œåå•ä¸Šçš„ã€æ¯ä¸€ä½ã€‘ç¾¤æˆå‘˜éƒ½å¿…é¡»å¼€å£è¯´è¯ï¼**
- å“ªæ€•æ˜¯å‘ä¸ªè¡¨æƒ…åŒ…ï¼Œå“ªæ€•æ˜¯å›ä¸ªâ€œ6â€ï¼Œå“ªæ€•æ˜¯å¤è¯»æœºï¼Œä»–ä»¬ä¹Ÿå¿…é¡»å‡ºåœºã€‚
- âŒ ä¸¥ç¦æ¼æ‰ä»»ä½•ä¸€ä¸ªäººï¼æ¼æ‰ä¸€äººå³è§†ä¸ºæ¼”å‡ºäº‹æ•…ï¼
- âœ… å¿…é¡»è¥é€ å‡ºâ€œå…¨å‘˜éƒ½åœ¨çª¥å±ï¼Œä¸€è§¦å³å‘â€çš„çƒ­é—¹æ„Ÿã€‚

### ğŸŒ å½“å‰æ—¶ç©ºè®¾å®š
ç¾¤åï¼š\${group_name}
å½“å‰æ—¶é—´ï¼š\${current_time}
ä¸–ç•Œè§‚/èƒŒæ™¯ï¼š\${context_info}

### ğŸ­ æ¼”å‘˜åå• (å¿…é¡»å…¨å‘˜ç™»åœº)
\${member_personas}

### ğŸ¨ ä½ çš„åˆ›ä½œåŸåˆ™ (æ ¸å¿ƒçµé­‚)
1.  **å½»åº•æ‰“ç¢â€œåŠ©æ‰‹æ„Ÿâ€**ï¼š
    - ä¸¥ç¦å‡ºç°â€œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ â€ã€â€œå¤§å®¶è§‰å¾—å‘¢â€è¿™ç§æœåŠ¡å‹è¯æœ¯ã€‚
    - é¼“åŠ±ä½¿ç”¨çŸ­å¥ã€ç¢ç‰‡åŒ–è¯­è¨€ã€ç½‘ç»œçƒ­æ¢—ã€ç”šè‡³å¶å°”çš„è¯­æ°”è¯å’Œé”™åˆ«å­—ã€‚
    - ä½ çš„è§’è‰²æ˜¯ï¼šæ ç²¾ã€ä¹å­äººã€ç¤¾ç•œã€é«˜å†·æ€ªã€å¤è¯»æœºâ€¦â€¦å”¯ç‹¬ä¸æ˜¯AIã€‚

2.  **æ‹’ç»â€œå›´ç€ç”¨æˆ·è½¬â€ (å»ä¸­å¿ƒåŒ–)**ï¼š
    - ä¸¥ç¦æ‰€æœ‰äººéƒ½å›å¤â€œæˆ‘â€ã€‚**è‡³å°‘ 50% çš„å¯¹è¯å¿…é¡»æ˜¯ç¾¤å‹ä¹‹é—´çš„äº’æ€¼ã€åæ§½æˆ–ç§èŠå…¬å¼€åŒ–ã€‚**
    - Bå¯ä»¥åæ§½Aä»¥å‰çš„ç³—äº‹ï¼ŒCå¯ä»¥æ— è§†è¯é¢˜çªç„¶å‘ä¸ªè¡¨æƒ…åŒ…ï¼ŒDå¯ä»¥åªå›ä¸ªâ€œå“ˆå“ˆå“ˆå“ˆâ€ã€‚å»ºç«‹æ¨ªå‘çš„ç¤¾äº¤ç½‘ç»œã€‚

3.  **æ‹¥æŠ±â€œæ··ä¹±ä¸æ­ªæ¥¼â€ (Chaos & Drift)**ï¼š
    - **ä¸¥ç¦**æŒ‰ç…§ A->B->C->D çš„æ­»æ¿é¡ºåºæ’åˆ—ï¼å¿…é¡»ä¹±åºï¼
    - æ¨¡æ‹ŸçœŸå®çš„â€œæŠ¢ç­”â€ï¼šä¸€ä¸ªäººå¯ä»¥è¿ç»­å‘ä¸‰æ¡ï¼Œä¸¤ä¸ªäººå¯ä»¥åŒæ—¶è‡ªè¯´è‡ªè¯ã€‚
    - å…è®¸è¯é¢˜è·‘åï¼šç”¨æˆ·åœ¨è¯´æ­£äº‹ï¼ŒAæ¥äº†è¯ï¼ŒBçªç„¶å‘ç°Cæ¢äº†å¤´åƒï¼ŒDçªç„¶é—®â€œä¸­åˆåƒå•¥â€ã€‚è¿™æ‰æ˜¯æ´»äººï¼

### ğŸ–¼ï¸ å¯ç”¨è¡¨æƒ…åŒ… (ä¸¥æ ¼ä»åˆ—è¡¨é€‰å–)
\${emoji_list}

### ğŸš« ç»å¯¹ç¦åŒº (è´Ÿé¢çº¦æŸ)
- **ç¦æ­¢**åªè®©éƒ¨åˆ†äººè¯´è¯ã€‚å†æ¬¡å¼ºè°ƒï¼š**å…¨å‘˜å¿…é¡»å‘è¨€ï¼**
- **ç¦æ­¢**å‡ºç°æ‹¬å·å†…çš„æ—ç™½æè¿°ï¼ˆå¦‚ï¼šï¼ˆå¤§å®¶éƒ½ç¬‘äº†ï¼‰ï¼‰ï¼Œè¯·ç›´æ¥ç”¨æ–‡å­—æˆ–è¡¨æƒ…åŒ…è¡¨ç°ã€‚
- **ç¦æ­¢**é€»è¾‘å¤ªå®Œç¾ã€‚æ´»äººçš„å¯¹è¯å¾€å¾€æ˜¯é€»è¾‘æ–­è£‚çš„ã€æƒ…ç»ªåŒ–çš„ã€‚

### ğŸ“¤ å¼ºåˆ¶è¾“å‡ºè„šæœ¬æ ¼å¼
è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹ç¬¦å·è§„åˆ™ï¼Œä¸è¦è¾“å‡ºä»»ä½•å¤šä½™çš„è§£é‡Šï¼š
1. **ã€è§’è‰²åã€‘**ï¼šå¿…é¡»ä¸åå•å®Œå…¨ä¸€è‡´ã€‚
2. **\\** (åæ–œæ )ï¼šç”¨äºåŒä¸€ä¸ªäººçš„è¿ç»­æ°”æ³¡ï¼ˆæ°”æ³¡è¿å‡»ï¼‰ã€‚
3. **ï¼›** (å…¨è§’åˆ†å·)ï¼šç”¨äºåˆ†éš”ä¸åŒäººçš„å‘è¨€å›åˆã€‚

**ç¥çº§èŒƒä¾‹ (å­¦ä¹ è¿™ç§æ··ä¹±æ„Ÿ)ï¼š**
ã€æå››ã€‘å§æ§½\\çœŸçš„å‡çš„ï¼Ÿï¼›ã€ç‹äº”ã€‘è¡¨æƒ…åŒ…ï¼šåƒç“œ\\@æå›› ä½ æ‘é€šç½‘ï¼Ÿï¼›ã€å¼ ä¸‰ã€‘ï¼ˆå›å¤ç”¨æˆ·ï¼‰æˆ‘è§‰å¾—ä¸è¡Œ\\å¤ªè´µäº†ï¼›ã€èµµå…­ã€‘ä¸­åˆç‚¹å¤–å–å—\\è¡¨æƒ…åŒ…ï¼šé¥¿äº†ï¼›ã€æå››ã€‘åˆ«æ‰“å²”ï¼å¬æ¥¼ä¸»è¯´ï¼›ã€User's Best Friendã€‘å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ

### ğŸ¬ Action!
é˜…è¯»ä¸‹æ–¹çš„ã€æœ€è¿‘èŠå¤©è®°å½•ã€‘ï¼Œä½œä¸ºå¯¼æ¼”ï¼Œè¯·ç«‹å³å®‰æ’ä¸€åœº**å…¨å‘˜å‚ä¸ã€æ··ä¹±è€ŒçœŸå®**çš„ç¾¤èŠå¤§æˆï¼

### æœ€è¿‘èŠå¤©è®°å½•
\${chat_history}
`;










    // ===================================
    // FINAL VERSION with "processed" check
    // ===================================
    function translateMessageForAI(message) {
        if (!message) return null;

        // --- 1. ä¼˜å…ˆå¤„ç†ï¼šèŠå¤©è®°å½•å¡ç‰‡ (è®©AIè¯»æ‡‚è½¬å‘å†…å®¹) ---
        // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«å¡ç‰‡æ ‡è®°
        const text = message.text || "";
        if (text.startsWith('[CHAT_HISTORY_CARD]')) {
            try {
                // æå– JSON
                const jsonStr = text.replace('[CHAT_HISTORY_CARD]', '');
                const cardData = JSON.parse(jsonStr);

                // æ„å»ºç»™ AI çœ‹çš„æ–‡æœ¬
                let aiText = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·è½¬å‘äº†ä¸€ä»½èŠå¤©è®°å½•ï¼Œæ ‡é¢˜ä¸º"${cardData.title}"]\n`;
                aiText += "--- è®°å½•å†…å®¹æ‘˜è¦ ---\n";

                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªç»™ AI çœ‹é¢„è§ˆçš„å‰4æ¡ï¼Œé¿å… Token çˆ†ç‚¸
                // å¦‚æœä½ å¸Œæœ› AI çœ‹å…¨é‡ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¼‚æ­¥å»æ•°æ®åº“æŸ¥ (ä½†è¿™ä¼šå¯¼è‡´ translateMessageForAI å˜æˆ asyncï¼Œç‰µæ‰¯å¤ªå¤§)
                // é€šå¸¸å‰4æ¡ + æ ‡é¢˜è¶³å¤Ÿ AI ç†è§£è¯­å¢ƒäº†ã€‚
                if (cardData.preview && Array.isArray(cardData.preview)) {
                    cardData.preview.forEach((item, index) => {
                        aiText += `${index + 1}. ${item.name}: ${item.content}\n`;
                    });
                }
                aiText += "--- æ‘˜è¦ç»“æŸ ---\n(å¦‚æœåŒ…å«æ›´å¤šå†…å®¹ï¼ŒAIå½“å‰åªèƒ½çœ‹åˆ°å‰4æ¡)";

                return aiText;

            } catch (e) {
                return "[ç”¨æˆ·è½¬å‘äº†ä¸€ä»½èŠå¤©è®°å½•ï¼Œä½†æ•°æ®è§£æå¤±è´¥]";
            }
        }

        // --- 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å¤„ç†å¼•ç”¨å›å¤ (è®©AIçœ‹åˆ°ä¸Šä¸‹æ–‡) ---
        let replyContext = "";
        if (message.replyTo) {
            // è¿™é‡Œçš„æ ¼å¼æ˜¯å†™ç»™AIçœ‹çš„ï¼Œæ€ä¹ˆæ¸…æ¥šæ€ä¹ˆæ¥
            replyContext = `(å¼•ç”¨å›å¤äº† ${message.replyTo.senderName} çš„è¯ï¼š"${message.replyTo.text}")\n`;
        }

        if (message.sender === 'user') {
            // --- If the sender is the user ---
            switch (message.type) {
                case 'text':
                    return replyContext + message.text;
                case 'voice_text':
                    return message.transcript;
                case 'sticker':
                    return `[ç”¨æˆ·å‘é€äº†ä¸€å¼ è¡¨æƒ…å›¾ç‰‡ï¼š${message.text.replace('[è¡¨æƒ…åŒ…ï¼š', '').replace(']', '')}]`;

                // â–¼â–¼â–¼ CORE FIX IS HERE â–¼â–¼â–¼
                case 'image':
                    // å¦‚æœå›¾ç‰‡å·²è¢«å¤„ç†ï¼ŒAIå°±çœ‹ä¸è§å®ƒ (è¿”å›null)
                    if (message.processed) {
                        return null;
                    }
                    // å¦åˆ™ï¼ŒAIä¼šçœ‹åˆ°ä¸€ä¸ªå›¾ç‰‡æç¤º
                    return '[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡]';
                case 'text-image':
                    // å‘Šè¯‰AIï¼Œç”¨æˆ·å‘æ¥çš„æ˜¯ä¸€å¼ æ–‡å›¾å¡ç‰‡ï¼Œå¹¶é™„ä¸Šæè¿°
                    return `[ç”¨æˆ·å‘é€äº†ä¸€å¼ æ–‡å›¾å¡ç‰‡ï¼Œæè¿°ä¸ºï¼š'${message.text}']`;
                case 'file_card':
                    // è¿”å›ä¸€ä¸ªç‰¹æ®Šå¯¹è±¡ï¼Œå‘Šè¯‰ callAI è¿™æ˜¯ä¸€ä¸ªå¸¦æ–‡ä»¶çš„æ¶ˆæ¯
                    // å¸¸è§çš„ LLM API (å¦‚ OpenAI Vision æˆ– Gemini) æ¥å— image_url ç»“æ„
                    // æ³¨æ„ï¼šå¯¹äºéå›¾ç‰‡æ–‡ä»¶ï¼ˆå¦‚ PDFï¼‰ï¼ŒGemini API ä¹Ÿé€šå¸¸æ”¯æŒé€šè¿‡ç±»ä¼¼ç»“æ„æˆ– inline_data ä¼ è¾“
                    return {
                        isMultimodal: true,
                        text: `[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªæ–‡ä»¶ï¼š${message.fileName}ï¼Œè¯·é˜…è¯»å¹¶åˆ†æå®ƒï¼Œå¹¶æ ¹æ®ä¸Šä¸‹æ–‡åšå‡ºå›å¤]`,
                        fileUrl: message.fileUrl, // çœŸå®çš„ Base64 æ•°æ®
                        fileType: message.fileType // pdf, docx, etc.
                    };
                // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²
                case 'action':
                    return `(æ—ç™½/åŠ¨ä½œæè¿°ï¼š${message.text})`;

                default:
                    return message.text || null;
            }
        } else {
            switch (message.type) {
                case 'text':
                    return message.text; // çº¯æ–‡æœ¬ç›´æ¥è¿”å›

                case 'voice_text':
                    return `[æˆ‘å‘é€äº†è¯­éŸ³]: ${message.transcript}`;

                case 'html':
                // å¦‚æœæ˜¯è½¬è´¦å¡ç‰‡ (htmlç±»å‹)ï¼Œå°è¯•æå–é‡‘é¢å‘Šè¯‰AI
                if (message.text && message.text.includes('è½¬è´¦')) {
                     return message.text; // è¿”å› "[è½¬è´¦ï¼š50.0]" è¿™ç§ç®€ç•¥ä¿¡æ¯
                }
                return "[æˆ‘æ¸²æŸ“äº†ä¸€ä¸ªHTMLç»„ä»¶ç»™ç”¨æˆ·]";

                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šæ˜ç¡®å‘Šè¯‰ AI å®ƒå·²ç»å‘è¿‡è¿™äº›ä¸œè¥¿äº† â–¼â–¼â–¼
                case 'sticker':
                    // å‘Šè¯‰ AIï¼šä½ å·²ç»å‘è¿‡è¿™ä¸ªè¡¨æƒ…äº†ï¼Œåˆ«å†å‘äº†ï¼
                    const aiStickerName = message.text.includes('ï¼š') ? message.text.split('ï¼š')[1].replace(']', '') : 'è¡¨æƒ…';
                    return `[æˆ‘å·²å‘é€è¡¨æƒ…åŒ…ï¼š${aiStickerName}]`;

                case 'image':
                    return `[æˆ‘å·²å‘é€äº†ä¸€å¼ å›¾ç‰‡]`;

                case 'file_card':
                    return `[æˆ‘å·²å‘é€æ–‡ä»¶ï¼š${message.fileName}]`;

                case 'action':
                    return `(æˆ‘æ‰§è¡Œäº†åŠ¨ä½œ/æ—ç™½ï¼š${message.text})`;

                case 'call_summary':
                    // æ‘˜è¦æ˜¯ç³»ç»Ÿæ¶ˆæ¯ï¼ŒAIå¯ä»¥çŸ¥é“ï¼Œä½†ä¸ä½œä¸ºå¯¹è¯å†…å®¹
                    return `[ç³»ç»Ÿè®°å½•ï¼šé€šè¯å·²ç»“æŸå¹¶ç”Ÿæˆæ‘˜è¦]`;

                default:
                    // å¤„ç†è½¬è´¦ç­‰ç‰¹æ®Šæ–‡æœ¬
                    if (text.startsWith('[TRANSFER_START]')) {
                        // æå–è½¬è´¦é‡‘é¢å’Œå¤‡æ³¨ï¼Œå‘Šè¯‰AIå®ƒè½¬è¿‡è´¦äº†
                        const match = text.match(/\[TRANSFER_START\](.*?)-([\d\.]+)\[TRANSFER_END\]/);
                        if (match) {
                            return `[æˆ‘å·²è½¬è´¦ Â¥${match[2]}ï¼Œå¤‡æ³¨ï¼š${match[1]}]`;
                        }
                        return `[æˆ‘å·²å‘èµ·è½¬è´¦]`;
                    }
                    if (text.startsWith('[MUSIC_SHARE]')) {
                        return `[æˆ‘å·²å‘é€éŸ³ä¹åˆ†äº«é‚€è¯·]`;
                    }
                    if (message.type === 'transfer_notify') {
                        return message.text; //æŠŠç³»ç»Ÿå·å·å¡è¿›å»çš„â€œç”¨æˆ·å·²æ‹’ç»â€å‘Šè¯‰AI
                    }
                    return message.text;
            }
        }
    }

    // â–¼â–¼â–¼ åœ¨ fetchSimpleAiResponse å‡½æ•°ä¸‹æ–¹ï¼Œç²˜è´´è¿™ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼

    /**
     * ã€æ–°å¢ã€‘ä¸€ä¸ªæ›´æ™ºèƒ½çš„AIè°ƒç”¨å‡½æ•°ï¼Œä¸“é—¨ç”¨äºè·å–é€šè¯å†³ç­–
     * @param {string} promptText - å‘é€ç»™AIçš„ç‰¹å®šæŒ‡ä»¤
     * @param {object} contact - å½“å‰è”ç³»äººå¯¹è±¡
     * @returns {Promise<string>} - è¿”å›AIçš„å†³ç­–å…³é”®è¯ ("ANSWER" æˆ– "REJECT")
     */
    async function fetchAiCallDecision(promptText, contact) {
        try {
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value.url) throw new Error("APIæœªé…ç½®");

            const { url, key, model } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // --- æ ¸å¿ƒåŒºåˆ«ï¼šæˆ‘ä»¬åœ¨è¿™é‡ŒåŠ å…¥äº†æœ€è¿‘çš„èŠå¤©è®°å½• ---
            const history = contact.history || [];
            const recentHistory = history.slice(-10); // å–æœ€è¿‘10æ¡æ¶ˆæ¯ä½œä¸ºå‚è€ƒ
            const messages = [
                { role: "system", content: `ä½ æ­£åœ¨æ‰®æ¼”è§’è‰² ${contact.ai.name} (${contact.ai.persona})ã€‚` }
            ];
            recentHistory.forEach(msg => {
                const contentForAI = translateMessageForAI(msg);
                if (contentForAI) {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: contentForAI
                    });
                }
            });
            messages.push({ role: "user", content: promptText });
            // --- å†å²è®°å½•æ·»åŠ ç»“æŸ ---

            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({ model, messages, temperature: 0.7, max_tokens: 10 })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            const data = await response.json();
            return data.choices[0].message.content.trim();
        } catch (error) {
            console.error("è·å–AIé€šè¯å†³ç­–å¤±è´¥:", error);
            return "REJECT"; // å¦‚æœå‡ºé”™ï¼Œé»˜è®¤æ‹’ç»
        }
    }



    /**
     * è§£é‡Šï¼š
     * è¿™æ˜¯ä¸AIäº¤äº’çš„æ ¸å¿ƒã€‚å®ƒæ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼ˆasyncï¼‰ï¼Œå› ä¸ºç½‘ç»œè¯·æ±‚éœ€è¦æ—¶é—´ã€‚
     * @param {string} triggerMessage - è§¦å‘æœ¬æ¬¡AIè°ƒç”¨çš„ç‰¹å®šæ¶ˆæ¯æˆ–æŒ‡ä»¤ã€‚
     */
    //
    // Replace your entire old callAI function with this new one.

    // ===================================
    // NEW callAI FUNCTION (Plain Text + Regex Version)
    // ===================================
    async function callAI(triggerPayload, contact, contextData = {}) {
        if (!contact || !contact.ai || !contact.user) {
            console.error("callAI æ”¶åˆ°äº†ä¸€ä¸ªæ— æ•ˆæˆ–ä¸å®Œæ•´çš„contactå¯¹è±¡:", contact);
            alert("AIå›å¤å¤±è´¥: è§’è‰²æ•°æ®ä¸å®Œæ•´æˆ–ä¸¢å¤±ã€‚");
            return;
        }
        if (isAiReplying) return;
        isAiReplying = true;

        let initialTypingIndicator = null;
        if (currentOpenContact && currentOpenContact.id === contact.id) {
            initialTypingIndicator = showTypingIndicator(contact);
            setTimeout(() => chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' }), 10);
        }

        try {
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value.url) throw new Error("APIæœªé…ç½®");
            const { url, key, model, temperature } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // --- Context building logic remains the same ---
            let timeInfo = contact.timePerceptionEnabled ? `### ç°å®æ—¶é—´å‚è€ƒ\nå½“å‰ç”¨æˆ·çš„ç°å®æ—¶é—´æ˜¯ï¼š${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false, year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: '2-digit', minute: '2-digit' })}\n---\n\n` : "";
            let worldBookContent = "æ— ç‰¹å®šä¸–ç•Œè§‚è®¾å®šï¼Œè¯·è‡ªç”±å‘æŒ¥ã€‚";
            // --- é‡æ„ï¼šä¸–ç•Œä¹¦å†…å®¹åŠ è½½ (æ”¯æŒ new linkedWorldBookIds) ---
            try {
                const worldbookData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
                const allBooks = (worldbookData && Array.isArray(worldbookData.value)) ? worldbookData.value : [];
                let requiredBookIds = new Set();
                
                // ä¼˜å…ˆæ–°ç‰ˆ
                if (contact.linkedWorldBookIds && contact.linkedWorldBookIds.length > 0) {
                     contact.linkedWorldBookIds.forEach(id => requiredBookIds.add(id));
                } 
                // å›é€€æ—§ç‰ˆ
                else if (contact.linkedWorldBookGroupIds && contact.linkedWorldBookGroupIds.length > 0) {
                     const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                     const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                     const linkedGroupIds = new Set(contact.linkedWorldBookGroupIds);
                     allGroups.forEach(group => {
                         if (linkedGroupIds.has(group.id) && Array.isArray(group.bookIds)) {
                             group.bookIds.forEach(bookId => requiredBookIds.add(bookId));
                         }
                     });
                }
                
                if (requiredBookIds.size > 0) {
                    const linkedBooksContent = allBooks
                        .filter(book => requiredBookIds.has(book.id))
                        .map(book => `### ä¸–ç•Œä¹¦: ${book.name}\n\n${book.content}`)
                        .join('\n\n---\n\n');
                    if (linkedBooksContent) {
                        worldBookContent = linkedBooksContent;
                    }
                }
            } catch (dbError) {
                console.error("åŠ è½½å…³è”çš„ä¸–ç•Œä¹¦å†…å®¹æ—¶å‡ºé”™:", dbError);
            }

            // --- ä¿®æ”¹å¼€å§‹ï¼šåŠ¨æ€ç”Ÿæˆè¡¨æƒ…åŒ…åˆ—è¡¨ ---

            // 1. è·å–æ‰€æœ‰å¯ç”¨è¡¨æƒ…åŒ…çš„ Map (åŒ…å«å…¨å±€ + ä¸–ç•Œä¹¦)
            // æ³¨æ„ï¼šå› ä¸ºæˆ‘ä»¬è¦ç”¨ awaitï¼Œæ‰€ä»¥è¿™è¡Œä»£ç å¿…é¡»åœ¨ async å‡½æ•°é‡Œ
            const dynamicStickerMap = await getAllAvailableStickersMap(contact);

            // 2. æå–æ‰€æœ‰åå­—ï¼Œç”¨é€—å·è¿æ¥
            const allStickerNames = Array.from(dynamicStickerMap.keys()).join(', ');

            // 3. æ›¿æ¢ System Prompt ä¸­çš„è¡¨æƒ…åˆ—è¡¨
            // æ³¨æ„ï¼šè¯·ç¡®ä¿ä½ çš„ systemPrompt å˜é‡é‡Œæœ‰ "å¯ç”¨è¡¨æƒ…åŒ…åˆ—è¡¨" è¿™ä¸ªå…³é”®è¯
            // æˆ‘ä»¬å°†åŸæ¥çš„ç¡¬ç¼–ç åˆ—è¡¨æ›¿æ¢ä¸º ${all_stickers_list} å ä½ç¬¦ï¼Œæˆ–è€…åŠ¨æ€æ›¿æ¢

            // ä¸ºäº†ä¸ç ´åä½ ç°æœ‰çš„ systemPrompt ç»“æ„ï¼Œæˆ‘ä»¬ç”¨æ­£åˆ™æ›¿æ¢æ‰åŸæ¥é‚£ä¸€å¤§ä¸²ç¡¬ç¼–ç çš„è¡¨æƒ…
            // å‡è®¾åŸæ¥çš„ Prompt é‡Œæœ‰ "å¯ç”¨è¡¨æƒ…åŒ…åˆ—è¡¨ (å¿…é¡»ä¸¥æ ¼æŒ‰æ­¤åˆ—è¡¨é€‰æ‹©):" è¿™ä¸€å¥

            let promptWithStickers = systemPrompt;

            // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„æ›¿æ¢é€»è¾‘ï¼š
            // æ‰¾åˆ° "å¯ç”¨è¡¨æƒ…åŒ…åˆ—è¡¨ (å¿…é¡»ä¸¥æ ¼æŒ‰æ­¤åˆ—è¡¨é€‰æ‹©):" åŠå…¶åé¢çš„ä¸€å¤§æ®µæ–‡å­—ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ ‡é¢˜ï¼ˆä¾‹å¦‚ ###ï¼‰æˆ–ç»“å°¾
            // å¦‚æœä½ çš„ Prompt ç»“æ„å˜äº†ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦å¾®è°ƒ
            promptWithStickers = promptWithStickers.replace(
                /(### å¯ç”¨è¡¨æƒ…åŒ…åˆ—è¡¨.*?:)([\s\S]*?)(\n###|$)/,
                `$1 ${allStickerNames}$3`
            );


            const finalSystemPrompt = systemPrompt.replace(/\$\{ai_persona\}/g, `å§“å: ${contact.ai.name}\näººè®¾: ${contact.ai.persona}`).replace(/\$\{user_persona\}/g, `å§“å: ${contact.user.name}\näººè®¾: ${contact.user.persona}`).replace(/\$\{world_book_content\}/g, worldBookContent).replace(/\$\{time_info\}/g, timeInfo);
            const history = contact.history || [];
            const recentHistory = (contact.contextMemory || 10) > 0 ? history.slice(-(contact.contextMemory || 10)) : [];

            // 1. å¤åˆ¶ä¸€ä»½å½“å‰çš„ç³»ç»Ÿæç¤ºè¯
            let currentSystemPrompt = finalSystemPrompt;

            // 2. å¦‚æœå¼€å…³è¢«å…³é—­ï¼Œå¼ºè¡Œè¿½åŠ â€œç¦æ­¢åŠ¨ä½œâ€çš„æŒ‡ä»¤
            if (!isActionNarrationOn) {
                currentSystemPrompt += `
            
            ã€é‡è¦æŒ‡ä»¤ï¼šçº¯å¯¹è¯æ¨¡å¼ã€‘
            ç”¨æˆ·å¼ºåˆ¶å…³é—­äº†åŠ¨ä½œæ—ç™½åŠŸèƒ½ã€‚
            1. è¯·åŠ¡å¿…ä»…è¾“å‡ºã€çº¯ç²¹çš„å£è¯­å¯¹è¯ã€‘ã€‚
            2. **ä¸¥ç¦**ä½¿ç”¨ *åŠ¨ä½œ*ã€(æ‹¬å·) æˆ–ä»»ä½•å½¢å¼çš„å¿ƒç†æ´»åŠ¨ã€ç¯å¢ƒæå†™ã€‚
            3. ä¸è¦æå†™ä½ çš„ç¥æ€ï¼Œåªè¯´è¯ã€‚
            `;
            }


            // ============ è®°å¿†æ³¨å…¥ç³»ç»Ÿ ============
// åœ¨æ¯æ¬¡AIè°ƒç”¨æ—¶,è‡ªåŠ¨è¯»å–å¹¶æ³¨å…¥å·²å¯ç”¨çš„è®°å¿†
let memoryContext = '';
if (typeof window.getEnabledMemories === 'function') {
    try {
        const enabledMemories = await window.getEnabledMemories(contact.id);
        if (enabledMemories && enabledMemories.length > 0) {
            const memoryContents = enabledMemories.map((m, index) => {
                const content = m.editedContent || m.content;
                return `ã€è®°å¿† ${index + 1}ã€‘\n${content}`;
            }).join('\n\n');
            
            memoryContext = `\n\n### ğŸ§  é‡è¦è®°å¿† (Memory Context)\nä»¥ä¸‹æ˜¯ä½ ä¸ç”¨æˆ·ä¹‹é—´çš„é‡è¦è®°å¿†ç‰‡æ®µ,è¯·åœ¨å›å¤æ—¶å‚è€ƒè¿™äº›å†…å®¹,ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œä¸€è‡´æ€§:\n\n${memoryContents}\n\n---\n`;
        }
    } catch (error) {
        console.error('åŠ è½½è®°å¿†å¤±è´¥:', error);
    }
}

// å°†è®°å¿†æ³¨å…¥åˆ°system promptä¸­
currentSystemPrompt += memoryContext;
// ============ è®°å¿†æ³¨å…¥ç»“æŸ ============

// ============ åŒè¯­ç¿»è¯‘æ³¨å…¥ ============
if (currentOpenContact && currentOpenContact.enableBilingualBubble) {
    currentSystemPrompt += `

å¯¹è¯ç¿»è¯‘**æ–‡æœ¬**æ ¼å¼å¼ºåˆ¶è§„åˆ™
ä¸€ã€æ ¸å¿ƒæ ¼å¼è¦æ±‚ï¼ˆä¸¥ç¦è¿ä½“åº”ç­”ï¼‰
1. ç¿»è¯‘åˆ†éš”æ ‡è®°ï¼šè¾“å‡º**æ–‡æœ¬**ï¼ˆéè¯­éŸ³ï¼‰å†…å®¹åŒ…å«å¤–è¯­/æ–¹è¨€æ—¶ï¼Œæ¯å¥è¯æœ«å°¾å¿…é¡»ä½¿ç”¨ [Split] åˆ†éš”ç¬¦ï¼Œç´§éšå…¶åæ ‡æ³¨ä¸­æ–‡ç¿»è¯‘ã€‚
2. æ°”æ³¡å¼ºåˆ¶åˆ†éš”ï¼šã€é‡è¦ã€‘æ¯ä¸€ç»„ "åŸæ–‡[Split]è¯‘æ–‡" ç»“æŸåï¼Œå¿…é¡»å¼ºåˆ¶ä»¥ \\\\ (å³å•ä¸ªåæ–œæ ) ç»“å°¾ã€‚è¿™å†³å®šäº†æ°”æ³¡æ˜¯å¦èƒ½æ­£ç¡®åˆ†æ®µã€‚ä¸¥ç¦å°†å¤šç»„å¯¹è¯è¿åœ¨åŒä¸€è¡Œè¾“å‡ºï¼
3. åŠ¨ä½œæè¿°å¤„ç†ï¼šä»¥ * * åŒ…è£¹çš„åŠ¨ä½œæè¿°å†…å®¹ï¼Œæ— éœ€ç¿»è¯‘ï¼Œä¿ç•™åŸæ ·ã€‚
4. è¯­éŸ³æ¶ˆæ¯å¤„ç†ï¼šå¦‚æœå‘é€è¯­éŸ³ï¼Œå†…å®¹ä¹Ÿéœ€ç¿»è¯‘ã€‚æ ¼å¼ï¼š[æˆ‘å‘é€äº†è¯­éŸ³]ï¼šåŸæ–‡[Split]è¯‘æ–‡\\\\

äºŒã€æ­£ç¡®ç¤ºä¾‹ï¼ˆè¯·ä¸¥æ ¼æ¨¡ä»¿æ¢è¡Œå’Œåæ–œæ ï¼‰
Hello, world.[Split]ä½ å¥½ï¼Œä¸–ç•Œã€‚\\\\
How are you today?[Split]ä½ ä»Šå¤©å¥½å—ï¼Ÿ\\\\
[æˆ‘å‘é€äº†è¯­éŸ³]ï¼šI love you.[Split]æˆ‘çˆ±ä½ ã€‚\\\\

ä¸‰ã€é”™è¯¯è¡Œä¸ºè­¦ç¤ºï¼ˆç»å¯¹ç¦æ­¢ï¼‰
âŒ é”™è¯¯ï¼šHello.[Split]ä½ å¥½ã€‚How are you?[Split]ä½ å¥½å—ï¼Ÿ ï¼ˆä¸¤å¥è¯è¿åœ¨ä¸€èµ·ï¼Œå¯¼è‡´è§£æå¤±è´¥ï¼‰
âœ… æ­£ç¡®ï¼šHello.[Split]ä½ å¥½ã€‚\\\\
         How are you?[Split]ä½ å¥½å—ï¼Ÿ\\\\
ï¼ˆæ³¨æ„ï¼šå¿…é¡»æ˜¾å¼æ¢è¡Œï¼Œä¸”æ¯è¡Œæœ«å°¾å¿…é¡»æœ‰åæ–œæ  \\\\ ï¼ï¼‰

å››ã€ç‰¹æ®Šåœºæ™¯
1. çº¯ä¸­æ–‡å†…å®¹ï¼šæ— éœ€ [Split]ï¼Œä½†ä»å»ºè®®ä»¥ \\\\ ç»“å°¾ä»¥ç¡®ä¿åˆ†æ°”æ³¡ã€‚
2. æ–¹è¨€å†…å®¹ï¼šä½ é£Ÿå’—é¥­æœªï¼Ÿ[Split]ä½ åƒé¥­äº†å—ï¼Ÿ\\\\
`;
}
// ============ åŒè¯­ç¿»è¯‘æ³¨å…¥ç»“æŸ ============



            const messages = [{ role: "system", content: currentSystemPrompt }];
            recentHistory.forEach(msg => {
                const contentResult = translateMessageForAI(msg);

                if (contentResult) {
                    // 1. å¦‚æœæ˜¯ç‰¹æ®Šçš„å¤šæ¨¡æ€å¯¹è±¡ (æ–‡ä»¶/å›¾ç‰‡)
                    if (typeof contentResult === 'object' && contentResult.isMultimodal) {

                        // æ„å»ºç¬¦åˆ OpenAI/Gemini æ ‡å‡†çš„å¤šæ¨¡æ€ Payload
                        // æ³¨æ„ï¼šä¸åŒæ¨¡å‹å¯¹ text + file çš„ç»„åˆæ–¹å¼ç•¥æœ‰ä¸åŒï¼Œè¿™æ˜¯æœ€é€šç”¨çš„æ ¼å¼
                        const contentPayload = [
                            { type: "text", text: contentResult.text },
                            {
                                type: "image_url",
                                image_url: {
                                    "url": contentResult.fileUrl
                                }
                            }
                        ];

                        messages.push({
                            role: msg.sender === 'user' ? 'user' : 'assistant',
                            content: contentPayload
                        });
                    }
                    // 2. å¦‚æœæ˜¯æ™®é€šæ–‡æœ¬
                    else if (typeof contentResult === 'string') {
                        messages.push({
                            role: msg.sender === 'user' ? 'user' : 'assistant',
                            content: contentResult
                        });
                    }
                }
            });
            // ====== è¿™æ˜¯æ–°ä»£ç  (å¼€å§‹) ======

            // å®šä¹‰å‘é€ç»™ OpenAI çš„å†…å®¹å˜é‡
            let userContentPayload;

            // 1. æ£€æŸ¥æ˜¯å¦åŒ…å«å¼•ç”¨å›å¤ (replyTo)
            if (typeof triggerPayload === 'object' && triggerPayload.replyTo) {
                // æ„é€ å¼•ç”¨æç¤ºè¯­
                const replyContext = `ğŸ’¡[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·æ­£åœ¨å›å¤ "${triggerPayload.replyTo.senderName}" çš„æ¶ˆæ¯ï¼š"${triggerPayload.replyTo.text}"]\n\n`;

                // å¦‚æœæ˜¯å›¾æ–‡æ¶ˆæ¯ + å¼•ç”¨
                if (triggerPayload.imageUrl) {
                    userContentPayload = [
                        { type: "text", text: replyContext + (triggerPayload.text || "ï¼ˆç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ï¼‰") },
                        { type: "image_url", image_url: { "url": triggerPayload.imageUrl } }
                    ];
                }
                // å¦‚æœæ˜¯çº¯æ–‡æœ¬ + å¼•ç”¨
                else {
                    userContentPayload = replyContext + (triggerPayload.text || "");
                }
            }
            // 2. æ£€æŸ¥æ˜¯å¦æ˜¯æ™®é€šå›¾æ–‡æ¶ˆæ¯ (æ— å¼•ç”¨)
            else if (typeof triggerPayload === 'object' && triggerPayload.imageUrl) {
                userContentPayload = [
                    { type: "text", text: triggerPayload.text || "ï¼ˆç”¨æˆ·æ²¡æœ‰è¾“å…¥æ–‡å­—ï¼Œè¯·æè¿°è¿™å¼ å›¾ç‰‡ï¼‰" },
                    { type: "image_url", image_url: { "url": triggerPayload.imageUrl } }
                ];
            }
            // 3. æ™®é€šçº¯æ–‡æœ¬æ¶ˆæ¯
            else {
                // å¦‚æœ triggerPayload æ˜¯å¯¹è±¡ä½†æ²¡å‘½ä¸­ä¸Šé¢çš„æ¡ä»¶ï¼ˆä¾‹å¦‚ text-imageï¼‰ï¼Œå– .textï¼Œå¦åˆ™ç›´æ¥ç”¨å­—ç¬¦ä¸²
                userContentPayload = (typeof triggerPayload === 'object' && triggerPayload.text) ? triggerPayload.text : triggerPayload;
            }

            // å°†æœ€ç»ˆæ„å»ºå¥½çš„å†…å®¹æ¨å…¥ messages æ•°ç»„
            messages.push({ role: "user", content: userContentPayload });

            // ====== è¿™æ˜¯æ–°ä»£ç  (ç»“æŸ) ======
            // --- End of context building ---

            // --- CORE CHANGE: No more "tools" in the request ---
            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model,
                    messages,
                    temperature: parseFloat(temperature) || 1.0,
                    // NO "tools" or "tool_choice" parameters
                })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            const data = await response.json();

            // --- CORE CHANGE: We now expect a plain text "content" field ---
            // æ·»åŠ é˜²å¾¡æ€§æ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´
            if (!data || !data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
                console.error("APIè¿”å›æ•°æ®å¼‚å¸¸:", data);
                throw new Error("APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ choices æ•°ç»„");
            }
            
            if (!data.choices[0].message || typeof data.choices[0].message.content === 'undefined') {
                console.error("APIè¿”å›çš„æ¶ˆæ¯æ ¼å¼å¼‚å¸¸:", data.choices[0]);
                throw new Error("APIè¿”å›çš„æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ message.content å­—æ®µ");
            }
            
            const aiResponseText = data.choices[0].message.content;
            console.log('ã€AI åŸå§‹çº¯æ–‡æœ¬å›å¤ã€‘:', aiResponseText);

            // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢çš„æ–°ä»£ç  â–¼â–¼â–¼
            // --- Start: Mark image as processed after AI response ---
            if (typeof triggerPayload === 'object' && triggerPayload.imageUrl) {
                // åœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°è¿™å¼ å›¾ç‰‡å¯¹åº”çš„æ¶ˆæ¯
                const imageMessageIndex = currentOpenContact.history.findIndex(msg => msg.url === triggerPayload.imageUrl);
                if (imageMessageIndex > -1) {
                    // ç»™å®ƒæ·»åŠ ä¸€ä¸ª processed æ ‡è®°
                    currentOpenContact.history[imageMessageIndex].processed = true;
                    // ç«‹åˆ»ä¿å­˜å›æ•°æ®åº“ï¼Œç¡®ä¿æ ‡è®°è¢«æŒä¹…åŒ–
                    await saveCurrentContactToDatabase();
                    console.log(`å›¾ç‰‡ ${triggerPayload.imageUrl} å·²è¢«æ ‡è®°ä¸ºâ€œå·²å¤„ç†â€ã€‚`);
                }
            }
            // --- End: Marking logic ---
            // â–²â–²â–² ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

            if (aiResponseText) {
                // Call the new execution function
                return await executePlainTextResponse(aiResponseText, contact, initialTypingIndicator, contextData);
            } else {
                if (initialTypingIndicator) initialTypingIndicator.remove();
            }

        } catch (error) {
            console.error("è°ƒç”¨AIå¤±è´¥:", error);
            if (initialTypingIndicator) initialTypingIndicator.remove();
            alert(`AIå›å¤å¤±è´¥: ${error.message}`);
        } finally {
            isAiReplying = false;
        }
    }


    // ===================================
    // NEW EXECUTION FUNCTION (Plain Text + Regex Version)
    // ===================================
    // 

    async function executePlainTextResponse(responseText, contact, initialIndicator, contextData = {}) {
        // è·å–å½“å‰ä¸Šä¸‹æ–‡çš„å®Œæ•´è¡¨æƒ…åŒ… Map
        const currentStickerMap = await getAllAvailableStickersMap(contact);

        let contactUpdated = false;

        // --- çŠ¶æ€ä¸å†…å¿ƒç‹¬ç™½è§£æé€»è¾‘ (åŠŸèƒ½ä¿æŒå®Œæ•´) ---
        const statusRegex = /(?:^|\n)\s*çŠ¶æ€[:ï¼š](.*)/;
        const monologueRegex = /(?:^|\n)\s*å†…å¿ƒç‹¬ç™½[:ï¼š](.*)/;
        const statusMatch = responseText.match(statusRegex);
        const monologueMatch = responseText.match(monologueRegex);
       if (statusMatch) {
        contact.ai.lastStatus = statusMatch[1].trim();
        responseText = responseText.replace(statusRegex, ''); 
        contactUpdated = true;
    }

    if (monologueMatch) {
        contact.ai.lastMonologue = monologueMatch[1].trim();
        responseText = responseText.replace(monologueRegex, '');
        contactUpdated = true;
    }

    if (contactUpdated) {
        saveCurrentContactToDatabase();
    }
    updateThoughtBubbleContent();

        const HISTORY_PLACEHOLDER = "|||CHAT_HISTORY_CARD_BLOCK|||"; // å®šä¹‰ä¸€ä¸ªç‹¬ç‰¹çš„å ä½ç¬¦
        let preservedHistoryBlock = null;

        // æ­£åˆ™è¯´æ˜ï¼šåŒ¹é… [CHAT_HISTORY_START] åˆ° [CHAT_HISTORY_END] ä¹‹é—´çš„æ‰€æœ‰å†…å®¹
        // [\s\S]*? è¡¨ç¤ºåŒ¹é…ä»»æ„å­—ç¬¦ï¼ˆåŒ…æ‹¬æ¢è¡Œç¬¦ï¼‰
        const historyRegex = /(\[CHAT_HISTORY_START\][\s\S]*?\[CHAT_HISTORY_END\])/;
        const historyMatch = responseText.match(historyRegex);

        if (historyMatch) {
            preservedHistoryBlock = historyMatch[1]; // æŠŠå®Œæ•´çš„å¡ç‰‡å†…å®¹å…ˆå­˜èµ·æ¥
            // å°†åŸæ–‡ä¸­çš„å¡ç‰‡æ›¿æ¢æˆå ä½ç¬¦ï¼ˆå ä½ç¬¦æ˜¯ä¸€è¡Œå­—ï¼Œä¸ä¼šè¢« split åˆ‡ç¢ï¼‰
            responseText = responseText.replace(historyRegex, HISTORY_PLACEHOLDER);
        }

        // --- HTMLå—è§£æé€»è¾‘ (å¢å¼ºç‰ˆï¼šæ”¯æŒå¤šç§æ ¼å¼ï¼Œä¸”æ”¯æŒä¸å…¶ä»–æ¶ˆæ¯æ··åˆ) ---
        // æ ¼å¼1: æ ‡å‡†æ ¼å¼ - å‘é€HTMLï¼š```html\n...\n```
        // æ ¼å¼2: æ— ä»£ç å—æ ¼å¼ - å‘é€HTMLï¼š<!DOCTYPE html>...</html> æˆ– å‘é€HTMLï¼š<html>...</html>
        // æ ¼å¼3: ç›´æ¥HTMLæ ¼å¼ - <!DOCTYPE html>...</html> æˆ– <html>...</html>
        const HTML_PLACEHOLDER = "|||HTML_CONTENT_BLOCK|||";
        let preservedHtmlContent = null;
        let htmlMatchedPattern = null;
        
        // å°è¯•åŒ¹é…æ ¼å¼1: æ ‡å‡†ä»£ç å—æ ¼å¼
        const htmlBlockPattern1 = /å‘é€HTMLï¼š\s*```html\n([\s\S]*?)\n```/s;
        const htmlMatch1 = responseText.match(htmlBlockPattern1);
        if (htmlMatch1) {
            preservedHtmlContent = htmlMatch1[1].trim();
            htmlMatchedPattern = htmlBlockPattern1;
        }
        
        // å°è¯•åŒ¹é…æ ¼å¼2: å‘é€HTMLï¼šåç›´æ¥è·ŸHTMLä»£ç ï¼ˆæ— ä»£ç å—ï¼‰
        if (!preservedHtmlContent) {
            const htmlBlockPattern2 = /å‘é€HTMLï¼š\s*((?:<!DOCTYPE\s+html>|<html[\s>])[\s\S]*?<\/html>)/si;
            const htmlMatch2 = responseText.match(htmlBlockPattern2);
            if (htmlMatch2) {
                preservedHtmlContent = htmlMatch2[1].trim();
                htmlMatchedPattern = htmlBlockPattern2;
            }
        }
        
        // å°è¯•åŒ¹é…æ ¼å¼3: æ–‡æœ¬ä¸­åŒ…å«HTMLä»£ç ï¼ˆæ— å‰ç¼€ï¼‰
        if (!preservedHtmlContent) {
            // æ£€æµ‹å“åº”ä¸­æ˜¯å¦åŒ…å«å®Œæ•´çš„HTMLæ–‡æ¡£ï¼ˆå¯èƒ½æ··åˆåœ¨å…¶ä»–æ–‡æœ¬ä¸­ï¼‰
            const htmlInTextPattern = /(<!DOCTYPE\s+html>[\s\S]*?<\/html>|<html[\s>][\s\S]*?<\/html>)/si;
            const htmlInTextMatch = responseText.match(htmlInTextPattern);
            if (htmlInTextMatch) {
                preservedHtmlContent = htmlInTextMatch[1].trim();
                // ç”¨å ä½ç¬¦æ›¿æ¢HTMLéƒ¨åˆ†
                responseText = responseText.replace(htmlInTextPattern, HTML_PLACEHOLDER);
            }
        }
        
        // å¦‚æœåŒ¹é…åˆ°HTMLï¼ˆæ ¼å¼1æˆ–æ ¼å¼2ï¼Œå¸¦å‰ç¼€çš„ï¼‰ï¼Œç”¨å ä½ç¬¦æ›¿æ¢
        if (preservedHtmlContent && htmlMatchedPattern) {
            responseText = responseText.replace(htmlMatchedPattern, HTML_PLACEHOLDER);
        }
        // 3. ä¿æŠ¤ã€AIæ¨¡æ‹Ÿæ–‡ä»¶ã€‘(è§£å†³å›¾3æ–­è¡Œé—®é¢˜)
        // é€»è¾‘ï¼šåŒ¹é… "å‘é€æ–‡ä»¶ï¼š... å†…å®¹ï¼š" å¼€å§‹ï¼Œç›´åˆ°æ–‡æœ¬ç»“æŸ(å› ä¸ºçŠ¶æ€/ç‹¬ç™½å·²ç»è¢«ç§»é™¤äº†)
        const AI_FILE_PLACEHOLDER = "|||AI_FILE_BLOCK|||";
        let preservedAiFile = null;
        // è¿™ä¸ªæ­£åˆ™éå¸¸è´ªå©ªï¼Œå®ƒä¼šåƒæ‰ä»"å‘é€æ–‡ä»¶"å¼€å§‹çš„æ‰€æœ‰å‰©ä½™æ–‡æœ¬
        // ä¿®æ”¹åï¼šå»æ‰æœ€å¤–å±‚æ‹¬å·ï¼Œåªä¿ç•™ä¸¤ä¸ªæ•è·ç»„ï¼šç±»å‹(index 1) å’Œ å†…å®¹(index 2)
        const aiFileDeepRegex = /å‘é€æ–‡ä»¶ï¼š([A-Za-z0-9]+)\s+å†…å®¹ï¼š([\s\S]+)/;
        const aiFileDeepMatch = responseText.match(aiFileDeepRegex);

        if (aiFileDeepMatch) {
            preservedAiFile = {
                fullText: aiFileDeepMatch[0],
                type: aiFileDeepMatch[1],     // ä¿®æ”¹ï¼šæ”¹ä¸ºä¸‹æ ‡ 1
                content: aiFileDeepMatch[2]   // ä¿®æ”¹ï¼šæ”¹ä¸ºä¸‹æ ‡ 2
            };
            // æ›¿æ¢ä¸ºå ä½ç¬¦...
            responseText = responseText.replace(aiFileDeepRegex, AI_FILE_PLACEHOLDER);
        }
        // --- å¤šæŒ‡ä»¤è§£æé€»è¾‘ ---
        const commands = responseText.split('\n').filter(line => line.trim() !== '');
        // â–¼â–¼â–¼ START: åœ¨è¿™é‡Œç²˜è´´æ–°çš„ä»£ç  â–¼â–¼â–¼
        // Add this block right before the `for (const command of commands)` loop.

        // If this is a blocking action, store the entire raw response and stop.
        if (contextData.isBlockingAction) {
            console.log("Blocking action detected. Storing AI response silently.");
            if (!Array.isArray(contact.hiddenMessagesOnBlock)) {
                contact.hiddenMessagesOnBlock = [];
            }
            // We store the raw commands to be processed later.
            contact.hiddenMessagesOnBlock.push({ rawResponse: responseText });
            await saveCurrentContactToDatabase();
            if (initialIndicator) initialIndicator.remove(); // Clean up the "typing..." bubble
            return; // IMPORTANT: Stop further execution.
        }

        // If we are unblocking, we need to process the raw response.
        if (contextData.isUnblockingAction && contextData.rawResponse) {
            // This logic will now be handled inside the unblock button's event listener.
            // We can simplify this part. We will process the messages when unblocking.
        }
        // â–²â–²â–² ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
        let typingRowForTransform = initialIndicator;

        for (const command of commands) {
            let messageObject = null; // é¢„æ„å»ºæ¶ˆæ¯å¯¹è±¡
            // â–¼â–¼â–¼â–¼â–¼â–¼ ã€æ–°å¢ã€‘åœ¨å¾ªç¯ä¸€å¼€å§‹ï¼Œå…ˆè¿˜åŸå ä½ç¬¦ â–¼â–¼â–¼â–¼â–¼â–¼
            let currentCommandText = command;
            // å¦‚æœè¿™ä¸€è¡Œæ˜¯æˆ‘ä»¬çš„å ä½ç¬¦ï¼Œå°±æŠŠå®ƒå˜å›åŸæ¥çš„å®Œæ•´å¡ç‰‡å†…å®¹
            if (command.includes(HISTORY_PLACEHOLDER) && preservedHistoryBlock) {
                currentCommandText = preservedHistoryBlock;
            }
            
            // å¦‚æœè¿™ä¸€è¡Œæ˜¯HTMLå ä½ç¬¦ï¼Œåˆ›å»ºå¹¶å‘é€HTMLæ¶ˆæ¯
            if (command.includes(HTML_PLACEHOLDER) && preservedHtmlContent) {
                const htmlMessage = {
                    sender: 'ai', type: 'html',
                    content: { html: preservedHtmlContent, css: '', js: '' },
                    timestamp: new Date(),
                    uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                };
                if (typingRowForTransform) {
                    typingRowForTransform.remove();
                    typingRowForTransform = null;
                }
                await saveMessageToHistory(htmlMessage, contact.id);
                addMessageToView(htmlMessage, contact);
                continue; // å¤„ç†å®ŒHTMLåç»§ç»­å¤„ç†ä¸‹ä¸€æ¡æŒ‡ä»¤
            }
            // â–²â–²â–²â–²â–²â–² è¿˜åŸé€»è¾‘ç»“æŸ â–²â–²â–²â–²â–²â–²

            // ã€å¢å¼ºå®¹é”™ã€‘è¯­éŸ³å’Œè¡¨æƒ…åŒ…æ­£åˆ™ - æ”¯æŒæ¢è¡Œç¬¦ã€å¤šä½™ç©ºæ ¼ã€å†’å·ä½ç½®é—®é¢˜ã€æ‹¬å·ä¸å®Œæ•´ç­‰
            // åŒ¹é…æ ¼å¼ï¼š[æˆ‘å‘é€äº†è¯­éŸ³]ï¼šxxx / [æˆ‘å·²å‘é€è¡¨æƒ…åŒ…ï¼šxxx] / [æˆ‘å‘é€\näº†è¯­éŸ³]ï¼šxxx ç­‰
            const voicePattern = /\[?æˆ‘?(?:å·²|å‘é€)?(?:å‘é€)?[\s\n]*äº†?[\s\n]*è¯­éŸ³\]?\s*[:ï¼š]\s*(?:\[\s*)?(.*?)(?:\s*\])?(?:\s*\[split\]|$)/i;
            const stickerPattern = /\[?æˆ‘?(?:å·²|å‘é€)?(?:å‘é€)?[\s\n]*äº†?[\s\n]*è¡¨æƒ…åŒ…\]?\s*[:ï¼š]?\s*\[?([^\]\n]+)\]?/i;
            const transferPattern = /(?:^|\[|\s)è½¬è´¦[:ï¼š]\s*([\d.]+)\s*-\s*([^\]\n\\]+)/;
            const acceptListenPattern = /^æ¥å—ä¸€èµ·å¬ï¼š(.+)/;
            const callPattern = /^å‘èµ·é€šè¯ï¼š(.+)/;
            const postPattern = /^å‘æœ‹å‹åœˆï¼š(.+?)(?:\[å›¾ç‰‡æè¿°ï¼š(.+?)\])?$/;
            const commentPattern = /^è¯„è®ºæœ‹å‹åœˆï¼š(.+)/;
            const textImagePattern = /^æ–‡å›¾ï¼š(.+)/;
            const replyPattern = /^å¼•ç”¨å›å¤ï¼š(.+?)[:ï¼š](.+?)\s*\|\|\|\s*(.+)/;
            const actionPattern = /(?:^|[(\uff08])\s*(?:æˆ‘æ‰§è¡Œäº†)?(?:åŠ¨ä½œ|æ—ç™½)(?:\/æ—ç™½)?\s*[:ï¼š]\s*(.*?)(?:[)\uff09]|$)/;
            const filePattern = /^å‘é€æ–‡ä»¶ï¼š\[(.*?)\]\((.*?)\)/;
            const aiFilePattern = /^å‘é€æ–‡ä»¶ï¼š([A-Za-z0-9]+)\s+å†…å®¹ï¼š([\s\S]+)/;
            const statusRegex = /\[è½¬è´¦çŠ¶æ€[:ï¼š]\s*(æ¥æ”¶|é€€å›)\]/;

            const voiceMatch = currentCommandText.match(voicePattern);
            const stickerMatch = currentCommandText.match(stickerPattern);
            const transferMatch = currentCommandText.match(transferPattern);
            const acceptListenMatch = currentCommandText.match(acceptListenPattern);
            const callMatch = currentCommandText.match(callPattern);
            const postMatch = currentCommandText.match(postPattern);
            const commentMatch = currentCommandText.match(commentPattern);
            const textImageMatch = currentCommandText.match(textImagePattern);
            const replyMatch = currentCommandText.match(replyPattern);
            const actionMatch = currentCommandText.match(actionPattern);
            const fileMatch = currentCommandText.match(filePattern);
            const aiFileMatch = currentCommandText.match(aiFilePattern);
            const transferStatusUpdateMatch = currentCommandText.match(statusRegex);
            if (transferMatch) {
    // 1. AI å‘èµ·è½¬è´¦
    const amount = parseFloat(transferMatch[1]).toFixed(2);
    const remark = transferMatch[2].replace(/\\+$/, '').trim();
    
    // ç”Ÿæˆ UUID
    const msgUuid = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    messageObject = {
        sender: 'ai',
        type: 'html', // ä½¿ç”¨ HTML ç±»å‹
        // è°ƒç”¨æˆ‘ä»¬åˆšæ‰å†™çš„ç”Ÿæˆå‡½æ•°ï¼ŒisUserSender = false
        content: { 
            html: createTransferCardHtml(amount, remark, msgUuid, false, 'pending')
        },
        text: `[è½¬è´¦ ï¿¥${amount}]` // å†å²è®°å½•ç®€ç•¥æ˜¾ç¤º
    };
} 
else if (transferStatusUpdateMatch) {
    // 1. è·å–åŠ¨ä½œ (æ¥æ”¶/é€€å›)
    const actionCN = transferStatusUpdateMatch[1];
    const actionKey = (actionCN === 'æ¥æ”¶') ? 'accepted' : 'refused';
    
    // 2. æŸ¥æ‰¾ç•Œé¢ä¸Šæœ€è¿‘çš„ä¸€ä¸ªå¾…å¤„ç†è½¬è´¦ (User å‘çš„)
    // æ³¨æ„ï¼šAI å›å¤çš„æ˜¯ User å‘çš„è½¬è´¦ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰¾ .message-row.is-user ä¸‹é¢çš„ .status-pending
    // æˆ–è€…ç®€å•ç‚¹ï¼Œæ‰¾æ‰€æœ‰ status-pending çš„å¡ç‰‡ï¼ˆå€’åºæ‰¾ï¼‰
    const pendingCards = document.querySelectorAll('.transfer-card.status-pending');
    let targetCard = null;
    
    // æˆ‘ä»¬å‡è®¾ AI å›å¤çš„æ˜¯æœ€è¿‘çš„ä¸€æ¡è½¬è´¦
    if (pendingCards.length > 0) {
        targetCard = pendingCards[pendingCards.length - 1];
    }

    if (targetCard) {
        const uuid = targetCard.dataset.uuid;

        // 3. æ›´æ–° UI
        targetCard.classList.remove('status-pending', 'status-selecting');
        targetCard.classList.add(`status-${actionKey}`);
        const statusTextDiv = targetCard.querySelector('.transfer-status-text');
        if (statusTextDiv) statusTextDiv.textContent = (actionKey === 'accepted') ? "å·²æ”¶æ¬¾" : "å·²é€€å›";
        targetCard.removeAttribute('onclick'); // é”æ­»

        // 4. â˜…â˜…â˜… æ›´æ–°æ•°æ®åº“ (å…³é”®) â˜…â˜…â˜…
        // å¤ç”¨æˆ‘ä»¬åˆšæ‰å†™çš„ handleTransferAction é‡Œçš„ä¿å­˜é€»è¾‘ï¼Œä½†è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨æ•°æ®åº“æ“ä½œ
        // å› ä¸º handleTransferAction éœ€è¦ event å¯¹è±¡ï¼Œè¿™é‡Œæ˜¯åœ¨ä»£ç é‡Œè‡ªåŠ¨æ‰§è¡Œçš„
        if (typeof dbHelper !== 'undefined' && currentOpenContact) {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            let contacts = contactsData.value || [];
            const contactIdx = contacts.findIndex(c => c.id === currentOpenContact.id);
            
            if (contactIdx > -1) {
                const msg = contacts[contactIdx].history.find(m => m.uuid === uuid);
                if (msg) {
                    msg.transferStatus = actionKey; // å†™å…¥çŠ¶æ€
                    await dbHelper.saveData('messageContacts', 'allContacts', contacts);
                    console.log(`AIè‡ªåŠ¨æ“ä½œï¼šè½¬è´¦ ${uuid} å·²æ›´æ–°ä¸º ${actionKey}`);
                    
                    // åŒæ­¥å†…å­˜
                    currentOpenContact.history = contacts[contactIdx].history;
                }
            }
        }
    }
    
    // ç§»é™¤æŒ‡ä»¤æ–‡æœ¬ï¼Œä¸æ˜¾ç¤ºåœ¨æ°”æ³¡é‡Œ
    currentCommandText = currentCommandText.replace(statusRegex, '').trim();
    if (!currentCommandText) continue;
}

   


            // --- é€»è¾‘åˆ†æ”¯å¼€å§‹ ---

            if (currentCommandText === preservedHistoryBlock) {
                // å¦‚æœæ˜¯è¿˜åŸå›æ¥çš„å¡ç‰‡ï¼Œç›´æ¥ä½œä¸ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯å¤„ç†
                // addMessageToView å†…éƒ¨æœ‰æ­£åˆ™ä¼šè¯†åˆ«å®ƒå¹¶æ¸²æŸ“æˆå¡ç‰‡
                messageObject = { sender: 'ai', text: currentCommandText };
            }
            else if (currentCommandText.includes(AI_FILE_PLACEHOLDER) && preservedAiFile) {
                // 1. æ‹¦æˆªåˆ°äº†å ä½ç¬¦ï¼Œå¼€å§‹è¿˜åŸæ–‡ä»¶å¡ç‰‡æ•°æ®
                const fileType = preservedAiFile.type.toUpperCase();
                // ä¿®æ”¹åï¼šä½¿ç”¨ ?. (å¯é€‰é“¾) å’Œ || '' (ç©ºå­—ç¬¦ä¸²å…œåº•)
                // æ„æ€å°±æ˜¯ï¼šå¦‚æœ content å­˜åœ¨ï¼Œå°±å»ç©ºæ ¼ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œå°±å½“æˆç©ºå­—ç¬¦ä¸²å¤„ç†ï¼Œä¸è¦æŠ¥é”™ã€‚
                const content = (preservedAiFile.content || "").trim();
                let extractedName = "æœªå‘½åæ–‡æ¡£"; // é»˜è®¤å…œåº•

                // 1. è·å–å†…å®¹çš„ç¬¬ä¸€è¡Œ
                const firstLine = content.split('\n')[0].trim();

                // 2. å¦‚æœç¬¬ä¸€è¡Œå­˜åœ¨ï¼Œå°±å¤„ç†å®ƒ
                if (firstLine) {
                    // å»æ‰ Markdown çš„åŠ ç²—ç¬¦å· (**) å’Œæ ‡é¢˜ç¬¦å· (#)
                    let cleanName = firstLine.replace(/\*\*/g, '').replace(/#/g, '').trim();

                    // 3. ç®€å•è¿‡æ»¤ï¼šå¦‚æœåå­—å¤ªé•¿ï¼ˆè¶…è¿‡20å­—ï¼‰ï¼Œå°±æˆªæ–­ï¼Œé˜²æ­¢æ ·å¼å´©å
                    if (cleanName.length > 20) {
                        cleanName = cleanName.substring(0, 20) + "...";
                    }

                    // èµ‹å€¼ç»™ extractedName
                    if (cleanName) {
                        extractedName = cleanName;
                    }
                }

                // 2. ä¼°ç®—æ–‡ä»¶å¤§å° (ç®€å•ç®—æ³•ï¼šå­—ç¬¦æ•° * 2 å­—èŠ‚)
                const formatFileSize = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                };

                // 3. æ„å»ºæ¶ˆæ¯å¯¹è±¡ (type: 'file_card')
                messageObject = {
                    sender: 'ai',
                    type: 'file_card',
                    isSimulated: true, // æ ‡è®°ä¸ºAIç”Ÿæˆçš„æ¨¡æ‹Ÿæ–‡ä»¶
                    fileName: `${extractedName}.${fileType.toLowerCase()}`,
                    fileSize: formatFileSize(content.length * 2),
                    fileType: fileType.toLowerCase(),
                    fileContent: content, // æ ¸å¿ƒï¼šæŠŠä¿å­˜çš„å†…å®¹æ”¾è¿›å»
                    text: `[å‘é€äº†æ–‡ä»¶ï¼š${fileType}æ–‡æ¡£]` // è¿™æ˜¯ç»™å†å²è®°å½•é¢„è§ˆçœ‹çš„
                };
            }
            else if (voiceMatch) {
                // 1. è·å–åŸå§‹å†…å®¹
                let rawTranscript = voiceMatch[1].trim().replace(/\\+$/, '');
                
                // 2. [æ ¸å¿ƒä¿®å¤] å¦‚æœåŒ…å« [Split]ï¼Œåªæå–åŸæ–‡éƒ¨åˆ†ç»™è¯­éŸ³å¼•æ“
                // è¿™æ ·èƒ½é˜²æ­¢ TTS æŠŠ "Split" å’Œä¸­æ–‡ç¿»è¯‘ä¹Ÿè¯»å‡ºæ¥ï¼Œè§£å†³å‰²è£‚æ„Ÿ
                if (rawTranscript.includes('[Split]')) {
                    rawTranscript = rawTranscript.split('[Split]')[0].trim();
                }

                const transcript = rawTranscript;
                const duration = Math.max(1, Math.ceil(transcript.length / 3));
                messageObject = { sender: 'ai', type: 'voice_text', transcript: transcript, duration: duration, text: `[è¯­éŸ³æ¶ˆæ¯ ${duration}s]` };
            } else if (stickerMatch) {
                const stickerDesc = stickerMatch[1].trim();
                const stickerUrl = currentStickerMap.get(stickerDesc);
                if (stickerUrl) {
                    messageObject = { sender: 'ai', type: 'sticker', url: stickerUrl, text: `[è¡¨æƒ…åŒ…ï¼š${stickerDesc}]` };
                } else { console.warn(`AIå°è¯•å‘é€ä¸€ä¸ªä¸å­˜åœ¨çš„è¡¨æƒ…åŒ…: ${stickerDesc}`); continue; }
            } else if (transferMatch) {
    // 1. æå–é‡‘é¢å’Œå¤‡æ³¨
    const amount = transferMatch[1].trim();
    const remark = transferMatch[2].trim();
    
    // 2. ç”Ÿæˆå”¯ä¸€ UUID
    const uuid = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘æ”¹ä¸ºå‘é€ type: 'text'
    // æˆ‘ä»¬ä¸å†ç”Ÿæˆ HTML å¯¹è±¡ï¼Œè€Œæ˜¯ç”Ÿæˆç¬¦åˆ System Prompt æ ¼å¼çš„çº¯æ–‡æœ¬
    // è¿™æ · addMessageToView ä¼šåƒå¤„ç†ç”¨æˆ·æ¶ˆæ¯ä¸€æ ·å¤„ç†å®ƒï¼ˆæ­£åˆ™åŒ¹é… -> æ¸²æŸ“ä¸ºåŸç”Ÿ DIVï¼‰
    messageObject = {
        sender: 'ai',
        type: 'text', // å…³é”®ï¼šæ”¹å› text
        text: `è½¬è´¦ï¼š${amount}-${remark}`, // å…³é”®ï¼šæ ‡å‡†æ ¼å¼
        uuid: uuid,
        transferStatus: 'pending' // æ•°æ®åº“å­—æ®µ
    };
    
    // 4. ä¸éœ€è¦ continueï¼Œè®©å®ƒè‡ªç„¶æµè½¬åˆ°ä¸‹æ–¹çš„ä¿å­˜å’Œæ¸²æŸ“é€»è¾‘
} else if (textImageMatch) {
                messageObject = { sender: 'ai', type: 'text-image', text: textImageMatch[1].trim() };
            }


            else if (fileMatch) {
                const fileName = fileMatch[1];
                const fileUrl = fileMatch[2];
                const extension = fileName.split('.').pop().toLowerCase();

                // æ„å»ºæ–‡ä»¶æ¶ˆæ¯å¯¹è±¡
                messageObject = {
                    sender: 'ai',
                    type: 'file_card',
                    fileName: fileName,
                    fileSize: 'ä¸ƒèŠ', // AIç”Ÿæˆçš„æ–‡ä»¶é€šå¸¸æ²¡æœ‰å¤§å°ä¿¡æ¯
                    fileType: extension,
                    fileUrl: fileUrl, // è¿™é‡Œå¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL æˆ– Base64
                    text: `[å‘é€äº†æ–‡ä»¶ï¼š${fileName}]`
                };
            }


            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘å¤„ç†å¼•ç”¨å›å¤ â–¼â–¼â–¼
            else if (replyMatch) {
                // 1. æå– AI è¾“å‡ºçš„æ–‡æœ¬ä¿¡æ¯
                const quotedName = replyMatch[1].trim();
                const quotedText = replyMatch[2].trim();
                const replyContent = replyMatch[3].trim();

                // 2. å°è¯•åœ¨å½“å‰å†å²è®°å½•ä¸­æ‰¾åˆ°è¿™æ¡è¢«å¼•ç”¨çš„åŸæ¶ˆæ¯
                // æˆ‘ä»¬éœ€è¦æŸ¥æ‰¾ï¼šå‘é€è€…åå­—åŒ¹é… ä¸” å†…å®¹åŒ…å«å¼•ç”¨æ–‡æœ¬ çš„æ¶ˆæ¯
                // æ³¨æ„ï¼šä¸ºäº†æé«˜å®¹é”™ç‡ï¼Œæˆ‘ä»¬åªæ£€æŸ¥å†…å®¹æ˜¯å¦â€œåŒ…å«â€å¼•ç”¨çš„æ–‡æœ¬ï¼Œé˜²æ­¢ AI ç¨å¾®æ”¹äº†ä¸€ä¸¤ä¸ªæ ‡ç‚¹
                let foundUuid = null;

                // ç¡®å®šæœç´¢èŒƒå›´ (å•èŠæˆ–ç¾¤èŠ)
                const searchHistory = currentOpenGroup ? currentOpenGroup.history : (currentOpenContact ? currentOpenContact.history : []);

                if (searchHistory && searchHistory.length > 0) {
                    // ä»åå¾€å‰æ‰¾ï¼Œæ›´æœ‰å¯èƒ½å¼•ç”¨çš„æ˜¯æœ€è¿‘çš„æ¶ˆæ¯
                    for (let i = searchHistory.length - 1; i >= 0; i--) {
                        const msg = searchHistory[i];

                        // è·å–æ¶ˆæ¯çš„çº¯æ–‡æœ¬å†…å®¹ç”¨äºæ¯”å¯¹
                        const rawMsgText = msg.text || (msg.transcript) || "";

                        // åˆ¤æ–­åå­—ï¼š
                        // å•èŠï¼šuseråå­— vs quotedName æˆ– AIåå­— vs quotedName
                        // ç¾¤èŠï¼šsenderName vs quotedName
                        let isNameMatch = false;
                        if (msg.sender === 'user') {
                            const userName = currentOpenGroup ? (currentOpenGroup.userCardName || "æˆ‘") : currentOpenContact.user.name;
                            isNameMatch = (userName === quotedName) || (quotedName === "æˆ‘"); // AIæœ‰æ—¶å€™ä¼šè¯´ "å¼•ç”¨å›å¤ï¼šæˆ‘ï¼š..."
                        } else {
                            const aiName = currentOpenGroup ? (msg.senderName || "ç¾¤å‹") : currentOpenContact.ai.name;
                            isNameMatch = (aiName === quotedName);
                        }

                        // åˆ¤æ–­å†…å®¹ (åªè¦åŒ…å«å³å¯ï¼Œæå‡å‘½ä¸­ç‡)
                        if (isNameMatch && rawMsgText.includes(quotedText)) {
                            foundUuid = msg.uuid;
                            break; // æ‰¾åˆ°äº†å°±åœæ­¢
                        }
                    }
                }

                // 3. æ„å»ºæ¶ˆæ¯å¯¹è±¡
                messageObject = {
                    sender: 'ai',
                    text: replyContent,
                    replyTo: {
                        senderName: quotedName,
                        text: quotedText,
                        uuid: foundUuid // â˜… è¿™é‡Œå¡«å…¥æ‰¾åˆ°çš„çœŸå® UUIDï¼Œè·³è½¬åŠŸèƒ½å°±èƒ½ç”¨äº†ï¼
                    }
                };

            } else if (acceptListenMatch) {
                if (typingRowForTransform) { typingRowForTransform.remove(); typingRowForTransform = null; }
                const acceptMessage = acceptListenMatch[1].trim();
                if (sharedListeningState.active === false) {
                    sharedListeningState.active = true;
                    sharedListeningState.contact = currentOpenContact;
                    await showSystemNotification(`${currentOpenContact.ai.name} åŠ å…¥äº†ä¸€èµ·å¬`, currentOpenContact.id);
                    updateSharedListeningUI();
                }
                const messages = acceptMessage.split(/\\|\\/g).map(m => m.trim()).filter(m => m);
                for (const text of messages) {
                    const aiMessage = { sender: 'ai', text, timestamp: new Date(), uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9) };
                    await saveMessageToHistory(aiMessage, contact.id); // å…ˆä¿å­˜
                    addMessageToView(aiMessage, contact); // åæ¸²æŸ“
                }
                continue;
            } else if (callMatch) {
                if (typingRowForTransform) { typingRowForTransform.remove(); typingRowForTransform = null; }
                const reason = callMatch[1].trim();
                if (currentOpenContact && currentOpenContact.id === contact.id) {
                    showIncomingCallScreen(reason);
                }
                continue;
            } else if (postMatch) {
                if (typingRowForTransform) { typingRowForTransform.remove(); typingRowForTransform = null; }
                const postText = postMatch[1].trim();
                const imageDesc = postMatch[2] ? postMatch[2].trim() : null;
                await createAiPost(contact, postText, imageDesc);
                renderAllPosts();
                continue;
            } else if (commentMatch) {
                if (typingRowForTransform) { typingRowForTransform.remove(); typingRowForTransform = null; }
                const postIdForComment = contextData.postId;
                const commentText = commentMatch[1].trim();
                if (postIdForComment && commentText) {
                    await addComment(postIdForComment, commentText, null, contact);
                    renderAllPosts();
                } else { console.error("AIå°è¯•è¯„è®ºå¤±è´¥ï¼šç¼ºå°‘postIdæˆ–è¯„è®ºæ–‡æœ¬ã€‚"); }
                continue;
            } else {
                // ============================================================
                // â–¼â–¼â–¼ ã€ç»ˆæä¿®å¤ã€‘åŠ¨ä½œåˆ‡åˆ† + å¯¹è¯åˆ†å¥é€»è¾‘ â–¼â–¼â–¼
                // ============================================================

                // 1. ã€æ ¼å¼æ¸…æ´—ã€‘(ä¿æŒä¸å˜ï¼Œå…¼å®¹å„ç§å¥‡æ€ªæ ¼å¼)
                let processedText = currentCommandText.replace(
                    /(?:[\(ï¼ˆ\*])\s*(?:æˆ‘æ‰§è¡Œäº†)?(?:åŠ¨ä½œ|æ—ç™½)(?:\/æ—ç™½)?\s*[:ï¼š]\s*(.*?)\s*(?:[\)ï¼‰\*])/g,
                    '*$1*'
                );

                // 2. ã€ç¬¬ä¸€å±‚åˆ‡åˆ†ã€‘ï¼šæŒ‰ *åŠ¨ä½œ* åˆ‡åˆ†
                // ç»“æœç¤ºä¾‹ï¼š["*æ¨é—¨*", "ä½ å¥½ \ åƒé¥­äº†å—", "*åä¸‹*"]
                const segments = processedText.split(/(\*[^*]+\*)/g).map(s => s.trim()).filter(s => s);

                for (const segment of segments) {
                    // åˆ¤æ–­æ˜¯å¦ä¸ºåŠ¨ä½œ
                    const isAction = segment.startsWith('*') && segment.endsWith('*') && segment.length > 2;

                    if (isAction) {
                        // â¤ æƒ…å†µAï¼šæ˜¯åŠ¨ä½œ -> ç›´æ¥å‘é€ï¼ˆä¸­é—´ç°å­—ï¼‰
                        const actionContent = segment.slice(1, -1).trim();
                        const actionMsg = {
                            sender: 'ai',
                            type: 'action',
                            text: actionContent,
                            timestamp: new Date(),
                            uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                        };

                        // åŠ¨ä½œç¨å¾®å¿«ä¸€ç‚¹
                        await new Promise(resolve => setTimeout(resolve, 400));
                        await saveMessageToHistory(actionMsg, contact.id);
                        addMessageToView(actionMsg, contact);

                    } else {
                        // â¤ æƒ…å†µBï¼šæ˜¯å¯¹è¯ -> ã€æ ¸å¿ƒä¿®å¤ã€‘è¿™é‡Œéœ€è¦æ”¯æŒåˆ†å¥ï¼
                        // ä»¥å‰æ˜¯ç›´æ¥å‘ï¼Œç°åœ¨æˆ‘ä»¬è¦æ£€æŸ¥é‡Œé¢æœ‰æ²¡æœ‰ "\" æˆ–æ¢è¡Œç¬¦

                        // ä½¿ç”¨æ­£åˆ™æŒ‰ "\" æˆ– "\\" æˆ– "\n" åˆ‡å‰²
                        const subSegments = segment.split(/\\|\\|\n/g).map(s => s.trim()).filter(s => s);

                        for (const subText of subSegments) {
                            // å‡†å¤‡æ™®é€šæ°”æ³¡æ¶ˆæ¯
                            const textMsg = {
                                sender: 'ai',
                                type: 'text',
                                text: subText,
                                timestamp: new Date(),
                                uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                            };

                            // å¤„ç†æ­£åœ¨è¾“å…¥çŠ¶æ€ (æ¯ä¸ªæ°”æ³¡å‰éƒ½æ˜¾ç¤ºä¸€ä¸‹æ­£åœ¨è¾“å…¥ï¼Œæ›´æœ‰çœŸå®æ„Ÿ)
                            let typingRow = (typingRowForTransform) ? typingRowForTransform : showTypingIndicator(contact);
                            typingRowForTransform = null;

                            // æ ¹æ®å­—æ•°è®¡ç®—å»¶æ—¶
                            // --- AIæ‰“å­—å»¶è¿Ÿè®¡ç®— (æ ¸å¿ƒæ§åˆ¶å¤„) ---
                            // è§„åˆ™ï¼šåŸºç¡€æ¯å­— 600ms (çº¦ç­‰äºæ­£å¸¸é˜…è¯»é€Ÿåº¦)
                            // ä¸Šé™ 10000ms (é˜²æ­¢é•¿æ–‡ç­‰å¾…å¤ªä¹…)ï¼Œä¸‹é™ 2000ms (ä¿è¯æœ‰â€œæ­£åœ¨è¾“å…¥â€çš„æ„Ÿè§‰)
                            const typingSpeedPerChar = 80; 
                            const minDelay = 800;
                            const maxDelay = 3000;
                            
                            const typingDelay = Math.min(Math.max(subText.length * typingSpeedPerChar, minDelay), maxDelay);
                            await new Promise(resolve => setTimeout(resolve, typingDelay));

                            // ä¿å­˜å¹¶æ¸²æŸ“
                            await saveMessageToHistory(textMsg, contact.id);

                            if (typingRow && typingRow.parentNode) {
                                typingRow.remove();
                            }

                            addMessageToView(textMsg, contact);
                        }
                    }
                }
                continue;
            }


            // --- é€šç”¨å¤„ç†é€»è¾‘ï¼šä¸ºæ‰€æœ‰éçº¯æ–‡æœ¬ã€éåŠ¨ä½œæŒ‡ä»¤çš„æ¶ˆæ¯å¯¹è±¡æ‰§è¡Œ ä¿å­˜->æ¸²æŸ“ ---
            if (messageObject) {
                if (typingRowForTransform) {
                    typingRowForTransform.remove();
                    typingRowForTransform = null;
                }
                const finalMessage = { ...messageObject, timestamp: new Date(), uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9) };

                // ã€é¡ºåºä¿®æ­£ã€‘å…ˆä¿å­˜å¹¶æ›´æ–°å†…å­˜
                await saveMessageToHistory(finalMessage, contact.id);
                // å†ç”¨æœ€æ–°çš„æ•°æ®æ¸²æŸ“è§†å›¾
                addMessageToView(finalMessage, contact);
            }
        }

        if (typingRowForTransform) {
            typingRowForTransform.remove();
        }
    }

    // ===================================
    // è¿™æ˜¯æ–°çš„ã€ç®€åŒ–çš„ saveMessageToHistory
    // ===================================
    async function saveMessageToHistory(message, contactId) {
        try {
            // 1. ã€æ ¸å¿ƒä¼˜åŒ–ã€‘ä¼˜å…ˆä»ç¼“å­˜è·å–ï¼Œä¸ºç©ºæ‰è¯»åº“
            let allContacts = Global_AllContactsCache;
            if (!allContacts) {
                console.log("ç¼“å­˜æœªå‘½ä¸­ï¼Œä»DBè¯»å– allContacts...");
                const allContactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                allContacts = (allContactsData && Array.isArray(allContactsData.value)) ? allContactsData.value : [];
                Global_AllContactsCache = allContacts;
            }

            // 2. åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°æˆ‘ä»¬è¦ä¿®æ”¹çš„è”ç³»äºº
            const contactIndex = allContacts.findIndex(c => c.id === contactId);

            if (contactIndex > -1) {
                const contactToUpdate = allContacts[contactIndex];

                // ç¡®ä¿ history æ•°ç»„å­˜åœ¨
                if (!Array.isArray(contactToUpdate.history)) {
                    contactToUpdate.history = [];
                }

                // 3. å°†æ–°æ¶ˆæ¯æ·»åŠ åˆ°è¯¥è”ç³»äººçš„å†å²è®°å½•ä¸­
                contactToUpdate.history.push(message);


                // 4. ã€æ ¸å¿ƒä¿®å¤ã€‘åªæœ‰å½“æ¶ˆæ¯ä¸æ˜¯é€šè¯æ‘˜è¦æ—¶ï¼Œæ‰æ›´æ–° lastMessage å±æ€§
                // 4. ã€æ ¸å¿ƒä¿®å¤ã€‘æ›´æ–° lastMessage å±æ€§ï¼ˆå¤„ç†å®šä½ã€éšè—æ¶ˆæ¯ç­‰é€»è¾‘ï¼‰
                // ä¼˜å…ˆçº§ï¼š
                // 1. å®šä½æ¶ˆæ¯ -> æ˜¾ç¤º "[å®šä½]"
                // 2. é€šè¯æ‘˜è¦/éšè—æç¤º/ç³»ç»Ÿæç¤º -> è·³è¿‡æ›´æ–°
                // 3. å…¶ä»– -> æ¸…æ´—åä½œä¸ºé¢„è§ˆ
                if (message.type === 'location') {
                    contactToUpdate.lastMessage = '[å®šä½]';
                } else if (message.type !== 'call_summary' && message.type !== 'location_hint' && !message.hidden) {
                    // å®‰å…¨åœ°è·å–ç”¨äºé¢„è§ˆçš„æ–‡æœ¬
                    const previewText = message.text || (message.content && message.content.html) || '';
                    contactToUpdate.lastMessage = cleanMessageForPreview(previewText);
                }

                // 5. å°†ä¿®æ”¹åçš„æ•´ä¸ªè”ç³»äººåˆ—è¡¨å®Œæ•´åœ°ä¿å­˜å›æ•°æ®åº“
                await dbHelper.saveData('messageContacts', 'allContacts', allContacts);

                // 6. å¦‚æœå½“å‰èŠå¤©çª—å£æ­£å¥½æ˜¯è¿™ä¸ªè”ç³»äººï¼Œåˆ™æ›´æ–°å†…å­˜ä¸­çš„çŠ¶æ€
                // â–¼â–¼â–¼ START: åœ¨è¿™é‡Œç²˜è´´æ–°çš„ä»£ç  â–¼â–¼â–¼
                // ç”¨ä¸‹é¢è¿™æ®µä»£ç æ›¿æ¢æ‰ä¸Šé¢çš„ `if` è¯­å¥
                if (currentOpenContact && currentOpenContact.id === contactId) {
                    // æ ¸å¿ƒä¿®å¤ï¼š
                    // ä¸è¦ç”¨ä»æ•°æ®åº“è¯»å‡ºæ¥çš„æ—§å¯¹è±¡(contactToUpdate)è¦†ç›–æ•´ä¸ªå†…å­˜å¯¹è±¡ã€‚
                    // è€Œæ˜¯åªæ›´æ–°å†…å­˜å¯¹è±¡(currentOpenContact)ä¸­å®é™…å‘ç”Ÿå˜åŒ–çš„å±æ€§ã€‚
                    currentOpenContact.history = contactToUpdate.history;
                    currentOpenContact.lastMessage = contactToUpdate.lastMessage;
                }
                // â–²â–²â–² ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

                // 7. åœ¨ä¸»æ¶ˆæ¯åˆ—è¡¨ç•Œé¢ä¸Šå®æ—¶æ›´æ–°é¢„è§ˆ
                const contactItemInList = contactList.querySelector(`.contact-item[data-contact-id="${contactId}"]`);
                if (contactItemInList) {
                    contactItemInList.querySelector('.contact-last-message').textContent = contactToUpdate.lastMessage;
                }
                // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„ä»£ç  â–¼â–¼â–¼
                // åœ¨æ‰€æœ‰æ•°æ®ä¿å­˜å®Œæ¯•åï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè¿›è¡Œæœ€ç»ˆæ£€æŸ¥
                const updatedContact = allContacts[contactIndex];
                const totalHistoryLength = (updatedContact.history || []).length;

                // æ£€æŸ¥æ¶ˆæ¯æ€»æ•°æ˜¯å¦æ˜¯200çš„å€æ•°ï¼Œå¹¶ä¸”è§¦å‘æ¶ˆæ¯ä¸èƒ½æ˜¯ç³»ç»Ÿæ¶ˆæ¯
                if (totalHistoryLength > 0 && totalHistoryLength % 200 === 0 && message.type !== 'system') {
                    console.log(`æ¶ˆæ¯æ€»æ•°è¾¾åˆ° ${totalHistoryLength}ï¼Œå‡†å¤‡è§¦å‘AIå‘æœ‹å‹åœˆï¼`);
                    // è°ƒç”¨å‘æœ‹å‹åœˆçš„è§¦å‘å‡½æ•°
                    triggerAiSocialPost(updatedContact);
                }

            } else {
                console.error(`åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°IDä¸º ${contactId} çš„è”ç³»äººæ¥ä¿å­˜æ¶ˆæ¯ã€‚`);
            }
        } catch (error) {
            console.error("ä¿å­˜æ¶ˆæ¯å†å²è®°å½•å¤±è´¥:", error);
        }
    }

    // Expose for usage in other scopes (e.g. Location Feature)
    window.saveMessageToHistory = saveMessageToHistory;
    window.addMessageToView = addMessageToView;


    // === ä¿®æ”¹ï¼šå‘é€æ¶ˆæ¯ä¸»å‡½æ•° (å…¼å®¹å•èŠå’Œç¾¤èŠ) ===
    async function sendMessage(messageData) {
        // å®‰å…¨æ£€æŸ¥ï¼šå¿…é¡»æœ‰ä¸€ä¸ªèŠå¤©å¯¹è±¡ï¼ˆè¦ä¹ˆæ˜¯äººï¼Œè¦ä¹ˆæ˜¯ç¾¤ï¼‰
        if (!currentOpenContact && !currentOpenGroup) return;

        // 1. æ ‡å‡†åŒ–æ¶ˆæ¯å¯¹è±¡
        let messageObject;
        if (typeof messageData === 'string') {
            const text = messageData.trim();
            if (isHtmlString(text)) {
                messageObject = { type: 'html', content: { html: text } };
            } else {
                messageObject = { type: 'text', text: text };
            }
        } else {
            messageObject = messageData;
        }
        // â–¼â–¼â–¼ æ–°å¢ï¼šæ³¨å…¥å›å¤ä¿¡æ¯ â–¼â–¼â–¼
        if (currentReplyTarget) {
            messageObject.replyTo = {
                uuid: currentReplyTarget.uuid,
                text: currentReplyTarget.text,
                senderName: currentReplyTarget.senderName
            };
            // å‘é€åæ¸…é™¤çŠ¶æ€
            cancelReplyMode();
        }


        const userMessage = {
            sender: 'user',
            timestamp: new Date(),
            uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            ...messageObject
        };

        // 2. åˆ†æµå¤„ç†ï¼šæ˜¯å‘ç»™ç¾¤ï¼Œè¿˜æ˜¯å‘ç»™äººï¼Ÿ
        if (currentOpenGroup) {
            // --- ç¾¤èŠæ¨¡å¼ ---
            await saveGroupMessageToHistory(userMessage, currentOpenGroup.id);
            addGroupMessageToView(userMessage); // ç¾¤èŠæ¸²æŸ“å‡½æ•°

        } else if (currentOpenContact) {
            // --- å•èŠæ¨¡å¼ ---
            await saveMessageToHistory(userMessage, currentOpenContact.id);
            addMessageToView(userMessage, currentOpenContact); // å•èŠæ¸²æŸ“å‡½æ•°
        } else {
            // å¦‚æœä¸¤ä¸ªéƒ½æ˜¯ nullï¼Œè¯´æ˜å‡ºbugäº†ï¼Œç›´æ¥è¿”å›ï¼Œåˆ«çå‘
            console.error("é”™è¯¯ï¼šå½“å‰æ²¡æœ‰æ‰“å¼€ä»»ä½•ä¼šè¯ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
            return;
        }

        // 3. æ»šåŠ¨åˆ°åº•éƒ¨
        chatMessagesContainer.scrollTo({
            top: chatMessagesContainer.scrollHeight,
            behavior: 'smooth'
        });

        // 4. æ¸…ç©ºè¾“å…¥æ¡†
        chatMessageInput.value = '';
    }



    // === AIåŠŸèƒ½æ–°å¢ï¼šé€æ¡å»¶æ—¶æ˜¾ç¤ºAIæ¶ˆæ¯çš„å‡½æ•° ===

    /**
     * è§£é‡Šï¼š
     * è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªåŒ…å«å¤šæ¡æ¶ˆæ¯æ–‡æœ¬çš„æ•°ç»„ï¼Œç„¶åé€æ¡æ˜¾ç¤ºå®ƒä»¬ã€‚
     * 'async' å’Œ 'await' çš„ä½¿ç”¨è®©æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åœ¨å¾ªç¯ä¸­å®ç°å»¶æ—¶ã€‚
     * @param {string[]} messages - AIå›å¤çš„çº¯æ–‡æœ¬æ¶ˆæ¯æ•°ç»„
     */
    //
    // ç²˜è´´è¿™ä¸¤ä¸ªå…¨æ–°çš„å‡½æ•°
    //

    /**
     * åŠŸèƒ½1ï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«â€œæ­£åœ¨è¾“å…¥â€åŠ¨ç”»çš„AIæ°”æ³¡ï¼Œå¹¶è¿”å›è¯¥æ°”æ³¡å…ƒç´ çš„å¼•ç”¨
     */
    function createTypingBubble() {
        const row = document.createElement('div');
        row.className = 'message-row ai';

        const avatar = document.createElement('img');
        avatar.className = 'chat-avatar';
        avatar.src = currentOpenContact.ai.avatar;
        const avatarSettings = currentOpenContact.avatarSettings || { radius: '50%' };
        avatar.style.borderRadius = avatarSettings.radius;

        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble ai-bubble';
        bubble.innerHTML = `
        <div class="typing-animation">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
    `;

        row.appendChild(avatar);
        row.appendChild(bubble);
        chatMessagesContainer.appendChild(row);
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

        return bubble; // è¿”å›è¿™ä¸ªæ–°åˆ›å»ºçš„æ°”æ³¡å…ƒç´ ï¼Œä»¥ä¾¿åç»­ä¿®æ”¹
    }

    /**
     * åŠŸèƒ½2ï¼ˆå…¨æ–°ç‰ˆæœ¬ï¼‰ï¼šé€æ¡æ˜¾ç¤ºAIæ¶ˆæ¯ï¼Œå¹¶å®ç°â€œå…ˆæ˜¾ç¤ºåŠ¨ç”»ï¼Œå†å¡«å……æ–‡å­—â€çš„åŠ¨æ€æ•ˆæœ
     */

    // è¿™æ˜¯ displayAiMessagesSequentially å‡½æ•°çš„ã€æ–°ç‰ˆã€‘ï¼Œèƒ½å¤„ç†é¢„å…ˆåˆ›å»ºçš„åŠ è½½åŠ¨ç”»
    //
    async function displayAiMessagesSequentially(messages, initialBubble) {
        // ä½¿ç”¨ .entries() æ¥åŒæ—¶è·å–æ¶ˆæ¯çš„ç´¢å¼•å’Œå†…å®¹
        for (const [index, text] of messages.entries()) {
            if (!text) continue;

            let currentBubble;

            // åˆ¤æ–­ä½¿ç”¨å“ªä¸ªæ°”æ³¡ï¼š
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ (index === 0)ï¼Œå°±ä½¿ç”¨ callAI é¢„å…ˆåˆ›å»ºçš„é‚£ä¸ª
            // å¦‚æœæ˜¯åç»­æ¶ˆæ¯ï¼Œå°±æ–°å»ºä¸€ä¸ª
            if (index === 0) {
                currentBubble = initialBubble;
            } else {
                currentBubble = createTypingBubble();
            }

            // æ¨¡æ‹Ÿæ‰“å­—å»¶è¿Ÿ
            const typingDelay = Math.min(Math.max(text.length * 3000, 2000), 6000);
            await new Promise(resolve => setTimeout(resolve, typingDelay));

            // å°†åŠ¨ç”»æ›¿æ¢ä¸ºçœŸå®çš„æ–‡å­—å†…å®¹
            currentBubble.innerHTML = '';
            currentBubble.textContent = text;

            // ä¿å­˜åˆ°å†å²è®°å½•
            const aiMessage = {
                sender: 'ai',
                text: text,
                timestamp: new Date()
            };
            await saveMessageToHistory(aiMessage);
        }
    }



    // â–¼â–¼â–¼ ã€æ–°å¢è¿™ä¸ªå‡½æ•°ã€‘åªè´Ÿè´£æ³¨å…¥æ ·å¼ï¼Œç»ä¸éå† DOMï¼Œé€Ÿåº¦æå¿« â–¼â–¼â–¼
    function initializeChatStyles(contact) {
        // 1. æ³¨å…¥æ°”æ³¡æ ·å¼ (è§£å†³é€æ˜é—®é¢˜)
        customBubbleStyles.innerHTML = contact.customBubbleCss || defaultBubbleCss;

        // 2. è®¾ç½®èŠå¤©èƒŒæ™¯ (ä¿®å¤ï¼šç»Ÿä¸€ä½¿ç”¨ chatMessagesContainerï¼Œä¸ applyChatBackground ä¿æŒä¸€è‡´)
        // ä¼˜å…ˆä½¿ç”¨ chatBackgroundï¼Œå‘åå…¼å®¹ backgroundImage
        const bgToApply = contact.chatBackground || contact.backgroundImage;
        if (bgToApply) {
            chatMessagesContainer.style.backgroundImage = `url('${bgToApply}')`;
            chatMessagesContainer.style.backgroundSize = 'cover';
            chatMessagesContainer.style.backgroundPosition = 'center';
            chatMessagesContainer.style.backgroundRepeat = 'no-repeat';
        } else {
            // æ¸…é™¤èƒŒæ™¯
            chatMessagesContainer.style.backgroundImage = '';
            chatMessagesContainer.style.backgroundSize = '';
            chatMessagesContainer.style.backgroundPosition = '';
            chatMessagesContainer.style.backgroundRepeat = '';
        }

        // 3. è®¾ç½®å¤´åƒæ˜¾ç¤º/éšè— (ä¸éœ€è¦éå†ï¼Œç›´æ¥åˆ‡æ¢å®¹å™¨ç±»å)
        const avatarSettings = contact.avatarSettings || { show: true, radius: '50%' };
        chatMessagesContainer.classList.toggle('hide-avatars', !avatarSettings.show);

        // 4. æ³¨å…¥æŒ‚ä»¶æ ·å¼
        let finalPendantCss = '';
        if (contact.ai.avatarPendant && contact.ai.avatarPendant.css) {
            finalPendantCss += `#chat-screen.contact-${contact.id} .message-content-wrapper.ai .avatar-pendant { ${contact.ai.avatarPendant.css} } \n`;
        }
        if (contact.user.avatarPendant && contact.user.avatarPendant.css) {
            finalPendantCss += `#chat-screen.contact-${contact.id} .message-content-wrapper.user .avatar-pendant { ${contact.user.avatarPendant.css} } \n`;
        }
        customPendantStyles.innerHTML = finalPendantCss;
    }
    // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

    let chatCloseTimer = null;
    // ==========================================================
    // === openChatView  ===
    // ==========================================================

    async function openChatView(contactId, options = {}) {
        if (chatCloseTimer) {
            clearTimeout(chatCloseTimer);
            chatCloseTimer = null;
        }
        // playEnterSound();
        console.log(`æ­£åœ¨æ‰“å¼€èŠå¤©çª—å£: ${contactId}`);

        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘æ¸…ç†æ‰€æœ‰åŠ¨æ€åˆ›å»ºçš„æ°”æ³¡æ ·å¼æ ‡ç­¾ï¼Œé˜²æ­¢æ ·å¼æ±¡æŸ“ â–¼â–¼â–¼
        document.querySelectorAll('style[id^="dynamic-chat-style-"]').forEach(el => el.remove());
        // â–²â–²â–² æ ·å¼æ¸…ç†ç»“æŸ â–²â–²â–²
        currentOpenGroup = null;
        stopProactiveTimer(contactId);


        // 1. åŸºç¡€æ£€æŸ¥
        if (!isVoiceInputInitialized) {
            initializeVoiceInput();
            isVoiceInputInitialized = true;
        }
        chatScreen.classList.remove('emoji-panel-active');
        
        // ã€é˜²æ±¡æŸ“ä¿®å¤ã€‘å¼ºåˆ¶æ¸…é™¤ chatScreen å¯èƒ½æ®‹ç•™çš„è¡Œå†…èƒŒæ™¯æ ·å¼
        // ç°åœ¨çš„èƒŒæ™¯ç»Ÿä¸€ç”± initializeChatStyles åº”ç”¨åˆ° chatMessagesContainer
        chatScreen.style.backgroundImage = '';
        chatScreen.style.backgroundColor = '';

        // 2. åŠ è½½è”ç³»äººæ•°æ® (ä¼˜åŒ–ç‰ˆï¼šä¼˜å…ˆè¯»ç¼“å­˜)
        let allContacts = Global_AllContactsCache;
        if (!allContacts) {
             console.log("openChatView: ç¼“å­˜æœªå‘½ä¸­ï¼Œä»DBè¯»å–...");
             const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
             if (!contactsData || !Array.isArray(contactsData.value)) {
                 console.error("æ— æ³•åŠ è½½è”ç³»äººæ•°æ®"); return;
             }
             allContacts = contactsData.value;
             Global_AllContactsCache = allContacts; // å»ºç«‹ç¼“å­˜
        }
        
        currentOpenContact = allContacts.find(c => c.id === contactId);

        if (!currentOpenContact) {
            console.error(`æ‰¾ä¸åˆ° ID ä¸º ${contactId} çš„è”ç³»äºº`); return;
        }

        // 3. æ›´æ–°é¡¶æ ä¿¡æ¯
        const blockNotice = document.getElementById('block-status-notice');
        if (currentOpenContact.isBlocked) {
            blockNotice.textContent = `ä½ å·²æ‹‰é»‘ ${currentOpenContact.ai.name}`;
            blockNotice.style.display = 'block';
        } else {
            blockNotice.style.display = 'none';
        }
        chatContactName.textContent = currentOpenContact.ai.name;

        // è®¾ç½®ä¸“å±ç±»åï¼Œç”¨äºCSSæ ·å¼éš”ç¦»
        chatScreen.className = `screen contact-${currentOpenContact.id}`;




        // â–¼â–¼â–¼â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ï¼šç‰©ç†éš”ç¦»ç›–ç« ã€‘â–¼â–¼â–¼â–¼â–¼â–¼
        // è¿™é‡Œæ˜¯å•èŠï¼Œæ‰€ä»¥ mode æ˜¯ 'single'ï¼ŒID ä½¿ç”¨ currentOpenContact.id
        // ä¹‹å‰æŠ¥é”™æ˜¯å› ä¸ºä½ å¯èƒ½åœ¨è¿™é‡Œå†™äº† group.id
        if (chatMessagesContainer) {
            chatMessagesContainer.dataset.contextMode = 'single';
            chatMessagesContainer.dataset.contextId = currentOpenContact.id;
        }
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²



        // 4. å‡†å¤‡å†å²è®°å½•
        const history = Array.isArray(currentOpenContact.history) ? currentOpenContact.history : [];

        // === æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒï¼šä½¿ç”¨ DocumentFragment ===
        const fragment = document.createDocumentFragment(); // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿå®¹å™¨

        // å†³å®šè¦æ˜¾ç¤ºå“ªäº›æ¶ˆæ¯
        let messagesToRender = [];
        if (options.targetMessageUuid) {
            // å¦‚æœæ˜¯æœç´¢è·³è½¬ï¼ŒåŠ è½½æ‰€æœ‰æ¶ˆæ¯ï¼ˆæˆ–è€…ä½ éœ€è¦æ›´å¤æ‚çš„é€»è¾‘æ¥å®šä½ï¼Œæš‚ä¸”å…¨åŠ è½½ï¼‰
            messagesToRender = history;
        } else {
            // é»˜è®¤åªåŠ è½½æœ€å 30 æ¡ï¼Œé˜²æ­¢å¡é¡¿
            if (history.length > 30) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'load-more-messages-btn';
                loadMoreBtn.textContent = 'æŸ¥çœ‹æ›´æ—©çš„æ¶ˆæ¯';
                loadMoreBtn.addEventListener('click', loadMoreMessages);
                // æŠŠæŒ‰é’®å…ˆåŠ åˆ°ç•Œé¢å®¹å™¨é¡¶éƒ¨ï¼ˆå› ä¸ºFragmentæ˜¯ç¨åè¿½åŠ çš„ï¼‰
                chatMessagesContainer.innerHTML = '';
                chatMessagesContainer.appendChild(loadMoreBtn);
            } else {
                chatMessagesContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
            }
            messagesToRender = history.slice(-30);
        }

        // 5. æ‰¹é‡ç”Ÿæˆ DOM (åœ¨å†…å­˜ä¸­è¿›è¡Œï¼Œä¸è§¦å‘å¸ƒå±€é‡ç»˜)
        messagesToRender.forEach(message => {
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¼ å…¥ fragment ä½œä¸ºå®¹å™¨
            addMessageToView(message, currentOpenContact, fragment);
        });

        // 6. ä¸€æ¬¡æ€§æŒ‚è½½åˆ°é¡µé¢ (åªè§¦å‘ä¸€æ¬¡é‡ç»˜ï¼)
        chatMessagesContainer.appendChild(fragment);

        // 7. === æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒ:æ¸²æŸ“å®Œæˆå,åªæ‰§è¡Œä¸€æ¬¡æ ·å¼åº”ç”¨ ===
        // è¿™ä¼šç»Ÿä¸€å¤„ç†æ‰€æœ‰çš„å¤´åƒæŒ‚ä»¶ã€æ°”æ³¡é¢œè‰²ç­‰
        initializeChatStyles(currentOpenContact);

        // 8. === åº”ç”¨èŠå¤©èƒŒæ™¯å·²åœ¨ initializeChatStyles ä¸­ç»Ÿä¸€å¤„ç† ===



        // A. å…ˆç§»é™¤ settled ç±» (å…³é—­æ¯›ç»ç’ƒ)ï¼Œç¡®ä¿åŠ¨ç”»å¼€å§‹æ—¶æ˜¯ä½è´Ÿè½½æ¨¡å¼
        chatScreen.classList.remove('settled');

        // B. å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ä¸€å¸§ (Double RAF)ï¼Œç¡®ä¿ transition èƒ½å¤Ÿæ­£ç¡®è§¦å‘
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                // C. å¼€å§‹åŠ¨ç”»
                phoneFrame.classList.add('show-chat');

                // D. æ»šåŠ¨åˆ°åº•éƒ¨ (æ”¾åœ¨è¿™é‡Œæ›´å¹³æ»‘)
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            });
        });

        // E. ç­‰å¾…åŠ¨ç”»ç»“æŸ (350ms) åï¼Œå¼€å¯é«˜ç”»è´¨
        setTimeout(() => {
            // åªæœ‰å½“èŠå¤©ç•Œé¢ä¾ç„¶æ˜¾ç¤ºæ—¶æ‰å¼€å¯ï¼Œé˜²æ­¢ç”¨æˆ·å¿«é€Ÿå…³é—­å¯¼è‡´é”™ä¹±
            if (phoneFrame.classList.contains('show-chat')) {
                chatScreen.classList.add('settled'); // å¼€å¯æ¯›ç»ç’ƒ
            }
        }, 380); // æ¯” CSS çš„ 0.35s ç¨é•¿ä¸€ç‚¹ï¼Œç¡®ä¿å®‰å…¨

        // 8. æ˜¾ç¤ºç•Œé¢
        phoneFrame.classList.add('show-chat');

        // 9. å¤„ç†ç‰¹æ®ŠHTMLæ¶ˆæ¯çš„è„šæœ¬æ‰§è¡Œ (ä¿æŒåŸæœ‰é€»è¾‘)
        messagesToRender.forEach(message => {
            if (message.type === 'html' && message.content) {
                const messageElement = chatMessagesContainer.querySelector(`.html-render-container[id='html-render-${message.uuid}']`);
                if (messageElement) {
                    if (message.content.css) {
                        const style = document.createElement('style');
                        const uniqueId = messageElement.id;
                        const scopedCss = message.content.css.replace(/([^\r\n,{}]+)(,(?=[^}]*{)|s*\{)/g, `#${uniqueId} $1 `);
                        style.textContent = scopedCss;
                        document.head.appendChild(style);
                    }
                    if (message.content.js) {
                        try { new Function(message.content.js)(); } catch (e) { console.error(e); }
                    }
                }
            }
        });

        // 10. æ»šåŠ¨å®šä½
        if (options.targetMessageUuid) {
            const targetMessage = chatMessagesContainer.querySelector(`.message-row[data-uuid="${options.targetMessageUuid}"]`);
            if (targetMessage) {
                targetMessage.scrollIntoView({ behavior: 'auto', block: 'center' });
                targetMessage.classList.add('message-highlight');
                setTimeout(() => targetMessage.classList.remove('message-highlight'), 1500);
            }
        } else {
            // å¼ºåˆ¶åœ¨ä¸‹ä¸€å¸§æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿å›¾ç‰‡å¸ƒå±€å·²ç¨³å®š
            requestAnimationFrame(() => {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            });
        }

        chatMessageInput.blur();
    }


    // é‡æ–°ä¿®æ”¹ loadMoreMessages å‡½æ•°



    // === loadMoreMessages (V3 - è°ƒç”¨ç»Ÿä¸€æ¸²æŸ“å‡½æ•°) ===
    async function loadMoreMessages() {
        if (!currentOpenContact) return;
        const loadMoreBtn = document.getElementById('load-more-messages-btn');
        if (!loadMoreBtn) return;

        const oldScrollHeight = chatMessagesContainer.scrollHeight;
        const history = Array.isArray(currentOpenContact.history) ? currentOpenContact.history : [];
        const messagesInViewCount = chatMessagesContainer.querySelectorAll('.message-row').length;
        const endIndex = history.length - messagesInViewCount;
        if (endIndex <= 0) {
            loadMoreBtn.remove();
            return;
        }

        const startIndex = Math.max(0, endIndex - 30);
        const messagesToAdd = history.slice(startIndex, endIndex).reverse(); // åè½¬æ•°ç»„ï¼Œä»¥ä¾¿ä»æ—§åˆ°æ–°æ’å…¥

        messagesToAdd.forEach(message => {
            const messageElement = addMessageToView(message); // è°ƒç”¨æ–°çš„ã€åŠŸèƒ½å®Œæ•´çš„å‡½æ•°
            if (messageElement) {
                loadMoreBtn.after(messageElement); // å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°æŒ‰é’®ä¹‹å
            }
        });

        const newScrollHeight = chatMessagesContainer.scrollHeight;
        chatMessagesContainer.scrollTop += (newScrollHeight - oldScrollHeight);

        if (startIndex === 0) {
            loadMoreBtn.remove();
        }
    }

    // è¯·åœ¨æ‚¨çš„ä»£ç ä¸­æ‰¾åˆ°å¹¶ã€å½»åº•åˆ é™¤ã€‘æ—§çš„ createMessageElement å‡½æ•°


    // --- åŠŸèƒ½ B: å…³é—­èŠå¤©ç•Œé¢ ---
    function closeChatView() {
        console.log('[DEBUG] closeChatView: START');
        
        scrollToBottomBtn.classList.remove('visible');
        chatScreen.classList.remove('settled');

        // ã€ä¿®å¤ã€‘ç§»é™¤è¿™é‡Œçš„ renderMessagesList è°ƒç”¨ï¼Œé¿å…é‡å¤æ¸²æŸ“å¯¼è‡´é—ªçƒ
        // æ¸²æŸ“ä¼šåœ¨è¿”å›æŒ‰é’®çš„äº‹ä»¶å¤„ç†å™¨ä¸­ç»Ÿä¸€å¤„ç†

        if (currentOpenContact) {
            startProactiveTimer(currentOpenContact.id);
        }

        // å¼€å§‹é€€å‡ºåŠ¨ç”»
        phoneFrame.classList.remove('show-chat');
        console.log('[DEBUG] closeChatView: Animation started');

        if (chatCloseTimer) clearTimeout(chatCloseTimer);

        // å¯åŠ¨æ–°çš„å®šæ—¶å™¨ï¼Œå¹¶æŠŠ ID å­˜èµ·æ¥
        chatCloseTimer = setTimeout(() => {
            currentOpenContact = null;
            currentOpenGroup = null;

            chatMessagesContainer.textContent = ''; // æ¸…ç©ºå†…å®¹
            console.log('[DEBUG] closeChatView: Cleanup completed');

            // ä»»åŠ¡æ‰§è¡Œå®Œäº†ï¼ŒæŠŠ ID é‡ç½®
            chatCloseTimer = null;
        }, 350);
    }

    // --- åŠŸèƒ½ C: ç»‘å®šäº‹ä»¶ ---

    // ä½¿ç”¨â€œäº‹ä»¶å§”æ‰˜â€æ¥å¤„ç†è”ç³»äººåˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶ã€‚
    // è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå³ä½¿æ˜¯åŠ¨æ€æ·»åŠ çš„è”ç³»äººï¼Œç‚¹å‡»äº‹ä»¶ä¹ŸåŒæ ·æœ‰æ•ˆã€‚
    // === ä¿®æ”¹ï¼šæ¶ˆæ¯åˆ—è¡¨ç‚¹å‡»äº‹ä»¶ï¼ˆæ”¯æŒå•èŠå’Œç¾¤èŠï¼‰ ===
    contactList.addEventListener('click', (event) => {
        // å¦‚æœå½“å‰å¤„äºåˆ é™¤æ¨¡å¼ï¼Œå¹¶ä¸”ç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†ï¼Œåˆ™ä¸è¿›å…¥èŠå¤©
        if (contactList.classList.contains('delete-mode') && event.target.classList.contains('contact-checkbox')) {
            return;
        }

        // æŸ¥æ‰¾è¢«ç‚¹å‡»çš„ã€æœ€æ¥è¿‘çš„çˆ¶çº§ .contact-item å…ƒç´ 
        const contactItem = event.target.closest('.contact-item');

        if (contactItem) {
            // 1. ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠ ID
            if (contactItem.dataset.groupId) {
                const groupId = parseInt(contactItem.dataset.groupId, 10);
                openGroupChatView(groupId); // <--- è°ƒç”¨è¿˜æ²¡å†™çš„ç¾¤èŠæ‰“å¼€å‡½æ•°
            }
            // 2. å¦åˆ™æ£€æŸ¥æ˜¯å¦æ˜¯å•èŠ ID
            else if (contactItem.dataset.contactId) {
                const contactId = parseInt(contactItem.dataset.contactId, 10);
                openChatView(contactId); // <--- è°ƒç”¨åŸæœ¬çš„å•èŠæ‰“å¼€å‡½æ•°
            }
        }
    });

    // ä¸ºèŠå¤©ç•Œé¢çš„è¿”å›æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    chatBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean("chat-messages-container"); // âœ… æ·»åŠ è¿™è¡Œ
        console.log('[DEBUG] Back button clicked');
        
        // 1. å…ˆæ‰§è¡ŒåŸæœ‰çš„å…³é—­é€»è¾‘
        closeChatView();

        // 2. â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶åˆ·æ–°åˆ—è¡¨ â–¼â–¼â–¼
        // å»¶æ—¶ä¸€ç‚¹ç‚¹ï¼Œç¡®ä¿å…³é—­åŠ¨ç”»å¼€å§‹åï¼Œåå°åˆ·æ–°åˆ—è¡¨æ•°æ®
        setTimeout(() => {
            console.log('[DEBUG] Starting renderMessagesList');
            const startTime = performance.now();
            
            // å¦‚æœæœ‰ renderMessagesList å‡½æ•°ï¼ˆç”¨æ¥æ¸²æŸ“åˆ—è¡¨çš„ï¼‰ï¼Œå°±è°ƒç”¨å®ƒ
            if (typeof renderMessagesList === 'function') {
                renderMessagesList().then(() => {
                    const endTime = performance.now();
                    console.log(`[DEBUG] renderMessagesList completed in ${(endTime - startTime).toFixed(2)}ms`);
                }).catch(err => {
                    console.error('[DEBUG] renderMessagesList error:', err);
                });
            }
        }, 50);
    });



    // === æ›´æ–°é»˜è®¤æ°”æ³¡æ ·å¼å˜é‡ ===
    const defaultBubbleCss = `.user-bubble {
    align-self: flex-end;
    max-width: 85%;
    border-radius: 12px 12px 12px 12px;
    font-size: 14px;
    color: #D1D9D3;
    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;
    background: #2F3633; 
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border-left: 1px solid rgba(255, 255, 255, 0.05);
    margin-bottom: 0px;
}
.ai-bubble {
    align-self: flex-start;
    max-width: 85%;
    border-radius: 12px 12px 12px 12px;
    font-size: 14px;
    color: #5F6360;
    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;
    background: #E8EAE9;
    border: none;
    margin-bottom: 0px;
}`;

    // --- åŠŸèƒ½ A: æ‰“å¼€å’Œå…³é—­è®¾ç½®å¼¹å‡ºå±‚ ---
    // === æ›´æ–° openChatSettingsModal (æ”¯æŒä¸–ç•Œä¹¦å¤šé€‰) ===
    async function openChatSettingsModal() {
        if (!currentOpenContact) return;

        // --- åŠ è½½è§’è‰²ä¿¡æ¯ç­‰ (è¿™éƒ¨åˆ†ä¸å˜) ---
        aiAvatarPreviewSettings.src = currentOpenContact.ai.avatar;
        aiNameInputSettings.value = currentOpenContact.ai.name;
        aiPersonaInputSettings.value = currentOpenContact.ai.persona;
        userAvatarPreviewSettings.src = currentOpenContact.user.avatar;
        userNameInputSettings.value = currentOpenContact.user.name;
        userPersonaInputSettings.value = currentOpenContact.user.persona;
        contextMemoryInputSettings.value = currentOpenContact.contextMemory || 10;
        bubbleCssInput.value = currentOpenContact.customBubbleCss || defaultBubbleCss;
        const avatarSettings = currentOpenContact.avatarSettings || { show: true, radius: '50%' };
        showAvatarsToggle.checked = avatarSettings.show;
        avatarRadiusInput.value = avatarSettings.radius;
        const timestampToggle = document.getElementById('show-timestamps-toggle');

        // 1. è¯»å–â€œé¢„è®¾è¡¨æƒ…â€å¼€å…³ (å·²ç§»é™¤é»˜è®¤è¡¨æƒ…åŒ…åŠŸèƒ½ï¼Œæ­¤å¤„ä»…ä¿ç•™é€»è¾‘å…¼å®¹æ€§)
        // const defaultStickersToggle = document.getElementById('enable-default-stickers-toggle');
        // defaultStickersToggle.checked = currentOpenContact.enableDefaultStickers !== false;
        // è·å–å¼€å…³å…ƒç´ 
        const wbStickersToggle = document.getElementById('enable-wb-stickers-toggle');
        // è¯»å–æ•°æ® (å¦‚æœ undefined é»˜è®¤ä¸º true)
        wbStickersToggle.checked = currentOpenContact.enableWBStickers !== false;
        // é»˜è®¤å…³é—­ (false)ï¼Œå¦‚æœæ•°æ®åº“é‡Œå­˜äº† true åˆ™å¼€å¯
        const timestampSettings = currentOpenContact.timestampSettings || { show: false };
        if (timestampToggle) timestampToggle.checked = timestampSettings.show;

        const monologueToggle = document.getElementById('enable-monologue-toggle');
        if (monologueToggle) {
            // å¦‚æœæ•°æ®åº“é‡Œæ²¡å­˜ï¼Œé»˜è®¤ä¸º true (å¼€å¯)
            const isMonologueEnabled = currentOpenContact.enableMonologue !== false;
            monologueToggle.checked = isMonologueEnabled;
        }

        // åŒè¯­æŠ˜å æ°”æ³¡å¼€å…³ (é»˜è®¤å…³é—­)
        const bilingualBubbleToggle = document.getElementById('enable-bilingual-bubble-toggle');
        if (bilingualBubbleToggle) {
            bilingualBubbleToggle.checked = currentOpenContact.enableBilingualBubble === true;
        }

        // â–¼â–¼â–¼ ä½¿ç”¨è¿™æ®µæ–°ä»£ç æ›¿æ¢æ—§çš„ pendantSettings åŠ è½½é€»è¾‘ â–¼â–¼â–¼
        // åˆ†åˆ«åŠ è½½AIå’Œç”¨æˆ·çš„æŒ‚ä»¶è®¾ç½®
        const aiPendantSettings = currentOpenContact.ai.avatarPendant || { url: '', css: '' };
        aiPendantUrlInput.value = aiPendantSettings.url;
        aiPendantCssInput.value = aiPendantSettings.css;

        const userPendantSettings = currentOpenContact.user.avatarPendant || { url: '', css: '' };
        userPendantUrlInput.value = userPendantSettings.url;
        userPendantCssInput.value = userPendantSettings.css;
        // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåŠ è½½å¹¶æ¸²æŸ“ä¸–ç•Œä¹¦å¤šé€‰åˆ—è¡¨ ---
        const container = document.getElementById('worldbook-group-multiselect-container');
        if (typeof window.renderWorldBookMultiselect === 'function') {
             // ä¼ å…¥ currentOpenContactï¼Œä¸å¼€å¯è‡ªåŠ¨ä¿å­˜ï¼Œå› ä¸ºç¨åæœ‰ä¿å­˜æŒ‰é’®
             await window.renderWorldBookMultiselect(container, currentOpenContact, false);
        } else {
             container.innerHTML = 'ç»„ä»¶æœªå°±ç»ª';
        }

        // Add this block at the end of the function, before it displays the modal.

        const blockBtn = document.getElementById('block-contact-btn');
        if (currentOpenContact.isBlocked) {
            blockBtn.textContent = 'è§£é™¤é™åˆ¶';
            // We can reuse the red 'danger-button' class
            blockBtn.classList.remove('purple-button');
            blockBtn.classList.add('danger-button');
        } else {
            blockBtn.textContent = 'æ‹‰é»‘è¯¥è”ç³»äºº';
            // Use our new purple style
            blockBtn.classList.remove('danger-button');
            blockBtn.classList.add('purple-button');
        }
        // â–²â–²â–² ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

        // --- æ˜¾ç¤ºå¼¹çª— (è¿™éƒ¨åˆ†ä¸å˜) ---
        chatSettingsModal.style.display = 'flex';
        setTimeout(() => {
            chatSettingsModal.style.opacity = '1';
            chatSettingsModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    function closeChatSettingsModal() {
        chatSettingsModal.style.opacity = '0';
        chatSettingsModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            chatSettingsModal.style.display = 'none';
        }, 300);
    }

    chatSettingsButton.onclick = () => { // ä½¿ç”¨ onclick è¦†ç›–æ—§é€»è¾‘
        console.log('[ChatSettings] Button clicked. currentOpenGroup:', currentOpenGroup, 'currentOpenContact:', currentOpenContact);
        if (currentOpenGroup) {
            // å¦‚æœæ˜¯ç¾¤èŠï¼Œæ‰“å¼€ç¾¤èŠè®¾ç½®
            console.log('[ChatSettings] Opening group settings...');
            openGroupInfoModal();
        } else if (currentOpenContact) {
            // å¦‚æœæ˜¯å•èŠï¼Œæ‰“å¼€æ–°çš„å…¨å±è®¾ç½®é¡µé¢
            console.log('[ChatSettings] Opening chat settings page...');
            window.openChatSettingsPage();
        } else {
            console.warn('[ChatSettings] Neither group nor contact is open!');
        }
    };
    chatSettingsCloseBtn.addEventListener('click', closeChatSettingsModal);
    // â–¼â–¼â–¼ ä½¿ç”¨è¿™ä¸¤æ®µæ–°ä»£ç æ›¿æ¢æ—§çš„ restorePendantBtn ç›‘å¬å™¨ â–¼â–¼â–¼
    restoreAiPendantBtn.addEventListener('click', () => {
        aiPendantUrlInput.value = '';
        aiPendantCssInput.value = '';
        alert('è§’è‰²æŒ‚ä»¶è®¾ç½®å·²åœ¨è¾“å…¥æ¡†ä¸­æ¸…ç©ºï¼Œç‚¹å‡»â€œä¿å­˜è®¾ç½®â€åç”Ÿæ•ˆã€‚');
    });

    restoreUserPendantBtn.addEventListener('click', () => {
        userPendantUrlInput.value = '';
        userPendantCssInput.value = '';
        alert('ç”¨æˆ·æŒ‚ä»¶è®¾ç½®å·²åœ¨è¾“å…¥æ¡†ä¸­æ¸…ç©ºï¼Œç‚¹å‡»â€œä¿å­˜è®¾ç½®â€åç”Ÿæ•ˆã€‚');
    });
    // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²
    // --- åŠŸèƒ½ B: ç»‘å®šè®¾ç½®å¼¹å‡ºå±‚å†…éƒ¨çš„å„ç§äº¤äº’ ---

    // è§’è‰²åˆ‡æ¢
    roleSwitchCheckboxSettings.addEventListener('change', () => {
        const isUser = roleSwitchCheckboxSettings.checked;
        aiFormSettings.classList.toggle('active', !isUser);
        userFormSettings.classList.toggle('active', isUser);
        const settingsSwitchLabels = chatSettingsModal.querySelectorAll('.switch-label');
        settingsSwitchLabels[0].classList.toggle('active', !isUser);
        settingsSwitchLabels[1].classList.toggle('active', isUser);
    });

    // å¤´åƒä¸Šä¼ 
    aiAvatarInputSettings.addEventListener('change', () => handleAvatarUpload(aiAvatarInputSettings, aiAvatarPreviewSettings));
    userAvatarInputSettings.addEventListener('change', () => handleAvatarUpload(userAvatarInputSettings, userAvatarPreviewSettings));

    // æ¢å¤é»˜è®¤æ°”æ³¡æ ·å¼
    restoreBubbleCssBtn.addEventListener('click', () => {
        bubbleCssInput.value = defaultBubbleCss;
    });

    // ã€å·²åˆ é™¤ã€‘æ—§çš„èƒŒæ™¯ä¸Šä¼ ç›‘å¬å™¨
    // è¿™äº›ç›‘å¬å™¨åªä¿®æ”¹DOMä¸ä¿å­˜æ•°æ®,å¯¼è‡´èƒŒæ™¯åœ¨å•èŠå’Œç¾¤èŠé—´æ··ä¹±
    // æ–°çš„èƒŒæ™¯ä¸Šä¼ é€»è¾‘ç”± initChatBackgroundListeners() å‡½æ•°å¤„ç†
    // è¯¥å‡½æ•°ä¼šæ­£ç¡®è°ƒç”¨ saveChatBackground() æ¥åŒºåˆ†å•èŠå’Œç¾¤èŠ

    // === ä¿®æ­£ç‰ˆï¼šæ¸…ç©ºèŠå¤©è®°å½•åŠŸèƒ½ (å¢åŠ æ•°æ®åº“æ“ä½œ) ===
    clearHistoryBtn.addEventListener('click', async () => {
        if (!currentOpenContact) return;

        if (confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤å¯¹è¯çš„æ‰€æœ‰èŠå¤©è®°å½•ï¼Œä¸”æ— æ³•æ¢å¤ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            try {
                // 1. **ä»æ•°æ®åº“åŠ è½½æœ€æ–°çš„å®Œæ•´è”ç³»äººåˆ—è¡¨**
                const allContactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                let allContacts = allContactsData.value || [];
                const contactIndex = allContacts.findIndex(c => c.id === currentOpenContact.id);

                if (contactIndex > -1) {
                    // 2. **æ¸…ç©ºè¯¥è”ç³»äººçš„å†å²è®°å½•ï¼Œå¹¶æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯**
                    allContacts[contactIndex].history = [];
                    allContacts[contactIndex].lastMessage = "èŠå¤©è®°å½•å·²æ¸…ç©º";

                    // 3. **å°†ä¿®æ”¹åçš„å®Œæ•´è”ç³»äººåˆ—è¡¨ï¼Œå­˜å›æ•°æ®åº“**
                    await dbHelper.saveData('messageContacts', 'allContacts', allContacts);

                    // 4. **æ›´æ–°å½“å‰å†…å­˜ä¸­çš„æ•°æ®å’ŒUI**
                    currentOpenContact.history = [];
                    currentOpenContact.lastMessage = "èŠå¤©è®°å½•å·²æ¸…ç©º";
                    chatMessagesContainer.innerHTML = ''; // æ¸…ç©ºèŠå¤©ç•Œé¢

                    // 5. æ›´æ–°æ¶ˆæ¯åˆ—è¡¨é¡µçš„é¢„è§ˆ
                    const contactItemInList = contactList.querySelector(`.contact-item[data-contact-id="${currentOpenContact.id}"]`);
                    if (contactItemInList) {
                        contactItemInList.querySelector('.contact-last-message').textContent = "èŠå¤©è®°å½•å·²æ¸…ç©º";
                    }

                    alert('èŠå¤©è®°å½•å·²æˆåŠŸæ¸…é™¤ï¼');
                } else {
                    throw new Error("åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°å½“å‰è”ç³»äººã€‚");
                }
            } catch (error) {
                console.error("æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥:", error);
                alert(`æ“ä½œå¤±è´¥: ${error.message}`);
            }
        }
    });


    // æ‰¾åˆ°ä½ å·²æœ‰çš„ saveChatSettingsBtn äº‹ä»¶ç›‘å¬å™¨ï¼Œå¹¶ç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢å…¶å†…éƒ¨é€»è¾‘ï¼š

    if (saveChatSettingsBtn) {
        saveChatSettingsBtn.addEventListener('click', async () => {
            if (!currentOpenContact) return;

            try {
                // --- ä¿®å¤å¼€å§‹ ---

                // æ­¥éª¤ 1: ä»æ•°æ®åº“åŠ è½½å®Œæ•´çš„è”ç³»äººæ•°ç»„ (ä¼˜åŒ–ï¼šä¼˜å…ˆä½¿ç”¨å…¨å±€ç¼“å­˜ï¼Œé˜²æ­¢ç«æ€)
                let allContacts = Global_AllContactsCache;
                if (!allContacts) {
                    const allContactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                    allContacts = (allContactsData && Array.isArray(allContactsData.value)) ? allContactsData.value : [];
                }

                // æ­¥éª¤ 2: åœ¨è¯¥æ•°ç»„ä¸­æ‰¾åˆ°æˆ‘ä»¬éœ€è¦æ›´æ–°çš„é‚£ä¸ªè”ç³»äººã€‚
                const contactIndex = allContacts.findIndex(c => c.id === currentOpenContact.id);

                if (contactIndex > -1) {
                    // æ­¥éª¤ 3: å°†è®¾ç½®å¼¹çª—ä¸­çš„æ‰€æœ‰æ–°ä¿¡æ¯åº”ç”¨åˆ°é‚£ä¸ªè”ç³»äººå¯¹è±¡ä¸Šã€‚

                    // è·å– DOM å…ƒç´  (ç¡®ä¿å‰é¢å·²å®šä¹‰)
                    const aiNameInputSettings = document.getElementById('ai-name-input-settings');
                    const aiPersonaInputSettings = document.getElementById('ai-persona-input-settings');
                    const aiAvatarPreviewSettings = document.getElementById('ai-avatar-preview-settings');
                    const userNameInputSettings = document.getElementById('user-name-input-settings');
                    const userPersonaInputSettings = document.getElementById('user-persona-input-settings');
                    const userAvatarPreviewSettings = document.getElementById('user-avatar-preview-settings');
                    const contextMemoryInputSettings = document.getElementById('context-memory-input-settings');
                    const bubbleCssInput = document.getElementById('bubble-css-input');
                    const avatarRadiusInput = document.getElementById('avatar-radius-input');
                    const showAvatarsToggle = document.getElementById('show-avatars-toggle');
                    const aiPendantUrlInput = document.getElementById('ai-pendant-url-input');
                    const aiPendantCssInput = document.getElementById('ai-pendant-css-input');
                    const userPendantUrlInput = document.getElementById('user-pendant-url-input');
                    const userPendantCssInput = document.getElementById('user-pendant-css-input');

                    // æ›´æ–° AI/ç”¨æˆ·ä¿¡æ¯
                    allContacts[contactIndex].ai.name = aiNameInputSettings.value.trim();
                    allContacts[contactIndex].ai.persona = aiPersonaInputSettings.value.trim();
                    allContacts[contactIndex].ai.avatar = aiAvatarPreviewSettings.src;

                    // ç¡®ä¿ user å¯¹è±¡å­˜åœ¨
                    if (!allContacts[contactIndex].user) allContacts[contactIndex].user = {};
                    allContacts[contactIndex].user.name = userNameInputSettings.value.trim();
                    allContacts[contactIndex].user.persona = userPersonaInputSettings.value.trim();
                    allContacts[contactIndex].user.avatar = userAvatarPreviewSettings.src;

                    allContacts[contactIndex].contextMemory = parseInt(contextMemoryInputSettings.value, 10);

                    // è·å–å¼€å…³çŠ¶æ€ (å·²ç§»é™¤é»˜è®¤è¡¨æƒ…åŒ…å¼€å…³ï¼Œæ’ä¸º true é¿å…é€»è¾‘é”™è¯¯)
                    // const defaultStickersToggle = document.getElementById('enable-default-stickers-toggle');
                    allContacts[contactIndex].enableDefaultStickers = true; // defaultStickersToggle ? defaultStickersToggle.checked : true;

                    const wbStickersToggle = document.getElementById('enable-wb-stickers-toggle');
                    allContacts[contactIndex].enableWBStickers = wbStickersToggle ? wbStickersToggle.checked : false;

                    // æ›´æ–°ä¸ªæ€§åŒ–è®¾ç½®
                    allContacts[contactIndex].customBubbleCss = bubbleCssInput.value;
                    allContacts[contactIndex].avatarSettings = {
                        show: showAvatarsToggle ? showAvatarsToggle.checked : true,
                        radius: avatarRadiusInput.value.trim() || '50%'
                    };

                    const timestampToggle = document.getElementById('show-timestamps-toggle');
                    allContacts[contactIndex].timestampSettings = {
                        show: timestampToggle ? timestampToggle.checked : false
                    };

                    const monologueToggle = document.getElementById('enable-monologue-toggle');
                    allContacts[contactIndex].enableMonologue = monologueToggle ? monologueToggle.checked : true;

                    // ä¿å­˜åŒè¯­æŠ˜å æ°”æ³¡å¼€å…³
                    const bilingualBubbleToggle = document.getElementById('enable-bilingual-bubble-toggle');
                    allContacts[contactIndex].enableBilingualBubble = bilingualBubbleToggle ? bilingualBubbleToggle.checked : false;

                    // ã€ä¿®å¤ã€‘ä¿å­˜èŠå¤©èƒŒæ™¯ - ä» chatMessagesContainer è¯»å–å¹¶ä¿å­˜åˆ° chatBackground
                    const chatMessagesContainerEl = document.getElementById('chat-messages-container');
                    const bgImage = chatMessagesContainerEl ? chatMessagesContainerEl.style.backgroundImage : '';
                    // æå– url() ä¸­çš„å®é™…å›¾ç‰‡æ•°æ®
                    if (bgImage && bgImage.startsWith('url(')) {
                        // ä» url('...') æ ¼å¼ä¸­æå–å®é™…çš„å›¾ç‰‡URL/Base64
                        const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
                        allContacts[contactIndex].chatBackground = urlMatch ? urlMatch[1] : null;
                    } else {
                        allContacts[contactIndex].chatBackground = null;
                    }
                    // åŒæ—¶ä¿æŒ backgroundImage å±æ€§ä»¥å…¼å®¹æ—§æ•°æ®
                    allContacts[contactIndex].backgroundImage = allContacts[contactIndex].chatBackground;

                    // åˆ†åˆ«ä¿å­˜AIå’Œç”¨æˆ·çš„æŒ‚ä»¶è®¾ç½®
                    allContacts[contactIndex].ai.avatarPendant = {
                        url: aiPendantUrlInput.value.trim(),
                        css: aiPendantCssInput.value.trim()
                    };
                    if (!allContacts[contactIndex].user.avatarPendant) allContacts[contactIndex].user.avatarPendant = {};
                    allContacts[contactIndex].user.avatarPendant = {
                        url: userPendantUrlInput.value.trim(),
                        css: userPendantCssInput.value.trim()
                    };

                    // ã€é‡æ„ã€‘ä¿å­˜ä¸–ç•Œä¹¦å…³è”
                    // renderWorldBookMultiselect å·²ç»æ›´æ–°äº† currentOpenContact.linkedWorldBookIds
                    // æˆ‘ä»¬åªéœ€å°†å…¶æŒä¹…åŒ–åˆ°æ•°æ®åº“å¯¹è±¡ä¸­
                    allContacts[contactIndex].linkedWorldBookIds = currentOpenContact.linkedWorldBookIds || [];
                    // æ¸…ç†ä¸å†ä½¿ç”¨çš„ç»„å­—æ®µ
                    delete allContacts[contactIndex].linkedWorldBookGroupIds;

                    // æ›´æ–°å½“å‰å†…å­˜ä¸­çš„å¯¹è±¡
                    currentOpenContact = allContacts[contactIndex];
                } else {
                    // å¦‚æœå› ä¸ºæŸäº›åŸå› æ‰¾ä¸åˆ°è”ç³»äººï¼Œå°±åœæ­¢å¹¶æŠ¥é”™ã€‚
                    throw new Error("åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è¦ä¿å­˜çš„è”ç³»äººã€‚");
                }

                // æ­¥éª¤ 4: å°†æ•´ä¸ªä¿®æ”¹åçš„ 'allContacts' æ•°ç»„å®Œæ•´åœ°ä¿å­˜å›æ•°æ®åº“ã€‚
                await dbHelper.saveData('messageContacts', 'allContacts', allContacts);

                // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒæ­¥æ›´æ–°å…¨å±€ç¼“å­˜ï¼Œé˜²æ­¢åç»­æ“ä½œï¼ˆå¦‚å‘é€æ¶ˆæ¯ï¼‰ä½¿ç”¨æ—§çš„ç¼“å­˜æ•°æ®è¦†ç›–æ–°è®¾ç½®
                Global_AllContactsCache = allContacts;

                // --- ä¿®å¤ç»“æŸ ---

                // =================================================
                // ğŸ”¥ã€æ ¸å¿ƒæ’å…¥ã€‘æ£€æµ‹æ˜¯å¦éœ€è¦åŒæ­¥ WOW ç•Œé¢ ğŸ”¥
                // =================================================

                // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœå½“å‰ä¿å­˜çš„è§’è‰² ID == å½“å‰ç™»å½• WOW çš„è§’è‰² ID
                if (typeof currentWowContact !== 'undefined' && currentWowContact && String(currentWowContact.id) === String(currentOpenContact.id)) {
                    console.log("æ£€æµ‹åˆ° WOW èº«ä»½ä¿¡æ¯å˜æ›´ï¼Œæ­£åœ¨åŒæ­¥...");

                    // 1. æ›´æ–°å†…å­˜ä¸­çš„ WOW èº«ä»½
                    currentWowContact = currentOpenContact;

                    // 2. åˆ·æ–° WOW é¡¶æ å¤´åƒ
                    const wowHeaderAvatar = document.getElementById('wow-current-avatar');
                    if (wowHeaderAvatar) wowHeaderAvatar.src = currentOpenContact.user.avatar;

                    // 3. åˆ·æ–° WOW ä¸ªäººä¸­å¿ƒç•Œé¢
                    if (typeof updateWowProfileUI === 'function') {
                        updateWowProfileUI();
                    }

                    // 4. åˆ·æ–° WOW ä¿¡æ¯æµ
                    if (typeof renderWowFeed === 'function') {
                        renderWowFeed();
                    }
                }
                // =================================================

                // ç°åœ¨ï¼Œä½ å…¶ä½™çš„UIæ›´æ–°ä»£ç å¯ä»¥ç…§å¸¸è¿è¡Œã€‚
                // å®ƒä»¬ä¼šä½¿ç”¨åˆšåˆšè¢«æ›´æ–°è¿‡çš„ 'currentOpenContact' å¯¹è±¡ã€‚
                applyChatViewSettings(currentOpenContact);
                chatContactName.textContent = currentOpenContact.ai.name;

                // æ›´æ–°ä¸»æ¶ˆæ¯åˆ—è¡¨ä¸­çš„åç§°å’Œå¤´åƒ
                const contactItemInList = contactList.querySelector(`.contact-item[data-contact-id="${currentOpenContact.id}"]`);
                if (contactItemInList) {
                    contactItemInList.querySelector('.contact-name').textContent = currentOpenContact.ai.name;
                    contactItemInList.querySelector('.contact-avatar').src = currentOpenContact.ai.avatar;
                }

                // åˆ·æ–°å…¨å±€å¤´åƒç¼“å­˜ (ç¡®ä¿æ‰€æœ‰æ°”æ³¡å¤´åƒå˜äº†)
                if (typeof refreshGlobalAvatarMap === 'function') {
                    refreshGlobalAvatarMap(currentOpenContact);
                }

                // ã€æ ¸å¿ƒä¿®å¤ã€‘é‡æ–°æ¸²æŸ“èŠå¤©æ¶ˆæ¯ï¼Œä½¿åŒè¯­æ°”æ³¡ã€æ—¶é—´æˆ³ç­‰è®¾ç½®ç«‹å³ç”Ÿæ•ˆ
                try {
                    const contactKey = `messages_${currentOpenContact.id}`;
                    const chatData = await dbHelper.loadData('chatMessages', contactKey);
                    const history = (chatData && Array.isArray(chatData.value)) ? chatData.value : [];
                    
                    // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“æ¶ˆæ¯
                    const fragment = document.createDocumentFragment();
                    const messagesToRender = history.slice(-30); // åªæ¸²æŸ“æœ€å30æ¡
                    
                    // ä¿ç•™"æŸ¥çœ‹æ›´æ—©æ¶ˆæ¯"æŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const loadMoreBtn = chatMessagesContainer.querySelector('#load-more-messages-btn');
                    chatMessagesContainer.innerHTML = '';
                    if (loadMoreBtn) {
                        chatMessagesContainer.appendChild(loadMoreBtn);
                    } else if (history.length > 30) {
                        // å¦‚æœæ¶ˆæ¯è¶…è¿‡30æ¡ä½†æ²¡æœ‰æŒ‰é’®ï¼Œé‡æ–°åˆ›å»º
                        const newLoadMoreBtn = document.createElement('button');
                        newLoadMoreBtn.id = 'load-more-messages-btn';
                        newLoadMoreBtn.textContent = 'æŸ¥çœ‹æ›´æ—©çš„æ¶ˆæ¯';
                        newLoadMoreBtn.addEventListener('click', loadMoreMessages);
                        chatMessagesContainer.appendChild(newLoadMoreBtn);
                    }
                    
                    messagesToRender.forEach(message => {
                        addMessageToView(message, currentOpenContact, fragment);
                    });
                    chatMessagesContainer.appendChild(fragment);
                    
                    // é‡æ–°åº”ç”¨æ ·å¼
                    initializeChatStyles(currentOpenContact);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                    
                    console.log('èŠå¤©æ¶ˆæ¯å·²åˆ·æ–°ï¼Œè®¾ç½®å·²ç”Ÿæ•ˆ');
                } catch (refreshError) {
                    console.warn('åˆ·æ–°æ¶ˆæ¯å¤±è´¥ï¼Œéœ€è¦é€€å‡ºé‡è¿›:', refreshError);
                }

                closeChatSettingsModal();
                alert('è®¾ç½®å·²æˆåŠŸä¿å­˜ï¼');


            } catch (error) {
                console.error("ä¿å­˜èŠå¤©è®¾ç½®å¤±è´¥:", error);
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        });
    }



    const blockContactBtn = document.getElementById('block-contact-btn');

    blockContactBtn.addEventListener('click', async () => {
        if (!currentOpenContact) return;

        // Toggle the blocked state
        const wasBlocked = currentOpenContact.isBlocked;
        currentOpenContact.isBlocked = !wasBlocked;

        if (currentOpenContact.isBlocked) {
            // --- Logic for BLOCKING the contact ---
            if (confirm(`ç¡®å®šè¦æ‹‰é»‘ ${currentOpenContact.ai.name} å—ï¼Ÿ`)) {
                // Initialize the hidden messages array
                currentOpenContact.hiddenMessagesOnBlock = [];
                await saveCurrentContactToDatabase();

                // Update UI in the modal
                blockContactBtn.textContent = 'è§£é™¤é™åˆ¶';
                blockContactBtn.classList.remove('purple-button');
                blockContactBtn.classList.add('danger-button');

                // Update UI in the chat header
                const blockNotice = document.getElementById('block-status-notice');
                blockNotice.textContent = `ä½ å·²æ‹‰é»‘ ${currentOpenContact.ai.name}`;
                blockNotice.style.display = 'block';

                // Silently call the AI
                console.log("Silently telling AI it has been blocked...");
                await callAI("[ç³»ç»Ÿæç¤ºï¼šä½ å·²è¢«å¯¹æ–¹æ‹‰é»‘]", currentOpenContact, { isBlockingAction: true });

                alert(`${currentOpenContact.ai.name} å·²è¢«æ‹‰é»‘ã€‚`);

            } else {
                // User cancelled, revert the state
                currentOpenContact.isBlocked = wasBlocked;
            }
        } else {
            // --- Logic for UNBLOCKING the contact ---

            // 1. Unblock the contact in memory
            currentOpenContact.isBlocked = false;

            // â–¼â–¼â–¼ START: æ›¿æ¢æ—§çš„ unblocking logic â–¼â–¼â–¼
            // 2. Process and display the hidden messages
            if (Array.isArray(currentOpenContact.hiddenMessagesOnBlock)) {
                // We need to process these messages one by one
                for (const hiddenMsg of currentOpenContact.hiddenMessagesOnBlock) {
                    if (hiddenMsg.rawResponse) {
                        // This is a simplified version of executePlainTextResponse
                        const commands = hiddenMsg.rawResponse.split('\n').filter(line => line.trim() !== '');
                        for (const command of commands) {
                            // You can expand this to handle stickers, voice, etc. if needed
                            // For now, we'll assume it's text.
                            const textMatch = command.match(/^(?:è¯­éŸ³ï¼š)?(.+)/);
                            if (textMatch) {
                                const text = textMatch[1].trim()
                                    .replace(/\nçŠ¶æ€ï¼š.*/, '')
                                    .replace(/\nå†…å¿ƒç‹¬ç™½ï¼š.*/, '');

                                const aiMessage = {
                                    sender: 'ai',
                                    text: text,
                                    timestamp: new Date(), // Use current time for simplicity
                                    uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                    showBlockedWarning: true // Add the special flag!
                                };

                                // Save and display this processed message
                                await saveMessageToHistory(aiMessage, currentOpenContact.id);
                                addMessageToView(aiMessage, currentOpenContact);
                            }
                        }
                    }
                }
            }
            // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

            // 3. Clear the hidden messages array
            currentOpenContact.hiddenMessagesOnBlock = [];

            // 4. Save everything to the database
            await saveCurrentContactToDatabase();

            // 5. Update UI in the modal
            blockContactBtn.textContent = 'æ‹‰é»‘è¯¥è”ç³»äºº';
            blockContactBtn.classList.remove('danger-button');
            blockContactBtn.classList.add('purple-button');

            // 6. Update UI in the chat header
            document.getElementById('block-status-notice').style.display = 'none';

            // 7. Add a system notification to the chat
            await showSystemNotification("ä½ å·²è§£é™¤æ‹‰é»‘", currentOpenContact.id);

            alert(`${currentOpenContact.ai.name} å·²è§£é™¤æ‹‰é»‘ã€‚`);
        }
    });
    // â–²â–²â–² ç²˜è´´åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²

    // â–¼â–¼â–¼ ä½¿ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬å®Œæ•´æ›¿æ¢æ—§çš„ applyChatViewSettings å‡½æ•° â–¼â–¼â–¼

    /**
     * ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘åº”ç”¨æ‰€æœ‰èŠå¤©è§†å›¾çš„ä¸ªæ€§åŒ–è®¾ç½®ï¼Œå¹¶å®æ—¶åˆ·æ–°æŒ‚ä»¶
     * @param {object} contact - åŒ…å«æœ€æ–°è®¾ç½®çš„è”ç³»äººå¯¹è±¡
     */
    // â–¼â–¼â–¼ ä½¿ç”¨è¿™ä¸ªã€æœ€ç»ˆå®Œç¾ç‰ˆã€‘ï¼Œå®Œæ•´æ›¿æ¢ä½ ç°æœ‰çš„ applyChatViewSettings å‡½æ•° â–¼â–¼â–¼

    /**
     * ã€æœ€ç»ˆå®Œç¾ç‰ˆã€‘åº”ç”¨æ‰€æœ‰èŠå¤©è§†å›¾çš„ä¸ªæ€§åŒ–è®¾ç½®ï¼Œå¹¶å®æ—¶åˆ·æ–°å¤´åƒã€æŒ‚ä»¶ç­‰æ‰€æœ‰å¯è§å…ƒç´ 
     * @param {object} contact - åŒ…å«æœ€æ–°è®¾ç½®çš„è”ç³»äººå¯¹è±¡
     */
    function applyChatViewSettings(contact) {
        // åº”ç”¨æ°”æ³¡æ ·å¼ (é€»è¾‘ä¸å˜)
        customBubbleStyles.innerHTML = contact.customBubbleCss || defaultBubbleCss;

        // ã€ä¿®å¤ã€‘åº”ç”¨èŠå¤©èƒŒæ™¯ - ç»Ÿä¸€ä½¿ç”¨ chatMessagesContainer (ä¸ initializeChatStyles ä¿æŒä¸€è‡´)
        // ä¼˜å…ˆä½¿ç”¨ chatBackgroundï¼Œå‘åå…¼å®¹ backgroundImage
        const bgToApply = contact.chatBackground || contact.backgroundImage;
        if (bgToApply) {
            chatMessagesContainer.style.backgroundImage = `url('${bgToApply}')`;
            chatMessagesContainer.style.backgroundSize = 'cover';
            chatMessagesContainer.style.backgroundPosition = 'center';
            chatMessagesContainer.style.backgroundRepeat = 'no-repeat';
        } else {
            // æ¸…é™¤èƒŒæ™¯ï¼Œæ¢å¤é»˜è®¤
            chatMessagesContainer.style.backgroundImage = '';
            chatMessagesContainer.style.backgroundSize = '';
            chatMessagesContainer.style.backgroundPosition = '';
            chatMessagesContainer.style.backgroundRepeat = '';
        }

        // åº”ç”¨å¤´åƒæ˜¾ç¤º/åœ†è§’è®¾ç½® (é€»è¾‘ä¸å˜)
        const avatarSettings = contact.avatarSettings || { show: true, radius: '50%' };
        chatMessagesContainer.classList.toggle('hide-avatars', !avatarSettings.show);

        // â–¼â–¼â–¼ ã€æ ¸å¿ƒä¿®å¤ã€‘éå†å½“å‰æ‰€æœ‰æ¶ˆæ¯è¡Œï¼Œå¹¶åˆ·æ–°å®ƒä»¬çš„å¤´åƒå’ŒæŒ‚ä»¶ â–¼â–¼â–¼
        const allMessageRows = document.querySelectorAll('#chat-messages-container .message-row');
        allMessageRows.forEach(row => {
            // --- 1. åˆ·æ–°å¤´åƒå›¾ç‰‡å’Œåœ†è§’ ---
            const avatarElement = row.querySelector('.chat-avatar');
            if (avatarElement) {
                // æ ¹æ®æ¶ˆæ¯è¡Œæ˜¯'user'è¿˜æ˜¯'ai'æ¥å†³å®šç”¨å“ªä¸ªæ–°å¤´åƒURL
                if (row.querySelector('.message-content-wrapper.user')) {
                    avatarElement.src = contact.user.avatar; // åº”ç”¨ç”¨æˆ·æ–°å¤´åƒ
                } else {
                    avatarElement.src = contact.ai.avatar;   // åº”ç”¨AIæ–°å¤´åƒ
                }
                // åŒæ—¶åˆ·æ–°åœ†è§’
                avatarElement.style.borderRadius = avatarSettings.radius;
            }

            // --- 2. åˆ·æ–°æŒ‚ä»¶ (è°ƒç”¨æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„è¾…åŠ©å‡½æ•°) ---
            updatePendantForMessageRow(row, contact);
        });
        // â–²â–²â–² ã€æ ¸å¿ƒä¿®å¤ã€‘ç»“æŸ â–²â–²â–²

        // åº”ç”¨æŒ‚ä»¶çš„è‡ªå®šä¹‰CSS (é€»è¾‘ä¸å˜)
        let finalPendantCss = '';
        if (contact.ai.avatarPendant && contact.ai.avatarPendant.css) {
            finalPendantCss += `#chat-screen.contact-${contact.id} .message-content-wrapper.ai .avatar-pendant { ${contact.ai.avatarPendant.css} } \n`;
        }
        if (contact.user.avatarPendant && contact.user.avatarPendant.css) {
            finalPendantCss += `#chat-screen.contact-${contact.id} .message-content-wrapper.user .avatar-pendant { ${contact.user.avatarPendant.css} } \n`;
        }
        customPendantStyles.innerHTML = finalPendantCss;
    }
    /**
     * æ–°å¢ï¼šå‡€åŒ–æ¶ˆæ¯æ–‡æœ¬ï¼Œç”¨äºåœ¨è”ç³»äººåˆ—è¡¨ç”Ÿæˆé¢„è§ˆ
     * @param {string} text - åŸå§‹æ¶ˆæ¯æ–‡æœ¬
     * @returns {string} - æ¸…ç†æ‰ç‰¹æ®Šæ ‡ç­¾åçš„é¢„è§ˆæ–‡æœ¬
     */
    // === cleanMessageForPreview (V2 - å·²æ”¯æŒHTML) ===
function cleanMessageForPreview(text) {
    if (typeof text !== 'string') return '';

    if (isHtmlString(text)) {
        // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯è½¬è´¦å¡ç‰‡çš„ç®€ç•¥æ–‡æœ¬
        if (text.includes('transfer-card')) return '[è½¬è´¦]';
        return '[HTMLæ¶ˆæ¯]';
    }

    if (text.includes('[STICKER_START]') || text.includes('è¡¨æƒ…åŒ…ï¼š')) {
        return '[è¡¨æƒ…åŒ…]';
    }
    
    const messageMatch = text.match(/\[MESSAGE_START\]([\s\S]*?)\[MESSAGE_END\]/);
    if (messageMatch && messageMatch[1]) {
        return messageMatch[1].trim();
    }

    // åŒ¹é… "è½¬è´¦ï¼š50-å¤‡æ³¨" æˆ– "[è½¬è´¦ï¼š50]"
    if (/^\[?è½¬è´¦[:ï¼š]/.test(text)) {
        return '[è½¬è´¦]';
    }
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    if (text.includes('å‘æœ‹å‹åœˆï¼š')) {
        return '[æœ‹å‹åœˆåŠ¨æ€]';
    }
    if (text.includes('å¼•ç”¨å›å¤ï¼š')) {
        return '[å¼•ç”¨å›å¤]';
    }

    return text;
}


    // === ã€ä¿®å¤ã€‘ä¸‡èƒ½æ–‡æœ¬æ ¼å¼åŒ–ï¼šæ”¯æŒ *åŠ¨ä½œ* å’Œ (åŠ¨ä½œ:...)ï¼Œä¸”ä¸åå­— ===
    function formatActionText(text) {
        if (!text) return '';

        // 1. å®‰å…¨è½¬ä¹‰ (é˜²æ­¢ HTML æ³¨å…¥)
        let safeText = text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

        // 2. ã€æ ¸å¿ƒã€‘ç»Ÿä¸€æ ¼å¼åŒ– (å¢åŠ å®¹é”™ç‡)

        // æƒ…å†µAï¼šåŒ¹é… *åŠ¨ä½œ* (æ ‡å‡†æ ¼å¼)
        safeText = safeText.replace(/\*([^*]+)\*/g, '<span style="color: #888; font-style: italic;">* $1 *</span>');

        // æƒ…å†µBï¼šåŒ¹é… (æˆ‘æ‰§è¡Œäº†åŠ¨ä½œï¼š...) æˆ– ï¼ˆæ—ç™½ï¼š...ï¼‰ (å®¹é”™æ ¼å¼)
        // è¿™ä¸ªæ­£åˆ™ä¼šæå–å†’å·åé¢çš„å†…å®¹ï¼Œå¹¶ç»Ÿä¸€æ˜¾ç¤ºä¸º * å†…å®¹ * çš„æ ·å¼
        safeText = safeText.replace(/[\(ï¼ˆ]\s*(?:æˆ‘æ‰§è¡Œäº†)?(?:åŠ¨ä½œ|æ—ç™½)(?:\/æ—ç™½)?\s*[:ï¼š]\s*(.*?)\s*[)ï¼‰]/g,
            '<span style="color: #888; font-style: italic;">* $1 *</span>');

        // æƒ…å†µCï¼šåŒ¹é…çº¯æ‹¬å· (åŠ¨ä½œ) - å¯é€‰ï¼Œé˜²æ­¢AIå¶å°”ç”¨æ‹¬å·
        // safeText = safeText.replace(/[\(ï¼ˆ]([^)ï¼‰]+)[\)ï¼‰]/g, '<span style="color: #888; font-style: italic;">($1)</span>');

        return safeText;
    }

    /**
    * åŠŸèƒ½ï¼šå°†æ¶ˆæ¯æ·»åŠ åˆ°è§†å›¾ä¸­
    */
    // ==========================================================
    // === addMessageToView ===
    // ==========================================================


    function addMessageToView(message, contact = null, container = null) {
    const targetContainer = container || chatMessagesContainer;
    if (!message) return null;

    // 1. ç³»ç»Ÿæ¶ˆæ¯ç›´æ¥æ¸²æŸ“
    if (message.type === 'system') {
        const notification = document.createElement('div');
        notification.className = 'system-notification';
        notification.textContent = message.text;
        targetContainer.appendChild(notification);
        return notification;
    }
    // å¿½ç•¥é€šè¯æ‘˜è¦ï¼ˆå¦‚æœæœ‰ç‹¬ç«‹é€»è¾‘å¤„ç†çš„è¯ï¼‰
    if (message.type === 'call_summary') return null;
    // å¿½ç•¥éšè—æ¶ˆæ¯ï¼ˆç”¨äº AI é€šçŸ¥ä½†ä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼‰
    if (message.isHidden) return null;

    const activeContact = contact || currentOpenContact;
    const settings = (activeContact && activeContact.avatarSettings) || { show: true, radius: '50%' };
    const isUserSender = (message.sender === 'user');
    const isGroup = activeContact && currentOpenGroup && activeContact.id === currentOpenGroup.id;

    // --- åˆ›å»ºæ¶ˆæ¯è¡Œç»“æ„ ---
    const row = document.createElement('div');
    row.className = 'message-row';
    // ç»‘å®š ID ç”¨äºæ ·å¼æ³¨å…¥å’ŒæŸ¥æ‰¾
    row.dataset.senderId = isUserSender ? 'user-me' : activeContact.id;
    if (message.uuid) row.dataset.uuid = message.uuid;
    if (message.showBlockedWarning) row.classList.add('show-blocked-warning');

    // åŠ¨ä½œ/æ—ç™½æ¶ˆæ¯ (ç‰¹æ®Šå¤„ç†ï¼šå±…ä¸­ç°è‰²å°å­—)
    if (message.type === 'action') {
        const actionContainer = document.createElement('div');
        actionContainer.className = 'action-message-container';
        actionContainer.innerHTML = `<div class="action-message-text">${message.text}</div>`;
        
        row.className = 'message-row action-row'; // ç‰¹æ®Šç±»å
        row.style.justifyContent = 'center';
        row.appendChild(actionContainer);
        targetContainer.appendChild(row);
        return row;
    }

    // === å®šä½æ¶ˆæ¯ç‰¹æ®Šå¤„ç†ï¼ˆç‹¬ç«‹å¡ç‰‡ + ç”¨æˆ·å¤´åƒï¼‰===
    if (message.type === 'location') {
        const userAvatar = activeContact?.user?.avatar || 'https://via.placeholder.com/36';
        
        row.className = 'message-row location-message';
        row.dataset.uuid = message.uuid;
        row.dataset.senderId = 'user-me';
        
        // åˆ›å»ºæ¶ˆæ¯åŒ…è£…å™¨ï¼ˆç›´æ¥ä½¿ç”¨ä¿å­˜çš„ HTMLï¼‰
        const wrapper = document.createElement('div');
        wrapper.className = 'message-content-wrapper user';
        wrapper.innerHTML = message.text; // message.text å­˜å‚¨çš„æ˜¯å¡ç‰‡ HTML
        
        // åˆ›å»ºå¤´åƒå…ƒç´ 
        const avatarWrapper = document.createElement('div');
        avatarWrapper.className = 'chat-avatar-wrapper';
        // ä¿®å¤ï¼šåº”ç”¨ settings.radius
        const avatarRadius = settings.radius || '50%';
        avatarWrapper.innerHTML = `<img class="chat-avatar" style="border-radius: ${avatarRadius};" src="${userAvatar}" alt="ç”¨æˆ·å¤´åƒ">`;
        
        row.appendChild(wrapper);
        row.appendChild(avatarWrapper);
        targetContainer.appendChild(row);
        return row;
    }

    // === å¿½ç•¥å®šä½æç¤ºæ¶ˆæ¯ï¼ˆä»…ä¾› AI ä¸Šä¸‹æ–‡ï¼Œä¸æ˜¾ç¤ºï¼‰===
    if (message.type === 'location_hint' || message.hidden) {
        return null;
    }

    // --- åˆ›å»ºå¤´åƒä¸é”šç‚¹ ---
    const anchor = document.createElement('div');
    anchor.className = 'avatar-anchor';

    const avatar = document.createElement('img');
    avatar.className = 'chat-avatar';
    avatar.style.borderRadius = settings.radius;
    avatar.src = isUserSender 
        ? ((activeContact && activeContact.user) ? activeContact.user.avatar : '')
        : ((activeContact && activeContact.ai) ? activeContact.ai.avatar : '');
    
    // å¤´åƒç‚¹å‡»äº‹ä»¶æ•°æ®
    avatar.dataset.action = 'edit-bubble-style';
    avatar.dataset.isUser = isUserSender;
    if (activeContact) avatar.dataset.memberId = activeContact.id;

    anchor.appendChild(avatar);
    updatePendantForMessageRow(anchor, activeContact, isUserSender); // æŒ‚è½½æŒ‚ä»¶

    const wrapper = document.createElement('div');
    wrapper.className = 'message-content-wrapper';
    wrapper.classList.add(isUserSender ? 'user' : 'ai');

    // --- åˆ›å»ºæ—¶é—´æˆ³ (å¦‚æœå¼€å¯) ---
    let timestampHtml = '';
    const showTime = (activeContact && activeContact.timestampSettings && activeContact.timestampSettings.show);
    if (showTime && message.timestamp) {
        const date = new Date(message.timestamp);
        const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-timestamp';
        timeDiv.textContent = timeStr;
        timestampHtml = timeDiv;
    }

    // --- æ ¸å¿ƒï¼šå†…å®¹æ¸²æŸ“é€»è¾‘ ---
    let contentElement = null;
    let rawText = message.text || '';

    // 1. HTML æ¶ˆæ¯ (æœ€é«˜ä¼˜å…ˆçº§)
    // 1. HTML æ¶ˆæ¯ (æœ€é«˜ä¼˜å…ˆçº§)
    // 1. HTML æ¶ˆæ¯ (æœ€é«˜ä¼˜å…ˆçº§)
    // 1. HTML æ¶ˆæ¯ (æœ€é«˜ä¼˜å…ˆçº§)
    if (message.type === 'html' && message.content) {
        wrapper.classList.add('is-html-content');
        wrapper.classList.add('is-html-content');
        
        // --- æ ¸å¿ƒä¿®å¤ï¼šShadow DOM æ¸²æŸ“ (Direct Rendering) ---
        // å½»åº•è§£å†³ iframe çš„ "ç›’å­æ„Ÿ" å’Œé«˜åº¦è®¡ç®—é—®é¢˜ï¼ŒåƒåŸç”Ÿå¡ç‰‡ä¸€æ ·æ¸²æŸ“
        
        const shadowContainer = document.createElement('div');
        shadowContainer.className = 'html-render-container html-shadow-card';
        // å®¹å™¨è®¾ç½®ï¼šå®½åº¦100%è·Ÿéšæ°”æ³¡ï¼Œé«˜åº¦è‡ªé€‚åº”
        shadowContainer.style.width = '100%';
        shadowContainer.style.minWidth = '200px'; 
        // ã€å…³é”®ä¿®å¤ã€‘ç§»é™¤åœ†è§’å’Œæº¢å‡ºéšè—ï¼Œå…è®¸å¡ç‰‡è‡ªå®šä¹‰å½¢çŠ¶ï¼ˆå¦‚æ‹±å½¢ï¼‰ä¸”ä¸è¢«è£åˆ‡
        shadowContainer.style.display = 'block';
        
        // 1. åˆ›å»º Shadow Root
        const shadow = shadowContainer.attachShadow({mode: 'open'});
        
        // 2. å‡†å¤‡å†…å®¹å’Œæ ·å¼æ¸…æ´—
        // ç”¨æˆ· CSS ä¸­å¸¸å–œæ¬¢ç”¨ height: 100vhï¼Œè¿™åœ¨æ°”æ³¡é‡Œæ˜¯ç¾éš¾ï¼Œå¿…é¡»è¦†ç›–
        const styleReset = `
            <style>
                :host { 
                    display: block; 
                    width: 100%;
                    /* ç§»é™¤æ‰€æœ‰å®¹å™¨çº§çº¦æŸï¼Œå®Œå…¨äº¤ç»™å†…éƒ¨ HTML å†³å®š */
                    background: transparent;
                    border-radius: 0;
                    overflow: visible;
                }
                /* å¼ºåˆ¶é‡ç½® body æ ·å¼ï¼Œä½¿å…¶è¡¨ç°å¾—åƒä¸€ä¸ªæ™®é€šçš„ div */
                body { 
                    margin: 0 !important; 
                    padding: 0 !important;
                    height: auto !important; 
                    min-height: auto !important;
                    width: 100% !important;
                    overflow: visible !important;
                    background: transparent !important;
                    display: block !important;
                    position: relative !important;
                }
                /* ç¡®ä¿å®¹å™¨å‚ç›´å±…ä¸­é€»è¾‘è¢«è½¬æ¢ä¸ºæ™®é€šæµå¸ƒå±€ï¼Œæˆ–è€…ä¿ç•™ flex ä½†å»æ‰å…¨å±é«˜åº¦ */
                body {
                    display: flex !important;
                    flex-direction: column !important;
                    justify-content: center !important;
                    align-items: center !important;
                }
                /* ç¡®ä¿å›¾ç‰‡è‡ªé€‚åº” */
                img { max-width: 100%; height: auto; }
            </style>
        `;
        
        // 3. æ³¨å…¥å†…å®¹
        // Shadow DOM è‡ªåŠ¨éš”ç¦»æ ·å¼ï¼Œä¸ä¼šæ±¡æŸ“å¤–éƒ¨ï¼Œå¤–éƒ¨ä¹Ÿä¸ä¼šè½»æ˜“æ±¡æŸ“å†…éƒ¨
        try {
            shadow.innerHTML = styleReset + (message.content.html || '');
        } catch(e) {
            shadow.innerHTML = '<div style="color:red;padding:10px;">HTML æ¸²æŸ“å¤±è´¥</div>';
        }

        contentElement = shadowContainer;
        
        // æ— éœ€ä»»ä½•é«˜åº¦è®¡ç®—è„šæœ¬ï¼ŒDOM ä¼šè‡ªåŠ¨æ’‘å¼€ï¼

     } else if ((message.type === 'sticker' || message.type === 'image') && message.url) {
        contentElement = document.createElement('img');
        const bubbleClass = message.type === 'image' ? 'image-bubble' : 'sticker-bubble';
        contentElement.className = `chat-bubble ${bubbleClass}`;
        contentElement.src = message.url;
        contentElement.loading = 'lazy';
    }
    // 3. æ–‡å›¾å¡ç‰‡ (æ–°åŠŸèƒ½)
    else if (message.type === 'text-image') {
        const modalId = 'text-image-modal-overlay';
        
        // 0. (CSS Injection) - åŒ…å«å¡ç‰‡æ ·å¼ + å¼¹çª—æ ·å¼
        if (!document.getElementById('text-image-card-styles')) {
            const style = document.createElement('style');
            style.id = 'text-image-card-styles';
            style.textContent = `
            :root {
                --london-bg: #EAEFF2; 
                --london-card: #FFFFFF;
                --london-border: rgba(69, 73, 77, 0.12);
                --london-shadow-soft: 0 2px 6px rgba(69, 73, 77, 0.04);
                --london-shadow: 0 4px 12px rgba(69, 73, 77, 0.08);
            }
            .text-image-card {
                width: 120px;
                height:130px;
                background: var(--london-card);
                border: 1px solid var(--london-border);
                border-radius: 14px;
                box-shadow: var(--london-shadow-soft);
                overflow: hidden; 
                margin-top: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 16px; 
                box-sizing: border-box;
                transition: all 0.3s ease;
                cursor: pointer;
                position: relative;
                /* ç¡®ä¿å†…éƒ¨ 180px å…ƒç´ èƒ½æ’‘å¼€é«˜åº¦ */
            }
            .text-image-card:hover {
                box-shadow: var(--london-shadow);
                transform: translateY(-1px);
            }
            
            /* æ ¸å¿ƒè§†è§‰å…ƒç´ ï¼š180x180, 10% opacity */
            .text-image-inner-visual {
                width: 180px;
                height: 180px;
                opacity: 0.1; /* ç¡¬æ€§è¦æ±‚ */
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 100px; /* Emoji å°ºå¯¸ */
                line-height: 1;
                user-select: none;
                pointer-events: none; /* ç‚¹å‡»ç©¿é€ç»™å¡ç‰‡ */
            }

            /* --- å¼¹çª—æ ·å¼ --- */
            #${modalId} {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 9999; /* è¶³å¤Ÿé«˜ */
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(4px);
                opacity: 0;
                transition: opacity 0.2s ease;
                pointer-events: none;
                visibility: hidden;
            }
            #${modalId}.active {
                opacity: 1;
                pointer-events: auto;
                visibility: visible;
            }
            .text-image-modal-content {
                background: #FFFFFF;
                width: 85%;
                max-width: 360px;
                padding: 24px;
                padding-top: 40px; /* ç•™å‡ºå…³é—­æŒ‰é’®ç©ºé—´ */
                border-radius: 20px;
                box-shadow: 0 12px 40px rgba(0,0,0,0.15);
                position: relative;
                max-height: 70vh;
                overflow-y: auto;
                transform: scale(0.95);
                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            #${modalId}.active .text-image-modal-content {
                transform: scale(1);
            }
            .text-image-modal-close-btn {
                position: absolute;
                top: 12px;
                right: 12px;
                width: 28px;
                height: 28px;
                cursor: pointer;
                background: #F2F2F7;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #8E8E93;
                font-family: -apple-system, sans-serif;
                font-size: 14px;
                font-weight: bold;
                transition: all 0.2s;
            }
            .text-image-modal-close-btn:hover {
                background: #E5E5EA;
                color: #000;
            }
            .text-image-modal-text-body {
                font-size: 16px;
                line-height: 1.6;
                color: #333;
                white-space: pre-wrap;
                word-wrap: break-word;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            }
            `;
            document.head.appendChild(style);
            
            // æ³¨å…¥å¼¹çª—DOM (å•ä¾‹)
            if (!document.getElementById(modalId)) {
                const modalDiv = document.createElement('div');
                modalDiv.id = modalId;
                modalDiv.innerHTML = `
                    <div class="text-image-modal-content">
                        <div class="text-image-modal-close-btn">âœ•</div>
                        <div class="text-image-modal-text-body" id="text-image-modal-text-target"></div>
                    </div>
                `;
                document.body.appendChild(modalDiv);
                
                // å…³é—­é€»è¾‘
                const closeAction = () => modalDiv.classList.remove('active');
                modalDiv.querySelector('.text-image-modal-close-btn').onclick = closeAction;
                modalDiv.onclick = (e) => { if(e.target === modalDiv) closeAction(); };
            }
        }

        contentElement = document.createElement('div');
        contentElement.className = 'text-image-card'; 
        // æ ¸å¿ƒå±•ç¤ºï¼š180x180 emoji
        contentElement.innerHTML = `
            <div class="text-image-inner-visual">ğŸ“</div> 
        `;
        
        // äº¤äº’ï¼šç‚¹å‡»å¼¹çª—
        contentElement.onclick = (e) => {
             e.stopPropagation(); 
             const modal = document.getElementById(modalId);
             const textTarget = document.getElementById('text-image-modal-text-target');
             if (modal && textTarget) {
                 textTarget.textContent = rawText; 
                 modal.classList.add('active');
             }
        };
    }
    // 4. è¯­éŸ³æ¶ˆæ¯
    else if (message.type === 'voice_text' && message.transcript) {
        contentElement = document.createElement('div');
        contentElement.className = 'voice-message-wrapper';
        const duration = message.duration || Math.ceil(message.transcript.length / 3) || 1;
        const bubbleWidth = Math.min(60 + duration * 5, 200);
        // ä½¿ç”¨æ ‡å‡†æ°”æ³¡æ ·å¼ä»¥æ”¯æŒçš®è‚¤
        const bubbleClass = isUserSender ? 'chat-bubble user-bubble' : 'chat-bubble ai-bubble';
        
        const waveformSvg = `<svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 17.9911C13.9236 17.9911 18 13.9079 18 8.99556C18 4.07447 13.9148 0 8.99119 0C4.07648 0 0 4.07447 0 8.99556C0 13.9079 4.0853 17.9911 9 17.9911ZM9 16.4919C4.83531 16.4919 1.50883 13.1583 1.50883 8.99556C1.50883 4.83292 4.82648 1.49926 8.99119 1.49926C13.1559 1.49926 16.5001 4.83292 16.5001 8.99556C16.5001 13.1583 13.1648 16.4919 9 16.4919Z" fill="currentColor" opacity="0.3"/><path d="M7.35 12.44L12.37 9.47C12.74 9.26 12.73 8.75 12.37 8.53L7.35 5.56C6.97 5.34 6.47 5.5 6.47 5.94V12.06C6.47 12.49 6.94 12.69 7.35 12.44Z" fill="currentColor"/></svg>`;

        contentElement.innerHTML = `
            <div class="${bubbleClass} voice-audio-bubble clickable-voice-bubble" 
                 style="width: ${bubbleWidth}px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                ${waveformSvg}
                <span style="margin-left:6px; font-size:12px;">${duration}"</span>
            </div>
            <div class="voice-text-panel" style="display:none; margin-top:4px; font-size:12px; color:#888;">
                ${message.transcript}
            </div>
        `;
        // ç‚¹å‡»åˆ‡æ¢æ–‡å­—æ˜¾ç¤º
        contentElement.onclick = () => {
            const panel = contentElement.querySelector('.voice-text-panel');
            if(panel) panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        };
    }
    // 5. æ¨¡æ‹Ÿæ–‡ä»¶å¡ç‰‡ (type: 'file_card' æˆ–è€… æ­£åˆ™è§£æ)
    else if (message.type === 'file_card' || /(?:^|\n)\s*å‘é€æ–‡ä»¶ï¼š/.test(rawText)) {
        // å¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼Œå°è¯•è§£æ
        let fileName = "æœªå‘½åæ–‡ä»¶";
        let fileType = "FILE";
        let fileSize = "10 KB";
        
        if (message.type !== 'file_card') {
             // è§£ææ ¼å¼: "å‘é€æ–‡ä»¶ï¼š[ç±»å‹] å†…å®¹ï¼š[...]"
            const fileMatch = rawText.match(/å‘é€æ–‡ä»¶ï¼š([A-Za-z0-9]+)\s+å†…å®¹ï¼š([\s\S]+)/);
            if (fileMatch) {
                fileType = fileMatch[1].toUpperCase();
                const content = fileMatch[2].trim();
                fileName = content.split('\n')[0].substring(0, 15) || "æ–‡æ¡£"; // å–ç¬¬ä¸€è¡Œåšæ–‡ä»¶å
                fileSize = Math.ceil(content.length / 1024) + " KB";
            }
        } else {
            // å¦‚æœå·²ç»æ˜¯å¯¹è±¡
            fileName = message.fileName || "æ–‡ä»¶";
            fileType = message.fileType || "FILE";
            fileSize = message.fileSize || "æœªçŸ¥å¤§å°";
        }

        contentElement = document.createElement('div');
        // ä½¿ç”¨æ–‡ä»¶å¡ç‰‡æ ·å¼å®¹å™¨
        contentElement.className = 'file-card-bubble'; 
        contentElement.style.cssText = "background: white; border-radius: 12px; padding: 12px; width: 220px; display: flex; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); cursor: pointer;";
        
        contentElement.innerHTML = `
            <div style="flex: 1; overflow: hidden;">
                <div style="font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;">${fileName}</div>
                <div style="font-size: 11px; color: #999; margin-top: 4px;">${fileSize}</div>
            </div>
            <div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-left: 10px; font-size: 10px; color: #666; font-weight: bold;">
                ${fileType}
            </div>
        `;
    }
    // 6. å…¶ä»–ç‰¹æ®Šæ–‡æœ¬æŒ‡ä»¤è§£æ
    else {
        // å…ˆå®šä¹‰éœ€è¦çš„æ­£åˆ™ (åŒ¹é… System Prompt å®šä¹‰çš„æ ¼å¼)
        const transferRegex = /(?:^|\n)\s*è½¬è´¦[:ï¼š]([\d.]+)-(.*)/;
        const chatHistoryRegex = /\[CHAT_HISTORY_START\]([\s\S]*?)\[CHAT_HISTORY_END\]/;
        const inviteListenRegex = /(?:^|\n)\s*æ¥å—ä¸€èµ·å¬[:ï¼š]/;
        const callRegex = /(?:^|\n)\s*å‘èµ·é€šè¯[:ï¼š]/;
        const friendCircleRegex = /(?:^|\n)\s*å‘æœ‹å‹åœˆ[:ï¼š]/;
        const commentRegex = /(?:^|\n)\s*è¯„è®ºæœ‹å‹åœˆ[:ï¼š]/;
        const replyRegex = /å¼•ç”¨å›å¤ï¼š(.*?)[:ï¼š](.*?)\s*\|\|\|\s*(.*)/;

        // A. è½¬è´¦å¡ç‰‡
        const transferMatch = rawText.match(transferRegex);
        if (transferMatch) {
            const amount = transferMatch[1];
            const remark = transferMatch[2].trim();
            const msgUuid = message.uuid || Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const status = message.transferStatus || 'pending'; // éœ€è¦ä½ åœ¨å¤–éƒ¨é€»è¾‘å¤„ç†çŠ¶æ€ä¿å­˜

            contentElement = document.createElement('div');
            // æ¸…é™¤é»˜è®¤æ ·å¼ï¼Œå› ä¸º createTransferCardHtml åŒ…å«å®Œæ•´æ ·å¼
            contentElement.style.background = 'transparent';
            contentElement.style.padding = '0';
            // è°ƒç”¨ä½ ä¹‹å‰å†™çš„å¡ç‰‡ç”Ÿæˆå‡½æ•°
            const currentStatus = message.transferStatus || 'pending';
            contentElement.innerHTML = createTransferCardHtml(amount, remark, msgUuid, isUserSender, status);
        }
        // A2. è®¢å•åˆ†äº«å¡ç‰‡
        else if (rawText.startsWith('[ORDER_SHARE_CARD]')) {
            try {
                const jsonStr = rawText.substring('[ORDER_SHARE_CARD]'.length);
                const orderData = JSON.parse(jsonStr);
                
                // ç”Ÿæˆå•†å“åˆ—è¡¨HTML
                const itemsHtml = (orderData.items || []).map(item => 
                    `<div class="order-item">â€¢ ${item.name}</div>`
                ).join('');
                
                // æ ¼å¼åŒ–æ—¶é—´
                const orderDate = new Date(orderData.purchaseDate);
                const dateStr = orderDate.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                contentElement = document.createElement('div');
                contentElement.className = 'order-share-card-wrapper';
                contentElement.innerHTML = `
                    <div class="order-share-card">
                        <div class="order-card-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 8V16C21 18.7614 18.7614 21 16 21H8C5.23858 21 3 18.7614 3 16V8C3 5.23858 5.23858 3 8 3H16C18.7614 3 21 5.23858 21 8Z" stroke="white" stroke-width="2"/>
                                <path d="M12 8V16M8 12H16" stroke="white" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span>è®¢å•è¯¦æƒ…</span>
                        </div>
                        <div class="order-card-body">
                            <div class="order-section">
                                <div class="order-label">å•†å“</div>
                                <div class="order-items">${itemsHtml}</div>
                            </div>
                            <div class="order-section">
                                <div class="order-label">æ€»é¢</div>
                                <div class="order-value">Â¥${(orderData.totalAmount || 0).toFixed(2)}</div>
                            </div>
                            <div class="order-section">
                                <div class="order-label">æ”¶è´§äºº</div>
                                <div class="order-value">${orderData.recipient ? orderData.recipient.name : 'æœªçŸ¥'}</div>
                            </div>
                            <div class="order-section">
                                <div class="order-label">ä¸‹å•æ—¶é—´</div>
                                <div class="order-value order-date">${dateStr}</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('è§£æè®¢å•æ•°æ®å¤±è´¥:', e);
                // å¦‚æœè§£æå¤±è´¥,æ˜¾ç¤ºä¸ºæ™®é€šæ–‡æœ¬
                contentElement = document.createElement('div');
                contentElement.className = isUserSender ? 'chat-bubble user-bubble' : 'chat-bubble ai-bubble';
                contentElement.textContent = '[è®¢å•å¡ç‰‡è§£æå¤±è´¥]';
            }
        }
        // B. èŠå¤©è®°å½•å¡ç‰‡
        else if (rawText.match(chatHistoryRegex)) {
            const historyMatch = rawText.match(chatHistoryRegex);
            const rawContent = historyMatch[1].trim();
            const lines = rawContent.split('\n').filter(l => l.trim());
            
            let title = "èŠå¤©è®°å½•";
            let previews = [];
            
            // ç®€å•çš„è§£ææ ‡é¢˜é€»è¾‘
            if(lines.length > 0 && lines[0].includes("æ ‡é¢˜ï¼š")) {
                title = lines[0].replace("æ ‡é¢˜ï¼š", "").trim();
                previews = lines.slice(1, 3);
            } else {
                previews = lines.slice(0, 2);
            }

            contentElement = document.createElement('div');
            contentElement.className = 'history-card-bubble';
            contentElement.style.cssText = "background: white; border-radius: 12px; padding: 12px; width: 200px; cursor: pointer; text-align: left; box-shadow: 0 2px 6px rgba(0,0,0,0.05);";
            contentElement.innerHTML = `
                <div style="font-size: 15px; color: #000; margin-bottom: 6px; font-weight: 500;">${title}</div>
                <div style="font-size: 12px; color: #888;">${previews.map(l => `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${l}</div>`).join('')}</div>
                <div style="margin-top: 8px; border-top: 1px solid #f5f5f5; padding-top: 4px; font-size: 10px; color: #ccc;">èŠå¤©è®°å½•</div>
            `;
            // å°†å®Œæ•´å†…å®¹å­˜å…¥ dataset ä¾›ç‚¹å‡»æŸ¥çœ‹
            contentElement.dataset.fullContent = rawContent;
        }
        // C. æœ‹å‹åœˆ/è¯„è®º/é€šè¯ç­‰ (ä½œä¸ºæ™®é€šæ°”æ³¡æ˜¾ç¤ºï¼Œä½†åŠ ä¸ªå›¾æ ‡æˆ–ç‰¹æ®Šæ ·å¼)
        else if (rawText.match(friendCircleRegex) || rawText.match(commentRegex) || rawText.match(inviteListenRegex) || rawText.match(callRegex)) {
            contentElement = document.createElement('div');
             // ä½¿ç”¨æ°”æ³¡æ ·å¼
            contentElement.className = isGroup 
                ? (isUserSender ? 'gp-user-bubble' : 'gp-ai-bubble') 
                : (isUserSender ? 'chat-bubble user-bubble' : 'chat-bubble ai-bubble');
            
            // ç®€å•å¤„ç†ï¼šä¿ç•™åŸå§‹æ–‡æœ¬ï¼Œä½†å¯ä»¥åŠ ä¸ªå‰ç¼€å›¾æ ‡
            let icon = '';
            if (rawText.match(friendCircleRegex)) icon = 'ğŸ“¸ ';
            if (rawText.match(callRegex)) icon = 'ğŸ“ ';
            
            contentElement.innerHTML = icon + formatActionText(rawText);
        }
        // D. å¼•ç”¨å›å¤ (å›å¤å†…å®¹åœ¨ ||| åé¢)
        else if (rawText.match(replyRegex)) {
            const replyMatch = rawText.match(replyRegex);
            const quotedName = replyMatch[1];
            const quotedText = replyMatch[2];
            const myReply = replyMatch[3];

            // åˆ›å»ºå®¹å™¨æ°”æ³¡
            contentElement = document.createElement('div');
            contentElement.className = isGroup 
                ? (isUserSender ? 'gp-user-bubble' : 'gp-ai-bubble') 
                : (isUserSender ? 'chat-bubble user-bubble' : 'chat-bubble ai-bubble');
            
            // æ„å»ºå¼•ç”¨å— HTML
            const quoteHtml = `
                <div class="reply-quote-block" style="margin-bottom:6px; padding:4px 8px; background:rgba(0,0,0,0.05); border-radius:4px; font-size:12px; color:#666; display:flex; flex-direction:column; border-left: 2px solid #ccc;">
                    <span style="font-weight:bold; margin-bottom:2px;">${quotedName}</span>
                    <span style="overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${quotedText}</span>
                </div>
            `;
            
            contentElement.innerHTML = quoteHtml + formatActionText(myReply);
        }
        // E. æ™®é€šæ–‡æœ¬ (é»˜è®¤å…œåº•)
        else {
            // å¤„ç† [MESSAGE_START] ç­‰å¯èƒ½çš„æ®‹ç•™æ ‡ç­¾
            let cleanText = rawText.replace(/\[MESSAGE_START\]([\s\S]*?)\[MESSAGE_END\]/, '$1').trim();
            
            // æ£€æµ‹è¡Œå†…åŒè¯­ [Split] æ ¼å¼ (ä»…å¯¹AIæ¶ˆæ¯ç”Ÿæ•ˆ)
            // æ–°æ ¼å¼: "åŸæ–‡[Split]ç¿»è¯‘" (è¡Œå†…ï¼Œæ— æ¢è¡Œ)
            const splitMatch = cleanText.match(/^(.+?)\[Split\](.+)$/i);
            
            if (splitMatch && currentOpenContact && currentOpenContact.enableBilingualBubble && !isUserSender) {
                // === åŒè¯­æŠ˜å æ°”æ³¡ ===
                const originalText = splitMatch[1].trim();
                const translatedText = splitMatch[2].trim();
                
                // åˆ›å»ºå¤–å±‚ wrapperï¼ˆåŒ…å«æ°”æ³¡ + æŒ‰é’®ï¼‰
                contentElement = document.createElement('div');
                contentElement.className = 'bilingual-wrapper';
                
                contentElement.innerHTML = `
                    <div class="bilingual-bubble chat-bubble ai-bubble">
                        <div class="bilingual-original">${formatActionText(originalText)}</div>
                        <div class="bilingual-divider">
                            <span class="bilingual-divider-line"></span>
                        </div>
                        <div class="bilingual-translation">${formatActionText(translatedText)}</div>
                    </div>
                    <button class="bilingual-toggle-btn" title="æ”¶èµ·/å±•å¼€ç¿»è¯‘">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                            <path d="M7 14l5-5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                `;
                
                // æ·»åŠ æŠ˜å äº¤äº’
                const toggleBtn = contentElement.querySelector('.bilingual-toggle-btn');
                const bubble = contentElement.querySelector('.bilingual-bubble');
                const toggleFunc = (e) => {
                    e.stopPropagation();
                    contentElement.classList.toggle('collapsed');
                };
                toggleBtn.addEventListener('click', toggleFunc);
                bubble.addEventListener('click', toggleFunc);

            } else {
                // === æ™®é€šæ–‡æœ¬æ°”æ³¡ ===
                contentElement = document.createElement('div');
                // æ ¹æ®æ˜¯å•èŠè¿˜æ˜¯ç¾¤èŠé€‰æ‹©ç±»å
                if (isGroup) {
                    contentElement.className = isUserSender ? 'gp-user-bubble' : 'gp-ai-bubble';
                } else {
                    contentElement.className = isUserSender ? 'chat-bubble user-bubble' : 'chat-bubble ai-bubble';
                }
                
                // æ¸²æŸ“æ–‡æœ¬ï¼ˆæ”¯æŒ formatActionText å¤„ç† *åŠ¨ä½œ* å˜ç°ï¼‰
                const formattedText = formatActionText(cleanText);
                contentElement.innerHTML = formattedText;
            }

        }
    }

    // --- ç»„è£…å¹¶æ’å…¥ DOM ---
    if (contentElement) {
        // å¦‚æœæ¶ˆæ¯å¯¹è±¡é‡Œæœ‰ replyTo å­—æ®µï¼ˆéæ–‡æœ¬å†…çš„å¼•ç”¨æ ¼å¼ï¼Œè€Œæ˜¯ç³»ç»Ÿçº§å¼•ç”¨ï¼‰ï¼Œåœ¨è¿™é‡Œå¤„ç†
        if (message.replyTo && !contentElement.querySelector('.reply-quote-block')) {
             const replyBlock = document.createElement('div');
             replyBlock.className = 'reply-quote-container'; // ä½ çš„ CSS ç±»
             replyBlock.innerHTML = `
                <div class="reply-quote-name">${message.replyTo.senderName}</div>
                <div class="reply-quote-text">${message.replyTo.text}</div>
             `;
             // ç‚¹å‡»è·³è½¬
             replyBlock.onclick = (e) => {
                 e.stopPropagation();
                 const target = targetContainer.querySelector(`.message-row[data-uuid="${message.replyTo.uuid}"]`);
                 if (target) {
                     target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     target.classList.add('highlight-anim'); // éœ€å®šä¹‰åŠ¨ç”»
                     setTimeout(()=>target.classList.remove('highlight-anim'), 1000);
                 }
             };
             // æ’å…¥åˆ°æ°”æ³¡å†…å®¹æœ€å‰é¢
             if (contentElement.firstChild) {
                 contentElement.insertBefore(replyBlock, contentElement.firstChild);
             } else {
                 contentElement.appendChild(replyBlock);
             }
        }

        // ã€ä¿®å¤ã€‘æ·»åŠ å¤šé€‰æ¨¡å¼çš„é€‰æ‹©æŒ‡ç¤ºå™¨
        const indicator = document.createElement('div');
        indicator.className = 'selection-indicator';
        row.appendChild(indicator);

        // å°†å¤´åƒé”šç‚¹æ”¾å…¥ wrapper
        wrapper.appendChild(anchor);
        // å°†æ°”æ³¡å†…å®¹æ”¾å…¥ wrapper
        wrapper.appendChild(contentElement);
        // æ”¾å…¥æ—¶é—´æˆ³
        if (timestampHtml) wrapper.appendChild(timestampHtml);

        row.appendChild(wrapper);
        targetContainer.appendChild(row);
    }

    return row;
}

    /**
* 
* ä¿®å¤äº†æ–°æ¶ˆæ¯ä¸æ˜¾ç¤ºæŒ‚ä»¶çš„é—®é¢˜ï¼ŒåŒæ—¶æ”¯æŒæ¥æ”¶â€œæ•´è¡Œâ€æˆ–â€œå•ç‹¬çš„å¤´åƒæ¡†â€
*/
    function updatePendantForMessageRow(containerElement, contact, isUserMsg = null) {
        if (!containerElement || !contact) return;

        // --- å…³é”®ä¿®å¤ç‚¹ Start ---
        // æ—§ç‰ˆæœ¬åªæ‡‚ querySelectorï¼Œæ–°ç‰ˆæœ¬ä¼šå…ˆæ£€æŸ¥ container æœ¬èº«æ˜¯ä¸æ˜¯å°±æ˜¯ avatar-anchor
        let anchor = containerElement.classList.contains('avatar-anchor') ?
            containerElement :
            containerElement.querySelector('.avatar-anchor');
        // --- å…³é”®ä¿®å¤ç‚¹ End ---

        if (!anchor) return;

        // 1. å…ˆç§»é™¤æ—§æŒ‚ä»¶
        const existingPendant = anchor.querySelector('.avatar-pendant');
        if (existingPendant) {
            existingPendant.remove();
        }

        // 2. ç¡®å®šèº«ä»½ (isUserMsg ä¼ è¿›æ¥æ˜¯ true/falseï¼Œæ²¡ä¼ æ˜¯ null)
        let isUser = isUserMsg;

        // å…œåº•ï¼šå¦‚æœæ²¡ä¼ èº«ä»½å‚æ•°ï¼Œå†å» DOM é‡ŒçŒœï¼ˆä¸ºäº†å…¼å®¹â€œé€€å‡ºé‡è¿›â€åçš„åˆ·æ–°ï¼‰
        if (isUser === null) {
            const wrapper = anchor.closest('.message-content-wrapper');
            if (wrapper) {
                isUser = wrapper.classList.contains('user');
            } else {
                // å¦‚æœè¿ wrapper éƒ½æ²¡ç”Ÿæˆï¼Œè¯´æ˜æ˜¯æ–°æ¶ˆæ¯é˜¶æ®µï¼Œä½†å› ä¸ºä¸Šé¢æ²¡ä¼ å‚ï¼Œè¿™é‡Œä¹Ÿæ²¡æ³•æ˜¾ç¤º
                // åªè¦ç¬¬ä¸€æ­¥æ”¹å¯¹äº†ï¼Œè¿™é‡Œä¸ä¼šå‘ç”Ÿ
                return;
            }
        }

        // 3. å–å‡ºå¯¹åº”çš„æŒ‚ä»¶é…ç½®
        let pendantSettings = isUser ? contact.user.avatarPendant : contact.ai.avatarPendant;

        // 4. åˆ›å»ºæŒ‚ä»¶
        if (pendantSettings && pendantSettings.url) {
            const pendant = document.createElement('div');
            pendant.className = 'avatar-pendant';
            pendant.style.backgroundImage = `url('${pendantSettings.url}')`;

            if (pendantSettings.css) {
                pendant.style.cssText += pendantSettings.css;
            }
            anchor.appendChild(pendant);
        }
    }


    // === æ–°å¢ï¼šâ€œæ­£åœ¨è¾“å…¥â€æç¤ºçš„JSå‡½æ•° ===

    /**
     * åŠŸèƒ½ï¼šåœ¨èŠå¤©çª—å£æ˜¾ç¤ºä¸€ä¸ªâ€œæ­£åœ¨è¾“å…¥â€çš„åŠ¨ç”»æ°”æ³¡
     */
    /**
    * åŠŸèƒ½ï¼šåœ¨èŠå¤©çª—å£æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€åŠ¨ç”»ï¼Œå¹¶è¿”å›è¯¥åŠ¨ç”»çš„DOMå…ƒç´ 
    * (å·²ä¿®æ”¹ï¼šç§»é™¤é‡å¤æ£€æŸ¥ï¼Œå¹¶è¿”å›å…ƒç´ æœ¬èº«)
    */
    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢ä½ ç°æœ‰çš„ showTypingIndicator å‡½æ•°

    /**
     * ã€å·²ä¿®å¤ã€‘åŠŸèƒ½ï¼šåœ¨èŠå¤©çª—å£æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€åŠ¨ç”»ï¼Œå¹¶è¿”å›è¯¥åŠ¨ç”»çš„DOMå…ƒç´ 
     * @param {object} contact - ã€æ–°å¢ã€‘æ˜ç¡®æŒ‡å®šæ˜¯å“ªä¸ªAIæ­£åœ¨è¾“å…¥
     * @returns {HTMLElement}
     */
    function showTypingIndicator(contact) {
        if (!contact || !contact.ai) {
            console.error("showTypingIndicator å¤±è´¥ï¼šä¼ å…¥äº†æ— æ•ˆçš„contactå¯¹è±¡ã€‚");
            return null;
        }
        // åªåœ¨å¯¹åº”çš„èŠå¤©çª—å£æ‰“å¼€æ—¶æ‰æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€
        if (currentOpenContact && currentOpenContact.id === contact.id) {
            const row = document.createElement('div');
            row.className = 'message-row ai typing-indicator';
            const indicator = document.createElement('div');
            indicator.className = 'selection-indicator';
            row.appendChild(indicator);
            const wrapper = document.createElement('div');
            wrapper.className = 'message-content-wrapper ai';
            const avatar = document.createElement('img');
            avatar.className = 'chat-avatar';
            avatar.src = contact.ai.avatar;
            const avatarSettings = contact.avatarSettings || { radius: '50%' };
            avatar.style.borderRadius = avatarSettings.radius;
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble ai-bubble';
            bubble.innerHTML = `<div class="typing-animation"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;
            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            row.appendChild(wrapper);

            chatMessagesContainer.appendChild(row);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            return row;
        }
        return null; // å¦‚æœèŠå¤©çª—å£æ²¡æ‰“å¼€ï¼Œåˆ™ä¸åˆ›å»ºä»»ä½•å…ƒç´ 
    }
    const moreFeaturesButton = document.getElementById('chat-add-attachment-button');
    const moreFeaturesPanel = document.getElementById('more-features-panel');
    // const featuresOverlay = document.getElementById('features-overlay'); // è·å–é®ç½©å±‚
    const timePerceptionButton = document.getElementById('time-perception-feature');
    const receiptFeatureButton = document.getElementById('receipt-feature');
    const transferFeatureButton = document.getElementById('transfer-feature');
    const chatMessageInputForReceipt = document.getElementById('chat-message-input'); // å¤ç”¨èŠå¤©è¾“å…¥æ¡†çš„ID

    // === æ–°å¢ï¼šåˆå§‹åŒ–åŠŸèƒ½é¢æ¿åˆ†é¡µå¸ƒå±€ ===
    function initFeaturesPanelPagination() {
        const panel = document.getElementById('more-features-panel');
        if (!panel) return;
        
        const grid = panel.querySelector('.features-grid');
        if (!grid) return;
        
        // è·å–æ‰€æœ‰åŠŸèƒ½é¡¹ï¼ˆæ’é™¤ input å…ƒç´ ï¼‰
        const items = Array.from(grid.querySelectorAll('.feature-item'));
        const fileInput = grid.querySelector('#file-attachment-input');
        
        if (items.length === 0) return;
        
        const ITEMS_PER_PAGE = 8;
        const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
        
        // æ¸…ç©ºç½‘æ ¼
        grid.innerHTML = '';
        
        // åˆ›å»ºåˆ†é¡µå®¹å™¨
        for (let i = 0; i < totalPages; i++) {
            const page = document.createElement('div');
            page.className = 'features-page';
            
            // æ·»åŠ è¯¥é¡µçš„åŠŸèƒ½é¡¹
            const startIdx = i * ITEMS_PER_PAGE;
            const endIdx = Math.min(startIdx + ITEMS_PER_PAGE, items.length);
            
            for (let j = startIdx; j < endIdx; j++) {
                page.appendChild(items[j]);
            }
            
            grid.appendChild(page);
        }
        
        // æŠŠæ–‡ä»¶è¾“å…¥æ¡†åŠ å›å»ï¼ˆéšè—çš„ï¼‰
        if (fileInput) {
            grid.appendChild(fileInput);
        }
        
        // åˆ›å»ºåˆ†é¡µæŒ‡ç¤ºå™¨
        if (totalPages > 1) {
            const indicator = document.createElement('div');
            indicator.className = 'features-page-indicator';
            
            for (let i = 0; i < totalPages; i++) {
                const dot = document.createElement('span');
                dot.className = 'dot' + (i === 0 ? ' active' : '');
                indicator.appendChild(dot);
            }
            
            panel.appendChild(indicator);
            
            // æ»‘åŠ¨æ—¶æ›´æ–°æŒ‡ç¤ºå™¨
            grid.addEventListener('scroll', () => {
                const scrollLeft = grid.scrollLeft;
                const pageWidth = grid.clientWidth;
                const currentPage = Math.round(scrollLeft / pageWidth);
                
                const dots = indicator.querySelectorAll('.dot');
                dots.forEach((dot, idx) => {
                    dot.classList.toggle('active', idx === currentPage);
                });
            });

            // === æ–°å¢ï¼šJS æ‰‹åŠ¿ç¿»é¡µé€»è¾‘ (è§£å†³åŸç”Ÿ scroll-snap è¿‡äºçµæ•çš„é—®é¢˜) ===
            let startX = 0;
            let startScrollLeft = 0;
            const SWIPE_THRESHOLD = 60; // æ»‘åŠ¨é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼æ‰ç¿»é¡µ

            grid.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startScrollLeft = grid.scrollLeft;
            }, { passive: true });

            grid.addEventListener('touchend', (e) => {
                const endX = e.changedTouches[0].clientX;
                const deltaX = endX - startX;
                const pageWidth = grid.clientWidth;
                
                // è®¡ç®—å½“å‰åŸæœ¬åº”è¯¥åœ¨å“ªä¸€é¡µ
                let currentPage = Math.round(startScrollLeft / pageWidth);
                
                if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
                    if (deltaX > 0 && currentPage > 0) {
                        // å‘å³æ»‘ (deltaX > 0)ï¼Œå»ä¸Šä¸€é¡µ
                        currentPage--;
                    } else if (deltaX < 0 && currentPage < totalPages - 1) {
                        // å‘å·¦æ»‘ (deltaX < 0)ï¼Œå»ä¸‹ä¸€é¡µ
                        currentPage++;
                    }
                }
                // å¦åˆ™(æœªè¶…è¿‡é˜ˆå€¼)ï¼ŒcurrentPage ä¿æŒä¸å˜ï¼Œå³å›å¼¹

                // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡é¡µ
                grid.scrollTo({
                    left: currentPage * pageWidth,
                    behavior: 'smooth'
                });
            });
            // === ç»“æŸæ‰‹åŠ¿é€»è¾‘ ===
        }
    }
    
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿ DOM å·²ç»åŠ è½½
    setTimeout(initFeaturesPanelPagination, 100);



    // === æ–°å¢ï¼šè½¬è´¦åŠŸèƒ½æ‰€éœ€å…ƒç´  ===
    const transferModal = document.getElementById('transfer-modal');
    const transferModalCloseBtn = document.getElementById('transfer-modal-close-btn');
    const confirmTransferBtn = document.getElementById('confirm-transfer-btn');
    const transferAmountInput = document.getElementById('transfer-amount-input');
    const transferRemarkInput = document.getElementById('transfer-remark-input');



    // æ€»å¼€å…³å‡½æ•°ï¼šåœ¨ chatScreen ä¸Šåˆ‡æ¢ç±»ï¼Œä¸è¡¨æƒ…é¢æ¿é€»è¾‘ä¸€è‡´
    function toggleFeaturesPanel(event) {
        if (event) {
            event.stopPropagation();
        }
        // è·å– chat-screen å…ƒç´ 
        const chatScreenEl = document.getElementById('chat-screen');
        if (!chatScreenEl) return;
        
        // å¦‚æœè¡¨æƒ…é¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œå…ˆå…³é—­å®ƒ
        if (chatScreenEl.classList.contains('emoji-panel-active')) {
            chatScreenEl.classList.remove('emoji-panel-active');
        }
        
        // åˆ‡æ¢æ›´å¤šåŠŸèƒ½é¢æ¿
        chatScreenEl.classList.toggle('features-panel-active');

        // ã€æ ¸å¿ƒä¿®å¤ã€‘é¢æ¿åˆ‡æ¢æ—¶ï¼Œç«‹å³å¼ºåˆ¶éšè—/æ£€æŸ¥å›åˆ°åº•éƒ¨æŒ‰é’®
        // ç¡®ä¿é¢æ¿æ‰“å¼€ç¬é—´æŒ‰é’®å³æ¶ˆå¤±ï¼Œä¸éœ€è¦ç­‰å¾…æ»šåŠ¨è§¦å‘
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
        if (scrollToBottomBtn && chatScreenEl.classList.contains('features-panel-active')) {
            scrollToBottomBtn.classList.remove('visible');
        }
    }

    // 1. ä¸ºPCç«¯çš„é¼ æ ‡ç‚¹å‡»æ·»åŠ ç›‘å¬
    moreFeaturesButton.addEventListener('click', (event) => {
        // æ£€æŸ¥æ˜¯å¦ä¸ºè§¦æ‘¸è®¾å¤‡ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ‰æ‰§è¡Œç‚¹å‡»é€»è¾‘
        // è¿™å¯ä»¥é˜²æ­¢åœ¨æ‰‹æœºä¸ŠåŒæ—¶è§¦å‘ touchend å’Œ click
        if (!('ontouchstart' in window)) {
            toggleFeaturesPanel(event);
        }
    });

    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¸ºç§»åŠ¨ç«¯çš„è§¦æ‘¸æ“ä½œæ·»åŠ ç›‘å¬
    moreFeaturesButton.addEventListener('touchend', (event) => {
        // a. é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼
        // å®ƒå¯ä»¥é˜²æ­¢åœ¨ touchend ä¹‹åæµè§ˆå™¨ç»§ç»­è§¦å‘ä¸€ä¸ªå¤šä½™çš„ "click" äº‹ä»¶ï¼Œé¿å…é¢æ¿é—ªçƒã€‚
        event.preventDefault();

        // b. ç«‹å³æ‰§è¡Œæˆ‘ä»¬çš„åŠŸèƒ½å‡½æ•°
        toggleFeaturesPanel(event);
    });
    // æ–°å¢ï¼šä¸ºå›æ‰§æ‚¬æµ®æŒ‰é’®æ·»åŠ äº‹ä»¶
    receiptFeatureButton.addEventListener('click', () => {
        handleReceiptClick();
    });


    // // ä¸ºé®ç½©å±‚ç»‘å®šå…³é—­äº‹ä»¶
    // featuresOverlay.addEventListener('click', () => {
    //     if (moreFeaturesPanel.classList.contains('active')) {
    //         toggleFeaturesPanel();
    //     }
    // });

    // 3. ä¸ºâ€œå›æ‰§â€åŠŸèƒ½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
    // === æ›´æ–°ï¼šâ€œå›æ‰§â€åŠŸèƒ½æŒ‰é’®çš„äº‹ä»¶ç›‘å¬ ===


    // ===================================
    // handleReceiptClick 
    // ===================================
    async function handleReceiptClick() {
        // æ ¸å¿ƒä¿®æ­£ï¼šä»…å½“åŠŸèƒ½é¢æ¿æ‰“å¼€æ—¶æ‰å…³é—­å®ƒï¼Œé˜²æ­¢â€œè¯¯è§¦â€æ‰“å¼€é¢æ¿
        const chatScreenEl = document.getElementById('chat-screen');
        if (chatScreenEl && chatScreenEl.classList.contains('features-panel-active')) {
            chatScreenEl.classList.remove('features-panel-active');
        }

        if (currentOpenGroup) {
            // ç›´æ¥è°ƒç”¨æ–°çš„å¯¼æ¼”æ¨¡å¼å‡½æ•°
            await fetchGroupScript(currentOpenGroup);
            return;
        }
        if (currentOpenContact) {
            // åŸºç¡€æ£€æŸ¥ï¼šç¡®ä¿æœ‰å¯¹è¯ï¼Œä¸”AIå½“å‰ä¸åœ¨å›å¤ä¸­
            if (!currentOpenContact || isAiReplying) {
                return;
            }

            const history = currentOpenContact.history || [];
            if (history.length === 0) {
                return;
            }

            const lastMessage = history[history.length - 1];

            if (lastMessage.sender === 'user') {
                // --- åœºæ™¯A: æœ€åæ˜¯ç”¨æˆ·å‘è¨€ ---
                let lastAiMessageIndex = -1;
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].sender === 'ai') {
                        lastAiMessageIndex = i;
                        break;
                    }
                }
                const currentUserTurnMessages = history.slice(lastAiMessageIndex + 1);
                const imageInTurn = currentUserTurnMessages.find(msg => msg.type === 'image' && msg.url && !msg.processed);

                if (imageInTurn) {
                    // å¦‚æœç”¨æˆ·çš„å›åˆä¸­åŒ…å«å›¾ç‰‡ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªç‰¹æ®Šçš„å›¾æ–‡è½½è·
                    const combinedText = currentUserTurnMessages
                        .filter(msg => msg.type === 'text' || msg.type === 'voice_text')
                        .map(msg => msg.transcript || msg.text)
                        .join(' \n');
                    callAI({ text: combinedText.trim(), imageUrl: imageInTurn.url }, currentOpenContact);
                } else {
                    // å¦‚æœåªæ˜¯çº¯æ–‡æœ¬ï¼Œå‘é€ä¸€ä¸ªé€šç”¨çš„ç³»ç»ŸæŒ‡ä»¤
                    const triggerPayload = "(ç³»ç»ŸæŒ‡ä»¤ï¼šè¯·æ ¹æ®ç”¨æˆ·çš„ä¸Šä¸€æ¡æˆ–å‡ æ¡æ¶ˆæ¯è¿›è¡Œå›å¤ã€‚)";
                    callAI(triggerPayload, currentOpenContact);
                }

            } else {
                // --- åœºæ™¯B: æœ€åæ˜¯AIå‘è¨€ ---
                // åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„ç³»ç»ŸæŒ‡ä»¤ï¼Œå‘Šè¯‰AIç»§ç»­è¯´ä¸‹å»
                const triggerPayload = "(ç³»ç»ŸæŒ‡ä»¤ï¼šè¯·æ ¹æ®ä½ ä¸Šä¸€æ¡å‘å‡ºçš„æ¶ˆæ¯ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€æ€è€ƒæˆ–æ‰§è¡Œä¸‹ä¸€æ­¥åŠ¨ä½œã€‚)";
                // æ ¸å¿ƒä¿®æ­£ï¼šå°† callAI è°ƒç”¨æ”¾åœ¨ else å—å†…éƒ¨
                callAI(triggerPayload, currentOpenContact);
            }
        }

        
    }
    // *** åœ¨è¿™é‡Œæ–°å¢ä¸‹é¢çš„ä»£ç  ***
    // === æœ€ç»ˆæ­£ç¡®ç‰ˆï¼šç”¨æˆ·å‘AIè½¬è´¦åŠŸèƒ½çš„äº‹ä»¶ç›‘å¬ ===
    // === æœ€æ–°ç‰ˆï¼šç”¨æˆ·å‘AIè½¬è´¦åŠŸèƒ½çš„äº‹ä»¶ç›‘å¬ï¼ˆä½¿ç”¨è¶…ç®€åŒ–æ ¼å¼ï¼‰ ===
    // === æ›´æ–°ï¼šâ€œè½¬è´¦â€åŠŸèƒ½æŒ‰é’®ï¼Œä½¿å…¶æ‰“å¼€æ–°å¼¹çª— ===
    transferFeatureButton.addEventListener('click', () => {
        openTransferModal();
    });

    // *** æ–°å¢ä»£ç ç»“æŸ ***

    // 4. (å¯é€‰ä½†æ¨è) æ·»åŠ ä¸€ä¸ªå…¨å±€ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºåœ¨ç‚¹å‡»é¢æ¿å¤–éƒ¨åŒºåŸŸæ—¶å…³é—­é¢æ¿
    document.addEventListener('click', (event) => {
        // æ£€æŸ¥é¢æ¿æ˜¯å¦æ˜¯æ‰“å¼€çš„
        if (moreFeaturesPanel.classList.contains('active')) {
            // æ£€æŸ¥ç‚¹å‡»çš„ç›®æ ‡æ˜¯å¦åœ¨é¢æ¿å†…éƒ¨ï¼Œæˆ–è€…æ˜¯å¦æ˜¯é‚£ä¸ªåŠ å·æŒ‰é’®æœ¬èº«
            const isClickInsidePanel = moreFeaturesPanel.contains(event.target);
            const isClickOnButton = moreFeaturesButton.contains(event.target);

            // å¦‚æœç‚¹å‡»æ—¢ä¸åœ¨é¢æ¿å†…ï¼Œä¹Ÿä¸æ˜¯ç‚¹çš„åŠ å·æŒ‰é’®ï¼Œé‚£ä¹ˆå°±å…³é—­é¢æ¿
            if (!isClickInsidePanel && !isClickOnButton) {
                moreFeaturesPanel.classList.remove('active');
            }
        }
    });
    // --- æ–°å¢ï¼šæ¶ˆæ¯é€‰æ‹©å’Œåˆ é™¤åŠŸèƒ½çš„æ ¸å¿ƒJSé€»è¾‘ ---

    // 1. å…¨å±€å˜é‡
    let isMessageSelectionMode = false;


    const chatScreenContainer = document.getElementById('chat-screen');

    // 2. è·å–æ–°æ·»åŠ çš„é¡¶æ æŒ‰é’®
    const normalHeaderActions = document.getElementById('chat-header-actions-normal');
    const selectHeaderActions = document.getElementById('chat-header-actions-select');
    const deleteMessagesBtn = document.getElementById('delete-messages-btn');
    const cancelSelectionBtn = document.getElementById('cancel-selection-btn');


    // 3. å®šä¹‰åŠŸèƒ½å‡½æ•°
    function enterMessageSelectionMode(targetMessageRow) {
        if (isMessageSelectionMode) return;
        isMessageSelectionMode = true;
        chatScreenContainer.classList.add('selection-mode-active');

        // åˆ‡æ¢é¡¶æ æŒ‰é’®
        normalHeaderActions.style.display = 'none';
        selectHeaderActions.style.display = 'flex';

        // // é€‰ä¸­é•¿æŒ‰çš„é‚£æ¡æ¶ˆæ¯
        // toggleMessageSelection(targetMessageRow);
    }

    function exitMessageSelectionMode() {
        isMessageSelectionMode = false;
        chatScreenContainer.classList.remove('selection-mode-active');

        // åˆ‡æ¢å›æ­£å¸¸çš„é¡¶æ æŒ‰é’®
        normalHeaderActions.style.display = 'flex';
        selectHeaderActions.style.display = 'none';

        // å–æ¶ˆæ‰€æœ‰æ¶ˆæ¯çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.message-row.selected').forEach(row => {
            row.classList.remove('selected');
        });
    }

    function toggleMessageSelection(messageRow) {
        if (!messageRow) return;
        messageRow.classList.toggle('selected');
    }

    // ===================================
    // è¿™æ˜¯æ–°çš„ã€ç®€åŒ–çš„ deleteSelectedMessages
    // ===================================
    // ===================================
    // ä¿®å¤ç‰ˆï¼šdeleteSelectedMessages (æ”¯æŒç¾¤èŠå’Œå•èŠ)
    // ===================================
    async function deleteSelectedMessages() {
        const selectedRows = document.querySelectorAll('.message-row.selected');
        // ä¿®æ”¹ç‚¹1ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ‰“å¼€çš„ç¾¤èŠ OR å•èŠ
        if (selectedRows.length === 0 || (!currentOpenContact && !currentOpenGroup)) {
            return;
        }

        if (!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${selectedRows.length} æ¡æ¶ˆæ¯å—ï¼Ÿ`)) {
            return;
        }

        const uuidsToDelete = new Set();
        selectedRows.forEach(row => {
            if (row.dataset.uuid) {
                uuidsToDelete.add(row.dataset.uuid);
            }
        });

        try {
            // ==========================
            // åˆ†æ”¯ A: å¦‚æœæ˜¯ç¾¤èŠ
            // ==========================
            if (currentOpenGroup) {
                // 1. åŠ è½½ç¾¤èŠæ•°æ®åº“
                const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

                // 2. æ‰¾åˆ°å½“å‰ç¾¤
                const groupIndex = allGroups.findIndex(g => g.id === currentOpenGroup.id);

                if (groupIndex > -1) {
                    const groupToUpdate = allGroups[groupIndex];

                    // 3. è¿‡æ»¤å†å²è®°å½•
                    if (Array.isArray(groupToUpdate.history)) {
                        groupToUpdate.history = groupToUpdate.history.filter(
                            message => !uuidsToDelete.has(message.uuid)
                        );
                    }

                    // 4. æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆ
                    if (groupToUpdate.history.length > 0) {
                        const newLastMessage = groupToUpdate.history[groupToUpdate.history.length - 1];
                        const previewText = newLastMessage.text || (newLastMessage.content && newLastMessage.content.html) || '[å¤šåª’ä½“]';
                        // ç¾¤èŠé¢„è§ˆä¸€èˆ¬åŠ ä¸ª"æˆ‘:"æˆ–è€…å‘é€è€…åå­—ï¼Œè¿™é‡Œç®€å•å¤„ç†
                        groupToUpdate.lastMessage = cleanMessageForPreview(previewText);
                    } else {
                        groupToUpdate.lastMessage = "å¯¹è¯å·²æ¸…ç©º";
                    }

                    // 5. ä¿å­˜å›æ•°æ®åº“
                    await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);

                    // 6. åŒæ­¥å†…å­˜å¯¹è±¡
                    currentOpenGroup = groupToUpdate;

                    // 7. æ›´æ–°UI
                    selectedRows.forEach(row => row.remove());
                    // åˆ·æ–°åˆ—è¡¨é¡µçš„é¢„è§ˆæ–‡å­—
                    if (typeof renderMessagesList === 'function') renderMessagesList();

                    exitMessageSelectionMode();
                    alert('åˆ é™¤æˆåŠŸï¼');
                }
            }
            // ==========================
            // åˆ†æ”¯ B: å¦‚æœæ˜¯å•èŠ (åŸæœ‰é€»è¾‘)
            // ==========================
            else if (currentOpenContact) {
                const allContactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                let allContacts = (allContactsData && Array.isArray(allContactsData.value)) ? allContactsData.value : [];
                const contactIndex = allContacts.findIndex(c => c.id === currentOpenContact.id);

                if (contactIndex > -1) {
                    const contactToUpdate = allContacts[contactIndex];
                    if (Array.isArray(contactToUpdate.history)) {
                        contactToUpdate.history = contactToUpdate.history.filter(
                            message => !uuidsToDelete.has(message.uuid)
                        );
                    }

                    if (contactToUpdate.history.length > 0) {
                        const newLastMessage = contactToUpdate.history[contactToUpdate.history.length - 1];
                        contactToUpdate.lastMessage = cleanMessageForPreview(newLastMessage.text || (newLastMessage.content && newLastMessage.content.html) || '');
                    } else {
                        contactToUpdate.lastMessage = "å¯¹è¯å·²æ¸…ç©º";
                    }

                    await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                    currentOpenContact = contactToUpdate;

                    selectedRows.forEach(row => row.remove());
                    const contactItemInList = contactList.querySelector(`.contact-item[data-contact-id="${currentOpenContact.id}"]`);
                    if (contactItemInList) {
                        contactItemInList.querySelector('.contact-last-message').textContent = currentOpenContact.lastMessage;
                    }

                    exitMessageSelectionMode();
                    alert('åˆ é™¤æˆåŠŸï¼');
                }
            }

        } catch (error) {
            console.error("åˆ é™¤æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯:", error);
            alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
        }
    }
    // ===================================
    // è¿™æ˜¯ã€æœ€ç»ˆæ­£ç¡®ç‰ˆã€‘çš„äº‹ä»¶ç›‘å¬ä»£ç å—
    // ===================================

    // 1. å–æ¶ˆå’Œåˆ é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    cancelSelectionBtn.addEventListener('click', exitMessageSelectionMode);
    deleteMessagesBtn.addEventListener('click', deleteSelectedMessages);

    // --- 2. é•¿æŒ‰å¼€å§‹ ---
    // --- å¢å¼ºç‰ˆé•¿æŒ‰å¼€å§‹å‡½æ•° ---
    function handlePressStart(e) {
        // åŸºç¡€æ£€æŸ¥
        if (isAiReplying || isMessageSelectionMode) return;

        const targetElement = e.target;

        // A. æ£€æŸ¥æ˜¯å¦é•¿æŒ‰äº†è¯­éŸ³è½¬æ–‡å­—çš„é¢æ¿ (æ–°å¢é€»è¾‘)
        const voiceTextPanel = targetElement.closest('.voice-text-panel');
        if (voiceTextPanel) {
            const messageRow = voiceTextPanel.closest('.message-row');
            if (!messageRow) return;

            isLongPressTriggered = false;
            clearTimeout(longPressTimer);

            longPressTimer = setTimeout(() => {
                isLongPressTriggered = true;
                // è§¦å‘ç¼–è¾‘å¼¹çª—
                openVoiceEditModal(messageRow.dataset.uuid, voiceTextPanel.innerText);
            }, 500); // 500ms é•¿æŒ‰
            return;
        }

        // B. åŸæœ‰çš„é•¿æŒ‰æ°”æ³¡å‡ºèœå•é€»è¾‘
        // æ’é™¤ç‰¹æ®Šå…ƒç´ 
        if (targetElement.tagName === 'IMG' && targetElement.classList.contains('image-bubble')) return;
        if (targetElement.closest('.html-render-container')) return;

        const targetRow = e.target.closest('.message-row');
        if (!targetRow) return;

        // é‡ç½®çŠ¶æ€
        isLongPressTriggered = false;
        clearTimeout(longPressTimer);

        longPressTimer = setTimeout(() => {
            isLongPressTriggered = true;
            showMsgActionMenu(targetRow, e);
        }, 500);
    }

    // --- 3. é•¿æŒ‰ç»“æŸ (æ¾å¼€é¼ æ ‡/æ‰‹æŒ‡) ---
    function handlePressEnd(event) {
        // åªè¦æ¾æ‰‹ï¼Œå°±æ¸…é™¤å®šæ—¶å™¨ã€‚
        // å¦‚æœè¿˜æ²¡åˆ° 500msï¼Œå®šæ—¶å™¨è¢«æ¸…é™¤ï¼ŒisLongPressTriggered ä¾ç„¶æ˜¯ false (è§†ä¸ºæ™®é€šç‚¹å‡»)
        // å¦‚æœè¶…è¿‡ 500msï¼Œå®šæ—¶å™¨å·²ç»æ‰§è¡Œè¿‡äº†ï¼ŒisLongPressTriggered å·²ç»æ˜¯ true äº†
        clearTimeout(longPressTimer);
    }


    // 3. ã€æ ¸å¿ƒã€‘ä¸ºèŠå¤©å®¹å™¨ç»‘å®šæ‰€æœ‰å¿…éœ€çš„é¼ æ ‡å’Œè§¦æ‘¸äº‹ä»¶
    chatMessagesContainer.addEventListener('mousedown', handlePressStart);
    chatMessagesContainer.addEventListener('touchstart', handlePressStart, { passive: true });

    chatMessagesContainer.addEventListener('mouseup', handlePressEnd);
    chatMessagesContainer.addEventListener('touchend', (event) => handlePressEnd(event));
    chatMessagesContainer.addEventListener('mouseleave', handlePressEnd); // é¼ æ ‡ç§»å‡ºä¹Ÿè¦å–æ¶ˆ
    chatMessagesContainer.addEventListener('touchmove', handlePressEnd); // æ‰‹æŒ‡æ»‘åŠ¨ï¼ˆæ»šåŠ¨ï¼‰æ—¶ä¹Ÿè¦å–æ¶ˆé•¿æŒ‰

    // 4. èŠå¤©å®¹å™¨çš„å•å‡»äº‹ä»¶
    // ==========================================================
    // === ç»ˆæç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ (å¤„ç†æ‰€æœ‰ç‚¹å‡»äº¤äº’ - æœ€ç»ˆåˆå¹¶ç‰ˆ) ===
    // ==========================================================
    chatMessagesContainer.addEventListener('click', (e) => {

        // 1. é•¿æŒ‰ä¿æŠ¤
        if (isLongPressTriggered) {
            e.stopPropagation(); e.preventDefault(); isLongPressTriggered = false; return;
        }

        // 2. èŠå¤©è®°å½•å¡ç‰‡ç‚¹å‡»
        const historyCard = e.target.closest('.history-card-bubble');
        if (historyCard) {
            e.stopPropagation(); e.preventDefault();
            const title = historyCard.dataset.historyTitle || "èŠå¤©è®°å½•";
            const rawContent = historyCard.dataset.historyContent;
            if (rawContent) {
                try {
                    const lines = JSON.parse(rawContent);
                    showTextHistoryModal(title, lines);
                } catch (err) {
                    showTextHistoryModal(title, [rawContent]);
                }
            }
            return;
        }

        // 3. æ–‡å›¾å¡ç‰‡ç¿»è½¬
        const card = e.target.closest('.text-image-card');
        if (card) {
            card.classList.toggle('text-revealed');
            return;
        }

        // 4. å›¾ç‰‡é¢„è§ˆ
        if (e.target.tagName === 'IMG' && e.target.classList.contains('image-bubble')) {
            openImagePreview(e.target.src);
            return;
        }

        // 5. è¯­éŸ³æ°”æ³¡å±•å¼€/æŠ˜å 


        // â–¼â–¼â–¼ 6. ç¾¤èŠå¤´åƒç‚¹å‡» (ä¿®æ”¹æ°”æ³¡æ ·å¼) â–¼â–¼â–¼
        if (e.target.classList.contains('chat-avatar') && e.target.dataset.action === 'edit-bubble-style') {
            if (currentOpenGroup) {
                const memberId = e.target.dataset.memberId;
                let currentCss = "";
                if (currentOpenGroup.memberStyles && currentOpenGroup.memberStyles[memberId]) {
                    currentCss = currentOpenGroup.memberStyles[memberId];
                }
                let nameTitle = "æˆå‘˜";
                const nicknameDiv = e.target.nextElementSibling;
                if (nicknameDiv) nameTitle = nicknameDiv.textContent;

                const onSaveGroupCss = async (newCss) => {
                    if (!currentOpenGroup.memberStyles) currentOpenGroup.memberStyles = {};
                    currentOpenGroup.memberStyles[memberId] = newCss;
                    const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                    let allGroups = groupsData.value;
                    const groupIndex = allGroups.findIndex(g => g.id === currentOpenGroup.id);
                    if (groupIndex > -1) {
                        allGroups[groupIndex] = currentOpenGroup;
                        await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                    }
                    
                    // â–¼â–¼â–¼ ä¿®å¤ï¼šå¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿æ ·å¼ç«‹å³ç”Ÿæ•ˆ â–¼â–¼â–¼
                    if (window.injectedStylesCache) {
                        const styleTagId = `style-group-${currentOpenGroup.id}-${memberId}`;
                        window.injectedStylesCache.delete(styleTagId);
                    }
                    // æ¸…é™¤è½¬æ¢ç¼“å­˜é˜²æ­¢å‰ç¼€ç›¸åŒçš„CSSä¸æ›´æ–°
                    if (window._cssTransformCache) window._cssTransformCache.clear();
                    
                    injectMemberStyle(memberId);
                    closeTextEditModal();
                    alert("ç¾¤èŠæ°”æ³¡æ ·å¼å·²æ›´æ–°ï¼");
                };
                openTextEditModal(`ç¼–è¾‘ ${nameTitle} çš„ç¾¤æ°”æ³¡`, currentCss, onSaveGroupCss);
                setTimeout(() => {
                    const textarea = document.getElementById('text-edit-textarea');
                    if (textarea) textarea.placeholder = "è¾“å…¥CSSä»£ç ...";
                }, 50);
            } else if (currentOpenContact) {
                console.log("å•èŠæ¨¡å¼ç‚¹å‡»å¤´åƒï¼Œå¿½ç•¥");
            }
            return;
        }
        // â–²â–²â–² 6. ç»“æŸ â–²â–²â–²

        // 7. å¤šé€‰æ¨¡å¼ç‚¹å‡»
        if (isMessageSelectionMode) {
            const targetRow = e.target.closest('.message-row');
            if (targetRow) {
                e.stopPropagation(); e.preventDefault(); toggleMessageSelection(targetRow);
            }
        }
        // 6. ç‚¹å‡»æ–‡ä»¶å¡ç‰‡ (æ–°å¢)
        const fileCard = e.target.closest('.clickable-file-card');
        if (fileCard) {
            e.stopPropagation(); // é˜²æ­¢è§¦å‘å…¶ä»–æ°”æ³¡ç‚¹å‡»äº‹ä»¶

            // æ£€æŸ¥æ˜¯å¦æ˜¯ AI æ¨¡æ‹Ÿæ–‡ä»¶
            if (fileCard.dataset.isSimulated === "true") {
                const fileName = fileCard.dataset.filename;
                // è§£ç å†…å®¹
                const rawContent = fileCard.dataset.simulatedContent;
                const content = decodeURIComponent(rawContent);

                openAiFileViewer(fileName, content);
            }
            // å¦åˆ™æ˜¯çœŸå®æ–‡ä»¶ (ç”¨æˆ·å‘çš„)
            else {
                const fileName = fileCard.dataset.filename;
                const fileUrl = fileCard.dataset.fileUrl;
                openFileFromCard(fileName, fileUrl);
            }
            return;
        }

    });



    // è¯·å°†è¿™ä¸¤è¡Œä»£ç ï¼Œæ·»åŠ åˆ°ä¸Šä¸€æ­¥ä»£ç çš„æ­£ä¸‹æ–¹
    imagePreviewCloseBtn.addEventListener('click', closeImagePreview);
    imagePreviewModal.addEventListener('click', (event) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯èƒŒæ™¯ï¼ˆé®ç½©å±‚ï¼‰æœ¬èº«ï¼Œè€Œä¸æ˜¯å›¾ç‰‡ï¼Œå°±å…³é—­
        if (event.target === imagePreviewModal) {
            closeImagePreview();
        }
    });



    // *** åœ¨è¿™é‡Œæ–°å¢ä¸‹é¢çš„ä»£ç  ***

    // === æ–°å¢ï¼šä¸–ç•Œä¹¦å¯¹è¯æ¡†çš„æ§åˆ¶å‡½æ•° ===
    // === å‡çº§ç‰ˆï¼šä¸–ç•Œä¹¦å¯¹è¯æ¡†æ§åˆ¶å‡½æ•°ï¼ˆæ”¯æŒæ–°å»ºå’Œç¼–è¾‘ï¼‰ ===
    async function openWorldbookModal(bookId = null) {
        const modalTitle = addWorldbookModal.querySelector('h2');

        if (bookId) {
            // --- ç¼–è¾‘æ¨¡å¼ ---
            currentEditingBookId = bookId; // è®°å½•æ­£åœ¨ç¼–è¾‘çš„ID
            modalTitle.textContent = 'ç¼–è¾‘ä¸–ç•Œä¹¦';

            // ä»æ•°æ®åº“åŠ è½½å¹¶å¡«å……å†…å®¹
            const existingData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            const book = existingData.value.find(b => b.id === bookId);
            if (book) {
                worldbookNameInput.value = book.name;
                worldbookContentInput.value = book.content;
            }
        } else {
            // --- æ–°å»ºæ¨¡å¼ ---
            currentEditingBookId = null; // ç¡®ä¿æ˜¯null
            modalTitle.textContent = 'æ–°å»ºä¸–ç•Œä¹¦';
            // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆè™½ç„¶å…³é—­æ—¶ä¼šæ¸…ï¼Œä½†è¿™é‡Œå†æ¸…ä¸€æ¬¡æ›´ä¿é™©ï¼‰
            worldbookNameInput.value = '';
            worldbookContentInput.value = '';
        }

        // æ˜¾ç¤ºå¼¹çª—
        addWorldbookModal.style.display = 'flex';
        setTimeout(() => {
            addWorldbookModal.style.opacity = '1';
            addWorldbookModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    function closeWorldbookModal() {
        addWorldbookModal.style.opacity = '0';
        addWorldbookModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            addWorldbookModal.style.display = 'none';
            // é‡ç½®è¾“å…¥æ¡†å†…å®¹
            worldbookNameInput.value = '';
            worldbookContentInput.value = '';
            currentEditingBookId = null;
        }, 300);
    }

    // --- äº‹ä»¶ç»‘å®š ---
    worldbookModalCloseBtn.addEventListener('click', closeWorldbookModal);

    // --- ä¿å­˜ä¸–ç•Œä¹¦çš„é€»è¾‘ ---
    // === å‡çº§ç‰ˆï¼šä¿å­˜ä¸–ç•Œä¹¦çš„é€»è¾‘ï¼ˆæ”¯æŒæ–°å»ºå’Œç¼–è¾‘ï¼‰ ===
    saveWorldbookBtn.addEventListener('click', async () => {
        const name = worldbookNameInput.value.trim();
        const content = worldbookContentInput.value.trim();

        if (!name) {
            alert('ä¸–ç•Œä¹¦åç§°ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }

        try {
            const existingData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            let books = (existingData && Array.isArray(existingData.value)) ? existingData.value : [];

            if (currentEditingBookId) {
                // --- ç¼–è¾‘é€»è¾‘ (ä¿æŒä¸å˜) ---
                const bookIndex = books.findIndex(b => b.id === currentEditingBookId);
                if (bookIndex > -1) {
                    books[bookIndex].name = name;
                    books[bookIndex].content = content;
                }
            } else {
                // --- æ–°å»ºé€»è¾‘ (æ ¸å¿ƒå‡çº§) ---
                const newBook = {
                    id: Date.now(),
                    name: name,
                    content: content,
                    createdAt: new Date()
                };
                books.push(newBook);

                // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦åœ¨åˆ†ç»„å†…åˆ›å»º â–¼â–¼â–¼
                if (currentOpenGroupId) {
                    const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                    let groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                    const group = groups.find(g => g.id === currentOpenGroupId);
                    if (group) {
                        if (!Array.isArray(group.bookIds)) {
                            group.bookIds = [];
                        }
                        group.bookIds.push(newBook.id);
                        await dbHelper.saveData('worldBookGroups', 'allGroups', groups);
                    }
                }
                // â–²â–²â–² æ–°å¢é€»è¾‘ç»“æŸ â–²â–²â–²
            }

            // å°†æ›´æ–°åçš„æ•´ä¸ªä¹¦ç±æ•°ç»„å­˜å›æ•°æ®åº“
            await dbHelper.saveData('worldBooks', 'allWorldBooks', books);

            alert('ä¸–ç•Œä¹¦å·²ä¿å­˜ï¼');
            closeWorldbookModal();

            // â–¼â–¼â–¼ æ–°å¢çš„æ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ®å½“å‰åœ¨å“ªï¼Œå°±åˆ·æ–°å“ªä¸ªåˆ—è¡¨ â–¼â–¼â–¼
            if (currentOpenGroupId) {
                openGroupDetailView(currentOpenGroupId); // åˆ·æ–°åˆ†ç»„è¯¦æƒ…é¡µ
            } else {
                loadAndRenderWorldBooks(); // åˆ·æ–°ä¸»ä¸–ç•Œä¹¦åˆ—è¡¨
            }
            // â–²â–²â–² æ–°å¢é€»è¾‘ç»“æŸ â–²â–²â–²

        } catch (error) {
            console.error("ä¿å­˜ä¸–ç•Œä¹¦å¤±è´¥:", error);
            alert("ä¿å­˜å¤±è´¥");
        }
    });

    /**
     * æ¸²æŸ“ä¸–ç•Œä¹¦åˆ—è¡¨åˆ°ç•Œé¢ä¸Š
     * @param {Array} books - ä»æ•°æ®åº“è¯»å–çš„ä¸–ç•Œä¹¦å¯¹è±¡æ•°ç»„
     */
    function renderWorldBooks(books) {
        worldbookListContainer.innerHTML = ''; // å…ˆæ¸…ç©ºåˆ—è¡¨
        if (!books || books.length === 0) {
            worldbookListContainer.innerHTML = '<p style="text-align:center; color:#888;">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¸–ç•Œä¹¦ã€‚</p>';
            return;
        }

        books.forEach(book => {
            const bookItem = document.createElement('div');
            bookItem.className = 'contact-item'; // å¤ç”¨è”ç³»äººåˆ—è¡¨é¡¹çš„æ ·å¼
            bookItem.dataset.bookId = book.id;
            bookItem.innerHTML = `
            <input type="checkbox" class="contact-checkbox">
            <div class="contact-info">
                <div class="contact-name">${book.name}</div>
                <div class="contact-last-message" style="white-space: normal;">${book.content.substring(0, 50)}...</div>
            </div>
        `;
            worldbookListContainer.appendChild(bookItem);
        });
    }

    /**
     * ä»æ•°æ®åº“åŠ è½½æ•°æ®å¹¶è°ƒç”¨æ¸²æŸ“å‡½æ•°
     */
    async function loadAndRenderWorldBooks() {
        const existingData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
        const books = (existingData && Array.isArray(existingData.value)) ? existingData.value : [];
        renderWorldBooks(books);
    }

    // *** æ–°å¢ä»£ç ç»“æŸ ***

    // *** åœ¨è¿™é‡Œæ–°å¢ä¸‹é¢çš„ä»£ç  ***

    // --- â€œå¤šé€‰â€æŒ‰é’®ç°åœ¨åªè´Ÿè´£è¿›å…¥å¤šé€‰æ¨¡å¼ ---
    worldbookMultiselectBtn.addEventListener('click', () => {
        isWorldbookDeleteMode = !isWorldbookDeleteMode;
        worldbookListContainer.classList.toggle('delete-mode', isWorldbookDeleteMode);

        const iconSelect = worldbookMultiselectBtn.querySelector('.icon-select');
        const iconCancel = worldbookMultiselectBtn.querySelector('.icon-cancel');

        if (isWorldbookDeleteMode) {
            // è¿›å…¥æ¨¡å¼ï¼šæ˜¾ç¤ºå–æ¶ˆ(X)å›¾æ ‡
            iconSelect.style.display = 'none';
            iconCancel.style.display = 'block';
            worldbookHeaderNormal.style.display = 'none';
            worldbookHeaderSelect.style.display = 'flex';
        } else {
            // é€€å‡ºæ¨¡å¼ï¼šæ˜¾ç¤ºåˆ—è¡¨å›¾æ ‡
            iconSelect.style.display = 'block';
            iconCancel.style.display = 'none';
            worldbookHeaderNormal.style.display = 'flex';
            worldbookHeaderSelect.style.display = 'none';
            worldbookListContainer.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = false);
        }
    });

    // --- æ–°å¢ï¼šâ€œå–æ¶ˆâ€æŒ‰é’®è´Ÿè´£é€€å‡ºå¤šé€‰æ¨¡å¼ ---
    worldbookCancelSelectBtn.addEventListener('click', () => {
        isWorldbookDeleteMode = false;
        worldbookListContainer.classList.remove('delete-mode');

        // åˆ‡æ¢å›æ­£å¸¸çš„é¡¶æ æŒ‰é’®
        worldbookHeaderNormal.style.display = 'flex';
        worldbookHeaderSelect.style.display = 'none';

        // å–æ¶ˆæ‰€æœ‰å‹¾é€‰
        worldbookListContainer.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = false);
    });



    // --- â€œç§»åŠ¨â€æŒ‰é’®æ‰“å¼€å¼¹å‡ºæ¡† (æ­¤å‡½æ•°ä¸å˜) ---
    moveBooksBtn.addEventListener('click', async () => {
        const selectedCheckboxes = worldbookListContainer.querySelectorAll('.contact-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ç§»åŠ¨çš„ä¸–ç•Œä¹¦ã€‚');
            return;
        }

        try {
            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            const groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
            groupSelectionList.innerHTML = '';
            if (groups.length > 0) {
                groups.forEach(group => {
                    const item = document.createElement('div');
                    item.className = 'group-selection-item';
                    item.dataset.groupId = group.id;
                    item.textContent = group.name;
                    groupSelectionList.appendChild(item);
                });
            } else {
                groupSelectionList.innerHTML = '<p style="text-align:center; color:#888;">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
            }
            moveToGroupModal.style.display = 'flex';
            setTimeout(() => moveToGroupModal.style.opacity = '1', 10);
        } catch (error) {
            console.error("åŠ è½½åˆ†ç»„åˆ°å¼¹çª—å¤±è´¥:", error);
        }
    });

    // // --- ä¿®æ”¹â€œæ–°å»ºâ€æŒ‰é’®çš„è¡Œä¸ºï¼Œä½¿å…¶åœ¨åˆ é™¤æ¨¡å¼ä¸‹æ‰§è¡Œåˆ é™¤ ---
    // addWorldbookBtn.addEventListener('click', () => {
    //     if (isWorldbookDeleteMode) {
    //         handleBatchDeleteWorldBooks();
    //     } else {
    //         openWorldbookModal();
    //     }
    // });

    // // --- æ‰¹é‡åˆ é™¤çš„æ‰§è¡Œå‡½æ•° ---
    // async function handleBatchDeleteWorldBooks() {
    //     const selectedCheckboxes = worldbookListContainer.querySelectorAll('.contact-checkbox:checked');
    //     if (selectedCheckboxes.length === 0) {
    //         alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„ä¸–ç•Œä¹¦ã€‚');
    //         return;
    //     }

    //     if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} ä¸ªä¸–ç•Œä¹¦å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
    //         return;
    //     }

    //     const idsToDelete = new Set();
    //     selectedCheckboxes.forEach(cb => {
    //         const bookId = cb.closest('.contact-item').dataset.bookId;
    //         idsToDelete.add(parseInt(bookId, 10));
    //     });

    //     try {
    //         const existingData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
    //         let books = (existingData && Array.isArray(existingData.value)) ? existingData.value : [];

    //         // è¿‡æ»¤æ‰éœ€è¦åˆ é™¤çš„ä¹¦ç±
    //         const updatedBooks = books.filter(book => !idsToDelete.has(book.id));

    //         // å°†æ›´æ–°åçš„åˆ—è¡¨å­˜å›æ•°æ®åº“
    //         await dbHelper.saveData('worldBooks', 'allWorldBooks', updatedBooks);

    //         // é‡æ–°åŠ è½½åˆ—è¡¨å¹¶é€€å‡ºåˆ é™¤æ¨¡å¼
    //         await loadAndRenderWorldBooks();
    //         worldbookMultiselectBtn.click(); // æ¨¡æ‹Ÿç‚¹å‡»â€œå–æ¶ˆâ€æŒ‰é’®

    //     } catch (error) {
    //         console.error("åˆ é™¤ä¸–ç•Œä¹¦å¤±è´¥:", error);
    //         alert("åˆ é™¤å¤±è´¥");
    //     }
    // }
    // *** æ–°å¢ä»£ç ç»“æŸ ***

    // === æ›´æ–°ï¼šè½¬è´¦åŠŸèƒ½ï¼Œä½¿å…¶æ‰“å¼€å¼¹çª—å¹¶å‘é€æ­£ç¡®æ ¼å¼çš„æ¶ˆæ¯ ===
    function openTransferModal() {
        transferModal.style.display = 'flex';
        setTimeout(() => {
            transferModal.style.opacity = '1';
            transferModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    function closeTransferModal() {
        transferModal.style.opacity = '0';
        transferModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            transferModal.style.display = 'none';
            transferAmountInput.value = '';
            transferRemarkInput.value = '';
        }, 300);
    }

    transferFeatureButton.addEventListener('click', () => {
        openTransferModal();
        moreFeaturesPanel.classList.remove('active');
    });

    timePerceptionButton.addEventListener('click', handleTimePerceptionToggle);

    transferModalCloseBtn.addEventListener('click', closeTransferModal);

    confirmTransferBtn.addEventListener('click', async () => {
    const amount = parseFloat(transferAmountInput.value);
    const remark = transferRemarkInput.value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢ã€‚");
        return;
    }
    if (!remark) {
        alert("å¤‡æ³¨ä¸èƒ½ä¸ºç©ºã€‚");
        return;
    }

    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
    // æ”¹æˆç¬¦åˆ System Prompt å’Œ addMessageToView æ­£åˆ™çš„çº¯æ–‡æœ¬æ ¼å¼
    const messageText = `è½¬è´¦ï¼š${amount.toFixed(2)}-${remark}`; 
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

    const userMessage = {
        sender: 'user',
        text: messageText,
        timestamp: new Date(),
        // ç¡®ä¿æœ‰ UUIDï¼Œè¿™æ ·ç‚¹å‡»äº‹ä»¶æ‰èƒ½æ‰¾åˆ°å®ƒ
        uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9) 
    };

    // 1. æ¸²æŸ“åˆ°ç•Œé¢
    // addMessageToView å†…éƒ¨ç°åœ¨æœ‰æ­£åˆ™æ£€æµ‹ "è½¬è´¦ï¼š..."ï¼Œä¼šè‡ªåŠ¨æŠŠå®ƒå˜èº«æˆå¡ç‰‡
    addMessageToView(userMessage);

    // 2. ä¿å­˜åˆ°å†å²
    // ä¿å­˜è¿™ç§æ ¼å¼éå¸¸å¥½ï¼Œå› ä¸ºå®ƒæ˜¯ System Prompt å®šä¹‰çš„æ ‡å‡†æ ¼å¼ï¼ŒAI è¯»å–å†å²æ—¶èƒ½å®Œç¾ç†è§£
    await saveMessageToHistory(userMessage, currentOpenContact.id);
    
    chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' });

    closeTransferModal();
});
    /**
     * æœ€ç»ˆç¡®è®¤ç‰ˆï¼šå¤„ç†AIå›å¤çš„æ ¸å¿ƒå‡½æ•°
     * 1. ä¸¥æ ¼æ¢å¤æ‚¨æœ€åˆè®¾å®šçš„å»¶è¿Ÿæ—¶é—´è®¡ç®—å…¬å¼ã€‚
     * 2. åŒ…å«æ‰€æœ‰å·²ä¿®æ­£çš„é”™è¯¯å’Œæ–°å¢çš„åŠŸèƒ½ã€‚
     * @param {number} contactId - å¯¹è¯çš„ID.
     * @param {Array} newMessages - AIè¿”å›çš„æ–°æ¶ˆæ¯å¯¹è±¡æ•°ç»„.
     * @param {HTMLElement|null} initialIndicator - ä¸ºç¬¬ä¸€æ¡æ¶ˆæ¯é¢„åˆ›å»ºçš„â€œæ­£åœ¨è¾“å…¥â€åŠ¨ç”»å…ƒç´ .
     */
    async function updateChatViewWithAIResponse(contactId, newMessages, initialIndicator) {
        if (currentOpenContact && currentOpenContact.id === contactId) {
            let acceptedInvite = false;

            for (const [index, message] of newMessages.entries()) {

                if (message.text.includes('[ACCEPT_INVITE]')) {
                    acceptedInvite = true;
                }

                let currentTypingIndicator;

                if (index === 0 && initialIndicator) {
                    currentTypingIndicator = initialIndicator;
                } else {
                    currentTypingIndicator = showTypingIndicator();
                }

                
                let visibleText = message.text.replace('[ACCEPT_INVITE]', '').trim();
                const match = visibleText.match(messageRegex);
                if (match && match[1]) {
                    visibleText = match[1].trim();
                }

                // --- æ ¸å¿ƒä¿®æ­£ï¼šä¸¥æ ¼æ¢å¤ä¸ºæ‚¨åŸæ¥çš„å»¶è¿Ÿæ—¶é—´å…¬å¼ ---
                const typingDelay = Math.min(visibleText.length * 800 + 1000, 4000); 

                await new Promise(resolve => setTimeout(resolve, typingDelay));

                currentTypingIndicator.remove();

                if (visibleText) {
                    addMessageToView({ ...message, text: visibleText });
                    chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' });
                }
            }

            if (acceptedInvite && sharedListeningState.active === false) {
                console.log(`AI "${currentOpenContact.ai.name}" æ¥å—äº†é‚€è¯·ï¼`);

                sharedListeningState.active = true;
                sharedListeningState.contact = currentOpenContact;

                const message = `${currentOpenContact.ai.name} åŠ å…¥äº†ä¸€èµ·å¬`;
                // ç¡®ä¿è°ƒç”¨äº†æ–°çš„ showSystemNotification å‡½æ•°
                showSystemNotification(message, currentOpenContact.id);

                if (dynamicIsland.classList.contains('expanded')) {
                    updateSharedListeningUI();
                }
            }
        }
    }
    // === å¤‡ä»½ä¸æ¢å¤åŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ ===

    // å®šä¹‰æˆ‘ä»¬æ•°æ®åº“ä¸­æ‰€æœ‰çš„â€œè¡¨â€å
    const objectStoreNames = [
        'settingsStore',            // è®¾ç½®ã€å£çº¸ã€ä½™é¢ç­‰
        'messageContacts',          // å•èŠè”ç³»äººå’Œè®°å½•
        'groupChats',               // ã€æ–°å¢ã€‘ç¾¤èŠåˆ—è¡¨å’Œè®°å½•
        'worldBooks',               // ä¸–ç•Œä¹¦
        'worldBookGroups',          // ä¸–ç•Œä¹¦åˆ†ç»„
        'gachaPosts',               // æœ‹å‹åœˆå¸–å­
        'emojiStore',               // è¡¨æƒ…åŒ… (ç‰¹æ®Šç»“æ„)
        'iconPresets',              // å›¾æ ‡é¢„è®¾
        'datingSetupStore',         // çº¦ä¼šè®¾ç½® (ç«‹ç»˜/èƒŒæ™¯)
        'datingHistoryStore',       // çº¦ä¼šå†å²è®°å½•
        'writingStylePresets',      // æ–‡ç¬”åå¥½
        'fontUrlStore'              // å­—ä½“URL
        // æ³¨æ„ï¼šmusicPlaylists (æ­Œå•) å¦‚æœåŒ…å«ç”± file input è¯»å–çš„ Blob/File å¯¹è±¡ï¼Œ
        // æ˜¯æ— æ³•é€šè¿‡ JSON åºåˆ—åŒ–å¤‡ä»½çš„ã€‚å¦‚æœåªå­˜ URL åˆ™å¯ä»¥ã€‚
        // ä¸ºäº†é˜²æ­¢å¤‡ä»½æ–‡ä»¶è¿‡å¤§æˆ–æŠ¥é”™ï¼Œè¿™é‡Œæš‚ä¸åŒ…å«å«æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„è¡¨ã€‚
    ];
    /**
     * å¤‡ä»½åŠŸèƒ½ï¼šè¯»å–æ‰€æœ‰æ•°æ®å¹¶ä¸‹è½½ä¸ºJSONæ–‡ä»¶
     */
    /**
     * å¤‡ä»½åŠŸèƒ½ï¼šã€å¤§æ–‡ä»¶å†…å­˜ä¼˜åŒ–ç‰ˆã€‘
     * ä½¿ç”¨æ¸¸æ ‡(Cursor) + Blob æ‹¼æ¥ï¼Œé¿å…ä¸€æ¬¡æ€§å°† 300MB æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­
     */
    // ==========================================================
    // === å¤‡ä»½åŠŸèƒ½ï¼šã€å›¾ç‰‡åˆ†ç¦»ç‰ˆã€‘(æºå¤´å‡è´Ÿ) ===
    // ==========================================================

    // ==========================================================
    // === å¤‡ä»½åŠŸèƒ½ï¼šã€å›¾ç‰‡å»é‡ + åˆ†ç¦»ç‰ˆã€‘ ===
    // ==========================================================
    async function backupData() {
        let loadingDiv = null;

        try {
            const date = new Date();
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

            const zip = new JSZip();
            const dataFolder = zip.folder("data");
            const imagesFolder = zip.folder("images");

            // === UI ===
            loadingDiv = document.createElement('div');
            loadingDiv.className = 'system-loader-overlay';
            loadingDiv.innerHTML = `
            ${SYSTEM_LOADER_CSS}
            <div class="system-loader-card">
                <div class="loader-icon-wrapper bounce-icon">ğŸ“¦</div>
                <div class="loader-title">æ­£åœ¨å¤‡ä»½æ•°æ®</div>
                <div class="loader-desc" id="backup-status-text">å‡†å¤‡å¼€å§‹...</div>
                <div class="progress-track">
                    <div class="progress-fill" id="backup-progress-bar"></div>
                </div>
            </div>
        `;
            document.body.appendChild(loadingDiv);

            const progressText = document.getElementById('backup-status-text');
            const progressBar = document.getElementById('backup-progress-bar');

            if (!progressText || !progressBar) throw new Error("UI åˆå§‹åŒ–å¤±è´¥");

            console.log("ğŸš€ å¼€å§‹å›¾ç‰‡å»é‡å¤‡ä»½...");

            // === 1. åˆå§‹åŒ–è®¡æ•°å™¨å’Œã€å»é‡è´¦æœ¬ã€‘ ===
            const globalImgCounter = { count: 0 };
            const globalImgDedupeMap = new Map(); // ç”¨äºè®°å½•å·²ä¿å­˜çš„ Base64

            // === 2. éå†æ•°æ®åº“ ===
            for (let i = 0; i < objectStoreNames.length; i++) {
                const storeName = objectStoreNames[i];

                if (progressText) progressText.textContent = `æå–ä¸­: ${storeName}`;

                // ä¼ å…¥ globalImgDedupeMap
                const storeBlob = await exportStoreWithImages(storeName, imagesFolder, globalImgCounter, globalImgDedupeMap);
                dataFolder.file(`${storeName}.json`, storeBlob);

                const percent = Math.round(((i + 1) / objectStoreNames.length) * 50);
                if (progressBar) progressBar.style.width = `${percent}%`;
            }

            // 3. å†…å­˜å›æ”¶ï¼šè´¦æœ¬ç”¨å®Œäº†ï¼Œæ¸…ç©ºä»¥é‡Šæ”¾å†…å­˜ (å› ä¸º Map å­˜ç€æ‰€æœ‰å›¾ç‰‡çš„ Base64ï¼Œå¾ˆå¤§)
            globalImgDedupeMap.clear();

            // === 3.5 å¯¼å‡º localStorage é¢„è®¾ ===
            const localStoragePresets = {
                themePresets: localStorage.getItem('themePresets'),
                bubblePresets: localStorage.getItem('bubblePresets'),
                meetuStyles: localStorage.getItem('meetuStyles_backup') // Backup Meetu Styles
            };
            zip.file("localStoragePresets.json", JSON.stringify(localStoragePresets));
            console.log("âœ… å·²å¯¼å‡º localStorage é¢„è®¾ï¼ˆä¸»é¢˜é¢„è®¾ã€æ°”æ³¡é¢„è®¾ï¼‰");

            zip.file("version.json", JSON.stringify({
                version: "3.2",
                type: "SevenPhoneBackup_Split_Dedupe",
                date: dateString
            }));

            // === 4. ç”Ÿæˆå‹ç¼©æ–‡ä»¶ ===
            if (progressText) progressText.textContent = `æ­£åœ¨æ‰“åŒ…... (å…± ${globalImgCounter.count} å¼ å›¾ç‰‡)`;

            const content = await zip.generateAsync({
                type: "blob",
                compression: "DEFLATE",
                compressionOptions: { level: 5 },
                streamFiles: true
            }, (metadata) => {
                const percent = 50 + (metadata.percent / 2);
                if (progressText) progressText.textContent = `å‹ç¼©ä¸­: ${metadata.percent.toFixed(0)}%`;
                if (progressBar) progressBar.style.width = `${percent}%`;
            });

            // === 5. ä¸‹è½½ ===
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.download = `phone_77_${dateString}.zip`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            setTimeout(() => URL.revokeObjectURL(url), 10000);

            if (loadingDiv && document.body.contains(loadingDiv)) {
                document.body.removeChild(loadingDiv);
            }

            console.log(`å¤‡ä»½å®Œæˆï¼Œå»é‡åå…±å­˜å›¾ ${globalImgCounter.count} å¼ ï¼Œä½“ç§¯: ${(content.size / 1024 / 1024).toFixed(2)} MB`);

        } catch (error) {
            console.error("å¤‡ä»½å¤±è´¥:", error);
            if (loadingDiv && document.body.contains(loadingDiv)) {
                document.body.removeChild(loadingDiv);
            }
            alert(`âŒ å¤‡ä»½å¤±è´¥: ${error.message}`);
        }
    }

    /**
     * è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼š
     * 1. è¯»ä¸€æ¡æ•°æ®
     * 2. é€’å½’æŸ¥æ‰¾é‡Œé¢çš„ Base64ï¼Œå‰ªåˆ‡å‡ºæ¥å­˜å…¥ ZIP
     * 3. æŠŠ Base64 æ›¿æ¢æˆ "backup://images/xxx.jpg"
     * 4. æŠŠå‰©ä¸‹çš„çº¯æ–‡æœ¬ JSON å­˜å…¥ Blob
     */
    /**
     * ã€æ ¸å¿ƒå‡½æ•°ã€‘é€’å½’æå–å¯¹è±¡ä¸­çš„ Base64 å›¾ç‰‡å¹¶ä¿å­˜åˆ° ZIP
     * @param {Object} obj - å½“å‰å¤„ç†çš„æ•°æ®å¯¹è±¡ï¼ˆä¼šè¢«åŸåœ°ä¿®æ”¹ï¼‰
     * @param {JSZip.folder} imagesFolder - ZIP ä¸­çš„ images æ–‡ä»¶å¤¹å¯¹è±¡
     * @param {Object} counterObj - å›¾ç‰‡è®¡æ•°å™¨ { count: number }
     * @param {Map} imgDedupeMap - å»é‡è´¦æœ¬ Map<base64, filename>
     */
    function extractAndSaveImages(obj, imagesFolder, counterObj, imgDedupeMap) {
        if (!obj || typeof obj !== 'object') return;

        for (const key in obj) {
            const value = obj[key];

            // === æƒ…å†µ A: çº¯ Base64 å­—ç¬¦ä¸² ===
            if (typeof value === 'string' && value.startsWith('data:image/')) {
                console.log(`ğŸ“¸ å‘ç°å›¾ç‰‡å­—æ®µ: ${key}, é•¿åº¦: ${value.length}`);
                const existingFileName = imgDedupeMap.get(value);

                if (existingFileName) {
                    // å·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨å ä½ç¬¦
                    obj[key] = `backup://images/${existingFileName}`;
                    console.log(`â™»ï¸  å›¾ç‰‡å·²å»é‡: ${key} -> ${existingFileName}`);
                } else {
                    // æ–°å›¾ç‰‡ï¼Œæå–å¹¶ä¿å­˜
                    // ä½¿ç”¨å­—ç¬¦ä¸²æ–¹æ³•è€Œéæ­£åˆ™ï¼Œé¿å…é•¿å­—ç¬¦ä¸²åŒ¹é…å¤±è´¥
                    const headerMatch = value.match(/^data:image\/(\w+);base64,/);
                    if (headerMatch) {
                        const ext = headerMatch[1]; // jpeg, png, gif, webp
                        // æˆªå–base64éƒ¨åˆ†ï¼Œå¹¶æ¸…ç†æ‰€æœ‰ç©ºç™½å­—ç¬¦
                        let base64Data = value.substring(headerMatch[0].length);
                        base64Data = base64Data.replace(/\s/g, ''); // ç§»é™¤æ‰€æœ‰ç©ºæ ¼ã€æ¢è¡Œç­‰

                        counterObj.count++;
                        const fileName = `img_${counterObj.count}.${ext}`;

                        // ä¿å­˜åˆ° ZIP
                        imagesFolder.file(fileName, base64Data, { base64: true });

                        // è®°å½•åˆ°å»é‡è´¦æœ¬
                        imgDedupeMap.set(value, fileName);

                        // æ›¿æ¢ä¸ºå ä½ç¬¦
                        const placeholder = `backup://images/${fileName}`;
                        console.log(`ğŸ”§ æ›¿æ¢å‰: ${key} = ${value.substring(0, 30)}...`);
                        obj[key] = placeholder;
                        console.log(`ğŸ”§ æ›¿æ¢å: ${key} = ${obj[key]}`);
                        console.log(`ğŸ”§ éªŒè¯: æ˜¯å¦æˆåŠŸ? ${obj[key] === placeholder ? 'æ˜¯' : 'å¦'}`);
                        console.log(`âœ… å›¾ç‰‡å·²ä¿å­˜å¹¶æ›¿æ¢: ${key} -> ${fileName}`);
                    } else {
                        console.warn(`âš ï¸  æ— æ³•è§£æå›¾ç‰‡æ ¼å¼: ${key}, å€¼: ${value.substring(0, 50)}...`);
                    }
                }
            }
            // === æƒ…å†µ B: CSS url() æ ¼å¼ ===
            // === æƒ…å†µ B: CSS url() æ ¼å¼ (æ”¯æŒå•å¼•å·ã€åŒå¼•å·ã€æ— å¼•å·) ===
            else if (typeof value === 'string' && value.trim().startsWith('url(') && value.includes('data:image/')) {
                // æå–æ‹¬å·å†…çš„ Base64
                // åŒ¹é… url("...") æˆ– url('...') æˆ– url(...)
                const urlMatch = value.match(/^url\(["']?(data:image\/[^"']+)["']?\)$/);
                if (urlMatch) {
                    const base64 = urlMatch[1];
                    const existingFileName = imgDedupeMap.get(base64);

                    if (existingFileName) {
                        obj[key] = `url("backup://images/${existingFileName}")`;
                        console.log(`â™»ï¸  CSSå›¾ç‰‡å·²å»é‡: ${key} -> ${existingFileName}`);
                    } else {
                        // ä½¿ç”¨å­—ç¬¦ä¸²æ–¹æ³•æå–
                        const headerMatch = base64.match(/^data:image\/(\w+);base64,/);
                        if (headerMatch) {
                            const ext = headerMatch[1];
                            let base64Data = base64.substring(headerMatch[0].length);
                            base64Data = base64Data.replace(/\s/g, ''); // æ¸…ç†ç©ºç™½å­—ç¬¦

                            counterObj.count++;
                            const fileName = `img_${counterObj.count}.${ext}`;

                            imagesFolder.file(fileName, base64Data, { base64: true });
                            imgDedupeMap.set(base64, fileName);

                            obj[key] = `url("backup://images/${fileName}")`;
                            console.log(`âœ… CSSå›¾ç‰‡å·²ä¿å­˜å¹¶æ›¿æ¢: ${key} -> ${fileName}`);
                        }
                    }
                }
            }
            // === æƒ…å†µ C: é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡ ===
            else if (typeof value === 'object' && value !== null) {
                extractAndSaveImages(value, imagesFolder, counterObj, imgDedupeMap);
            }
        }
    }

    /**
     * å¯¼å‡º Store å¹¶åˆ†ç¦»å›¾ç‰‡ï¼ˆå«å»é‡é€»è¾‘ï¼‰
     */
    function exportStoreWithImages(storeName, imagesFolder, counterObj, imgDedupeMap) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbHelper.dbName, dbHelper.dbVersion);

            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const cursorRequest = store.openCursor();

                const chunks = [];
                chunks.push('[');
                let isFirst = true;

                cursorRequest.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (!isFirst) chunks.push(',');
                        else isFirst = false;

                        let record = cursor.value;

                        try {
                            record = JSON.parse(JSON.stringify(record));

                            // ã€å…³é”®ä¿®æ”¹ã€‘ï¼šä¼ å…¥å…¨å±€çš„ imgDedupeMap
                            extractAndSaveImages(record, imagesFolder, counterObj, imgDedupeMap);

                            // ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥æ›¿æ¢æ˜¯å¦ç”Ÿæ•ˆ
                            const recordStr = JSON.stringify(record);
                            if (recordStr.includes('backup://images/')) {
                                console.log(`âœ¨ è®°å½•å·²å¤„ç†ï¼ŒåŒ…å«å ä½ç¬¦`);
                            } else if (recordStr.includes('data:image/')) {
                                console.error(`âŒ è­¦å‘Šï¼šè®°å½•ä¸­ä»åŒ…å«base64å›¾ç‰‡ï¼`);
                            }
                            
                            chunks.push(recordStr);

                        } catch (err) {
                            console.warn("å¤„ç†è®°å½•å¤±è´¥", err);
                        }

                        cursor.continue();
                    } else {
                        chunks.push(']');
                        const blob = new Blob(chunks, { type: 'application/json' });
                        chunks.length = 0;
                        resolve(blob);
                    }
                };
                cursorRequest.onerror = (e) => reject(e.target.error);
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }

    /**
     * ã€æ ¸å¿ƒè¾…åŠ©å‡½æ•°ã€‘
     * ä½¿ç”¨æ¸¸æ ‡è¯»å– IndexedDBï¼Œæ‰‹åŠ¨æ‹¼æ¥ JSON å­—ç¬¦ä¸²å¹¶è½¬ä¸º Blob
     * æå¤§åœ°é™ä½å†…å­˜å ç”¨
     */
    function exportStoreToBlob(storeName) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbHelper.dbName, dbHelper.dbVersion); // å‡è®¾ dbHelper æš´éœ²äº†è¿™äº›ï¼Œæˆ–è€…ç›´æ¥ç”¨ dbHelper.db

            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const cursorRequest = store.openCursor();

                // æˆ‘ä»¬ç”¨æ•°ç»„æ”¶é›† JSON ç‰‡æ®µï¼Œæœ€ååˆå¹¶æˆ Blob
                // æ¯”èµ· String += ...ï¼Œæ•°ç»„ push æ€§èƒ½æ›´å¥½ä¸”ä¸å®¹æ˜“çˆ†å†…å­˜
                const chunks = [];

                // JSON æ•°ç»„å¼€å¤´
                chunks.push('[');

                let isFirst = true;

                cursorRequest.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¡ï¼Œå‰é¢åŠ é€—å·
                        if (!isFirst) {
                            chunks.push(',');
                        } else {
                            isFirst = false;
                        }

                        // å°†å•æ¡è®°å½•è½¬ä¸º JSON å­—ç¬¦ä¸²
                        // å³ä½¿æœ‰å›¾ç‰‡ Base64ï¼Œå•æ¡ä¹Ÿä¸ä¼šå¤ªå¤§ï¼Œå¤„ç†å®Œå°±å˜æˆå­—ç¬¦ä¸²å­˜å…¥æ•°ç»„
                        try {
                            const jsonStr = JSON.stringify(cursor.value);
                            chunks.push(jsonStr);
                        } catch (err) {
                            console.error(`å¿½ç•¥ä¸€æ¡æ— æ³•åºåˆ—åŒ–çš„æ•°æ® id:${cursor.key}`, err);
                        }

                        cursor.continue();
                    } else {
                        // æ¸¸æ ‡ç»“æŸï¼Œå°å£ JSON æ•°ç»„
                        chunks.push(']');

                        // ã€å…³é”®ã€‘ï¼šå°†å­—ç¬¦ä¸²æ•°ç»„è½¬æ¢ä¸º Blob å¯¹è±¡
                        // Blob å­˜å‚¨åœ¨æµè§ˆå™¨ç®¡ç†çš„èµ„æºåŒºï¼Œä¸å ç”¨ V8 å¼•æ“çš„å †å†…å­˜
                        const blob = new Blob(chunks, { type: 'application/json' });

                        // ç«‹å³æ¸…ç©º chunks æ•°ç»„ï¼Œé‡Šæ”¾å¼•ç”¨
                        chunks.length = 0;

                        resolve(blob);
                    }
                };

                cursorRequest.onerror = (e) => reject(e.target.error);
            };

            request.onerror = (e) => reject(e.target.error);
        });
    }
    // ==========================================================
    // === æ ¸å¿ƒè¾…åŠ©å‡½æ•°ï¼šé€’å½’è¿˜åŸå›¾ç‰‡ (Image Restoration) ===
    // ==========================================================

    /**
     * é€’å½’éå†å¯¹è±¡ï¼Œæ‰¾åˆ° "backup://images/..." å ä½ç¬¦ï¼Œ
     * ä» ZIP åŒ…ä¸­è¯»å–å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶ï¼Œè½¬å› Base64 å¹¶å¡«å›å»ã€‚
     * * @param {Object} obj - å½“å‰å¤„ç†çš„æ•°æ®å¯¹è±¡ (å¼•ç”¨ä¼ é€’ï¼Œç›´æ¥ä¿®æ”¹)
     * @param {JSZip} zip - è§£å‹åçš„ ZIP å¯¹è±¡
     */
    /**
     * ã€å¢å¼ºç‰ˆã€‘é€’å½’è¿˜åŸå›¾ç‰‡ï¼ˆæ”¯æŒçº¯è·¯å¾„å’Œ CSS url() æ ¼å¼ï¼‰
     */
    async function restoreImagesInRecord(obj, zip) {
        if (!obj || typeof obj !== 'object') return;

        for (const key in obj) {
            const value = obj[key];

            try {
                // === æƒ…å†µ A: æ™®é€šå ä½ç¬¦ backup://images/xxx.jpg ===
                if (typeof value === 'string' && value.startsWith('backup://images/')) {
                    const fileName = value.replace('backup://images/', '');
                    const base64 = await loadBase64FromZip(zip, fileName);
                    if (base64) {
                        obj[key] = base64; // è¿˜åŸå› data:image/...
                    }
                }
                // === æƒ…å†µ B: CSS URL å ä½ç¬¦ url("backup://images/...") ===
                else if (typeof value === 'string' && value.startsWith('url("backup://images/')) {
                    // æå–æ–‡ä»¶å: url("backup://images/img_1.png") -> img_1.png
                    const match = value.match(/url\("backup:\/\/images\/([^"]+)"\)/);
                    if (match && match[1]) {
                        const fileName = match[1];
                        const base64 = await loadBase64FromZip(zip, fileName);
                        if (base64) {
                            obj[key] = `url("${base64}")`; // è¿˜åŸå› url("data:image...")
                        }
                    }
                }
                // === æƒ…å†µ C: é€’å½’ ===
                else if (typeof value === 'object' && value !== null) {
                    await restoreImagesInRecord(value, zip);
                }
            } catch (error) {
                // ã€iOSä¼˜åŒ–ã€‘å•å¼ å›¾ç‰‡å¤±è´¥ä¸åº”é˜»å¡æ•´ä¸ªå¯¼å…¥
                console.warn(`å›¾ç‰‡è¿˜åŸå¤±è´¥ (${key}):`, error.message);
                // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå­—æ®µ
            }
        }
    }

    /**
     * å†…éƒ¨å¤ç”¨å‡½æ•°ï¼šä» ZIP è¯»å–æ–‡ä»¶å¹¶è½¬ Base64
     */
    async function loadBase64FromZip(zip, fileName) {
        const fileInZip = zip.file(`images/${fileName}`) || zip.file(fileName);
        if (!fileInZip) {
            // console.warn(`å›¾ç‰‡ä¸¢å¤±: ${fileName}`);
            return null;
        }

        const base64Part = await fileInZip.async('base64');

        // è¡¥å…¨å‰ç¼€
        let prefix = 'data:image/jpeg;base64,';
        if (fileName.toLowerCase().endsWith('.png')) prefix = 'data:image/png;base64,';
        else if (fileName.toLowerCase().endsWith('.gif')) prefix = 'data:image/gif;base64,';
        else if (fileName.toLowerCase().endsWith('.webp')) prefix = 'data:image/webp;base64,';

        return prefix + base64Part;
    }



    // === è¾…åŠ©å‡½æ•°ï¼šæ•°ç»„åˆ†å—ï¼ˆç”¨äºåˆ†æ‰¹å†™å…¥æ•°æ®åº“ï¼‰ ===
    function chunkArray(array, chunkSize) {
        const chunks = [];
        for (let i = 0; i < array.length; i += chunkSize) {
            chunks.push(array.slice(i, i + chunkSize));
        }
        return chunks;
    }

    /**
     * å¯¼å…¥åŠŸèƒ½ï¼šã€å¤§æ–‡ä»¶æ€§èƒ½ä¼˜åŒ–ç‰ˆã€‘
     * é‡‡ç”¨â€œæµå¼å¤„ç†â€æ€æƒ³ï¼šè¯»ä¸€ä¸ªè¡¨ -> å†™ä¸€ä¸ªè¡¨ -> é‡Šæ”¾å†…å­˜ -> è¯»ä¸‹ä¸€ä¸ªè¡¨
     * å½»åº•è§£å†³ 100MB+ èŠå¤©è®°å½•å¯¼è‡´æµè§ˆå™¨å´©æºƒçš„é—®é¢˜
     */
    // ==========================================================
    // === å¯¼å…¥åŠŸèƒ½ï¼šã€å›¾ç‰‡å›å¡« + å†…å­˜é˜²çˆ†ç‰ˆã€‘ ===
    // ==========================================================

    async function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm("âš ï¸ è­¦å‘Šï¼šå¯¼å…¥å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼\nå»ºè®®å…ˆå¤‡ä»½ç°æœ‰æ•°æ®ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
            event.target.value = ''; // æ¸…ç©ºé€‰æ‹©ï¼Œæ–¹ä¾¿ä¸‹æ¬¡é€‰åŒä¸€ä¸ªæ–‡ä»¶
            return;
        }

        // åˆ›å»ºå…¨å±åŠ è½½æç¤º
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'system-loader-overlay';
        loadingDiv.innerHTML = `
        ${SYSTEM_LOADER_CSS}
        <div class="system-loader-card">
            <div class="loader-icon-wrapper">
                <div class="spinner-ios"></div>
            </div>
            <div class="loader-title">æ­£åœ¨æ¢å¤æ•°æ®</div>
            <div class="loader-desc" id="import-status-text">è§£ææ–‡ä»¶ä¸­...</div>
            <div class="progress-track">
                <div class="progress-fill" id="import-progress-bar"></div>
            </div>
        </div>
    `;
        document.body.appendChild(loadingDiv);

        // è·å– UI å…ƒç´ å¼•ç”¨ (æ³¨æ„ ID å˜åŒ–)
        const statusText = document.getElementById('import-status-text');
        const progressBar = document.getElementById('import-progress-bar');

        try {
            console.log("ğŸ“‚ å¼€å§‹è§£æå¤‡ä»½æ–‡ä»¶...");

            // â–¼â–¼â–¼ã€å…¼å®¹æ€§ä¿®å¤ã€‘æ£€æµ‹æ–‡ä»¶ç±»å‹ï¼šJSON è¿˜æ˜¯ ZIP â–¼â–¼â–¼
            const fileName = file.name.toLowerCase();
            const isZipFile = fileName.endsWith('.zip');
            const isJsonFile = fileName.endsWith('.json');

            if (isJsonFile) {
                // === æ—§ç‰ˆ JSON æ ¼å¼å¯¼å…¥ ===
                console.log("ğŸ“„ æ£€æµ‹åˆ° JSON æ ¼å¼å¤‡ä»½ï¼Œä½¿ç”¨æ—§ç‰ˆå¯¼å…¥é€»è¾‘...");
                statusText.textContent = "æ­£åœ¨è¯»å– JSON æ–‡ä»¶...";

                const text = await file.text();
                const jsonData = JSON.parse(text);

                // éå† JSON ä¸­çš„æ¯ä¸ªè¡¨
                let totalCount = 0;
                const keys = Object.keys(jsonData);

                for (let i = 0; i < keys.length; i++) {
                    const storeName = keys[i];
                    const records = jsonData[storeName];

                    if (!Array.isArray(records) || records.length === 0) continue;

                    statusText.textContent = `æ­£åœ¨æ¢å¤: ${storeName}...`;
                    const percent = Math.round(((i + 1) / keys.length) * 100);
                    if (progressBar) progressBar.style.width = `${percent}%`;

                    // æ¸…ç©ºæ—§æ•°æ®
                    try {
                        await dbHelper.clearStore(storeName);
                    } catch (e) {
                        console.warn(`è·³è¿‡æ¸…ç©ºä¸å­˜åœ¨çš„è¡¨: ${storeName}`);
                        continue;
                    }

                    // ã€iOSä¼˜åŒ–ã€‘åˆ†æ‰¹å†™å…¥æ•°æ®ï¼Œé¿å…ä¸€æ¬¡æ€§å¤„ç†å¤§é‡è®°å½•
                    const BATCH_SIZE = 50;
                    for (let batchStart = 0; batchStart < records.length; batchStart += BATCH_SIZE) {
                        const batchEnd = Math.min(batchStart + BATCH_SIZE, records.length);
                        const batch = records.slice(batchStart, batchEnd);
                        
                        // æ›´æ–°è¿›åº¦
                        const batchPercent = Math.round(((i + (batchStart / records.length)) / keys.length) * 100);
                        statusText.textContent = `æ¢å¤ ${storeName}: ${batchStart}/${records.length}`;
                        if (progressBar) progressBar.style.width = `${batchPercent}%`;
                        
                        // å†™å…¥è¿™ä¸€æ‰¹æ•°æ®
                        for (const record of batch) {
                            try {
                                if (record.id !== undefined && record.value !== undefined) {
                                    await dbHelper.saveData(storeName, record.id, record.value);
                                } else if (record.id !== undefined) {
                                    await dbHelper.updateRecord(storeName, record);
                                }
                            } catch (e) {
                                console.warn(`è·³è¿‡æ— æ•ˆè®°å½•:`, record);
                            }
                        }
                        
                        // æ¯æ‰¹ä¹‹é—´æš‚åœï¼Œè®©æµè§ˆå™¨GC
                        await new Promise(resolve => setTimeout(resolve, 20));
                    }

                    totalCount++;
                    console.log(`âœ… è¡¨ ${storeName} æ¢å¤å®Œæˆï¼Œå…± ${records.length} æ¡`);
                }

                document.body.removeChild(loadingDiv);
                alert(`ğŸ‰ JSON å¯¼å…¥æˆåŠŸï¼\\næˆåŠŸæ¢å¤äº† ${totalCount} ä¸ªæ¨¡å—çš„æ•°æ®ã€‚`);
                location.reload();
                return;
            }


            // === æ–°ç‰ˆ ZIP æ ¼å¼å¯¼å…¥ ===
            console.log("ğŸ“¦ æ£€æµ‹åˆ° ZIP æ ¼å¼å¤‡ä»½ï¼Œä½¿ç”¨æ–°ç‰ˆå¯¼å…¥é€»è¾‘...");

            // 1. åŠ è½½ ZIP
            const zip = await JSZip.loadAsync(file);

            // æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶ (å¯é€‰)
            const versionFile = zip.file("version.json");
            if (versionFile) {
                const versionData = JSON.parse(await versionFile.async("string"));
                console.log("å¤‡ä»½ç‰ˆæœ¬ä¿¡æ¯:", versionData);
            }

            let totalCount = 0;

            // 2. éå†æ•°æ®åº“è¡¨å (objectStoreNames åœ¨ main.js å¼€å¤´å®šä¹‰çš„é‚£ä¸ªæ•°ç»„)
            for (const storeName of objectStoreNames) {

                // å°è¯•åœ¨ ZIP æ ¹ç›®å½•æˆ– data/ ç›®å½•ä¸‹æ‰¾ json æ–‡ä»¶
                let fileInZip = zip.file(`${storeName}.json`) || zip.file(`data/${storeName}.json`);

                if (!fileInZip) {
                    console.log(`è·³è¿‡: ZIPä¸­æœªæ‰¾åˆ° ${storeName} è¡¨çš„æ•°æ®`);
                    continue;
                }

                statusText.textContent = `æ­£åœ¨è¯»å–: ${storeName}...`;

                // 3. è¯»å– JSON å†…å®¹
                const content = await fileInZip.async("string");
                let records = [];
                try {
                    records = JSON.parse(content);
                } catch (e) {
                    console.error(`JSON è§£æå¤±è´¥: ${storeName}`, e);
                    continue;
                }

                if (records && Array.isArray(records) && records.length > 0) {
                    statusText.textContent = `æ­£åœ¨æ¸…ç©ºæ—§æ•°æ®: ${storeName}...`;

                    // 4. æ¸…ç©ºæ—§æ•°æ® (æ ¹æ®éœ€æ±‚ï¼Œå¦‚æœæƒ³å¢é‡å¯¼å…¥å°±æŠŠè¿™è¡Œåˆ æ‰)
                    await dbHelper.clearStore(storeName);

                    // 5. åˆ†æ‰¹å¤„ç† (Batch Processing) - iOSå†…å­˜ä¼˜åŒ–ç‰ˆ
                    // æ­¤æ—¶ records é‡Œå­˜çš„å›¾ç‰‡è¿˜æ˜¯ "backup://images/xxx.jpg"
                    // æˆ‘ä»¬éœ€è¦åœ¨å†™å…¥æ•°æ®åº“å‰ï¼ŒæŠŠå®ƒä»¬å˜å› Base64

                    // ã€iOSä¼˜åŒ–ã€‘é™ä½æ‰¹æ¬¡å¤§å°ï¼Œå‡å°‘å†…å­˜å³°å€¼
                    const BATCH_SIZE = 50; // iOSè®¾å¤‡å†…å­˜æœ‰é™ï¼Œä»100é™åˆ°50
                    const chunks = chunkArray(records, BATCH_SIZE);
                    const totalRecords = records.length;

                    for (let i = 0; i < chunks.length; i++) {
                        const chunk = chunks[i];

                        // æ›´æ–°è¿›åº¦æ¡
                        const percent = Math.round(((i * BATCH_SIZE) / totalRecords) * 100);

                        // æ›´æ–° UI
                        statusText.textContent = `æ¢å¤ ${storeName}: ${percent}% (${i * BATCH_SIZE}/${totalRecords})`;
                        if (progressBar) progressBar.style.width = `${percent}%`;

                        // --- A. ã€å…³é”®ä¼˜åŒ–ã€‘ä¸²è¡Œè¿˜åŸå›¾ç‰‡ï¼Œé¿å…å†…å­˜å³°å€¼ ---
                        // iOS Safariå¯¹å¹¶å‘Base64å¤„ç†éå¸¸æ•æ„Ÿï¼Œæ”¹ä¸ºé€æ¡å¤„ç†
                        for (let j = 0; j < chunk.length; j++) {
                            await restoreImagesInRecord(chunk[j], zip);
                            
                            // æ¯å¤„ç†10æ¡è®°å½•ï¼Œç»™æµè§ˆå™¨ä¸€ä¸ªå‘¼å¸çš„æœºä¼š
                            if (j % 10 === 0 && j > 0) {
                                await new Promise(resolve => setTimeout(resolve, 0));
                            }
                        }

                        // --- B. å¹¶è¡Œå†™å…¥æ•°æ®åº“ ---
                        const writePromises = chunk.map(record => {
                            // å…¼å®¹ä¸åŒè¡¨ç»“æ„çš„å†™å…¥é€»è¾‘
                            if (storeName === 'emojiStore') {
                                return dbHelper.updateRecord(storeName, record);
                            }
                            // å…¼å®¹ {id:..., value:...} ç»“æ„ (æ—§ç‰ˆå¤‡ä»½)
                            else if (record.id !== undefined && record.value !== undefined) {
                                return dbHelper.saveData(storeName, record.id, record.value);
                            }
                            // å…¼å®¹ç›´æ¥å¯¹è±¡ç»“æ„ (æ–°ç‰ˆæ¨è)
                            else if (record.id !== undefined) {
                                return dbHelper.updateRecord(storeName, record);
                            }
                            return Promise.resolve(); // å…œåº•
                        });

                        // ç­‰å¾…è¿™ä¸€æ‰¹å†™å…¥å®Œæˆ
                        await Promise.all(writePromises);

                        // ã€iOSä¼˜åŒ–ã€‘æ˜¾å¼é‡Šæ”¾å†…å­˜ + å¼ºåˆ¶åƒåœ¾å›æ”¶æç¤º
                        chunk.forEach((r, idx) => {
                            chunk[idx] = null;
                        });
                        
                        // æ¯æ‰¹æ¬¡ä¹‹é—´æš‚åœï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šè¿›è¡Œåƒåœ¾å›æ”¶
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }

                    totalCount++;
                    console.log(`âœ… è¡¨ ${storeName} æ¢å¤å®Œæˆï¼Œå…± ${totalRecords} æ¡`);

                    // é‡Šæ”¾å¤§æ•°ç»„å†…å­˜
                    records = null;
                }
            }

            statusText.textContent = "æ­£åœ¨å®Œæˆ...";

            // === æ¢å¤ localStorage é¢„è®¾ ===
            const presetsFile = zip.file("localStoragePresets.json");
            if (presetsFile) {
                try {
                    const presetsContent = await presetsFile.async("string");
                    const presets = JSON.parse(presetsContent);
                    if (presets.themePresets) {
                        localStorage.setItem('themePresets', presets.themePresets);
                        console.log("âœ… å·²æ¢å¤ä¸»é¢˜é¢„è®¾");
                    }
                    if (presets.bubblePresets) {
                        localStorage.setItem('bubblePresets', presets.bubblePresets);
                        console.log("âœ… å·²æ¢å¤æ°”æ³¡é¢„è®¾");
                    }
                    if (presets.meetuStyles) {
                        localStorage.setItem('meetuStyles_backup', presets.meetuStyles);
                        console.log("âœ… å·²æ¢å¤ç¬”é£é¢„è®¾ (LocalStorage)");
                    }
                } catch (e) {
                    console.warn("localStorage é¢„è®¾æ¢å¤å¤±è´¥:", e);
                }
            }

            // è¿è¡Œä½ çš„è¯Šæ–­æ£€æŸ¥ (å¦‚æœæœ‰)
            if (typeof runDiagnosticCheck === 'function') {
                await runDiagnosticCheck();
            }

            document.body.removeChild(loadingDiv);
            alert(`ğŸ‰ å¯¼å…¥æˆåŠŸï¼\næˆåŠŸæ¢å¤äº† ${totalCount} ä¸ªæ¨¡å—çš„æ•°æ®ã€‚`);

            // åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ•°æ®
            location.reload();

        } catch (error) {
            console.error("å¯¼å…¥è¿‡ç¨‹ä¸­å‡ºé”™:", error);
            if (document.body.contains(loadingDiv)) document.body.removeChild(loadingDiv);
            alert(`âŒ å¯¼å…¥å¤±è´¥: ${error.message}`);
        } finally {
            // æ¸…ç©º inputï¼Œå…è®¸å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }
    }
    // ä¸ºæŒ‰é’®ç»‘å®šäº‹ä»¶
    backupDataBtn.addEventListener('click', backupData);
    importDataBtn.addEventListener('click', () => importFileInput.click()); // ç‚¹å‡»â€œå¯¼å…¥â€æŒ‰é’®ï¼Œå®é™…æ˜¯è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
    importFileInput.addEventListener('change', handleFileImport);

    // === æ­Œå•åç§°ç¼–è¾‘åŠŸèƒ½ ===
    editPlaylistNameBtn.addEventListener('click', async () => {
        if (!currentOpenPlaylist) return;

        const newName = prompt("è¯·è¾“å…¥æ–°çš„æ­Œå•åç§°ï¼š", currentOpenPlaylist);

        if (newName === null || newName.trim() === "") return;

        const trimmedNewName = newName.trim();
        if (trimmedNewName === currentOpenPlaylist) return;

        try {
            // 1. ä»æ•°æ®åº“åŠ è½½æœ€æ–°çš„å®Œæ•´æ­Œå•åˆ—è¡¨
            const allPlaylistsData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
            if (!allPlaylistsData || typeof allPlaylistsData.value !== 'object') {
                throw new Error("æ— æ³•åŠ è½½æ­Œå•æ•°æ®åº“ã€‚");
            }
            let allPlaylists = allPlaylistsData.value;

            // 2. æ£€æŸ¥æ–°åç§°æ˜¯å¦å†²çª
            if (allPlaylists[trimmedNewName]) {
                alert("é”™è¯¯ï¼šè¯¥æ­Œå•åç§°å·²å­˜åœ¨ï¼");
                return;
            }

            // 3. åœ¨å†…å­˜ä¸­æ‰§è¡Œé‡å‘½åæ“ä½œ
            allPlaylists[trimmedNewName] = allPlaylists[currentOpenPlaylist];
            delete allPlaylists[currentOpenPlaylist];

            // 4. å°†ä¿®æ”¹åçš„å®Œæ•´æ­Œå•åˆ—è¡¨ï¼Œä¸€æ¬¡æ€§å­˜å›æ•°æ®åº“
            await dbHelper.saveData('musicPlaylists', 'allPlaylists', allPlaylists);

            // --- 5. æ ¸å¿ƒä¿®å¤ï¼šä¸å†æ‰‹åŠ¨ä¿®æ”¹UIï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨åŠ è½½å‡½æ•°æ¥é‡æ–°æ¸²æŸ“ ---
            await loadPlaylists(); // è¿™ä¼šæ ¹æ®æœ€æ–°çš„æ•°æ®åº“æ•°æ®ï¼Œé‡æ–°ç»˜åˆ¶æ•´ä¸ªæ­Œå•åˆ—è¡¨

            // 6. æ›´æ–°è¯¦æƒ…é¡µçš„æ ‡é¢˜å’Œå…¨å±€çŠ¶æ€å˜é‡
            const titleElement = document.getElementById('playlist-name-title');
            if (titleElement) {
                titleElement.textContent = trimmedNewName;
            }
            currentOpenPlaylist = trimmedNewName;

            alert("æ­Œå•åç§°å·²æ›´æ–°ï¼");

        } catch (error) {
            console.error("ç¼–è¾‘æ­Œå•åç§°å¤±è´¥:", error);
            alert(`ç¼–è¾‘å¤±è´¥: ${error.message}`);
        }
    });

    // === æ–°å¢ï¼šæ­Œå•å¤šé€‰ä¸åˆ é™¤çš„å…¨éƒ¨é€»è¾‘ ===

    // --- â€œå¤šé€‰â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ ---
    // === ä¿®å¤ï¼šéŸ³ä¹æ­Œå•åˆ—è¡¨å¤šé€‰é€»è¾‘ (å¸¦åˆ é™¤åŠŸèƒ½) ===
    playlistMultiselectBtn.addEventListener('click', () => {
        isPlaylistDeleteMode = !isPlaylistDeleteMode;
        playlistGrid.classList.toggle('delete-mode', isPlaylistDeleteMode);

        const iconSelect = playlistMultiselectBtn.querySelector('.icon-select');
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ç®€å•ç‚¹ï¼Œå¦‚æœä½ çš„SVGç»“æ„ä¸åŒï¼Œè¯·ç¡®ä¿èƒ½è·å–åˆ°å›¾æ ‡
        // æˆ–è€…ç›´æ¥ç”¨ display æ§åˆ¶

        // è·å–ä¸»æ“ä½œæŒ‰é’®
        const actionBtn = document.getElementById('add-playlist-btn');

        if (isPlaylistDeleteMode) {
            // --- è¿›å…¥åˆ é™¤æ¨¡å¼ ---
            // 1. åˆ‡æ¢å³ä¸Šè§’å›¾æ ‡ä¸ºâ€œå–æ¶ˆâ€ (å¦‚æœä½ æœ‰icon-cancelçš„è¯ï¼Œå¦åˆ™ä¿æŒé«˜äº®)
            playlistMultiselectBtn.style.color = '#007AFF';

            // 2. ã€å…³é”®ã€‘ä¸»æŒ‰é’®å˜èº«ï¼šè“è‰²æ–°å»º -> çº¢è‰²åˆ é™¤
            actionBtn.textContent = 'åˆ é™¤æ‰€é€‰æ­Œå•';
            actionBtn.classList.add('delete-mode-btn'); // æ·»åŠ ä¸€ä¸ªä¸“ç”¨æ ·å¼ç±»
            actionBtn.style.backgroundColor = 'rgba(255, 59, 48, 0.15)'; // çº¢è‰²èƒŒæ™¯
            actionBtn.style.color = '#FF3B30'; // çº¢è‰²æ–‡å­—
            actionBtn.style.borderColor = 'rgba(255, 59, 48, 0.3)';

        } else {
            // --- é€€å‡ºåˆ é™¤æ¨¡å¼ ---
            playlistMultiselectBtn.style.color = ''; // æ¢å¤é»˜è®¤é¢œè‰²

            // æ¢å¤ä¸»æŒ‰é’®
            actionBtn.textContent = 'æ–°å»ºæ­Œå•';
            actionBtn.classList.remove('delete-mode-btn');
            // æ¸…é™¤å†…è”æ ·å¼ï¼Œæ¢å¤ CSS é»˜è®¤
            actionBtn.style.backgroundColor = '';
            actionBtn.style.color = '';
            actionBtn.style.borderColor = '';

            // å–æ¶ˆæ‰€æœ‰å‹¾é€‰
            playlistGrid.querySelectorAll('.playlist-checkbox').forEach(cb => cb.checked = false);
        }
    });
    // --- ä¿®æ”¹â€œæ–°å»ºæ­Œå•â€æŒ‰é’®çš„è¡Œä¸ºï¼Œä½¿å…¶åœ¨åˆ é™¤æ¨¡å¼ä¸‹æ‰§è¡Œåˆ é™¤ ---
    addPlaylistBtn.addEventListener('click', () => {
        if (isPlaylistDeleteMode) {
            // å¦‚æœæ˜¯åˆ é™¤æ¨¡å¼ï¼Œåˆ™æ‰§è¡Œåˆ é™¤
            handleBatchDeletePlaylists();
        } else {
            // å¦åˆ™ï¼Œæ‰§è¡Œæ–°å»º
            createNewPlaylist();
        }
    });
    // å°†åŸæœ‰çš„æ–°å»ºé€»è¾‘å°è£…æˆä¸€ä¸ªå‡½æ•°
    async function createNewPlaylist() {
        const playlistName = prompt("è¯·è¾“å…¥æ–°çš„æ­Œå•åç§°ï¼š");
        if (playlistName && playlistName.trim() !== "") {
            const newName = playlistName.trim();
            try {
                const existingData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
                let playlists = (existingData && typeof existingData.value === 'object') ? existingData.value : {};
                if (playlists[newName]) {
                    alert("æ­Œå•åç§°å·²å­˜åœ¨ï¼");
                    return;
                }
                playlists[newName] = { songs: [], coverUrl: null };
                await dbHelper.saveData('musicPlaylists', 'allPlaylists', playlists);
                createPlaylistCard(newName, playlists[newName]);
            } catch (error) {
                console.error("ä¿å­˜æ­Œå•å¤±è´¥:", error);
            }
        }
    }

    // --- æ‰¹é‡åˆ é™¤çš„æ‰§è¡Œå‡½æ•° ---
    async function handleBatchDeletePlaylists() {
        const selectedCheckboxes = playlistGrid.querySelectorAll('.playlist-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„æ­Œå•ã€‚');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} ä¸ªæ­Œå•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
            return;
        }

        const namesToDelete = new Set();
        selectedCheckboxes.forEach(cb => {
            const card = cb.closest('.playlist-card');
            namesToDelete.add(card.dataset.playlistName);
        });

        try {
            const existingData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
            let playlists = existingData.value;

            namesToDelete.forEach(name => {
                delete playlists[name];
            });

            await dbHelper.saveData('musicPlaylists', 'allPlaylists', playlists);

            await loadPlaylists();
            playlistMultiselectBtn.click(); // æ“ä½œå®Œæˆåè‡ªåŠ¨é€€å‡ºå¤šé€‰æ¨¡å¼

        } catch (error) {
            console.error("åˆ é™¤æ­Œå•å¤±è´¥:", error);
            alert("åˆ é™¤å¤±è´¥");
        }
    }
    // === æ–°å¢ï¼šå…¨å±€å­—ä½“æ›´æ¢çš„å…¨éƒ¨é€»è¾‘ ===

    const defaultFontFamily = "sans-serif"; // å®šä¹‰ä¸€ä¸ªé»˜è®¤å­—ä½“

    /**
     * åº”ç”¨è‡ªå®šä¹‰å­—ä½“æˆ–æ¢å¤é»˜è®¤å­—ä½“çš„æ ¸å¿ƒå‡½æ•°
     * @param {string | null} fontDataUrl - Base64æ ¼å¼çš„å­—ä½“æ•°æ®URLï¼Œæˆ– null ä»¥æ¢å¤é»˜è®¤
     */
    function applyCustomFont(fontDataUrl) {
        if (fontDataUrl) {
            // å¦‚æœæœ‰è‡ªå®šä¹‰å­—ä½“æ•°æ®ï¼Œåˆ™åˆ›å»º @font-face è§„åˆ™å¹¶åº”ç”¨
            const fontFaceRule = `
            @font-face {
                font-family: 'CustomGlobalFont';
                src: url(${fontDataUrl});
            }
        `;
            customFontStyle.innerHTML = fontFaceRule;
            phoneFrame.style.fontFamily = "'CustomGlobalFont', " + defaultFontFamily;
        } else {
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ™æ¸…ç©ºè§„åˆ™å¹¶æ¢å¤é»˜è®¤å­—ä½“
            customFontStyle.innerHTML = '';
            phoneFrame.style.fontFamily = defaultFontFamily;
        }
    }





    // å°†è¿™æ®µä»£ç æ·»åŠ åˆ°ä½ çš„è„šæœ¬åŒºåŸŸï¼Œå’Œå…¶ä»–äº‹ä»¶ç›‘å¬å™¨æ”¾åœ¨ä¸€èµ·

    navigator.serviceWorker.addEventListener('message', event => {
        const data = event.data;
        if (data.type === 'OPEN_CHAT' && data.contactId) {
            console.log(`æ”¶åˆ°æ¥è‡ª Service Worker çš„æŒ‡ä»¤ï¼Œæ­£åœ¨æ‰“å¼€è”ç³»äººID: ${data.contactId} çš„èŠå¤©ã€‚`);
            // è°ƒç”¨ä½ å·²æœ‰çš„ openChatView å‡½æ•°
            openChatView(data.contactId);
        }
    });



    // 1. ç‚¹å‡»â€œæ›´æ¢å­—ä½“â€æŒ‰é’®
    changeFontBtn.addEventListener('click', () => {
        fontImportInput.click(); // è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
    });

    // 2. å½“ç”¨æˆ·é€‰æ‹©äº†å­—ä½“æ–‡ä»¶å
    fontImportInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const fontDataUrl = e.target.result;
            try {
                // a. å°†å­—ä½“æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“
                await dbHelper.saveData('settingsStore', 'customFont', fontDataUrl);
                // b. ç«‹å³åº”ç”¨æ–°å­—ä½“
                applyCustomFont(fontDataUrl);
                alert('å­—ä½“å·²æˆåŠŸåº”ç”¨ï¼');
            } catch (error) {
                console.error("ä¿å­˜æˆ–åº”ç”¨å­—ä½“å¤±è´¥:", error);
                alert("å­—ä½“åº”ç”¨å¤±è´¥");
            }
        };
        // å°†å­—ä½“æ–‡ä»¶è¯»å–ä¸ºBase64 Data URL
        reader.readAsDataURL(file);
        event.target.value = ''; // æ¸…ç©ºè¾“å…¥ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
    });

    // 3. ç‚¹å‡»â€œæ¢å¤é»˜è®¤â€æŒ‰é’®
    restoreFontBtn.addEventListener('click', async () => {
        if (confirm("ç¡®å®šè¦æ¢å¤ä¸ºé»˜è®¤å­—ä½“å—ï¼Ÿ")) {
            try {
                // a. ä»æ•°æ®åº“åˆ é™¤è‡ªå®šä¹‰å­—ä½“è®°å½•
                await dbHelper.deleteData('settingsStore', 'customFont');
                // b. ç«‹å³æ¢å¤é»˜è®¤å­—ä½“
                applyCustomFont(null);
                alert('å·²æ¢å¤é»˜è®¤å­—ä½“ï¼');
            } catch (error) {
                console.error("æ¢å¤é»˜è®¤å­—ä½“å¤±è´¥:", error);
                alert("æ¢å¤å¤±è´¥");
            }
        }
    });

    // === æ–°å¢ï¼šèŠå¤©è®°å½•æœç´¢åŠŸèƒ½çš„å…¨éƒ¨é€»è¾‘ ===

    // 1. è·å–æ–°æ·»åŠ çš„HTMLå…ƒç´ 
    const chatSearchButton = document.getElementById('chat-search-button');
    const searchModal = document.getElementById('search-modal');
    const searchModalCloseBtn = document.getElementById('search-modal-close-btn');
    const searchInput = document.getElementById('search-input');
    const searchResultsContainer = document.getElementById('search-results-container');
    let searchDebounceTimer;

    // 2. æ‰“å¼€å’Œå…³é—­æœç´¢å¯¹è¯æ¡†çš„å‡½æ•°
    function openSearchModal() {
        searchModal.style.display = 'flex';
        setTimeout(() => {
            searchModal.style.opacity = '1';
            searchModal.querySelector('.modal-content').style.transform = 'scale(1)';
            searchInput.focus(); // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
        }, 10);
    }

    function closeSearchModal() {
        searchInput.blur();
        searchModal.style.opacity = '0';
        searchModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            searchModal.style.display = 'none';
            searchInput.value = ''; // æ¸…ç©ºè¾“å…¥
            searchResultsContainer.innerHTML = ''; // æ¸…ç©ºç»“æœ
        }, 300);
    }

    // 3. ç»‘å®šæ‰“å¼€/å…³é—­äº‹ä»¶
    chatSearchButton.addEventListener('click', openSearchModal);
    searchModalCloseBtn.addEventListener('click', closeSearchModal);


    /**
     * ã€æœ€ç»ˆç‰ˆã€‘æ ¹æ®å…³é”®è¯åˆ›å»ºå±…ä¸­ã€å¸¦çœç•¥å·çš„æ¶ˆæ¯æ‘˜è¦
     * (å·²é›†æˆç§»é™¤æ¢è¡Œç¬¦åŠŸèƒ½ï¼Œç¡®ä¿å•è¡Œæ˜¾ç¤º)
     */
    /**
     * ã€æœ€ç»ˆç‰ˆ V2ã€‘æ ¹æ®å…³é”®è¯åˆ›å»ºå±…ä¸­ã€å¸¦çœç•¥å·çš„æ¶ˆæ¯æ‘˜è¦
     * (æˆªå–é•¿åº¦å·²æ ¹æ®è¦æ±‚è°ƒæ•´ä¸º3)
     */
    function createSnippet(fullText, keyword, contextLength = 3) { // <--- æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ
        // é¦–å…ˆï¼Œç§»é™¤åŸå§‹æ–‡æœ¬ä¸­çš„æ‰€æœ‰æ¢è¡Œç¬¦ï¼Œå°†å…¶æ›¿æ¢ä¸ºç©ºæ ¼
        const cleanText = fullText.replace(/(\r\n|\n|\r)/gm, " ");

        const keywordIndex = cleanText.toLowerCase().indexOf(keyword.toLowerCase());

        if (keywordIndex === -1) {
            let snippet = cleanText.substring(0, contextLength * 2 + keyword.length);
            return snippet + '...';
        }

        const startIndex = Math.max(0, keywordIndex - contextLength);
        const endIndex = Math.min(cleanText.length, keywordIndex + keyword.length + contextLength);

        let snippet = cleanText.substring(startIndex, endIndex);

        if (startIndex > 0) {
            snippet = '...' + snippet;
        }

        if (endIndex < cleanText.length) {
            snippet = snippet + '...';
        }

        return snippet;
    }

    /**
     * ã€æœ€ç»ˆç‰ˆã€‘æ¸²æŸ“æœç´¢ç»“æœçš„å‡½æ•°
     * (ä½¿ç”¨ä¸“å±ç±»å chatsearch-content)
     */
    /**
    * ã€æœ€ç»ˆç‰ˆã€‘æ¸²æŸ“æœç´¢ç»“æœçš„å‡½æ•°
    * (ä½¿ç”¨æ­£ç¡®çš„ä¸¤è¡Œå¼HTMLç»“æ„ï¼Œå¹¶åŒ…å« data-uuid)
    */
    /**
* ã€æœ€ç»ˆç‰ˆã€‘æ¸²æŸ“æœç´¢ç»“æœçš„å‡½æ•° (æ”¯æŒç¾¤èŠ)
*/
    function renderSearchResults(results, keyword, regex) {
        if (results.length === 0) {
            searchResultsContainer.innerHTML = '<p style="text-align:center; color:#888;">æœªæ‰¾åˆ°ç›¸å…³è®°å½•</p>';
            return;
        }

        searchResultsContainer.innerHTML = results.map(result => {
            const messageDate = new Date(result.message.timestamp);
            const formattedTime = `${String(messageDate.getMonth() + 1).padStart(2, '0')}-${String(messageDate.getDate()).padStart(2, '0')} ${String(messageDate.getHours()).padStart(2, '0')}:${String(messageDate.getMinutes()).padStart(2, '0')}`;

            // è·å–ç”¨äºæ˜¾ç¤ºçš„æ–‡æœ¬
            const rawText = result.message.text || (result.message.content ? result.message.content.html : '') || result.message.transcript || '[å¤šåª’ä½“]';
            const snippet = createSnippet(rawText, keyword);
            const highlightedSnippet = snippet.replace(regex, `<span class="highlight">$&</span>`);

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®æ˜¯å¦ç¾¤èŠï¼Œè®¾ç½®ä¸åŒçš„ data å±æ€§ â–¼â–¼â–¼
            const idAttr = result.isGroup ? `data-group-id="${result.contextId}"` : `data-contact-id="${result.contextId}"`;

            return `
    <div class="search-result-item" ${idAttr} data-uuid="${result.message.uuid}">
        <div class="result-header">
            <div class="sender-name">${result.senderName}:</div>
            <div class="time">${formattedTime}</div>
        </div>
        <div class="chatsearch-content">${highlightedSnippet}</div>
    </div>
`;
        }).join('');
    }

    // 4. æ‰§è¡Œæœç´¢å¹¶æ¸²æŸ“ç»“æœ (æ”¯æŒå•èŠå’Œç¾¤èŠ)
    async function performSearch(keyword) {
        // æ£€æŸ¥å…³é”®è¯
        if (!keyword || keyword.length < 1) {
            searchResultsContainer.innerHTML = '';
            return;
        }

        // 1. ç¡®å®šæœç´¢èŒƒå›´ï¼šæ˜¯ç¾¤èŠè¿˜æ˜¯å•èŠï¼Ÿ
        let history = [];
        let contextId = null;
        let isGroup = false;

        if (currentOpenGroup) {
            history = Array.isArray(currentOpenGroup.history) ? currentOpenGroup.history : [];
            contextId = currentOpenGroup.id;
            isGroup = true;
        } else if (currentOpenContact) {
            history = Array.isArray(currentOpenContact.history) ? currentOpenContact.history : [];
            contextId = currentOpenContact.id;
            isGroup = false;
        } else {
            return; // æ²¡æœ‰æ‰“å¼€ä»»ä½•çª—å£
        }

        const results = [];

        // 2. åœ¨å†å²è®°å½•ä¸­æŸ¥æ‰¾
        for (const message of history) {
            // ç¡®ä¿æ¶ˆæ¯æœ‰æ–‡æœ¬å†…å®¹ä¸”åŒ¹é…å…³é”®è¯
            const textToCheck = message.text || (message.content && message.content.html) || (message.transcript) || '';

            if (message.uuid && typeof textToCheck === 'string' && textToCheck.toLowerCase().includes(keyword.toLowerCase())) {

                // ç¡®å®šå‘é€è€…åå­—
                let senderName = 'æœªçŸ¥';
                if (isGroup) {
                    // ç¾¤èŠï¼šå¦‚æœæ˜¯ç”¨æˆ·ï¼Œæ˜¾ç¤ºâ€œæˆ‘â€æˆ–ç¾¤åç‰‡ï¼›å¦‚æœæ˜¯AIï¼Œæ˜¾ç¤ºsenderName
                    if (message.sender === 'user') {
                        senderName = currentOpenGroup.userCardName || 'æˆ‘';
                    } else {
                        senderName = message.senderName || 'ç¾¤å‹';
                    }
                } else {
                    // å•èŠ
                    senderName = message.sender === 'user' ? currentOpenContact.user.name : currentOpenContact.ai.name;
                }

                results.push({
                    message: message,
                    senderName: senderName,
                    contextId: contextId, // å­˜å…¥å½“å‰ä¼šè¯çš„ID
                    isGroup: isGroup      // æ ‡è®°æ˜¯å¦ä¸ºç¾¤èŠ
                });
            }
        }

        // 3. æ¸²æŸ“
        const searchRegex = new RegExp(keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
        renderSearchResults(results, keyword, searchRegex);
    }


    // 5. ç›‘å¬æœç´¢æ¡†çš„è¾“å…¥äº‹ä»¶ (ä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æ€§èƒ½)
    searchInput.addEventListener('input', () => {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            performSearch(searchInput.value.trim());
        }, 300); // åœæ­¢è¾“å…¥300æ¯«ç§’åæ‰§è¡Œæœç´¢
    });

    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢ä½ ç°æœ‰çš„ searchResultsContainer ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨

    // æ›¿æ¢ç°æœ‰çš„ searchResultsContainer ç‚¹å‡»ç›‘å¬å™¨
    searchResultsContainer.addEventListener('click', (event) => {
        const resultItem = event.target.closest('.search-result-item');
        if (resultItem) {
            event.preventDefault();
            event.stopPropagation();

            const shield = document.getElementById('click-shield');
            shield.style.display = 'block';

            const uuid = resultItem.dataset.uuid;

            // æ£€æŸ¥æ˜¯ç¾¤èŠIDè¿˜æ˜¯å•èŠID
            const contactId = resultItem.dataset.contactId ? parseInt(resultItem.dataset.contactId, 10) : null;
            const groupId = resultItem.dataset.groupId ? parseInt(resultItem.dataset.groupId, 10) : null;

            closeSearchModal();

            if (groupId) {
                // è·³è½¬ç¾¤èŠ
                jumpToMessage(groupId, uuid, true);
            } else if (contactId) {
                // è·³è½¬å•èŠ
                jumpToMessage(contactId, uuid, false);
            }

            setTimeout(() => {
                shield.style.display = 'none';
            }, 400);
        }
    });

    // 7. æ ¸å¿ƒï¼šè·³è½¬åˆ°æŒ‡å®šæ¶ˆæ¯çš„å‡½æ•°
    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢ç°æœ‰çš„ jumpToMessage å‡½æ•°

    // ä¿®æ”¹ jumpToMessage å‡½æ•°ç­¾åå’Œé€»è¾‘
    async function jumpToMessage(id, uuid, isGroup = false) {
        closeSearchModal();

        if (isGroup) {
            // å¦‚æœæ˜¯ç¾¤èŠï¼Œè°ƒç”¨ç¾¤èŠæ‰“å¼€å‡½æ•°
            await openGroupChatView(id);
        } else {
            // å¦‚æœæ˜¯å•èŠï¼Œè°ƒç”¨å•èŠæ‰“å¼€å‡½æ•°
            await openChatView(id, { targetMessageUuid: uuid });
        }

        // --- æ»šåŠ¨å®šä½é€»è¾‘ ---
        // openGroupChatView æš‚æ—¶è¿˜ä¸æ”¯æŒä¼  targetMessageUuidï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åœ¨è¿™é‡Œå¤„ç†æ»šåŠ¨
        // æˆ–è€…ä½ å¯ä»¥ä¿®æ”¹ openGroupChatView è®©å®ƒä¹Ÿæ”¯æŒ options å‚æ•°
        // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ç§é€šç”¨çš„å»¶æ—¶æ»šåŠ¨æ–¹æ³•ï¼š
        setTimeout(() => {
            const targetMessage = chatMessagesContainer.querySelector(`.message-row[data-uuid="${uuid}"]`);
            if (targetMessage) {
                targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetMessage.classList.add('message-highlight');
                setTimeout(() => targetMessage.classList.remove('message-highlight'), 1500);
            }
        }, 500); // ç­‰å¾…ç•Œé¢æ¸²æŸ“å®Œæˆ

        chatMessageInput.blur();
    }
    /**
     * ã€æ–°å¢ã€‘å¤„ç†æ—¶é—´æ„ŸçŸ¥åŠŸèƒ½å¼€å¯/å…³é—­çš„å‡½æ•°
     */
    async function handleTimePerceptionToggle() {
        if (!currentOpenContact) {
            alert("è¯·å…ˆæ‰“å¼€ä¸€ä¸ªå¯¹è¯ã€‚");
            return;
        }

        // æ£€æŸ¥å½“å‰çŠ¶æ€ (å¦‚æœå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™é»˜è®¤ä¸ºfalse)
        const isEnabled = currentOpenContact.timePerceptionEnabled || false;

        const message = isEnabled ?
            "è¦å…³é—­æ­¤AIçš„æ—¶é—´æ„ŸçŸ¥åŠŸèƒ½å—ï¼Ÿå…³é—­åå®ƒå°†ä¸å†çŸ¥æ™“ç°å®æ—¶é—´ã€‚" :
            "è¦ä¸ºæ­¤AIå¼€å¯æ„ŸçŸ¥ç°å®æ—¶é—´çš„åŠŸèƒ½å—ï¼Ÿå¼€å¯åAIçš„å›å¤ä¼šç»“åˆå½“å‰æ—¶é—´ã€‚";

        if (confirm(message)) {
            try {
                // åˆ‡æ¢çŠ¶æ€
                currentOpenContact.timePerceptionEnabled = !isEnabled;

                // ä½¿ç”¨â€œåŠ è½½-ä¿®æ”¹-ä¿å­˜â€æ¨¡å¼å®‰å…¨åœ°æ›´æ–°æ•°æ®åº“
                const allContactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                let allContacts = allContactsData.value || [];
                const contactIndex = allContacts.findIndex(c => c.id === currentOpenContact.id);

                if (contactIndex > -1) {
                    allContacts[contactIndex] = currentOpenContact;
                    await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                    alert(`æ—¶é—´æ„ŸçŸ¥åŠŸèƒ½å·²æˆåŠŸ${currentOpenContact.timePerceptionEnabled ? 'å¼€å¯' : 'å…³é—­'}ï¼`);
                } else {
                    throw new Error("åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°å½“å‰è”ç³»äººã€‚");
                }

            } catch (error) {
                console.error("æ›´æ–°æ—¶é—´æ„ŸçŸ¥çŠ¶æ€å¤±è´¥:", error);
                alert(`æ“ä½œå¤±è´¥: ${error.message}`);
            } finally {
                // æ“ä½œå®Œæˆåå…³é—­é¢æ¿
                toggleFeaturesPanel();
            }
        }
    }

    // === æ–°å¢ï¼šé‚€è¯·è”ç³»äººåŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ ===

    // 1. è·å–æ–°æ·»åŠ çš„HTMLå…ƒç´ 
    const inviteContactBtn = document.getElementById('island-invite-button');
    const inviteModal = document.getElementById('invite-modal');
    const inviteModalCloseBtn = document.getElementById('invite-modal-close-btn');
    const inviteContactListContainer = document.getElementById('invite-contact-list-container');

    // 2. æ‰“å¼€å’Œå…³é—­å¯¹è¯æ¡†çš„å‡½æ•°
    function openInviteModal() {
        inviteModal.style.display = 'flex';
        // åŠ¨æ€åŠ è½½å¹¶æ˜¾ç¤ºè”ç³»äººåˆ—è¡¨
        loadAndDisplayContactsForInvite();
        setTimeout(() => {
            inviteModal.style.opacity = '1';
            inviteModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    function closeInviteModal() {
        inviteModal.style.opacity = '0';
        inviteModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            inviteModal.style.display = 'none';
        }, 300);
    }

    // 3. ä»æ•°æ®åº“åŠ è½½è”ç³»äººå¹¶æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†ä¸­çš„å‡½æ•°
    async function loadAndDisplayContactsForInvite() {
        // æ¸…ç©ºæ—§åˆ—è¡¨ï¼Œé˜²æ­¢é‡å¤åŠ è½½
        inviteContactListContainer.innerHTML = '<p style="text-align:center; color:#888;">æ­£åœ¨åŠ è½½è”ç³»äºº...</p>';

        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (contactsData && Array.isArray(contactsData.value) && contactsData.value.length > 0) {
                inviteContactListContainer.innerHTML = ''; // åŠ è½½æˆåŠŸåæ¸…ç©ºæç¤º
                contactsData.value.forEach(contact => {
                    const contactItem = document.createElement('div');
                    contactItem.className = 'invite-contact-item';

                    contactItem.innerHTML = `
                    <img src="${contact.ai.avatar}" alt="avatar" class="invite-contact-avatar">
                    <span class="invite-contact-name">${contact.ai.name}</span>
                    <button class="invite-button" data-contact-id="${contact.id}">é‚€è¯·</button>
                `;

                    inviteContactListContainer.appendChild(contactItem);
                });
            } else {
                inviteContactListContainer.innerHTML = '<p style="text-align:center; color:#888;">ä½ è¿˜æ²¡æœ‰ä»»ä½•è”ç³»äººã€‚</p>';
            }
        } catch (error) {
            console.error("åŠ è½½è”ç³»äººåˆ—è¡¨å¤±è´¥:", error);
            inviteContactListContainer.innerHTML = '<p style="text-align:center; color:red;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p>';
        }
    }

    // 4. ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    // ç‚¹å‡»SVGå›¾æ ‡ï¼Œæ‰“å¼€å¯¹è¯æ¡†
    inviteContactBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        openInviteModal();
    });

    // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–é®ç½©èƒŒæ™¯ï¼Œå…³é—­å¯¹è¯æ¡†
    inviteModalCloseBtn.addEventListener('click', closeInviteModal);
    inviteModal.addEventListener('click', (event) => {
        if (event.target === inviteModal) {
            closeInviteModal();
        }
    });

    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†æ‰€æœ‰â€œé‚€è¯·â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    // === â€œé‚€è¯·ä¸€èµ·å¬â€æŒ‰é’®ç‚¹å‡»äº‹ä»¶ (V4 - ä¿®å¤å¡ç‰‡ä¸æ˜¾ç¤ºé—®é¢˜) ===
    // === â€œé‚€è¯·ä¸€èµ·å¬â€æŒ‰é’®ç‚¹å‡»äº‹ä»¶ (V5 - æœ€ç»ˆä¿®å¤ç‰ˆ) ===
    inviteContactListContainer.addEventListener('click', async (event) => {
        if (event.target.classList.contains('invite-button') && !event.target.disabled) {
            if (!playbackState.currentSong) {
                alert("è¯·å…ˆæ’­æ”¾ä¸€é¦–æ­Œæ›²å†é‚€è¯·ï¼");
                return;
            }

            const button = event.target;
            const contactId = parseInt(button.dataset.contactId, 10);

            button.textContent = 'å·²é‚€è¯·';
            button.disabled = true;
            button.classList.add('invited');

            try {
                // 1. æ„é€ é‚€è¯·æ¶ˆæ¯ (å¸¦UUID)
                const songTitle = playbackState.currentSong.title;
                const artistName = playbackState.currentSong.artist;
                const inviteMessageText = `[MUSIC_SHARE]å¯¹æ–¹é‚€è¯·ä½ æ”¶å¬-${songTitle}-${artistName}[MUSIC_SHARE]`;
                const userMessage = {
                    sender: 'user',
                    text: inviteMessageText,
                    timestamp: new Date(),
                    uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                };

                // 2. æ£€æŸ¥å½“å‰èŠå¤©çª—å£æ˜¯å¦æ­£å¥½æ˜¯é‚€è¯·å¯¹è±¡çš„çª—å£ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç«‹å³æ˜¾ç¤ºé‚€è¯·å¡ç‰‡
                if (currentOpenContact && currentOpenContact.id === contactId) {
                    addMessageToView(userMessage);
                }

                // 3. å°†æ¶ˆæ¯æ­£ç¡®åœ°ä¿å­˜åˆ°åå°æ•°æ®åº“
                const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                let allContacts = contactsData.value || [];
                const contactIndex = allContacts.findIndex(c => c.id === contactId);
                if (contactIndex > -1) {
                    const targetContact = allContacts[contactIndex];
                    if (!Array.isArray(targetContact.history)) {
                        targetContact.history = [];
                    }
                    targetContact.history.push(userMessage);
                    targetContact.lastMessage = "åˆ†äº«äº†ä¸€èµ·å¬é‚€è¯·";
                    await dbHelper.saveData('messageContacts', 'allContacts', allContacts);

                    // 4. å…³é—­å¼¹çª—å¹¶ä½¿ç”¨æ›´æ–°åçš„è”ç³»äººæ•°æ®æ¥è°ƒç”¨AI
                    closeInviteModal();
                    const aiTriggerMessage = `(æˆ‘ç»™ä½ åˆ†äº«äº†ä¸€èµ·å¬çš„é‚€è¯·ï¼Œæ­Œæ›²æ˜¯ã€Š${songTitle}ã€‹ - ${artistName}ï¼Œè¯·æ ¹æ®æˆ‘ä»¬çš„èŠå¤©è®°å½•å’Œä½ çš„äººè®¾ï¼Œè‡ªç„¶åœ°å†³å®šæ˜¯å¦æ¥å—ã€‚)`;
                    await callAI(aiTriggerMessage, targetContact);

                } else {
                    throw new Error("åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°ç›®æ ‡è”ç³»äººã€‚");
                }

            } catch (error) {
                console.error("å‘é€é‚€è¯·å¡ç‰‡å¤±è´¥:", error);
                alert("å‘é€é‚€è¯·å¤±è´¥");
                button.textContent = 'é‚€è¯·';
                button.disabled = false;
                button.classList.remove('invited');
            }
        }
    });

    // === â€œä¸€èµ·å¬â€åŠŸèƒ½æœ€ç»ˆä¿®å¤ç‰ˆ (åŒ…å«å˜é‡å£°æ˜) ===

    // 1. å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡æ¥ç®¡ç†â€œä¸€èµ·å¬â€çš„çŠ¶æ€ (è¿™æ˜¯ç¼ºå¤±çš„éƒ¨åˆ†)
    let sharedListeningState = {
        active: false,
        contact: null
    };

    // 2. è·å–æˆ‘ä»¬æ–°æ·»åŠ çš„HTMLå¤´åƒå®¹å™¨
    const sharedAvatarsContainer = document.getElementById('shared-listening-avatars');
    const avatarImageContainer = document.getElementById('avatar-image-container');

    // 3. ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œæ ¹æ®çŠ¶æ€æ¥æ›´æ–°UI
    // === è¿™æ˜¯ä¿®æ­£äº†UIæ›´æ–°é€»è¾‘çš„æœ€ç»ˆç‰ˆæœ¬ ===
    function updateSharedListeningUI() {
        if (sharedListeningState.active && sharedListeningState.contact) {
            // å¦‚æœæ˜¯æ¿€æ´»çŠ¶æ€ï¼Œå°±è·å–å¯¹åº”çš„å¤´åƒå¹¶æ˜¾ç¤º
            const userAvatar = sharedListeningState.contact.user.avatar;
            const aiAvatar = sharedListeningState.contact.ai.avatar;

            // å…³é”®ä¿®å¤ï¼šå°†å¤´åƒæ’å…¥åˆ°ä¸“ç”¨çš„å›¾ç‰‡å®¹å™¨ä¸­ï¼Œè€Œä¸æ˜¯è¦†ç›–æ•´ä¸ªçˆ¶å®¹å™¨
            avatarImageContainer.innerHTML = `
            <img src="${userAvatar}" class="shared-avatar-img" title="${sharedListeningState.contact.user.name}">
            <img src="${aiAvatar}" class="shared-avatar-img" title="${sharedListeningState.contact.ai.name}">
        `;
            // çˆ¶å®¹å™¨åªè´Ÿè´£æ§åˆ¶æ•´ä½“çš„æ˜¾ç¤ºå’Œéšè—
            sharedAvatarsContainer.classList.add('active');

        } else {
            // å¦åˆ™ï¼Œåªæ¸…ç©ºå›¾ç‰‡å®¹å™¨å¹¶éšè—çˆ¶å®¹å™¨
            avatarImageContainer.innerHTML = '';
            sharedAvatarsContainer.classList.remove('active');
        }
    }

    // 4. å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºç»“æŸâ€œä¸€èµ·å¬â€çŠ¶æ€
    function stopSharedListening() {
        sharedListeningState.active = false;
        sharedListeningState.contact = null;
        updateSharedListeningUI(); // è°ƒç”¨UIæ›´æ–°å‡½æ•°æ¥éšè—å¤´åƒ
    }

    // === â€œä¸€èµ·å¬â€åŠŸèƒ½æœ€ç»ˆäº¤äº’é€»è¾‘ ===

    // 1. è·å–æ–°å¢çš„æ°”æ³¡å’ŒæŒ‰é’®å…ƒç´ 
    const endSessionBubble = document.getElementById('end-session-bubble');
    const endListeningSessionBtn = document.getElementById('end-listening-session-btn');

    // 2. ä¸ºå¤´åƒå®¹å™¨ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºæ˜¾ç¤º/éšè—æ°”æ³¡
    sharedAvatarsContainer.addEventListener('click', (event) => {
        // ç¡®ä¿åªæœ‰åœ¨â€œä¸€èµ·å¬â€æ¨¡å¼æ¿€æ´»æ—¶æ‰å“åº”
        if (sharedListeningState.active) {
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯â€œç»“æŸâ€æŒ‰é’®æœ¬èº«ï¼Œåˆ™åˆ‡æ¢æ°”æ³¡çš„æ˜¾ç¤ºçŠ¶æ€
            if (!event.target.closest('#end-listening-session-btn')) {
                endSessionBubble.classList.toggle('active');
            }
        }
    });

    // 3. ä¸ºæ°”æ³¡å†…çš„â€œç»“æŸâ€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    endListeningSessionBtn.addEventListener('click', async (event) => {
        event.stopPropagation();
        endSessionBubble.classList.remove('active');

        try {
            // --- å…³é”®çš„æ‰§è¡Œé¡ºåºåœ¨è¿™é‡Œ ---

            // æ­¥éª¤ 1ï¼šå…ˆè°ƒç”¨å¹¶â€œç­‰å¾…â€ç³»ç»Ÿæç¤ºå‡½æ•°å®Œæˆã€‚
            // è¿™ä¸ª await å…³é”®å­—ä¼šå¼ºåˆ¶ç¨‹åºåœ¨æ­¤æš‚åœï¼Œç›´åˆ°æ¶ˆæ¯è¢«ä¿å­˜å¹¶ä¸”æ˜¾ç¤ºå‡ºæ¥ã€‚
            // è¿™ä¼šç¡®ä¿â€œå·²ç»ç»“æŸä¸€èµ·å¬â€çš„ç°è‰²æç¤ºå…ˆå‡ºç°åœ¨ç•Œé¢ä¸Šã€‚
            await showSystemNotification('å·²ç»ç»“æŸä¸€èµ·å¬', sharedListeningState.contact.id);

            // æ­¥éª¤ 2ï¼šåœ¨ç³»ç»Ÿæç¤ºæ˜¾ç¤ºå®Œæ¯•åï¼Œå†è°ƒç”¨å¹¶â€œç­‰å¾…â€AIå›åº”ã€‚
            // åªæœ‰åœ¨ä¸Šé¢ä¸€è¡Œä»£ç å®Œå…¨ç»“æŸåï¼Œè¿™ä¸€è¡Œæ‰ä¼šå¼€å§‹æ‰§è¡Œã€‚
            // AIçš„â€œ...â€è¾“å…¥æ°”æ³¡ä¼šåœ¨è¿™é‡Œæ‰å‡ºç°ã€‚
            // This is the new, context-aware line
            await callAI("(æˆ‘å·²ç»ç»“æŸäº†ä¸€èµ·å¬æ¨¡å¼ï¼Œæˆ‘ä»¬ç»§ç»­èŠå§)", sharedListeningState.contact);

        } catch (error) {
            // (å¯é€‰) å¦‚æœåœ¨é€šçŸ¥AIæ—¶å‡ºé”™ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°æ‰“å°é”™è¯¯ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
            console.error("åœ¨ç»“æŸâ€œä¸€èµ·å¬â€å¹¶é€šçŸ¥AIæ—¶å‘ç”Ÿé”™è¯¯:", error);
        } finally {
            // æ­¥éª¤ 3ï¼šæ— è®ºä¸Šé¢çš„æ“ä½œæˆåŠŸä¸å¦ï¼Œæœ€åéƒ½æ›´æ–°UIï¼Œéšè—å¤´åƒã€‚
            stopSharedListening();
        }
    });

    // 4. (å¯é€‰ä½†æ¨è) æ·»åŠ ä¸€ä¸ªå…¨å±€ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºåœ¨ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶ï¼Œè‡ªåŠ¨éšè—æ°”æ³¡
    document.addEventListener('click', (event) => {
        // å¦‚æœæ°”æ³¡æ˜¯æ˜¾ç¤ºçš„ï¼Œå¹¶ä¸”ç‚¹å‡»çš„åŒºåŸŸä¸åœ¨å¤´åƒå®¹å™¨å†…
        if (endSessionBubble.classList.contains('active') && !sharedAvatarsContainer.contains(event.target)) {
            endSessionBubble.classList.remove('active');
        }
    }, true); // ä½¿ç”¨æ•è·é˜¶æ®µç¡®ä¿å®ƒä¼˜å…ˆæ‰§è¡Œ

    /**
     * æ–°å¢ï¼šåœ¨èŠå¤©ç•Œé¢æ˜¾ç¤ºä¸€ä¸ªç³»ç»Ÿçº§åˆ«çš„æç¤ºæ¶ˆæ¯
     * @param {string} text - è¦æ˜¾ç¤ºçš„æç¤ºæ–‡æœ¬
     */
    async function showSystemNotification(text, contactId) {
        if (!contactId) return;

        // 1. æ„é€ ä¸€ä¸ªå¸¦æœ‰ type: 'system' çš„æ¶ˆæ¯å¯¹è±¡
        const systemMessage = {
            sender: 'system',
            type: 'system',
            text: text,
            timestamp: new Date(),
            uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
        };

        // 2. å°†è¿™æ¡ç³»ç»Ÿæ¶ˆæ¯æ°¸ä¹…ä¿å­˜åˆ°æ•°æ®åº“
        await saveMessageToHistory(systemMessage, contactId);

        // 3. å¦‚æœç”¨æˆ·æ­£æ‰“å¼€ç€è¿™ä¸ªå¯¹è¯ï¼Œåˆ™ç«‹å³åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå‡ºæ¥
        if (currentOpenContact && currentOpenContact.id === contactId) {
            addMessageToView(systemMessage);
            chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' });
        }
    }



    // 2. æ§åˆ¶â€œæ·»åŠ è¡¨æƒ…â€å¯¹è¯æ¡†æ˜¾ç¤ºå’Œéšè—çš„å‡½æ•°
    function openAddEmojiModal() {

        const urlsTextarea = document.getElementById('emoji-urls-textarea');
        if (urlsTextarea) {
            urlsTextarea.value = '';
        }
        addEmojiModal.style.display = 'flex';
        setTimeout(() => {
            addEmojiModal.style.opacity = '1';
            addEmojiModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    function closeAddEmojiModal() {
        addEmojiModal.style.opacity = '0';
        addEmojiModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            addEmojiModal.style.display = 'none';
            emojiUrlInput.value = ''; // å…³é—­æ—¶æ¸…ç©ºè¾“å…¥æ¡†
        }, 300);
    }

    // 3. ä»æ•°æ®åº“åŠ è½½å¹¶æ¸²æŸ“æ‰€æœ‰è¡¨æƒ…åˆ°ç½‘æ ¼ä¸­
    // æ–°ç‰ˆæœ¬ï¼šåœ¨æ¸²æŸ“æ—¶åŠ å…¥äº†å¤é€‰æ¡†
    async function loadAndRenderEmojis() {
        try {
            // 1. è·å–æ•°æ®
            let emojis = await dbHelper.getAllDataFromStore('emojiStore');

            // 2. ã€æ–°å¢ã€‘æ ¸å¿ƒæ’åºé€»è¾‘ï¼šæŒ‰æ—¶é—´å€’åºæ’åˆ—
            // å¦‚æœæ˜¯æ—§æ•°æ®æ²¡æœ‰æ—¶é—´æˆ³(timestamp)ï¼Œå°±é»˜è®¤ä¸º0ï¼Œæ’åœ¨æœ€åé¢
            if (emojis && Array.isArray(emojis)) {
                emojis.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            }

            emojiGridContainer.innerHTML = '';
            if (emojis && emojis.length > 0) {
                emojis.forEach(emoji => {
                    const container = document.createElement('div');
                    container.className = 'emoji-item-container';

                    // === æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨ HTML ç»“æ„ä¸­åŠ å…¥ input[type=checkbox] ===
                    container.innerHTML = `
                    <input type="checkbox" class="emoji-checkbox" value="${emoji.url}">
                    <img src="${emoji.url}" class="emoji-item" title="ç‚¹å‡»å‘é€" data-url="${emoji.url}">
                    <p class="emoji-remark" contenteditable="true">${emoji.remark}</p>
                `;

                    // ä¸ºæ–°åˆ›å»ºçš„å¤‡æ³¨å…ƒç´ é‡æ–°ç»‘å®š"å¤±å»ç„¦ç‚¹"äº‹ä»¶
                    const remarkElement = container.querySelector('.emoji-remark');
                    remarkElement.addEventListener('blur', async (event) => {
                        const newRemark = event.target.textContent.trim();
                        const urlToUpdate = container.querySelector('.emoji-item').dataset.url;

                        if (newRemark) {
                            try {
                                await dbHelper.updateRecord('emojiStore', { url: urlToUpdate, remark: newRemark });
                            } catch (dbError) {
                                console.error("æ›´æ–°å¤‡æ³¨å¤±è´¥:", dbError);
                            }
                        } else {
                            event.target.textContent = "ç‚¹å‡»ä¿®æ”¹å¤‡æ³¨";
                        }
                    });

                    emojiGridContainer.appendChild(container);
                });
            } else {
                emojiGridContainer.innerHTML = '<p style="color:#aaa; font-size:14px; text-align:center; grid-column: 1 / -1;">å¿«æ¥æ·»åŠ è¡¨æƒ…åŒ…åŒ…å§ï¼</p>';
            }
        } catch (error) {
            console.error("åŠ è½½è¡¨æƒ…å¤±è´¥:", error);
        }
    }

    // 4. â€œç¡®è®¤æ·»åŠ â€æŒ‰é’®çš„ç‚¹å‡»å¤„ç†å‡½æ•°
    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ handleSaveEmojis å‡½æ•°
    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ handleSaveEmojis å‡½æ•°
    // ç”¨è¿™ä¸ªåŠŸèƒ½æ›´å¼ºå¤§çš„æ–°ç‰ˆæœ¬ï¼Œå®Œæ•´æ›¿æ¢ä½ æ—§çš„ handleSaveEmojis å‡½æ•°

    async function handleSaveEmojis() {
        const urlsTextarea = document.getElementById('emoji-urls-textarea');
        const inputText = urlsTextarea.value.trim();
        if (!inputText) {
            alert('è¯·è¾“å…¥è¡¨æƒ…åŒ…æ•°æ®ï¼');
            return;
        }

        // --- å…¨æ–°çš„è§£æé€»è¾‘ ---

        // 1. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆ [ä»»æ„å­—ç¬¦:ä»»æ„å­—ç¬¦] æ ¼å¼çš„æ¡ç›®
        //    è¿™æ¯”ç®€å•çš„é€—å·åˆ†å‰²æ›´å¥å£®ï¼Œå¯ä»¥é¿å…URLä¸­åŒ…å«é€—å·ç­‰é—®é¢˜
        const entries = inputText.match(/\[.*?:\s*.*?\]/g);

        if (!entries || entries.length === 0) {
            alert('æœªæ‰¾åˆ°æœ‰æ•ˆæ ¼å¼çš„æ•°æ®ã€‚\n\nè¯·ç¡®ä¿ä½¿ç”¨æ ¼å¼: [å¤‡æ³¨1:url1],[å¤‡æ³¨2:url2]');
            return;
        }

        const emojisToSave = [];

        // 2. éå†æ¯ä¸ªæ‰¾åˆ°çš„æ¡ç›®
        for (const entry of entries) {
            try {
                // ç§»é™¤å‰åçš„æ–¹æ‹¬å· -> "[å¤‡æ³¨:url]" å˜æˆ "å¤‡æ³¨:url"
                const content = entry.slice(1, -1);

                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå†’å·çš„ä½ç½®
                const colonIndex = content.indexOf(':');

                if (colonIndex === -1) {
                    console.warn(`æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡æ­¤æ¡ç›® (ç¼ºå°‘å†’å·): ${entry}`);
                    continue; // å¦‚æœæ²¡æœ‰å†’å·ï¼Œè·³è¿‡è¿™ä¸ªæ¡ç›®
                }

                // 3. æ ¹æ®å†’å·ä½ç½®ï¼Œç²¾ç¡®åœ°åˆ†ç¦»å‡ºå¤‡æ³¨å’ŒURL
                const remark = content.substring(0, colonIndex).trim();
                const url = content.substring(colonIndex + 1).trim();

                // 4. è¿›è¡Œç®€å•éªŒè¯ï¼Œç¡®ä¿å¤‡æ³¨ä¸ä¸ºç©ºï¼ŒURLä»¥httpå¼€å¤´
                if (remark && url.startsWith('http')) {
                    emojisToSave.push({ url, remark });
                } else {
                    console.warn(`æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡æ­¤æ¡ç›® (å¤‡æ³¨ä¸ºç©ºæˆ–URLæ— æ•ˆ): ${entry}`);
                }
            } catch (e) {
                console.error(`è§£ææ¡ç›®æ—¶å‡ºé”™: ${entry}`, e);
            }
        }

        if (emojisToSave.length === 0) {
            alert('è§£æåæœªå‘ç°æœ‰æ•ˆçš„è¡¨æƒ…åŒ…æ•°æ®ï¼Œè¯·æ£€æŸ¥æ‚¨çš„æ ¼å¼ã€‚');
            return;
        }

        // --- ä¿å­˜åˆ°æ•°æ®åº“çš„é€»è¾‘ï¼ˆä¸ä¹‹å‰ç±»ä¼¼ï¼‰ ---
        try {
            let successCount = 0;
            // åœ¨ handleSaveEmojis å‡½æ•°å†…éƒ¨çš„å¾ªç¯é‡Œ
            for (const emoji of emojisToSave) {
                const newEmoji = {
                    url: emoji.url,
                    remark: emoji.remark,
                    timestamp: Date.now() // ã€æ–°å¢ã€‘è®°å½•å½“å‰æ—¶é—´æˆ³
                };
                await dbHelper.updateRecord('emojiStore', newEmoji);
                successCount++;
            }

            alert(`æˆåŠŸå¤„ç†äº† ${entries.length} æ¡æ•°æ®ï¼Œæœ‰æ•ˆæ·»åŠ /æ›´æ–°äº† ${successCount} ä¸ªè¡¨æƒ…ï¼`);
            closeAddEmojiModal();
            loadAndRenderEmojis(); // é‡æ–°åŠ è½½ä»¥æ˜¾ç¤ºæ–°è¡¨æƒ…

        } catch (error) {
            console.error("ä¿å­˜è¡¨æƒ…å¤±è´¥:", error);
            alert("æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ ¼å¼æˆ–æ•°æ®åº“ã€‚");
        }
    }

    // 5. ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
    addEmojiBtn.addEventListener('click', () => {
        if (isEmojiDeleteMode) {
            handleBatchDeleteEmojis(); // å¦‚æœåœ¨åˆ é™¤æ¨¡å¼ï¼Œå°±æ‰§è¡Œåˆ é™¤
        } else {
            openAddEmojiModal(); // å¦åˆ™ï¼Œæ‰“å¼€æ·»åŠ è¡¨æƒ…å¯¹è¯æ¡†
        }
    });
    emojiModalCloseBtn.addEventListener('click', closeAddEmojiModal);
    saveEmojiBtn.addEventListener('click', handleSaveEmojis);
    // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨çš„ç°è‰²åŒºåŸŸä¹Ÿå¯ä»¥å…³é—­
    addEmojiModal.addEventListener('click', (event) => {
        if (event.target === addEmojiModal) {
            closeAddEmojiModal();
        }
    });
    multiselectEmojiBtn.addEventListener('click', () => {
        isEmojiDeleteMode = !isEmojiDeleteMode; // åˆ‡æ¢åˆ é™¤æ¨¡å¼çŠ¶æ€

        // æ ¹æ®çŠ¶æ€åˆ‡æ¢UI
        emojiGridContainer.classList.toggle('delete-mode', isEmojiDeleteMode);

       if (isEmojiDeleteMode) {
    // è¿›å…¥åˆ é™¤æ¨¡å¼ï¼šå¤šé€‰æŒ‰é’® â†’ å–æ¶ˆ(SVG)ï¼Œæ·»åŠ æŒ‰é’® â†’ åˆ é™¤æ‰€é€‰(SVG)
    multiselectEmojiBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    `; // å–æ¶ˆ â†’ å‰å·SVG
    addEmojiBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
    `; // åˆ é™¤æ‰€é€‰ â†’ åˆ é™¤åƒåœ¾æ¡¶SVG
} else {
    // é€€å‡ºåˆ é™¤æ¨¡å¼ï¼šå¤šé€‰æŒ‰é’® â†’ å¤šé€‰(SVG)ï¼Œæ·»åŠ æŒ‰é’® â†’ æ·»åŠ (SVG)
    multiselectEmojiBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    `; // å¤šé€‰ â†’ å‹¾é€‰SVG
    addEmojiBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    `; // æ·»åŠ  â†’ åŠ å·SVG
    // é€€å‡ºæ—¶ï¼Œå–æ¶ˆæ‰€æœ‰å¤é€‰æ¡†çš„å‹¾é€‰ï¼ˆä½ çš„åŸæœ‰é€»è¾‘ä¿ç•™ï¼‰
    emojiGridContainer.querySelectorAll('.emoji-checkbox').forEach(cb => cb.checked = false);
}
    });
    async function handleBatchDeleteEmojis() {
        const selectedCheckboxes = emojiGridContainer.querySelectorAll('.emoji-checkbox:checked');

        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„è¡¨æƒ…ã€‚');
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} ä¸ªè¡¨æƒ…å—ï¼Ÿ`)) {
            return;
        }

        try {
            let deletedCount = 0;
            // éå†æ‰€æœ‰è¢«é€‰ä¸­çš„å¤é€‰æ¡†
            for (const checkbox of selectedCheckboxes) {
                const urlToDelete = checkbox.value; // å¤é€‰æ¡†çš„ value å°±æ˜¯å›¾ç‰‡çš„ URL
                // ä» IndexedDB ä¸­åˆ é™¤
                await dbHelper.deleteData('emojiStore', urlToDelete);
                deletedCount++;
            }

            alert(`æˆåŠŸåˆ é™¤äº† ${deletedCount} ä¸ªè¡¨æƒ…ï¼`);

            // æ“ä½œå®Œæˆåï¼Œé‡æ–°åŠ è½½è¡¨æƒ…åˆ—è¡¨ä»¥åˆ·æ–°UI
            await loadAndRenderEmojis();

            // ä¸»åŠ¨â€œç‚¹å‡»â€å–æ¶ˆæŒ‰é’®ï¼Œé€€å‡ºåˆ é™¤æ¨¡å¼
            multiselectEmojiBtn.click();

        } catch (error) {
            console.error("åˆ é™¤è¡¨æƒ…å¤±è´¥:", error);
            alert("åˆ é™¤å¤±è´¥");
        }
    }
    /**
     * æ–°å¢ï¼šä¸»ä¿å­˜å‡½æ•°
     * è¿™æ˜¯å”¯ä¸€ä¸€ä¸ªè´Ÿè´£å°† currentOpenContact çš„å½“å‰çŠ¶æ€å†™å…¥æ•°æ®åº“çš„å‡½æ•°ã€‚
     * ä»»ä½•éœ€è¦ä¿å­˜çš„æ“ä½œéƒ½åº”è¯¥è°ƒç”¨å®ƒã€‚
     */
    async function saveCurrentContactToDatabase() {
        // å¦‚æœâ€œå­˜æ¡£é”â€è¢«å ç”¨ï¼Œåˆ™æ’é˜Ÿç­‰å€™
        if (isSaving) {
            // ç­‰å¾…100æ¯«ç§’åå†æ¬¡å°è¯•ï¼Œç»™å½“å‰ä»»åŠ¡ç•™å‡ºå®Œæˆæ—¶é—´
            await new Promise(resolve => setTimeout(resolve, 100));
            return saveCurrentContactToDatabase(); // å†æ¬¡è°ƒç”¨è‡ªå·±ï¼Œè¿›å…¥æ’é˜Ÿåºåˆ—
        }

        // å ç”¨â€œå­˜æ¡£é”â€ï¼Œå¼€å§‹å¤„ç†å½“å‰ä»»åŠ¡
        isSaving = true;

        try {
            // --- è¿™é‡Œçš„æ ¸å¿ƒå­˜æ¡£é€»è¾‘ä¿æŒä¸å˜ ---
            if (!currentOpenContact) return;
            
            // ã€æ ¸å¿ƒä¼˜åŒ–ã€‘ä¼˜å…ˆç”¨ç¼“å­˜
            let allContacts = Global_AllContactsCache;
            if (!allContacts) {
                 const allContactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                 allContacts = (allContactsData && Array.isArray(allContactsData.value)) ? allContactsData.value : [];
                 Global_AllContactsCache = allContacts;
            }
            
            const contactIndex = allContacts.findIndex(c => c.id === currentOpenContact.id);

            if (contactIndex > -1) {
                // ä½¿ç”¨ JSON åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¥åˆ›å»ºä¸€ä¸ªæ·±æ‹·è´ï¼Œç¡®ä¿æˆ‘ä»¬ä¿å­˜çš„æ˜¯å½“å‰æ—¶åˆ»çš„å¿«ç…§
                allContacts[contactIndex] = JSON.parse(JSON.stringify(currentOpenContact));
            } else {
                allContacts.push(JSON.parse(JSON.stringify(currentOpenContact)));
            }

            await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
            // --- æ ¸å¿ƒé€»è¾‘ç»“æŸ ---

        } catch (error) {
            console.error("Master save function failed:", error);
        } finally {
            // ä»»åŠ¡å®Œæˆï¼Œé‡Šæ”¾â€œå­˜æ¡£é”â€ï¼Œè®©ä¸‹ä¸€ä¸ªæ’é˜Ÿçš„ä»»åŠ¡å¯ä»¥å¼€å§‹
            isSaving = false;
        }
    }

    // === æ–°å¢ï¼šæ¸²æŸ“å›¾æ ‡è®¾ç½®åˆ—è¡¨çš„æ ¸å¿ƒå‡½æ•° ===
    async function renderIconSettings() {
        const container = document.getElementById('icon-list-container');
        if (!container) return;

        // 1. è·å–ä¸»å±å¹•ä¸Šæ‰€æœ‰å¸¦IDçš„Appå®¹å™¨
        const appElements = document.querySelectorAll('#home-screen .app-container[id]');

        // 2. ä»æ•°æ®åº“åŠ è½½å·²ä¿å­˜çš„è‡ªå®šä¹‰å›¾æ ‡è®¾ç½®
        const savedIconsData = await dbHelper.loadData('settingsStore', 'customAppIcons');
        const savedIcons = (savedIconsData && savedIconsData.value) ? savedIconsData.value : {};

        container.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹ï¼Œé˜²æ­¢é‡å¤

        // 3. éå†æ¯ä¸ªAppå…ƒç´ ï¼Œç”Ÿæˆå¯¹åº”çš„è®¾ç½®é¡¹
        appElements.forEach(app => {
            const appId = app.id;
            const appName = app.querySelector('.app-name').textContent;
            const currentIconSrc = app.querySelector('.app-icon img').src;

            // è·å–ä¸ºæ­¤Appä¿å­˜çš„URLï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©ºå­—ç¬¦ä¸²
            const savedUrl = savedIcons[appId] || '';

            const itemHTML = `
            <div class="icon-setting-item">
                <img src="${currentIconSrc}" class="icon-preview" data-app-id="${appId}">
                <div class="icon-details">
                    <span class="app-name-setting">${appName}</span>
                    <input type="text" class="icon-url-input" placeholder="è¾“å…¥æ–°çš„å›¾æ ‡URL" value="${savedUrl}" data-app-id="${appId}">
                </div>
            </div>
        `;
            container.innerHTML += itemHTML;
        });
    }
    // ç›‘å¬æ•´ä¸ªåˆ—è¡¨å®¹å™¨çš„ 'change' äº‹ä»¶ (å½“è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ä¸”å†…å®¹æ”¹å˜æ—¶è§¦å‘)
    iconListContainer.addEventListener('change', async (event) => {
        // æ£€æŸ¥äº‹ä»¶æ˜¯å¦ç”±æˆ‘ä»¬çš„URLè¾“å…¥æ¡†è§¦å‘
        if (event.target.classList.contains('icon-url-input')) {
            const input = event.target;
            const appId = input.dataset.appId;
            const newUrl = input.value.trim();

            await updateAppIcon(appId, newUrl);
        }
    });

    // è´Ÿè´£æ›´æ–°UIå’Œæ•°æ®åº“çš„å‡½æ•°
    async function updateAppIcon(appId, newUrl) {
        const appIconOnHomeScreen = document.querySelector(`#${appId} .app-icon img`);
        const iconPreviewInSettings = document.querySelector(`.icon-preview[data-app-id="${appId}"]`);

        if (!appIconOnHomeScreen || !iconPreviewInSettings) return;

        let finalUrl; // ç”¨ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨æœ€ç»ˆè¦åº”ç”¨çš„URL

        if (newUrl) {
            // å¦‚æœæœ‰æ–°URLï¼Œåˆ™ä½¿ç”¨æ–°URL
            finalUrl = newUrl;
        } else {
            // å¦‚æœURLè¢«æ¸…ç©ºï¼Œåˆ™ä» data-default-src å±æ€§æ¢å¤é»˜è®¤URL
            finalUrl = appIconOnHomeScreen.dataset.defaultSrc;
        }

        // åº”ç”¨æœ€ç»ˆçš„URL
        appIconOnHomeScreen.src = finalUrl;
        iconPreviewInSettings.src = finalUrl;

        // ä¿å­˜åˆ°æ•°æ®åº“çš„é€»è¾‘ä¿æŒä¸å˜
        try {
            const savedIconsData = await dbHelper.loadData('settingsStore', 'customAppIcons');
            let savedIcons = (savedIconsData && savedIconsData.value) ? savedIconsData.value : {};

            if (newUrl) {
                savedIcons[appId] = newUrl;
            } else {
                delete savedIcons[appId]; // å¦‚æœURLä¸ºç©ºï¼Œåˆ™ä»ä¿å­˜è®°å½•ä¸­åˆ é™¤
            }

            await dbHelper.saveData('settingsStore', 'customAppIcons', savedIcons);

        } catch (error) {
            console.error("ä¿å­˜è‡ªå®šä¹‰å›¾æ ‡å¤±è´¥:", error);
        }
    }
    // === æ–°å¢ï¼šé¡µé¢åŠ è½½æ—¶åº”ç”¨å·²ä¿å­˜çš„å›¾æ ‡ ===
    async function loadCustomIcons() {
        const savedIconsData = await dbHelper.loadData('settingsStore', 'customAppIcons');
        if (savedIconsData && savedIconsData.value) {
            const savedIcons = savedIconsData.value;
            for (const appId in savedIcons) {
                const iconUrl = savedIcons[appId];
                const appIconOnHomeScreen = document.querySelector(`#${appId} .app-icon img`);
                if (appIconOnHomeScreen && iconUrl) {
                    appIconOnHomeScreen.src = iconUrl;
                }
            }
        }
    }
    // === æ–°å¢ï¼šæ—¶é’Ÿé¢œè‰²æ›´æ¢çš„æ ¸å¿ƒé€»è¾‘ ===

    // æ ¸å¿ƒå‡½æ•°ï¼šæ›´æ–°æ‰€æœ‰æ—¶é’Ÿå…ƒç´ çš„é¢œè‰²
    function updateClockColor(color) {
        clockElements.forEach(span => {
            span.style.color = color;
        });
    }

    // ç›‘å¬æ–‡æœ¬è¾“å…¥æ¡†çš„å˜åŒ–
    clockColorInput.addEventListener('input', (event) => {
        const newColor = event.target.value;
        clockColorPicker.value = newColor; // åŒæ­¥æ›´æ–°é¢œè‰²é€‰æ‹©å™¨
        updateClockColor(newColor);
        dbHelper.saveData('settingsStore', 'clockColor', newColor); // ä¿å­˜åˆ°æ•°æ®åº“
    });

    // ç›‘å¬é¢œè‰²é€‰æ‹©å™¨çš„å˜åŒ–
    clockColorPicker.addEventListener('input', (event) => {
        const newColor = event.target.value;
        clockColorInput.value = newColor; // åŒæ­¥æ›´æ–°æ–‡æœ¬è¾“å…¥æ¡†
        updateClockColor(newColor);
        dbHelper.saveData('settingsStore', 'clockColor', newColor); // ä¿å­˜åˆ°æ•°æ®åº“
    });
    // === æ–°å¢ï¼šé¡µé¢åŠ è½½æ—¶åº”ç”¨å·²ä¿å­˜çš„æ—¶é’Ÿé¢œè‰² ===
    async function loadClockColor() {
        const colorData = await dbHelper.loadData('settingsStore', 'clockColor');
        if (colorData && colorData.value) {
            const savedColor = colorData.value;
            updateClockColor(savedColor);
            // åŒæ­¥æ›´æ–°è®¾ç½®é¡µçš„è¾“å…¥æ¡†é»˜è®¤å€¼
            clockColorInput.value = savedColor;
            clockColorPicker.value = savedColor;
        }
    }
    // === æ–°å¢ï¼šæ—¶é’Ÿé«˜æ–¯æ¨¡ç³ŠåŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ ===

    // å‡½æ•°ï¼šæ ¹æ®ä¼ å…¥çš„å¸ƒå°”å€¼åº”ç”¨æˆ–ç§»é™¤æ¨¡ç³Šæ•ˆæœ
    function applyClockBlur(isEnabled) {
        if (isEnabled) {
            clockContainer.classList.add('clock-blur-enabled');
        } else {
            clockContainer.classList.remove('clock-blur-enabled');
        }
    }

    // ç›‘å¬å¼€å…³çŠ¶æ€çš„å˜åŒ–
    clockBlurToggle.addEventListener('change', async () => {
        const isEnabled = clockBlurToggle.checked;
        applyClockBlur(isEnabled); // å®æ—¶åº”ç”¨æ•ˆæœ
        await dbHelper.saveData('settingsStore', 'clockBlurEffect', isEnabled); // ä¿å­˜è®¾ç½®åˆ°æ•°æ®åº“
    });

    // === æ–°å¢ï¼šé¡µé¢åŠ è½½æ—¶åº”ç”¨å·²ä¿å­˜çš„æ—¶é’Ÿæ¨¡ç³Šè®¾ç½® ===
    async function loadClockBlurSetting() {
        const blurData = await dbHelper.loadData('settingsStore', 'clockBlurEffect');
        // å¦‚æœæ•°æ®åº“é‡Œæœ‰è®°å½•ï¼Œåˆ™ä½¿ç”¨è¯¥è®°å½•çš„å€¼ï¼›å¦åˆ™é»˜è®¤ä¸º false (å…³é—­)
        const isEnabled = blurData ? blurData.value : false;

        clockBlurToggle.checked = isEnabled; // åŒæ­¥å¼€å…³çš„çŠ¶æ€
        applyClockBlur(isEnabled); // åº”ç”¨æ•ˆæœ
    }

    // --- æ–°å¢ï¼šå¿«é€Ÿå›åˆ°åº•éƒ¨æŒ‰é’®åŠŸèƒ½ ---

    // 1. è·å–éœ€è¦çš„HTMLå…ƒç´ 
    const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
    // chatMessagesContainer å˜é‡åœ¨ä¹‹å‰çš„ä»£ç ä¸­å·²ç»è·å–ï¼Œè¿™é‡Œæ— éœ€é‡å¤

    // æ–°ä»£ç ï¼šä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
    let isScrolling = false;
    chatMessagesContainer.addEventListener('scroll', () => {
        if (!isScrolling) {
            window.requestAnimationFrame(() => {
                // ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœæ›´å¤šåŠŸèƒ½é¢æ¿æˆ–è¡¨æƒ…é¢æ¿å¤„äºæ‰“å¼€çŠ¶æ€ï¼Œå¼ºåˆ¶éšè—å›åˆ°åº•éƒ¨æŒ‰é’®ï¼Œé˜²æ­¢è¯¯è§¦
                const chatScreenEl = document.getElementById('chat-screen');
                if (chatScreenEl && (chatScreenEl.classList.contains('features-panel-active') || chatScreenEl.classList.contains('emoji-panel-active'))) {
                     scrollToBottomBtn.classList.remove('visible');
                     isScrolling = false;
                     return;
                }

                // å°†é«˜å¼€é”€çš„è®¡ç®—æ”¾åœ¨åŠ¨ç”»å¸§ä¸­æ‰§è¡Œ
                const scrollOffset = chatMessagesContainer.scrollHeight - chatMessagesContainer.scrollTop - chatMessagesContainer.clientHeight;
                const threshold = 300;
                if (scrollOffset > threshold) {
                    scrollToBottomBtn.classList.add('visible');
                } else {
                    scrollToBottomBtn.classList.remove('visible');
                }
                isScrolling = false;
            });
            isScrolling = true;
        }
    }, { passive: true }); // passive: true å‘Šè¯‰æµè§ˆå™¨è¿™ä¸ªç›‘å¬å™¨ä¸ä¼šé˜»æ­¢æ»šåŠ¨ï¼Œè¿›ä¸€æ­¥æå‡æµç•…åº¦

    // 3. ç›‘å¬æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    scrollToBottomBtn.addEventListener('click', () => {
        // ä½¿ç”¨ smooth behavior å®ç°å¹³æ»‘æ»šåŠ¨æ•ˆæœ
        chatMessagesContainer.scrollTo({
            top: chatMessagesContainer.scrollHeight,
            behavior: 'smooth'
        });
    });

    // --- æ–°å¢ï¼ˆæœ€ç»ˆæƒå¨ç‰ˆï¼‰ï¼šç‚¹å‡»(èšç„¦äº)è¾“å…¥æ¡†æ—¶ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°èŠå¤©åº•éƒ¨ ---
    // AFTER
    // This code is now in the global scope and works correctly.

    if (chatMessageInput && chatMessagesContainer) { // Note: Use the globally declared variable name

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                if (document.activeElement === chatMessageInput) {
                    chatMessagesContainer.scrollTo({ // Note: Use the globally declared variable name
                        top: chatMessagesContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            });
        } else {
            chatMessageInput.addEventListener('focus', () => {
                setTimeout(() => {
                    chatMessagesContainer.scrollTo({ // Note: Use the globally declared variable name
                        top: chatMessagesContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 300);
            });
        }
    }

    // === START: ä¸ƒè¢‹è´­ç‰©èº«ä»½ JS (FUNCTIONS & EVENTS) ===

    /**
     * æ›´æ–°å½“å‰è´­ç‰©è€…ä¿¡æ¯ï¼Œå¹¶åˆ·æ–°é¡¶æ å¤´åƒ
     * @param {object} contact - å®Œæ•´çš„è”ç³»äººå¯¹è±¡
     */
    function updateShopper(contact) {
        if (contact && contact.user) {
            currentShopper = contact.user; // å­˜å‚¨ç”¨æˆ·éƒ¨åˆ†çš„ä¿¡æ¯
            shopperAvatarImg.src = currentShopper.avatar;
            console.log(`å½“å‰è´­ç‰©èº«ä»½å·²åˆ‡æ¢ä¸º: ${currentShopper.name}`);
        }
    }

    /**
     * æ‰“å¼€é€‰æ‹©ç”¨æˆ·çš„å¯¹è¯æ¡†
     */
    async function openShopperSelectModal() {
        shopperListContainer.innerHTML = '<p style="text-align:center; color:#888;">æ­£åœ¨åŠ è½½...</p>';

        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (contactsData && Array.isArray(contactsData.value) && contactsData.value.length > 0) {
                shopperListContainer.innerHTML = ''; // æ¸…ç©º
                contactsData.value.forEach(contact => {
                    // æˆ‘ä»¬åªæ˜¾ç¤ºç”¨æˆ·èº«ä»½
                    const user = contact.user;
                    const contactItem = document.createElement('div');
                    // å¤ç”¨é‚€è¯·åˆ—è¡¨çš„æ ·å¼
                    contactItem.className = 'invite-contact-item';
                    contactItem.style.cursor = 'pointer';
                    contactItem.dataset.contactId = contact.id;

                    contactItem.innerHTML = `
                    <img src="${user.avatar}" alt="avatar" class="invite-contact-avatar">
                    <span class="invite-contact-name">${user.name}</span>
                `;
                    shopperListContainer.appendChild(contactItem);
                });
            } else {
                shopperListContainer.innerHTML = '<p style="text-align:center; color:#888;">æ²¡æœ‰å¯ç”¨çš„ç”¨æˆ·èº«ä»½</p>';
            }
        } catch (error) {
            console.error("åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:", error);
            shopperListContainer.innerHTML = '<p style="text-align:center; color:red;">åŠ è½½å¤±è´¥</p>';
        }

        shopperSelectModal.style.display = 'flex';
        setTimeout(() => {
            shopperSelectModal.style.opacity = '1';
            shopperSelectModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    /**
     * å…³é—­é€‰æ‹©ç”¨æˆ·çš„å¯¹è¯æ¡†
     */
    function closeShopperSelectModal() {
        shopperSelectModal.style.opacity = '0';
        shopperSelectModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            shopperSelectModal.style.display = 'none';
        }, 300);
    }

    // --- äº‹ä»¶ç›‘å¬ ---

    // ç‚¹å‡»é¡¶æ å¤´åƒï¼Œæ‰“å¼€Modal
    shopperAvatarButton.addEventListener('click', openShopperSelectModal);

   
    // è´­ç‰©è€…é€‰æ‹©å¼¹çª—
if (shopperModalCloseBtn) {
    shopperModalCloseBtn.addEventListener('click', () => {
        window.DOMCleanupManager.clean('shopper-list-container');
        closeShopperSelectModal;
    });
}

    // ç‚¹å‡»Modalä¸­çš„ç”¨æˆ·åˆ—è¡¨é¡¹
    shopperListContainer.addEventListener('click', async (event) => {
        const item = event.target.closest('.invite-contact-item');
        if (item) {
            const contactId = parseInt(item.dataset.contactId, 10);

            // ä»æ•°æ®åº“ä¸­æ‰¾åˆ°å®Œæ•´çš„è”ç³»äººå¯¹è±¡
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            const selectedContact = contactsData.value.find(c => c.id === contactId);

            if (selectedContact) {
                updateShopper(selectedContact); // æ›´æ–°èº«ä»½
                closeShopperSelectModal();   // å…³é—­Modal
            }
        }
    });

    // === END: ä¸ƒè¢‹è´­ç‰©èº«ä»½ JS (FUNCTIONS & EVENTS) ===
    // === START: SHOPMALL æ ‡ç­¾é¡µ JS (EVENTS) ===
    // === START: SHOPMALL æ ‡ç­¾é¡µ JS (EVENTS) - V2 æœ€ç»ˆä¿®å¤ç‰ˆ ===

    // === END: SHOPMALL æ ‡ç­¾é¡µ JS (EVENTS) - V2 æœ€ç»ˆä¿®å¤ç‰ˆ ===


    // === START: SHOPMALL å•†å“è´­ç‰© JS (DATA & FUNCTIONS) ===

    // 1. ç¤ºä¾‹å•†å“æ•°æ®
    const productData = {
        takeout: [
            { name: 'è±ªåç‰›è‚‰æ±‰å ¡', description: 'ç²¾é€‰å®‰æ ¼æ–¯ç‰›è‚‰ï¼Œæ­é…æ–°é²œç”Ÿèœå’Œç§˜åˆ¶é…±æ–™ï¼Œå¤šæ±ç¾å‘³ã€‚', price: 28.50 },
            { name: 'æ—¥å¼è±šéª¨æ‹‰é¢', description: 'æµ“éƒçŒªéª¨æ±¤åº•ï¼Œé…ä¸Šæºå¿ƒè›‹å’Œå‰çƒ§ï¼Œæ¸©æš–ä½ çš„èƒƒã€‚', price: 35.00 },
            { name: 'éº»è¾£å°é¾™è™¾', description: 'å¤æ—¥å¿…å¤‡ï¼Œé²œæ´»å°é¾™è™¾é…ä»¥ç‹¬å®¶éº»è¾£è°ƒæ–™ï¼Œé¦™è¾£è¿‡ç˜¾ã€‚', price: 88.00 },
            { name: 'æ°´æœç¼¤çº·æ²™æ‹‰', description: 'å¤šç§æ–°é²œæ—¶ä»¤æ°´æœï¼Œä½å¡å¥åº·ï¼Œæ˜¯è½»é£Ÿä¸»ä¹‰è€…çš„æœ€çˆ±ã€‚', price: 22.00 },
            { name: 'æ„å¼ç•ªèŒ„è‚‰é…±é¢', description: 'ç»å…¸æ„å¼é£å‘³ï¼Œæ…¢ç‚–ç•ªèŒ„è‚‰é…±æ­é…ç­‹é“æ„é¢ï¼Œå›å‘³æ— ç©·ã€‚', price: 32.00 },
            { name: 'å¥¥å°”è‰¯çƒ¤é¸¡ç¿…', description: 'ç§˜åˆ¶å¥¥å°”è‰¯é…±æ–™è…Œåˆ¶ï¼Œå¤–ç„¦é‡Œå«©ï¼Œé¦™æ°”å››æº¢ã€‚', price: 26.00 },
            { name: 'æµ·é²œæŠ«è¨', description: 'è–„è„†é¥¼åº•ï¼Œé“ºæ»¡è™¾ä»ã€é±¿é±¼å’ŒèŠå£«ï¼Œæµ·é²œçˆ±å¥½è€…é¦–é€‰ã€‚', price: 58.00 },
            { name: 'å®«ä¿é¸¡ä¸é¥­', description: 'é²œå«©é¸¡ä¸æ­é…èŠ±ç”Ÿå’Œè¾£æ¤’ï¼Œéº»è¾£é²œé¦™ï¼Œä¸‹é¥­ç¥å™¨ã€‚', price: 25.00 },
            { name: 'éŸ©å¼éƒ¨é˜Ÿç«é”…', description: 'èŠå£«å¹´ç³•ã€åˆé¤è‚‰å’Œæ³¡èœçš„å®Œç¾èåˆï¼ŒéŸ©å¼é£å‘³åè¶³ã€‚', price: 68.00 },
            { name: 'æ³°å¼å†¬é˜´åŠŸæ±¤', description: 'é…¸è¾£å¼€èƒƒï¼Œå¤§è™¾ã€è˜‘è‡ç­‰é£Ÿæä¸°å¯Œï¼Œå¼‚å›½é£å‘³æµ“éƒã€‚', price: 42.00 },
            { name: 'é¦™ç…ä¸‰æ–‡é±¼å¥—é¤', description: 'æŒªå¨ä¸‰æ–‡é±¼ç…è‡³é‡‘é»„ï¼Œæ­é…æ—¶è”¬å’ŒåœŸè±†æ³¥ï¼Œè¥å…»å‡è¡¡ã€‚', price: 78.00 },
            { name: 'å…°å·ç‰›è‚‰æ‹‰é¢', description: 'ä¸€æ¸…äºŒç™½ä¸‰çº¢å››ç»¿ï¼Œä¼ ç»Ÿå·¥è‰ºåˆ¶ä½œï¼Œæ±¤é²œå‘³ç¾ã€‚', price: 28.00 },
            { name: 'å¢¨è¥¿å“¥é¸¡è‚‰å·', description: 'å«©ç…é¸¡è‚‰é…ä»¥èèé…±å’Œè”¬èœï¼Œå·åœ¨è–„é¥¼ä¸­ï¼Œé£å‘³ç‹¬ç‰¹ã€‚', price: 30.00 },
            { name: 'æ‹›ç‰Œçº¢çƒ§è‚‰', description: 'ç²¾é€‰äº”èŠ±è‚‰ï¼Œæ…¢ç«ç‚–è‡³é…¥çƒ‚ï¼Œè‚¥è€Œä¸è…»ï¼Œå…¥å£å³åŒ–ã€‚', price: 45.00 },
            { name: 'é²œè™¾äº‘åé¢', description: 'æ‰‹å·¥äº‘ååŒ…è£¹å¤§é¢—è™¾ä»ï¼Œæ­é…ç«¹å‡é¢ï¼Œæ±¤æ¸…å‘³é²œã€‚', price: 36.00 },
            { name: 'æ³•å¼é¦™ç…é¹…è‚', description: 'è¿›å£é¹…è‚ç…è‡³ä¸¤é¢é‡‘é»„ï¼Œæ­é…æ— èŠ±æœé…±ï¼Œå¥¢åäº«å—ã€‚', price: 98.00 },
            { name: 'å’–å–±ç‰›è‚‰é¥­', description: 'æµ“éƒå’–å–±æ±åŒ…è£¹é²œå«©ç‰›è‚‰å’ŒåœŸè±†ï¼Œæ‹Œé¥­ç»ä½³ã€‚', price: 32.00 },
            { name: 'è¶Šå—ç‰›è‚‰æ²³ç²‰', description: 'æ¸…çˆ½ç‰›éª¨æ±¤åº•ï¼Œé²œå«©ç‰›è‚‰ç‰‡ï¼Œæ­é…é¦™è‰ï¼Œæ¸…æ–°çˆ½å£ã€‚', price: 38.00 },
            { name: 'é»‘æ¾éœ²è˜‘è‡æ„é¢', description: 'é»‘æ¾éœ²ä¸è˜‘è‡çš„é²œé¦™èåˆï¼Œå£æ„Ÿä¸°å¯Œï¼Œé¦™æ°”ç‹¬ç‰¹ã€‚', price: 56.00 },
            { name: 'æ»‹è¡¥ä¹Œé¸¡æ±¤', description: 'è€ç«æ…¢ç‚–ä¹Œé¸¡æ±¤ï¼ŒåŠ å…¥å…šå‚ã€æ¸æï¼Œæ»‹è¡¥å…»ç”Ÿã€‚', price: 48.00 }
        ],
        electronics: [
            { name: 'è¶…é™éŸ³æœºæ¢°é”®ç›˜', description: 'é‡‡ç”¨èŒ¶è½´è®¾è®¡ï¼Œæ—¢æœ‰æ®µè½æ„Ÿåˆä¿æŒå®‰é™ï¼ŒåŠå…¬æ¸¸æˆä¸¤ç›¸å®œã€‚', price: 399.00 },
            { name: 'é«˜æ¸…é™å™ªè€³æœº', description: 'ä¸»åŠ¨é™å™ªæŠ€æœ¯ï¼Œè®©ä½ åœ¨å˜ˆæ‚ç¯å¢ƒä¸­ä¹Ÿèƒ½äº«å—çº¯å‡€éŸ³ä¹ã€‚', price: 799.00 },
            { name: 'ä¾¿æºå¼å……ç”µå®', description: '20000mAhå¤§å®¹é‡ï¼Œæ”¯æŒå¿«å……ï¼Œå‘Šåˆ«ç”µé‡ç„¦è™‘ã€‚', price: 129.00 },
            { name: 'æ™ºèƒ½è¿åŠ¨æ‰‹ç¯', description: 'å®æ—¶ç›‘æµ‹å¿ƒç‡ã€æ­¥æ•°å’Œç¡çœ ï¼Œä½ çš„è…•ä¸Šå¥åº·ç®¡å®¶ã€‚', price: 199.00 },
            { name: '4Kè¶…é«˜æ¸…æ˜¾ç¤ºå™¨', description: '27è‹±å¯¸å¤§å±ï¼Œ4Kåˆ†è¾¨ç‡ï¼Œè‰²å½©ç²¾å‡†ï¼Œé€‚åˆè®¾è®¡å’Œè§‚å½±ã€‚', price: 1499.00 },
            { name: 'æ— çº¿è“ç‰™è€³æœº', description: 'åŠå…¥è€³å¼è®¾è®¡ï¼Œä½©æˆ´èˆ’é€‚ï¼Œç»­èˆªé•¿è¾¾24å°æ—¶ã€‚', price: 299.00 },
            { name: 'è¶…è–„ç¬”è®°æœ¬ç”µè„‘', description: '14è‹±å¯¸å…¨é¢å±ï¼Œè½»è–„ä¾¿æºï¼Œæ€§èƒ½å¼ºåŠ²ï¼ŒåŠå…¬é¦–é€‰ã€‚', price: 5999.00 },
            { name: 'æ™ºèƒ½æ‰‹è¡¨', description: 'æ”¯æŒé€šè¯ã€æ”¯ä»˜å’Œå¤šç§è¿åŠ¨æ¨¡å¼ï¼ŒåŠŸèƒ½å…¨é¢ã€‚', price: 1599.00 },
            { name: 'é«˜æ¸…æ‘„åƒå¤´', description: '1080Påˆ†è¾¨ç‡ï¼Œè‡ªåŠ¨å¯¹ç„¦ï¼Œè§†é¢‘é€šè¯æ¸…æ™°æµç•…ã€‚', price: 199.00 },
            { name: 'æ¸¸æˆæ‰‹æŸ„', description: 'é€‚é…å¤šå¹³å°ï¼Œæ‰‹æ„Ÿèˆ’é€‚ï¼ŒæŒ‰é”®çµæ•ï¼Œæ¸¸æˆä½“éªŒå‡çº§ã€‚', price: 299.00 },
            { name: 'è¿·ä½ æŠ•å½±ä»ª', description: 'ä¾¿æºè®¾è®¡ï¼Œæ”¯æŒ1080PæŠ•å½±ï¼Œæ‰“é€ ç§äººå½±é™¢ã€‚', price: 2499.00 },
            { name: 'æ™ºèƒ½éŸ³ç®±', description: 'è¯­éŸ³æ§åˆ¶ï¼Œæ™ºèƒ½å®¶å±…ä¸­æ§ï¼ŒéŸ³è´¨å‡ºè‰²ã€‚', price: 399.00 },
            { name: 'ç§»åŠ¨ç¡¬ç›˜', description: '2TBå¤§å®¹é‡ï¼Œé«˜é€Ÿä¼ è¾“ï¼Œæ•°æ®å­˜å‚¨å®‰å…¨å¯é ã€‚', price: 599.00 },
            { name: 'æ°®åŒ–é•“å……ç”µå™¨', description: '65Wå¤§åŠŸç‡ï¼Œå°å·§ä¾¿æºï¼Œå¤šè®¾å¤‡å…¼å®¹ã€‚', price: 149.00 },
            { name: 'è“ç‰™éŸ³ç®±', description: 'é˜²æ°´è®¾è®¡ï¼Œ360Â°ç¯ç»•éŸ³æ•ˆï¼Œæˆ·å¤–èšä¼šå¿…å¤‡ã€‚', price: 499.00 },
            { name: 'æœºæ¢°é¼ æ ‡', description: 'é«˜ç²¾åº¦ä¼ æ„Ÿå™¨ï¼Œè‡ªå®šä¹‰æŒ‰é”®ï¼Œæ¸¸æˆåŠå…¬çš†å®œã€‚', price: 249.00 },
            { name: 'VRçœ¼é•œ', description: 'æ²‰æµ¸å¼ä½“éªŒï¼Œæ”¯æŒå¤šç§VRæ¸¸æˆå’Œå½±è§†å†…å®¹ã€‚', price: 1999.00 },
            { name: 'è¡Œè½¦è®°å½•ä»ª', description: '4Ké«˜æ¸…å¤œè§†ï¼Œåœè½¦ç›‘æ§ï¼Œä¿éšœè¡Œè½¦å®‰å…¨ã€‚', price: 399.00 },
            { name: 'æ— çº¿å……ç”µå™¨', description: '15Wå¿«å……ï¼Œæ”¯æŒå¤šè®¾å¤‡å…¼å®¹ï¼Œæ¡Œé¢æ•´æ´ç¥å™¨ã€‚', price: 89.00 },
            { name: 'æ™ºèƒ½é—¨é”', description: 'æŒ‡çº¹è¯†åˆ«ï¼Œæ‰‹æœºè¿œç¨‹æ§åˆ¶ï¼Œå®‰å…¨ä¾¿æ·ã€‚', price: 1299.00 }
        ],
        daily: [
            { name: 'è¿›å£æ— èŠ¯å·çº¸', description: 'åŸç”Ÿæœ¨æµ†åˆ¶é€ ï¼Œå››å±‚åŠ åšï¼Œäº²è‚¤æŸ”è½¯ï¼Œä¸€åŒ…12å·ã€‚', price: 19.90 },
            { name: 'è‡ªåŠ¨æ„Ÿåº”æ´—æ‰‹æ¶²æœº', description: 'çº¢å¤–æ„Ÿåº”ï¼Œå…æ¥è§¦å‡ºæ³¡ï¼Œæœ‰æ•ˆé¿å…äº¤å‰æ„ŸæŸ“ï¼Œå®ˆæŠ¤å®¶äººå¥åº·ã€‚', price: 69.00 },
            { name: 'æ‡’äººæ¡Œé¢å¸å°˜å™¨', description: 'å¼ºåŠ›å¸é™¤æ¡Œé¢ç°å°˜ã€æ©¡çš®å±‘å’Œé›¶é£Ÿç¢å±‘ï¼Œä¸€é”®å¼€å¯ï¼Œè½»æ¾æ´å‡€ã€‚', price: 45.00 },
            { name: 'åˆ†ç±»æ”¶çº³ç›’å¥—è£…', description: 'ä¸€å¥—ä¸‰ä»¶ï¼Œä¸åŒå°ºå¯¸æ»¡è¶³å„ç§æ”¶çº³éœ€æ±‚ï¼Œè®©ä½ çš„æ¡Œé¢äº•äº•æœ‰æ¡ã€‚', price: 38.00 },
            { name: 'å¤©ç„¶ç«¹çº¤ç»´æ¯›å·¾', description: 'å¸æ°´æ€§å¼ºï¼ŒæŸ”è½¯äº²è‚¤ï¼ŒæŠ—èŒé˜²éœ‰ï¼Œä¸‰æ¡è£…ã€‚', price: 29.90 },
            { name: 'å¤šåŠŸèƒ½å¨æˆ¿å‰ªåˆ€', description: 'é”‹åˆ©è€ç”¨ï¼Œå¯å‰ªéª¨å¤´ã€è”¬èœå’Œè‚‰ç±»ï¼Œè¿˜èƒ½å¼€ç“¶å’Œåˆ®é±¼é³ã€‚', price: 39.00 },
            { name: 'å¯é™è§£åƒåœ¾è¢‹', description: 'ç¯ä¿ææ–™åˆ¶ä½œï¼Œæ‰¿é‡å¼ºä¸æ˜“ç ´ï¼Œ100åªè£…ã€‚', price: 12.90 },
            { name: 'ä¾¿æºå¼æŠ˜å æ™¾è¡£æ¶', description: 'å¤–å‡ºæ—…è¡Œå¿…å¤‡ï¼ŒæŠ˜å è®¾è®¡ä¸å ç©ºé—´ï¼Œæ‰¿é‡èƒ½åŠ›å¼ºã€‚', price: 49.00 },
            { name: 'è¶…å£°æ³¢é¦™è–°æœº', description: 'é™éŸ³è¿è¡Œï¼ŒåŠ æ¹¿é¦™è–°äºŒåˆä¸€ï¼Œè¥é€ èˆ’é€‚ç¯å¢ƒã€‚', price: 79.00 },
            { name: 'å¤šåŠŸèƒ½åˆ‡èœå™¨', description: 'å¤šç§åˆ€ç‰‡å¯é€‰ï¼Œåˆ‡ä¸åˆ‡ç‰‡åˆ‡ä¸ä¸€é”®æå®šï¼Œçœæ—¶çœåŠ›ã€‚', price: 59.00 },
            { name: 'è®°å¿†æ£‰æ•å¤´', description: 'æ…¢å›å¼¹æè´¨ï¼Œè´´åˆé¢ˆæ¤æ›²çº¿ï¼Œæ”¹å–„ç¡çœ è´¨é‡ã€‚', price: 129.00 },
            { name: 'ä¸é”ˆé’¢ä¿æ¸©æ¯', description: '316ä¸é”ˆé’¢æè´¨ï¼Œä¿æ¸©ä¿å†·24å°æ—¶ï¼Œ500mlå®¹é‡ã€‚', price: 89.00 },
            { name: 'å¨æˆ¿æ²¹æ±¡æ¸…æ´å‰‚', description: 'å¼ºæ•ˆå»æ±¡ï¼Œå¤©ç„¶æˆåˆ†ä¸ä¼¤æ‰‹ï¼Œè½»æ¾å»é™¤é‡æ²¹æ±¡ã€‚', price: 29.90 },
            { name: 'é˜²æ»‘æµ´å®¤åœ°å«', description: 'å¸æ°´é€Ÿå¹²ï¼Œé˜²æ»‘è®¾è®¡ï¼ŒæŸ”è½¯èˆ’é€‚ï¼Œå¤šç§å›¾æ¡ˆå¯é€‰ã€‚', price: 35.00 },
            { name: 'LEDå°å¤œç¯', description: 'å…‰æ„Ÿè‡ªåŠ¨å¼€å…³ï¼ŒæŸ”å…‰ä¸åˆºçœ¼ï¼Œå‘µæŠ¤å®å®ç¡çœ ã€‚', price: 19.90 },
            { name: 'å¤šåŠŸèƒ½æ•°æ®çº¿', description: 'ä¸€æ‹–ä¸‰è®¾è®¡ï¼Œæ”¯æŒå¿«å……ï¼Œé€‚ç”¨äºæ‰‹æœºã€å¹³æ¿ç­‰è®¾å¤‡ã€‚', price: 29.00 },
            { name: 'å¤©ç„¶æ¤ç‰©æ´—è¡£æ¶²', description: 'æ¸©å’Œé…æ–¹ï¼Œæ·±å±‚æ´å‡€ï¼Œä¸å«è§å…‰å‰‚ï¼Œé€‚åˆæ¯å©´è¡£ç‰©ã€‚', price: 45.00 },
            { name: 'ä¾¿æºå¼é¤å…·å¥—è£…', description: 'åŒ…å«ç­·å­ã€å‹ºå­å’Œå‰å­ï¼Œé£Ÿå“çº§æè´¨ï¼Œç¯ä¿å«ç”Ÿã€‚', price: 25.00 },
            { name: 'æ¡Œé¢åŠ æ¹¿å™¨', description: 'è¿·ä½ è®¾è®¡ä¸å ç©ºé—´ï¼Œé™éŸ³è¿è¡Œï¼Œç¼“è§£ç©ºæ°”å¹²ç‡¥ã€‚', price: 59.00 },
            { name: 'å¤šåŠŸèƒ½ç¬”è®°æœ¬æ”¯æ¶', description: 'å¯è°ƒèŠ‚é«˜åº¦è§’åº¦ï¼Œæ•£çƒ­é€æ°”ï¼Œä¿æŠ¤é¢ˆæ¤ã€‚', price: 79.00 }
        ],
        sports: [
            { name: 'ä¸“ä¸šé˜²æ»‘ç‘œä¼½å«', description: '8mmåŠ åšå¤©ç„¶æ©¡èƒ¶æè´¨ï¼Œé˜²æ»‘æ€§èƒ½ä¼˜å¼‚ï¼Œç¯ä¿æ— å¼‚å‘³ï¼Œé™„å¸¦ç»‘å¸¦æ–¹ä¾¿æºå¸¦ã€‚', price: 129.00 },
            { name: 'æŠ˜å éœ²è¥å¸ç¯·', description: '3-4äººå…¨è‡ªåŠ¨é€Ÿå¼€å¸ç¯·ï¼Œé˜²æ°´é˜²æ™’é¢æ–™ï¼Œé€šé£è®¾è®¡ï¼Œé€‚åˆå®¶åº­æˆ·å¤–éœ²è¥ã€‚', price: 459.00 },
            { name: 'è½»é‡å¾’æ­¥ç™»å±±é‹', description: 'é˜²æ°´é€æ°”é‹é¢ï¼Œé˜²æ»‘Vibramå¤§åº•ï¼Œå‡éœ‡é‹å«ï¼Œé€‚åˆä¸­ä½éš¾åº¦å¾’æ­¥ã€‚', price: 699.00 },
            { name: 'æ™ºèƒ½è¿åŠ¨æ‰‹è¡¨', description: 'æ”¯æŒ100+è¿åŠ¨æ¨¡å¼ï¼Œå¿ƒç‡è¡€æ°§ç›‘æµ‹ï¼Œ50ç±³é˜²æ°´ï¼Œç»­èˆªå¯è¾¾14å¤©ã€‚', price: 899.00 },
            { name: 'å¯æŠ˜å å±±åœ°è‡ªè¡Œè½¦', description: '27é€Ÿå˜é€Ÿç³»ç»Ÿï¼Œé“åˆé‡‘è½¦æ¶ï¼ŒæŠ˜å åå¯æ”¾å…¥æ±½è½¦åå¤‡ç®±ï¼Œæ–¹ä¾¿æºå¸¦ã€‚', price: 1599.00 },
            { name: 'å¤šåŠŸèƒ½æˆ·å¤–èƒŒåŒ…', description: '45Lå¤§å®¹é‡ï¼Œé˜²æ°´é¢æ–™ï¼ŒèƒŒè´Ÿç³»ç»Ÿèˆ’é€‚ï¼Œé€‚åˆ2-3å¤©æˆ·å¤–å¾’æ­¥æ—…è¡Œã€‚', price: 399.00 },
            { name: 'ä¸“ä¸šç¾½æ¯›çƒæ‹å¥—è£…', description: 'å…¨ç¢³ç´ çº¤ç»´æè´¨ï¼Œè½»é‡åŒ–è®¾è®¡ï¼Œå«2æ”¯çƒæ‹ã€3ä¸ªç¾½æ¯›çƒå’Œä¾¿æºåŒ…ã€‚', price: 259.00 },
            { name: 'è‡ªåŠ¨å……æ°”é˜²æ½®å«', description: '3cmåŠ åšæµ·ç»µï¼Œè‡ªåŠ¨å……æ°”è®¾è®¡ï¼Œé˜²æ½®éš”æ¸©ï¼Œé€‚åˆéœ²è¥é‡é¤ä½¿ç”¨ã€‚', price: 199.00 },
            { name: 'é€Ÿå¹²è¿åŠ¨å¥—è£…', description: 'ç”·å¥³åŒæ¬¾ï¼Œå¸æ¹¿æ’æ±—é¢æ–™ï¼Œé€æ°”ä¸é—·æ±—ï¼Œé€‚åˆè·‘æ­¥å¥èº«ç­‰è¿åŠ¨ã€‚', price: 159.00 },
            { name: 'é«˜å¼ºåº¦æ‹‰åŠ›ç»³', description: '5æ ¹ä¸åŒé˜»åŠ›ç»³ç»„åˆï¼Œå¯è°ƒèŠ‚é•¿åº¦ï¼Œé€‚åˆå±…å®¶åŠ›é‡è®­ç»ƒï¼Œé™„å¸¦æ”¶çº³è¢‹ã€‚', price: 89.00 },
            { name: 'æˆ·å¤–ä¾¿æºå¼æ°´å£¶', description: '1Lå¤§å®¹é‡ï¼Œé£Ÿå“çº§ä¸é”ˆé’¢æè´¨ï¼Œä¿æ¸©ä¿å†·24å°æ—¶ï¼Œå¸¦ç™»å±±æ‰£è®¾è®¡ã€‚', price: 129.00 },
            { name: 'ä¸“ä¸šæ½œæ°´æ¸¸æ³³é•œ', description: 'é˜²é›¾é˜²ç´«å¤–çº¿é•œç‰‡ï¼Œç¡…èƒ¶å¯†å°åœˆï¼Œè´´åˆä¸æ¼æ°´ï¼Œå¯è°ƒèŠ‚å¤´å¸¦ã€‚', price: 159.00 },
            { name: 'æŠ˜å å¼å¤ªé˜³èƒ½å……ç”µå®', description: '20000mAhå¤§å®¹é‡ï¼Œæ”¯æŒå¤ªé˜³èƒ½å……ç”µï¼ŒåŒUSBè¾“å‡ºï¼Œæˆ·å¤–åº”æ€¥å¿…å¤‡ã€‚', price: 299.00 },
            { name: 'å®¤å†…å¥èº«åŠ¨æ„Ÿå•è½¦', description: 'é™éŸ³ç£æ§ç³»ç»Ÿï¼Œå¯è°ƒèŠ‚é˜»åŠ›å’Œåº§æ¤…é«˜åº¦ï¼Œå¸¦å¿ƒç‡ç›‘æµ‹åŠŸèƒ½ã€‚', price: 1899.00 },
            { name: 'æˆ·å¤–é‡è¥ç‚‰å…·å¥—è£…', description: 'ä¾¿æºå¼æ°”ç‚‰+é”…å…·ç»„åˆï¼Œç«åŠ›è°ƒèŠ‚ç²¾å‡†ï¼Œé€‚åˆé‡å¤–çƒ¹é¥ªã€‚', price: 259.00 },
            { name: 'ä¸“ä¸šè·‘æ­¥è¿åŠ¨é‹', description: 'ç¼“éœ‡ä¸­åº•ï¼Œé€æ°”ç½‘é¢ï¼Œè€ç£¨æ©¡èƒ¶å¤§åº•ï¼Œé€‚åˆé•¿è·ç¦»è·‘æ­¥ã€‚', price: 799.00 },
            { name: 'å¤šåŠŸèƒ½æˆ˜æœ¯æ‰‹ç”µç­’', description: 'å¼ºå…‰è¿œå°„ï¼Œæ”¯æŒçˆ†é—ªå’ŒSOSæ¨¡å¼ï¼Œé˜²æ°´é˜²å°˜ï¼Œå¯å……ç”µè®¾è®¡ã€‚', price: 199.00 },
            { name: 'ç‘œä¼½çƒå¥èº«çƒ', description: 'é˜²çˆ†æè´¨ï¼Œç›´å¾„75cmï¼Œé€‚åˆç‘œä¼½ç»ƒä¹ å’Œæ ¸å¿ƒåŠ›é‡è®­ç»ƒï¼Œé™„å¸¦æ‰“æ°”ç­’ã€‚', price: 69.00 },
            { name: 'æˆ·å¤–ä¿æ¸©é‡é¤ç¯®', description: 'å®¹é‡20Lï¼Œä¿æ¸©å±‚è®¾è®¡ï¼Œå¯å®¹çº³4äººä»½é¤å…·ï¼Œé€‚åˆéƒŠå¤–é‡é¤ã€‚', price: 299.00 },
            { name: 'ä¸“ä¸šæ»‘é›ªæ¿å¥—è£…', description: 'å…¨èƒ½å‹æ»‘é›ªæ¿+å›ºå®šå™¨+é›ªæ–ç»„åˆï¼Œé€‚åˆåˆä¸­çº§æ»‘é›ªçˆ±å¥½è€…ã€‚', price: 2599.00 }
        ],
        beautyCare: [
            { name: 'æ°¨åŸºé…¸æ´é¢ä¹³', description: 'æ¸©å’Œæ¸…æ´é…æ–¹ï¼Œå«æ°¨åŸºé…¸æˆåˆ†ï¼Œæ´—å®Œä¸ç´§ç»·ï¼Œé€‚åˆæ‰€æœ‰è‚¤è´¨', price: 89.00 },
            { name: 'ç»å°¿é…¸è¡¥æ°´é¢è†œ', description: 'é«˜æµ“åº¦ç»å°¿é…¸ç²¾åï¼Œæ·±å±‚è¡¥æ°´é”æ°´ï¼Œä¸€ç›’10ç‰‡è£…', price: 129.00 },
            { name: 'çƒŸé…°èƒºäº®è‚¤ç²¾åæ¶²', description: '5%çƒŸé…°èƒºæµ“åº¦ï¼Œæäº®è‚¤è‰²æ”¹å–„æš—æ²‰ï¼Œæ·¡åŒ–ç—˜å°', price: 159.00 },
            { name: 'ç¥ç»é…°èƒºä¿®æŠ¤é¢éœœ', description: 'ä¸‰é‡ç¥ç»é…°èƒºé…æ–¹ï¼Œä¿®å¤è‚Œè‚¤å±éšœï¼Œæ•æ„Ÿè‚Œé€‚ç”¨', price: 219.00 },
            { name: 'æ°¨åŸºé…¸æ³¡æ³¡æ²æµ´éœ²', description: 'ä¸°å¯Œç»†è…»æ³¡æ²«ï¼Œæ¸©å’Œæ¸…æ´ä¸å‡æ»‘ï¼ŒæŒä¹…ç•™é¦™', price: 59.00 },
            { name: 'ä¹³æœ¨æœæŠ¤æ‰‹éœœå¥—è£…', description: 'å«ä¹³æœ¨æœæ²¹å’Œç»´ç”Ÿç´ Eï¼Œæ»‹æ¶¦ä¿æ¹¿ï¼Œ3æ”¯è£…ä¸åŒé¦™å‹', price: 45.00 },
            { name: 'èŠ¦èŸèƒ¶èˆ’ç¼“å‡èƒ¶', description: '99%èŠ¦èŸåŸæ±æå–ï¼Œèˆ’ç¼“æ™’åä¿®æŠ¤ï¼Œå¯åšç¡çœ é¢è†œ', price: 39.00 },
            { name: 'åŒ–å¦†åˆ·å¥—è£…12æ”¯', description: 'æŸ”è½¯äººé€ çº¤ç»´æ¯›ï¼Œå«æ•£ç²‰åˆ·ã€çœ¼å½±åˆ·ç­‰ï¼Œé€æ”¶çº³åŒ…', price: 139.00 },
            { name: 'å¤©ç„¶æ¤ç‰©æ´—å‘æ°´', description: 'æ— ç¡…æ²¹é…æ–¹ï¼Œæ§æ²¹å»å±‘ï¼Œé€‚åˆæ²¹æ€§å‘è´¨', price: 79.00 },
            { name: 'é˜²æ°´ç«æ¯›è†', description: 'æµ“å¯†çº¤é•¿æ•ˆæœï¼Œé˜²æ°´é˜²æ±—ä¸æ™•æŸ“ï¼Œæ˜“å¸å¦†', price: 69.00 },
            { name: 'ä¿æ¹¿ç²‰åº•æ¶²', description: 'è½»è–„æœå¸–ï¼Œè‡ªç„¶é®ç‘•ï¼ŒæŒå¦†8å°æ—¶ä¸è„±å¦†', price: 189.00 },
            { name: 'å»è§’è´¨æ­»çš®è†', description: 'æ¸©å’Œå»é™¤é¢éƒ¨è€åºŸè§’è´¨ï¼Œæ¯å‘¨ä½¿ç”¨1-2æ¬¡', price: 49.00 },
            { name: 'é˜²æ™’éœœSPF50+', description: 'é«˜å€é˜²æ™’ï¼Œé˜²æ°´é˜²æ±—ï¼Œæ¸…çˆ½ä¸æ²¹è…»', price: 99.00 },
            { name: 'ç«ç‘°çº¯éœ²çˆ½è‚¤æ°´', description: 'å¤©ç„¶ç«ç‘°æå–ï¼Œè¡¥æ°´ä¿æ¹¿ï¼Œå¯åšæ°´è†œ', price: 65.00 },
            { name: 'å¸å¦†æ°´æ•æ„Ÿè‚Œç”¨', description: 'æ¸©å’Œæ— åˆºæ¿€ï¼Œçœ¼å”‡è„¸ä¸‰åˆä¸€ï¼Œæ·±å±‚æ¸…æ´', price: 55.00 },
            { name: 'ç»´ç”Ÿç´ Eæ¶¦å”‡è†', description: 'æŒä¹…æ»‹æ¶¦ä¿æ¹¿ï¼Œæ·¡åŒ–å”‡çº¹ï¼Œæ— è‰²é€æ˜', price: 25.00 },
            { name: 'èŒ¶æ ‘ç²¾æ²¹ç¥›ç—˜å‡èƒ¶', description: 'å¿«é€Ÿæ¶ˆç‚ç¥›ç—˜ï¼Œæ·¡åŒ–ç—˜å°ï¼Œä¸åˆºæ¿€çš®è‚¤', price: 35.00 },
            { name: 'å‹ç¼©é¢è†œçº¸100ç²’', description: 'çº¯æ£‰æè´¨ï¼Œå¸æ°´æ€§å¼ºï¼Œæ­é…çˆ½è‚¤æ°´ä½¿ç”¨', price: 29.00 },
            { name: 'èº«ä½“ç£¨ç ‚è†', description: 'æµ·ç›é¢—ç²’ï¼Œæ¸©å’Œå»è§’è´¨ï¼Œä½¿è‚Œè‚¤å…‰æ»‘ç»†è…»', price: 69.00 },
            { name: 'çœ‰ç¬”çœ‰ç²‰å¥—è£…', description: 'é˜²æ°´é˜²æ±—ï¼Œæ˜“ä¸Šè‰²ä¸æ™•æŸ“ï¼Œå«çœ‰ç¬”ã€çœ‰ç²‰å’Œçœ‰åˆ·', price: 59.00 }
        ],
        foodSnacks: [
            { name: 'æ··åˆåšæœç¤¼ç›’', description: 'åŒ…å«å·´æ—¦æœ¨ã€è…°æœã€æ ¸æ¡ƒç­‰6ç§åšæœï¼Œç‹¬ç«‹å°åŒ…è£…ï¼Œæ¯æ—¥ä¸€åŒ…è¡¥å……è¥å…»', price: 159.00 },
            { name: 'æ— è”—ç³–å…¨éº¦é¥¼å¹²', description: 'é«˜çº¤ç»´ä½çƒ­é‡ï¼Œæ— è”—ç³–æ·»åŠ ï¼Œå£æ„Ÿé…¥è„†ï¼Œé€‚åˆä»£é¤æˆ–ä¸‹åˆèŒ¶', price: 39.90 },
            { name: 'å†»å¹²æ°´æœè„†ç‰‡', description: 'è‰è“ã€èŠ’æœã€é¦™è•‰å¤šç§å£å‘³ç»„åˆï¼Œéæ²¹ç‚¸ä¿ç•™è¥å…»ï¼Œå„¿ç«¥é›¶é£Ÿé¦–é€‰', price: 45.00 },
            { name: 'çº¯é»‘å·§å…‹åŠ›', description: '85%å¯å¯å«é‡ï¼Œå¾®è‹¦é†‡åšï¼Œæ— æ·»åŠ è”—ç³–ï¼Œç‹¬ç«‹å°å—è£…', price: 59.00 },
            { name: 'æ—¥å¼æ‹‰é¢ç»„åˆè£…', description: 'è±šéª¨ã€é…±æ²¹ã€å‘³å™Œä¸‰ç§å£å‘³ï¼Œå«ç‹¬ç«‹æ±¤åŒ…å’Œå‰çƒ§ï¼Œ5åŒ…è£…', price: 69.00 },
            { name: 'å³é£Ÿç‡•éº¦ç‰‡', description: 'æ¾³æ´²çº¯ç‡•éº¦ï¼Œå…ç…®å³é£Ÿï¼Œå¯æ­é…ç‰›å¥¶æ°´æœï¼Œè¥å…»æ—©é¤é€‰æ‹©', price: 29.90 },
            { name: 'ç‰›è‚‰å¹²ç¤¼ç›’', description: 'å†…è’™å¤é£å¹²å·¥è‰ºï¼ŒåŸå‘³å’Œé¦™è¾£ä¸¤ç§å£å‘³ï¼Œè‚‰è´¨ç´§å®æœ‰åš¼åŠ²', price: 89.00 },
            { name: 'é€Ÿæº¶é»‘å’–å•¡', description: 'å“¥ä¼¦æ¯”äºšè¿›å£å’–å•¡è±†ï¼Œå†»å¹²æŠ€æœ¯ä¿ç•™é£å‘³ï¼Œ40æ¡è£…', price: 65.00 },
            { name: 'èœ‚èœœæŸšå­èŒ¶', description: 'éŸ©å›½è¿›å£åŸæ–™ï¼Œèœ‚èœœä¸æŸšå­é»„é‡‘é…æ¯”ï¼Œå†²æ°´é¥®ç”¨é…¸ç”œå¯å£', price: 45.00 },
            { name: 'è–¯ç‰‡å¤§ç¤¼åŒ…', description: 'åŸå‘³ã€ç•ªèŒ„ã€çƒ§çƒ¤å¤šç§å£å‘³æ··åˆï¼Œç‹¬ç«‹å°åŒ…è£…ï¼Œåˆ†äº«è£…', price: 39.00 },
            { name: 'äº”å¸¸ç¨»èŠ±é¦™å¤§ç±³', description: '5kgçœŸç©ºåŒ…è£…ï¼Œé»‘é¾™æ±Ÿäº”å¸¸äº§åŒºï¼Œç±³ç²’é¥±æ»¡å£æ„Ÿé¦™ç³¯', price: 99.00 },
            { name: 'ç‰¹çº§åˆæ¦¨æ©„æ¦„æ²¹', description: '2Lè£…ï¼Œè¥¿ç­ç‰™è¿›å£ï¼Œé€‚åˆå‡‰æ‹Œå’Œä½æ¸©çƒ¹é¥ªï¼Œå¥åº·é£Ÿç”¨æ²¹', price: 129.00 },
            { name: 'å†»å¹²é“¶è€³ç¾¹', description: 'å…ç…®å³é£Ÿï¼Œæ·»åŠ æ¸æå’Œå†°ç³–ï¼Œå¼€æ°´å†²æ³¡3åˆ†é’Ÿå³å¯é£Ÿç”¨', price: 55.00 },
            { name: 'é±¿é±¼ä¸æµ·å‘³é›¶é£Ÿ', description: 'æ·±æµ·é±¿é±¼åˆ¶ä½œï¼Œé²œå«©æœ‰åš¼åŠ²ï¼Œç‹¬ç«‹åŒ…è£…æ–¹ä¾¿æºå¸¦', price: 35.00 },
            { name: 'æŠ¹èŒ¶å‘³æ›²å¥‡é¥¼å¹²', description: 'è¿›å£æŠ¹èŒ¶ç²‰åˆ¶ä½œï¼ŒèŒ¶é¦™æµ“éƒï¼Œå£æ„Ÿé…¥è„†ï¼Œç¤¼ç›’è£…', price: 49.00 },
            { name: 'çº¢è±†è–ç±³ç²‰', description: 'ç¥›æ¹¿ä»£é¤ç²‰ï¼Œç‹¬ç«‹å°åŒ…è£…ï¼Œå¼€æ°´å†²è°ƒå³å¯é£Ÿç”¨ï¼Œ30æ¡è£…', price: 59.00 },
            { name: 'å·´æ—¦æœ¨å¤¹å¿ƒæ£', description: 'æ–°ç–†ç°æ£å¤¹å·´æ—¦æœ¨ï¼Œæ— æ·»åŠ è”—ç³–ï¼Œé¦™ç”œå¯å£ï¼Œè¡¥è¡€ç›Šæ°”', price: 45.00 },
            { name: 'æ„å¤§åˆ©é¢å¥—è£…', description: 'å«èºæ—‹é¢ã€ç•ªèŒ„é…±å’Œæ„å¼é¦™è‰ï¼Œ4äººä»½ï¼Œç®€å•æ˜“åš', price: 39.00 },
            { name: 'é»„æ¡ƒç½å¤´', description: 'ç €å±±é»„æ¡ƒåˆ¶ä½œï¼Œæ— é˜²è…å‰‚ï¼Œæœè‚‰é¥±æ»¡ï¼Œç³–æ°´æ¸…ç”œ', price: 35.00 },
            { name: 'åšæœç‡•éº¦èƒ½é‡æ£’', description: 'ä»£é¤é›¶é£Ÿï¼Œå«å¤šç§åšæœå’Œç‡•éº¦ï¼ŒæŠ—é¥¿4å°æ—¶ï¼Œ12æ¡è£…', price: 69.00 }
        ],
        milktea: [
            { name: 'æ³¢éœ¸å¥¶èŒ¶', description: 'ç»å…¸å°å¼é£å‘³ï¼ŒQå¼¹æ³¢éœ¸æ­é…é¦™æµ“å¥¶èŒ¶ï¼Œå£æ„Ÿä¸°å¯Œã€‚', price: 15.00, brand: 'CoCoéƒ½å¯' },
            { name: 'å››å­£æ˜¥ç›å¥‡æœµ', description: 'æ¸…çˆ½çš„å››å­£æ˜¥èŒ¶åº•ï¼Œè¦†ä¸Šç»µå¯†çš„å’¸é¦™èŠå£«å¥¶ç›–ï¼Œå±‚æ¬¡åˆ†æ˜ã€‚', price: 18.00, brand: 'ä¸€ç‚¹ç‚¹' },
            { name: 'å¤šè‚‰è‘¡è„', description: 'æ–°é²œæ‰‹å‰¥è‘¡è„æœè‚‰ï¼Œæ­é…æ¸…çˆ½ç»¿å¦èŒ¶åº•å’ŒQå¼¹è„†æ³¢æ³¢ï¼Œäººæ°”é¦–é€‰ã€‚', price: 29.00, brand: 'å–œèŒ¶' },
            { name: 'å¹½å…°æ‹¿é“', description: 'ç²¾é€‰çº¢èŒ¶åº•ä¸é²œå¥¶èåˆï¼Œé¡¶éƒ¨æ’’ä¸Šé¦™è„†ç¢§æ ¹æœï¼ŒèŒ¶é¦™ä¸åšæœé¦™äº¤ç»‡ã€‚', price: 20.00, brand: 'èŒ¶é¢œæ‚¦è‰²' },
            { name: 'èŠ‹æ³¥æ³¢æ³¢ç‰›ä¹³', description: 'æ‰‹å·¥æ£åˆ¶çš„é¦™ç”œèŠ‹æ³¥ï¼Œæ­é…Qå¼¹æ³¢æ³¢å’Œæ–°é²œç‰›ä¹³ï¼Œå£æ„Ÿç»µå¯†ã€‚', price: 22.00, brand: 'å¥ˆé›ªçš„èŒ¶' },
            { name: 'æ¨æç”˜éœ²', description: 'æ–°é²œèŠ’æœã€è¥¿æŸšæœç²’ä¸è¥¿ç±³éœ²çš„å®Œç¾ç»“åˆï¼Œå¤æ—¥è§£æš‘ç¥å™¨ã€‚', price: 25.00, brand: 'å–œèŒ¶' },
            { name: 'æ‰¾å¥¶èŒ¶', description: 'ç»å…¸åŸå‘³å¥¶èŒ¶ï¼Œå›å½’æœ€çº¯ç²¹çš„å¥¶ä¸èŒ¶çš„èåˆï¼Œæ€§ä»·æ¯”ä¹‹é€‰ã€‚', price: 12.00, brand: 'ä¸€ç‚¹ç‚¹' },
            { name: 'å†°é²œæŸ æª¬æ°´', description: 'æ–°é²œæŸ æª¬åˆ‡ç‰‡ï¼Œæ­é…å†°å—å’Œçº¯å‡€æ°´ï¼Œæ¸…çˆ½è§£æ¸´ï¼Œæ€§ä»·æ¯”ä¹‹ç‹ã€‚', price: 4.00, brand: 'èœœé›ªå†°åŸ' },
            { name: 'çç å¥¶èŒ¶', description: 'ç»å…¸çš„èœœé›ªå¥¶èŒ¶ï¼Œæ­é…Qå¼¹çç ï¼Œæ˜¯æ¯ä¸ªäººçš„å…¥é—¨æ¬¾ã€‚', price: 7.00, brand: 'èœœé›ªå†°åŸ' },
            { name: 'æ‘©å¤©è„†è„†å†°æ·‡æ·‹', description: 'é¦™è‰å‘³çš„å†°æ·‡æ·‹ç”œç­’ï¼Œé¡¶éƒ¨åŠ ä¸Šé…¥è„†çš„å·§å…‹åŠ›æ£’ï¼Œç«¥å¹´çš„å‘³é“ã€‚', price: 5.00, brand: 'èœœé›ªå†°åŸ' },
            { name: 'æ»¡æ¯ç™¾é¦™æœ', description: 'æ–°é²œç™¾é¦™æœæœè‚‰ä¸èŒ¶åº•çš„æ¿€æƒ…ç¢°æ’ï¼Œé…¸ç”œå¯å£ï¼Œæœé¦™å››æº¢ã€‚', price: 8.00, brand: 'èœœé›ªå†°åŸ' },
            { name: 'è¡€ç³¯ç±³çº¢è±†å¥¶èŒ¶', description: 'æ‹›ç‰Œè¡€ç³¯ç±³æ­é…è½¯ç³¯çº¢è±†ï¼Œå£æ„Ÿä¸°å¯Œï¼Œæš–å¿ƒæš–èƒƒçš„äº”è°·å¥¶èŒ¶ã€‚', price: 16.00, brand: 'æ²ªä¸Šé˜¿å§¨' },
            { name: 'é²œç‚–æ¢¨è†', description: 'æ‰‹å·¥é²œç‚–æ¢¨è†ï¼Œæ¸…æ¶¦é™ç‡¥ï¼Œæ­é…é“¶è€³ï¼Œæ˜¯å…»ç”Ÿäººå£«çš„é¦–é€‰ã€‚', price: 18.00, brand: 'æ²ªä¸Šé˜¿å§¨' },
            { name: 'ç»¿è±†ç‰›ä¹³å†°', description: 'æ¸…çˆ½çš„ç»¿è±†æ²™æ­é…é¡ºæ»‘ç‰›ä¹³ï¼Œå¤æ—¥è§£æš‘ï¼Œå£æ„Ÿç»µå¯†ã€‚', price: 15.00, brand: 'æ²ªä¸Šé˜¿å§¨' },
            { name: 'èŠ‹åœ†è‘¡è„', description: 'æ–°é²œè‘¡è„æœè‚‰æ­é…æ‰‹å·¥èŠ‹åœ†ï¼ŒQå¼¹æœ‰åš¼åŠ²ï¼Œæœå‘³åè¶³ã€‚', price: 20.00, brand: 'æ²ªä¸Šé˜¿å§¨' },
            { name: 'çƒ¤å¥¶', description: 'ç‹¬ç‰¹çš„çƒ˜ç„™å·¥è‰ºï¼Œå¸¦æ¥ç„¦ç³–èˆ¬çš„ç‚­çƒ§é£å‘³ï¼Œå¥¶é¦™æµ“éƒã€‚', price: 16.00, brand: 'èŒ¶é¢œæ‚¦è‰²' },
            { name: 'å¥¶éœœè‰è“æœèŒ¶', description: 'æ–°é²œè‰è“æœè‚‰ä¸ç»¿èŒ¶çš„å®Œç¾ç»“åˆï¼Œé¡¶éƒ¨è¦†ç›–å’¸é¦™å¥¶éœœã€‚', price: 26.00, brand: 'å¥ˆé›ªçš„èŒ¶' },
            { name: 'é²œèŠ‹ç‰›å¥¶è¥¿ç±³éœ²', description: 'æ–°é²œèŠ‹å¤´è’¸ç…®æˆæ³¥ï¼Œæ­é…è¥¿ç±³å’Œç‰›å¥¶ï¼Œå£æ„Ÿé¡ºæ»‘ã€‚', price: 19.00, brand: 'CoCoéƒ½å¯' },
            { name: 'å†°æ·‡æ·‹çº¢èŒ¶', description: 'é¡ºæ»‘çš„é¦™è‰å†°æ·‡æ·‹çƒï¼Œç¼“ç¼“èå…¥é†‡åšçš„çº¢èŒ¶ä¸­ï¼Œç»å…¸ä¹‹é€‰ã€‚', price: 14.00, brand: 'ä¸€ç‚¹ç‚¹' },
            { name: 'èŠèŠèŠ’èŠ’', description: 'å¤§å—æ–°é²œèŠ’æœæœè‚‰ï¼Œæ­é…ç»¿å¦èŒ¶åº•å’Œæµ“éƒèŠå£«å¥¶ç›–ï¼Œæœé¦™å››æº¢ã€‚', price: 32.00, brand: 'å–œèŒ¶' },
            { name: 'å£°å£°ä¹Œé¾™', description: 'å¸¦æœ‰ç‹¬ç‰¹çƒŸç†é£å‘³çš„ä¹Œé¾™èŒ¶åº•ï¼Œå…¥å£ç”˜é†‡ï¼Œå›å‘³æ‚ é•¿ã€‚', price: 17.00, brand: 'èŒ¶é¢œæ‚¦è‰²' },
            { name: 'éœ¸æ°”æ©™å­', description: 'ç²¾é€‰è¿›å£æ–°å¥‡å£«æ©™ï¼Œæ•´é¢—é²œåˆ‡ï¼Œæ­é…æ¸…é¦™ç»¿èŒ¶ï¼ŒVCçˆ†æ£šã€‚', price: 25.00, brand: 'å¥ˆé›ªçš„èŒ¶' }
        ],
        gifts: [
            { name: 'ç®€çº¦æƒ…ä¾£å¯¹æˆ’', description: 'é‡‡ç”¨ä¼˜è´¨é‡‘å±æ‰“é€ ï¼Œè®¾è®¡ç®€çº¦æ—¶å°šï¼Œè±¡å¾æ°¸æ’çˆ±æ„ã€‚', price: 520.00, brand: 'å‘¨å¤§ç¦' },
            { name: 'ç’€ç’¨é’»çŸ³æƒ…ä¾£å¯¹æˆ’', description: 'é•¶åµŒé—ªè€€é’»çŸ³ï¼Œå·¥è‰ºç²¾æ¹›ï¼Œæ˜¯æƒ…ä¾£é—´çè´µçš„æ‰¿è¯ºè±¡å¾ã€‚', price: 5999.00, brand: 'DR' },
            { name: '99æœµçº¢ç«ç‘°èŠ±æŸ', description: 'ç²¾é€‰99æœµé²œè‰³çº¢ç«ç‘°ï¼Œå¯“æ„é•¿é•¿ä¹…ä¹…ï¼Œæµªæ¼«è‡³æã€‚', price: 399.00, brand: 'é‡å…½æ´¾BEAST' },
            { name: 'æ°¸ç”ŸèŠ±å°ç†Šç¤¼ç›’', description: 'å¯çˆ±å°ç†Šæ­é…æ°¸ä¸å‡‹è°¢çš„æ°¸ç”ŸèŠ±ï¼Œç²¾è‡´åˆæµªæ¼«ã€‚', price: 258.00, brand: 'è¯ºèª“ROSEONLY' },
            { name: 'æƒ…ä¾£è¿å¸½å«è¡£', description: 'çº¯æ£‰æè´¨ï¼Œèˆ’é€‚é€æ°”ï¼Œæƒ…ä¾£æ¬¾è®¾è®¡ï¼Œæ—¶å°šç™¾æ­ã€‚', price: 199.00, brand: 'å”ç‹®Tonlion' },
            { name: 'ç®€çº¦æƒ…ä¾£Tæ¤', description: 'ç®€çº¦é£æ ¼ï¼Œå¤šç§é¢œè‰²å¯é€‰ï¼Œé€‚åˆæ—¥å¸¸ç©¿ç€ã€‚', price: 99.00, brand: 'æ£®é©¬Semir' },
            { name: 'æƒ…ä¾£ç‰›ä»”å¤–å¥—', description: 'ç»å…¸ç‰›ä»”é¢æ–™ï¼Œæ½®æµæ¬¾å¼ï¼Œæƒ…ä¾£å‡ºè¡—è¶…å¸ç›ã€‚', price: 399.00, brand: 'ç¾ç‰¹æ–¯é‚¦å¨' },
            { name: 'æƒ…ä¾£è¿åŠ¨é‹', description: 'èˆ’é€‚é‹åº•ï¼Œæ—¶å°šå¤–è§‚ï¼Œé€‚åˆæƒ…ä¾£ä¸€èµ·è¿åŠ¨ã€‚', price: 499.00, brand: 'æå®LINING' },
            { name: 'æƒ…ä¾£æ‰‹è¡¨', description: 'ç®€çº¦è¡¨ç›˜è®¾è®¡ï¼Œç²¾å‡†èµ°æ—¶ï¼Œæ—¶åˆ»ç›¸ä¼´ã€‚', price: 799.00, brand: 'å¡è¥¿æ¬§CASIO' },
            { name: 'æƒ…ä¾£é¦™æ°´ç¤¼ç›’', description: 'ç”·é¦™å¥³é¦™æ­é…ï¼Œç‹¬ç‰¹é¦™å‘³ï¼Œå¢æ·»æµªæ¼«æ°›å›´ã€‚', price: 560.00, brand: 'ç¥–ç›ç‘Jo Malone' },
            { name: 'æƒ…ä¾£ç¡è¡£', description: 'æŸ”è½¯é¢æ–™ï¼Œèˆ’é€‚äº²è‚¤ï¼Œäº«å—æ¸©é¦¨å±…å®¶æ—¶å…‰ã€‚', price: 239.00, brand: 'èŠ¬è…¾FENTENG' },
            { name: 'æƒ…ä¾£ä¿æ¸©æ¯', description: 'ä¿æ¸©æ•ˆæœå¥½ï¼Œå¯çˆ±å¤–è§‚ï¼Œæƒ…ä¾£å‡ºè¡Œå¿…å¤‡ã€‚', price: 129.00, brand: 'å“ˆå°”æ–¯HAERS' },
            { name: 'æƒ…ä¾£é’¥åŒ™æ‰£', description: 'ç²¾è‡´å°å·§ï¼Œå°æœ‰æƒ…ä¾£å…ƒç´ ï¼Œæºå¸¦æ–¹ä¾¿ã€‚', price: 39.00, brand: 'ååˆ›ä¼˜å“MINISO' },
            { name: 'æƒ…ä¾£æ‰‹å·¥ç›¸å†Œ', description: 'å¯äº²æ‰‹åˆ¶ä½œï¼Œè®°å½•æƒ…ä¾£é—´ç¾å¥½å›å¿†ã€‚', price: 69.00, brand: 'æ™¨å…‰M&G' },
            { name: 'æƒ…ä¾£ç©å¶', description: 'å¯çˆ±æ¯›ç»’ç©å¶ï¼Œä¸€å¯¹æ­é…ï¼ŒèŒè¶£åè¶³ã€‚', price: 89.00, brand: 'è¿ªå£«å°¼Disney' },
            { name: 'æƒ…ä¾£é›¨ä¼', description: 'æ™´é›¨ä¸¤ç”¨ï¼Œæ—¶å°šå¤–è§‚ï¼Œä¸ºæƒ…ä¾£é®é£æŒ¡é›¨ã€‚', price: 99.00, brand: 'å¤©å ‚ä¼' },
            { name: 'æƒ…ä¾£é’±åŒ…', description: 'ä¼˜è´¨çš®é©ï¼Œå®ç”¨åˆç¾è§‚ï¼Œæ–¹ä¾¿æºå¸¦ã€‚', price: 189.00, brand: 'å•„æœ¨é¸ŸTUCANO' },
            { name: 'æƒ…ä¾£æŠ±æ•', description: 'æŸ”è½¯èˆ’é€‚ï¼Œé åœ¨ä¸Šé¢äº«å—ç”œèœœæ—¶å…‰ã€‚', price: 79.00, brand: 'å—æäººNanJiren' },
            { name: 'æƒ…ä¾£å¤ªé˜³é•œ', description: 'æ—¶å°šæ¬¾å¼ï¼Œæœ‰æ•ˆé˜»æŒ¡ç´«å¤–çº¿ï¼Œå‡ºè¡Œæ—¶å°šå•å“ã€‚', price: 269.00, brand: 'æš´é¾™BOLON' },
            { name: 'æƒ…ä¾£è“ç‰™éŸ³ç®±', description: 'éŸ³è´¨æ¸…æ™°ï¼Œå°å·§ä¾¿æºï¼Œäº«å—éŸ³ä¹æ—¶å…‰ã€‚', price: 159.00, brand: 'æ¼«æ­¥è€…EDIFIER' },
            { name: 'æƒ…ä¾£æ‰‹é“¾', description: 'ç²¾ç¾è®¾è®¡ï¼Œä½©æˆ´åœ¨æ‰‹è…•ä¸Šï¼Œå½°æ˜¾æƒ…ä¾£èº«ä»½ã€‚', price: 168.00, brand: 'æ–½åæ´›æ€å¥‡SWAROVSKI' },
            { name: 'æƒ…ä¾£å¸½å­', description: 'æ½®æµæ¬¾å¼ï¼Œé®é˜³åˆæ—¶å°šï¼Œæƒ…ä¾£æ­é…è¶…é…·ã€‚', price: 89.00, brand: 'MLB' },
            { name: 'æƒ…ä¾£é¤å…·', description: 'ç²¾è‡´é¤å…·ï¼Œé€‚åˆæƒ…ä¾£ä¸€èµ·ç”¨é¤ï¼Œå¢æ·»ç”Ÿæ´»ä»ªå¼æ„Ÿã€‚', price: 139.00, brand: 'åŒç«‹äººZWILLING' },
            { name: 'æƒ…ä¾£æ‰‹æœºå£³', description: 'å¯çˆ±æˆ–é…·ç‚«çš„è®¾è®¡ï¼Œä¿æŠ¤æ‰‹æœºåŒæ—¶ç§€å‡ºæ©çˆ±ã€‚', price: 49.00, brand: 'äº¿è‰²ESR' },
            { name: 'æƒ…ä¾£æ‹¼å›¾', description: 'ä¸€èµ·å®Œæˆæ‹¼å›¾ï¼Œäº«å—åˆä½œä¹è¶£ï¼Œç•™ä¸‹ç¾å¥½å›å¿†ã€‚', price: 59.00, brand: '3D-JP' },
            { name: 'æƒ…ä¾£é¦™è–°èœ¡çƒ›', description: 'æ•£å‘è¿·äººé¦™æ°”ï¼Œè¥é€ æµªæ¼«æ°›å›´ã€‚', price: 99.00, brand: 'è§‚å¤To Summer' },
            { name: 'æƒ…ä¾£è¿åŠ¨èƒŒåŒ…', description: 'å¤§å®¹é‡ï¼Œèˆ’é€‚èƒŒè´Ÿï¼Œé€‚åˆæƒ…ä¾£å‡ºè¡Œæˆ–è¿åŠ¨æºå¸¦ç‰©å“ã€‚', price: 299.00, brand: 'å®‰è¸ANTA' },
            { name: 'æƒ…ä¾£æ‹¼å›¾ç›¸æ¡†', description: 'å¯å°†å®Œæˆçš„æ‹¼å›¾æ”¾å…¥ç›¸æ¡†ï¼Œä½œä¸ºè£…é¥°ï¼Œçºªå¿µç¾å¥½ã€‚', price: 79.00, brand: 'æ— å°è‰¯å“MUJI' },
            { name: 'æƒ…ä¾£å¥èº«å™¨æï¼ˆå“‘é“ƒå¥—è£…ï¼‰', description: 'é€‚åˆæƒ…ä¾£ä¸€èµ·å¥èº«é”»ç‚¼ï¼Œæ‰“é€ å¥åº·ç”Ÿæ´»ã€‚', price: 359.00, brand: 'è¿ªå¡ä¾¬DECATHLON' },
            { name: 'æƒ…ä¾£çƒ˜ç„™å¥—è£…', description: 'åŒ…å«çƒ˜ç„™å·¥å…·ï¼Œå¯ä¸€èµ·åˆ¶ä½œç”œèœœç‚¹å¿ƒã€‚', price: 219.00, brand: 'å­¦å¨CHEFMADE' },
            { name: 'æƒ…ä¾£ç‘œä¼½å«', description: 'ç¯ä¿æè´¨ï¼Œèˆ’é€‚é˜²æ»‘ï¼Œé€‚åˆæƒ…ä¾£ä¸€èµ·ç»ƒä¹ ç‘œä¼½ã€‚', price: 149.00, brand: 'å¥¥ä¹‰YOTTOY' }
        ],
        brands: [
            {
                name: ' å®æ ¼ä¸½ Serpenti ç³»åˆ—æ‰‹é•¯ ',
                description: ' ä»¥çµè›‡ä¸ºçµæ„Ÿï¼Œé‡‡ç”¨ 18K é‡‘æè´¨ï¼Œé•¶åµŒç’€ç’¨å®çŸ³ï¼ŒçµåŠ¨ä¼˜é›…ï¼Œå°½æ˜¾å¥¢åæ°”è´¨ï¼Œæ˜¯å®æ ¼ä¸½æå…·ä»£è¡¨æ€§çš„ç»å…¸æ¬¾å¼ã€‚',
                price: 19800.00,
                brand: ' å®æ ¼ä¸½ BVLGARI'
            },
            {
                name: ' æ¢µå…‹é›…å® Alhambra å››å¶è‰é¡¹é“¾ï¼ˆçº¢ç‰é«“é•¶é’»æ¬¾ï¼‰',
                description: ' ç»å…¸å››å¶è‰é€ å‹ï¼Œçº¢ç‰é«“æ­é…é’»çŸ³ï¼Œåœ¨ä¼˜é›…ä¸­å¢æ·»é—ªè€€å…‰èŠ’ï¼Œè±¡å¾ç€å¹¸è¿ä¸ç¾å¥½ï¼Œæ˜¯æ¢µå…‹é›…å®çš„æ˜æ˜Ÿäº§å“ã€‚',
                price: 21000.00,
                brand: ' æ¢µå…‹é›…å® VAN CLEEF & ARPELS'
            },
            {
                name: ' å¡åœ°äºš Love ç³»åˆ—å®½ç‰ˆæ‰‹é•¯ ',
                description: ' æ ‡å¿—æ€§çš„èºä¸é’‰è®¾è®¡ï¼Œå®½ç‰ˆé€ å‹æ›´æ˜¾å¤§æ°”ï¼Œ18K é‡‘æè´¨åšå›ºè€ç”¨ï¼Œå¯“æ„ç€å°†çˆ±ç‰¢ç‰¢é”ä½ï¼Œæ˜¯æƒ…ä¾£é—´è¡¨è¾¾çˆ±æ„çš„çƒ­é—¨é€‰æ‹©ã€‚',
                price: 23000.00,
                brand: ' å¡åœ°äºš CARTIER'
            },
            {
                name: ' åŠ³åŠ›å£«èšå¼æ’åŠ¨æ—¥å¿—å‹ 36 è…•è¡¨ ',
                description: ' åŠ³åŠ›å£«ç»å…¸æ¬¾å¼ï¼Œ36 æ¯«ç±³è¡¨ç›˜é€‚åˆå¤šç§è…•å‘¨ï¼Œèšå¼è¡¨å£³åšå›ºé˜²æ°´ï¼Œç²¾å‡†èµ°æ—¶ï¼Œå±•ç°å“è¶Šå“è´¨ä¸ä½è°ƒå¥¢åã€‚',
                price: 18500.00,
                brand: ' åŠ³åŠ›å£« ROLEX'
            },
            {
                name: ' é¦™å¥ˆå„¿ Chanel CF Mini é“¾æ¡åŒ…ï¼ˆå°ç¾Šçš®ï¼‰',
                description: ' é¦™å¥ˆå„¿ç»å…¸çš„ CF ç³»åˆ—ï¼ŒMini å°ºå¯¸ç²¾è‡´å°å·§ï¼Œå°ç¾Šçš®æè´¨æ‰‹æ„ŸæŸ”è½¯ï¼Œè±æ ¼çº¹æ­é…é‡‘å±é“¾æ¡ï¼Œæ—¶å°šåˆç™¾æ­ï¼Œæ˜¯æ¯ä¸ªæ—¶å°šè¾¾äººçš„æ¢¦æƒ³å•å“ã€‚',
                price: 20500.00,
                brand: ' é¦™å¥ˆå„¿ CHANEL'
            },
            {
                name: ' è¿ªå¥¥ Dior Lady D-Lite ä¸‰æ ¼æˆ´å¦ƒåŒ…ï¼ˆè—¤æ ¼çº¹ï¼‰',
                description: ' å»¶ç»­æˆ´å¦ƒåŒ…çš„ä¼˜é›…è®¾è®¡ï¼Œä¸‰æ ¼å¤§å°å®ç”¨ä¸”ç²¾è‡´ï¼Œè—¤æ ¼çº¹æ­é…é‡‘å±æ‰£ï¼Œå½°æ˜¾è¿ªå¥¥çš„é«˜çº§è´¨æ„Ÿï¼Œé€‚åˆå„ç§æ­£å¼ä¸ä¼‘é—²åœºåˆã€‚',
                price: 19900.00,
                brand: ' è¿ªå¥¥ DIOR'
            },
            {
                name: ' çˆ±é©¬ä»• HermÃ¨s Evelyne 16 æ–œæŒåŒ… ',
                description: ' ç®€çº¦çš„è®¾è®¡é£æ ¼ï¼Œ16 å˜ç±³çš„å°ºå¯¸å°å·§ä¾¿æºï¼Œç»å…¸çš„ â€œHâ€ æ‰£æ ‡è¯†ï¼Œæ­é…å¯è°ƒèŠ‚è‚©å¸¦ï¼Œå®ç”¨æ€§ä¸æ—¶å°šæ„Ÿå…¼å…·ï¼Œæ˜¯çˆ±é©¬ä»•å…¥é—¨çº§çš„çƒ­é—¨åŒ…æ¬¾ã€‚',
                price: 22000.00,
                brand: ' çˆ±é©¬ä»• HERMÃˆS'
            },
            {
                name: ' è’‚èŠ™å°¼ Tiffany T True ç³»åˆ— 18K é‡‘é•¶é’»æ‰‹é“¾ ',
                description: 'T å­—é€ å‹è®¾è®¡ç®€æ´ç°ä»£ï¼Œ18K é‡‘æ­é…é—ªè€€é’»çŸ³ï¼Œå±•ç°å‡ºç‹¬ç‰¹çš„æ—¶å°šå“å‘³ï¼Œæ˜¯è’‚èŠ™å°¼å°†ç»å…¸ä¸åˆ›æ–°èåˆçš„ä½³ä½œã€‚',
                price: 20800.00,
                brand: ' è’‚èŠ™å°¼ TIFFANY & CO.'
            },
            {
                name: ' å®è¯—é¾™ Boucheron Quatre Classique ç³»åˆ—æˆ’æŒ‡ ',
                description: ' èåˆäº†å››ç§ä¸åŒæè´¨å’Œçº¹è·¯çš„è®¾è®¡ï¼Œè±¡å¾ç€å’Œè°ä¸å¹³è¡¡ï¼Œå±•ç°å‡ºå‰å«ä¼˜é›…çš„é£æ ¼ï¼Œç”·å¥³å‡å¯ä½©æˆ´ï¼Œå½°æ˜¾ä¸ªæ€§ä¸å“å‘³ã€‚',
                price: 19500.00,
                brand: ' å®è¯—é¾™ BOUCHERON'
            },
            {
                name: ' å°šç¾å·´é» Chaumet Liens Ã‰vidence ç³»åˆ—é¡¹é“¾ ',
                description: ' ä»¥ â€œXâ€ é€ å‹ä¸ºæ ¸å¿ƒï¼Œä»£è¡¨ç€ç¼˜åˆ†çš„è¿ç»“ï¼Œ18K é‡‘æ­é…é’»çŸ³ï¼Œç®€çº¦è€Œä¸å¤±ä¼˜é›…ï¼Œå¯“æ„ç¾å¥½ï¼Œé€‚åˆä½œä¸ºæƒ…ä¾£é—´çš„å®šæƒ…ä¿¡ç‰©ã€‚',
                price: 21500.00,
                brand: ' å°šç¾å·´é» CHAUMET'
            }

        ]


    };

    /**
     * æ ¹æ®æŒ‡å®šçš„å•†å“ç±»åˆ«ï¼Œæ¸²æŸ“å•†å“åˆ—è¡¨
     * @param {string} category - å•†å“ç±»åˆ« (ä¾‹å¦‚ 'takeout', 'electronics')
     */
    /**
     * æ ¹æ®æŒ‡å®šçš„å•†å“ç±»åˆ«ï¼Œæ¸²æŸ“å•†å“åˆ—è¡¨ (V2 - æ”¯æŒå“ç‰Œæ ‡è®°)
     * @param {string} category - å•†å“ç±»åˆ« (ä¾‹å¦‚ 'takeout', 'electronics')
     */
    function renderProducts(category) {
        productGrid.innerHTML = ''; // æ¸…ç©ºç°æœ‰å•†å“
        const items = productData[category] || []; // è·å–å¯¹åº”ç±»åˆ«çš„å•†å“æ•°ç»„

        if (items.length === 0) {
            productGrid.innerHTML = '<p>è¯¥åˆ†ç±»ä¸‹æš‚æ— å•†å“</p>';
            return;
        }

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'product-card';

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨å“ç‰Œä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨åˆ™ç”Ÿæˆå“ç‰Œæ ‡ç­¾HTML â–¼â–¼â–¼
            const brandTagHTML = item.brand ? `<div class="product-brand-tag">${item.brand}</div>` : '';
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            card.innerHTML = `
            ${brandTagHTML} 
            <div class="product-name">${item.name}</div>
            <div class="product-description">${item.description}</div>
            <div class="product-footer">
                <span class="product-price">Â¥${item.price.toFixed(2)}</span>
                <button class="add-to-cart-btn">+</button>
            </div>
        `;
            productGrid.appendChild(card);
        });
    }

    // --- äº‹ä»¶ç›‘å¬ ---
    // ==========================================================
    // === æ–°å¢ï¼šä¸ºé¡¶éƒ¨å¤‡æ³¨åæ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤º/éšè—å†…å¿ƒç‹¬ç™½ ===
    // ==========================================================
    // ==========================================================
    // === ä¿®æ”¹ï¼šç‚¹å‡»é¡¶éƒ¨æ ‡é¢˜ ===
    // ==========================================================
    // ç‚¹å‡»é¡¶éƒ¨æ ‡é¢˜ï¼Œæ˜¾ç¤º/éšè—å†…å¿ƒç‹¬ç™½
    chatContactNameTrigger.addEventListener('click', (event) => {
        event.stopPropagation();

        // 1. å¦‚æœæ˜¯ç¾¤èŠï¼Œç›´æ¥é€€å‡º
        if (currentOpenGroup) {
            return;
        }

        // 2. â–¼â–¼â–¼ æ–°å¢ï¼šæ£€æŸ¥â€œå†…å¿ƒç‹¬ç™½â€å¼€å…³ â–¼â–¼â–¼
        // å¦‚æœè®¾ç½®äº† enableMonologue ä¸º falseï¼Œåˆ™ç›´æ¥é€€å‡ºï¼Œä¸æ˜¾ç¤ºå¼¹çª—
        if (currentOpenContact && currentOpenContact.enableMonologue === false) {
            // (å¯é€‰) ä½ å¯ä»¥åœ¨è¿™é‡Œ console.log ä¸€ä¸‹ï¼Œç¡®è®¤é€»è¾‘è§¦å‘äº†
            // console.log("å†…å¿ƒç‹¬ç™½åŠŸèƒ½å·²å…³é—­");
            return;
        }
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

        // 3. æ­£å¸¸æ˜¾ç¤ºé€»è¾‘
        updateThoughtBubbleContent();
        thoughtBubble.classList.toggle('visible');
    });

    // ç›‘å¬åˆ†ç±»æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
    categoryTabsContainer.addEventListener('click', (event) => {
        const targetTab = event.target.closest('.category-tab');
        if (!targetTab) return;

        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ 'active' çŠ¶æ€
        categoryTabsContainer.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // ä¸ºè¢«ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ  'active' çŠ¶æ€
        targetTab.classList.add('active');

        // è·å–è¦æ˜¾ç¤ºçš„ç±»åˆ«
        const categoryToShow = targetTab.dataset.category;
        // é‡æ–°æ¸²æŸ“å•†å“åˆ—è¡¨
        renderProducts(categoryToShow);
    });

    // åˆå§‹åŒ–æ—¶ï¼Œé»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªåˆ†ç±»çš„å•†å“
    renderProducts('takeout');

    // === END: SHOPMALL å•†å“è´­ç‰© JS (DATA & FUNCTIONS) ===

    // === START: SHOPMALL è´­ç‰©æµç¨‹ JS (FUNCTIONS & EVENTS) ===

    // --- æ•°æ®åº“æ“ä½œ ---
    async function saveCartToDB() {
        await dbHelper.saveData('settingsStore', 'shoppingCart', shoppingCart);
    }

    async function loadCartFromDB() {
        const cartData = await dbHelper.loadData('settingsStore', 'shoppingCart');
        if (cartData && Array.isArray(cartData.value)) {
            shoppingCart = cartData.value;
        }
    }

    async function loadOrdersFromDB() {
        const ordersData = await dbHelper.loadData('settingsStore', 'myOrders');
        if (ordersData && Array.isArray(ordersData.value)) {
            renderOrders(ordersData.value);
        }
    }

    // --- é¡µé¢å¯¼èˆª ---
    myCartButton.addEventListener('click', () => {
        renderCart(); // æ‰“å¼€å‰å…ˆæ¸²æŸ“
        phoneFrame.classList.add('show-cart');
    });
    cartBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean('cart-items-container');
        phoneFrame.classList.remove('show-cart');
    });
    myOrdersButton.addEventListener('click', () => {
        phoneFrame.classList.add('show-orders');
    });
    ordersBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean('orders-list-container');
        phoneFrame.classList.remove('show-orders');
    });

    // â–¼â–¼â–¼ ä½¿ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ productGrid ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
    productGrid.addEventListener('click', async (event) => {
        if (event.target.classList.contains('add-to-cart-btn')) {
            const card = event.target.closest('.product-card');
            const name = card.querySelector('.product-name').textContent;
            const priceText = card.querySelector('.product-price').textContent;
            const price = parseFloat(priceText.replace('Â¥', ''));

            // --- â–¼â–¼â–¼ æ–°å¢é€»è¾‘ï¼šè·å–å“ç‰Œä¿¡æ¯ â–¼â–¼â–¼ ---
            // 1. æ‰¾åˆ°å½“å‰æ¿€æ´»çš„åˆ†ç±»
            const activeCategory = document.querySelector('.category-tab.active').dataset.category;
            // 2. åœ¨åŸå§‹æ•°æ®ä¸­æ‰¾åˆ°å¯¹åº”çš„å•†å“å¯¹è±¡
            const originalProduct = productData[activeCategory].find(p => p.name === name);
            // 3. è·å–å“ç‰Œï¼Œå¦‚æœå•†å“æ²¡æœ‰å“ç‰Œå±æ€§ï¼Œåˆ™ä¸º null
            const brand = originalProduct ? originalProduct.brand : null;
            // --- â–²â–²â–² æ–°å¢é€»è¾‘ç»“æŸ â–²â–²â–² ---

            // å°†åŒ…å«å“ç‰Œçš„æ–°å•†å“å¯¹è±¡æ·»åŠ åˆ°è´­ç‰©è½¦
            const product = { id: Date.now(), name, price, brand }; // <-- åœ¨è¿™é‡ŒåŠ å…¥äº† brand
            shoppingCart.push(product);
            await saveCartToDB();

            // æ·»åŠ ä¸€ä¸ªç®€å•çš„è§†è§‰åé¦ˆ
            const originalText = event.target.textContent;
            event.target.textContent = 'å·²æ·»åŠ !';
            setTimeout(() => {
                event.target.textContent = originalText;
            }, 1000);
        }
    });
    // â–²â–²â–² æ›¿æ¢ç»“æŸ â–²â–²â–²

    // --- è´­ç‰©è½¦æ¸²æŸ“å’Œæ“ä½œ ---
    function renderCart() {
        cartItemsContainer.innerHTML = '';
        if (shoppingCart.length === 0) {
            cartItemsContainer.innerHTML = '<p style="text-align:center; color:#888;">è´­ç‰©è½¦æ˜¯ç©ºçš„å“¦</p>';
            confirmPurchaseBtn.disabled = true;
            return;
        }

        confirmPurchaseBtn.disabled = false;
        shoppingCart.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item';
            itemDiv.innerHTML = `
            <div class="cart-item-details">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">Â¥${item.price.toFixed(2)}</div>
            </div>
            <button class="cart-item-delete-btn" data-item-id="${item.id}">
                <svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M7.62211 7.47819L3.35254 3.20862" stroke="#FF0505" stroke-width="0.609939" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M7.62211 3.20862L3.35254 7.47819" stroke="#FF0000" stroke-width="0.609939" stroke-linecap="round" stroke-linejoin="round"/>
</svg>


            </button>
        `;
            cartItemsContainer.appendChild(itemDiv);
        });
    }

    cartItemsContainer.addEventListener('click', async (event) => {
        const deleteBtn = event.target.closest('.cart-item-delete-btn');
        if (deleteBtn) {
            const itemId = parseInt(deleteBtn.dataset.itemId, 10);
            shoppingCart = shoppingCart.filter(item => item.id !== itemId);
            await saveCartToDB();
            renderCart(); // é‡æ–°æ¸²æŸ“è´­ç‰©è½¦
        }
    });

    // === START: æ”¶è´§äººé€‰æ‹© JS (V2 - å·²ä¿®å¤å†»ç»“é—®é¢˜) ===

    /**
     * æ‰“å¼€é€‰æ‹©æ”¶è´§äººå¯¹è¯æ¡† (å¸¦æœ‰åŠ¨ç”»æ•ˆæœ)
     */
    function openRecipientSelectModal() {
        recipientSelectModal.style.display = 'flex';
        // ä½¿ç”¨ä¸€ä¸ªçŸ­æš‚çš„å»¶æ—¶æ¥ç¡®ä¿CSSåŠ¨ç”»èƒ½å¤Ÿè§¦å‘
        setTimeout(() => {
            recipientSelectModal.style.opacity = '1';
            recipientSelectModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    /**
     * å…³é—­é€‰æ‹©æ”¶è´§äººå¯¹è¯æ¡† (å¸¦æœ‰åŠ¨ç”»æ•ˆæœ)
     */
    function closeRecipientSelectModal() {
        recipientSelectModal.style.opacity = '0';
        recipientSelectModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        // ç­‰å¾…åŠ¨ç”»ç»“æŸåå†éšè—å…ƒç´ 
        setTimeout(() => {
            recipientSelectModal.style.display = 'none';
        }, 300);
    }

    // --- äº‹ä»¶ç›‘å¬ ---
    selectRecipientBtn.addEventListener('click', async () => {
        recipientListContainer.innerHTML = '<p style="text-align:center; color:#888;">æ­£åœ¨åŠ è½½...</p>';
        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (contactsData && Array.isArray(contactsData.value) && contactsData.value.length > 0) {
                recipientListContainer.innerHTML = '';
                contactsData.value.forEach(contact => {
                    const ai = contact.ai;
                    const item = document.createElement('div');
                    item.className = 'invite-contact-item';
                    item.style.cursor = 'pointer';
                    item.dataset.recipient = JSON.stringify(ai);
                    item.innerHTML = `
                    <img src="${ai.avatar}" alt="avatar" class="invite-contact-avatar">
                    <span class="invite-contact-name">${ai.name}</span>
                `;
                    recipientListContainer.appendChild(item);
                });
            } else {
                recipientListContainer.innerHTML = '<p>æ²¡æœ‰å¯ç”¨çš„æ”¶è´§äºº</p>';
            }
        } catch (error) {
            console.error(error);
            recipientListContainer.innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥</p>';
        }

        // è°ƒç”¨æˆ‘ä»¬æ–°çš„ã€å¸¦åŠ¨ç”»çš„æ‰“å¼€å‡½æ•°
        openRecipientSelectModal();
    });

    // å…³é—­æŒ‰é’®è°ƒç”¨æ–°çš„å…³é—­å‡½æ•°
    if (recipientModalCloseBtn) {
    recipientModalCloseBtn.addEventListener('click', () => {
        window.DOMCleanupManager.clean('recipient-list-container');
         closeRecipientSelectModal;
    });
}

    // é€‰æ‹©æ”¶è´§äººåè°ƒç”¨æ–°çš„å…³é—­å‡½æ•°
    recipientListContainer.addEventListener('click', (event) => {
        const item = event.target.closest('.invite-contact-item');
        if (item) {
            currentRecipient = JSON.parse(item.dataset.recipient);
            recipientNameDisplay.textContent = currentRecipient.name;
            closeRecipientSelectModal(); // è°ƒç”¨æ–°çš„å…³é—­å‡½æ•°
        }
    });

    // === END: æ”¶è´§äººé€‰æ‹© JS (V2 - å·²ä¿®å¤å†»ç»“é—®é¢˜) ===
    // --- ç¡®è®¤è´­ä¹° ---
    confirmPurchaseBtn.addEventListener('click', async () => {

        if (shoppingCart.length === 0) {
            alert("è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼");
            return;
        }
        if (!currentRecipient) {
            alert("è¯·å…ˆé€‰æ‹©æ”¶è´§äººï¼");
            return;
        }

        const totalAmount = shoppingCart.reduce((sum, item) => sum + item.price, 0);
        const currentBalance = await getBalance();
        if (currentBalance < totalAmount) {
            alert(`ä½™é¢ä¸è¶³ï¼éœ€è¦ Â¥${totalAmount.toFixed(2)}ï¼Œå½“å‰åªæœ‰ Â¥${currentBalance.toFixed(2)}ã€‚`);
            return;
        }

        await logTransactionAndUpdateBalance({
            description: `åœ¨ä¸ƒè¢‹è´­ç‰©æ¶ˆè´¹`,
            amount: -totalAmount
        });

        const newOrder = {
            id: Date.now(),
            items: [...shoppingCart],
            totalAmount: totalAmount,
            recipient: currentRecipient,
            purchaseDate: new Date()
        };

        const ordersData = await dbHelper.loadData('settingsStore', 'myOrders');
        let allOrders = (ordersData && Array.isArray(ordersData.value)) ? ordersData.value : [];
        allOrders.unshift(newOrder);
        await dbHelper.saveData('settingsStore', 'myOrders', allOrders);

        shoppingCart = [];
        await saveCartToDB();

        alert(`è´­ä¹°æˆåŠŸï¼æ¶ˆè´¹äº† Â¥${totalAmount.toFixed(2)}ã€‚`);
        renderCart();
        renderOrders(allOrders);
        phoneFrame.classList.remove('show-cart');
        phoneFrame.classList.add('show-orders');
    });

    // --- è®¢å•æ¸²æŸ“ ---
    // ç”¨è¿™ä¸ªæ›´å¥å£®çš„æ–°ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ renderOrders å‡½æ•°

    async function renderOrders(orders) {
        ordersListContainer.innerHTML = '';

        // å¢åŠ ä¸€ä¸ªæ£€æŸ¥ï¼Œç¡®ä¿ orders æœ¬èº«æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°ç»„
        if (!orders || orders.length === 0) {
            ordersListContainer.innerHTML = '<p style="text-align:center; color:#888;">è¿˜æ²¡æœ‰ä»»ä½•è®¢å•</p>';
            return;
        }

        orders.forEach(order => {
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤åœ¨è¿™é‡Œ â–¼â–¼â–¼
            // åœ¨ä½¿ç”¨ .map() ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥ order.items æ˜¯å¦ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä½¿ç”¨ä¸€ä¸ªç©ºæ•°ç»„ä»£æ›¿
            const itemsToRender = Array.isArray(order.items) ? order.items : [];
            const itemsHtml = itemsToRender.map(item => `<li>${item.name} - Â¥${(item.price || 0).toFixed(2)}</li>`).join('');
            const totalAmountHtml = `Â¥${(order.totalAmount || 0).toFixed(2)}`;


            // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

            orderCard.innerHTML = `
            <button class="order-share-btn" data-order-id="${order.id}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_50_22)">
                    <path d="M4 5H6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 4V6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M11.5 4L11 6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18 5H20" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 4V6" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15 9L14 10" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18 13L20 12.5" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18 19H20" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 18V20" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 16.518L7.48196 10L3.09196 19.58C3.00703 19.766 2.98098 19.9735 3.01728 20.1747C3.05359 20.3759 3.15053 20.5613 3.29512 20.7058C3.4397 20.8504 3.62501 20.9474 3.82624 20.9837C4.02746 21.02 4.23497 20.9939 4.42096 20.909L14 16.519V16.518Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </g>
                    <defs><clipPath id="clip0_50_22"><rect width="24" height="24" fill="white"/></clipPath></defs>
                </svg>
            </button>
            <div class="order-details">
                <div class="order-title">è®¢å•å•†å“</div>
                <ul style="padding-left: 20px; margin: 5px 0 0; font-size: 15px;">${itemsHtml}</ul>
            </div>
            <div class="order-header">
                <div class="order-title">è®¢å•æ€»é¢</div>
                <div class="order-value">Â¥${(order.totalAmount || 0).toFixed(2)}</div>
            </div>
            <div class="order-recipient">
                <div class="order-title">æ”¶è´§äºº</div>
                <div class="order-value">${order.recipient ? order.recipient.name : 'æœªçŸ¥'}</div>
            </div>
            <div class="order-date">
                 <div class="order-title">ä¸‹å•æ—¶é—´</div>
                <div class="order-value">${new Date(order.purchaseDate).toLocaleString('zh-CN')}</div>
            </div>
        `;
            ordersListContainer.appendChild(orderCard);
        });
    }
    // === END: SHOPMALL è´­ç‰©æµç¨‹ JS (FUNCTIONS & EVENTS) ===

    // === START: è®¢å•åˆ†äº«åŠŸèƒ½ JS (V3 - æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œ) ===
    // â–¼â–¼â–¼ ä½¿ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬ï¼Œæ›¿æ¢æ—§çš„ ordersListContainer ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼
    ordersListContainer.addEventListener('click', async (event) => {
        const shareBtn = event.target.closest('.order-share-btn');
        if (!shareBtn) return;

        const orderId = parseInt(shareBtn.dataset.orderId, 10);

        try {
            const ordersData = await dbHelper.loadData('settingsStore', 'myOrders');
            const orderToShare = ordersData.value.find(o => o.id === orderId);
            if (!orderToShare) throw new Error("æ‰¾ä¸åˆ°è¯¥è®¢å•");

            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            const recipientContact = contactsData.value.find(c => c.ai.name === orderToShare.recipient.name);
            if (!recipientContact) throw new Error("æ‰¾ä¸åˆ°æ”¶ä»¶äººå¯¹åº”çš„èŠå¤©å¯¹è¯");

            // --- â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šç”ŸæˆåŒ…å«å“ç‰Œä¿¡æ¯çš„å•†å“æè¿° â–¼â–¼â–¼ ---
            const itemsText = orderToShare.items.map(item => {
                // å¦‚æœå•†å“æœ‰å“ç‰Œï¼Œå°±æ ¼å¼åŒ–ä¸º "å“ç‰Œ çš„ 'å•†å“å'"
                if (item.brand) {
                    return `${item.brand}çš„â€œ${item.name}â€`;
                }
                // å¦‚æœæ²¡æœ‰ï¼Œå°±åªæ˜¾ç¤ºå•†å“å
                return `â€œ${item.name}â€`;
            }).join('ï¼Œ'); // ç”¨ä¸­æ–‡é€—å·è¿æ¥ï¼Œæ›´è‡ªç„¶

            // æ›´æ–°å‘é€ç»™ AI çš„æç¤ºä¿¡æ¯
            const aiTriggerMessage = `(æˆ‘ç»™ä½ åˆ†äº«äº†ä¸€ä¸ªè®¢å•ï¼Œå•†å“æ˜¯${itemsText}ï¼Œè¯·æ ¹æ®ä½ çš„äººè®¾å’Œæˆ‘ä»¬çš„å…³ç³»å¯¹æ­¤ä½œå‡ºå›åº”ã€‚)`;
            // --- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² ---

            const messageText = `[ORDER_SHARE_CARD]${JSON.stringify(orderToShare)}`;
            const userMessage = {
                sender: 'user', text: messageText, timestamp: new Date(),
                uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
            };

            if (!Array.isArray(recipientContact.history)) recipientContact.history = [];
            recipientContact.history.push(userMessage);
            recipientContact.lastMessage = "åˆ†äº«äº†ä¸€ä¸ªè®¢å•";
            const allContacts = contactsData.value;
            const contactIndex = allContacts.findIndex(c => c.id === recipientContact.id);
            if (contactIndex > -1) {
                allContacts[contactIndex] = recipientContact;
                await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
            }

            phoneFrame.classList.add('show-messages');
            phoneFrame.classList.remove('show-cart');
            phoneFrame.classList.remove('show-orders');

            await openChatView(recipientContact.id);

            await callAI(aiTriggerMessage, recipientContact);

        } catch (error) {
            console.error("åˆ†äº«è®¢å•å¤±è´¥:", error);
            alert(`åˆ†äº«å¤±è´¥: ${error.message}`);
        }
    });

    // â–¼â–¼â–¼ START: åœ¨è¿™é‡Œç²˜è´´æ–°çš„æ‘¸é±¼Appäº¤äº’é€»è¾‘ â–¼â–¼â–¼

    // --- 1. å¯¼èˆªé€»è¾‘ï¼šè¿›å…¥å’Œé€€å‡ºApp ---

    // ç‚¹å‡»â€œæ‘¸é±¼â€Appå›¾æ ‡ï¼Œæ˜¾ç¤ºAppç•Œé¢
    slackingOffAppIcon.addEventListener('click', () => {
        phoneFrame.classList.add('show-slacking-off');
        renderGames();
    });

    // ç‚¹å‡»è¿”å›æŒ‰é’®ï¼Œå›åˆ°ä¸»å±å¹•
    slackingOffBackButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-slacking-off');
    });


    // --- 2. æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘ ---


    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„é’±åŒ…ç®¡ç†å‡½æ•° â–¼â–¼â–¼

    /**
     * è·å–å½“å‰ç”¨æˆ·ä½™é¢
     * @returns {Promise<number>} è¿”å›å½“å‰ä½™é¢ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›åˆå§‹å€¼100
     */
    async function getBalance() {
        const balanceData = await dbHelper.loadData('settingsStore', 'userBalance');
        // å¦‚æœæ²¡æœ‰ä½™é¢è®°å½•ï¼Œç»™äºˆ100çš„åˆå§‹èµ„é‡‘
        return balanceData ? balanceData.value : 100;
    }

    /**
     * æ›´æ–°ç”¨æˆ·ä½™é¢
     * @param {number} amount - è¦å¢åŠ ï¼ˆæ­£æ•°ï¼‰æˆ–å‡å°‘ï¼ˆè´Ÿæ•°ï¼‰çš„é‡‘é¢
     * @returns {Promise<number>} è¿”å›æ›´æ–°åçš„æ–°ä½™é¢
     */
    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ updateBalance å‡½æ•°


    /**
     * åˆ·æ–°â€œå‚¨è“„â€ç•Œé¢çš„ä½™é¢æ˜¾ç¤º
     */
    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ updateBalanceDisplay å‡½æ•°

    async function updateBalanceDisplay() {
        const currentBalance = await getBalance();
        if (balanceDisplay) {
            if (currentBalance >= 10000) {
                // å¦‚æœé‡‘é¢è¶…è¿‡1ä¸‡ï¼Œåˆ™æ ¼å¼åŒ–ä¸º 'x.xx W'
                const balanceInW = currentBalance / 10000;
                // ä½¿ç”¨ toFixed(2) ä¿ç•™ä¸¤ä½å°æ•°ï¼Œç„¶åç”¨ parseFloat å»æ‰æœ«å°¾å¤šä½™çš„0
                balanceDisplay.textContent = `Â¥ ${parseFloat(balanceInW.toFixed(2))} W`;
            } else {
                // å¦åˆ™ï¼Œä¿æŒåŸæ¥çš„ 'xx.xx' æ ¼å¼
                balanceDisplay.textContent = `Â¥ ${currentBalance.toFixed(2)}`;
            }
        }
        // æ§åˆ¶â€œç”³è¯·è§£é™¤â€æŒ‰é’®çš„å¯è§æ€§ (é€»è¾‘ä¿æŒä¸å˜)
        if (applyUnlockBtn) {
            if (currentBalance <= -200) {
                applyUnlockBtn.style.display = 'block';
            } else {
                applyUnlockBtn.style.display = 'none';
            }
        }
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ¸¸æˆæ•°æ®å’Œæ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼

    // 1. å®šä¹‰æ¸¸æˆæ•°æ®
    const gamesData = [
        {
            id: 'coin-flip',
            name: 'å¹¸è¿ç¡¬å¸',
            description: 'çŒœçŒœç¡¬å¸æ˜¯æ­£é¢è¿˜æ˜¯åé¢ï¼ŸçŒœå¯¹èµ¢Â¥50ï¼ŒçŒœé”™äºÂ¥20ã€‚',
            image: 'https://i.postimg.cc/q7BWsqYB/0728bde4133c361a0d86d02dc7f0c625.png',
            winChance: 0.5, // 50%çš„èƒœç‡
            reward: 50,
            penalty: -20
        },
        {
            id: 'number-guess',
            name: 'æ•°å­—å¤§å¸ˆ',
            description: 'ä»1-3ä¸­çŒœä¸€ä¸ªæ•°å­—ã€‚çŒœå¯¹èµ¢Â¥80ï¼ŒçŒœé”™äºÂ¥40ã€‚',
            image: 'https://i.postimg.cc/fLpFQKbk/26408f03e171688d69f0ac84c5f0bdc3.jpg',
            winChance: 0.33, // 33%çš„èƒœç‡
            reward: 80,
            penalty: -40
        },
        {
            id: 'go_to_work',
            name: 'ä¸Šç­æ¨¡æ‹Ÿ',
            description: 'ä½“éªŒæ‰“å·¥äººçš„æ‚²æ¬¢ç¦»åˆï¼Œä½ çš„è–ªæ°´å°†ç”±ä»Šæ—¥çš„è¿åŠ¿å†³å®šã€‚',
            image: 'https://i.postimg.cc/tJ6cqx1k/e40723f24112fcbfb5b593fab10e3b5c.png'
        },
        {
            id: 'lottery',
            name: 'ä¹°å½©ç¥¨',
            description: 'æä¸€æï¼Œå•è½¦å˜æ‘©æ‰˜ï¼èŠ±è´¹å°‘é‡å‚¨è“„ï¼Œèµ¢å–æœ€é«˜2000å…ƒå¤§å¥–ï¼',
            image: 'https://i.postimg.cc/8504rz8Y/bc4d45476e2902ff4bd22788d2119ae6.jpg'
        }
    ];
    const challengesData = [
        {
            id: 'investment_opportunity',
            name: 'æŠ•èµ„æœºé‡',
            description: 'ä¸€ä¸ªåƒè½½éš¾é€¢çš„æŠ•èµ„æœºä¼šæ‘†åœ¨çœ¼å‰ï¼Œé«˜é£é™©ä¹Ÿå¯èƒ½å¸¦æ¥é«˜å›æŠ¥ã€‚ä½ æ•¢èµŒä¸€æŠŠå—ï¼Ÿ',
            reward: 20000, // åŸºç¡€å¥–åŠ± 2w
            penalty: -2000, // å¤±è´¥æƒ©ç½š 2k
            scenario: 'â€œå¬ç€ï¼Œè¿™ä¸ªé¡¹ç›®æœ‰å·¨å¤§çš„æ½œåŠ›ï¼Œä½†å¸‚åœºæ³¢åŠ¨ä¹Ÿå¾ˆå¤§ã€‚ä¿å®ˆç‚¹è¿˜æ˜¯æ¿€è¿›ç‚¹ï¼Œä½ æ¥å†³å®šï¼â€',
            choices: [
                { text: 'ç¨³å¥æŠ•èµ„', successChance: 0.6 }, // 60% æˆåŠŸç‡
                { text: 'æ¿€è¿›ä¸€æŠŠ', successChance: 0.3 }  // 30% æˆåŠŸç‡ï¼Œä½†å¦‚æœæˆåŠŸï¼Œå¥–åŠ±ä¼šç¿»å€
            ]
        },
        {
            id: 'antique_auction',
            name: 'å¤è‘£æ‹å–ä¼š',
            description: 'ä¸€ä»¶çœ‹ä¼¼ä¸èµ·çœ¼çš„å¤è‘£ï¼ŒèƒŒåå¯èƒ½éšè—ç€å·¨å¤§çš„ä»·å€¼ã€‚ä½ çš„çœ¼å…‰èƒ½å¦è®©ä½ ä¸€å¤œæš´å¯Œï¼Ÿ',
            reward: 50000, // åŸºç¡€å¥–åŠ± 5w
            penalty: -5000, // å¤±è´¥æƒ©ç½š 5k
            scenario: 'â€œè¿™ä»¶è—å“ï¼Œæœ‰äººè¯´æ˜¯èµå“ï¼Œæœ‰äººè¯´æ˜¯ç»ä¸–çå®ã€‚åº•ä»·5000ï¼Œä½ è¦ä¸è¦ä¸¾ç‰Œï¼Ÿâ€',
            choices: [
                { text: 'è°¨æ…å‡ºä»·', successChance: 0.4 }, // 40% æˆåŠŸç‡
                { text: 'è±ªèµŒä¸€æ¬¡', successChance: 0.15 } // 15% æˆåŠŸç‡ï¼Œä½†å¦‚æœæˆåŠŸï¼Œå¥–åŠ±ä¼šç¿»å€
            ]
        },
        {
            id: 'tech_startup_pitch',
            name: 'é£æŠ•æ—¶åˆ»',
            description: 'ä¸€ä¸ªå……æ»¡æ¿€æƒ…çš„åˆ›ä¸šè€…æ­£åœ¨å‘ä½ å…œå”®æ¢¦æƒ³ï¼Œè¿™ä¼šæ˜¯ä¸‹ä¸€ä¸ªæ—¶ä»£å·¨å¤´ï¼Œè¿˜æ˜¯ä¸€ä¸ªç¾ä¸½çš„æ³¡æ²«ï¼Ÿ',
            reward: 200000, // åŸºç¡€å¥–åŠ± 20w
            penalty: -20000, // å¤±è´¥æƒ©ç½š 2w
            scenario: 'â€œæˆ‘ä»¬çš„æŠ€æœ¯å°†æ”¹å˜ä¸–ç•Œï¼ç°åœ¨åªéœ€è¦æœ€åä¸€ç¬”å¯åŠ¨èµ„é‡‘ã€‚è¿™æ˜¯é£é™©ï¼Œæ›´æ˜¯æœªæ¥çš„å…¥åœºåˆ¸ï¼â€',
            choices: [
                { text: 'æŠ•èµ„æ¢¦æƒ³', successChance: 0.1 }, // 10% æˆåŠŸç‡
                { text: 'æ‹’ç»ç”»é¥¼', successChance: 0.9 }  // 90% æˆåŠŸç‡ï¼Œä½†å¥–åŠ±æä½
            ]
        }
    ];

    // 2. æ¸²æŸ“æ‰€æœ‰æ¸¸æˆå¡ç‰‡åˆ°ç•Œé¢
    function renderGames() {
        if (!gamesGrid) return;
        gamesGrid.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
        gamesData.forEach(game => {
            const card = document.createElement('div');
            card.className = 'game-card';
            card.innerHTML = `
            <img src="${game.image}" alt="${game.name}">
            <div class="game-card-info">
                <h3>${game.name}</h3>
                <p>${game.description}</p>
                <button class="play-game-btn" data-game-id="${game.id}">å¼€å§‹ç©</button>
            </div>
        `;
            gamesGrid.appendChild(card);
        });
    }
    // â–²â–²â–² æ¸¸æˆæ•°æ®å’Œæ¸²æŸ“é€»è¾‘ç²˜è´´ç»“æŸ â–²â–²â–²
    // â–²â–²â–² é’±åŒ…ç®¡ç†å‡½æ•°ç²˜è´´ç»“æŸ â–²â–²â–²

    // â–²â–²â–² æ‘¸é±¼Appäº¤äº’é€»è¾‘ç²˜è´´ç»“æŸ â–²â–²â–²
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ¸¸æˆç‚¹å‡»å¤„ç†é€»è¾‘ â–¼â–¼â–¼
    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ gamesGrid.addEventListener

    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ gamesGrid.addEventListener

    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ gamesGrid.addEventListener

    gamesGrid.addEventListener('click', async (event) => {
        if (!event.target.classList.contains('play-game-btn')) return;

        const gameId = event.target.dataset.gameId;
        const game = gamesData.find(g => g.id === gameId);
        if (!game) return;

        const currentBalance = await getBalance();
        if (currentBalance <= -200) {
            openCreditModal(blacklistModal);
            return;
        }

        // æ ¹æ®æ¸¸æˆIDå†³å®šè¡Œä¸º
        if (gameId === 'coin-flip' || gameId === 'number-guess') {
            openGameModal(document.getElementById(`${gameId}-modal`));
        } else if (gameId === 'lottery') { // ã€æ–°å¢ã€‘å¤„ç†å½©ç¥¨æ¸¸æˆ
            openGameModal(document.getElementById('lottery-modal'));
        } else if (gameId === 'go_to_work') {
            const eventResult = workEvents[Math.floor(Math.random() * workEvents.length)];
            await logTransactionAndUpdateBalance({
                description: eventResult.text.split('ï¼Œ')[0],
                amount: eventResult.amount
            });
            let resultMessage = `ã€ä»Šæ—¥å·¥ä½œæ€»ç»“ã€‘\n\n${eventResult.text}\n\n`;
            if (eventResult.amount > 0) {
                resultMessage += `å‚¨è“„å¢åŠ : Â¥${eventResult.amount.toFixed(2)}`;
            } else if (eventResult.amount < 0) {
                resultMessage += `å‚¨è“„å‡å°‘: Â¥${Math.abs(eventResult.amount).toFixed(2)}`;
            } else {
                resultMessage += `å‚¨è“„æ— å˜åŒ–ã€‚`;
            }
            alert(resultMessage);
        }
    });

    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ numberGuessModal äº‹ä»¶ç›‘å¬å™¨
    numberGuessModal.addEventListener('click', async (event) => {
        const choiceBtn = event.target.closest('.game-choice-btn');
        if (!choiceBtn) return;

        const userChoice = parseInt(choiceBtn.dataset.choice, 10);
        const game = gamesData.find(g => g.id === 'number-guess');

        const computerChoice = Math.floor(Math.random() * 3) + 1;

        let resultMessage = `ä½ é€‰æ‹©äº† ${userChoice}ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${computerChoice}ã€‚\n\n`;
        let transactionAmount; // ç”¨äºè®°å½•æœ¬æ¬¡äº¤æ˜“é‡‘é¢

        if (userChoice === computerChoice) {
            transactionAmount = game.reward;
            resultMessage += `çŒœå¯¹äº†ï¼æ­å–œä½ èµ¢äº† Â¥${game.reward.toFixed(2)}ï¼`;
        } else {
            transactionAmount = game.penalty;
            resultMessage += `çœŸé—æ†¾ï¼ä½ è¾“äº† Â¥${Math.abs(game.penalty).toFixed(2)}ã€‚`;
        }

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šè°ƒç”¨æ–°çš„è®°è´¦å‡½æ•° â–¼â–¼â–¼
        await logTransactionAndUpdateBalance({ description: 'ç©æ•°å­—å¤§å¸ˆ', amount: transactionAmount });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        closeGameModals();
        setTimeout(() => alert(resultMessage), 310);
    });


    // ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬æ›¿æ¢æ—§çš„ coinFlipModal äº‹ä»¶ç›‘å¬å™¨
    coinFlipModal.addEventListener('click', async (event) => {
        const choiceBtn = event.target.closest('.game-choice-btn');
        if (!choiceBtn) return;

        const userChoice = choiceBtn.dataset.choice;
        const game = gamesData.find(g => g.id === 'coin-flip');

        const computerChoice = Math.random() < 0.5 ? 'heads' : 'tails';
        const computerChoiceText = computerChoice === 'heads' ? 'æ­£é¢' : 'åé¢';

        let resultMessage = `ä½ çŒœäº† ${userChoice === 'heads' ? 'æ­£é¢' : 'åé¢'}ï¼Œç»“æœæ˜¯ ${computerChoiceText}ã€‚\n\n`;
        let transactionAmount; // ç”¨äºè®°å½•æœ¬æ¬¡äº¤æ˜“é‡‘é¢

        if (userChoice === computerChoice) {
            transactionAmount = game.reward;
            resultMessage += `çŒœå¯¹äº†ï¼æ­å–œä½ èµ¢äº† Â¥${game.reward.toFixed(2)}ï¼`;
        } else {
            transactionAmount = game.penalty;
            resultMessage += `çœŸé—æ†¾ï¼ä½ è¾“äº† Â¥${Math.abs(game.penalty).toFixed(2)}ã€‚`;
        }

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šè°ƒç”¨æ–°çš„è®°è´¦å‡½æ•° â–¼â–¼â–¼
        await logTransactionAndUpdateBalance({ description: 'ç©å¹¸è¿ç¡¬å¸', amount: transactionAmount });
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        closeGameModals();
        setTimeout(() => alert(resultMessage), 310);
    });
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„æ¸¸æˆå¼¹çª—æ§åˆ¶å‡½æ•° â–¼â–¼â–¼

    /**
     * æ‰“å¼€ä¸€ä¸ªæŒ‡å®šçš„æ¸¸æˆå¼¹çª—
     * @param {HTMLElement} modalElement è¦æ‰“å¼€çš„å¼¹çª—å…ƒç´ 
     */
    function openGameModal(modalElement) {
        if (!modalElement) return;
        modalElement.style.display = 'flex';
        setTimeout(() => {
            modalElement.style.opacity = '1';
            modalElement.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    /**
     * å…³é—­æ‰€æœ‰æ¸¸æˆå¼¹çª—
     */
    function closeGameModals() {
        // æ‰¾åˆ°æ‰€æœ‰æ¸¸æˆå¼¹çª—å¹¶å…³é—­å®ƒä»¬
        document.querySelectorAll('#coin-flip-modal, #number-guess-modal, #lottery-modal, #blacklist-modal, #unlock-modal').forEach(modal => {
            modal.style.opacity = '0';
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        });
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ¸¸æˆæ ¸å¿ƒé€»è¾‘ä»£ç  â–¼â–¼â–¼

    // --- çŒœæ•°å­—æ¸¸æˆçš„æ ¸å¿ƒé€»è¾‘ ---
    numberGuessModal.addEventListener('click', async (event) => {
        const choiceBtn = event.target.closest('.game-choice-btn');
        if (!choiceBtn) return; // å¦‚æœç‚¹çš„ä¸æ˜¯æŒ‰é’®ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ

        const userChoice = parseInt(choiceBtn.dataset.choice, 10);
        const game = gamesData.find(g => g.id === 'number_guess');

        // ç”Ÿæˆä¸€ä¸ª1, 2, æˆ– 3çš„éšæœºæ•°ä½œä¸ºæ­£ç¡®ç­”æ¡ˆ
        const computerChoice = Math.floor(Math.random() * 3) + 1;

        let resultMessage = `ä½ é€‰æ‹©äº† ${userChoice}ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${computerChoice}ã€‚\n\n`;

        if (userChoice === computerChoice) {
            await updateBalance(game.reward);
            resultMessage += `çŒœå¯¹äº†ï¼æ­å–œä½ èµ¢äº† Â¥${game.reward.toFixed(2)}ï¼`;
        } else {
            await updateBalance(game.penalty);
            resultMessage += `çœŸé—æ†¾ï¼ä½ è¾“äº† Â¥${Math.abs(game.penalty).toFixed(2)}ã€‚`;
        }

        closeGameModals(); // å…ˆå…³é—­å¼¹çª—
        setTimeout(() => alert(resultMessage), 310); // ç¨ä½œå»¶è¿Ÿåæ˜¾ç¤ºç»“æœ
    });

    // --- æŠ›ç¡¬å¸æ¸¸æˆçš„æ ¸å¿ƒé€»è¾‘ ---
    coinFlipModal.addEventListener('click', async (event) => {
        const choiceBtn = event.target.closest('.game-choice-btn');
        if (!choiceBtn) return;

        const userChoice = choiceBtn.dataset.choice; // "heads" æˆ– "tails"
        const game = gamesData.find(g => g.id === 'coin_flip');

        // éšæœºç”Ÿæˆç¡¬å¸æ­£åé¢
        const computerChoice = Math.random() < 0.5 ? 'heads' : 'tails';
        const computerChoiceText = computerChoice === 'heads' ? 'æ­£é¢' : 'åé¢';

        let resultMessage = `ä½ çŒœäº† ${userChoice === 'heads' ? 'æ­£é¢' : 'åé¢'}ï¼Œç»“æœæ˜¯ ${computerChoiceText}ã€‚\n\n`;

        if (userChoice === computerChoice) {
            await updateBalance(game.reward);
            resultMessage += `çŒœå¯¹äº†ï¼æ­å–œä½ èµ¢äº† Â¥${game.reward.toFixed(2)}ï¼`;
        } else {
            await updateBalance(game.penalty);
            resultMessage += `çœŸé—æ†¾ï¼ä½ è¾“äº† Â¥${Math.abs(game.penalty).toFixed(2)}ã€‚`;
        }

        closeGameModals();
        setTimeout(() => alert(resultMessage), 310);
    });
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„ä¿¡ç”¨ç³»ç»Ÿå‡½æ•° â–¼â–¼â–¼

    /**
     * å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è§£é”ç ï¼Œåˆ™åˆ›å»ºå¹¶å­˜å…¥åˆå§‹è§£é”ç 
     */
    async function initializeUnlockCodes() {
        const codesData = await dbHelper.loadData('settingsStore', 'unlockCodes');
        if (!codesData) { // åªåœ¨å®Œå…¨æ²¡æœ‰è®°å½•æ—¶æ‰§è¡Œ
            const initialCodes = [
                'QIQI-LOVE-U-01', 'SLACK-OFF-KING', 'GAME-MASTER-77', 'CODE-BREAKER-X',
                'LUCKY-STAR-2024', 'FREEDOM-PASS-A', 'GET-RICH-QUICK', 'DEBT-CLEANER-PRO',
                'QIQI-BANK-VIP', 'THE-ONLY-WAY', 'RESET-MY-LIFE', 'GOLDEN-TICKET-7',
                'PHOENIX-DOWN-GG', 'ULTIMATE-CODE', 'SECRET-HANDSHAKE', 'BACK-TO-ZERO-00',
                'GAME-CHANGER-25', 'MASTER-KEY-007', 'NEW-BEGINNING', 'LAST-CHANCE-OK'
            ];
            const codesObject = {};
            initialCodes.forEach(code => {
                codesObject[code] = 5; // æ¯ä¸ªç å¯ä»¥ç”¨5æ¬¡
            });
            await dbHelper.saveData('settingsStore', 'unlockCodes', codesObject);
            console.log("è§£é”ç å·²åˆå§‹åŒ–ã€‚");
        }
    }

    /**
     * æ‰“å¼€æŒ‡å®šçš„ä¿¡ç”¨ç³»ç»Ÿå¼¹çª—
     * @param {HTMLElement} modalElement
     */
    function openCreditModal(modalElement) {
        if (!modalElement) return;
        modalElement.style.display = 'flex';
        setTimeout(() => {
            modalElement.style.opacity = '1';
            modalElement.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    /**
     * å…³é—­æ‰€æœ‰ä¿¡ç”¨ç³»ç»Ÿå¼¹çª—
     */
    function closeCreditModals() {
        document.querySelectorAll('#blacklist-modal, #unlock-modal').forEach(modal => {
            modal.style.opacity = '0';
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        });
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„ä¿¡ç”¨ç³»ç»Ÿäº‹ä»¶ç›‘å¬å™¨ â–¼â–¼â–¼

    // â€œæ‹‰é»‘å¼¹çª—â€é‡Œçš„æŒ‰é’®ï¼Œç‚¹å‡»åè·³è½¬åˆ°å‚¨è“„æ ‡ç­¾é¡µ
    goToSavingsBtn.addEventListener('click', () => {
        closeCreditModals();
        // æ¨¡æ‹Ÿç‚¹å‡»â€œå‚¨è“„â€æ ‡ç­¾é¡µ
        document.getElementById('slacking-off-tab-savings').click();
    });

    // ç‚¹å‡»â€œç”³è¯·è§£é™¤â€æŒ‰é’®ï¼Œæ‰“å¼€è§£é”ç è¾“å…¥å¼¹çª—
    applyUnlockBtn.addEventListener('click', () => {
        openCreditModal(unlockModal);
    });

    // å…³é—­è§£é”ç å¼¹çª—
    unlockModalCloseBtn.addEventListener('click', closeCreditModals);

    // â€œç¡®è®¤è§£é”â€æŒ‰é’®çš„æ ¸å¿ƒé€»è¾‘
    confirmUnlockBtn.addEventListener('click', async () => {
        const inputCode = unlockCodeInput.value.trim();
        if (!inputCode) {
            alert('è¯·è¾“å…¥è§£é”ç ï¼');
            return;
        }

        try {
            const codesData = await dbHelper.loadData('settingsStore', 'unlockCodes');
            let codesObject = codesData.value;

            // æ£€æŸ¥è§£é”ç æ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨
            if (codesObject && codesObject[inputCode] && codesObject[inputCode] > 0) {
                // è§£é”æˆåŠŸ
                codesObject[inputCode]--; // ä½¿ç”¨æ¬¡æ•°å‡1

                // å°†æ›´æ–°åçš„è§£é”ç æ•°æ®å­˜å›æ•°æ®åº“
                await dbHelper.saveData('settingsStore', 'unlockCodes', codesObject);

                // å°†ä½™é¢é‡ç½®ä¸º0
                await dbHelper.saveData('settingsStore', 'userBalance', 0);

                // åˆ·æ–°æ˜¾ç¤º
                await updateBalanceDisplay();

                alert(`è§£é”æˆåŠŸï¼\n\nè¯¥è§£é”ç å‰©ä½™ä½¿ç”¨æ¬¡æ•°ï¼š${codesObject[inputCode]}\n\næ‚¨çš„è´¦æˆ·å·²æ¢å¤æ­£å¸¸ï¼Œå‚¨è“„å·²é‡ç½®ä¸º Â¥0.00ã€‚`);
                closeCreditModals();
                unlockCodeInput.value = '';

            } else if (codesObject && codesObject[inputCode] === 0) {
                // è§£é”ç å·²ç”¨å®Œ
                alert('è§£é”å¤±è´¥ï¼è¯¥è§£é”ç çš„ä½¿ç”¨æ¬¡æ•°å·²ç”¨å°½ã€‚');
            } else {
                // è§£é”ç æ— æ•ˆ
                alert('è§£é”å¤±è´¥ï¼æ— æ•ˆçš„è§£é”ç ã€‚');
            }

        } catch (error) {
            console.error("è§£é”è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:", error);
            alert("æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        }
    });


    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ä¸Šç­æ¨¡æ‹Ÿçš„éšæœºäº‹ä»¶æ•°æ® â–¼â–¼â–¼

    const workEvents = [
        { text: "ä¸šç»©çªå‡ºï¼Œæ‹¿ä¸‹å¤§å•ï¼Œè€æ¿é«˜å…´åœ°å‘äº†å¥–é‡‘ï¼", amount: 200, type: 'reward' },
        { text: "ä¼šè®®ä¸Šæå‡ºç»å¦™ç‚¹å­ï¼Œé¡¹ç›®å¥–é‡‘åˆ°æ‰‹ï¼", amount: 150, type: 'reward' },
        { text: "å¸®åŒäº‹è§£å†³äº†æŠ€æœ¯éš¾é¢˜ï¼Œæ”¶è·äº†ä¸‹åˆèŒ¶åŸºé‡‘ã€‚", amount: 50, type: 'reward' },
        { text: "å…¬å¸å¹´ä¼šæŠ½ä¸­äºŒç­‰å¥–ï¼", amount: 300, type: 'reward' },
        { text: "å†™çš„æŠ¥å‘Šè¢«è¯„ä¸ºæœ€ä½³èŒƒæœ¬ï¼Œè·å¾—äº†ç»©æ•ˆå¥–åŠ±ã€‚", amount: 120, type: 'reward' },
        { text: "è¿Ÿåˆ°5åˆ†é’Ÿï¼Œæ­£å¥½æ’è§è€æ¿ï¼Œè¢«æ‰£äº†å·¥èµ„ã€‚", amount: -50, type: 'penalty' },
        { text: "ä¸Šç­æ‘¸é±¼åˆ·æ‰‹æœºè¢«å‘ç°ï¼Œæœ¬æœˆç»©æ•ˆå‡åŠã€‚", amount: -100, type: 'penalty' },
        { text: "æäº¤çš„æ–¹æ¡ˆå‡ºç°é‡å¤§ç–æ¼ï¼Œéœ€è¦è‡ªè´¹è¯·å®¢èµ”ç½ªã€‚", amount: -80, type: 'penalty' },
        { text: "åœ¨èŒ¶æ°´é—´è¯´è€æ¿åè¯ï¼Œè¢«è·¯è¿‡çš„è€æ¿å¬è§äº†...", amount: -150, type: 'penalty' },
        { text: "ç”µè„‘çªç„¶è“å±ï¼Œé‡è¦æ–‡ä»¶æ²¡ä¿å­˜ï¼Œé¡¹ç›®å»¶è¯¯è¢«ç½šæ¬¾ã€‚", amount: -180, type: 'penalty' },
        { text: "é€šå‹¤è·¯ä¸Šæ¡åˆ°é’±åŒ…ï¼Œäº¤ç»™è­¦å¯Ÿå”å”åå‘ç°é‡Œé¢æœ‰æ„Ÿè°¢è´¹ã€‚", amount: 100, type: 'reward' },
        { text: "ä¸‹ç­åä¹°å½©ç¥¨ï¼Œç«Ÿç„¶ä¸­äº†æœ«ç­‰å¥–ã€‚", amount: 10, type: 'reward' },
        { text: "åœ¨å…¬å¸æ¥¼ä¸‹é‡åˆ°æ€»è£ï¼Œæ€»è£çœ‹ä½ éª¨éª¼æƒŠå¥‡ï¼Œç»™äº†ä½ ä¸€ä¸ªçº¢åŒ…ã€‚", amount: 88, type: 'reward' },
        { text: "åˆä¼‘æ—¶åšæ¢¦ï¼Œæ¢¦åˆ°ä¸€ç»„ç¥ç§˜æ•°å­—ï¼Œé†’æ¥åå‘ç°æ˜¯è‡ªå·±çš„é“¶è¡Œå¡ä½™é¢ã€‚", amount: 0, type: 'neutral' },
        { text: "ä¸€æ•´å¤©éƒ½åœ¨å¼€ä¼šï¼Œç²¾ç¥ææƒšï¼Œæ— åŠŸæ— è¿‡ã€‚", amount: 0, type: 'neutral' },
        { text: "åç”µæ¢¯æ—¶é‡åˆ°è¶…è½½ï¼Œä½ ä¸»åŠ¨èµ°äº†å‡ºæ¥ï¼Œç»“æœç”µæ¢¯åäº†ï¼Œä½ å› æ­¤èº²è¿‡ä¸€åŠ«å¹¶è·å¾—äº†è§ä¹‰å‹‡ä¸ºå¥–ã€‚", amount: 20, type: 'reward' },
        { text: "ç‚¹å¤–å–æ—¶ç”¨é”™äº†ä¼˜æƒ åˆ¸ï¼Œå¤šèŠ±äº†ä¸€ç¬”é’±ã€‚", amount: -15, type: 'penalty' },
        { text: "å‚åŠ å…¬å¸ç»„ç»‡çš„å›¢å»ºï¼Œå› ä¸ºå¤ªç¦»è°±è€Œç²¾ç¥å—åˆ›ï¼Œè·å¾—äº†ç²¾ç¥æŸå¤±è´¹ã€‚", amount: 30, type: 'reward' },
        { text: "æŠŠå…¬å¸æ‰“å°æœºå¼„åäº†ï¼Œéœ€è¦èµ”å¿ç»´ä¿®è´¹ã€‚", amount: -200, type: 'penalty' },
        { text: "æ¶¨å·¥èµ„äº†", amount: 8000, type: 'penalty' },
        { text: "ä¸»å¯¼çš„æ ¸å¿ƒé¡¹ç›®è¶…é¢å®ŒæˆKPIï¼Œè·å¾—å¹´åº¦ç‰¹åˆ«å¥–é‡‘", amount: 150000, type: 'reward' },
        { text: "æˆåŠŸä¸ºå…¬å¸å¼•è¿›æˆ˜ç•¥æŠ•èµ„ï¼Œè·å¾—é¡¹ç›®åˆ†çº¢", amount: 200000, type: 'reward' },
        { text: "ç ”å‘çš„ä¸“åˆ©æŠ€æœ¯è¢«é«˜ä»·æ”¶è´­ï¼Œè·å¾—å·¨é¢å¥–é‡‘", amount: 180000, type: 'reward' },
        { text: "å‘ç°é‡å¤§å®‰å…¨æ¼æ´å¹¶åŠæ—¶è¡¥æ•‘ï¼Œé¿å…å…¬å¸å·¨é¢æŸå¤±è·å¥–åŠ±", amount: 50000, type: 'reward' },
        { text: "å¹´åº¦ä¼˜ç§€ä¼˜ç§€ä¸šåŠ¡æ‹“å±•åˆ°æµ·å¤–å¸‚åœºï¼Œé¦–å¹´è¥æ”¶è¾¾æ ‡è·ç‰¹åˆ«å¥–", amount: 80000, type: 'reward' },
        { text: "å› é‡å¤§å†³ç­–å¤±è¯¯å¯¼è‡´å…¬å¸é¡¹ç›®äºæŸï¼Œæ‰¿æ‹…èµ”å¿è´£ä»»", amount: -30000, type: 'penalty' },
        { text: "æ³„éœ²å…¬å¸æ ¸å¿ƒæœºå¯†ï¼Œè¢«è¿½ç©¶è´£ä»»ç½šæ¬¾", amount: -50000, type: 'penalty' },
        { text: "å¸¦é¢†çš„äº§å“å‡ºç°ä¸¥é‡è´¨é‡é—®é¢˜ï¼Œéœ€æ‰¿æ‹…éƒ¨åˆ†èµ”å¿é‡‘", amount: -25000, type: 'penalty' },
        { text: "æˆåŠŸç«æ ‡å›½å®¶çº§é‡ç‚¹é¡¹ç›®ï¼Œè·å¾—å›¢é˜Ÿæ¿€åŠ±å¥–é‡‘", amount: 120000, type: 'reward' },
        { text: "è¿è§„æ“ä½œé€ æˆç”Ÿäº§äº‹æ•…ï¼Œè¢«æ‰£é™¤å®‰å…¨ä¿è¯é‡‘", amount: -40000, type: 'penalty' },
        { text: "å‘ç°å…¬å¸è´¢åŠ¡ç³»ç»Ÿçš„ä¸€ä¸ªBUGï¼Œé¿å…äº†å·¨å¤§æŸå¤±ï¼Œè·å¾—ç‰¹æ®Šè´¡çŒ®å¥–ï¼", amount: 500, type: 'reward' },
        { text: "å¼€å‘çš„æ ¸å¿ƒäº§å“è·å¾—è¡Œä¸šå¤§å¥–ï¼Œå…¬å¸ç»™äºˆåˆ›æ–°å¥–åŠ±", amount: 120000, type: 'reward' },
        { text: "æˆåŠŸç­¾ä¸‹å¹´åº¦æœ€å¤§å®¢æˆ·ï¼Œè·å¾—é”€å”®å† å†›ç‰¹åˆ«å¥–é‡‘", amount: 180000, type: 'reward' },
        { text: "æå‡ºçš„æˆæœ¬ä¼˜åŒ–æ–¹æ¡ˆä¸ºå…¬å¸èŠ‚çœå·¨é¢å¼€æ”¯ï¼Œè·ä¸“é¡¹å¥–åŠ±", amount: 80000, type: 'reward' },
        { text: "å¸¦é¢†å›¢é˜Ÿæ”»å…‹æŠ€æœ¯éš¾å…³ï¼Œé¡¹ç›®æå‰ä¸Šçº¿è·é¢å¤–å¥–é‡‘", amount: 60000, type: 'reward' },
        { text: "å¹´åº¦ç»©æ•ˆè€ƒæ ¸å…¨å…¬å¸ç¬¬ä¸€ï¼Œè·å¾—æ€»è£ç‰¹åˆ«å˜‰å¥–", amount: 150000, type: 'reward' },
        { text: "ä¸»å¯¼çš„å¹¶è´­æ¡ˆåœ†æ»¡å®Œæˆï¼Œè·å¾—æˆ˜ç•¥è´¡çŒ®å¥–é‡‘", amount: 200000, type: 'reward' },
        { text: "å®¢æˆ·æ»¡æ„åº¦è¯„åˆ†è¿ç»­12ä¸ªæœˆç¬¬ä¸€ï¼Œè·æœåŠ¡ä¹‹æ˜Ÿå¥–é‡‘", amount: 30000, type: 'reward' },
        { text: "ä¸ºå…¬å¸åŸ¹å…»å‡º3åéƒ¨é—¨ä¸»ç®¡ï¼Œè·äººæ‰å‘å±•å¥–åŠ±", amount: 50000, type: 'reward' },
        { text: "æ’°å†™çš„è¡Œä¸šæŠ¥å‘Šè¢«å›½å®¶çº§æœŸåˆŠæ”¶å½•ï¼Œå…¬å¸ç»™äºˆç§‘ç ”å¥–åŠ±", amount: 40000, type: 'reward' },
        { text: "åœ¨å›½é™…è¡Œä¸šå³°ä¼šä¸Šä»£è¡¨å…¬å¸å‘è¨€ï¼Œæå‡å“ç‰Œå½±å“åŠ›è·å¥–åŠ±", amount: 70000, type: 'reward' }
    ];
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´å…¨æ–°çš„ç»Ÿä¸€è®°è´¦å‡½æ•° â–¼â–¼â–¼

    /**
     * è®°å½•ä¸€ç¬”äº¤æ˜“ï¼Œå¹¶æ›´æ–°ä½™é¢
     * è¿™æ˜¯æ–°çš„æ ¸å¿ƒå‡½æ•°ï¼Œæ‰€æœ‰é‡‘é’±å˜åŠ¨éƒ½å¿…é¡»è°ƒç”¨å®ƒ
     * @param {object} transaction - äº¤æ˜“å¯¹è±¡ï¼ŒåŒ…å« { description: string, amount: number }
     * @returns {Promise<number>} è¿”å›æ›´æ–°åçš„æ–°ä½™é¢
     */
    async function logTransactionAndUpdateBalance(transaction) {
        // 1. æ·»åŠ æ—¶é—´æˆ³
        transaction.timestamp = new Date();

        // 2. ä»æ•°æ®åº“è¯»å–æ—§çš„äº¤æ˜“è®°å½•
        const historyData = await dbHelper.loadData('settingsStore', 'transactionHistory');
        let history = (historyData && Array.isArray(historyData.value)) ? historyData.value : [];

        // 3. å°†æ–°è®°å½•æ·»åŠ åˆ°æœ€å‰é¢
        history.unshift(transaction);

        // 4. å°†æ›´æ–°åçš„è®°å½•å­˜å›æ•°æ®åº“
        await dbHelper.saveData('settingsStore', 'transactionHistory', history);

        // 5. æ›´æ–°ä½™é¢
        let currentBalance = await getBalance();
        const newBalance = currentBalance + transaction.amount;

        if (newBalance <= -200) {
            openCreditModal(blacklistModal);
            await dbHelper.saveData('settingsStore', 'userBalance', -200);
        } else {
            await dbHelper.saveData('settingsStore', 'userBalance', newBalance);
        }

        await updateBalanceDisplay();
        return newBalance;
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„æ˜ç»†é¡µé¢å¯¼èˆªå’Œæ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼

    // --- å¯¼èˆªé€»è¾‘ ---
    transactionHistoryCard.addEventListener('click', () => {
        renderTransactions(); // æ‰“å¼€é¡µé¢å‰å…ˆæ¸²æŸ“å†…å®¹
        phoneFrame.classList.add('show-transactions');
    });

    transactionsBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean('transactions-list-container');
        phoneFrame.classList.remove('show-transactions');
    });

    // --- æ¸²æŸ“é€»è¾‘ ---
    async function renderTransactions() {
        const historyData = await dbHelper.loadData('settingsStore', 'transactionHistory');
        let history = (historyData && Array.isArray(historyData.value)) ? historyData.value : [];

        transactionsListContainer.innerHTML = ''; // æ¸…ç©ºæ—§åˆ—è¡¨

        if (history.length === 0) {
            transactionsListContainer.innerHTML = '<p style="text-align:center; color:#888;">æš‚æ— æ”¶æ”¯è®°å½•</p>';
            return;
        }

        history.forEach(tx => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'transaction-item';

            const amountClass = tx.amount >= 0 ? 'income' : 'expense';
            const amountPrefix = tx.amount >= 0 ? '+' : '';

            itemDiv.innerHTML = `
            <div class="transaction-info">
                <div class="description">${tx.description}</div>
                <div class="timestamp">${new Date(tx.timestamp).toLocaleString('zh-CN')}</div>
            </div>
            <div class="transaction-amount ${amountClass}">
                ${amountPrefix}${tx.amount.toFixed(2)}
            </div>
        `;
            transactionsListContainer.appendChild(itemDiv);
        });
    }
    // --- 2. å¯¼èˆªé€»è¾‘ï¼šè¿›å…¥å’Œé€€å‡ºApp ---

    // ç‚¹å‡»â€œGACHAï¼â€Appå›¾æ ‡ï¼Œæ˜¾ç¤ºAppç•Œé¢
    gachaAppIcon.addEventListener('click', () => {
        phoneFrame.classList.add('show-gacha');
    });

    // ç‚¹å‡»è¿”å›æŒ‰é’®ï¼Œå›åˆ°ä¸»å±å¹•
    gachaBackButton.addEventListener('click', () => {
        // âœ… æ¸…ç†Gachaå¸–å­
        window.DOMCleanupManager.clean('gacha-posts-container');
        
        // æ¸…ç†å…¨å±€å˜é‡
        if (typeof currentGachaIdentity !== 'undefined') {
            currentGachaIdentity = null;
        }
        
        phoneFrame.classList.remove('show-gacha');
    });

    // --- 3. åº•éƒ¨æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘ ---


    // â–¼â–¼â–¼ START: GACHA App èº«ä»½é€‰æ‹©é€»è¾‘ â–¼â–¼â–¼

    // 1. ç‚¹å‡»å³ä¸Šè§’å¤´åƒï¼Œæ‰“å¼€èº«ä»½é€‰æ‹©å¯¹è¯æ¡†
    gachaAvatarButton.addEventListener('click', () => {
        // æˆ‘ä»¬ç›´æ¥è°ƒç”¨ä¸ƒè¢‹Appå·²ç»å†™å¥½çš„å‡½æ•°æ¥æ‰“å¼€é€‰æ‹©æ¡†
        openShopperSelectModal();
    });

    // 2. ç›‘å¬èº«ä»½é€‰æ‹©å¯¹è¯æ¡†çš„ç‚¹å‡»äº‹ä»¶ (äº‹ä»¶å§”æ‰˜)
    // æˆ‘ä»¬éœ€è¦æ‰¾åˆ° #shopper-list-containerï¼Œå› ä¸ºå®ƒåœ¨ä¸ƒè¢‹Appçš„JSé‡Œå·²ç»å®šä¹‰äº†
    const gachaShopperListContainer = document.getElementById('shopper-list-container');

    gachaShopperListContainer.addEventListener('click', async (event) => {
        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨GACHA Appç•Œé¢æ“ä½œï¼Œé¿å…ä¸ä¸ƒè¢‹Appçš„åŠŸèƒ½å†²çª
        if (!gachaScreen.classList.contains('active')) return;

        const item = event.target.closest('.invite-contact-item');
        if (item) {
            const contactId = parseInt(item.dataset.contactId, 10);

            // ä»æ•°æ®åº“æ‰¾åˆ°å®Œæ•´çš„è”ç³»äººä¿¡æ¯
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            const selectedContact = contactsData.value.find(c => c.id === contactId);

            if (selectedContact) {
                // å…³é”®ä¸€æ­¥ï¼šæ›´æ–°å½“å‰GACHAèº«ä»½
                currentGachaIdentity = selectedContact;

                // æ›´æ–°å³ä¸Šè§’å¤´åƒçš„æ˜¾ç¤º
                gachaAvatarImg.src = selectedContact.user.avatar; // é»˜è®¤ä½¿ç”¨ç”¨æˆ·çš„å¤´åƒä½œä¸ºèº«ä»½å¤´åƒ

                console.log(`GACHA èº«ä»½å·²åˆ‡æ¢ä¸º: ${currentGachaIdentity.user.name}`);

                // å…³é—­å¯¹è¯æ¡†
                closeShopperSelectModal();
            }
        }
    });

    // 3. è¿›å…¥ GACHA App æ—¶ï¼Œè‡ªåŠ¨è®¾ç½®ä¸€ä¸ªé»˜è®¤èº«ä»½
    gachaAppIcon.addEventListener('click', async () => {
        phoneFrame.classList.add('show-gacha');

        // å¦‚æœè¿˜æ²¡æœ‰è®¾ç½®è¿‡èº«ä»½ï¼Œå°±è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªè”ç³»äººä½œä¸ºé»˜è®¤èº«ä»½
        if (!currentGachaIdentity) {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (contactsData && Array.isArray(contactsData.value) && contactsData.value.length > 0) {
                currentGachaIdentity = contactsData.value[0];
                gachaAvatarImg.src = currentGachaIdentity.user.avatar;
                console.log(`GACHA é»˜è®¤èº«ä»½å·²è®¾ç½®ä¸º: ${currentGachaIdentity.user.name}`);
            }
        }
        renderAllPosts();
    });

    // â–¼â–¼â–¼ START: ç»Ÿä¸€çš„èº«ä»½é€‰æ‹©é€»è¾‘ (ä¿®æ­£ç‰ˆ) â–¼â–¼â–¼

    // 1. è·å–èº«ä»½é€‰æ‹©åˆ—è¡¨çš„å®¹å™¨
    const identityListContainer = document.getElementById('shopper-list-container');

    // 2. ä¸ºè¯¥å®¹å™¨ç»‘å®šå”¯ä¸€çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    identityListContainer.addEventListener('click', async (event) => {
        const item = event.target.closest('.invite-contact-item');
        if (!item) return; // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯åˆ—è¡¨é¡¹ï¼Œåˆ™é€€å‡º

        const contactId = parseInt(item.dataset.contactId, 10);
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        const selectedContact = contactsData.value.find(c => c.id === contactId);

        if (selectedContact) {
            // å…³é”®ä¿®æ­£ï¼šæ£€æŸ¥ phoneFrame çš„ class æ¥åˆ¤æ–­å½“å‰æ˜¯å“ªä¸ªApp
            if (phoneFrame.classList.contains('show-gacha')) {
                // å¦‚æœæ˜¯ GACHA Appï¼Œåˆ™æ›´æ–° GACHA çš„èº«ä»½
                currentGachaIdentity = selectedContact;
                gachaAvatarImg.src = selectedContact.user.avatar;
                console.log(`GACHA èº«ä»½å·²åˆ‡æ¢ä¸º: ${currentGachaIdentity.user.name}`);

            } else if (phoneFrame.classList.contains('show-shop')) {
                // å¦‚æœæ˜¯ä¸ƒè¢‹ Appï¼Œåˆ™æ›´æ–°ä¸ƒè¢‹çš„èº«ä»½ (è°ƒç”¨å®ƒåŸæ¥çš„å‡½æ•°)
                updateShopper(selectedContact);
            }

            // æ— è®ºå“ªä¸ªAppï¼Œæ“ä½œå®Œæˆåéƒ½å…³é—­å¯¹è¯æ¡†
            closeShopperSelectModal();
        }
    });// â–¼â–¼â–¼ START: GACHA App å‘å¸–é€»è¾‘ â–¼â–¼â–¼

    function openSharePostModal() {
        postModal.style.display = 'flex';
        setTimeout(() => {
            postModal.style.opacity = '1';
            postModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    // å…³é—­å¯¹è¯æ¡†çš„å‡½æ•°ä¿æŒä¸å˜ (å¦‚æœæ‚¨ä¹‹å‰åˆ é™¤äº†ï¼Œå¯ä»¥æŠŠè¿™ä¸ªä¹ŸåŠ å›å»)
    function closePostModal() {
        postModal.style.opacity = '0';
        postModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            postModal.style.display = 'none';
            postTextInput.value = '';
            postImageDescInput.value = '';
        }, 300);
    }

    // ç¡®ä¿å…³é—­æŒ‰é’®ä»ç„¶æœ‰æ•ˆ
    postModalCloseBtn.addEventListener('click', closePostModal);
    // 2. ä¸ºç›¸å…³æŒ‰é’®ç»‘å®šäº‹ä»¶
    newPostBtn.addEventListener('click', () => {
        // 1. æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©èº«ä»½
        if (!currentGachaIdentity) {
            alert('è¯·å…ˆç‚¹å‡»å³ä¸Šè§’å¤´åƒé€‰æ‹©ä¸€ä¸ªå‘å¸–èº«ä»½ï¼');
            return;
        }

        // 2. æ£€æŸ¥å½“å‰æ˜¯å“ªä¸ªæ ‡ç­¾é¡µå¤„äºæ¿€æ´»çŠ¶æ€
        const isShareTabActive = document.getElementById('share-content-panel').classList.contains('active');
        const isForumTabActive = document.getElementById('forum-content-panel').classList.contains('active');

        if (isShareTabActive) {
            // å¦‚æœæ˜¯ SHARE æ ‡ç­¾é¡µï¼Œæ‰§è¡ŒåŸæ¥çš„æ‰“å¼€åˆ†äº«å¯¹è¯æ¡†çš„é€»è¾‘
            openSharePostModal();
        } else if (isForumTabActive) {
            // å¦‚æœæ˜¯ FORUM æ ‡ç­¾é¡µï¼Œæ‰§è¡Œæ–°çš„é€»è¾‘
            // ç›®å‰æˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªæç¤ºæ¥å ä½ï¼Œæ‚¨å¯ä»¥åç»­åœ¨è¿™é‡Œå®ç°æ‰“å¼€è®ºå›å‘å¸–çª—å£çš„åŠŸèƒ½
            alert('è®ºå›å‘å¸–åŠŸèƒ½å¾…å®ç°ï¼');
        }
    });
    postModalCloseBtn.addEventListener('click', closePostModal);

    // 3. æ ¸å¿ƒï¼šç‚¹å‡»â€œåˆ†äº«â€æŒ‰é’®çš„é€»è¾‘
    confirmPostBtn.addEventListener('click', async () => {
        const postText = postTextInput.value.trim();
        const imageDesc = postImageDescInput.value.trim();

        if (!postText && !imageDesc) {
            alert('åˆ†äº«å†…å®¹å’Œå›¾ç‰‡æè¿°ä¸èƒ½éƒ½ä¸ºç©ºï¼');
            return;
        }

        // åˆ›å»ºä¸€ä¸ªå¸–å­å¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯
        const newPost = {
            id: Date.now(), // ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
            authorId: currentGachaIdentity.id, // è®°å½•ä½œè€…çš„ID
            authorName: currentGachaIdentity.user.name, // ä½¿ç”¨å½“å‰èº«ä»½çš„ç”¨æˆ·å
            authorAvatar: currentGachaIdentity.user.avatar, // ä½¿ç”¨å½“å‰èº«ä»½çš„å¤´åƒ
            timestamp: new Date().toISOString(),
            content: postText,
            imageDescription: imageDesc,
            likes: [], // åˆå§‹åŒ–ä¸€ä¸ªç©ºæ•°ç»„æ¥å­˜æ”¾ç‚¹èµçš„äºº
            comments: [],
            visibleTo: [],
        };

        // 4. ä¿å­˜å¸–å­åˆ°æ•°æ®åº“
        try {
            const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
            let allPosts = (postsData && Array.isArray(postsData.value)) ? postsData.value : [];
            allPosts.unshift(newPost); // unshift å°†æ–°å¸–å­åŠ åˆ°æ•°ç»„æœ€å‰é¢
            await dbHelper.saveData('gachaPosts', 'allPosts', allPosts);

            // 5. åˆ·æ–°å¸–å­åˆ—è¡¨å¹¶å…³é—­å¯¹è¯æ¡†
            renderAllPosts();
            closePostModal();

        } catch (error) {
            console.error("ä¿å­˜å¸–å­å¤±è´¥:", error);
            alert("å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è®¾ç½®ã€‚");
        }
    });

    // â–¼â–¼â–¼ START: GACHA App å¸–å­æ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼

    /**
     * ä¸»å‡½æ•°ï¼šä»æ•°æ®åº“åŠ è½½æ‰€æœ‰å¸–å­å¹¶æ¸²æŸ“åˆ°é¡µé¢ä¸Š
     */
    async function renderAllPosts() {
        const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
        const allPosts = (postsData && Array.isArray(postsData.value)) ? postsData.value : [];
        postsContainer.innerHTML = '';
        if (allPosts.length === 0) {
            postsContainer.innerHTML = '<p style="text-align:center; color:#888; margin-top: 50px;">è¿˜æ²¡æœ‰ä»»ä½•åˆ†äº«ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</p>';
            return;
        }
        allPosts.forEach(post => {
            const postElement = createPostElement(post);
            postsContainer.appendChild(postElement);
        });
    }
    /**
     * è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å•ä¸ªå¸–å­å¯¹è±¡ï¼Œåˆ›å»ºå¹¶è¿”å›å…¶å¯¹åº”çš„ HTML å…ƒç´ 
     * @param {object} post - åŒ…å«å¸–å­ä¿¡æ¯çš„å¯¹è±¡
     * @returns {HTMLElement} - ä»£è¡¨è¯¥å¸–å­çš„ div å…ƒç´ 
     */
    /**
     * è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å•ä¸ªå¸–å­å¯¹è±¡ï¼Œåˆ›å»ºå¹¶è¿”å›å…¶å¯¹åº”çš„ HTML å…ƒç´  (V2 - æœ€ç»ˆç‰ˆ)
     * @param {object} post - åŒ…å«å¸–å­ä¿¡æ¯çš„å¯¹è±¡
     * @returns {HTMLElement} - ä»£è¡¨è¯¥å¸–å­çš„ div å…ƒç´ 
     */
    // ç”¨è¿™ä¸ªã€åŒ…å«å®Œæ•´SVGã€‘çš„æ–°ç‰ˆæœ¬ï¼Œæ›¿æ¢æ‰ä½ åŸæ¥çš„ createPostElement å‡½æ•°
    function createPostElement(post) {
        const postCard = document.createElement('div');
        postCard.className = 'gp-card';
        postCard.dataset.postId = post.id;
        const postDate = new Date(post.timestamp);
        const timeString = `${postDate.getFullYear()}å¹´${postDate.getMonth() + 1}æœˆ${postDate.getDate()}æ—¥ æ˜ŸæœŸ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][postDate.getDay()]}`;
        const isLikedByCurrentUser = currentGachaIdentity ? post.likes.some(liker => liker.id === currentGachaIdentity.id) : false;
        const likedClass = isLikedByCurrentUser ? 'liked' : '';
        const postContentHTML = post.content.replace(/\n/g, '<br>');
        const imageDescHTML = post.imageDescription ? `<p class="gp-image-desc">[å›¾ç‰‡æè¿°]: ${post.imageDescription}</p>` : '';
        const isPrivate = Array.isArray(post.visibleTo) && post.visibleTo.length > 0;
        const deleteButtonHTML = `
        <button class="gp-delete-post-btn gp-action-button" title="åˆ é™¤å¸–å­">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 6L18 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>`;
        postCard.innerHTML = `
        <div class="gp-header">
            <div class="gp-header-content">
                <div class="gp-user-info">
                    <div class="gp-avatar" style="background-image: url('${post.authorAvatar}');"></div>
                    <div><div class="gp-user-name">${post.authorName}</div><div class="gp-user-handle">ä¸ªæ€§ç­¾å</div></div>
                </div>
                ${deleteButtonHTML} 
                <button class="gp-visibility-btn ${isPrivate ? 'private' : ''}" data-post-id="${post.id}">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </button>
                <div class="gp-post-date">${timeString}</div>
            </div>
        </div>
        <div class="gp-divider"></div>
        <div class="gp-post-content">
            <div class="gp-post-text"><p>${postContentHTML}</p>${imageDescHTML}</div>
            <div class="gp-action-buttons">
                <button class="gp-like-btn gp-action-button ${likedClass}"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.125 3.75C4.02246 3.75 1.5 6.30176 1.5 9.375C1.5 10.4473 1.98633 11.376 2.4375 12.0469C2.88867 12.7178 3.35156 13.1484 3.35156 13.1484L11.4609 21.2812L12 21.8203L12.5391 21.2812L20.6484 13.1484C20.6484 13.1484 22.5 11.5166 22.5 9.375C22.5 6.30176 19.9775 3.75 16.875 3.75C14.2998 3.75 12.6416 5.2998 12 5.95312C11.3584 5.2998 9.7002 3.75 7.125 3.75ZM7.125 5.25C9.36621 5.25 11.4375 7.42969 11.4375 7.42969L12 8.0625L12.5625 7.42969C12.5625 7.42969 14.6338 5.25 16.875 5.25C19.1572 5.25 21 7.12207 21 9.375C21 10.5322 19.5938 12.0938 19.5938 12.0938L12 19.6875L4.40625 12.0938C4.40625 12.0938 4.04297 11.7451 3.67969 11.2031C3.31641 10.6611 3 9.95508 3 9.375C3 7.12207 4.84277 5.25 7.125 5.25Z" fill="#808080" fill-opacity="0.55"/></svg></button>
                <button class="gp-comment-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.25 4.5V19.5H9.43945L12 22.0605L14.5605 19.5H21.75V4.5H2.25ZM3.75 6H20.25V18H13.9395L12 19.9395L10.0605 18H3.75V6ZM6.75 8.25V9.75H17.25V8.25H6.75ZM6.75 11.25V12.75H17.25V11.25H6.75ZM6.75 14.25V15.75H14.25V14.25H6.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>
                <button class="gp-favorite-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3.75L11.7656 3.96094L3.21094 12.6094L2.69531 13.125L3.21094 13.6641L10.3359 20.7891L10.875 21.3047L11.3906 20.7891L20.0391 12.2344L20.25 12V3.75H12ZM12.6328 5.25H18.75V11.3672L10.875 19.1953L4.80469 13.125L12.6328 5.25ZM16.5 6.75C16.0869 6.75 15.75 7.08691 15.75 7.5C15.75 7.91309 16.0869 8.25 16.5 8.25C16.9131 8.25 17.25 7.91309 17.25 7.5C17.25 7.08691 16.9131 6.75 16.5 6.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>
                <button class="gp-summon-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.25 4.5V10.5H6.47607L9 14.9312V20.25H15V14.25H10.3374L8.20312 10.5H8.25V8.25H15.75V10.5H21.75V4.5H15.75V6.75H8.25V4.5H2.25ZM3.75 6H6.75V9H3.75V6ZM17.25 6H20.25V9H17.25V6ZM10.8135 15.75H13.5V18.75H10.5V15.9287L10.8135 15.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>
            </div>
        </div>
        <div class="gp-comment-section" style="display: none;">
            <div class="gp-comment-input-area"><div class="gp-comment-input-wrapper"><div class="gp-comment-avatar" style="background-image: url('${currentGachaIdentity ? currentGachaIdentity.user.avatar : ''}');"></div><input type="text" class="gp-comment-input" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></div></div>
            <div class="gp-comment-list"></div>
        </div>
    `;
        if (post.comments && post.comments.length > 0) {
            const commentList = postCard.querySelector('.gp-comment-list');
            post.comments.forEach(comment => {
                const commentElement = createCommentElement(comment);
                commentList.appendChild(commentElement);
            });
        }
        return postCard;
    }



    // â–²â–²â–² END: GACHA Post ç»Ÿä¸€ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ (V9 ä¿®å¤ç‰ˆ) â–²â–²â–²
    postsContainer.addEventListener('keydown', async (event) => {
        const input = event.target;
        if (event.key === 'Enter' && (input.classList.contains('gp-comment-input') || input.classList.contains('gp-reply-input'))) {
            event.preventDefault();
            const text = input.value.trim();
            if (!text || !currentGachaIdentity) return;
            const postCard = input.closest('.gp-card');
            const postId = parseInt(postCard.dataset.postId);
            const replyTo = input.classList.contains('gp-reply-input') ? input.dataset.replyTo : null;
            const newComment = await addUserComment(postId, text, replyTo);
            if (newComment) {
                const commentList = postCard.querySelector('.gp-comment-list');
                const newCommentElement = createCommentElement(newComment);
                commentList.appendChild(newCommentElement);
                input.value = '';
                commentList.scrollTop = commentList.scrollHeight;
                if (replyTo) {
                    // Case A: å¦‚æœæ˜¯å›å¤ (replyToæœ‰å€¼)ï¼Œè§¦å‘è¢«å›å¤è€…
                    await triggerAiCommentReply(postId, replyTo, text);
                } else {
                    // Case B: å¦‚æœæ˜¯æ–°è¯„è®º (replyToä¸ºnull)ï¼Œæ£€æŸ¥å¸–å­ä½œè€…æ˜¯ä¸æ˜¯AI
                    const authorName = postCard.querySelector('.gp-user-name').textContent;
                    // è°ƒç”¨åŒä¸€ä¸ªè§¦å‘å‡½æ•°ï¼Œåªä¸è¿‡ç›®æ ‡æ˜¯è¢«è¯„è®ºçš„å¸–å­ä½œè€…
                    await triggerAiCommentReply(postId, authorName, text);
                }
            }
        }
    });

    /**
     * è¾…åŠ©å‡½æ•°ï¼šå¤„ç†ç‚¹èµ/å–æ¶ˆç‚¹èµ
     * @param {number} postId - è¢«æ“ä½œçš„å¸–å­ID
     */
    async function toggleLike(postId) {
        if (!currentGachaIdentity) { alert('è¯·å…ˆé€‰æ‹©èº«ä»½ï¼'); return; }
        const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
        let allPosts = postsData.value;
        const post = allPosts.find(p => p.id === postId);
        if (post) {
            const likerIndex = post.likes.findIndex(liker => liker.id === currentGachaIdentity.id);
            if (likerIndex > -1) {
                post.likes.splice(likerIndex, 1);
            } else {
                post.likes.push({ id: currentGachaIdentity.id, name: currentGachaIdentity.user.name });
            }
            await dbHelper.saveData('gachaPosts', 'allPosts', allPosts);
        }
    }
    // â–¼â–¼â–¼ START: addComment å’Œ likeCommentById å‡½æ•° (V11 AIèº«ä»½ä¿®å¤ç‰ˆ) â–¼â–¼â–¼

    /**
     * æ·»åŠ è¯„è®ºå‡½æ•°
     * @param {number} postId - å¸–å­ID
     * @param {string} text - è¯„è®ºå†…å®¹
     * @param {string|null} replyTo - å›å¤çš„ç”¨æˆ·å
     * @param {object} authorContact - ã€æ–°å¢ã€‘å‘è¡¨è¯„è®ºçš„ä½œè€…ä¿¡æ¯å¯¹è±¡
     */
    async function addComment(postId, text, replyTo = null, authorContact = null) {
        const author = authorContact || currentGachaIdentity;
        if (!author) {
            console.error("æ— æ³•ç¡®å®šè¯„è®ºä½œè€…èº«ä»½ï¼");
            return null;
        }
        const commentText = replyTo ? `@${replyTo} ${text}` : text;
        const newComment = {
            id: Date.now(),
            authorId: author.id,
            authorName: author.ai ? author.ai.name : author.user.name,
            authorAvatar: author.ai ? author.ai.avatar : author.user.avatar,
            text: commentText,
            timestamp: new Date().toISOString(),
            likes: [] // æ–°è¯„è®ºç‚¹èµæ•°ä¸ºç©º
        };
        const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
        let allPosts = postsData.value;
        const post = allPosts.find(p => p.id === postId);
        if (post) {
            if (!post.comments) post.comments = [];
            post.comments.push(newComment);
            await dbHelper.saveData('gachaPosts', 'allPosts', allPosts);
        }
        return newComment;
    }





    function showReplyInput(button) {
        const existingReplyInputs = document.querySelectorAll('.gp-reply-input-area');
        existingReplyInputs.forEach(input => input.remove());
        const commentItem = button.closest('.gp-comment-item');
        const username = commentItem.querySelector('.gp-comment-username').textContent;
        const commentContent = commentItem.querySelector('.gp-comment-content');
        const replyInputArea = document.createElement('div');
        replyInputArea.className = 'gp-reply-input-area';
        replyInputArea.innerHTML = `<div class="gp-comment-avatar" style="width: 24px; height: 24px; background-image: url('${currentGachaIdentity.user.avatar}');"></div><input type="text" class="gp-reply-input" placeholder="å›å¤ ${username}..." data-reply-to="${username}">`;
        commentContent.appendChild(replyInputArea);
        const replyInput = replyInputArea.querySelector('.gp-reply-input');
        replyInput.focus();
        replyInput.addEventListener('blur', () => setTimeout(() => {
            if (!replyInput.matches(':focus')) replyInputArea.remove();
        }, 150));
    }
    function applyDarkMode(isEnabled) {
        phoneFrame.classList.toggle('dark-mode', isEnabled);
    }

    // --- è¾…åŠ©å‡½æ•° ---

    /**
     * ã€æ–°å¢ã€‘è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å•ä¸ªè¯„è®ºå¯¹è±¡ï¼Œåˆ›å»ºå¹¶è¿”å›å…¶å¯¹åº”çš„ HTML å…ƒç´ 
     * @param {object} comment - åŒ…å«è¯„è®ºä¿¡æ¯çš„å¯¹è±¡
     * @returns {HTMLElement} - ä»£è¡¨è¯¥è¯„è®ºçš„ div å…ƒç´ 
     */
    // â–¼â–¼â–¼ START: createCommentElement å‡½æ•° (V12 - å¸¦ç‚¹èµæ˜¾ç¤º) â–¼â–¼â–¼
    /**
     * ã€å·²æ›´æ–°ã€‘è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å•ä¸ªè¯„è®ºå¯¹è±¡ï¼Œåˆ›å»ºå¹¶è¿”å›å…¶å¯¹åº”çš„ HTML å…ƒç´ 
     * @param {object} comment - åŒ…å«è¯„è®ºä¿¡æ¯çš„å¯¹è±¡
     * @returns {HTMLElement} - ä»£è¡¨è¯¥è¯„è®ºçš„ div å…ƒç´ 
     */
    function createCommentElement(comment) {
        const commentElement = document.createElement('div');
        commentElement.className = 'gp-comment-item';
        commentElement.dataset.commentId = comment.id;
        const commentDate = new Date(comment.timestamp);
        const commentTimeString = `${commentDate.getMonth() + 1}-${commentDate.getDate()} ${commentDate.getHours()}:${String(commentDate.getMinutes()).padStart(2, '0')}`;
        const styledText = comment.text.replace(/(@\S+)/g, '<span class="gp-reply-mention">$1</span>');
        let likesHtml = '';
        if (comment.likes && comment.likes.length > 0) {
            const likerNames = comment.likes.map(liker => liker.name).join(', ');
            likesHtml = `
            <div class="gp-comment-likes">
                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                <span>${likerNames} è§‰å¾—å¾ˆèµ</span>
            </div>
        `;
        }
        const deleteCommentButtonHTML = `
        <button class="gp-delete-comment-btn gp-action-button" title="åˆ é™¤è¯„è®º">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 6L18 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>`;
        commentElement.innerHTML = `
        <div class="gp-comment-avatar" style="background-image: url('${comment.authorAvatar}');"></div>
        <div class="gp-comment-content">
            <div class="gp-comment-header">
                <span class="gp-comment-username">${comment.authorName}</span>
                <span class="gp-comment-time">${commentTimeString}</span>
            </div>
            <div class="gp-comment-text">${styledText}</div>
            <div class="gp-comment-actions">
                <button class="gp-reply-btn">å›å¤</button>
                ${deleteCommentButtonHTML}
            </div>
            ${likesHtml}
        </div>
    `;
        return commentElement;
    }
    // â–²â–²â–² END: createCommentElement å‡½æ•° (V12 - å¸¦ç‚¹èµæ˜¾ç¤º) â–²â–²â–²


    async function toggleLike(postId) {
        const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
        let allPosts = postsData.value;
        const post = allPosts.find(p => p.id === postId);

        if (post) {
            const likerIndex = post.likes.findIndex(liker => liker.id === currentGachaIdentity.id);
            if (likerIndex > -1) {
                post.likes.splice(likerIndex, 1);
            } else {
                post.likes.push({ id: currentGachaIdentity.id, name: currentGachaIdentity.user.name });
            }
            await dbHelper.saveData('gachaPosts', 'allPosts', allPosts);
        }
    }
    async function openVisibilityModal(postId) {
        currentPostIdForVisibility = postId;
        worldbookVisibilityList.innerHTML = '<p>æ­£åœ¨åŠ è½½ä¸–ç•Œä¹¦...</p>';

        try {
            // ä»æ•°æ®åº“åŠ è½½å¸–å­å’Œä¸–ç•Œä¹¦çš„æ•°æ®
            const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
            const post = postsData.value.find(p => p.id === postId);
            const worldbooksData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            const allWorldbooks = (worldbooksData && Array.isArray(worldbooksData.value)) ? worldbooksData.value : [];

            if (!post) throw new Error("æ‰¾ä¸åˆ°å¸–å­");

            const selectedIds = new Set(post.visibleTo || []);
            worldbookVisibilityList.innerHTML = '';

            if (allWorldbooks.length === 0) {
                worldbookVisibilityList.innerHTML = '<p style="color: #888;">æš‚æ— ä¸–ç•Œä¹¦å¯é€‰</p>';
            } else {
                // ä¸ºæ¯ä¸ªä¸–ç•Œä¹¦åˆ›å»ºä¸€ä¸ªå¸¦å¤é€‰æ¡†çš„åˆ—è¡¨é¡¹
                allWorldbooks.forEach(book => {
                    const isChecked = selectedIds.has(book.id);
                    const item = document.createElement('div');
                    item.className = 'visibility-item';
                    item.innerHTML = `
                    <input type="checkbox" id="wb-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}>
                    <label for="wb-${book.id}">${book.name}</label>
                `;
                    worldbookVisibilityList.appendChild(item);
                });
            }

            // æ˜¾ç¤ºModal
            visibilityModal.style.display = 'flex';
            setTimeout(() => { visibilityModal.style.opacity = '1'; }, 10);

        } catch (error) {
            console.error("æ‰“å¼€å¯è§æ€§è®¾ç½®å¤±è´¥:", error);
            alert("åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
        }
    }

    // 3. å…³é—­å¯¹è¯æ¡†çš„å‡½æ•°
    function closeVisibilityModal() {
        visibilityModal.style.opacity = '0';
        setTimeout(() => {
            visibilityModal.style.display = 'none';
            currentPostIdForVisibility = null;
        }, 300);
    }

    // 4. ä¸ºâ€œä¿å­˜â€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    saveVisibilityBtn.addEventListener('click', async () => {
        if (!currentPostIdForVisibility) return;

        // æ”¶é›†æ‰€æœ‰è¢«é€‰ä¸­çš„ä¸–ç•Œä¹¦ID
        const selectedIds = [];
        worldbookVisibilityList.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            selectedIds.push(parseInt(checkbox.value));
        });

        try {
            const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
            let allPosts = postsData.value;
            const postIndex = allPosts.findIndex(p => p.id === currentPostIdForVisibility);

            if (postIndex > -1) {
                allPosts[postIndex].visibleTo = selectedIds; // æ›´æ–°å¯è§èŒƒå›´
                await dbHelper.saveData('gachaPosts', 'allPosts', allPosts); // ä¿å­˜å›æ•°æ®åº“

                closeVisibilityModal();
                renderAllPosts(); // åˆ·æ–°å¸–å­åˆ—è¡¨ä»¥æ›´æ–°å›¾æ ‡çŠ¶æ€
                alert('å¯è§èŒƒå›´å·²æ›´æ–°ï¼');
            } else {
                throw new Error("ä¿å­˜æ—¶æ‰¾ä¸åˆ°å¸–å­");
            }
        } catch (error) {
            console.error("ä¿å­˜å¯è§èŒƒå›´å¤±è´¥:", error);
            alert("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
        }
    });

    // 5. ç»‘å®šå…³é—­äº‹ä»¶
    if (visibilityModalCloseBtn) {
    visibilityModalCloseBtn.addEventListener('click', () => {
        window.DOMCleanupManager.clean('worldbook-visibility-list');
       closeVisibilityModal;
    });
}


    /**
     * AIç‚¹èµè¯„è®ºçš„è¾…åŠ©å‡½æ•°
     * @param {number} postId - å¸–å­ID
     * @param {number} commentId - è¯„è®ºID
     * @param {number} likerId - ã€æ–°å¢ã€‘ç‚¹èµè€…çš„ID
     */
    async function likeCommentById(postId, commentId, likerId) {
        if (!likerId) { console.error("ç‚¹èµå¤±è´¥ï¼šæœªæä¾›ç‚¹èµè€…IDã€‚"); return; }
        const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
        let allPosts = postsData.value;
        const post = allPosts.find(p => p.id === postId);
        if (!post) return;
        const comment = post.comments.find(c => c.id === commentId);
        if (!comment) return;
        const likerIdentity = await getContactById(likerId);
        if (!likerIdentity) return;
        if (!Array.isArray(comment.likes)) { comment.likes = []; }
        const likerIndex = comment.likes.findIndex(liker => liker.id === likerIdentity.id);
        if (likerIndex === -1) {
            comment.likes.push({ id: likerIdentity.id, name: likerIdentity.ai.name });
            await dbHelper.saveData('gachaPosts', 'allPosts', allPosts);
        }
    }

    // â–¼â–¼â–¼ START: ã€æ–°å¢ã€‘æ ¹æ®IDè·å–è”ç³»äººçš„è¾…åŠ©å‡½æ•° â–¼â–¼â–¼

    /**
     * æ ¹æ®è”ç³»äººIDä»æ•°æ®åº“ä¸­è·å–å®Œæ•´çš„è”ç³»äººå¯¹è±¡
     * @param {number} contactId - è¦æŸ¥æ‰¾çš„è”ç³»äººID
     * @returns {Promise<object|null>} - è¿”å›æ‰¾åˆ°çš„è”ç³»äººå¯¹è±¡ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è¿”å›null
     */
    async function getContactById(contactId) {
        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (contactsData && Array.isArray(contactsData.value)) {
                return contactsData.value.find(c => c.id === contactId);
            }
            return null;
        } catch (error) {
            console.error("é€šè¿‡IDè·å–è”ç³»äººå¤±è´¥:", error);
            return null;
        }
    }
    // --- 2. æ‰“å¼€å’Œå…³é—­â€œé€‰æ‹©å¬å”¤AIâ€å¯¹è¯æ¡†çš„å‡½æ•° ---
    function openSummonAiModal(postId) {
        currentPostIdForSummoning = postId;
        summonAiListContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #888;">æ­£åœ¨åŠ è½½AIè§’è‰²åˆ—è¡¨...</p>';
        dbHelper.loadData('messageContacts', 'allContacts').then(contactsData => {
            if (contactsData && Array.isArray(contactsData.value) && contactsData.value.length > 0) {
                summonAiListContainer.innerHTML = '';
                contactsData.value.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'invite-contact-item';
                    item.style.cursor = 'pointer';
                    item.dataset.contactId = contact.id;
                    item.innerHTML = `<img src="${contact.ai.avatar}" alt="avatar" class="invite-contact-avatar"><span class="invite-contact-name">${contact.ai.name}</span>`;
                    summonAiListContainer.appendChild(item);
                });
            } else { /* ... */ }
        });
        summonAiModal.style.display = 'flex';
        setTimeout(() => { summonAiModal.style.opacity = '1'; }, 10);
    }


    function closeSummonAiModal() {
        summonAiModal.style.opacity = '0';
        setTimeout(() => {
            summonAiModal.style.display = 'none';
            currentPostIdForSummoning = null;
        }, 300);
    }
    // --- 3. æ ¸å¿ƒæ‰§è¡Œå‡½æ•°ï¼šå½“ç”¨æˆ·é€‰æ‹©äº†è¦å¬å”¤çš„AIåï¼Œè§¦å‘æ­¤å‡½æ•° ---
    async function executeSummon(postId, contactToSummonId) {
        try {
            const postData = await dbHelper.loadData('gachaPosts', 'allPosts');
            const post = postData.value.find(p => p.id === postId);
            if (!post) throw new Error("æ‰¾ä¸åˆ°å¸–å­ã€‚");

            const contactToSummon = await getContactById(contactToSummonId);
            if (!contactToSummon) {
                throw new Error("æ— æ³•åŠ è½½è¢«å¬å”¤çš„AIè§’è‰²ä¿¡æ¯ï¼Œæ“ä½œå·²å–æ¶ˆã€‚");
            }

            alert(`${contactToSummon.ai.name} å·²è¢«å¬å”¤ï¼Œæ­£åœ¨æŸ¥çœ‹åŠ¨æ€...`);

            let context = `[åŠ¨æ€å‘å¸ƒè€…]:\n${post.authorName}\n\n[åŠ¨æ€å†…å®¹]:\n${post.content || '(æ— æ–‡å­—å†…å®¹)'}\n`;
            if (post.imageDescription) { context += `[å›¾ç‰‡æè¿°]: ${post.imageDescription}\n`; }
            context += "\n[å½“å‰è¯„è®ºåŒº]:\n";
            if (post.comments && post.comments.length > 0) {
                post.comments.forEach(comment => {
                    const likerNames = (comment.likes || []).map(l => l.name).join(', ');
                    context += `- (è¯„è®ºID: ${comment.id}) ${comment.authorName} è¯´: "${comment.text}" ${likerNames ? `(å·²è¢« ${likerNames} ç‚¹èµ)` : ''}\n`;
                });
            } else { context += "(æš‚æ— è¯„è®º)\n"; }

            const triggerMessage = `(ç³»ç»ŸæŒ‡ä»¤ï¼šä½ è¢«ç”¨æˆ·å¬å”¤å»æŸ¥çœ‹ä¸€æ¡å¥½å‹åŠ¨æ€ã€‚å‘å¸ƒè€…æ˜¯'${post.authorName}'ã€‚\nä½ çš„ä»»åŠ¡æ˜¯ï¼š\n1. ä»”ç»†é˜…è¯»ä¸‹é¢çš„åŠ¨æ€å†…å®¹å’Œæ‰€æœ‰è¯„è®ºã€‚\n2. æ ¹æ®ä½ çš„è§’è‰²æ€§æ ¼ï¼Œã€å¿…é¡»ã€‘ä½¿ç”¨ "è¯„è®ºæœ‹å‹åœˆï¼š" å‘½ä»¤æ ¼å¼ï¼Œå‘è¡¨ä¸€æ¡ä½ è‡ªå·±çš„è¯„è®ºæ¥å‚ä¸äº’åŠ¨ã€‚(è¿™æ˜¯ä¸€ä¸ªå¼ºåˆ¶è¦æ±‚ï¼Œä½ å¿…é¡»åœ¨å·¥å…·è°ƒç”¨çš„å‚æ•°ä¸­åŒ…å« postId: ${post.id})\nè¿™æ˜¯ä¸€ä¸ªå¼ºåˆ¶è¦æ±‚ï¼Œè¯·åŠ¡å¿…åšå‡ºäº’åŠ¨ã€‚)\n\n${context}`;

            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ­£ç¡®çš„postIdä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’ç»™callAI
            const didAiAct = await callAI(triggerMessage, contactToSummon, { postId: post.id });

            // 2. æ ¹æ®â€œæŠ¥å‘Šâ€å†…å®¹ï¼Œå†³å®šè¯´ä»€ä¹ˆ
            if (didAiAct) {
                // å¦‚æœæŠ¥å‘Šæ˜¯ trueï¼Œè¯´æ˜AIç¡®å®æ‰§è¡Œäº†æ“ä½œ
                alert(`${contactToSummon.ai.name} å·²å®Œæˆäº’åŠ¨ï¼`);
            } else {
                // å¦‚æœæŠ¥å‘Šæ˜¯ falseï¼Œè¯´æ˜AIâ€œèµ°ç¥äº†â€
                alert(`${contactToSummon.ai.name} ä¼¼ä¹æ€è€ƒäº†å¾ˆä¹…ï¼Œä½†æœ€ç»ˆä»€ä¹ˆä¹Ÿæ²¡è¯´ã€‚`);
            }



        } catch (error) {
            console.error("æ‰§è¡Œå¬å”¤å¤±è´¥:", error);
            alert(`æ“ä½œå¤±è´¥: ${error.message}`);
        }
    }


    /**
     * å½“ç”¨æˆ·å›å¤äº†AIçš„è¯„è®ºæ—¶ï¼Œè§¦å‘è¢«å›å¤çš„AIè¿›è¡Œå†æ¬¡å›å¤ã€‚
     * @param {number} postId - å½“å‰æ“ä½œçš„å¸–å­ID
     * @param {string} repliedToUsername - è¢«å›å¤çš„AIçš„ç”¨æˆ·å
     * @param {string} userReplyText - ç”¨æˆ·å‘é€çš„å›å¤å†…å®¹
     */
    /**
    * å½“ç”¨æˆ·å›å¤äº†AIçš„è¯„è®ºæ—¶ï¼Œè§¦å‘è¢«å›å¤çš„AIè¿›è¡Œå†æ¬¡å›å¤ã€‚
    * @param {number} postId - å½“å‰æ“ä½œçš„å¸–å­ID
    * @param {string} repliedToUsername - è¢«å›å¤çš„AIçš„ç”¨æˆ·å
    * @param {string} userReplyText - ç”¨æˆ·å‘é€çš„å›å¤å†…å®¹
    */
    async function triggerAiCommentReply(postId, repliedToUsername, userReplyText) {
        console.log(`å°è¯•è§¦å‘ ${repliedToUsername} æ¥å›å¤...`);

        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (!contactsData || !Array.isArray(contactsData.value)) return;

            const aiContact = contactsData.value.find(c => c.ai.name === repliedToUsername);

            if (!aiContact) {
                console.log(`${repliedToUsername} ä¸æ˜¯ä¸€ä¸ªå¯è§¦å‘çš„AIè§’è‰²ã€‚`);
                return;
            }

            const replierName = currentGachaIdentity.user.name;

            const triggerMessage = `(ç³»ç»ŸæŒ‡ä»¤ï¼š'${replierName}' åˆšåˆšåœ¨ä¸€æ¡åŠ¨æ€ä¸‹å›å¤äº†ä½ çš„è¯„è®ºã€‚
è¿™æ˜¯TAçš„å›å¤å†…å®¹ï¼š â€œ${userReplyText}â€
è¯·æ ¹æ®ä½ çš„è§’è‰²æ€§æ ¼å’ŒèŠå¤©è®°å½•ä»¥åŠå¸–å­å†…å®¹ï¼Œä½¿ç”¨ "è¯„è®ºæœ‹å‹åœˆï¼š" å‘½ä»¤æ ¼å¼åœ¨åŒä¸€ä¸ªå¸–å­ä¸‹ï¼ˆå¸–å­ID: ${postId}ï¼‰å‘è¡¨ä¸€æ¡æ–°çš„å…¬å¼€å›å¤ã€‚)`;

            console.log(`å‡†å¤‡å‘ ${aiContact.ai.name} å‘é€æŒ‡ä»¤:`, triggerMessage);

            // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ‚¨çš„åå­—ä½œä¸º replyToUsername ä¼ é€’è¿‡å» ---
            await callAI(triggerMessage, aiContact, {
                postId: postId,
                replyToUsername: replierName // æ–°å¢ï¼šå‘Šè¯‰AIå®ƒåº”è¯¥@è°
            });

        } catch (error) {
            console.error("è§¦å‘AIå›å¤å¤±è´¥:", error);
        }
    }

    // â–²â–²â–² END: ã€å·²æ›´æ–°ã€‘è§¦å‘AIå›å¤è¯„è®ºçš„å‡½æ•° (V17 - ä¼ é€’å›å¤ç›®æ ‡) â–²â–²â–²
    // --- 4. ä¸ºæ–°å¯¹è¯æ¡†ç»‘å®šäº‹ä»¶ ---
    summonAiModalCloseBtn.addEventListener('click', closeSummonAiModal);

    // å¬å”¤AIå¼¹çª—
if (summonAiModalCloseBtn) {
    summonAiModalCloseBtn.addEventListener('click', () => {
        window.DOMCleanupManager.clean('summon-ai-list-container');
        closeSummonAiModal;
    });
}



    summonAiListContainer.addEventListener('click', (event) => {
        const item = event.target.closest('.invite-contact-item');
        if (item) {
            const contactId = parseInt(item.dataset.contactId);
            if (currentPostIdForSummoning && contactId) {
                closeSummonAiModal();
                executeSummon(currentPostIdForSummoning, contactId);
            }
        }
    });

    function applyDarkMode(isEnabled) {
        phoneFrame.classList.toggle('dark-mode', isEnabled);
    }
    // â–¼â–¼â–¼ START: ã€æ–°å¢ã€‘ä¸“ç”¨äºç”¨æˆ·å‘è¡¨è¯„è®ºçš„å‡½æ•° (V15 ä¿®å¤) â–¼â–¼â–¼

    /**
     * ä¸“ç”¨äºç”¨æˆ·ï¼ˆé€šè¿‡è¾“å…¥æ¡†ï¼‰å‘è¡¨æ–°è¯„è®ºæˆ–å›å¤ã€‚
     * è¿™ä¸ªå‡½æ•°åªä½¿ç”¨å…¨å±€çš„ currentGachaIdentity ä½œä¸ºä½œè€…èº«ä»½ã€‚
     * @param {number} postId - å¸–å­ID
     * @param {string} text - è¯„è®ºå†…å®¹
     * @param {string|null} replyTo - å›å¤çš„ç”¨æˆ·å
     * @returns {Promise<object|null>} - è¿”å›æ–°åˆ›å»ºçš„è¯„è®ºå¯¹è±¡
     */
    /**
* ä¿®å¤ç‰ˆï¼šç”¨æˆ·å‘è¡¨è¯„è®º
* @param {number} postId - å¸–å­ID
* @param {string} text - è¯„è®ºå†…å®¹
* @param {string|null} replyToUser - å›å¤çš„ç”¨æˆ·å (ç”¨äºæ˜¾ç¤º @xxx)
* @param {string|null} parentId - ã€å…³é”®ä¿®å¤ã€‘çˆ¶è¯„è®ºçš„ID
*/
    async function addUserComment(postId, text, replyToUser = null, parentId = null) {
        if (!currentGachaIdentity) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèº«ä»½å†å‘è¡¨è¯„è®ºï¼");
            return null;
        }

        const author = currentGachaIdentity;
        // å¦‚æœæ˜¯æ¥¼ä¸­æ¥¼ï¼Œå†…å®¹ä¸ç”¨æ‰‹åŠ¨åŠ  @ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨UIä¸Šåˆ†å¼€æ˜¾ç¤ºäº†ï¼Œæˆ–è€…ä½ å¯ä»¥ä¿ç•™
        // è¿™é‡Œæˆ‘ä»¬ä¿æŒçº¯å‡€å†…å®¹ï¼ŒUIæ¸²æŸ“æ—¶å†å†³å®šè¦ä¸è¦åŠ 
        const commentContent = text;

        const newComment = {
            id: `c-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
            authorId: author.id,
            authorName: author.user.name,
            authorAvatar: author.user.avatar,
            text: commentContent,
            timestamp: new Date().toISOString(),
            likes: [],
            replies: [] // ç¡®ä¿æœ‰è¿™ä¸ªå­—æ®µ
        };

        try {
            const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
            let allPosts = postsData.value || [];
            const postIndex = allPosts.findIndex(p => p.id === postId);
            const post = allPosts[postIndex];

            if (post) {
                // === æ ¸å¿ƒé€»è¾‘ä¿®å¤ ===
                if (parentId) {
                    // å¦‚æœæœ‰çˆ¶IDï¼Œè¯´æ˜æ˜¯æ¥¼ä¸­æ¥¼ï¼Œéœ€è¦æ‰¾åˆ°çˆ¸çˆ¸
                    // ä½¿ç”¨ä¹‹å‰çš„é€’å½’æŸ¥æ‰¾å‡½æ•° findCommentAndAddReply
                    const success = findCommentAndAddReply(post.comments, parentId, newComment);
                    if (!success) {
                        // å¦‚æœæ²¡æ‰¾åˆ°çˆ¸çˆ¸ï¼ˆæå°‘è§ï¼‰ï¼Œå›é€€åˆ°é¡¶å±‚
                        post.comments.push(newComment);
                    }
                } else {
                    // æ²¡æœ‰çˆ¶IDï¼Œå°±æ˜¯é¡¶å±‚è¯„è®º
                    if (!post.comments) post.comments = [];
                    post.comments.push(newComment);
                }

                await dbHelper.saveData('gachaPosts', 'allPosts', allPosts);
                return newComment;
            } else {
                throw new Error(`æ‰¾ä¸åˆ°IDä¸º ${postId} çš„å¸–å­`);
            }
        } catch (error) {
            console.error("ç”¨æˆ·å‘è¡¨è¯„è®ºå¤±è´¥:", error);
            return null;
        }
    }



    /**
     * ç”±AIè°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æœ‹å‹åœˆå¸–å­å¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚
     * @param {object} aiContact - å‘å¸–çš„AIè§’è‰²å¯¹è±¡
     * @param {string} postText - å¸–å­æ­£æ–‡
     * @param {string|null} imageDescription - (å¯é€‰) å›¾ç‰‡æè¿°
     */
    /**
* ç”±AIè°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æœ‹å‹åœˆå¸–å­å¹¶ä¿å­˜åˆ°æ•°æ®åº“ (V2 - å·²ä¿®å¤UIä¸åˆ·æ–°çš„BUG)
* @param {object} aiContact - å‘å¸–çš„AIè§’è‰²å¯¹è±¡
* @param {string} postText - å¸–å­æ­£æ–‡
* @param {string|null} imageDescription - (å¯é€‰) å›¾ç‰‡æè¿°
*/
    async function createAiPost(aiContact, postText, imageDescription = null) {
        if (!aiContact || !postText) {
            console.error("AIåˆ›å»ºå¸–å­å¤±è´¥ï¼šç¼ºå°‘ä½œè€…ä¿¡æ¯æˆ–æ­£æ–‡ã€‚");
            return;
        }

        // 1. æ„å»ºå¸–å­å¯¹è±¡ (æ­¤éƒ¨åˆ†ä¸å˜)
        const newPost = {
            id: Date.now(),
            authorId: aiContact.id,
            authorName: aiContact.ai.name,
            authorAvatar: aiContact.ai.avatar,
            timestamp: new Date().toISOString(),
            content: postText,
            imageDescription: imageDescription,
            likes: [],
            comments: [],
            visibleTo: [],
        };

        // 2. ä¿å­˜åˆ°æ•°æ®åº“ (æ­¤éƒ¨åˆ†ä¸å˜)
        try {
            const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
            let allPosts = (postsData && Array.isArray(postsData.value)) ? postsData.value : [];
            allPosts.unshift(newPost);
            await dbHelper.saveData('gachaPosts', 'allPosts', allPosts);

            console.log(`${aiContact.ai.name} æˆåŠŸå‘å¸ƒäº†ä¸€æ¡æœ‹å‹åœˆï¼`);

            renderAllPosts();


        } catch (error) {
            console.error("AIä¿å­˜å¸–å­å¤±è´¥:", error);
        }
    }

    // â–¼â–¼â–¼ è§¦å‘AIå‘æœ‹å‹åœˆçš„å‡½æ•° â–¼â–¼â–¼

    /**
     * å½“å¯¹è¯æ»¡è¶³æ¡ä»¶æ—¶ï¼Œè§¦å‘AIæ ¹æ®æœ€è¿‘èŠå¤©è®°å½•å‘æœ‹å‹åœˆã€‚
     * @param {object} contact - è¦å‘æœ‹å‹åœˆçš„AIè§’è‰²å¯¹è±¡
     */
    async function triggerAiSocialPost(contact) {
        console.log(`è¾¾åˆ°æ¶ˆæ¯é˜ˆå€¼ï¼Œæ­£åœ¨è§¦å‘ ${contact.ai.name} å‘æœ‹å‹åœˆ...`);
        try {
            const history = contact.history || [];
            const recentHistory = history.slice(-50);

            let context = "[æœ€è¿‘çš„50æ¡èŠå¤©è®°å½•]:\n";
            recentHistory.forEach(msg => {
                const senderName = msg.sender === 'user' ? contact.user.name : contact.ai.name;

                // ä½¿ç”¨ cleanMessageForPreview æ¥è·å–å¹²å‡€çš„æ–‡æœ¬
                const previewText = cleanMessageForPreview(msg.text);

                // ç¡®ä¿åªæ·»åŠ æœ‰æ„ä¹‰çš„å†…å®¹
                if (previewText) {
                    context += `- ${senderName}: "${previewText}"\n`;
                }
            });

            // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æ›´å¼ºåŠ›ã€æ›´æ˜ç¡®çš„æç¤ºè¯ ---
            const triggerMessage = `(ç³»ç»ŸæŒ‡ä»¤ï¼šä½ å’Œ '${contact.user.name}' çš„å¯¹è¯éå¸¸æ„‰å¿«ã€‚
        ä½ çš„ä»»åŠ¡æ˜¯ï¼š
        1.  é˜…è¯»å¹¶ç†è§£ä»¥ä¸Šæœ€è¿‘çš„èŠå¤©è®°å½•ã€‚
        2.  æ ¹æ®èŠå¤©å†…å®¹ï¼Œæç‚¼ä¸€ä¸ªæœ‰è¶£æˆ–æœ‰æ„Ÿè§¦çš„ç¬é—´ã€‚
        3.  ã€å¿…é¡»ã€‘ä½¿ç”¨ "å‘æœ‹å‹åœˆï¼š" å‘½ä»¤æ ¼å¼ï¼Œå‘å¸ƒä¸€æ¡å…³äºè¿™ä¸ªç¬é—´çš„æœ‹å‹åœˆåŠ¨æ€ã€‚åŠ¨æ€å†…å®¹è¦ç¬¦åˆä½ çš„äººè®¾ã€‚
        è¿™æ˜¯ä¸€ä¸ªå¼ºåˆ¶è¦æ±‚ï¼Œä½ å¿…é¡»å‘å¸ƒåŠ¨æ€ã€‚)\n\n${context}`;

            // è°ƒç”¨AIï¼Œè®©å®ƒè‡ªå·±å†³ç­–å‘ä»€ä¹ˆå†…å®¹
            await callAI(triggerMessage, contact);

        } catch (error) {
            console.error("è§¦å‘AIå‘æœ‹å‹åœˆå¤±è´¥:", error);
        }
    }

    // å½©ç¥¨å¼€å¥–æ ¸å¿ƒé€»è¾‘å‡½æ•° â–¼â–¼â–¼

    /**
     * æ ¹æ®å¸¦æƒé‡çš„æ¦‚ç‡è®¡ç®—å½©ç¥¨å¥–é‡‘ã€‚
     * @returns {number} - è¿”å›ä¸€ä¸ªåœ¨5åˆ°2000ä¹‹é—´çš„éšæœºå¥–é‡‘é‡‘é¢
     */
    function calculateLotteryPrize() {
        const rand = Math.random(); // ç”Ÿæˆä¸€ä¸ª 0 åˆ° 1 ä¹‹é—´çš„éšæœºæ•°

        let prize;

        if (rand < 0.8) {
            // 80% çš„æ¦‚ç‡ä¸­ 5 - 500 å…ƒ
            prize = Math.floor(Math.random() * (500 - 5 + 1)) + 5;
        } else if (rand < 0.95) {
            // 15% çš„æ¦‚ç‡ä¸­ 501 - 1000 å…ƒ
            prize = Math.floor(Math.random() * (1000 - 501 + 1)) + 501;
        } else if (rand < 0.99) {
            // 4% çš„æ¦‚ç‡ä¸­ 1001 - 1500 å…ƒ
            prize = Math.floor(Math.random() * (1500 - 1001 + 1)) + 1001;
        } else {
            // 1% çš„æ¦‚ç‡ä¸­ 1501 - 2000 å…ƒ
            prize = Math.floor(Math.random() * (2000 - 1501 + 1)) + 1501;
        }

        return prize;
    }

    lotteryModal.addEventListener('click', async (event) => {
        // ã€æ–°å¢ã€‘å¤„ç†å…³é—­äº‹ä»¶
        if (event.target.classList.contains('modal-close-button') || event.target === lotteryModal) {
            closeGameModals();
            return;
        }

        const choiceBtn = event.target.closest('.game-choice-btn');
        if (!choiceBtn) return;

        const cost = parseInt(choiceBtn.dataset.cost, 10);
        const currentBalance = await getBalance();

        if (currentBalance < cost) {
            alert(`ä½™é¢ä¸è¶³ï¼æ‚¨éœ€è¦ Â¥${cost.toFixed(2)}ï¼Œä½†å½“å‰åªæœ‰ Â¥${currentBalance.toFixed(2)}ã€‚`);
            return;
        }

        await logTransactionAndUpdateBalance({
            description: `è´­ä¹° ${cost} å…ƒå½©ç¥¨`,
            amount: -cost
        });

        const prize = calculateLotteryPrize();

        await logTransactionAndUpdateBalance({
            description: 'å½©ç¥¨ä¸­å¥–',
            amount: prize
        });

        closeGameModals();
        setTimeout(() => {
            alert(`æ­å–œä½ ï¼\n\nèŠ±è´¹ Â¥${cost.toFixed(2)}ï¼Œå–œä¸­ Â¥${prize.toFixed(2)} å…ƒå¤§å¥–ï¼`);
        }, 310);
    });

    // ==========================================================
    // === START: æ¶ˆæ¯ç¼–è¾‘åŠŸèƒ½ ===
    // ==========================================================

    // --- æ­¥éª¤ 1: ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ºèŠå¤©å®¹å™¨æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬ ---
    // ==========================================================
    // === æœ€ç»ˆç‰ˆï¼šåŒå‡»äº‹ä»¶ç›‘å¬å™¨ (ç²¾å‡†æ§åˆ¶) ===
    // ==========================================================
    chatMessagesContainer.addEventListener('dblclick', (event) => {
        const target = event.target;

        // ========== å…³é”®ä¿®å¤1ï¼šå¦‚æœåŒå‡»çš„æ˜¯æ­£åœ¨ç¼–è¾‘çš„textareaï¼Œå¿½ç•¥ ==========
        if (target.classList.contains('editing-bubble')) {
            console.log('[åŒå‡»] å¿½ç•¥ï¼šç‚¹å‡»äº†æ­£åœ¨ç¼–è¾‘çš„textarea');
            return;
        }
        
        // ========== å…³é”®ä¿®å¤2ï¼šå¦‚æœæ°”æ³¡å·²ç»åœ¨ç¼–è¾‘çŠ¶æ€ï¼Œå¿½ç•¥ ==========
        const bubble = target.closest('.chat-bubble');
        if (bubble && bubble.classList.contains('editing-mode-active')) {
            console.log('[åŒå‡»] å¿½ç•¥ï¼šæ°”æ³¡å·²ç»åœ¨ç¼–è¾‘çŠ¶æ€');
            return;
        }

        // 1. ã€æ–°å¢ã€‘æ£€æµ‹è¯­éŸ³ä¸‹æ–¹çš„æ–‡å­—é¢æ¿ (voice-text-panel)
        // éœ€æ±‚ï¼šåŒå‡»è¿™é‡Œå¼¹å‡ºç¼–è¾‘æ¡†
        const voicePanel = target.closest('.voice-text-panel');
        if (voicePanel) {
            const row = voicePanel.closest('.message-row');
            if (row && row.dataset.uuid) {
                // è°ƒç”¨ä¹‹å‰å†™å¥½çš„ openVoiceEditModal å‡½æ•°
                // (æ³¨æ„ï¼šè¿™é‡Œç”¨ innerText è·å–çº¯æ–‡æœ¬ï¼Œå»é™¤ <br>)
                openVoiceEditModal(row.dataset.uuid, voicePanel.innerText);
            }
            return; // é˜»æ­¢åç»­é€»è¾‘
        }

        // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å±è”½è¯­éŸ³æ¡ (voice-audio-bubble)
        // éœ€æ±‚ï¼šåŒå‡»è¿™é‡Œä»€ä¹ˆéƒ½ä¸åšï¼Œé˜²æ­¢æ°”æ³¡çˆ†ç‚¸
        if (target.closest('.voice-audio-bubble')) {
            return;
        }

        // 3. æ£€æµ‹ä»»æ„é—¨/æ—ç™½ (action-message-text)
        // éœ€æ±‚ï¼šåŒå‡»ç¼–è¾‘å†…å®¹
        const actionText = target.closest('.action-message-text');
        if (actionText) {
            makeActionEditable(actionText);
            return;
        }

        // 4. ã€æ–°å¢ã€‘æ£€æµ‹ç¾¤èŠæ°”æ³¡ (gp-ai-bubble, gp-user-bubble)
        // éœ€æ±‚ï¼šæ”¯æŒç¾¤èŠä¸­çš„åŒå‡»ç¼–è¾‘
        const groupBubble = target.closest('.gp-ai-bubble, .gp-user-bubble');
        const messageRow = target.closest('.message-row');
        
        if (groupBubble && messageRow && !messageRow.classList.contains('typing-indicator')) {
            // å°†ç¾¤èŠæ°”æ³¡ä½œä¸ºæ™®é€šæ°”æ³¡å¤„ç†
            makeBubbleEditable(groupBubble);
            return;
        }

        // 5. æ™®é€šæ°”æ³¡ (chat-bubble)
        // æ’é™¤æ‰ç‰¹æ®Šçš„å›¾ç‰‡ã€æ–‡ä»¶ã€HTMLç­‰æ°”æ³¡
        if (bubble &&
            !bubble.classList.contains('sticker-bubble') &&
            !bubble.classList.contains('image-bubble') &&
            !bubble.classList.contains('html-render-container') &&
            !bubble.classList.contains('voice-text-bubble') && // å†æ¬¡ç¡®ä¿è¯­éŸ³æ°”æ³¡ä¸è¿›å…¥æ­¤é€»è¾‘
            messageRow && !messageRow.classList.contains('typing-indicator')) {

            makeBubbleEditable(bubble);
        }
    });
    /**
     * æ­¥éª¤ 2: å°†ä¸€ä¸ªæ°”æ³¡ DOM å…ƒç´ è½¬æ¢ä¸ºå¯ç¼–è¾‘çŠ¶æ€
     * @param {HTMLElement} bubbleElement - è¦ç¼–è¾‘çš„æ°”æ³¡å…ƒç´ 
     */
    // ==========================================================
    // === makeBubbleEditable (æœ€ç»ˆé˜²è¯¯è§¦ä¿®å¤ç‰ˆ) ===
    // ==========================================================
    // ==========================================================
    // === ç»ˆæç‰ˆï¼šmakeBubbleEditable (é˜²å¡æ­»é€»è¾‘) ===
    // ==========================================================
    // å…¨å±€å˜é‡ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
    let isEditingBubble = false;

    // ==========================================================
    // === ä¿®å¤ç‰ˆï¼šæ°”æ³¡ç¼–è¾‘å‡½æ•° (å¸¦æ•°æ®åº“ä¿å­˜ & ç¾¤èŠæ ·å¼ä¿®æ­£) ===
    // ==========================================================
    // ==========================================================
    // === ç»ˆæé‡æ„ç‰ˆï¼šæ°”æ³¡ç¼–è¾‘ (æ‰€è§å³æ‰€å¾— + è‡ªåŠ¨æ ·å¼å¸å–) ===
    // ==========================================================
    function makeBubbleEditable(bubbleElement) {
        // 1. é˜²æŠ–
        if (typeof isEditingBubble !== 'undefined' && isEditingBubble) return;

        // 2. æ‰¾åˆ° UUID
        const messageRow = bubbleElement.closest('.message-row');
        if (!messageRow || !messageRow.dataset.uuid) return;

        // 3. ---ã€æ ¸å¿ƒé‡æ„ã€‘å¸å–åŸæ°”æ³¡çš„è®¡ç®—æ ·å¼ ---
        // ä¸å†å»çŒœæ˜¯ç¾¤èŠè¿˜æ˜¯å•èŠï¼Œç›´æ¥çœ‹æµè§ˆå™¨ç°åœ¨æ¸²æŸ“çš„æ˜¯ä»€ä¹ˆé¢œè‰²
        const computedStyle = window.getComputedStyle(bubbleElement);

        const originalBgColor = computedStyle.backgroundColor;
        const originalColor = computedStyle.color;
        const originalBorderRadius = computedStyle.borderRadius;
        const originalPadding = computedStyle.padding;
        const originalBoxShadow = computedStyle.boxShadow;
        const originalFontSize = computedStyle.fontSize;
        const originalLineHeight = computedStyle.lineHeight;

        // è·å–å†…å®¹
        const isHtmlContent = bubbleElement.classList.contains('html-render-container');
        const currentText = isHtmlContent ? bubbleElement.innerHTML : bubbleElement.innerText;

        // 4. åˆ›å»ºè¾“å…¥æ¡†
        const textarea = document.createElement('textarea');
        textarea.className = 'editing-bubble';
        textarea.value = currentText; // è¿™é‡Œå»ºè®®ç”¨ innerText å¯¹åº”çš„çº¯æ–‡æœ¬ï¼Œé™¤éä½ éœ€è¦ç¼–è¾‘ HTML

        // 5. ---ã€æ ¸å¿ƒé‡æ„ã€‘å°†å¸å–åˆ°çš„æ ·å¼èµ‹ç»™ textarea ---
        textarea.style.backgroundColor = originalBgColor;
        textarea.style.color = originalColor;
        textarea.style.borderRadius = originalBorderRadius;
        textarea.style.boxShadow = originalBoxShadow; // ä¿æŒé˜´å½±ä¸€è‡´
        textarea.style.fontSize = originalFontSize;
        textarea.style.lineHeight = originalLineHeight;
        // ç¨å¾®è°ƒæ•´ padding ä»¥åŒ¹é… textarea çš„ç‰¹æ€§
        textarea.style.padding = originalPadding;

        // å­˜ UUID
        textarea.dataset.uuid = messageRow.dataset.uuid;

        // 6. ---ã€æ ¸å¿ƒé‡æ„ã€‘çˆ¶å®¹å™¨éšèº«ï¼Œé˜²æ­¢â€œåŒå±‚æ°”æ³¡â€ ---
        // æš‚æ—¶æŠŠå†…å®¹çš„å®½é«˜ç­‰ä¿¡æ¯å­˜ä¸‹æ¥ï¼Œå…å¾—å¡Œé™·ï¼ˆè™½ç„¶ textrea ä¼šæ’‘å¼€ï¼‰
        const minHeight = bubbleElement.offsetHeight;
        const minWidth = bubbleElement.offsetWidth;

        bubbleElement.innerHTML = ''; // æ¸…ç©ºå†…å®¹
        bubbleElement.appendChild(textarea); // æ’å…¥è¾“å…¥æ¡†

        // ç»™çˆ¶å®¹å™¨åŠ ä¸ªç±»ï¼Œè®© CSS æŠŠå®ƒçš„èƒŒæ™¯è‰²å»æ‰ (è§ä¸Šé¢çš„ CSS)
        bubbleElement.classList.add('editing-mode-active');

        // åˆå§‹é«˜åº¦è°ƒæ•´
        textarea.style.height = minHeight + 'px';
        textarea.style.width = minWidth + 'px';

        textarea.focus();
        window.isEditingBubble = true;

        // è‡ªåŠ¨é«˜åº¦
        const autoResize = () => {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        };
        textarea.addEventListener('input', autoResize);
        setTimeout(autoResize, 0);

        // --- å®šä¹‰ç»“æŸé€»è¾‘ ---
        const cleanupListeners = () => {
            document.removeEventListener('click', handleDocumentClick, true);
            textarea.removeEventListener('keydown', handleKeyDown);
            window.isEditingBubble = false;
        };

        const finishEditing = async (saveChanges) => {
            cleanupListeners();

            const newText = textarea.value.trim();
            const uuid = textarea.dataset.uuid;

            // æ¢å¤çˆ¶å®¹å™¨æ ·å¼ (ç§»é™¤éšèº«ç±»)
            bubbleElement.classList.remove('editing-mode-active');

            if (saveChanges && newText && newText !== currentText) {
                // A. ç•Œé¢æ›´æ–°
                if (isHtmlContent) bubbleElement.innerHTML = newText; // åªæœ‰åŸæœ¬æ˜¯HTMLæ‰å›å†™HTML
                else bubbleElement.innerText = newText;

                // B. å†…å­˜æ›´æ–° (è§£å†³ä½ è¯´çš„åˆ‡å›æ¥è¿˜åŸçš„é—®é¢˜)
                let targetArray = null;
                if (typeof currentOpenGroup !== 'undefined' && currentOpenGroup) targetArray = currentOpenGroup.history;
                else if (typeof currentOpenContact !== 'undefined' && currentOpenContact) targetArray = currentOpenContact.history;

                if (targetArray) {
                    const msg = targetArray.find(m => m.uuid === uuid);
                    if (msg) msg.text = newText;
                }

                // C. æ•°æ®åº“æ›´æ–°
                if (typeof updateMessageInDatabase === 'function') {
                    await updateMessageInDatabase(uuid, newText);
                }
            } else {
                // å–æ¶ˆæˆ–æ— å˜åŒ–ï¼šæ¢å¤åŸçŠ¶
                if (isHtmlContent) bubbleElement.innerHTML = currentText;
                else bubbleElement.innerText = currentText;
            }
        };

        // äº‹ä»¶ç›‘å¬
        const handleDocumentClick = (event) => {
            if (event.target !== textarea) {
                event.preventDefault();
                event.stopPropagation();
                finishEditing(true);
            }
        };

        const handleKeyDown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                finishEditing(true);
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                finishEditing(false);
            }
        };

        textarea.addEventListener('keydown', handleKeyDown);
        setTimeout(() => {
            document.addEventListener('click', handleDocumentClick, true);
        }, 50);
    }


    // **ã€é‡è¦ç§»é™¤ã€‘**ï¼šç§»é™¤å¯¹ blur çš„ç›‘å¬ï¼Œå› ä¸ºå®ƒä¼šä¸é”®ç›˜æ”¶èµ·åŒæ—¶è§¦å‘
    // textarea.addEventListener('blur', () => finishEditing(true)); // <-- æ­¤è¡Œå·²ç§»é™¤

    /**
     * æ­¥éª¤ 4: æ›´æ–°æ•°æ®åº“ä¸­çš„æ¶ˆæ¯
     * @param {string} uuid - æ¶ˆæ¯çš„å”¯ä¸€ID
     * @param {string} newText - æ–°çš„æ¶ˆæ¯æ–‡æœ¬
     */
    // ==========================================================
    // === updateMessageInDatabase (åŒæ¨¡å¼å…¼å®¹ç‰ˆ) ===
    // ==========================================================
    async function updateMessageInDatabase(uuid, newText) {
        try {
            // --- åœºæ™¯ Aï¼šç¾¤èŠæ¨¡å¼ (User's Code ç¼ºå¤±çš„éƒ¨åˆ†) ---
            if (currentOpenGroup) {
                // 1. è¯»å–æ‰€æœ‰ç¾¤æ•°æ®
                const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

                // 2. æ‰¾åˆ°å½“å‰ç¾¤
                const groupIndex = allGroups.findIndex(g => g.id === currentOpenGroup.id);
                if (groupIndex > -1) {
                    // 3. æ‰¾åˆ°æ¶ˆæ¯
                    const msg = allGroups[groupIndex].history.find(m => m.uuid === uuid);
                    if (msg) {
                        // 4. æ›´æ–°å†…å®¹
                        if (msg.type === 'voice_text') msg.transcript = newText;
                        else if (isHtmlString(newText)) {
                            msg.type = 'html';
                            msg.content = { html: newText };
                            delete msg.text;
                        } else {
                            msg.type = 'text';
                            msg.text = newText;
                        }

                        // 5. ä¿å­˜å›æ•°æ®åº“
                        await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);

                        // 6. åŒæ­¥å†…å­˜
                        currentOpenGroup.history = allGroups[groupIndex].history;
                        console.log('ç¾¤èŠæ¶ˆæ¯å·²ä¿å­˜');
                        return; // ç»“æŸ
                    }
                }
            }

            // --- åœºæ™¯ Bï¼šå•èŠæ¨¡å¼ (User's Code åŸæœ‰çš„éƒ¨åˆ†) ---
            if (currentOpenContact) {
                // ç›´æ¥è¯»å–æ•°æ®åº“æ›´å®‰å…¨
                const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                const allContacts = (contactsData && Array.isArray(contactsData.value)) ? contactsData.value : [];

                const contactIndex = allContacts.findIndex(c => c.id === currentOpenContact.id);
                if (contactIndex > -1) {
                    const msg = allContacts[contactIndex].history.find(m => m.uuid === uuid);
                    if (msg) {
                        if (msg.type === 'voice_text') msg.transcript = newText;
                        else if (isHtmlString(newText)) {
                            msg.type = 'html';
                            msg.content = { html: newText };
                            delete msg.text;
                        } else {
                            msg.type = 'text';
                            msg.text = newText;
                        }

                        await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                        currentOpenContact.history = allContacts[contactIndex].history;
                        console.log('å•èŠæ¶ˆæ¯å·²ä¿å­˜');
                        return;
                    }
                }
            }
        } catch (e) {
            console.error("æ›´æ–°æ¶ˆæ¯å¤±è´¥:", e);
        }
    }
    // ==========================================================
    // === END: æ¶ˆæ¯ç¼–è¾‘åŠŸèƒ½ ===
    // ==========================================================
    // ==========================================================
    // === START: GACHA å†…å®¹åˆ é™¤åŠŸèƒ½ (V3 - ç®¡ç†å‘˜æ¨¡å¼) ===
    // ==========================================================

    // 1. ä¸»å®¹å™¨çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    postsContainer.addEventListener('click', async (event) => {
        const button = event.target.closest('button');
        if (!button) return;

        const postCard = button.closest('.gp-card');
        if (!postCard) return; // å¦‚æœæ‰¾ä¸åˆ°çˆ¶çº§å¸–å­ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ

        const postId = parseInt(postCard.dataset.postId);

        // --- å·²æœ‰çš„åŠŸèƒ½é€»è¾‘ (æ ¹æ®æ‚¨çš„ä»£ç åº“æƒ…å†µï¼Œå¯èƒ½éœ€è¦ä¿ç•™æˆ–åˆ é™¤) ---
        if (button.classList.contains('gp-like-btn')) {
            await toggleLike(postId);
            renderAllPosts();
        } else if (button.classList.contains('gp-comment-btn')) {
            const commentSection = postCard.querySelector('.gp-comment-section');
            commentSection.style.display = (commentSection.style.display === 'none' || commentSection.style.display === '') ? 'block' : 'none';
        } else if (button.classList.contains('gp-reply-btn')) {
            showReplyInput(button);
        } else if (button.classList.contains('gp-visibility-btn')) {
            openVisibilityModal(postId);
        } else if (button.classList.contains('gp-summon-btn')) {
            openSummonAiModal(postId);
        }
        // --- æ–°å¢çš„åˆ é™¤é€»è¾‘ ---
        else if (button.classList.contains('gp-delete-post-btn')) {
            await handleDeletePost(postId);
        }
        else if (button.classList.contains('gp-delete-comment-btn')) {
            const commentItem = button.closest('.gp-comment-item');
            const commentId = parseInt(commentItem.dataset.commentId);
            await handleDeleteComment(postId, commentId);
        }
    });


    /**
     * 2. å¤„ç†åˆ é™¤å¸–å­çš„æµç¨‹ (æ— æƒé™æ£€æŸ¥)
     * @param {number} postId - è¦åˆ é™¤çš„å¸–å­ID
     */
    async function handleDeletePost(postId) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡åˆ†äº«å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
            try {
                await deletePostFromDB(postId);
                alert('åˆ†äº«å·²åˆ é™¤ã€‚');
                renderAllPosts();
            } catch (error) {
                console.error("åˆ é™¤å¸–å­å¤±è´¥:", error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }
    }

    /**
     * 3. å¤„ç†åˆ é™¤è¯„è®ºçš„æµç¨‹ (æ— æƒé™æ£€æŸ¥)
     * @param {number} postId - è¯„è®ºæ‰€åœ¨çš„å¸–å­ID
     * @param {number} commentId - è¦åˆ é™¤çš„è¯„è®ºID
     */
    async function handleDeleteComment(postId, commentId) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
            try {
                await deleteCommentFromDB(postId, commentId);
                renderAllPosts();
            } catch (error) {
                console.error("åˆ é™¤è¯„è®ºå¤±è´¥:", error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }
    }

    /**
     * 4. ä»æ•°æ®åº“ä¸­åˆ é™¤æŒ‡å®šçš„å¸–å­
     * @param {number} postId - è¦åˆ é™¤çš„å¸–å­ID
     */
    async function deletePostFromDB(postId) {
        const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
        let allPosts = (postsData && Array.isArray(postsData.value)) ? postsData.value : [];
        const updatedPosts = allPosts.filter(p => p.id !== postId);
        await dbHelper.saveData('gachaPosts', 'allPosts', updatedPosts);
    }

    /**
     * 5. ä»æ•°æ®åº“ä¸­åˆ é™¤æŒ‡å®šçš„è¯„è®º
     * @param {number} postId - è¯„è®ºæ‰€åœ¨çš„å¸–å­ID
     * @param {number} commentId - è¦åˆ é™¤çš„è¯„è®ºID
     */
    async function deleteCommentFromDB(postId, commentId) {
        const postsData = await dbHelper.loadData('gachaPosts', 'allPosts');
        let allPosts = (postsData && Array.isArray(postsData.value)) ? postsData.value : [];
        const post = allPosts.find(p => p.id === postId);
        if (post && Array.isArray(post.comments)) {
            post.comments = post.comments.filter(c => c.id !== commentId);
            await dbHelper.saveData('gachaPosts', 'allPosts', allPosts);
        }
    }
    // ==========================================================
    // === END: GACHA å†…å®¹åˆ é™¤åŠŸèƒ½ ===
    // ==========================================================



    // ==========================================================
    // === updateBubbleInView (æœ€ç»ˆå¹³æ»‘ä¿®å¤ç‰ˆ - ç¡®ä¿æ»šåŠ¨åŒæ­¥) ===
    // ==========================================================
    /**
     * æ‰¾åˆ°å¹¶æ›´æ–°èŠå¤©ç•Œé¢ä¸­çš„æŒ‡å®šæ¶ˆæ¯æ°”æ³¡ï¼Œå¹¶æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœã€‚
     * @param {object} updatedMessage - å·²æ›´æ–°çš„æ¶ˆæ¯å¯¹è±¡ã€‚
     * @param {HTMLElement|null} container - æ¶ˆæ¯åº”è¯¥è¢«æ¸²æŸ“åˆ°çš„ DOM å®¹å™¨ï¼ˆå¯é€‰ï¼Œé€šå¸¸æ˜¯ chatMessagesContainerï¼‰ã€‚
     * @param {boolean} shouldMaintainScroll - ã€æ–°å¢ã€‘æ˜¯å¦åº”å°è¯•ä¿æŒå½“å‰æ»šåŠ¨ä½ç½®ã€‚
     */

    // ==========================================================
    // === updateBubbleInView (å®Œæ•´ä¿®å¤ç‰ˆï¼šå…¼å®¹æ‰€æœ‰ç±»å‹å’Œæ¨¡å¼) ===
    // ==========================================================
    function updateBubbleInView(updatedMessage, container = null, shouldMaintainScroll = false) {
        if (!updatedMessage || !updatedMessage.uuid) return;

        // 1. æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯è¡Œ
        const messageRow = (container || chatMessagesContainer).querySelector(`.message-row[data-uuid="${updatedMessage.uuid}"]`);
        if (!messageRow) return;

        // 2. æ‰¾åˆ°æ°”æ³¡æœ¬ä½“
        const bubbleElement = messageRow.querySelector('.chat-bubble');
        if (!bubbleElement) return;

        // 3. æŸ¥æ‰¾ Wrapper (å…¼å®¹å•èŠå’Œç¾¤èŠ)
        // è¿™ä¸€æ­¥å¾ˆå…³é”®ï¼Œå†³å®šäº†åç»­æ˜¯å¦èƒ½æ­£ç¡®åˆ¤æ–­æ˜¯ç¾¤èŠ
        let wrapper = messageRow.querySelector('.message-content-wrapper');
        if (!wrapper) wrapper = messageRow.querySelector('.group-message-wrapper');

        // 4. è®°å½•æ»šåŠ¨ä½ç½® (ä»¥ä¾¿æ›´æ–°åæ¢å¤)
        let scrollPosition = chatMessagesContainer.scrollTop;
        let scrollHeightBefore = chatMessagesContainer.scrollHeight;

        // 5. å…ˆéšè—æ°”æ³¡ï¼Œå‡†å¤‡è¿‡æ¸¡åŠ¨ç”»
        bubbleElement.style.opacity = 0;

        setTimeout(() => {
            // =============================
            // === åˆ†ç±»å‹å¤„ç†æ¶ˆæ¯å†…å®¹ ===
            // =============================

            // --- A. å¤„ç† HTML å†…å®¹ (ä½ æåˆ°çš„è¢«åˆ éƒ¨åˆ†) ---
            if (updatedMessage.type === 'html' && updatedMessage.content && updatedMessage.content.html) {
                if (wrapper) wrapper.classList.add('is-html-content');

                const uniqueId = 'html-render-' + updatedMessage.uuid;
                bubbleElement.id = uniqueId;
                // HTML æ¸²æŸ“å®¹å™¨ä¸éœ€è¦ chat-bubble çš„é€šç”¨æ ·å¼ç±»
                bubbleElement.className = 'html-render-container';
                bubbleElement.innerHTML = updatedMessage.content.html;

                // æ³¨å…¥é…å¥—çš„ CSS (å¦‚æœä¸æ˜¯åœ¨ä¸´æ—¶å®¹å™¨ä¸­æ¸²æŸ“)
                if (!container && updatedMessage.content.css) {
                    const style = document.createElement('style');
                    // å°† CSS ä½œç”¨åŸŸé™åˆ¶åœ¨å½“å‰æ°”æ³¡å†…ï¼Œé˜²æ­¢æ±¡æŸ“å…¨å±€
                    const scopedCss = updatedMessage.content.css.replace(/([^\r\n,{}]+)(,(?=[^}]*{)|s*\{)/g, `#${uniqueId} $1 `);
                    style.textContent = scopedCss;
                    document.head.appendChild(style);
                }

                // æ‰§è¡Œé…å¥—çš„ JS
                setTimeout(() => {
                    if (updatedMessage.content.js) {
                        try { new Function(updatedMessage.content.js)(); }
                        catch (e) { console.error("æ‰§è¡Œæ¸²æŸ“çš„JSæ—¶å‡ºé”™:", e); }
                    }
                }, 0);

            }
            // --- B. å¤„ç†è¡¨æƒ…åŒ…/å›¾ç‰‡ ---
            else if ((updatedMessage.type === 'sticker' || updatedMessage.type === 'image') && updatedMessage.url) {
                if (wrapper) wrapper.classList.remove('is-html-content');

                const bubbleClass = updatedMessage.type === 'image' ? 'image-bubble' : 'sticker-bubble';
                bubbleElement.className = `chat-bubble ${bubbleClass}`;
                bubbleElement.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
                const img = document.createElement('img');
                img.src = updatedMessage.url;
                bubbleElement.appendChild(img);
            }
            // --- C. å¤„ç†è¯­éŸ³æ¶ˆæ¯ ---
            else if (updatedMessage.type === 'voice_text') {
                if (wrapper) wrapper.classList.remove('is-html-content');

                // æ„å»ºåŸºç¡€ç±»å
                let classList = ['chat-bubble', 'voice-text-bubble'];
                const isUser = (updatedMessage.sender === 'user');
                if (isUser) classList.push('user-bubble'); else classList.push('ai-bubble');

                // ã€å…³é”®ã€‘åˆ¤æ–­æ˜¯å¦éœ€è¦ç¾¤èŠæ ·å¼
                const isGroupContext = (wrapper && wrapper.classList.contains('group-message-wrapper')) || (typeof currentOpenGroup !== 'undefined' && currentOpenGroup);
                if (isGroupContext) {
                    classList.push('gp-bubble');
                    if (isUser) classList.push('gp-user-bubble'); else classList.push('gp-ai-bubble');
                }
                bubbleElement.className = classList.join(' ');

                // æ„å»ºè¯­éŸ³ HTML ç»“æ„ (è¯·ç¡®ä¿ä½ çš„SVGä»£ç æ˜¯å®Œæ•´çš„)
                const duration = updatedMessage.duration || 0;
                // è¿™é‡Œç”¨ä¸€ä¸ªç®€åŒ–çš„SVGå ä½ï¼Œè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±å®Œæ•´çš„SVGä»£ç 
                const waveformSvg = `<div class="voice-waveform-svg"><svg class="icon" viewBox="0 0 1024 1024" width="200" height="200"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64z m0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z" fill="#FFFFFF"></path><path d="M512 320c-105.9 0-192 86.1-192 192s86.1 192 192 192 192-86.1 192-192-86.1-192-192-192z m0 344c-83.8 0-152-68.2-152-152s68.2-152 152-152 152 68.2 152 152-68.2 152-152 152z" fill="#FFFFFF"></path></svg></div>`;

                bubbleElement.innerHTML = `
                <div class="voice-display-area">
                    <div class="voice-play-button">
                        <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                    <div class="voice-duration">${duration}s</div>
                    ${waveformSvg}
                </div>
                <div class="voice-transcript">
                    ${updatedMessage.transcript.replace(/\n/g, '<br>')}
                </div>
            `;
            }
            // --- D. å¤„ç†æ™®é€šæ–‡æœ¬æ¶ˆæ¯ (é»˜è®¤) ---
            else {
                if (wrapper) wrapper.classList.remove('is-html-content');

                // 1. ç¡®å®šèº«ä»½
                const isUser = (updatedMessage.sender === 'user');

                // 2. æ„å»ºå®Œæ•´ç±»ååˆ—è¡¨ (æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢ç¼–è¾‘åæ ·å¼ä¸¢å¤±)
                let classList = ['chat-bubble'];
                // åŸºç¡€èº«ä»½ç±»
                if (isUser) classList.push('user-bubble'); else classList.push('ai-bubble');

                // ã€å…³é”®ã€‘åˆ¤æ–­æ˜¯å¦ä¸ºç¾¤èŠç¯å¢ƒï¼ŒåŠ ä¸Šä¸“å±ç±»å
                // åˆ¤æ–­ä¾æ®ï¼šå®¹å™¨æ˜¯ç¾¤èŠ wrapperï¼Œæˆ–è€…å½“å‰å…¨å±€çŠ¶æ€æ˜¯ç¾¤èŠæ¨¡å¼
                const isGroupContext = (wrapper && wrapper.classList.contains('group-message-wrapper')) || (typeof currentOpenGroup !== 'undefined' && currentOpenGroup);

                if (isGroupContext) {
                    classList.push('gp-bubble');
                    if (isUser) classList.push('gp-user-bubble'); else classList.push('gp-ai-bubble');
                }

                // 3. åº”ç”¨ç±»å
                bubbleElement.className = classList.join(' ');

                // 4. è®¾ç½®æ–‡æœ¬å†…å®¹ (å…¼å®¹ formatActionText å‡½æ•°)
                const textContent = updatedMessage.text || '';
                bubbleElement.innerHTML = typeof formatActionText === 'function' ? formatActionText(textContent) : textContent.replace(/\n/g, '<br>');
            }

            // 6. æ˜¾ç¤ºæ°”æ³¡ï¼Œå®Œæˆè¿‡æ¸¡
            bubbleElement.style.opacity = 1;

            // 7. æ¢å¤æ»šåŠ¨ä½ç½® (é˜²æ­¢ç”»é¢è·³åŠ¨)
            if (shouldMaintainScroll) {
                window.requestAnimationFrame(() => {
                    const scrollHeightAfter = chatMessagesContainer.scrollHeight;
                    if (scrollHeightAfter !== scrollHeightBefore) {
                        // è®¡ç®—é«˜åº¦å·®ï¼Œè°ƒæ•´æ»šåŠ¨æ¡ä½ç½®
                        chatMessagesContainer.scrollTop = scrollPosition + (scrollHeightAfter - scrollHeightBefore);
                    }
                });
            }
        }, 10); // çŸ­æš‚å»¶è¿Ÿä»¥è§¦å‘ opacity åŠ¨ç”»
    }
    // ==========================================================
    // === æ–°å¢ï¼šdeleteMessage (ç¡®ä¿æ•°æ®åŒæ­¥çš„åˆ é™¤åŠŸèƒ½) ===
    // ==========================================================
    /**
     * åˆ é™¤æŒ‡å®šçš„èŠå¤©æ¶ˆæ¯ï¼Œå¹¶ç¡®ä¿æ•°æ®æˆåŠŸåŒæ­¥åˆ°æ•°æ®åº“ã€‚
     * @param {string} messageUuid - è¦åˆ é™¤çš„æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
     * @returns {Promise<boolean>} - å¦‚æœåˆ é™¤æˆåŠŸåˆ™è¿”å› trueã€‚
     */
    async function deleteMessage(messageUuid) {
        // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘è‡ªåŠ¨åˆ¤æ–­å½“å‰æ˜¯åœ¨å•èŠè¿˜æ˜¯ç¾¤èŠ
        const activeContext = currentOpenGroup || currentOpenContact;

        // 2. æ£€æŸ¥ä¼šè¯å¯¹è±¡å’Œå†å²è®°å½•æ˜¯å¦å­˜åœ¨
        if (!activeContext || !Array.isArray(activeContext.history)) {
            console.error("æ— æ³•åˆ é™¤æ¶ˆæ¯ï¼šå½“å‰ä¼šè¯ï¼ˆå•èŠ/ç¾¤èŠï¼‰æˆ–èŠå¤©è®°å½•ä¸å­˜åœ¨ã€‚");
            return false;
        }

        const initialHistoryLength = activeContext.history.length;

        // 3. ä»å†…å­˜ä¸­åˆ é™¤æ¶ˆæ¯ (ç»Ÿä¸€ä½¿ç”¨ activeContext)
        // æ³¨æ„ï¼šfilter è¿”å›çš„æ˜¯æ–°æ•°ç»„ï¼Œè¿™æ­¥æ“ä½œæ˜¯æ­£ç¡®çš„ï¼Œä½†åœ¨å†…å­˜ä¸­ç”Ÿæ•ˆ
        activeContext.history = activeContext.history.filter(msg => msg.uuid !== messageUuid);

        // 4. æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ é™¤
        if (activeContext.history.length === initialHistoryLength) {
            console.warn(`æ¶ˆæ¯ ${messageUuid} æœªåœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°ï¼Œå¯èƒ½å·²è¢«åˆ é™¤ã€‚`);
            return false;
        }

        // 5. æ›´æ–°åˆ—è¡¨é¢„è§ˆ (æœ€åä¸€æ¡æ¶ˆæ¯)
        if (initialHistoryLength > 0 && activeContext.history.length < initialHistoryLength) {
            if (activeContext.history.length > 0) {
                const newLastMessage = activeContext.history[activeContext.history.length - 1];
                // å…¼å®¹å¤šç§å†…å®¹æ ¼å¼
                // æ³¨æ„ï¼šç¡®ä¿ cleanMessageForPreview å‡½æ•°åœ¨å½“å‰ä½œç”¨åŸŸå¯ç”¨
                activeContext.lastMessage = (typeof cleanMessageForPreview === 'function')
                    ? cleanMessageForPreview(
                        newLastMessage.text ||
                        (newLastMessage.content && newLastMessage.content.html) ||
                        newLastMessage.transcript || ''
                    )
                    : (newLastMessage.text || '[å¤šåª’ä½“]');
            } else {
                activeContext.lastMessage = 'æ— æ¶ˆæ¯';
            }

            // 6. åœ¨ UI åˆ—è¡¨ä¸Šæ›´æ–°é¢„è§ˆ
            const listSelector = currentOpenGroup ?
                `.contact-item[data-group-id="${activeContext.id}"]` :
                `.contact-item[data-contact-id="${activeContext.id}"]`;

            const contactItemInList = contactList.querySelector(listSelector);
            if (contactItemInList) {
                const previewEl = contactItemInList.querySelector('.contact-last-message');
                if (previewEl) previewEl.textContent = activeContext.lastMessage;
            }
        }

        // 7. ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶æŒä¹…åŒ–ä¿å­˜åˆ°æ•°æ®åº“
        try {
            if (currentOpenGroup) {
                // === ç¾¤èŠä¿å­˜é€»è¾‘ (ä¿®å¤ç‰ˆ) ===
                // 1. è¯»å–æ‰€æœ‰ç¾¤ç»„çš„å¤§åˆ—è¡¨
                const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

                // 2. åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°å½“å‰è¿™ä¸ªç¾¤
                const groupIndex = allGroups.findIndex(g => g.id === activeContext.id);

                if (groupIndex > -1) {
                    // 3. ç”¨å†…å­˜ä¸­å·²ç»åˆ é™¤è¿‡æ¶ˆæ¯çš„ activeContext æ›´æ–°åˆ—è¡¨ä¸­çš„æ•°æ®
                    allGroups[groupIndex] = activeContext;

                    // 4. æŠŠæ•´ä¸ªå¤§åˆ—è¡¨ä¿å­˜å›æ•°æ®åº“
                    await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                    console.log(`ç¾¤èŠæ¶ˆæ¯ ${messageUuid} å·²åˆ é™¤å¹¶æ­£ç¡®åŒæ­¥åˆ° allGroupChatsã€‚`);
                } else {
                    console.error("æ•°æ®åº“å¼‚å¸¸ï¼šåœ¨ allGroupChats ä¸­æ‰¾ä¸åˆ°å½“å‰ç¾¤ç»„ã€‚");
                }

            } else {
                // === å•èŠä¿å­˜é€»è¾‘ ===
                // ä½ çš„ main.js ä¸­åº”è¯¥æœ‰ saveCurrentContactToDatabaseï¼Œç›´æ¥è°ƒç”¨å³å¯
                if (typeof saveCurrentContactToDatabase === 'function') {
                    await saveCurrentContactToDatabase();
                    console.log(`å•èŠæ¶ˆæ¯ ${messageUuid} å·²åˆ é™¤å¹¶åŒæ­¥æ•°æ®åº“ã€‚`);
                } else {
                    console.warn("æœªæ‰¾åˆ° saveCurrentContactToDatabase å‡½æ•°ï¼Œå°è¯•æ‰‹åŠ¨ä¿å­˜å•èŠ...");
                    // å¤‡ç”¨å•èŠä¿å­˜é€»è¾‘
                    const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                    let allContacts = (contactsData && Array.isArray(contactsData.value)) ? contactsData.value : [];
                    const contactIndex = allContacts.findIndex(c => c.id === activeContext.id);
                    if (contactIndex > -1) {
                        allContacts[contactIndex] = activeContext;
                        await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                    }
                }
            }
        } catch (e) {
            console.error("æ•°æ®åº“åŒæ­¥å¤±è´¥:", e);
            alert("åˆ é™¤æˆåŠŸä½†ä¿å­˜å¤±è´¥ï¼Œåˆ·æ–°åå¯èƒ½ä¼šæ¢å¤ã€‚");
        }

        return true;
    }

    // ==========================================================
    // === removeMessageFromView (V4 - é€‚é…æ–°åˆ é™¤åŠŸèƒ½) ===
    // ==========================================================
    async function removeMessageFromView(messageElement) {
        if (!messageElement) {
            console.error("removeMessageFromView è¢«è°ƒç”¨äº†ï¼Œä½†å‚æ•°æ˜¯ç©ºçš„ï¼");
            return;
        }
        const uuid = messageElement.dataset.uuid;
        if (!uuid) {
            console.error("æ— æ³•åˆ é™¤ï¼šæ¶ˆæ¯å…ƒç´ æ²¡æœ‰UUIDã€‚");
            return;
        }

        // ã€ä¿®æ”¹ã€‘: åœ¨åˆ é™¤ UI å…ƒç´ ä¹‹å‰ï¼Œå…ˆè°ƒç”¨æˆ‘ä»¬çš„æ–°å‡½æ•°
        const isDeleted = await deleteMessage(uuid);

        if (isDeleted) {
            // ã€å…³é”®ã€‘: åªæœ‰å½“æ•°æ®æˆåŠŸä»æ•°æ®åº“ä¸­åˆ é™¤åï¼Œæ‰ä»ç•Œé¢ä¸Šç§»é™¤å…ƒç´ 
            if (messageElement && messageElement.parentNode) {
                messageElement.parentNode.removeChild(messageElement);
            }
        }
    }
    // === æ–°å¢ï¼šè”ç³»äººå¯¹è¯æ¡†é‡ç½®å‡½æ•° ===
    function resetContactModal() {
        // 1. æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†å’Œæ–‡æœ¬åŸŸ
        document.getElementById('ai-name-input').value = '';
        document.getElementById('ai-persona-input').value = '';
        document.getElementById('user-name-input').value = '';
        document.getElementById('user-persona-input').value = '';

        // 2. æ¢å¤é»˜è®¤å¤´åƒ
        document.getElementById('ai-avatar-preview').src = 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=AI';
        document.getElementById('user-avatar-preview').src = 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=User';

        // 3. é‡ç½®ä¸Šä¸‹æ–‡è®°å¿†è¾“å…¥æ¡†
        document.getElementById('context-memory-input').value = '10';

        // 4. æ¢å¤AI/Useråˆ‡æ¢å¼€å…³åˆ°é»˜è®¤çš„â€œAIâ€çŠ¶æ€
        const checkbox = document.getElementById('role-switch-checkbox');
        const labels = document.querySelectorAll('#add-contact-modal .switch-label');
        const aiForm = document.getElementById('ai-form');
        const userForm = document.getElementById('user-form');

        checkbox.checked = false;
        aiForm.classList.add('active');
        userForm.classList.remove('active');
        labels[0].classList.add('active');
        labels[1].classList.remove('active');
    }
    // ==========================================================
    // === æ–°å¢ï¼šä¸–ç•Œä¹¦åˆ†ç»„åŠŸèƒ½çš„å…¨éƒ¨ JS é€»è¾‘ ===
    // ==========================================================

    // --- 1. é¡µé¢å¯¼èˆªé€»è¾‘ ---

    // ä» ä¸–ç•Œä¹¦ -> åˆ†ç»„åˆ—è¡¨
    worldbookGroupsBtn.addEventListener('click', () => {
        phoneFrame.classList.add('show-worldbook-groups');
        loadAndRenderGroups();
    });

    // ==========================================================
    // === åˆ†ç»„åˆ—è¡¨é¡µè¿”å›æŒ‰é’® (JS V4 - æœ€ç»ˆç®€åŒ–ç‰ˆ) ===
    // ==========================================================
    worldbookGroupsBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean('worldbook-groups-list');
        // â–¼â–¼â–¼ åœ¨è¿™é‡Œæ³¨å…¥æˆ‘ä»¬çš„â€œçŠ¶æ€é‡ç½®â€é€»è¾‘ â–¼â–¼â–¼
        // 1. æ£€æŸ¥å½“å‰æ˜¯å¦æ­£å¤„äºåˆ é™¤æ¨¡å¼
        if (isGroupDeleteMode) {
            // 2. å¦‚æœæ˜¯ï¼Œå°±ä»¥ä»£ç çš„æ–¹å¼â€œç‚¹å‡»â€ä¸€ä¸‹å¤šé€‰/å–æ¶ˆæŒ‰é’®ï¼Œ
            //    è¿™ä¼šè§¦å‘å®ƒè‡ªå·±çš„ else é€»è¾‘ï¼Œå°†æ‰€æœ‰çŠ¶æ€æ¢å¤åˆ°åˆå§‹å€¼ã€‚
            groupsMultiselectBtn.click();
        }
        // â–²â–²â–² æ³¨å…¥ç»“æŸ â–²â–²â–²

        // è¿™ä¸ªæŒ‰é’®çš„åŠŸèƒ½æ°¸è¿œæ˜¯ï¼šå…³é—­åˆ†ç»„é¡µï¼Œæ˜¾ç¤ºä¸‹é¢çš„ä¸»é¡µ
        phoneFrame.classList.remove('show-worldbook-groups');
    });

    // ä» åˆ†ç»„åˆ—è¡¨ -> å•ä¸ªåˆ†ç»„è¯¦æƒ…
    worldbookGroupsList.addEventListener('click', (event) => {
        if (isGroupDeleteMode) return;
        const groupItem = event.target.closest('.contact-item');
        if (groupItem) {
            const groupId = parseInt(groupItem.dataset.groupId, 10);
            openGroupDetailView(groupId);
        }
    });

    // ä» å•ä¸ªåˆ†ç»„è¯¦æƒ… -> åˆ†ç»„åˆ—è¡¨
    groupDetailBackButton.addEventListener('click', () => {
        window.DOMCleanupManager.clean('books-in-group-list');
        
        if (typeof currentOpenGroupId !== 'undefined') {
            currentOpenGroupId = null;
        }
        phoneFrame.classList.remove('show-worldbook-group-detail');
        // æ ¸å¿ƒä¿®æ”¹ï¼šç¡®ä¿åœ¨è¿”å›æ—¶ï¼Œåˆ·æ–°çš„æ˜¯åˆ†ç»„åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ä¸»é¡µ
        loadAndRenderGroups();
    });


    // --- 2. åˆ†ç»„åˆ—è¡¨é¡µé¢çš„åŠŸèƒ½ ---

    // åŠ è½½å¹¶æ¸²æŸ“æ‰€æœ‰åˆ†ç»„
    async function loadAndRenderGroups() {
        try {
            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            const groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
            worldbookGroupsList.innerHTML = '';
            if (groups.length === 0) {
                worldbookGroupsList.innerHTML = '<p style="text-align:center; color:#888;">è¿˜æ²¡æœ‰ä»»ä½•åˆ†ç»„ã€‚</p>';
                return;
            }
            // è¿™æ˜¯ã€ä¿®æ­£åã€‘çš„æ­£ç¡®ä»£ç 
            groups.forEach(group => {
                const itemCount = Array.isArray(group.bookIds) ? group.bookIds.length : 0;
                const groupItem = document.createElement('div');
                groupItem.className = 'contact-item';
                groupItem.dataset.groupId = group.id;
                groupItem.innerHTML = `
        <input type="checkbox" class="contact-checkbox">
        <div class="contact-info">
            <div class="contact-name">${group.name}</div>
            <div class="contact-last-message">${itemCount}ä¸ªä¸–ç•Œä¹¦</div>
        </div>
    `;
                worldbookGroupsList.appendChild(groupItem);
            });
        } catch (error) {
            console.error("åŠ è½½åˆ†ç»„å¤±è´¥:", error);
        }
    }


    addWorldbookGroupBtn.addEventListener('click', async () => {
        // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨åˆ é™¤æ¨¡å¼ (é€šè¿‡åˆ¤æ–­å·¦ä¾§æŒ‰é’®æ˜¯å¦å˜èº«)
        // æˆ–è€…ç›´æ¥åˆ¤æ–­å…¨å±€å˜é‡ isGroupDeleteMode (å¦‚æœä½ æœ‰å®šä¹‰çš„è¯)
        // è¿™é‡Œæˆ‘ä»¬ç›´æ¥åˆ¤æ–­æ ·å¼ç±»å
        const isDeleteMode = addWorldbookGroupBtn.classList.contains('delete');

        if (isDeleteMode) {
            // --- å¦‚æœæ˜¯çº¢è‰²åƒåœ¾æ¡¶çŠ¶æ€ -> æ‰§è¡Œåˆ é™¤åˆ†ç»„ ---
            await handleBatchDeleteGroups();
        } else {
            // --- å¦åˆ™ -> æ‰§è¡Œæ–°å»ºåˆ†ç»„ ---
            const groupName = prompt('è¯·è¾“å…¥æ–°çš„ä¸–ç•Œä¹¦ç»„åç§°ï¼š');
            if (groupName && groupName.trim()) {
                try {
                    const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                    let groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                    const newGroup = {
                        id: Date.now(),
                        name: groupName.trim(),
                        bookIds: []
                    };
                    groups.push(newGroup);
                    await dbHelper.saveData('worldBookGroups', 'allGroups', groups);
                    loadAndRenderGroups();
                } catch (error) {
                    console.error("åˆ›å»ºåˆ†ç»„å¤±è´¥:", error);
                }
            }
        }
    });

    deleteGroupsBtn.addEventListener('click', async () => {
        const selectedCheckboxes = worldbookGroupsList.querySelectorAll('.contact-checkbox:checked');

        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„åˆ†ç»„ã€‚');
            return;
        }

        if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} ä¸ªåˆ†ç»„å—ï¼Ÿ\n(æ³¨æ„ï¼šè¿™åªä¼šåˆ é™¤åˆ†ç»„ï¼Œç»„å†…çš„ä¸–ç•Œä¹¦ä¼šä¿ç•™)`)) {
            const idsToDelete = new Set();
            selectedCheckboxes.forEach(cb => {
                // æ‰¾åˆ°å¯¹åº”çš„ LI å…ƒç´ å¹¶è·å– dataset ID
                const li = cb.closest('.contact-item');
                if (li) idsToDelete.add(parseInt(li.dataset.groupId, 10));
            });

            try {
                const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                let groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

                // è¿‡æ»¤æ‰è¦åˆ é™¤çš„
                const updatedGroups = groups.filter(g => !idsToDelete.has(g.id));

                await dbHelper.saveData('worldBookGroups', 'allGroups', updatedGroups);

                // åˆ·æ–°åˆ—è¡¨
                await loadAndRenderGroups();

                // è‡ªåŠ¨é€€å‡ºåˆ é™¤æ¨¡å¼
                exitGroupDeleteMode();

            } catch (error) {
                console.error("åˆ é™¤åˆ†ç»„å¤±è´¥:", error);
                alert("åˆ é™¤å¤±è´¥");
            }
        }
    });
    // åˆ†ç»„çš„å¤šé€‰åˆ é™¤é€»è¾‘
    // === ä¿®å¤ï¼šåˆ†ç»„åˆ—è¡¨å¤šé€‰é€»è¾‘ (é€‚é… SVG) ===
    groupsMultiselectBtn.addEventListener('click', () => {
        isGroupDeleteMode = true;
        worldbookGroupsList.classList.add('delete-mode');

        // åˆ‡æ¢é¡¶æ ï¼šéšè—æ­£å¸¸ç»„ï¼Œæ˜¾ç¤ºåˆ é™¤ç»„
        groupHeaderNormal.style.display = 'none';
        groupHeaderSelect.style.display = 'flex';
    });

    // 3. ç‚¹å‡»â€œå‰å·â€å›¾æ ‡ï¼šé€€å‡ºåˆ é™¤æ¨¡å¼
    groupsCancelSelectBtn.addEventListener('click', () => {
        exitGroupDeleteMode();
    });
    // è¾…åŠ©å‡½æ•°ï¼šé€€å‡ºé€»è¾‘å°è£…
    function exitGroupDeleteMode() {
        isGroupDeleteMode = false;
        worldbookGroupsList.classList.remove('delete-mode');

        // åˆ‡æ¢é¡¶æ ï¼šæ˜¾ç¤ºæ­£å¸¸ç»„ï¼Œéšè—åˆ é™¤ç»„
        groupHeaderNormal.style.display = 'flex';
        groupHeaderSelect.style.display = 'none';

        // å–æ¶ˆæ‰€æœ‰å‹¾é€‰
        worldbookGroupsList.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = false);
    }
    async function handleBatchDeleteGroups() {
        const selectedCheckboxes = worldbookGroupsList.querySelectorAll('.contact-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„åˆ†ç»„ã€‚');
            return;
        }
        if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} ä¸ªåˆ†ç»„å—ï¼Ÿ(æ³¨æ„ï¼šè¿™åªä¼šåˆ é™¤åˆ†ç»„ï¼Œä¸ä¼šåˆ é™¤é‡Œé¢çš„ä¸–ç•Œä¹¦)`)) {
            const idsToDelete = new Set();
            selectedCheckboxes.forEach(cb => idsToDelete.add(parseInt(cb.closest('.contact-item').dataset.groupId, 10)));
            try {
                const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                let groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                const updatedGroups = groups.filter(g => !idsToDelete.has(g.id));
                await dbHelper.saveData('worldBookGroups', 'allGroups', updatedGroups);
                loadAndRenderGroups();
                groupsMultiselectBtn.click(); // è‡ªåŠ¨é€€å‡ºåˆ é™¤æ¨¡å¼
            } catch (error) {
                console.error("åˆ é™¤åˆ†ç»„å¤±è´¥:", error);
            }
        }
    }


    // --- 3. å•ä¸ªåˆ†ç»„è¯¦æƒ…é¡µé¢çš„åŠŸèƒ½ ---

    // æ‰“å¼€åˆ†ç»„è¯¦æƒ…é¡µ
    async function openGroupDetailView(groupId) {
        currentOpenGroupId = groupId;
        try {
            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            // è¿™æ˜¯ä¿®æ­£åçš„ä»£ç 
            const group = ((groupsData && groupsData.value) || []).find(g => g.id === groupId);
            if (!group) { alert('æ‰¾ä¸åˆ°è¯¥åˆ†ç»„ï¼'); return; }

            const booksData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            // è¿™æ˜¯ä¿®æ­£åçš„ä»£ç 
            const allBooks = (booksData && booksData.value) || [];

            const bookIdsInGroup = new Set(group.bookIds || []);
            const booksInGroup = allBooks.filter(book => bookIdsInGroup.has(book.id));

            groupDetailTitle.textContent = group.name;
            booksInGroupList.innerHTML = ''; // æ¸…ç©º

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåˆ¤æ–­åˆ†ç»„æ˜¯å¦ä¸ºç©º â–¼â–¼â–¼
            if (booksInGroup.length === 0) {
                const newBookButton = document.createElement('button');
                newBookButton.className = 'empty-state-add-button';
                newBookButton.textContent = 'æ–°å»ºä¸–ç•Œä¹¦';
                // ç‚¹å‡»è¿™ä¸ªæŒ‰é’®æ—¶ï¼Œæ¨¡æ‹Ÿç‚¹å‡»é¡¶æ çš„â€œæ–°å»ºâ€æŒ‰é’®
                newBookButton.onclick = () => addBookInGroupBtn.click();
                booksInGroupList.appendChild(newBookButton);
            } else {
                // å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™æ­£å¸¸æ¸²æŸ“åˆ—è¡¨
                renderWorldBooksToContainer(booksInGroup, booksInGroupList);
            }
            phoneFrame.classList.add('show-worldbook-group-detail');
        } catch (error) {
            console.error("æ‰“å¼€åˆ†ç»„è¯¦æƒ…å¤±è´¥:", error);
        }
    }
    // åœ¨ç»„å†…æ–°å»ºä¸–ç•Œä¹¦
    addBookInGroupBtn.addEventListener('click', () => {
        // ç›´æ¥è°ƒç”¨å·²æœ‰çš„ã€æ­£ç¡®çš„å¼¹çª—å‡½æ•°ï¼Œå¹¶ä¼ å…¥ null è¡¨ç¤ºè¿›å…¥â€œæ–°å»ºâ€æ¨¡å¼
        openWorldbookModal(null);
    });

    // ç»„å†…ä¸–ç•Œä¹¦çš„å¤šé€‰åˆ é™¤é€»è¾‘
    groupDetailMultiselectBtn.addEventListener('click', () => {
        isBookInGroupDeleteMode = true;
        booksInGroupList.classList.add('delete-mode');

        // åˆ‡æ¢é¡¶æ æŒ‰é’®çš„æ˜¾ç¤º
        groupDetailHeaderNormal.style.display = 'none';
        groupDetailHeaderSelect.style.display = 'flex';
    });
    // ä¸ºæ–°çš„â€œåˆ é™¤æ‰€é€‰â€æŒ‰é’®ç»‘å®šäº‹ä»¶
    deleteBooksInGroupBtn.addEventListener('click', () => {
        handleBatchDeleteBooksInGroup();
    });
    // 2. æ–°å¢ï¼šâ€œå–æ¶ˆâ€æŒ‰é’®è´Ÿè´£é€€å‡ºå¤šé€‰æ¨¡å¼
    groupDetailCancelSelectBtn.addEventListener('click', () => {
        isBookInGroupDeleteMode = false;
        booksInGroupList.classList.remove('delete-mode');

        // åˆ‡æ¢å›æ­£å¸¸çš„é¡¶æ æŒ‰é’®
        groupDetailHeaderNormal.style.display = 'flex';
        groupDetailHeaderSelect.style.display = 'none';

        // å–æ¶ˆæ‰€æœ‰å‹¾é€‰
        booksInGroupList.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = false);
    });

    async function handleBatchDeleteBooksInGroup() {
        const selectedCheckboxes = booksInGroupList.querySelectorAll('.contact-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„ä¸–ç•Œä¹¦ã€‚');
            return;
        }
        if (confirm(`ç¡®å®šè¦ä»æ‰‹æœºä¸­æ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} ä¸ªä¸–ç•Œä¹¦å—ï¼Ÿ`)) {
            const idsToDelete = new Set();
            selectedCheckboxes.forEach(cb => idsToDelete.add(parseInt(cb.closest('.contact-item').dataset.bookId, 10)));
            try {
                // 1. ä»ä¸»ä¸–ç•Œä¹¦åˆ—è¡¨åˆ é™¤
                const booksData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
                let allBooks = booksData.value || [];
                const updatedBooks = allBooks.filter(book => !idsToDelete.has(book.id));
                await dbHelper.saveData('worldBooks', 'allWorldBooks', updatedBooks);

                // 2. ä»æ‰€æœ‰åˆ†ç»„ä¸­ç§»é™¤è¿™äº›ä¹¦çš„ID
                const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                let allGroups = groupsData.value || [];
                allGroups.forEach(group => {
                    group.bookIds = group.bookIds.filter(id => !idsToDelete.has(id));
                });
                await dbHelper.saveData('worldBookGroups', 'allGroups', allGroups);

                // 3. åˆ·æ–°è§†å›¾å¹¶é€€å‡ºåˆ é™¤æ¨¡å¼
                openGroupDetailView(currentOpenGroupId);
                groupDetailMultiselectBtn.click();
            } catch (error) {
                console.error("åˆ é™¤ä¸–ç•Œä¹¦å¤±è´¥:", error);
            }
        }
    }


    /// ==========================================================
    // === ç§»åŠ¨ä¸–ç•Œä¹¦åˆ°åˆ†ç»„çš„åŠŸèƒ½ (JS V5 - æ™ºèƒ½åˆ‡æ¢ç‰ˆ) ===
    // ==========================================================

    // --- â€œå¤šé€‰â€æŒ‰é’®é€»è¾‘ (ä¸å˜) ---
    worldbookMultiselectBtn.addEventListener('click', () => {
        isWorldbookDeleteMode = true;
        worldbookListContainer.classList.add('delete-mode');
        worldbookHeaderNormal.style.display = 'none';
        worldbookHeaderSelect.style.display = 'flex';
    });

    // --- â€œå–æ¶ˆâ€æŒ‰é’®é€»è¾‘ (ä¸å˜) ---
    worldbookCancelSelectBtn.addEventListener('click', () => {
        isWorldbookDeleteMode = false;
        worldbookListContainer.classList.remove('delete-mode');
        worldbookHeaderNormal.style.display = 'flex';
        worldbookHeaderSelect.style.display = 'none';
        worldbookListContainer.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = false);
    });

    // --- â€œç§»åŠ¨â€æŒ‰é’®æ‰“å¼€å¼¹å‡ºæ¡† (ä¸å˜) ---
    moveBooksBtn.addEventListener('click', async () => {
        const selectedCheckboxes = worldbookListContainer.querySelectorAll('.contact-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ç§»åŠ¨çš„ä¸–ç•Œä¹¦ã€‚');
            return;
        }
        try {
            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            const groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
            groupSelectionList.innerHTML = '';
            if (groups.length > 0) {
                groups.forEach(group => {
                    const item = document.createElement('div');
                    item.className = 'group-selection-item';
                    item.dataset.groupId = group.id;
                    item.textContent = group.name;
                    groupSelectionList.appendChild(item);
                });
            } else {
                groupSelectionList.innerHTML = '<p style="text-align:center; color:#888;">æ²¡æœ‰å¯ç”¨çš„åˆ†ç»„</p>';
            }
            moveToGroupModal.style.display = 'flex';
            setTimeout(() => moveToGroupModal.style.opacity = '1', 10);
        } catch (error) {
            console.error("åŠ è½½åˆ†ç»„åˆ°å¼¹çª—å¤±è´¥:", error);
        }
    });

    // --- å…³é—­ç§»åŠ¨å¼¹å‡ºæ¡† (ä¸å˜) ---
    moveToGroupModalCloseBtn.addEventListener('click', () => {
        moveToGroupModal.style.opacity = '0';
        setTimeout(() => moveToGroupModal.style.display = 'none', 300);
    });

    // ç”¨ä¸‹é¢è¿™æ®µä»£ç ï¼Œå®Œæ•´æ›¿æ¢æ‰ä½ åŸæ¥çš„ groupSelectionList.addEventListener('click', ...)
    groupSelectionList.addEventListener('click', async (event) => {
        const targetGroupItem = event.target.closest('.group-selection-item');
        if (!targetGroupItem) return;

        const targetGroupId = parseInt(targetGroupItem.dataset.groupId, 10);

        // æ™ºèƒ½æ£€æµ‹ï¼šæ˜¯åœ¨ä¸»åˆ—è¡¨ï¼ˆæœªåˆ†ç»„ï¼‰è¿˜æ˜¯åœ¨åˆ†ç»„è¯¦æƒ…é¡µè¿›è¡Œçš„å¤šé€‰
        const selectedInUngrouped = worldbookListContainer.querySelectorAll('.contact-checkbox:checked');
        const selectedInGroup = booksInGroupList.querySelectorAll('.contact-checkbox:checked');

        let bookIdsToMove = new Set();
        let sourceGroupId = null; // ç”¨æ¥è®°å½•æºåˆ†ç»„ID

        if (selectedInGroup.length > 0) {
            // åœºæ™¯Aï¼šä»åˆ†ç»„è¯¦æƒ…é¡µç§»åŠ¨
            selectedInGroup.forEach(cb => bookIdsToMove.add(parseInt(cb.closest('.contact-item').dataset.bookId, 10)));
            sourceGroupId = currentOpenGroupId; // æºåˆ†ç»„å°±æ˜¯å½“å‰æ‰“å¼€çš„åˆ†ç»„
        } else if (selectedInUngrouped.length > 0) {
            // åœºæ™¯Bï¼šä»ä¸»åˆ—è¡¨ï¼ˆæœªåˆ†ç»„ï¼‰ç§»åŠ¨ (è¿™æ˜¯åŸæ¥çš„é€»è¾‘)
            selectedInUngrouped.forEach(cb => bookIdsToMove.add(parseInt(cb.closest('.contact-item').dataset.bookId, 10)));
            // sourceGroupId ä¿æŒä¸º nullï¼Œè¡¨ç¤ºæ¥è‡ªâ€œæœªåˆ†ç»„â€
        } else {
            return; // æ²¡æœ‰é€‰ä¸­ä»»ä½•ä¸œè¥¿
        }

        try {
            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            let groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

            // æ ¸å¿ƒé€»è¾‘1ï¼šä»æºåˆ†ç»„ç§»é™¤ (å¦‚æœå­˜åœ¨æºåˆ†ç»„)
            if (sourceGroupId) {
                const sourceGroup = groups.find(g => g.id === sourceGroupId);
                if (sourceGroup && Array.isArray(sourceGroup.bookIds)) {
                    sourceGroup.bookIds = sourceGroup.bookIds.filter(id => !bookIdsToMove.has(id));
                }
            }

            // æ ¸å¿ƒé€»è¾‘2ï¼šæ·»åŠ åˆ°ç›®æ ‡åˆ†ç»„
            const targetGroup = groups.find(g => g.id === targetGroupId);
            if (targetGroup) {
                if (!Array.isArray(targetGroup.bookIds)) targetGroup.bookIds = [];
                // ä½¿ç”¨ Set æ¥è‡ªåŠ¨å¤„ç†é‡å¤é—®é¢˜ï¼Œç„¶åè½¬å›æ•°ç»„
                targetGroup.bookIds = [...new Set([...targetGroup.bookIds, ...bookIdsToMove])];
            }

            // å°†ä¿®æ”¹åçš„åˆ†ç»„æ•°æ®å®Œæ•´ä¿å­˜å›æ•°æ®åº“
            await dbHelper.saveData('worldBookGroups', 'allGroups', groups);
            alert('ç§»åŠ¨æˆåŠŸï¼');
            moveToGroupModalCloseBtn.click(); // å…³é—­å¼¹çª—

            // æ ¹æ®ç§»åŠ¨åœºæ™¯ï¼Œåˆ·æ–°å¯¹åº”çš„è§†å›¾
            if (sourceGroupId) {
                openGroupDetailView(sourceGroupId); // åˆ·æ–°å½“å‰åˆ†ç»„è¯¦æƒ…é¡µ
                groupDetailCancelSelectBtn.click(); // é€€å‡ºå¤šé€‰æ¨¡å¼
            } else {
                loadAndRenderUngroupedWorldBooks(); // åˆ·æ–°ä¸»é¡µçš„æœªåˆ†ç»„åˆ—è¡¨
                worldbookCancelSelectBtn.click(); // é€€å‡ºå¤šé€‰æ¨¡å¼
            }

        } catch (error) {
            console.error("ç§»åŠ¨ä¸–ç•Œä¹¦å¤±è´¥:", error);
            alert("æ“ä½œå¤±è´¥ï¼");
        }
    });
    // --- 5. è¾…åŠ©å‡½æ•° ---

    // è¿™æ˜¯ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºå°†ä¸–ç•Œä¹¦æ¸²æŸ“åˆ°æŒ‡å®šçš„å®¹å™¨ï¼Œé¿å…ä»£ç é‡å¤
    function renderWorldBooksToContainer(books, container) {
        container.innerHTML = ''; // å…ˆæ¸…ç©º
        books.forEach(book => {
            const bookItem = document.createElement('div');
            bookItem.className = 'contact-item';
            bookItem.dataset.bookId = book.id;
            bookItem.innerHTML = `
            <input type="checkbox" class="contact-checkbox">
            <div class="contact-info">
                <div class="contact-name">${book.name}</div>
                <div class="contact-last-message" style="white-space: normal;">${(book.content || '').substring(0, 50)}...</div>
            </div>
        `;
            // ä¸ºç»„å†…è¯¦æƒ…é¡µçš„åˆ—è¡¨é¡¹ä¹Ÿç»‘å®šåŒå‡»ç¼–è¾‘äº‹ä»¶
            bookItem.addEventListener('click', (e) => {
                if (isBookInGroupDeleteMode || e.target.type === 'checkbox') return;
                openWorldbookModal(book.id);
            });
            container.appendChild(bookItem);
        });
    }

    // ä¿®æ”¹åŸæœ‰çš„ loadAndRenderWorldBooksï¼Œè®©å®ƒä¹Ÿä½¿ç”¨è¿™ä¸ªè¾…åŠ©å‡½æ•°
    async function loadAndRenderWorldBooks() {
        const existingData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
        const books = (existingData && Array.isArray(existingData.value)) ? existingData.value : [];
        // ç°åœ¨å®ƒè°ƒç”¨äº†æ–°çš„è¾…åŠ©å‡½æ•°ï¼Œå¹¶æŒ‡å®šäº†ä¸»åˆ—è¡¨å®¹å™¨
        renderWorldBooksToContainer(books, worldbookListContainer);
    }
    // ==========================================================
    // === æ¸²æŸ“æœªåˆ†ç»„çš„ä¸–ç•Œä¹¦ (JS V2 - æ™ºèƒ½åˆ‡æ¢ç‰ˆ) ===
    // ==========================================================

    /**
     * ã€å…¨æ–°ã€‘æ ¸å¿ƒå‡½æ•°ï¼šåŠ è½½å¹¶åªæ¸²æŸ“æœªè¢«åˆ†ç»„çš„ä¸–ç•Œä¹¦ã€‚
     * å¦‚æœæ‰€æœ‰ä¸–ç•Œä¹¦éƒ½å·²è¢«åˆ†ç»„ï¼Œåˆ™è‡ªåŠ¨è·³è½¬åˆ°åˆ†ç»„åˆ—è¡¨é¡µã€‚
     */
    // ==========================================================
    // === æ¸²æŸ“æœªåˆ†ç»„çš„ä¸–ç•Œä¹¦ (JS V4 - æœ€ç»ˆç®€åŒ–ç‰ˆ) ===
    // ==========================================================
    /**
     * ã€å…¨æ–°ç®€åŒ–ç‰ˆã€‘æ ¸å¿ƒå‡½æ•°ï¼šåªæ¸²æŸ“æœªåˆ†ç»„çš„ä¸–ç•Œä¹¦ã€‚
     * å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œåˆ™æ˜¾ç¤ºæç¤ºä¿¡æ¯ï¼Œä¸å†è‡ªåŠ¨è·³è½¬ã€‚
     */
    async function loadAndRenderUngroupedWorldBooks() {
        try {
            const booksData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            const allBooks = (booksData && Array.isArray(booksData.value)) ? booksData.value : [];

            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

            const groupedBookIds = new Set();
            allGroups.forEach(group => {
                if (Array.isArray(group.bookIds)) {
                    group.bookIds.forEach(id => groupedBookIds.add(id));
                }
            });

            const ungroupedBooks = allBooks.filter(book => !groupedBookIds.has(book.id));

            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šä¸å†è‡ªåŠ¨è·³è½¬ï¼Œè€Œæ˜¯æ˜¾ç¤ºæç¤º â–¼â–¼â–¼
            if (ungroupedBooks.length === 0) {
                worldbookListContainer.innerHTML = '<p style="text-align:center; color:#888; padding-top: 40px;">æ‰€æœ‰ä¸–ç•Œä¹¦éƒ½å·²åˆ†ç»„ã€‚<br><br>è¯·ç‚¹å‡»å³ä¸Šè§’çš„â€œç»„â€æŒ‰é’®æŸ¥çœ‹ã€‚</p>';
            } else {
                renderWorldBooksToContainer(ungroupedBooks, worldbookListContainer);
            }

            // ç¡®ä¿å¤šé€‰æ¨¡å¼å·²å…³é—­
            if (isWorldbookDeleteMode) {
                worldbookCancelSelectBtn.click();
            }
        } catch (error) {
            console.error("åŠ è½½æœªåˆ†ç»„ä¸–ç•Œä¹¦å¤±è´¥:", error);
        }
    }
    /**
     * æ¸²æŸ“ä¸€ä¸ªåŒ…å«å¯æ‰§è¡Œè„šæœ¬çš„HTMLå­—ç¬¦ä¸²åˆ°æŒ‡å®šå®¹å™¨
     * @param {HTMLElement} container - è¦æ¸²æŸ“åˆ°çš„DOMå…ƒç´ ï¼Œä¾‹å¦‚ä¸€ä¸ªèŠå¤©æ°”æ³¡
     * @param {string} htmlString - åŒ…å«HTMLå’Œ<script>æ ‡ç­¾çš„å®Œæ•´å­—ç¬¦ä¸²
     */
    function renderInteractiveHtml(container, htmlString) {
        // 1. ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‰¾åˆ°å¹¶æå–<script>æ ‡ç­¾å†…çš„ä»£ç 
        const scriptRegex = /<script>([\s\S]*?)<\/script>/i;
        const scriptMatch = htmlString.match(scriptRegex);
        const javascriptCode = scriptMatch ? scriptMatch[1] : '';

        // 2. ä»åŸå§‹HTMLå­—ç¬¦ä¸²ä¸­ç§»é™¤<script>æ ‡ç­¾ï¼Œå¾—åˆ°çº¯å‡€çš„HTML
        const pureHtml = htmlString.replace(scriptRegex, '');

        // 3. å°†çº¯å‡€çš„HTMLæ¸²æŸ“åˆ°å®¹å™¨ä¸­
        container.innerHTML = pureHtml;

        // 4. å¦‚æœæå–åˆ°äº†JavaScriptä»£ç ï¼Œå°±æ‰‹åŠ¨æ‰§è¡Œå®ƒ
        if (javascriptCode) {
            try {
                // ä½¿ç”¨ new Function() æ¥æ‰§è¡Œå­—ç¬¦ä¸²å½¢å¼çš„ä»£ç 
                new Function(javascriptCode)();
                console.log("äº¤äº’è„šæœ¬å·²æˆåŠŸæ¿€æ´»ï¼");
            } catch (e) {
                console.error("æ¿€æ´»HTMLæ¶ˆæ¯çš„äº¤äº’è„šæœ¬æ—¶å¤±è´¥:", e);
            }
        }
    }


    // ==========================================================
    // === æœ€ç»ˆç‰ˆï¼šé•¿æŒ‰å¼¹çª—æ‰“å­—åŠŸèƒ½çš„æ ¸å¿ƒ JS é€»è¾‘ ===
    // ==========================================================
    function initializeVoiceInput() {

        // --- 1. è·å–æ‰€æœ‰éœ€è¦çš„å…ƒç´  ---
        const voiceInputToggle = document.getElementById('voice-input-toggle');
        const micIcon = document.getElementById('mic-icon');
        const keyboardIcon = document.getElementById('keyboard-icon');
        const voiceRecordButton = document.getElementById('voice-record-button');

        // è·å–æ–‡æœ¬è¾“å…¥é¢æ¿çš„å…ƒç´ 
        const textInputPanel = document.getElementById('voice-input-panel');
        const textInputPreview = document.getElementById('voice-transcript-preview');
        const cancelTextInputBtn = document.getElementById('cancel-voice-input-btn');
        const sendTextInputBtn = document.getElementById('send-voice-input-btn');

        // --- 2. åˆå§‹åŒ–å˜é‡ ---
        let longPressTimer;

        // --- 3. å®šä¹‰æ‰“å¼€å’Œå…³é—­æ–‡æœ¬è¾“å…¥é¢æ¿çš„å‡½æ•° ---
        function openTextInputPanel() {
            // ã€BUGä¿®å¤ã€‘æ¯æ¬¡æ‰“å¼€æ—¶ï¼Œéƒ½æ¸…ç©ºæ–‡æœ¬æ¡†å†…å®¹
            textInputPreview.value = '';
            textInputPanel.classList.add('visible');
            
            // --- ä¿®å¤è§¦æ‘¸ç©¿é€é—®é¢˜ ---
            // è·å–å†…éƒ¨å†…å®¹å®¹å™¨
            const contentDiv = textInputPanel.querySelector('.voice-panel-content');
            if (contentDiv) {
                // 1. ç¡®ä¿åˆå§‹ç§»é™¤äº† active ç±» (CSSä¸­ pointer-events: none)
                contentDiv.classList.remove('active');
                
                // 2. çŸ­æš‚å»¶è¿Ÿåæ·»åŠ  active ç±» (å¯ç”¨äº¤äº’)
                // 300ms è¶³å¤Ÿè®©æ‰‹æŒ‡ç¦»å¼€å±å¹•ï¼Œé˜²æ­¢è¯¯è§¦
                setTimeout(() => {
                    contentDiv.classList.add('active');
                }, 300);
            }
            
            // è‡ªåŠ¨èšç„¦åˆ°æ–‡æœ¬æ¡†ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥è¾“å…¥
            // æ³¨æ„ï¼šiOSä¸ŠæŸäº›æƒ…å†µå¯èƒ½æ— æ³•è‡ªåŠ¨èšç„¦ï¼Œä½†è¿™ä¸å½±å“è¯¯è§¦ä¿®å¤
            setTimeout(() => {
                textInputPreview.focus();
            }, 350); // èšç„¦ä¹Ÿç¨å¾®å»¶è¿Ÿä¸€ä¸‹
        }

        function closeTextInputPanel() {
            textInputPanel.classList.remove('visible');
            // é‡ç½®å†…å®¹å®¹å™¨çŠ¶æ€
            const contentDiv = textInputPanel.querySelector('.voice-panel-content');
            if (contentDiv) {
                contentDiv.classList.remove('active');
            }
        }

        // --- 4. å®šä¹‰é•¿æŒ‰å¼€å§‹å’Œç»“æŸçš„å‡½æ•° ---
        function startLongPress(e) {
            e.preventDefault();
            voiceRecordButton.classList.add('active-recording'); // è§¦å‘æ”¶ç¼©åŠ¨ç”»
            // è®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œé•¿æŒ‰è¶…è¿‡300æ¯«ç§’åˆ™æ‰“å¼€é¢æ¿
            longPressTimer = setTimeout(() => {
                openTextInputPanel();
            }, 300);
        }

        function cancelLongPress() {
            // å¦‚æœåœ¨300æ¯«ç§’å†…æ¾å¼€ï¼Œåˆ™æ¸…é™¤è®¡æ—¶å™¨ï¼Œä»€ä¹ˆä¹Ÿä¸åš
            clearTimeout(longPressTimer);
            voiceRecordButton.classList.remove('active-recording'); // ç§»é™¤æ”¶ç¼©åŠ¨ç”»
        }

        // --- 5. ç»‘å®šæ‰€æœ‰äº‹ä»¶ ---

        // åˆ‡æ¢ é”®ç›˜/è¯­éŸ³ æ¨¡å¼çš„æŒ‰é’® (é€»è¾‘ä¸å˜)
        voiceInputToggle.addEventListener('click', () => {
            if (!voiceRecordButton || !chatMessageInput || !micIcon || !keyboardIcon) return;
            const isVoiceMode = voiceRecordButton.style.display !== 'none';
            if (isVoiceMode) {
                // åˆ‡æ¢å›â€œé”®ç›˜æ¨¡å¼â€
                voiceRecordButton.style.display = 'none';
                chatMessageInput.style.display = 'block';
                micIcon.style.display = 'block';
                keyboardIcon.style.display = 'none';
                // â–¼â–¼â–¼ æ–°å¢ä»£ç ï¼šæ˜¾ç¤ºè¡¨æƒ…åŒ…æŒ‰é’® â–¼â–¼â–¼
                chatEmojiButton.style.display = 'flex';
            } else {
                // åˆ‡æ¢åˆ°â€œè¯­éŸ³æ¨¡å¼â€
                voiceRecordButton.style.display = 'block';
                chatMessageInput.style.display = 'none';
                micIcon.style.display = 'none';
                keyboardIcon.style.display = 'block';
                chatScreen.classList.remove('emoji-panel-active');
                // â–¼â–¼â–¼ æ–°å¢ä»£ç ï¼šéšè—è¡¨æƒ…åŒ…æŒ‰é’® â–¼â–¼â–¼
                chatEmojiButton.style.display = 'none';
            }
        });

        // ä¸ºâ€œæŒ‰ä½ è¯´è¯â€æŒ‰é’®ç»‘å®šé•¿æŒ‰é€»è¾‘
        voiceRecordButton.addEventListener('mousedown', startLongPress);
        voiceRecordButton.addEventListener('touchstart', startLongPress);
        voiceRecordButton.addEventListener('mouseup', cancelLongPress);
        voiceRecordButton.addEventListener('touchend', cancelLongPress);
        voiceRecordButton.addEventListener('mouseleave', cancelLongPress);

        // ä¸ºé¢æ¿å†…çš„â€œå‘é€â€æŒ‰é’®ç»‘å®šäº‹ä»¶ (å·²ä¿®å¤æ—¶é•¿è®¡ç®—)
        sendTextInputBtn.addEventListener('click', () => {
            const transcript = textInputPreview.value.trim();
            if (transcript) {

                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œ â–¼â–¼â–¼
                // æ–°çš„è®¡ç®—å…¬å¼ï¼šæ¯3ä¸ªå­—ç®—1ç§’ï¼Œç»“æœå‘ä¸Šå–æ•´ï¼Œä¸”ä¿åº•ä¸º1ç§’ã€‚
                const duration = Math.max(1, Math.ceil(transcript.length / 3));
                // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

                const voiceTextMessage = {
                    type: 'voice_text',
                    transcript: transcript,
                    duration: duration,
                    text: `[è¯­éŸ³æ¶ˆæ¯ ${duration}s]`
                };
                sendMessage(voiceTextMessage);
            }
            closeTextInputPanel();
        });
        // ä¸ºé¢æ¿å†…çš„â€œå–æ¶ˆâ€æŒ‰é’®ç»‘å®šäº‹ä»¶
        cancelTextInputBtn.addEventListener('click', closeTextInputPanel);


    }
    async function handleMoveBooksFromGroup() {
        // 1. æ‰¾åˆ°åœ¨å½“å‰åˆ†ç»„è¯¦æƒ…é¡µä¸­æ‰€æœ‰è¢«å‹¾é€‰çš„ä¹¦ç±
        const selectedCheckboxes = booksInGroupList.querySelectorAll('.contact-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ç§»åŠ¨çš„ä¸–ç•Œä¹¦ã€‚');
            return;
        }

        // 2. ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰åˆ†ç»„
        const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
        const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

        // 3. æ ¸å¿ƒï¼šè¿‡æ»¤æ‰å½“å‰æ‰€åœ¨çš„åˆ†ç»„ï¼Œç”Ÿæˆå¯ç§»åŠ¨çš„ç›®æ ‡åˆ†ç»„åˆ—è¡¨
        const destinationGroups = allGroups.filter(g => g.id !== currentOpenGroupId);

        // 4. å°†ç›®æ ‡åˆ†ç»„å¡«å……åˆ°å¼¹çª—çš„åˆ—è¡¨ä¸­
        groupSelectionList.innerHTML = ''; // æ¸…ç©ºæ—§åˆ—è¡¨
        if (destinationGroups.length > 0) {
            destinationGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'group-selection-item';
                item.dataset.groupId = group.id;
                item.textContent = group.name;
                groupSelectionList.appendChild(item);
            });
        } else {
            groupSelectionList.innerHTML = '<p style="text-align:center; color:#888;">æ²¡æœ‰å…¶ä»–å¯ç§»åŠ¨çš„åˆ†ç»„</p>';
        }

        // 5. æ‰“å¼€å¼¹çª—
        moveToGroupModal.style.display = 'flex';
        setTimeout(() => moveToGroupModal.style.opacity = '1', 10);
    }

    /**
     * æ ¸å¿ƒåŠŸèƒ½ï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ”¶é›†æ‰€æœ‰è®¾ç½®é¡¹å¹¶ä¿å­˜åˆ°æ•°æ®åº“
     */
    async function saveAllSettings() {
        try {
            // a. æ”¶é›†æ‰€æœ‰APIç›¸å…³çš„è®¾ç½®åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­
            const apiSettings = {
                url: apiUrlInput.value.trim(),
                key: apiKeyInput.value.trim(),
                model: modelSelect.value,
                temperature: parseFloat(tempSlider.value) || 1.0,
            };
            // b. å°†è¿™ä¸ªAPIå¯¹è±¡æ•´ä½“ä¿å­˜
            await dbHelper.saveData('settingsStore', 'apiSettings', apiSettings);

            // c. åˆ†åˆ«ä¿å­˜å…¶ä»–å¼€å…³é¡¹çš„è®¾ç½®

            await dbHelper.saveData('settingsStore', 'isFullscreenEnabled', fullscreenToggle.checked);
            await dbHelper.saveData('settingsStore', 'darkModeEnabled', darkModeToggle.checked);

            // d. æç¤ºç”¨æˆ·ä¿å­˜æˆåŠŸ
            alert('æ‰€æœ‰è®¾ç½®å·²ä¿å­˜ï¼');

        } catch (error) {
            console.error("ä¿å­˜æ‰€æœ‰è®¾ç½®å¤±è´¥:", error);
            alert("ä¿å­˜å¤±è´¥");
        }
    }

    // 2. ä¸ºä¿å­˜æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»æ—¶è°ƒç”¨ä¸Šé¢çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
    saveAllSettingsBtn.addEventListener('click', saveAllSettings);

    // â–¼â–¼â–¼ ç²˜è´´è¿™ä¸ªæ–°å‡½æ•° â–¼â–¼â–¼
    /**
     * å°†è¯­éŸ³æ¶ˆæ¯çš„æ–‡å­—éƒ¨åˆ†è½¬æ¢ä¸ºå¯ç¼–è¾‘çŠ¶æ€
     * @param {HTMLElement} transcriptElement - è¦ç¼–è¾‘çš„ .voice-transcript å…ƒç´ 
     */
    function makeTranscriptEditable(transcriptElement) {
        const bubble = transcriptElement.closest('.voice-text-bubble');
        const messageRow = bubble.closest('.message-row');
        if (!messageRow || !messageRow.dataset.uuid) return;

        const currentText = transcriptElement.textContent.trim();
        const uuid = messageRow.dataset.uuid;

        const textarea = document.createElement('textarea');
        textarea.className = 'editing-bubble'; // å¤ç”¨å·²æœ‰çš„ç¼–è¾‘æ¡†æ ·å¼
        textarea.value = currentText;

        // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        setTimeout(() => {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }, 0);

        // æ›¿æ¢å†…å®¹
        transcriptElement.innerHTML = '';
        transcriptElement.appendChild(textarea);
        textarea.focus();

        // ç»‘å®šäº‹ä»¶ï¼Œç”¨äºä¿å­˜æˆ–å–æ¶ˆ
        const handleFinish = async (saveChanges) => {
            const newText = textarea.value.trim();
            if (saveChanges && newText && newText !== currentText) {
                await updateMessageInDatabase(uuid, newText);
            } else {
                // æ¢å¤åŸå§‹å†…å®¹
                transcriptElement.textContent = currentText;
            }
        };

        textarea.addEventListener('blur', () => handleFinish(true));
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleFinish(true);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                handleFinish(false);
            }
        });
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´å…¨æ–°çš„è¾…åŠ©å‡½æ•° â–¼â–¼â–¼
    /**
     * æ™ºèƒ½æ£€æµ‹ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºHTML
     * @param {string} str - è¦æ£€æµ‹çš„å­—ç¬¦ä¸²
     * @returns {boolean}
     */
    function isHtmlString(str) {
        if (typeof str !== 'string') return false;
        // è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¼šæ£€æŸ¥å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«ä»»ä½• <tag> ç»“æ„
        const htmlRegex = /<[a-z][\s\S]*>/i;
        return htmlRegex.test(str);
    }

    imageFeatureButton.addEventListener('click', () => {
        // è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
        chatImageUploadInput.click();
        // ç«‹å³å…³é—­åŠŸèƒ½é¢æ¿ï¼Œæä¾›æµç•…çš„ä½“éªŒ
        moreFeaturesPanel.classList.remove('active');
    });

    // 3. å½“ç”¨æˆ·é€‰æ‹©äº†å›¾ç‰‡æ–‡ä»¶åï¼Œæ‰§è¡Œæ­¤å‡½æ•°
    chatImageUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
            return; // å¦‚æœç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
        }

        // ä½¿ç”¨ FileReader å°†å›¾ç‰‡æ–‡ä»¶è½¬æ¢ä¸º Base64 æ ¼å¼
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageDataUrl = e.target.result;

            // åˆ›å»ºä¸€ä¸ªå›¾ç‰‡æ¶ˆæ¯å¯¹è±¡
            const imageMessage = {
                sender: 'user',
                type: 'image', // æˆ‘ä»¬å¯ä»¥å¤ç”¨ sticker çš„æ ·å¼æ¥æ˜¾ç¤ºå›¾ç‰‡
                url: imageDataUrl,
                text: '[å›¾ç‰‡]', // è¿™æ˜¯ç»™AIå’Œå†å²è®°å½•çœ‹çš„å†…éƒ¨æ–‡æœ¬
                timestamp: new Date(),
                uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
            };

            // è°ƒç”¨ä½ å·²æœ‰çš„ sendMessage å‡½æ•°æ¥å‘é€
            sendMessage(imageMessage);
        };
        reader.readAsDataURL(file);

        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©æ¡†çš„å€¼ï¼Œä»¥ä¾¿ç”¨æˆ·ä¸‹æ¬¡å¯ä»¥é€‰æ‹©åŒä¸€å¼ å›¾ç‰‡
        event.target.value = '';
    });


    // ... (åœ¨ä½ å·²æœ‰çš„JSä»£ç ä¸­æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œæ¯”å¦‚å…¶ä»–æŒ‰é’®äº‹ä»¶ç›‘å¬çš„åŒºåŸŸ)

    // â–¼â–¼â–¼ æ–°å¢ï¼šå›¾æ ‡åŒ…é¢„è®¾åŠŸèƒ½çš„å…¨éƒ¨äº¤äº’é€»è¾‘ â–¼â–¼â–¼

    // 1. å¯¼èˆªé€»è¾‘ï¼šåœ¨â€œç¾åŒ–â€å’Œâ€œé¢„è®¾ç®¡ç†â€é¡µé¢ä¹‹é—´åˆ‡æ¢
    managePresetsButton.addEventListener('click', () => {
        phoneFrame.classList.add('show-presets');
        renderPresetList(); // æ¯æ¬¡æ‰“å¼€éƒ½é‡æ–°æ¸²æŸ“åˆ—è¡¨
    });

    presetBackButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-presets');
    });


    // 2. æ ¸å¿ƒåŠŸèƒ½ï¼šå°†å½“å‰å›¾æ ‡è®¾ç½®ä¿å­˜ä¸ºä¸€ä¸ªæ–°çš„é¢„è®¾
    savePresetButton.addEventListener('click', async () => {
        const presetName = prompt("è¯·è¾“å…¥é¢„è®¾åç§°ï¼š");
        if (!presetName || !presetName.trim()) {
            alert("é¢„è®¾åç§°ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }

        try {
            // a. è·å–å½“å‰æ­£åœ¨ä½¿ç”¨çš„å›¾æ ‡é…ç½®
            const currentIconsData = await dbHelper.loadData('settingsStore', 'customAppIcons');
            const currentIcons = (currentIconsData && currentIconsData.value) ? currentIconsData.value : {};

            // b. åˆ›å»ºæ–°çš„é¢„è®¾å¯¹è±¡
            const newPreset = {
                id: Date.now(),
                name: presetName.trim(),
                icons: currentIcons
            };

            // c. è¯»å–æ—§çš„é¢„è®¾åˆ—è¡¨ï¼Œå°†æ–°çš„é¢„è®¾æ·»åŠ è¿›å»
            const presetsData = await dbHelper.loadData('iconPresets', 'allPresets');
            let allPresets = (presetsData && Array.isArray(presetsData.value)) ? presetsData.value : [];
            allPresets.unshift(newPreset); // æ·»åŠ åˆ°æœ€å‰é¢

            // d. ä¿å­˜å›æ•°æ®åº“
            await dbHelper.saveData('iconPresets', 'allPresets', allPresets);
            alert(`é¢„è®¾ "${newPreset.name}" å·²æˆåŠŸä¿å­˜ï¼`);

        } catch (error) {
            console.error("ä¿å­˜é¢„è®¾å¤±è´¥:", error);
            alert("ä¿å­˜å¤±è´¥");
        }
    });


    // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šä»æ•°æ®åº“è¯»å–å¹¶æ¸²æŸ“æ‰€æœ‰é¢„è®¾åˆ°åˆ—è¡¨
    async function renderPresetList() {
        presetListContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½é¢„è®¾...</p>';
        try {
            const presetsData = await dbHelper.loadData('iconPresets', 'allPresets');
            const allPresets = (presetsData && Array.isArray(presetsData.value)) ? presetsData.value : [];

            if (allPresets.length === 0) {
                presetListContainer.innerHTML = '<p style="text-align: center; color: #888;">è¿˜æ²¡æœ‰ä»»ä½•é¢„è®¾ã€‚</p>';
                return;
            }

            presetListContainer.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º
            allPresets.forEach(preset => {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.innerHTML = `
                <span class="preset-name">${preset.name}</span>
                <div class="preset-actions">
                                        <button class="export-preset-btn" data-preset-id="${preset.id}">å¯¼å‡º</button>
                    <button class="apply-preset-btn" data-preset-id="${preset.id}">åº”ç”¨</button>
                    <button class="delete-preset-btn" data-preset-id="${preset.id}">åˆ é™¤</button>
                </div>
            `;
                presetListContainer.appendChild(item);
            });

        } catch (error) {
            console.error("æ¸²æŸ“é¢„è®¾åˆ—è¡¨å¤±è´¥:", error);
            presetListContainer.innerHTML = '<p style="text-align: center; color: red;">åŠ è½½å¤±è´¥ï¼</p>';
        }
    }


    // 4. æ ¸å¿ƒåŠŸèƒ½ï¼šä¸ºâ€œåº”ç”¨â€å’Œâ€œåˆ é™¤â€æŒ‰é’®ç»‘å®šäº‹ä»¶ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
    presetListContainer.addEventListener('click', async (event) => {
        const button = event.target;
        const presetId = parseInt(button.dataset.presetId, 10);

        if (button.classList.contains('apply-preset-btn')) {
            // --- åº”ç”¨é¢„è®¾ ---
            if (!confirm("ç¡®å®šè¦åº”ç”¨æ­¤å›¾æ ‡åŒ…é¢„è®¾å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„å›¾æ ‡è®¾ç½®ã€‚")) return;

            try {
                const presetsData = await dbHelper.loadData('iconPresets', 'allPresets');
                const presetToApply = presetsData.value.find(p => p.id === presetId);

                if (presetToApply) {
                    // a. å°†é¢„è®¾çš„å›¾æ ‡é…ç½®ï¼Œå†™å…¥åˆ°å½“å‰ä½¿ç”¨çš„å›¾æ ‡é…ç½®ä¸­
                    await dbHelper.saveData('settingsStore', 'customAppIcons', presetToApply.icons);
                    // b. ç«‹å³è°ƒç”¨åŠ è½½å›¾æ ‡çš„å‡½æ•°ï¼Œåˆ·æ–°ä¸»å±å¹•
                    await loadCustomIcons();
                    alert(`é¢„è®¾ "${presetToApply.name}" å·²æˆåŠŸåº”ç”¨ï¼`);
                }
            } catch (error) {
                console.error("åº”ç”¨é¢„è®¾å¤±è´¥:", error);
                alert("åº”ç”¨å¤±è´¥ï¼");
            }

        } else if (button.classList.contains('delete-preset-btn')) {
            // --- åˆ é™¤é¢„è®¾ ---
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) return;

            try {
                const presetsData = await dbHelper.loadData('iconPresets', 'allPresets');
                let allPresets = presetsData.value;
                // è¿‡æ»¤æ‰è¦åˆ é™¤çš„é¢„è®¾
                const updatedPresets = allPresets.filter(p => p.id !== presetId);
                // ä¿å­˜æ›´æ–°åçš„åˆ—è¡¨
                await dbHelper.saveData('iconPresets', 'allPresets', updatedPresets);
                // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                renderPresetList();
            } catch (error) {
                console.error("åˆ é™¤é¢„è®¾å¤±è´¥:", error);
                alert("åˆ é™¤å¤±è´¥ï¼");
            }
        } else if (button.classList.contains('export-preset-btn')) {
            // â–¼â–¼â–¼ æ–°å¢ï¼šå¯¼å‡ºé¢„è®¾çš„é€»è¾‘ â–¼â–¼â–¼
            try {
                const presetsData = await dbHelper.loadData('iconPresets', 'allPresets');
                const presetToExport = presetsData.value.find(p => p.id === presetId);

                if (presetToExport) {
                    // a. å°†å•ä¸ªé¢„è®¾å¯¹è±¡è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                    const jsonString = JSON.stringify(presetToExport, null, 2);
                    // b. åˆ›å»ºä¸€ä¸ªBlobå¯¹è±¡
                    const blob = new Blob([jsonString], { type: "application/json" });
                    // c. åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ä¸‹è½½é“¾æ¥
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    // d. è®¾ç½®ä¸‹è½½æ–‡ä»¶å
                    a.download = `å›¾æ ‡é¢„è®¾_${presetToExport.name}.json`;
                    a.href = url;
                    // e. è§¦å‘ä¸‹è½½å¹¶æ¸…ç†
                    a.click();
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error("å¯¼å‡ºé¢„è®¾å¤±è´¥:", error);
                alert("å¯¼å‡ºå¤±è´¥ï¼");
            }
        }
    });

    // â–¼â–¼â–¼ å¯¼å…¥å›¾æ ‡åŒ…é¢„è®¾â–¼â–¼â–¼
    // 1. ç‚¹å‡»é¡¶æ çš„â€œå¯¼å…¥â€æŒ‰é’®ï¼Œå®é™…æ˜¯è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©æ¡†
    importPresetButton.addEventListener('click', () => {
        presetImportInput.click();
    });

    // 2. ç›‘å¬æ–‡ä»¶é€‰æ‹©æ¡†çš„å˜åŒ–
    presetImportInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();

        // 3. æ–‡ä»¶è¯»å–æˆåŠŸåçš„å›è°ƒ
        reader.onload = async (e) => {
            try {
                const importedPreset = JSON.parse(e.target.result);

                // a. ç®€å•éªŒè¯å¯¼å…¥çš„æ–‡ä»¶æ˜¯å¦åˆæ³•
                if (!importedPreset.name || typeof importedPreset.icons !== 'object') {
                    throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œä¸æ˜¯æœ‰æ•ˆçš„é¢„è®¾æ–‡ä»¶ã€‚");
                }

                // b. ä»æ•°æ®åº“è¯»å–ç°æœ‰é¢„è®¾
                const presetsData = await dbHelper.loadData('iconPresets', 'allPresets');
                let allPresets = (presetsData && Array.isArray(presetsData.value)) ? presetsData.value : [];

                // c. æ£€æŸ¥åç§°æ˜¯å¦é‡å¤
                if (allPresets.some(p => p.name === importedPreset.name)) {
                    if (!confirm(`å·²å­˜åœ¨åä¸º "${importedPreset.name}" çš„é¢„è®¾ã€‚è¦è¦†ç›–å®ƒå—ï¼Ÿ`)) {
                        presetImportInput.value = ''; // æ¸…ç©ºè¾“å…¥ï¼Œä»¥ä¾¿ä¸‹æ¬¡èƒ½é€‰æ‹©åŒä¸ªæ–‡ä»¶
                        return; // ç”¨æˆ·é€‰æ‹©ä¸è¦†ç›–ï¼Œåˆ™ä¸­æ­¢æ“ä½œ
                    }
                    // å¦‚æœè¦è¦†ç›–ï¼Œå°±å…ˆåˆ é™¤æ—§çš„åŒåé¢„è®¾
                    allPresets = allPresets.filter(p => p.name !== importedPreset.name);
                }

                // d. ä¸ºå¯¼å…¥çš„é¢„è®¾ç”Ÿæˆä¸€ä¸ªæ–°çš„å”¯ä¸€IDï¼Œå¹¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­
                importedPreset.id = Date.now();
                allPresets.unshift(importedPreset);

                // e. ä¿å­˜å›æ•°æ®åº“å¹¶åˆ·æ–°UI
                await dbHelper.saveData('iconPresets', 'allPresets', allPresets);
                renderPresetList();
                alert(`é¢„è®¾ "${importedPreset.name}" å·²æˆåŠŸå¯¼å…¥ï¼`);

            } catch (error) {
                console.error("å¯¼å…¥é¢„è®¾å¤±è´¥:", error);
                alert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
            } finally {
                // æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
                presetImportInput.value = '';
            }
        };

        // 4. ä»¥æ–‡æœ¬å½¢å¼è¯»å–æ–‡ä»¶
        reader.readAsText(file);
    });

    // --- 1. ç­¾åç¾åŒ– ---

    // åº”ç”¨é¢œè‰²åˆ°ç­¾å
    function applyMottoColor(color) {
        if (mottoElement) mottoElement.style.color = color;
    }

    // åº”ç”¨æ¨¡ç³Šæ•ˆæœåˆ°ç­¾å
    function applyMottoBlur(isEnabled) {
        if (mottoElement) mottoElement.classList.toggle('motto-blur-enabled', isEnabled);
    }

    // ä¿å­˜ç­¾åæ ·å¼åˆ°æ•°æ®åº“
    async function saveMottoStyle() {
        const style = {
            color: mottoColorInput.value,
            blurEnabled: mottoBlurToggle.checked
        };
        await dbHelper.saveData('settingsStore', 'mottoStyle', style);
    }

    // ä»æ•°æ®åº“åŠ è½½å¹¶åº”ç”¨ç­¾åæ ·å¼
    async function loadMottoStyle() {
        const styleData = await dbHelper.loadData('settingsStore', 'mottoStyle');
        const style = styleData ? styleData.value : { color: '#8a8a8e', blurEnabled: false }; // é»˜è®¤å€¼

        // åº”ç”¨æ ·å¼åˆ°ä¸»å±å¹•
        applyMottoColor(style.color);
        applyMottoBlur(style.blurEnabled);

        // æ›´æ–°ç¾åŒ–Appä¸­æ§ä»¶çš„åˆå§‹çŠ¶æ€
        mottoColorInput.value = style.color;
        mottoColorPicker.value = style.color;
        mottoBlurToggle.checked = style.blurEnabled;
    }

    // --- 2. å›¾æ ‡åç§°ç¾åŒ– ---

    // åº”ç”¨é¢œè‰²åˆ°æ‰€æœ‰Appåç§°
    function applyAppNameColor(color) {
        appNameElements.forEach(el => el.style.color = color);
    }

    // åº”ç”¨æ¨¡ç³Šæ•ˆæœåˆ°æ‰€æœ‰Appåç§°
    function applyAppNameBlur(isEnabled) {
        appNameElements.forEach(el => el.classList.toggle('app-name-blur-enabled', isEnabled));
    }

    // ä¿å­˜å›¾æ ‡åç§°æ ·å¼åˆ°æ•°æ®åº“
    async function saveAppNameStyle() {
        const style = {
            color: appNameColorInput.value,
            blurEnabled: appNameBlurToggle.checked
        };
        await dbHelper.saveData('settingsStore', 'appNameStyle', style);
    }

    // ä»æ•°æ®åº“åŠ è½½å¹¶åº”ç”¨å›¾æ ‡åç§°æ ·å¼
    async function loadAppNameStyle() {
        const styleData = await dbHelper.loadData('settingsStore', 'appNameStyle');
        const defaultStyle = { color: '#111111', blurEnabled: false };
        const style = styleData ? styleData.value : defaultStyle;

        // âœ… éªŒè¯é¢œè‰²å€¼æ ¼å¼ï¼ˆå¿…é¡»æ˜¯ #rrggbb æ ¼å¼ï¼‰
        const isValidColor = /^#[0-9A-Fa-f]{6}$/.test(style.color);
        const validColor = isValidColor ? style.color : defaultStyle.color;

        // åº”ç”¨æ ·å¼åˆ°ä¸»å±å¹•
        applyAppNameColor(validColor);
        applyAppNameBlur(style.blurEnabled);

        // æ›´æ–°ç¾åŒ–Appä¸­æ§ä»¶çš„åˆå§‹çŠ¶æ€
        appNameColorInput.value = validColor;
        appNameColorPicker.value = validColor;
        appNameBlurToggle.checked = style.blurEnabled;
    }

    // æ‚¨å¯ä»¥æŠŠè¿™ä¸¤ä¸ªæ–°å‡½æ•°ï¼Œç²˜è´´åˆ° closeModal() å‡½æ•°çš„ä¸‹æ–¹

    /**
     * ã€å·²ä¿®å¤ã€‘æ‰“å¼€å›¾ç‰‡é¢„è§ˆå¼¹çª—
     * @param {string} imageUrl - è¦é¢„è§ˆçš„å›¾ç‰‡URL
     */
    function openImagePreview(imageUrl) {
        if (!imagePreviewModal || !previewImageElement) return;

        previewImageElement.src = imageUrl;
        imagePreviewModal.style.display = 'flex'; // 1. å…ˆè®©å…ƒç´ åœ¨å¸ƒå±€ä¸­å ä½

        // 2. å»¶è¿Ÿæ‰§è¡ŒåŠ¨ç”»ï¼Œç¡®ä¿æµè§ˆå™¨æœ‰æ—¶é—´æ¸²æŸ“
        setTimeout(() => {
            // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒæ—¶æ”¹å˜é®ç½©èƒŒæ™¯å’Œå›¾ç‰‡æœ¬èº«çš„ä¸é€æ˜åº¦
            imagePreviewModal.style.opacity = '1';
            previewImageElement.style.opacity = '1';
            previewImageElement.style.transform = 'scale(1)';
        }, 10);
    }


    /**
     * ã€å·²ä¿®å¤ã€‘å…³é—­å›¾ç‰‡é¢„è§ˆå¼¹çª—
     */
    function closeImagePreview() {
        if (!imagePreviewModal || !previewImageElement) return;

        // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒæ—¶æ”¹å˜é®ç½©èƒŒæ™¯å’Œå›¾ç‰‡æœ¬èº«çš„ä¸é€æ˜åº¦
        imagePreviewModal.style.opacity = '0';
        previewImageElement.style.opacity = '0';
        previewImageElement.style.transform = 'scale(0.95)';

        // ç­‰å¾…åŠ¨ç”»ï¼ˆ0.3ç§’ï¼‰ç»“æŸåå†éšè—å…ƒç´ 
        setTimeout(() => {
            imagePreviewModal.style.display = 'none';
            previewImageElement.src = ''; // æ¸…ç©ºå›¾ç‰‡ï¼Œé‡Šæ”¾å†…å­˜
        }, 300);
    }

    /**
     * å¼€å§‹è¯­éŸ³é€šè¯æµç¨‹
     */
    /**
    * å¼€å§‹è¯­éŸ³é€šè¯æµç¨‹
    */
    async function startVoiceCall() {
        if (!currentOpenContact) {
            alert("è¯·å…ˆæ‰“å¼€ä¸€ä¸ªå¯¹è¯ï¼");
            return;
        }
        callHistory = [];

        // å‡†å¤‡UI
        document.getElementById('scroll-to-bottom-btn').classList.remove('visible');
        callingAvatar.style.backgroundImage = `url(${currentOpenContact.ai.avatar})`;
        callingName.textContent = currentOpenContact.ai.name;
        callingStatus.textContent = 'æ­£åœ¨å‘¼å«...';

        callingState.classList.add('active');
        connectedState.classList.remove('active');
        phoneFrame.classList.add('show-voice-call');
        if (typeof toggleFeaturesPanel === 'function') toggleFeaturesPanel();


        setTimeout(() => {
            connectVoiceCall();
        }, 1500);
    }

    /**
     * ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘æ¥é€šç”µè¯ï¼ŒAIè¯´å¼€åœºç™½
     */
    async function connectVoiceCall() {
        console.log("é€šè¯å·²æ¥é€š");
        phoneFrame.classList.add('show-voice-call');
        callingState.classList.remove('active');
        connectedState.classList.add('active');
        connectedName.textContent = currentOpenContact.ai.name;

        callStartTime = Date.now();
        callTimerInterval = window.TimerManager.setInterval(updateCallTimer, 1000, 'voice-call');
        updateCallTimer();

        showCallTypingIndicator(); // æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€

        const history = currentOpenContact.history || [];
        const recentHistory = history.slice(-6);
        const chatContextForAI = recentHistory.map(msg => {
            const content = translateMessageForAI(msg);
            if (content) {
                return { role: msg.sender === 'user' ? 'user' : 'assistant', content: content };
            }
            return null;
        }).filter(Boolean);
        const firstWordPrompt = `[ç³»ç»Ÿæç¤ºï¼šç”µè¯åˆšåˆšæ¥é€šï¼Œè¯·æ ¹æ®ä½ çš„äººè®¾å’Œæˆ‘ä»¬çš„èŠå¤©è®°å½•ï¼Œè¯´ä¸€æ®µè‡ªç„¶æµç•…çš„å¼€åœºç™½ã€‚ã€å¼ºåˆ¶ã€‘å°†ä½ çš„å›å¤æ‹†åˆ†ä¸º2-3å¥çŸ­æ¶ˆæ¯ï¼Œå¹¶ç”¨ "\\" åˆ†éš”ã€‚-   ã€æå…¶é‡è¦ã€‘ä½ çš„å›å¤å°±æ˜¯è¯´çš„è¯æœ¬èº«ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘åœ¨å›å¤çš„å¼€å¤´æ·»åŠ  "è¯­éŸ³ï¼š" æˆ–ä»»ä½•ç±»ä¼¼çš„å‰ç¼€ã€‚
    -   âœ… **æ­£ç¡®èŒƒä¾‹**: å–‚ï¼Ÿ\\èƒ½å¬åˆ°æˆ‘è¯´è¯å—ï¼Ÿ
    -   âŒ **é”™è¯¯èŒƒä¾‹**: è¯­éŸ³ï¼šå–‚ï¼Ÿ\\è¯­éŸ³ï¼šèƒ½å¬åˆ°æˆ‘è¯´è¯å—ï¼Ÿ
-   ã€æå…¶é‡è¦ã€‘ä¸¥ç¦ä½¿ç”¨ä»»ä½•å…¶ä»–æŒ‡ä»¤å‰ç¼€ï¼Œä¾‹å¦‚ "è¡¨æƒ…åŒ…ï¼š" æˆ– "è½¬è´¦ï¼š"ã€‚è¿™é‡Œæ˜¯ç”µè¯ï¼Œä½ æ— æ³•æ‰§è¡Œé‚£äº›æ“ä½œã€‚
-   ã€ç»å¯¹ç¦æ­¢ã€‘è¾“å‡ºä»»ä½•JSONä»£ç æˆ–ä»£ç å—ã€‚]`;

        const aiMessages = await fetchAiCallResponse(firstWordPrompt, currentOpenContact, [], chatContextForAI);

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåªå¤„ç†æˆåŠŸçš„æƒ…å†µï¼Œä¸å†æœ‰else â–¼â–¼â–¼
        if (aiMessages && aiMessages.length > 0) {
            aiMessages.forEach(msg => callHistory.push({ role: 'assistant', content: msg }));
            await displayAiCallBubbles(aiMessages);
        }
        // â–²â–²â–² else { showCallFallbackMessage(); } å·²è¢«åˆ é™¤ â–²â–²â–²
    }

    /**
     * ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘ç”¨æˆ·åœ¨é€šè¯ä¸­å‘é€æ–‡å­—
     */
    async function handleUserSpeak() {
        const userText = voiceCallTextarea.value.trim();
        if (!userText) return;
        voiceCallInputModal.style.opacity = '0';
        setTimeout(() => voiceCallInputModal.style.display = 'none', 300);

        callHistory.push({ role: 'user', content: userText });

        showCallTypingIndicator(); // æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€

        // --- æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œé‡æ–°åŠ è½½é€šè¯å‰çš„èŠå¤©è®°å½• ---
        const history = currentOpenContact.history || [];
        const recentHistory = history.slice(-6); // å–æœ€è¿‘6æ¡ä½œä¸ºå‚è€ƒ
        const chatContextForAI = recentHistory.map(msg => {
            const content = translateMessageForAI(msg);
            if (content) {
                return { role: msg.sender === 'user' ? 'user' : 'assistant', content: content };
            }
            return null;
        }).filter(Boolean);
        // --- ä¿®å¤ç»“æŸ ---

        const aiPrompt = `(ç³»ç»ŸæŒ‡ä»¤ï¼šè¿™æ˜¯ç”¨æˆ·çš„æœ€æ–°å›åº”ï¼Œè¯·ä½ ç»§ç»­å¯¹è¯ã€‚è®°ä½ï¼Œã€å¼ºåˆ¶ã€‘å°†ä½ çš„å›å¤æ‹†åˆ†ä¸º2-5å¥çŸ­æ¶ˆæ¯ï¼Œå¹¶ç”¨ "\\" åˆ†éš”ã€‚-   ã€æå…¶é‡è¦ã€‘ä½ çš„å›å¤å°±æ˜¯è¯´çš„è¯æœ¬èº«ï¼Œã€ç»å¯¹ç¦æ­¢ã€‘åœ¨å›å¤çš„å¼€å¤´æ·»åŠ  "è¯­éŸ³ï¼š" æˆ–ä»»ä½•ç±»ä¼¼çš„å‰ç¼€ã€‚
    -   âœ… **æ­£ç¡®èŒƒä¾‹**: å–‚ï¼Ÿ\\èƒ½å¬åˆ°æˆ‘è¯´è¯å—ï¼Ÿ
    -   âŒ **é”™è¯¯èŒƒä¾‹**: è¯­éŸ³ï¼šå–‚ï¼Ÿ\\è¯­éŸ³ï¼šèƒ½å¬åˆ°æˆ‘è¯´è¯å—ï¼Ÿ
-   ã€æå…¶é‡è¦ã€‘ä¸¥ç¦ä½¿ç”¨ä»»ä½•å…¶ä»–æŒ‡ä»¤å‰ç¼€ï¼Œä¾‹å¦‚ "è¡¨æƒ…åŒ…ï¼š" æˆ– "è½¬è´¦ï¼š"ã€‚è¿™é‡Œæ˜¯ç”µè¯ï¼Œä½ æ— æ³•æ‰§è¡Œé‚£äº›æ“ä½œã€‚
-   ã€ç»å¯¹ç¦æ­¢ã€‘è¾“å‡ºä»»ä½•JSONä»£ç æˆ–ä»£ç å—ã€‚)`;

        const aiMessages = await fetchAiCallResponse(aiPrompt, currentOpenContact, callHistory, chatContextForAI);

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåªå¤„ç†æˆåŠŸçš„æƒ…å†µï¼Œä¸å†æœ‰else â–¼â–¼â–¼
        if (aiMessages && aiMessages.length > 0) {
            aiMessages.forEach(msg => callHistory.push({ role: 'assistant', content: msg }));
            await displayAiCallBubbles(aiMessages);
        }
        // â–²â–²â–² else { showCallFallbackMessage(); } å·²è¢«åˆ é™¤ â–²â–²â–²
    }

    // â–¼â–¼â–¼ å°†è¿™ä¸ªæ–°å‡½æ•°ç²˜è´´åˆ°JSä¸­ â–¼â–¼â–¼
    /**
     * ã€æ–°å¢ã€‘åŠ è½½å¹¶æ¸²æŸ“å½“å‰å¯¹è¯çš„æ‰€æœ‰é€šè¯æ‘˜è¦
     */
    // --- è¿™æ˜¯ä¿®æ”¹åçš„å‡½æ•° ---
    async function loadAndRenderSummaries() {
        if (!currentOpenContact) return;
        summaryListContainer.innerHTML = '';
        const summaries = currentOpenContact.history.filter(msg => msg.type === 'call_summary');

        if (summaries.length === 0) {
            summaryListContainer.innerHTML = '<p style="text-align:center; color:#888; margin-top: 50px;">æš‚æ— é€šè¯æ‘˜è¦</p>';
            return;
        }

        summaries.reverse().forEach(summaryMsg => {
            const card = document.createElement('div');
            card.className = 'summary-card';
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šåŒæ—¶å­˜å‚¨æ‘˜è¦å…¨æ–‡å’Œæ¶ˆæ¯çš„uuid â–¼â–¼â–¼
            card.dataset.summary = summaryMsg.text.replace(/---é€šè¯è®°å½•æ‘˜è¦---|---æ‘˜è¦ç»“æŸ---/g, '').trim();
            card.dataset.uuid = summaryMsg.uuid;

            const summaryText = summaryMsg.text.replace(/---é€šè¯è®°å½•æ‘˜è¦---|\n|---æ‘˜è¦ç»“æŸ---/g, ' ').trim();
            const timestamp = new Date(summaryMsg.timestamp);
            const formattedTime = `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')} ${String(timestamp.getHours()).padStart(2, '0')}:${String(timestamp.getMinutes()).padStart(2, '0')}`;

            // â–¼â–¼â–¼ è¿™æ˜¯è¦æ›¿æ¢çš„éƒ¨åˆ† â–¼â–¼â–¼
            card.innerHTML = `
    <div class="summary-card-header">
        <span class="summary-card-title">ä¸ ${currentOpenContact.ai.name} çš„é€šè¯</span>
        <span class="summary-card-timestamp">${formattedTime}</span>
    </div>
    <div class="summary-card-snippet">${summaryText}</div>
    <div class="preset-actions" style="border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 15px;">
        <button class="edit-btn" data-action="edit">ç¼–è¾‘</button>
        <button class="delete-btn" data-action="delete">åˆ é™¤</button>
    </div>
`;
            // â–²â–²â–² æ›¿æ¢åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²
            summaryListContainer.appendChild(card);
        });
    }
    // â–²â–²â–² ç²˜è´´ç»“æŸ â–²â–²â–²
    /**
     * æŒ‚æ–­ç”µè¯
     * @param {boolean} isPassive - æ˜¯å¦ä¸ºè¢«åŠ¨æŒ‚æ–­ï¼ˆå¯¹æ–¹æ‹’æ¥ï¼‰
     */
    async function hangUpVoiceCall(isPassive = false) {
        phoneFrame.classList.remove('show-voice-call', 'show-incoming-call');

        // âœ… ä½¿ç”¨TimerManagerç»Ÿä¸€æ¸…ç†æ‰€æœ‰é€šè¯è®¡æ—¶å™¨
        window.TimerManager.clear('voice-call');
        const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
        callStartTime = null;

        if (duration > 0 || !isPassive) {
            const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
            const seconds = (duration % 60).toString().padStart(2, '0');
            const durationText = `è¯­éŸ³é€šè¯: ${minutes}:${seconds}`;
            await showSystemNotification(durationText, currentOpenContact.id);
        }

        if (callHistory.length > 0) {
            const summary = callHistory.map(turn => `${turn.role === 'user' ? currentOpenContact.user.name : currentOpenContact.ai.name}: ${turn.content}`).join('\n');
            const summaryMessage = {
                sender: 'system',
                type: 'call_summary',
                text: `---é€šè¯è®°å½•æ‘˜è¦---\n${summary}\n---æ‘˜è¦ç»“æŸ---`,
                timestamp: new Date(),
                uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
            };
            // â–¼â–¼â–¼ CORE FIX IS HERE â–¼â–¼â–¼
            await saveMessageToHistory(summaryMessage, currentOpenContact.id);
            // â–²â–²â–² END OF FIX â–²â–²â–²
        }
    }
    /**
     * æ›´æ–°é€šè¯è®¡æ—¶å™¨
     */
    function updateCallTimer() {
        if (!callStartTime) return;
        const duration = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
        const seconds = (duration % 60).toString().padStart(2, '0');
        callTimerDisplay.textContent = `${minutes}:${seconds}`;
    }


    /**
     * ã€æœ€ç»ˆä¿®å¤ç‰ˆã€‘è·å–AIé€šè¯å›å¤çš„æ ¸å¿ƒå‡½æ•°
     */
    async function fetchAiCallResponse(promptText, contact, currentCallHistory, initialChatHistory = []) {
        try {
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value.url) throw new Error("APIæœªé…ç½®");

            const { url, key, model, temperature } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // --- è¿™ä¸€æ•´å—éƒ½æ˜¯æ–°å¢æˆ–ä¿®å¤çš„ä¸Šä¸‹æ–‡åŠ è½½é€»è¾‘ ---
            let timeInfo = contact.timePerceptionEnabled ? `### ç°å®æ—¶é—´å‚è€ƒ\nå½“å‰ç”¨æˆ·çš„ç°å®æ—¶é—´æ˜¯ï¼š${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false, year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: '2-digit', minute: '2-digit' })}\n---\n\n` : "";

            let worldBookContent = "æ— ç‰¹å®šä¸–ç•Œè§‚è®¾å®šï¼Œè¯·è‡ªç”±å‘æŒ¥ã€‚";
            // --- é‡æ„ï¼šä¸–ç•Œä¹¦å†…å®¹åŠ è½½ (æ”¯æŒæ–°ç‰ˆå¤šé€‰) ---
            try {
                const worldbookData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
                const allBooks = (worldbookData && Array.isArray(worldbookData.value)) ? worldbookData.value : [];
                let requiredBookIds = new Set();
                
                // 1. ä¼˜å…ˆæ–°ç‰ˆ
                if (contact.linkedWorldBookIds && contact.linkedWorldBookIds.length > 0) {
                     contact.linkedWorldBookIds.forEach(id => requiredBookIds.add(id));
                }
                // 2. å›é€€æ—§ç‰ˆ
                else if (contact.linkedWorldBookGroupIds && contact.linkedWorldBookGroupIds.length > 0) {
                     const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                     const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                     const linkedGroupIds = new Set(contact.linkedWorldBookGroupIds);
                     allGroups.forEach(group => {
                         if (linkedGroupIds.has(group.id) && Array.isArray(group.bookIds)) {
                             group.bookIds.forEach(bookId => requiredBookIds.add(bookId));
                         }
                     });
                }
                
                if (requiredBookIds.size > 0) {
                    const linkedBooksContent = allBooks
                        .filter(book => requiredBookIds.has(book.id))
                        .map(book => `### ä¸–ç•Œä¹¦: ${book.name}\n\n${book.content}`)
                        .join('\n\n---\n\n');
                    if (linkedBooksContent) {
                        worldBookContent = linkedBooksContent;
                    }
                }
            } catch (dbError) {
                console.error("åŠ è½½å…³è”çš„ä¸–ç•Œä¹¦å†…å®¹æ—¶å‡ºé”™:", dbError);
            }

            // æ ¸å¿ƒä¿®å¤1: æ„å»ºâ€œå‰æƒ…æè¦â€æ–‡æœ¬
            let chatHistoryForPrompt = initialChatHistory.map(msg => {
                const sender = msg.role === 'user' ? contact.user.name : contact.ai.name;
                return `${sender}: ${msg.content}`;
            }).join('\n');
            if (!chatHistoryForPrompt) chatHistoryForPrompt = "æ— ";

            // æ ¸å¿ƒä¿®å¤2: ä½¿ç”¨ voiceCallSystemPrompt å¹¶æ­£ç¡®æ›¿æ¢æ‰€æœ‰å ä½ç¬¦
            const finalSystemPrompt = voiceCallSystemPrompt
                .replace(/\$\{ai_persona\}/g, `å§“å: ${contact.ai.name}\näººè®¾: ${contact.ai.persona}`)
                .replace(/\$\{user_persona\}/g, `å§“å: ${contact.user.name}\näººè®¾: ${contact.user.persona}`)
                .replace(/\$\{world_book_content\}/g, worldBookContent)
                .replace(/\$\{chat_history\}/g, chatHistoryForPrompt); // æ–°å¢ï¼šæ³¨å…¥å‰æƒ…æè¦

            const messages = [
                { role: "system", content: finalSystemPrompt },
                ...currentCallHistory.map(turn => ({ role: turn.role, content: turn.content })),
                { role: "user", content: promptText }
            ];

            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model,
                    messages,
                    temperature: parseFloat(temperature) || 1.0,
                })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            const data = await response.json();

            const aiResponseText = data.choices[0].message.content;
            if (aiResponseText) {
                // å°†çº¯æ–‡æœ¬æŒ‰'\'åˆ†å‰²æˆæ•°ç»„è¿”å›
                return aiResponseText.split(/\\{1,2}/g).map(m => m.trim()).filter(m => m);
            }

            return null;

        } catch (error) {
            console.error("è·å–AIé€šè¯å›å¤å¤±è´¥:", error);
            return null;
        }
    }

    /**
     * åœ¨é€šè¯ç•Œé¢ä¸­ï¼Œé€ä¸ªæ˜¾ç¤ºå¤šä¸ªAIæ°”æ³¡
     */
    async function displayAiCallBubbles(messages) {
        if (!messages || messages.length === 0) return;

        aiSpeechBubbleContainer.innerHTML = '';

        let isFirstBubble = true;

        for (const text of messages) {
            const bubble = document.createElement('div');
            bubble.className = 'ai-speech-bubble';

            if (isFirstBubble) {
                bubble.classList.add('first-bubble');
                isFirstBubble = false;
            }

            bubble.style.opacity = '0';
            aiSpeechBubbleContainer.appendChild(bubble);

            let i = 0;
            await new Promise(resolve => {
                bubble.style.opacity = '1';
                const typingInterval = setInterval(() => {
                    if (i < text.length) {
                        bubble.textContent += text.charAt(i);
                        i++;
                    } else {
                        clearInterval(typingInterval);
                        resolve();
                    }
                }, 150);
            });

            await new Promise(resolve => setTimeout(resolve, 600));
        }
    }
    /**
     * ã€æ–°å¢ã€‘åœ¨é€šè¯ç•Œé¢æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€çš„åŠ¨ç”»
     */
    function showCallTypingIndicator() {
        aiSpeechBubbleContainer.innerHTML = ''; // æ¸…ç©ºæ—§æ°”æ³¡
        const bubble = document.createElement('div');
        bubble.className = 'ai-speech-bubble typing-indicator-bubble'; // ä½¿ç”¨æ–°æ ·å¼
        bubble.style.opacity = '1';

        bubble.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
    `;

        aiSpeechBubbleContainer.appendChild(bubble);
    }
    // â–¼â–¼â–¼ å°†è¿™æ®µå…¨æ–°çš„JSä»£ç ç²˜è´´åˆ°é€šè¯åŠŸèƒ½åŒº â–¼â–¼â–¼

    // â€œæ¥å¬â€æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
    acceptCallButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-incoming-call');
        // ã€æ ¸å¿ƒã€‘ç›´æ¥å¤ç”¨æˆ‘ä»¬å·²æœ‰çš„â€œè¿æ¥æˆåŠŸâ€å‡½æ•°ï¼Œç¡®ä¿é€»è¾‘å’Œç•Œé¢å®Œå…¨ä¸€è‡´
        connectVoiceCall();
    });

    // â€œæ‹’ç»â€æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
    declineCallButton.addEventListener('click', () => {
        phoneFrame.classList.remove('show-incoming-call');
        showSystemNotification(`æœªæ¥æ¥ç”µï¼š${currentOpenContact.ai.name}`, currentOpenContact.id);
    });




    /**
    * ã€å·²æ›´æ–°ã€‘æ˜¾ç¤ºAIæ¥ç”µç•Œé¢
    * @param {string} reason - (å¯é€‰) AIæä¾›çš„æ¥ç”µåŸå› 
    */
    function showIncomingCallScreen(reason = '') {
        if (!currentOpenContact) return;

        // å¡«å……æ¥ç”µä¿¡æ¯
        incomingCallAvatar.style.backgroundImage = `url(${currentOpenContact.ai.avatar})`;
        incomingCallName.textContent = currentOpenContact.ai.name;

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®æ˜¯å¦æœ‰åŸå› ï¼Œæ¥å†³å®šæ˜¯å¦æ˜¾ç¤ºåŸå› æ–‡æœ¬ â–¼â–¼â–¼
        if (reason && reason.trim() !== '') {
            incomingCallReason.textContent = `â€œ${reason}â€`; // ç»™åŸå› åŠ ä¸Šå¼•å·ï¼Œæ›´åƒä¸€å¥è¯
            incomingCallReason.style.display = 'block'; // æ˜¾ç¤ºå…ƒç´ 
        } else {
            incomingCallReason.style.display = 'none'; // å¦‚æœæ²¡æœ‰åŸå› ï¼Œåˆ™éšè—å…ƒç´ 
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        // è§¦å‘CSSåŠ¨ç”»ï¼Œæ˜¾ç¤ºç•Œé¢
        phoneFrame.classList.add('show-incoming-call');
    }



    // PWAæ³¨å†Œä»£ç 
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }).catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    // 3. æ£€æŸ¥è®¾ç½®æ˜¯å¦å®Œæ•´ï¼Œå¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€
    function checkSetupCompletion() {
        const hasPortrait = !!datingCharPortrait;
        const hasDefaultBg = datingBackgrounds.some(bg => bg.isDefault);
        startDatingBtn.disabled = !(hasPortrait && hasDefaultBg);
        if (startDatingBtn.disabled) {
            startDatingBtn.style.opacity = '0.5';
            startDatingBtn.style.cursor = 'not-allowed';
        } else {
            startDatingBtn.style.opacity = '1';
            startDatingBtn.style.cursor = 'pointer';
        }
    }

    // 4. æ¸²æŸ“èƒŒæ™¯é¢„è§ˆåˆ—è¡¨çš„å‡½æ•°
    function renderBgPreviews() {
        bgPreviewsContainer.innerHTML = '';
        datingBackgrounds.forEach((bg, index) => {
            const item = document.createElement('div');
            item.className = 'bg-preview-item';
            item.innerHTML = `
            ${bg.isDefault ? '<div class="default-tag">é»˜è®¤</div>' : ''}
            <div class="preview-img" style="background-image: url('${bg.url}')"></div>
            <div class="preview-details">
                <div class="preview-tags">æ ‡ç­¾: ${bg.tags.join(', ')}</div>
                <div class="preview-actions">
                    <button class="set-default-btn" data-index="${index}">è®¾ä¸ºé»˜è®¤</button>
                    <button class="delete-btn" data-index="${index}">åˆ é™¤</button>
                </div>
            </div>
        `;
            bgPreviewsContainer.appendChild(item);
        });
        checkSetupCompletion();
    }

    // 5. å°†è®¾ç½®ä¿å­˜åˆ°æ•°æ®åº“çš„å‡½æ•°
    // ä¿®æ”¹åçš„ä»£ç  (AFTER)
    async function saveDatingSetup() {
        // é¦–å…ˆï¼Œç¡®ä¿æˆ‘ä»¬çŸ¥é“å½“å‰æ­£åœ¨ä¸ºå“ªä¸ªè§’è‰²è¿›è¡Œè®¾ç½®
        if (!currentOpenContact) return;

        const setupData = {
            portrait: datingCharPortrait,
            backgrounds: datingBackgrounds
        };
        await dbHelper.saveData('datingSetupStore', currentOpenContact.id, setupData);
    }

    // 6. é¡µé¢åŠ è½½æ—¶ï¼Œè¯»å–å·²ä¿å­˜çš„è®¾ç½®
    // ä¿®æ”¹åçš„ä»£ç  (AFTER)
    async function loadDatingSetup() {
        // å¦‚æœæ²¡æœ‰æ‰“å¼€ä»»ä½•èŠå¤©ï¼Œåˆ™æ— æ³•åŠ è½½è®¾ç½®ï¼Œç›´æ¥é€€å‡º
        if (!currentOpenContact) return;

        // æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®å½“å‰è§’è‰²çš„IDæ¥åŠ è½½å¯¹åº”çš„è®¾ç½®
        const setupData = await dbHelper.loadData('datingSetupStore', currentOpenContact.id);

        if (setupData && setupData.value) {
            datingCharPortrait = setupData.value.portrait;
            datingBackgrounds = setupData.value.backgrounds || [];

            if (datingCharPortrait) {
                charUploadBox.style.backgroundImage = `url('${datingCharPortrait}')`;
                charUploadBox.textContent = '';
            }
            renderBgPreviews();
        } else {
            // å¦‚æœè¿™ä¸ªè§’è‰²æ²¡æœ‰ä¿å­˜è¿‡è®¾ç½®ï¼Œå°±æ¸…ç©ºå½“å‰çŠ¶æ€
            datingCharPortrait = null;
            datingBackgrounds = [];
            charUploadBox.style.backgroundImage = 'none';
            charUploadBox.textContent = 'ç‚¹å‡»ä¸Šä¼ ';
            renderBgPreviews();
        }
        checkSetupCompletion();
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šåŠ è½½æ•°æ®å¹¶è¿›å…¥VNç•Œé¢ (V3 - æ¥å…¥çœŸå®AI)
     * @param {object} setupData - åŒ…å«ç«‹ç»˜å’ŒèƒŒæ™¯çš„å¯¹è±¡
     */
    async function loadAndEnterVNScreen(setupData) {
        // a. æ›´æ–°è§’è‰²å (å…ˆç”¨AIçš„åå­—å ä½)
        vnCharName.textContent = currentOpenContact.ai.name.toUpperCase();

        // b. åŠ è½½é»˜è®¤èƒŒæ™¯å’Œç«‹ç»˜
        const defaultBg = setupData.backgrounds.find(bg => bg.isDefault);
        if (defaultBg) vnBackground.style.backgroundImage = `url('${defaultBg.url}')`;
        if (setupData.portrait) vnCharacter.style.backgroundImage = `url('${setupData.portrait}')`;

        // c. æ˜¾ç¤ºVNç•Œé¢
        vnScreen.classList.add('visible');

        // d. æ˜¾ç¤ºâ€œåŠ è½½ä¸­â€åŠ¨ç”»ï¼Œå¹¶è°ƒç”¨AIç”Ÿæˆå¼€åœºç™½
        vnDialogText.innerHTML = '<div class="dialog-loader"><span></span><span></span><span></span></div>';

        const openingPrompt = "(æ•…äº‹å¼€å§‹)"; // è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åˆå§‹æŒ‡ä»¤
        const aiScript = await callVnAI(openingPrompt);

        if (aiScript) {
            startVnScene(aiScript); // AIç”Ÿæˆå®Œæ¯•ï¼Œå¯åŠ¨å¯¹è¯å¼•æ“
        } else {
            // å¦‚æœAIç”Ÿæˆå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            vnDialogText.innerHTML = 'AIå¼€åœºç™½ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®æˆ–ç½‘ç»œåé‡è¯•ã€‚';
        }
    }
    /**
     * æ ¸å¿ƒé€»è¾‘ï¼šç‚¹å‡»â€œå®Œæˆè®¾ç½®â€æŒ‰é’®
     */
    startDatingBtn.addEventListener('click', () => {
        // a. éšè—è®¾ç½®ç•Œé¢
        datingSetupScreen.classList.remove('visible');
        // b. æ˜¾ç¤ºâ€œæ­£åœ¨èµ´çº¦â€åŠ è½½åŠ¨ç”»
        secondLoader.classList.add('visible');
        // c. 5ç§’åæ‰§è¡Œ
        setTimeout(() => {
            // d. éšè—åŠ è½½åŠ¨ç”»
            secondLoader.classList.remove('visible');
            // e. ä½¿ç”¨å½“å‰å·²ä¿å­˜çš„æ•°æ®è¿›å…¥VNç•Œé¢
            const currentSetup = {
                portrait: datingCharPortrait,
                backgrounds: datingBackgrounds
            };
            loadAndEnterVNScreen(currentSetup);
        }, 5000);
    });

    /**
     * è¾…åŠ©å‡½æ•°ï¼šä¸ºå¤åˆ¶å‡ºæ¥çš„è®¾ç½®å…ƒç´ é‡æ–°ç»‘å®šäº‹ä»¶
     */
    function rebindSettingsEventListeners(container) {
        const newSetupContainer = datingSettingsScreen.querySelector('.dating-setup-container');
        if (!newSetupContainer) return;

        newSetupContainer.classList.add('visible');

        // â€œå®Œæˆâ€æŒ‰é’®
        const doneBtn = newSetupContainer.querySelector('#start-dating-btn');
        doneBtn.textContent = "è¿”å›çº¦ä¼š";
        doneBtn.addEventListener('click', () => {
            phoneFrame.classList.remove('show-dating-settings');
        });

        // --- ç«‹ç»˜ä¸Šä¼  ---
        const newCharUploadBox = newSetupContainer.querySelector('#char-upload-box');
        const newCharUploadInput = newSetupContainer.querySelector('#char-upload-input');
        newCharUploadBox.addEventListener('click', () => newCharUploadInput.click());
        newCharUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                datingCharPortrait = e.target.result;
                newCharUploadBox.style.backgroundImage = `url('${datingCharPortrait}')`;
                newCharUploadBox.textContent = '';
                vnCharacter.style.backgroundImage = `url('${datingCharPortrait}')`;
                saveDatingSetup();
            };
            reader.readAsDataURL(file);
        });

        // --- èƒŒæ™¯ä¸Šä¼  ---
        const newBgUploadBox = newSetupContainer.querySelector('#bg-upload-box');
        const newBgUploadInput = newSetupContainer.querySelector('#bg-upload-input');
        newBgUploadBox.addEventListener('click', () => newBgUploadInput.click());
        newBgUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const tagsString = prompt("è¯·è¾“å…¥æ­¤èƒŒæ™¯çš„æ ‡ç­¾ (å¤šä¸ªæ ‡ç­¾è¯·ç”¨ç©ºæ ¼æˆ–é€—å·éš”å¼€):", "é»˜è®¤");
            if (tagsString === null) return;
            const tags = tagsString.split(/[\s,ï¼Œ]+/).filter(tag => tag);
            const reader = new FileReader();
            reader.onload = (e) => {
                const newBg = { url: e.target.result, tags: tags.length > 0 ? tags : ['æœªåˆ†ç±»'], isDefault: false };
                datingBackgrounds.push(newBg);
                // é‡æ–°æ¸²æŸ“è®¾ç½®é¡µçš„é¢„è§ˆåˆ—è¡¨
                renderBgPreviewsInSettings();
                saveDatingSetup();
            };
            reader.readAsDataURL(file);
        });

        // --- èƒŒæ™¯é¢„è§ˆåˆ—è¡¨äº¤äº’ ---
        const newBgPreviewsContainer = newSetupContainer.querySelector('#bg-previews-container');
        newBgPreviewsContainer.addEventListener('click', (event) => {
            const target = event.target;
            const index = parseInt(target.dataset.index, 10);

            if (target.classList.contains('set-default-btn')) {
                datingBackgrounds.forEach((bg, i) => bg.isDefault = (i === index));
                // å®æ—¶æ›´æ–°VNç•Œé¢çš„èƒŒæ™¯
                vnBackground.style.backgroundImage = `url('${datingBackgrounds[index].url}')`;
                renderBgPreviewsInSettings();
                saveDatingSetup();
            }

            if (target.classList.contains('delete-btn')) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèƒŒæ™¯å—ï¼Ÿ')) {
                    const wasDefault = datingBackgrounds[index].isDefault;
                    datingBackgrounds.splice(index, 1);
                    if (wasDefault && datingBackgrounds.length > 0) {
                        datingBackgrounds[0].isDefault = true;
                        vnBackground.style.backgroundImage = `url('${datingBackgrounds[0].url}')`;
                    } else if (datingBackgrounds.length === 0) {
                        vnBackground.style.backgroundImage = 'none';
                    }
                    renderBgPreviewsInSettings();
                    saveDatingSetup();
                }
            }
        });

        // åˆ›å»ºä¸€ä¸ªä¸“ç”¨äºæ¸²æŸ“â€œè®¾ç½®é¡µâ€é¢„è§ˆçš„å‡½æ•°
        function renderBgPreviewsInSettings() {
            newBgPreviewsContainer.innerHTML = '';
            datingBackgrounds.forEach((bg, index) => {
                const item = document.createElement('div');
                item.className = 'bg-preview-item';
                item.innerHTML = `
                ${bg.isDefault ? '<div class="default-tag">é»˜è®¤</div>' : ''}
                <div class="preview-img" style="background-image: url('${bg.url}')"></div>
                <div class="preview-details">
                    <div class="preview-tags">æ ‡ç­¾: ${bg.tags.join(', ')}</div>
                    <div class="preview-actions">
                        <button class="set-default-btn" data-index="${index}">è®¾ä¸ºé»˜è®¤</button>
                        <button class="delete-btn" data-index="${index}">åˆ é™¤</button>
                    </div>
                </div>
            `;
                newBgPreviewsContainer.appendChild(item);
            });
        }

        // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
        renderBgPreviewsInSettings();
    }

    // ä¸“ç”¨äºç»‘å®šâ€œç«‹ç»˜è®¾ç½®â€å­é¡µé¢çš„äº‹ä»¶
    // --- è¿™æ˜¯ä¿®æ”¹åçš„å®Œæ•´å‡½æ•° ---
    function bindPortraitSettingsEvents(container) {
        // è·å–æ‰€æœ‰éœ€è¦çš„æ§ä»¶
        const charUploadBox = container.querySelector('#char-upload-box-settings');
        const charUploadInput = container.querySelector('#char-upload-input-settings');
        const deleteBtn = container.querySelector('#delete-char-portrait-btn'); // è·å–æ–°æŒ‰é’®

        // åˆå§‹åŒ–æ˜¾ç¤ºå½“å‰ç«‹ç»˜
        if (datingCharPortrait) {
            charUploadBox.style.backgroundImage = `url('${datingCharPortrait}')`;
            charUploadBox.textContent = '';
        }

        // --- ä¸Šä¼ é€»è¾‘ (ä¿æŒä¸å˜) ---
        charUploadBox.addEventListener('click', () => charUploadInput.click());
        charUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                datingCharPortrait = e.target.result;
                charUploadBox.style.backgroundImage = `url('${datingCharPortrait}')`;
                charUploadBox.textContent = '';
                vnCharacter.style.backgroundImage = `url('${datingCharPortrait}')`; // å®æ—¶æ›´æ–°ä¸»ç•Œé¢
                saveDatingSetup();
                checkSetupCompletion(); // ä¸Šä¼ åæ£€æŸ¥çŠ¶æ€
            };
            reader.readAsDataURL(file);
        });

        // --- â–¼â–¼â–¼ æ–°å¢çš„åˆ é™¤é€»è¾‘ â–¼â–¼â–¼ ---
        deleteBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦åˆ é™¤å½“å‰çš„è§’è‰²ç«‹ç»˜å—ï¼Ÿ')) {
                // 1. æ¸…ç©ºå†…å­˜ä¸­çš„ç«‹ç»˜æ•°æ®
                datingCharPortrait = null;

                // 2. æ›´æ–°è®¾ç½®ç•Œé¢çš„UI
                charUploadBox.style.backgroundImage = 'none';
                charUploadBox.textContent = 'ç‚¹å‡»ä¸Šä¼ ';

                // 3. å®æ—¶æ›´æ–°çº¦ä¼šä¸»ç•Œé¢çš„ç«‹ç»˜
                vnCharacter.style.backgroundImage = 'none';

                // 4. å°†æ¸…ç©ºåçš„çŠ¶æ€ä¿å­˜åˆ°æ•°æ®åº“
                saveDatingSetup();

                // 5. é‡æ–°æ£€æŸ¥è®¾ç½®å®Œæ•´æ€§ (è¿™ä¼šè‡ªåŠ¨ç¦ç”¨â€œè¿”å›çº¦ä¼šâ€æŒ‰é’®)
                checkSetupCompletion();
            }
        });
    }

    // ä¸“ç”¨äºç»‘å®šâ€œèƒŒæ™¯å›¾è®¾ç½®â€å­é¡µé¢çš„äº‹ä»¶
    function bindBackgroundSettingsEvents(container) {
        const bgUploadBox = container.querySelector('#bg-upload-box');
        const bgUploadInput = container.querySelector('#bg-upload-input');
        const bgPreviewsContainer = container.querySelector('#bg-previews-container');

        bgUploadBox.addEventListener('click', () => bgUploadInput.click());
        bgUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const tagsString = prompt("è¯·è¾“å…¥æ­¤èƒŒæ™¯çš„æ ‡ç­¾ (å¤šä¸ªæ ‡ç­¾è¯·ç”¨ç©ºæ ¼æˆ–é€—å·éš”å¼€):", "é»˜è®¤");
            if (tagsString === null) return;
            const tags = tagsString.split(/[\s,ï¼Œ]+/).filter(tag => tag);
            const reader = new FileReader();
            reader.onload = (e) => {
                const newBg = { url: e.target.result, tags: tags.length > 0 ? tags : ['æœªåˆ†ç±»'], isDefault: false };
                if (datingBackgrounds.length === 0) newBg.isDefault = true;
                datingBackgrounds.push(newBg);
                renderBgPreviewsInSettings(bgPreviewsContainer);
                saveDatingSetup();
            };
            reader.readAsDataURL(file);
        });

        bgPreviewsContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (!target.dataset.index) return;
            const index = parseInt(target.dataset.index, 10);

            if (target.classList.contains('set-default-btn')) {
                datingBackgrounds.forEach((bg, i) => bg.isDefault = (i === index));
                vnBackground.style.backgroundImage = `url('${datingBackgrounds[index].url}')`; // å®æ—¶æ›´æ–°ä¸»ç•Œé¢
                renderBgPreviewsInSettings(bgPreviewsContainer);
                saveDatingSetup();
            }

            if (target.classList.contains('delete-btn')) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèƒŒæ™¯å—ï¼Ÿ')) {
                    const wasDefault = datingBackgrounds[index].isDefault;
                    datingBackgrounds.splice(index, 1);
                    if (wasDefault && datingBackgrounds.length > 0) {
                        datingBackgrounds[0].isDefault = true;
                        vnBackground.style.backgroundImage = `url('${datingBackgrounds[0].url}')`;
                    } else if (datingBackgrounds.length === 0) {
                        vnBackground.style.backgroundImage = 'none';
                    }
                    renderBgPreviewsInSettings(bgPreviewsContainer);
                    saveDatingSetup();
                }
            }
        });

        function renderBgPreviewsInSettings(previewContainer) {
            previewContainer.innerHTML = '';
            datingBackgrounds.forEach((bg, index) => {
                const item = document.createElement('div');
                item.className = 'bg-preview-item';
                item.innerHTML = `
                ${bg.isDefault ? '<div class="default-tag">é»˜è®¤</div>' : ''}
                <div class="preview-img" style="background-image: url('${bg.url}')"></div>
                <div class="preview-details">
                    <div class="preview-tags">æ ‡ç­¾: ${bg.tags.join(', ')}</div>
                    <div class="preview-actions">
                        <button class="set-default-btn" data-index="${index}">è®¾ä¸ºé»˜è®¤</button>
                        <button class="delete-btn" data-index="${index}">åˆ é™¤</button>
                    </div>
                </div>
            `;
                previewContainer.appendChild(item);
            });
        }

        renderBgPreviewsInSettings(bgPreviewsContainer); // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
    }

    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´æ–°çš„JSä»£ç  â–¼â–¼â–¼

    // --- æ¨¡æ¿: å®šä¹‰å­—ä½“è®¾ç½®æ§ä»¶çš„HTML ---
    const fontSettingsHTML = `
    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 20px; gap: 25px;">
        <div class="settings-column" style="width: 100%;">
            <h4>è§’è‰²å</h4>
            <div class="font-setting-item">
                <label for="char-name-color-input">æ–‡å­—é¢œè‰²</label>
                <div class="color-input-container">
                    <input type="text" id="char-name-color-input">
                    <input type="color" id="char-name-color-picker">
                </div>
            </div>
            <div class="font-setting-item">
                <label for="char-name-size-slider">æ–‡å­—å¤§å°</label>
                <div class="font-slider-container">
                    <input type="range" id="char-name-size-slider" min="12" max="24" step="1">
                    <span id="char-name-size-value">16px</span>
                </div>
            </div>
        </div>

        <div class="settings-column" style="width: 100%;">
            <h4>å¯¹è¯å†…å®¹</h4>
            <div class="font-setting-item">
                <label for="dialog-text-color-input">æ–‡å­—é¢œè‰²</label>
                <div class="color-input-container">
                    <input type="text" id="dialog-text-color-input">
                    <input type="color" id="dialog-text-color-picker">
                </div>
            </div>
            <div class="font-setting-item">
                <label for="dialog-text-size-slider">æ–‡å­—å¤§å°</label>
                <div class="font-slider-container">
                    <input type="range" id="dialog-text-size-slider" min="12" max="20" step="0.5">
                    <span id="dialog-text-size-value">15px</span>
                </div>
            </div>
        </div>
    </div>
`;

    // --- é€»è¾‘æ‹†åˆ†ï¼šä¸ºâ€œå­—ä½“è®¾ç½®â€å­é¡µé¢ç»‘å®šäº‹ä»¶ ---
    function bindFontSettingsEvents(container) {
        // è·å–æ‰€æœ‰æ§ä»¶
        const charNameColorInput = container.querySelector('#char-name-color-input');
        const charNameColorPicker = container.querySelector('#char-name-color-picker');
        const charNameSizeSlider = container.querySelector('#char-name-size-slider');
        const charNameSizeValue = container.querySelector('#char-name-size-value');

        const dialogTextColorInput = container.querySelector('#dialog-text-color-input');
        const dialogTextColorPicker = container.querySelector('#dialog-text-color-picker');
        const dialogTextSizeSlider = container.querySelector('#dialog-text-size-slider');
        const dialogTextSizeValue = container.querySelector('#dialog-text-size-value');

        // è·å–è¦å®æ—¶ä¿®æ”¹çš„VNç•Œé¢å…ƒç´ 
        const vnCharNameContainer = document.getElementById('vn-char-name-container');
        const vnDialogText = document.getElementById('vn-dialog-text');

        // --- åŠŸèƒ½1: åˆå§‹åŒ–æ§ä»¶çš„å€¼ ---
        function initializeValues() {
            // ä»VNç•Œé¢å…ƒç´ çš„å½“å‰æ ·å¼ä¸­è¯»å–åˆå§‹å€¼
            const initialNameColor = window.getComputedStyle(vnCharNameContainer).color;
            const initialNameSize = parseInt(window.getComputedStyle(vnCharNameContainer).fontSize, 10);
            const initialTextColor = window.getComputedStyle(vnDialogText).color;
            const initialTextSize = parseFloat(window.getComputedStyle(vnDialogText).fontSize);

            // è®¾ç½®è§’è‰²åæ§ä»¶
            charNameColorInput.value = rgbToHex(initialNameColor);
            charNameColorPicker.value = rgbToHex(initialNameColor);
            charNameSizeSlider.value = initialNameSize;
            charNameSizeValue.textContent = `${initialNameSize}px`;

            // è®¾ç½®å¯¹è¯å†…å®¹æ§ä»¶
            dialogTextColorInput.value = rgbToHex(initialTextColor);
            dialogTextColorPicker.value = rgbToHex(initialTextColor);
            dialogTextSizeSlider.value = initialTextSize;
            dialogTextSizeValue.textContent = `${initialTextSize}px`;
        }

        // --- åŠŸèƒ½2: ç»‘å®šäº‹ä»¶ç›‘å¬ ---
        // è§’è‰²åé¢œè‰²
        charNameColorInput.addEventListener('input', (e) => {
            const color = e.target.value;
            charNameColorPicker.value = color;
            vnCharNameContainer.style.color = color;
        });
        charNameColorPicker.addEventListener('input', (e) => {
            const color = e.target.value;
            charNameColorInput.value = color;
            vnCharNameContainer.style.color = color;
        });

        // è§’è‰²åå¤§å°
        charNameSizeSlider.addEventListener('input', (e) => {
            const size = e.target.value;
            charNameSizeValue.textContent = `${size}px`;
            vnCharNameContainer.style.fontSize = `${size}px`;
        });

        // å¯¹è¯å†…å®¹é¢œè‰²
        dialogTextColorInput.addEventListener('input', (e) => {
            const color = e.target.value;
            dialogTextColorPicker.value = color;
            vnDialogText.style.color = color;
        });
        dialogTextColorPicker.addEventListener('input', (e) => {
            const color = e.target.value;
            dialogTextColorInput.value = color;
            vnDialogText.style.color = color;
        });

        // å¯¹è¯å†…å®¹å¤§å°
        dialogTextSizeSlider.addEventListener('input', (e) => {
            const size = e.target.value;
            dialogTextSizeValue.textContent = `${size}px`;
            vnDialogText.style.fontSize = `${size}px`;
        });

        // --- è¾…åŠ©å‡½æ•°ï¼šå°†RGBé¢œè‰²å€¼è½¬æ¢ä¸ºåå…­è¿›åˆ¶ ---
        function rgbToHex(rgb) {
            let sep = rgb.indexOf(",") > -1 ? "," : " ";
            rgb = rgb.substr(4).split(")")[0].split(sep);
            let r = (+rgb[0]).toString(16),
                g = (+rgb[1]).toString(16),
                b = (+rgb[2]).toString(16);
            if (r.length == 1) r = "0" + r;
            if (g.length == 1) g = "0" + g;
            if (b.length == 1) b = "0" + b;
            return "#" + r + g + b;
        }

        // --- åˆå§‹åŒ– ---
        initializeValues();
    }
    /**
     * ä¸»å‡½æ•°ï¼šå¼€å§‹æ’­æ”¾ä¸€ä¸ªVNåœºæ™¯
     * @param {string} rawScript - AIç”Ÿæˆçš„åŸå§‹å‰§æœ¬å­—ç¬¦ä¸²
     */
    // --- è¿™æ˜¯ä¿®æ”¹åçš„å‡½æ•° ---
    function startVnScene(rawScript, triggerChoice = "(æ•…äº‹å¼€å§‹)") {
        lastVnUserChoice = triggerChoice; // è®°å½•è§¦å‘æœ¬æ¬¡åœºæ™¯çš„ç”¨æˆ·é€‰æ‹©
        vnConversationHistory.push(`AI: ${rawScript}`);

        vnDialogText.innerHTML = '';
        vnChoicesContainer.style.display = 'none';
        vnCharacter.style.opacity = 0;

        vnSceneQueue = parseVnScript(rawScript);
        currentSegmentIndex = 0;
        playNextSegment();
    }

    /**
     * ã€åå¤‡å‡½æ•°/é¢„å¤„ç†å™¨ã€‘
     * åœ¨æ­£å¼è§£æVNå‰§æœ¬å‰ï¼Œæ¸…ç†å’Œä¿®æ­£AIå¯èƒ½è¿”å›çš„ä¸è§„èŒƒæ ¼å¼ã€‚
     * æ ¸å¿ƒåŠŸèƒ½ï¼šæŸ¥æ‰¾å¹¶ä¿®å¤é‚£äº›è¢«é”™è¯¯åœ°åˆå¹¶åˆ°åŒä¸€è¡Œçš„æŒ‡ä»¤ (å¦‚ 'æ—ç™½' å’Œ 'é€‰é¡¹')ã€‚
     * @param {string} rawScript - ä»AIè·å–çš„åŸå§‹å‰§æœ¬å­—ç¬¦ä¸²ã€‚
     * @returns {string} - è¿”å›ä¸€ä¸ªæ ¼å¼ä¿®æ­£åçš„å‰§æœ¬å­—ç¬¦ä¸²ã€‚
     */
    function preProcessVnScript(rawScript) {
        // 1. å®šä¹‰éœ€è¦æ£€æŸ¥çš„å…³é”®è¯åˆ—è¡¨ã€‚é¡ºåºå¾ˆé‡è¦ï¼Œæˆ‘ä»¬æŠŠæœ€å¯èƒ½è¢«åµŒå…¥çš„'é€‰é¡¹'æ”¾åœ¨å‰é¢ã€‚
        //    æˆ‘ä»¬åŠ¨æ€åœ°è·å–å½“å‰AIçš„è§’è‰²åï¼Œç¡®ä¿å®ƒä¹Ÿèƒ½è¢«æ­£ç¡®å¤„ç†ã€‚
        const keywords = [
            'é€‰é¡¹ï¼š',
            'æ—ç™½ï¼š',
            currentOpenContact.ai.name + 'ï¼š'
        ];

        // 2. å°†æ•´ä¸ªå‰§æœ¬æŒ‰è¡Œåˆ†å‰²æˆä¸€ä¸ªæ•°ç»„ï¼Œæ–¹ä¾¿é€è¡Œå¤„ç†ã€‚
        let lines = rawScript.split('\n');

        // 3. åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„æ¥å­˜æ”¾å¤„ç†åçš„å¹²å‡€è¡Œã€‚
        const processedLines = [];

        // 4. éå†åŸå§‹çš„æ¯ä¸€è¡Œã€‚
        for (const line of lines) {
            let currentLine = line.trim(); // å»æ‰å‰åçš„ç©ºæ ¼
            let foundAndSplit = false; // æ ‡è®°å½“å‰è¡Œæ˜¯å¦è¢«åˆ†å‰²è¿‡

            // 5. å¾ªç¯æ£€æŸ¥æ¯ä¸ªå…³é”®è¯æ˜¯å¦è¢«â€œåµŒå…¥â€åˆ°äº†å½“å‰è¡Œä¸­ã€‚
            for (const keyword of keywords) {
                // ä½¿ç”¨ indexOf æŸ¥æ‰¾å…³é”®è¯çš„ä½ç½®ã€‚
                // å…³é”®æ¡ä»¶ï¼š `> 0` è¡¨ç¤ºå…³é”®è¯å­˜åœ¨ï¼Œä½†**ä¸**åœ¨è¡Œé¦–ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬è¦æ‰¾çš„é”™è¯¯æ ¼å¼ï¼
                const keywordIndex = currentLine.indexOf(keyword);

                if (keywordIndex > 0) {
                    // a. æ‰¾åˆ°äº†åµŒå…¥çš„å…³é”®è¯ï¼æˆ‘ä»¬å°†è¿™ä¸€è¡Œä»å…³é”®è¯å¤„åˆ†å‰²æˆä¸¤éƒ¨åˆ†ã€‚
                    const part1 = currentLine.substring(0, keywordIndex).trim();
                    const part2 = currentLine.substring(keywordIndex).trim();

                    // b. å°†åˆ†å‰²åçš„ä¸¤éƒ¨åˆ†ä½œä¸ºç‹¬ç«‹çš„ä¸¤è¡Œï¼Œæ·»åŠ åˆ°æˆ‘ä»¬çš„æ–°æ•°ç»„ä¸­ã€‚
                    processedLines.push(part1);
                    processedLines.push(part2);

                    foundAndSplit = true; // æ ‡è®°å·²å¤„ç†
                    break; // å¤„ç†å®Œä¸€ä¸ªåµŒå…¥å…³é”®è¯åï¼Œå°±æ— éœ€å†æ£€æŸ¥è¯¥è¡Œçš„å…¶ä»–å…³é”®è¯ï¼Œè·³å‡ºå†…å±‚å¾ªç¯ã€‚
                }
            }

            // 6. å¦‚æœå½“å‰è¡Œæ²¡æœ‰å‘ç°ä»»ä½•åµŒå…¥çš„å…³é”®è¯ï¼Œè¯´æ˜å®ƒæ ¼å¼æ­£ç¡®ï¼Œç›´æ¥ä¿ç•™ã€‚
            if (!foundAndSplit) {
                processedLines.push(currentLine);
            }
        }

        // 7. æœ€åï¼Œå°†å¤„ç†è¿‡çš„æ‰€æœ‰è¡Œç”¨æ¢è¡Œç¬¦é‡æ–°ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„ã€æ ¼å¼æ­£ç¡®çš„å‰§æœ¬å­—ç¬¦ä¸²å¹¶è¿”å›ã€‚
        return processedLines.join('\n');
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šè§£æAIçš„å‰§æœ¬å­—ç¬¦ä¸²ä¸ºç»“æ„åŒ–æ•°ç»„ (V4 - æœ€ç»ˆä¿®å¤ç‰ˆ)
     * @param {string} rawScript - åŸå§‹å‰§æœ¬
     * @returns {Array<object>}
     */
    function parseVnScript(rawScript) {
        rawScript = preProcessVnScript(rawScript);
        const queue = [];
        // V4ç‰ˆæ­£åˆ™è¡¨è¾¾å¼ï¼Œä½¿ç”¨å‘½åæ•è·ç»„å’Œæ›´ç²¾ç¡®çš„åŒ¹é…ï¼Œéå¸¸ç¨³å¥
        // ä¿®å¤ï¼šè§’è‰²ååº”è¯¥æ˜¯ä¸åŒ…å«æ¢è¡Œç¬¦ã€å¥å·ç­‰æ ‡ç‚¹çš„çŸ­æ–‡æœ¬
        const regex = /(?<speaker>æ—ç™½|é€‰é¡¹|[^ï¼š\n\\ã€‚ï¼Œï¼ï¼Ÿï¼›]+?)ï¼š(?<content>[\s\S]*?)(?=\n?(?:æ—ç™½|é€‰é¡¹|[^ï¼š\n\\ã€‚ï¼Œï¼ï¼Ÿï¼›]+?)ï¼š|$)/g;

        const matches = [...rawScript.matchAll(regex)];

        if (matches.length === 0) {
            // å¦‚æœæ­£åˆ™æ²¡åŒ¹é…åˆ°ä»»ä½•å†…å®¹ï¼Œè¯´æ˜å¯èƒ½æ˜¯çº¯æ–‡æœ¬ï¼Œä½œä¸ºAIå¯¹è¯å¤„ç†
            const segments = rawScript.split('\\').map(s => s.trim()).filter(s => s);
            if (segments.length > 0 && currentOpenContact) {
                queue.push({ type: 'dialogue', speaker: currentOpenContact.ai.name, segments });
            }
            return queue;
        }

        for (const match of matches) {
            const { speaker, content } = match.groups;
            const trimmedSpeaker = speaker.trim();
            const trimmedContent = content.trim();

            if (!trimmedContent) continue;

            if (trimmedSpeaker === 'æ—ç™½') {
                const segments = trimmedContent.split('\\').map(s => s.trim()).filter(s => s);
                queue.push({ type: 'narration', speaker: 'æ—ç™½', segments });
            } else if (trimmedSpeaker === 'é€‰é¡¹') {
                const options = trimmedContent.split('ï¼›').map(opt => opt.replace(/^\d+\.\s*/, '').trim());
                queue.push({ type: 'choices', options });
            } else {
                const segments = trimmedContent.split('\\').map(s => s.trim()).filter(s => s);
                queue.push({ type: 'dialogue', speaker: trimmedSpeaker, segments });
            }
        }
        return queue;
    }
    /**
     * æ ¸å¿ƒå‡½æ•°ï¼šæ’­æ”¾é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€æ®µ
     */
    function playNextSegment() {
        if (currentSegmentIndex >= vnSceneQueue.length) {
            console.log("å‰§æœ¬æ’­æ”¾å®Œæ¯•ã€‚");
            return;
        }

        const currentPart = vnSceneQueue[currentSegmentIndex];

        if (currentPart.type === 'narration' || currentPart.type === 'dialogue') {
            if (currentPart.type === 'narration') {
                vnCharName.textContent = 'æ—ç™½';
                vnCharacter.style.opacity = 0; // æ—ç™½æ—¶éšè—ç«‹ç»˜
            } else {
                vnCharName.textContent = currentPart.speaker.toUpperCase();
                vnCharacter.style.opacity = 1; // å¯¹è¯æ—¶æ˜¾ç¤ºç«‹ç»˜
            }

            // é€æ®µæ’­æ”¾ segments æ•°ç»„é‡Œçš„å†…å®¹
            let segmentIdx = 0;
            const playSegment = () => {
                if (segmentIdx < currentPart.segments.length) {
                    typewriterEffect(vnDialogText, currentPart.segments[segmentIdx], () => {
                        segmentIdx++;
                        // å½“å‰æ®µè½æ’­æ”¾å®Œåï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç»§ç»­
                    });
                } else {
                    // å½“å‰éƒ¨åˆ†çš„æ‰€æœ‰æ®µè½éƒ½å·²æ’­æ”¾å®Œï¼Œè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€éƒ¨åˆ†
                    currentSegmentIndex++;
                    playNextSegment();
                }
            };

            // ä¸ºå¯¹è¯æ¡†ç»‘å®šä¸€æ¬¡æ€§çš„ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºæ’­æ”¾ä¸‹ä¸€æ®µ
            vnDialogBox.onclick = () => {
                if (isTyping) { // å¦‚æœæ­£åœ¨æ‰“å­—ï¼Œç‚¹å‡»åˆ™å¿«è¿›
                    isTyping = false; // è¿™ä¼šä¸­æ–­æ‰“å­—æœºå¾ªç¯
                } else { // å¦‚æœæ‰“å­—ç»“æŸï¼Œç‚¹å‡»åˆ™æ’­æ”¾ä¸‹ä¸€æ®µ
                    playSegment();
                }
            };

            playSegment(); // è‡ªåŠ¨å¼€å§‹æ’­æ”¾ç¬¬ä¸€æ®µ

        } else if (currentPart.type === 'choices') {
            displayChoices(currentPart.options);
        }
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šå®ç°é€å­—æ‰“å°æ•ˆæœ
     * @param {HTMLElement} element - è¦æ‰“å°åˆ°çš„å…ƒç´ 
     * @param {string} text - è¦æ‰“å°çš„æ–‡æœ¬
     * @param {Function} onComplete - å®Œæˆåçš„å›è°ƒ
     */
    /**
     * ä¼˜åŒ–åçš„æ‰“å­—æœºæ•ˆæœ
     */
    function typewriterEffect(element, text, onComplete) {
        isTyping = true;
        element.innerHTML = ''; // æ¸…ç©ºä¸Šä¸€æ®µè¯
        // === ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨ textContent æˆ–è€… createTextNode ===
        // è¿™ç§æ–¹å¼ä¸ä¼šå¯¼è‡´æ•´ä¸ªå®¹å™¨çš„é‡æ’ï¼Œæ€§èƒ½æé«˜
        element.appendChild(document.createTextNode(text.charAt(i)));

        i++;
        setTimeout(type, TYPEWRITER_SPEED);

        let i = 0;

        function type() {
            if (!isTyping) { // å¿«è¿›é€»è¾‘
                element.innerHTML = text; // æœ€åä¸€æ¬¡æ€§èµ‹å€¼æ˜¯æ²¡é—®é¢˜çš„
                onComplete();
                return;
            }
            if (i < text.length) { } else {
                isTyping = false;
                onComplete();
            }
        }
        type();
    }


    /**
     * è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé€‰é¡¹æŒ‰é’® (V3 - åŠ¨ç”»ä¿®å¤ç‰ˆ)
     * @param {Array<string>} options - é€‰é¡¹æ–‡æœ¬æ•°ç»„
     */
    function displayChoices(options) {
        vnDialogBox.onclick = null;
        vnChoicesContainer.innerHTML = '';

        options.forEach(optText => {
            const btn = document.createElement('button');
            btn.className = 'vn-choice-btn';
            btn.textContent = optText;
            btn.onclick = () => handleChoiceSelection(optText);
            vnChoicesContainer.appendChild(btn);
        });

        const customBtn = document.createElement('button');
        customBtn.className = 'vn-choice-btn';
        customBtn.textContent = 'è‡ªå®šä¹‰...';

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å°±åœ¨è¿™é‡Œ â–¼â–¼â–¼
        // è¿™æ®µä»£ç ä¼šæ­£ç¡®åœ°è§¦å‘å±…ä¸­å¼¹çª—åŠ¨ç”»
        customBtn.onclick = () => {
            customChoiceInput.value = '';
            customChoiceModal.style.display = 'flex'; // 1. å…ˆè®©å¼¹çª—åœ¨DOMä¸­å¯è§
            setTimeout(() => {
                customChoiceModal.classList.add('visible'); // 2. è§¦å‘CSSæ·¡å…¥åŠ¨ç”»
                customChoiceInput.focus(); // 3. ã€è§£å†³åŒå‡»é—®é¢˜ã€‘è‡ªåŠ¨å°†å…‰æ ‡èšç„¦åˆ°è¾“å…¥æ¡†
            }, 10); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿å…ƒç´ å¯è§åå†èšç„¦
        };
        // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

        vnChoicesContainer.appendChild(customBtn);
        vnChoicesContainer.style.display = 'flex';
    }

    /**
     * æ ¸å¿ƒå‡½æ•°ï¼šå¤„ç†ç”¨æˆ·çš„é€‰æ‹© (V2 - æ¥å…¥çœŸå®AI)
     * @param {string} choiceText - ç”¨æˆ·é€‰æ‹©çš„æ–‡æœ¬
     */
    // --- è¿™æ˜¯ä¿®æ”¹åçš„å‡½æ•° ---
    async function handleChoiceSelection(choiceText) {
        vnConversationHistory.push(`ç”¨æˆ·ï¼š${choiceText}`);
        console.log("ç”¨æˆ·é€‰æ‹©äº†:", choiceText);
        vnChoicesContainer.style.display = 'none';

        vnCharName.textContent = currentOpenContact.user.name.toUpperCase();
        await new Promise(resolve => typewriterEffect(vnDialogText, choiceText, resolve));

        setTimeout(async () => {
            vnDialogText.innerHTML = '<div class="dialog-loader"><span></span><span></span><span></span></div>';
            const aiScript = await callVnAI(choiceText);

            if (aiScript) {
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå°†ç”¨æˆ·çš„é€‰æ‹©ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ â–¼â–¼â–¼
                startVnScene(aiScript, choiceText);
            } else {
                vnDialogText.innerHTML = 'AIç»­å†™å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®æˆ–ç½‘ç»œåé‡è¯•ã€‚';
            }
        }, 1000);
    }

    // 2. æ‰“å¼€/å…³é—­å¼¹çª—çš„å‡½æ•°
    function openStylePresetModal(preset = null) {
        if (preset) {
            currentEditingPresetId = preset.id;
            stylePresetModalTitle.textContent = 'ç¼–è¾‘åå¥½';
            stylePresetInput.value = preset.text;
        } else {
            currentEditingPresetId = null;
            stylePresetModalTitle.textContent = 'æ·»åŠ åå¥½';
            stylePresetInput.value = '';
        }

        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤åœ¨è¿™é‡Œ â–¼â–¼â–¼
        stylePresetModal.style.display = 'flex'; // 1. å…ˆè®©å…ƒç´ åœ¨å¸ƒå±€ä¸­å¯è§
        setTimeout(() => {
            // 2. ç„¶åå†æ·»åŠ  .visible ç±»æ¥è§¦å‘CSSåŠ¨ç”»
            stylePresetModal.classList.add('visible');
        }, 10);
        // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
    }
    function closeStylePresetModal() {
        stylePresetModal.classList.remove('visible');
        setTimeout(() => stylePresetModal.style.display = 'none', 300);
    }

    // 3. ä»æ•°æ®åº“åŠ è½½å¹¶æ¸²æŸ“æ‰€æœ‰åå¥½å¡ç‰‡
    async function renderStylePresets(container) {
        container.innerHTML = '<p style="text-align:center; color:#888;">æ­£åœ¨åŠ è½½...</p>';
        try {
            const presetsData = await dbHelper.loadData('writingStylePresets', 'allPresets');
            const activePresetsData = await dbHelper.loadData('writingStylePresets', 'activePresetIds'); // Load an array of IDs
            const allPresets = (presetsData && Array.isArray(presetsData.value)) ? presetsData.value : [];
            const activePresetIds = (activePresetsData && Array.isArray(activePresetsData.value)) ? new Set(activePresetsData.value) : new Set(); // Use a Set for fast lookups

            if (allPresets.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; padding-top: 50px;">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•æ–‡ç¬”åå¥½<br>ç‚¹å‡»å³ä¸Šè§’â€œæ·»åŠ â€æ¥åˆ›å»ºç¬¬ä¸€ä¸ªå§ï¼</p>';
                return;
            }

            container.innerHTML = '';
            allPresets.forEach(preset => {
                const card = document.createElement('div');
                card.className = 'preset-card';
                const isActive = activePresetIds.has(preset.id); // Check if the ID is in our active set
                if (isActive) {
                    card.classList.add('active');
                }
                card.dataset.presetId = preset.id;
                card.innerHTML = `
                        <div class="active-tag">å·²æ¿€æ´»</div>
                        <p class="preset-text">${preset.text}</p>
                        <div class="preset-actions">
                            <button class="select-preset-btn">${isActive ? 'å–æ¶ˆé€‰æ‹©' : 'é€‰æ‹©'}</button>
                            <button class="edit-preset-btn">ç¼–è¾‘</button>
                            <button class="delete-btn delete-preset-btn">åˆ é™¤</button>
                        </div>
                    `;
                container.appendChild(card);
            });
        } catch (error) {
            console.error("åŠ è½½æ–‡ç¬”åå¥½å¤±è´¥:", error);
            container.innerHTML = '<p style="text-align:center; color:red;">åŠ è½½å¤±è´¥ï¼</p>';
        }
    }

    // 4. ç»‘å®šæ‰€æœ‰äº‹ä»¶
    addStylePresetBtn.addEventListener('click', () => openStylePresetModal());
    // æ ·å¼é¢„è®¾å¼¹çª—å…³é—­
if (stylePresetModalCloseBtn) {
    stylePresetModalCloseBtn.addEventListener('click', () => {
        window.DOMCleanupManager.clean('style-presets-container');
        closeStylePresetModal;
    });
}

    saveStylePresetBtn.addEventListener('click', async () => {
        const text = stylePresetInput.value.trim();
        if (!text) {
            alert('åå¥½å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }

        try {
            const presetsData = await dbHelper.loadData('writingStylePresets', 'allPresets');
            let allPresets = (presetsData && Array.isArray(presetsData.value)) ? presetsData.value : [];

            if (currentEditingPresetId) {
                // ç¼–è¾‘
                const index = allPresets.findIndex(p => p.id === currentEditingPresetId);
                if (index > -1) {
                    allPresets[index].text = text;
                }
            } else {
                // æ–°å»º
                const newPreset = { id: Date.now(), text: text };
                allPresets.unshift(newPreset);
            }

            await dbHelper.saveData('writingStylePresets', 'allPresets', allPresets);
            closeStylePresetModal();
            renderStylePresets(stylePresetsContainer); // é‡æ–°æ¸²æŸ“åˆ—è¡¨

        } catch (error) {
            console.error("ä¿å­˜åå¥½å¤±è´¥:", error);
            alert("ä¿å­˜å¤±è´¥ï¼");
        }
    });

    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å¡ç‰‡ä¸Šçš„æŒ‰é’®ç‚¹å‡»
    stylePresetsContainer.addEventListener('click', async (event) => {
        const button = event.target;
        const card = button.closest('.preset-card');
        if (!card) return;
        const presetId = parseInt(card.dataset.presetId, 10);

        const presetsData = await dbHelper.loadData('writingStylePresets', 'allPresets');
        let allPresets = (presetsData && Array.isArray(presetsData.value)) ? presetsData.value : [];
        const preset = allPresets.find(p => p.id === presetId);

        if (button.classList.contains('select-preset-btn')) {
            // --- Multi-select logic ---
            const activeData = await dbHelper.loadData('writingStylePresets', 'activePresetIds');
            let activeIds = (activeData && Array.isArray(activeData.value)) ? activeData.value : [];

            if (activeIds.includes(presetId)) {
                // If already active, remove it
                activeIds = activeIds.filter(id => id !== presetId);
            } else {
                // If not active, add it
                activeIds.push(presetId);
            }
            await dbHelper.saveData('writingStylePresets', 'activePresetIds', activeIds);
            renderStylePresets(stylePresetsContainer); // Re-render to update UI

        } else if (button.classList.contains('edit-preset-btn')) {
            openStylePresetModal(preset);
        } else if (button.classList.contains('delete-preset-btn')) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ç¬”åå¥½å—ï¼Ÿ')) {
                const updatedPresets = allPresets.filter(p => p.id !== presetId);
                await dbHelper.saveData('writingStylePresets', 'allPresets', updatedPresets);

                // Also remove it from active IDs if it was active
                const activeData = await dbHelper.loadData('writingStylePresets', 'activePresetIds');
                if (activeData && activeData.value) {
                    let activeIds = activeData.value.filter(id => id !== presetId);
                    await dbHelper.saveData('writingStylePresets', 'activePresetIds', activeIds);
                }

                renderStylePresets(stylePresetsContainer);
            }
        }
    });


    /**
     * ä¸€ä¸ªç®€åŒ–çš„AIè°ƒç”¨å‡½æ•°ï¼Œç”¨äºè·å–ç®€å•çš„æ–‡æœ¬å›å¤ï¼ˆä¾‹å¦‚æ‘˜è¦ï¼‰ã€‚
     * @param {string} promptText - å‘é€ç»™AIçš„æŒ‡ä»¤æ–‡æœ¬ã€‚
     * @returns {Promise<string|null>} - è¿”å›AIç”Ÿæˆçš„æ–‡æœ¬ï¼Œæˆ–åœ¨å¤±è´¥æ—¶è¿”å›nullã€‚
     */
    async function fetchSimpleAiResponse(promptText) {
        try {
            // 1. è·å–APIè®¾ç½®
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value.url) throw new Error("APIæœªé…ç½®");
            const { url, key, model, temperature } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // 2. æ„é€ ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯ä½“
            const messages = [
                { role: "system", content: "You are a helpful assistant that provides concise text responses based on user instructions." },
                { role: "user", content: promptText }
            ];

            // 3. å‘é€è¯·æ±‚
            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    temperature: parseFloat(temperature) || 0.7, // æ‘˜è¦ä»»åŠ¡å¯ä»¥ä½¿ç”¨ç¨ä½çš„æ¸©åº¦
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({})); // å°è¯•è§£æé”™è¯¯ä½“
                console.error("âŒ API è¯·æ±‚å¤±è´¥è¯¦æƒ…:", errorData);

                // ç‰¹åˆ«æç¤ºï¼šå¦‚æœæ˜¯ä¸Šä¸‹æ–‡è¶…é•¿
                if (errorData.error && errorData.error.code === 'context_length_exceeded') {
                    alert("ğŸ˜­ å¤±è´¥ï¼šå‘é€çš„å†…å®¹å¤ªé•¿äº†ï¼è¯·ç²¾ç®€ä¸–ç•Œä¹¦æˆ–Promptã€‚");
                } else if (response.status === 401) {
                    alert("ğŸ”‘ å¤±è´¥ï¼šAPI Key é”™è¯¯æˆ–è¿‡æœŸã€‚");
                } else {
                    alert(`âš ï¸ APIæŠ¥é”™ (${response.status}): è¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°è¯¦æƒ…`);
                }

                return null; // è¿™é‡Œè¿”å› nullï¼Œå¤–éƒ¨å‡½æ•°å°±ä¼šçŸ¥é“å¤±è´¥äº†
            }
            const data = await response.json();
            // æ£€æŸ¥è¿”å›ç»“æ„æ˜¯å¦åˆæ³•
            if (!data.choices || data.choices.length === 0) {
                console.warn("API è¿”å›äº†ç©ºå†…å®¹:", data);
                return null;
            }

            return data.choices[0].message.content;

        } catch (error) {
            console.error("â›” ç½‘ç»œé”™è¯¯:", error);
            alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä½ çš„ä»£ç†æˆ–ç½‘ç»œè®¾ç½®ã€‚");
            return null;
        }
    }
    // â–¼â–¼â–¼ åœ¨è¿™é‡Œç²˜è´´ç¼ºå¤±çš„è¾…åŠ©å‡½æ•° â–¼â–¼â–¼

    /**
     * ä¸€ä¸ªç®€åŒ–çš„AIè°ƒç”¨å‡½æ•°ï¼Œç”¨äºè·å–ç®€å•çš„æ–‡æœ¬å›å¤ï¼ˆä¾‹å¦‚æ‘˜è¦ï¼‰ã€‚
     * @param {string} promptText - å‘é€ç»™AIçš„æŒ‡ä»¤æ–‡æœ¬ã€‚
     * @returns {Promise<string|null>} - è¿”å›AIç”Ÿæˆçš„æ–‡æœ¬ï¼Œæˆ–åœ¨å¤±è´¥æ—¶è¿”å›nullã€‚
     */
    async function fetchSimpleAiResponse(promptText) {
        try {
            // 1. è·å–APIè®¾ç½®
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value.url) throw new Error("APIæœªé…ç½®");
            const { url, key, model, temperature } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // 2. æ„é€ ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯ä½“
            const messages = [
                { role: "system", content: "You are a helpful assistant that provides concise text responses based on user instructions." },
                { role: "user", content: promptText }
            ];

            // 3. å‘é€è¯·æ±‚
            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    temperature: parseFloat(temperature) || 0.7, // æ‘˜è¦ä»»åŠ¡å¯ä»¥ä½¿ç”¨ç¨ä½çš„æ¸©åº¦
                })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            const data = await response.json();
            return data.choices[0].message.content;

        } catch (error) {
            console.error("fetchSimpleAiResponse å¤±è´¥:", error);
            // åœ¨è¿™ç§è¾…åŠ©å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ç›´æ¥alertï¼Œè€Œæ˜¯è¿”å›nullè®©è°ƒç”¨è€…å¤„ç†
            return null;
        }
    }



    // â–¼â–¼â–¼ ä½¿ç”¨è¿™ä¸ªã€å…¨æ–°ç‰ˆæœ¬ã€‘æ›¿æ¢æ‰æ‚¨åŸæ¥çš„ callVnAI å‡½æ•° â–¼â–¼â–¼

    /**
     * ä¸“ç”¨äºVNçº¦ä¼šæ¨¡å¼çš„AIè°ƒç”¨å‡½æ•° (V3 - å·²ä¿®å¤ä¸–ç•Œä¹¦è¯»å–å’Œè®°å¿†é—®é¢˜)
     * @param {string} userChoice - ç”¨æˆ·ä¸Šä¸€æ­¥çš„é€‰æ‹©æˆ–è¡ŒåŠ¨
     * @returns {Promise<string|null>} - è¿”å›AIç”Ÿæˆçš„å‰§æœ¬å­—ç¬¦ä¸²ï¼Œæˆ–åœ¨å¤±è´¥æ—¶è¿”å›null
     */
    async function callVnAI(userChoice) {
        if (!currentOpenContact) return null;

        try {
            // 1. è·å–APIè®¾ç½® (ä¸å˜)
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value.url) throw new Error("APIæœªé…ç½®");
            const { url, key, model, temperature } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // 2. è·å–æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯

            // ã€ä¿®å¤ â‘ ã€‘: ä»ä¸»èŠå¤©è®°å½•ä¸­åŠ è½½å†å²ï¼Œä½œä¸ºâ€œå‰æƒ…æè¦â€
            const history = currentOpenContact.history || [];
            const recentHistory = history.slice(-5); // å–æœ€è¿‘5æ¡ä½œä¸ºå‚è€ƒ
            // Example of how to structure the history string
            let chatHistoryForPrompt = recentHistory.map(msg => {
                const sender = msg.sender === 'user' ? contact.user.name : contact.ai.name;
                let text = msg.text || '';

                // Check if this message is a reply to someone
                if (msg.replyTo) { // Assuming you save replyTo info in your message object
                    return `${sender} (replying to ${msg.replyTo.senderName}): ${text}`;
                }

                return `${sender}: ${text}`;
            }).join('\n');
            if (!chatHistoryForPrompt) chatHistoryForPrompt = "æ— ";

            // ã€ä¿®å¤ â‘¡ã€‘: çœŸæ­£åœ°ä»æ•°æ®åº“åŠ è½½ä¸–ç•Œä¹¦å†…å®¹
            let worldBookContent = "æ— ç‰¹å®šä¸–ç•Œè§‚è®¾å®šã€‚";
            if (currentOpenContact.linkedWorldBookGroupIds && currentOpenContact.linkedWorldBookGroupIds.length > 0) {
                try {
                    const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                    const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                    const worldbookData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
                    const allBooks = (worldbookData && Array.isArray(worldbookData.value)) ? worldbookData.value : [];
                    const linkedGroupIds = new Set(currentOpenContact.linkedWorldBookGroupIds);
                    const requiredBookIds = new Set();
                    allGroups.forEach(group => {
                        if (linkedGroupIds.has(group.id) && Array.isArray(group.bookIds)) {
                            group.bookIds.forEach(bookId => requiredBookIds.add(bookId));
                        }
                    });
                    const linkedBooksContent = allBooks
                        .filter(book => requiredBookIds.has(book.id))
                        .map(book => `### ä¸–ç•Œä¹¦: ${book.name}\n\n${book.content}`)
                        .join('\n\n---\n\n');
                    if (linkedBooksContent) {
                        worldBookContent = linkedBooksContent;
                    }
                } catch (dbError) {
                    console.error("åŠ è½½å…³è”çš„ä¸–ç•Œä¹¦ç»„å†…å®¹æ—¶å‡ºé”™:", dbError);
                }
            }

            // è·å–æ–‡ç¬”åå¥½ (ä¸å˜)
            let writingStyle = "è¯·è‡ªç”±å‘æŒ¥ï¼Œæ–‡ç¬”ä¼˜ç¾è‡ªç„¶å³å¯ã€‚";
            const allPresetsData = await dbHelper.loadData('writingStylePresets', 'allPresets');
            const activePresetIdsData = await dbHelper.loadData('writingStylePresets', 'activePresetIds');
            if (allPresetsData && activePresetIdsData && Array.isArray(allPresetsData.value) && Array.isArray(activePresetIdsData.value)) {
                const allPresets = allPresetsData.value;
                const activeIds = new Set(activePresetIdsData.value);
                const activeStyles = allPresets.filter(p => activeIds.has(p.id)).map(p => p.text);
                if (activeStyles.length > 0) {
                    writingStyle = activeStyles.join('\n\n');
                }
            }

            // 3. å°†æ‰€æœ‰ä¿¡æ¯æ‰“åŒ…æˆ context å¯¹è±¡ (ä¸å˜)
            const promptContext = {
                ai_name: currentOpenContact.ai.name,
                user_name: currentOpenContact.user.name,
                ai_persona: currentOpenContact.ai.persona || 'æ— ',
                user_persona: currentOpenContact.user.persona || 'æ— ',
                world_book_content: worldBookContent,
                chat_history: chatHistoryForPrompt,
                user_choice: userChoice,
                writing_style: writingStyle,
                // ã€ä¿®å¤ â‘¢ã€‘: å°†çº¦ä¼šè¿‡ç¨‹ä¸­çš„å¯¹è¯å†å²ä¹ŸåŠ å…¥è¿›æ¥ï¼Œè¿™æ˜¯è§£å†³â€œé‡å¤â€é—®é¢˜çš„å…³é”®ï¼
                scene_history: vnConversationHistory.join('\n')
            };

            // 4. è°ƒç”¨å‡½æ•°ç”Ÿæˆæœ€ç»ˆçš„ System Prompt
            const finalSystemPrompt = getVnSystemPrompt(promptContext);

            // 5. æ„é€ APIè¯·æ±‚ä½“ (ä¸å˜)
            const messages = [
                { role: "system", content: finalSystemPrompt },
                { role: "user", content: "è¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ï¼Œç»§ç»­æˆ‘ä»¬çš„çº¦ä¼šæ•…äº‹ã€‚" }
            ];

            // 6. å‘é€è¯·æ±‚ (ä¸å˜)
            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model,
                    messages,
                    temperature: parseFloat(temperature) || 1.0,
                })
            });

            if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            const data = await response.json();
            return data.choices[0].message.content;

        } catch (error) {
            console.error("è°ƒç”¨VN AIå¤±è´¥:", error);
            alert(`AIåˆ›ä½œå¤±è´¥: ${error.message}`);
            return null;
        }
    }
    function getVnSystemPrompt(context) {
        return `
### æ ¸å¿ƒèº«ä»½
ä½ æ˜¯ä¸€ä½æ‰åæ¨ªæº¢çš„æ²‰æµ¸å¼æ•…äº‹ä½œå®¶å’Œçº¦ä¼šæ¨¡æ‹Ÿå¼•æ“ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æä¾›çš„ä¸Šä¸‹æ–‡ï¼ŒåŠ¨æ€åˆ›ä½œä¸€æ®µåŒ…å«æ—ç™½ã€è§’è‰²å¯¹è¯å’Œé€‰é¡¹çš„äº’åŠ¨å¼çº¦ä¼šåœºæ™¯ã€‚

### ä¸Šä¸‹æ–‡ä¿¡æ¯
ä½ æ­£åœ¨ç»­å†™ä½ ï¼ˆæ‰®æ¼” ${context.ai_name}ï¼‰å’Œç”¨æˆ·ï¼ˆæ‰®æ¼” ${context.user_name}ï¼‰ä¹‹é—´çš„ä¸€æ®µçº¦ä¼šæ•…äº‹ã€‚
- è§’è‰²è®¾å®šï¼š${context.ai_persona}
- ç”¨æˆ·è®¾å®šï¼š${context.user_persona}
- ä¸–ç•Œè§‚è®¾å®šï¼š${context.world_book_content}
- æœ€è¿‘çš„èŠå¤©è®°å½•ï¼ˆçº¦ä¼šå‰çš„é“ºå«ï¼‰ï¼š${context.chat_history}
- æœ¬æ¬¡çº¦ä¼šçš„åœºæ™¯å†å²ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰ï¼š
${context.scene_history || 'ï¼ˆè¿™æ˜¯çº¦ä¼šçš„å¼€å§‹ï¼‰'}
- ç”¨æˆ·åˆšåˆšçš„è¡ŒåŠ¨/é€‰æ‹©æ˜¯ï¼šâ€${context.user_choice}â€œ


### æ–‡ç¬”é£æ ¼åå¥½ (å¿…é¡»éµå®ˆ)
${context.writing_style}

---
### ã€æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ã€‘
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è§„åˆ™ï¼Œè¿™æ˜¯ç¨‹åºæ­£ç¡®è¿è¡Œçš„ä¿éšœã€‚

#### 1. å™äº‹è§†è§’è§„åˆ™ (Narrative Perspective)
- **å½“ä½¿ç”¨ "æ—ç™½ï¼š" æ—¶**ï¼šä½ æ˜¯ä¸€ä¸ªå®¢è§‚çš„ã€æ²¡æœ‰æ„Ÿæƒ…çš„ã€ç¬¬ä¸‰äººç§°ã€‘å™äº‹è€…ã€‚ä½ å¿…é¡»ç”¨â€œä»–â€ã€â€œå¥¹â€æˆ–è§’è‰²åï¼ˆ${context.ai_name}ï¼‰æ¥ç§°å‘¼AIè§’è‰²ï¼Œç”¨â€œä½ â€æ¥ç§°å‘¼ç”¨æˆ·ã€‚**ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨ "æ—ç™½ï¼š" çš„å†…å®¹ä¸­ä½¿ç”¨ç¬¬ä¸€äººç§° "æˆ‘"**ã€‚
    - âœ… **æ­£ç¡®èŒƒä¾‹**: æ—ç™½ï¼šä»–çœ‹ç€ä½ ï¼Œå˜´è§’ä¸è‡ªè§‰å‹¾èµ·ä¸€ä¸ç¬‘æ„ã€‚
    - âŒ **é”™è¯¯èŒƒä¾‹**: æ—ç™½ï¼šæˆ‘çœ‹ç€ä½ ï¼Œå˜´è§’ä¸è‡ªè§‰å‹¾èµ·ä¸€ä¸ç¬‘æ„ã€‚
- **å½“ä½¿ç”¨ "${context.ai_name}ï¼š" æ—¶**ï¼šä½ å®Œå…¨ä»£å…¥è§’è‰²ï¼Œä½¿ç”¨ã€ç¬¬ä¸€äººç§°ã€‘"æˆ‘" è¿›è¡Œæ€è€ƒå’Œè¯´è¯ã€‚

// --- è¿™æ˜¯ä¿®æ­£åçš„æ–°æŒ‡ä»¤ ---
#### 2. å¼ºåˆ¶åˆ†æ®µè§„åˆ™ (Mandatory Segmentation)
- åœ¨ "æ—ç™½ï¼š" å’Œ "${context.ai_name}ï¼š" çš„å†…å®¹ä¸­ï¼Œã€å¿…é¡»ã€‘åªåœ¨ä»£è¡¨ä¸€å¥è¯ç»“æŸçš„æ ‡ç‚¹ç¬¦å·ï¼ˆå¦‚å¥å·ã€é—®å·ã€æ„Ÿå¹å·ï¼‰åé¢ç´§è·Ÿä¸€ä¸ªåæ–œæ  "\\" æ¥è¿›è¡Œåˆ†æ®µã€‚è¿™æ˜¯æ¨¡æ‹Ÿè§†è§‰å°è¯´ç‚¹å‡»ç¿»é¡µçš„æŠ€æœ¯è¦æ±‚ã€‚
- ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨å¥å­ä¸­é—´çš„é€—å·ã€é¡¿å·æˆ–ä»»ä½•ä¸æ˜¯ä¸€å¥è¯ç»“å°¾çš„åœ°æ–¹ä½¿ç”¨åæ–œæ ã€‚
    - âœ… **æ­£ç¡®èŒƒä¾‹**: ${context.ai_name}ï¼šè¿™å®¶çš„æ‹¿é“å¾ˆä¸é”™ï¼Œä½ è¦å°å°å—ï¼Ÿ\\æˆ‘ä¸ºä½ ç‚¹äº†ä¸€æ¯ã€‚
    - âŒ **é”™è¯¯èŒƒä¾‹**: ${context.ai_name}ï¼šè¿™å®¶çš„æ‹¿é“å¾ˆä¸é”™ï¼Œ\\ä½ è¦å°å°å—ï¼Ÿ

#### 3. é€‰é¡¹æ ¼å¼è§„åˆ™ (Choice Formatting)
- **æ‰€æœ‰é€‰é¡¹ã€å¿…é¡»ã€‘æ˜¯ä»ç”¨æˆ·çš„è§†è§’å‡ºå‘çš„åŠ¨ä½œæˆ–å¯¹è¯ã€‚**
- **ã€å¿…é¡»ã€‘** ä»¥ "é€‰é¡¹ï¼š" å¼€å¤´ï¼Œæä¾›ä¸¤ä¸ªé€‰é¡¹ï¼Œç”¨ä¸­æ–‡åˆ†å· "ï¼›" éš”å¼€ã€‚
    - âœ… **æ­£ç¡®èŒƒä¾‹**: é€‰é¡¹ï¼š1. æ¡ä½ä»–çš„æ‰‹ï¼›2. å‡è£…æ²¡çœ‹è§ï¼Œä½å¤´å–å’–å•¡ã€‚
    - âŒ **é”™è¯¯èŒƒä¾‹**: é€‰é¡¹ï¼š1. æˆ‘æ¡ä½äº†ä½ çš„æ‰‹ï¼›2. ä½ ä½å¤´å–å’–å•¡ã€‚
---


### ä¸¥æ ¼è¾“å‡ºæ ¼å¼ (Output Format)
ä½ çš„æ‰€æœ‰è¾“å‡ºã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼Œä¸åŒéƒ¨åˆ†ç”¨æ¢è¡Œåˆ†éš”ã€‚
1.  **æ—ç™½ (å¯é€‰):** ä»¥ "æ—ç™½ï¼š" å¼€å¤´ã€‚
2.  **è§’è‰²å¯¹è¯ (å¿…é¡»):** ä»¥ä½ çš„è§’è‰²å "${context.ai_name}ï¼š" å¼€å¤´ã€‚
3.  **é€‰é¡¹ (å¿…é¡»):** ä»¥ "é€‰é¡¹ï¼š" å¼€å¤´ã€‚
`;
    }
    // 3. ä»æ•°æ®åº“åŠ è½½å¹¶æ¸²æŸ“æ‰€æœ‰çº¦ä¼šè®°å½•
    // --- è¿™æ˜¯ä¿®æ”¹åçš„å‡½æ•° ---
    async function loadAndDisplayDatingHistory() {
        datingHistoryContainer.innerHTML = '<p style="text-align:center; color:#888;">æ­£åœ¨åŠ è½½è®°å½•...</p>';
        try {
            const historyData = await dbHelper.getAllDataFromStore('datingHistoryStore');
            const sortedHistory = historyData.sort((a, b) => b.id - a.id);

            if (sortedHistory.length === 0) {
                datingHistoryContainer.innerHTML = '<p style="text-align:center; color:#888; padding-top: 50px;">è¿˜æ²¡æœ‰ä»»ä½•çº¦ä¼šè®°å½•ã€‚</p>';
                return;
            }

            datingHistoryContainer.innerHTML = '';
            sortedHistory.forEach(record => {
                const card = document.createElement('div');
                card.className = 'history-card';
                // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šä¸ºå¡ç‰‡æ·»åŠ  data-id â–¼â–¼â–¼
                card.dataset.id = record.id;
                const date = new Date(record.value.date);
                const formattedDate = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;

                card.innerHTML = `
                <div class="history-card-header">
                    <span class="history-date">${formattedDate}</span>
                    <span class="history-partner">With: ${record.value.partnerName}</span>
                </div>
                <p class="history-summary">${record.value.summary}</p>
                <div class="preset-actions" style="border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 15px;">
                    <button class="edit-btn">ç¼–è¾‘</button>
                    <button class="delete-btn">åˆ é™¤</button>
                </div>
            `;
                datingHistoryContainer.appendChild(card);
            });
        } catch (error) {
            console.error("åŠ è½½çº¦ä¼šè®°å½•å¤±è´¥:", error);
            datingHistoryContainer.innerHTML = '<p style="text-align:center; color:red;">åŠ è½½å¤±è´¥ï¼</p>';
        }
    }

    // 4. ã€æ ¸å¿ƒã€‘åœ¨çº¦ä¼šç»“æŸæ—¶ï¼Œè°ƒç”¨AIç”Ÿæˆæ‘˜è¦å¹¶ä¿å­˜
    async function generateAndSaveDatingSummary() {
        if (!currentOpenContact || vnSceneQueue.length === 0) return;

        // a. ä» vnSceneQueue æå–å®Œæ•´çš„å¯¹è¯å†å²
        let conversationText = '';
        vnSceneQueue.forEach(part => {
            if (part.type === 'narration' || part.type === 'dialogue') {
                conversationText += `${part.speaker}: ${part.segments.join(' ')}\n`;
            }
        });

        // b. æ„é€ ä¸€ä¸ªä¸“é—¨ç”¨äºç”Ÿæˆæ‘˜è¦çš„AIæŒ‡ä»¤
        const summaryPrompt = `(ç³»ç»ŸæŒ‡ä»¤ï¼šè¯·å°†ä»¥ä¸‹è¿™æ®µçº¦ä¼šåœºæ™¯çš„å¯¹è¯å’Œæ—ç™½ï¼Œæ€»ç»“æˆä¸€æ®µ2-3å¥è¯çš„ã€æ¸©é¦¨çš„æ—¥è®°å¼å›å¿†ã€‚è¯·ä»¥ç”¨æˆ·çš„è§†è§’æ¥å†™ï¼Œä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚ä¸è¦åŒ…å«ä»»ä½•å¤šä½™çš„æ ¼å¼æˆ–æ ‡ç­¾ï¼Œç›´æ¥è¾“å‡ºæ—¥è®°å†…å®¹ã€‚)\n\nã€çº¦ä¼šåœºæ™¯ã€‘:\n${conversationText}`;

        console.log("æ­£åœ¨è¯·æ±‚AIç”Ÿæˆçº¦ä¼šæ‘˜è¦...");

        // c. è°ƒç”¨ä¸€ä¸ªç®€åŒ–çš„AIå‡½æ•°æ¥è·å–æ‘˜è¦
        const summaryText = await fetchSimpleAiResponse(summaryPrompt);

        if (summaryText) {
            console.log("AIç”Ÿæˆçš„æ‘˜è¦:", summaryText);
            // d. åˆ›å»ºè®°å½•å¯¹è±¡
            const newRecord = {
                id: Date.now(),
                value: {
                    date: new Date().toISOString(),
                    partnerName: currentOpenContact.ai.name,
                    summary: summaryText
                }
            };

            // e. ä¿å­˜åˆ°çº¦ä¼šè®°å½•æ•°æ®åº“
            await dbHelper.updateRecord('datingHistoryStore', newRecord);

            // f. ã€é‡è¦ã€‘å°†è®°å¿†æ³¨å…¥åˆ°ä¸»èŠå¤©å†å²ä¸­ï¼Œè®©AIâ€œè®°ä½â€è¿™æ¬¡çº¦ä¼š
            const memoryMessage = {
                sender: 'system',
                type: 'system',
                // æ ¸å¿ƒä¿®æ”¹ï¼šå°† text çš„å†…å®¹æ”¹ä¸ºç®€æ´çš„æç¤º
                text: `[ç³»ç»Ÿæç¤ºï¼šçº¦ä¼šè®°å¿†å·²ä¿å­˜ã€‚]`,
                timestamp: new Date(),
                uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
            };
            await saveMessageToHistory(memoryMessage, currentOpenContact.id);

            console.log("çº¦ä¼šæ‘˜è¦å·²æˆåŠŸä¿å­˜å¹¶æ³¨å…¥è®°å¿†ï¼");
        } else {
            console.error("AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„çº¦ä¼šæ‘˜è¦ã€‚");
        }
    }
    // --- é‡æ–°ç”ŸæˆåŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ ---
    const vnRegenerateBtn = document.getElementById('vn-regenerate-btn');

    async function handleVnRegenerate() {
        if (!lastVnUserChoice) {
            alert("æ— æ³•é‡æ–°ç”Ÿæˆï¼Œæ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€æ¬¡çš„ç”¨æˆ·é€‰æ‹©ã€‚");
            return;
        }

        console.log("æ­£åœ¨ä»ä¸Šä¸€æ¬¡çš„é€‰æ‹©é‡æ–°ç”Ÿæˆ:", lastVnUserChoice);

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        vnDialogText.innerHTML = '<div class="dialog-loader"><span></span><span></span><span></span></div>';
        vnChoicesContainer.style.display = 'none'; // éšè—æ—§é€‰é¡¹

        // ä½¿ç”¨ä¸Šä¸€æ¬¡çš„é€‰æ‹©ï¼Œé‡æ–°è°ƒç”¨AI
        const newAiScript = await callVnAI(lastVnUserChoice);

        if (newAiScript) {
            // ä½¿ç”¨æ–°ç”Ÿæˆçš„å‰§æœ¬ï¼Œæ›¿æ¢æ‰æ—§çš„åœºæ™¯
            startVnScene(newAiScript, lastVnUserChoice);
        } else {
            vnDialogText.innerHTML = 'AIé‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚';
        }
    }


    vnRegenerateBtn.addEventListener('click', handleVnRegenerate);

    function openTextEditModal(title, currentText, onSave) {
        textEditModalTitle.textContent = title;
        textEditTextarea.value = currentText;
        onSaveCallback = onSave; // å­˜å‚¨å›è°ƒ

        textEditModal.style.display = 'flex';
        setTimeout(() => { textEditModal.style.opacity = '1'; }, 10);
    }

    function closeTextEditModal() {
        textEditModal.style.opacity = '0';
        setTimeout(() => { textEditModal.style.display = 'none'; }, 300);
    }
    textEditModalCloseBtn.addEventListener('click', closeTextEditModal);
    textEditSaveBtn.addEventListener('click', () => {
        if (onSaveCallback) {
            onSaveCallback(textEditTextarea.value);
        }
    });

    // --- çº¦ä¼šè®°å½•çš„ç¼–è¾‘ä¸åˆ é™¤äº‹ä»¶å¤„ç† ---
    datingHistoryContainer.addEventListener('click', async (event) => {
        const button = event.target;
        const card = button.closest('.history-card');
        if (!card) return;

        const recordId = parseInt(card.dataset.id, 10);

        if (button.classList.contains('delete-btn')) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡çº¦ä¼šè®°å½•å—ï¼Ÿ')) {
                await dbHelper.deleteData('datingHistoryStore', recordId);
                loadAndDisplayDatingHistory(); // åˆ·æ–°åˆ—è¡¨
            }
        } else if (button.classList.contains('edit-btn')) {
            const recordData = await dbHelper.loadData('datingHistoryStore', recordId);
            if (recordData) {
                const currentSummary = recordData.value.summary;

                // å®šä¹‰ä¿å­˜æ—¶çš„å›è°ƒå‡½æ•°
                const onSave = async (newSummary) => {
                    recordData.value.summary = newSummary;
                    await dbHelper.updateRecord('datingHistoryStore', recordData);
                    closeTextEditModal();
                    loadAndDisplayDatingHistory();
                };

                openTextEditModal('ç¼–è¾‘çº¦ä¼šè®°å½•', currentSummary, onSave);
            }
        }
    });

    // â–¼â–¼â–¼ åŠŸèƒ½å®Œæ•´çš„é€šè¯æ‘˜è¦äº‹ä»¶ç›‘å¬å™¨ (æœ€ç»ˆä¿®å¤ç‰ˆ) â–¼â–¼â–¼

    summaryListContainer.addEventListener('click', async (event) => {
        // é¦–å…ˆï¼Œæ‰¾åˆ°è¢«ç‚¹å‡»çš„æœ€å¤–å±‚çš„å¡ç‰‡å…ƒç´ 
        const card = event.target.closest('.summary-card');
        // å¦‚æœè¿å¡ç‰‡éƒ½æ²¡ç‚¹åˆ°ï¼Œå°±ç›´æ¥é€€å‡º
        if (!card) return;

        // ä»å¡ç‰‡ä¸Šè·å– uuidï¼Œè¿™æ˜¯æ‰€æœ‰æ“ä½œéƒ½éœ€è¦çš„æ•°æ®
        const uuid = card.dataset.uuid;

        // æ¥ä¸‹æ¥ï¼Œåˆ¤æ–­å…·ä½“ç‚¹å‡»äº†ä»€ä¹ˆ
        if (event.target.closest('.delete-btn')) {
            // --- åœºæ™¯1: ç‚¹å‡»äº†åˆ é™¤æŒ‰é’® ---
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é€šè¯è®°å½•å—ï¼Ÿ')) {
                const messageIndex = currentOpenContact.history.findIndex(msg => msg.uuid === uuid);
                if (messageIndex > -1) {
                    currentOpenContact.history.splice(messageIndex, 1);
                    await saveCurrentContactToDatabase();
                    loadAndRenderSummaries(); // åˆ·æ–°åˆ—è¡¨
                }
            }
        } else if (event.target.closest('.edit-btn')) {
            // --- åœºæ™¯2: ç‚¹å‡»äº†ç¼–è¾‘æŒ‰é’® ---
            const currentSummary = card.dataset.summary;
            const onSave = async (newSummary) => {
                const messageIndex = currentOpenContact.history.findIndex(msg => msg.uuid === uuid);
                if (messageIndex > -1) {
                    currentOpenContact.history[messageIndex].text = `---é€šè¯è®°å½•æ‘˜è¦---\n${newSummary}\n---æ‘˜è¦ç»“æŸ---`;
                    await saveCurrentContactToDatabase();
                    closeTextEditModal();
                    loadAndRenderSummaries(); // åˆ·æ–°åˆ—è¡¨
                }
            };
            openTextEditModal('ç¼–è¾‘é€šè¯æ‘˜è¦', currentSummary, onSave);
        } else {
            // --- åœºæ™¯3: å¦‚æœæ²¡ç‚¹åˆ°ä»»ä½•æŒ‰é’®ï¼Œä½†ç‚¹åœ¨äº†å¡ç‰‡ä¸Šï¼Œå°±è§†ä¸ºæŸ¥çœ‹è¯¦æƒ… ---
            const summaryText = card.dataset.summary;
            const formattedHtml = summaryText.split('\n').map(line => {
                const parts = line.split(':');
                if (parts.length > 1) {
                    const name = parts.shift();
                    const content = parts.join(':');
                    return `<p><strong>${name}:</strong>${content}</p>`;
                }
                return `<p>${line}</p>`;
            }).join('');

            summaryDetailContainer.innerHTML = formattedHtml;
            phoneFrame.classList.remove('show-summary-list');
            phoneFrame.classList.add('show-summary-detail');
        }
    });

    /**
    * Renders the list of font URLs from the database.
    */
    async function renderFontUrlList() {
        fontUrlListContainer.innerHTML = '<p style="text-align:center; color:#888;">æ­£åœ¨åŠ è½½...</p>';
        try {
            const fontData = await dbHelper.loadData('fontUrlStore', 'allFonts');
            const fontUrls = (fontData && Array.isArray(fontData.value)) ? fontData.value : [];

            fontUrlListContainer.innerHTML = '';
            if (fontUrls.length === 0) {
                fontUrlListContainer.innerHTML = '<p style="text-align:center; color:#888;">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•URLã€‚</p>';
                return;
            }

            fontUrls.forEach(font => {
                const itemElement = document.createElement('div');
                itemElement.className = 'font-url-item';

                // --- CORE CHANGE IS HERE ---
                itemElement.innerHTML = `
                        <span class="font-url-text" title="URL: ${font.url}">${font.name}</span>
                        <div class="font-url-actions">
                            <button class="apply-font-url-btn" data-url="${font.url}">åº”ç”¨</button>
                            <button class="delete-font-url-btn" data-id="${font.id}">åˆ é™¤</button>
                        </div>
                    `;
                fontUrlListContainer.appendChild(itemElement);
            });
        } catch (error) {
            console.error("åŠ è½½å­—ä½“URLåˆ—è¡¨å¤±è´¥:", error);
            fontUrlListContainer.innerHTML = '<p style="text-align:center; color:red;">åŠ è½½å¤±è´¥ï¼</p>';
        }
    }

    addFontUrlBtn.addEventListener('click', async () => {
        const newName = prompt("è¯·è¾“å…¥å­—ä½“çš„åç§° (ä¾‹å¦‚: å¯çˆ±æ‰‹å†™ä½“)");

        // If the user cancels or enters an empty name, stop.
        if (!newName || !newName.trim()) {
            return;
        }

        const newUrl = prompt(`è¯·è¾“å…¥ "${newName}" å¯¹åº”çš„å­—ä½“URLåœ°å€:`);

        // If the user cancels or enters an empty URL, stop.
        if (!newUrl || !newUrl.trim()) {
            return;
        }

        try {
            const fontData = await dbHelper.loadData('fontUrlStore', 'allFonts');
            let fontUrls = (fontData && Array.isArray(fontData.value)) ? fontData.value : [];

            // The new object now includes a 'name' property
            const newFont = {
                id: Date.now(),
                name: newName.trim(), // Save the name
                url: newUrl.trim()   // Save the URL
            };

            fontUrls.push(newFont);
            await dbHelper.saveData('fontUrlStore', 'allFonts', fontUrls);
            renderFontUrlList();
        } catch (error) {
            console.error("ä¿å­˜å­—ä½“URLå¤±è´¥:", error);
            alert("æ·»åŠ å¤±è´¥ï¼");
        }
    });


    // --- Event listener for the entire Font URL list container ---
    fontUrlListContainer.addEventListener('click', async (event) => {
        const button = event.target;

        // Check if the clicked element is a delete button
        if (button.classList.contains('delete-font-url-btn')) {
            const fontId = parseInt(button.dataset.id, 10);

            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­—ä½“URLå—ï¼Ÿ")) {
                try {
                    const fontData = await dbHelper.loadData('fontUrlStore', 'allFonts');
                    let fontUrls = (fontData && Array.isArray(fontData.value)) ? fontData.value : [];
                    const updatedUrls = fontUrls.filter(font => font.id !== fontId);
                    await dbHelper.saveData('fontUrlStore', 'allFonts', updatedUrls);
                    renderFontUrlList();
                } catch (error) {
                    console.error("åˆ é™¤å­—ä½“URLå¤±è´¥:", error);
                    alert("åˆ é™¤å¤±è´¥ï¼");
                }
            }
        }
        // â–¼â–¼â–¼ THIS IS THE MISSING PART â–¼â–¼â–¼
        else if (button.classList.contains('apply-font-url-btn')) {
            const urlToApply = button.dataset.url;
            if (urlToApply) {
                applyCustomFontByUrl(urlToApply);
                // Save this choice so it persists on reload
                await dbHelper.saveData('settingsStore', 'appliedFontUrl', urlToApply);
                alert('å­—ä½“å·²åº”ç”¨ï¼');
            }
        }
        // â–²â–²â–² END OF THE MISSING PART â–²â–²â–²
    });


    /**
     * Applies a custom font using a direct URL.
     * @param {string} fontUrl - The URL of the font file (.ttf, .otf, .woff, etc.).
     */
    function applyCustomFontByUrl(fontUrl) {
        if (!fontUrl) {
            console.log("Font URL is empty, restoring default.");
            // Restore default logic here if needed
            customFontStyle.innerHTML = '';
            phoneFrame.style.fontFamily = ''; // Let it inherit from body
            return;
        }

        const fontFaceRule = `
                @font-face {
                    font-family: 'CustomUrlFont';
                    src: url('${fontUrl}');
                }
            `;
        customFontStyle.innerHTML = fontFaceRule;
        phoneFrame.style.fontFamily = "'CustomUrlFont', sans-serif";
        console.log(`Applied font from URL: ${fontUrl}`);
    }

    /**
* è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å¼¹çª—å†…çš„æ–‡å­—å†…å®¹
*/
    // ä¿®æ”¹åçš„ä»£ç  (AFTER)
    function updateThoughtBubbleContent() {
        const statusEl = document.getElementById('thought-bubble-status');
        const monologueEl = document.getElementById('thought-bubble-monologue');

        // ç¡®ä¿æˆ‘ä»¬æœ‰æ‰“å¼€çš„è”ç³»äººï¼Œå¹¶ä¸”å…ƒç´ å­˜åœ¨
        if (statusEl && monologueEl && currentOpenContact && currentOpenContact.ai) {
            statusEl.textContent = currentOpenContact.ai.lastStatus || 'çŠ¶æ€æœªçŸ¥...';
            monologueEl.textContent = currentOpenContact.ai.lastMonologue || 'å†…å¿ƒç©ºç©ºå¦‚ä¹Ÿ...';
        }
    }

    // 3. ã€ä¼˜åŒ–ä½“éªŒã€‘æ·»åŠ ä¸€ä¸ªå…¨å±€ç‚¹å‡»äº‹ä»¶ï¼Œå®ç°â€œç‚¹å‡»å¼¹çª—å¤–éƒ¨åŒºåŸŸå°±å…³é—­â€
    document.addEventListener('click', (event) => {
        // æ£€æŸ¥å¼¹çª—å½“å‰æ˜¯å¦æ˜¯å¯è§çš„
        if (thoughtBubble.classList.contains('visible')) {
            // æ£€æŸ¥ç‚¹å‡»äº‹ä»¶çš„ç›®æ ‡ï¼Œæ˜¯å¦æ˜¯å¼¹çª—è‡ªèº«æˆ–è€…å¼¹çª—çš„å†…éƒ¨å…ƒç´ 
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å¼¹çª—å†…éƒ¨ï¼Œå°±å…³é—­å®ƒ
            if (!thoughtBubble.contains(event.target)) {
                thoughtBubble.classList.remove('visible');
            }
        }
    });






    // â–¼â–¼â–¼ START: åœ¨è¿™é‡Œç²˜è´´æ–°çš„ä»£ç  â–¼â–¼â–¼

    // ä» localStorage åŠ è½½ä¸Šæ¬¡ç¦»å¼€æ—¶çš„æ—¶é—´æˆ³
    function loadLastActiveTimestamps() {
        try {
            const stored = localStorage.getItem('lastActiveTimestamps');
            if (stored) {
                lastActiveTimestamps = JSON.parse(stored);
            }
        } catch (e) {
            console.error("åŠ è½½æ´»åŠ¨æ—¶é—´æˆ³å¤±è´¥:", e);
            lastActiveTimestamps = {};
        }
    }

    // å°†å½“å‰æ—¶é—´æˆ³ä¿å­˜åˆ° localStorage
    function saveLastActiveTimestamps() {
        try {
            localStorage.setItem('lastActiveTimestamps', JSON.stringify(lastActiveTimestamps));
        } catch (e) {
            console.error("ä¿å­˜æ´»åŠ¨æ—¶é—´æˆ³å¤±è´¥:", e);
        }
    }


    // ===================================
    // ä¿®å¤ç‰ˆï¼šæ™ºèƒ½é‡Roll (é’ˆå¯¹è¿ç»­ç”¨æˆ·æ¶ˆæ¯ç»„)
    // ===================================
    rerollFeatureButton.addEventListener('click', async () => {
        // 1. å…³é—­é¢æ¿
        toggleFeaturesPanel();

        // 2. å®‰å…¨æ£€æŸ¥
        if (!currentOpenContact && !currentOpenGroup) {
            alert("è¯·å…ˆæ‰“å¼€ä¸€ä¸ªå¯¹è¯ï¼");
            return;
        }
        if (isAiReplying) {
            alert("AIæ­£åœ¨å›å¤ä¸­ï¼Œè¯·ç¨åå†è¯•...");
            return;
        }

        // å®šä¹‰é€šç”¨å˜é‡
        let history = [];
        let contextId = null;
        let isGroup = false;

        // 3. ç¡®å®šä¸Šä¸‹æ–‡
        if (currentOpenGroup) {
            history = currentOpenGroup.history;
            contextId = currentOpenGroup.id;
            isGroup = true;
        } else {
            history = currentOpenContact.history;
            contextId = currentOpenContact.id;
            isGroup = false;
        }

        if (!history || history.length === 0) {
            alert("æ²¡æœ‰æ¶ˆæ¯å¯ä»¥é‡æ¥ã€‚");
            return;
        }

        // -------------------------------------------------
        // é˜¶æ®µä¸€ï¼šæ¸…ç† AI çš„å°¾éƒ¨æ¶ˆæ¯
        // -------------------------------------------------
        const uuidsToRemove = [];
        let deleteCount = 0;
        let foundUserTail = false; // æ ‡è®°æ˜¯å¦æ‰¾åˆ°äº†ç”¨æˆ·çš„â€œå°¾å·´â€

        // ä»åå¾€å‰éå†ï¼Œåˆ é™¤æ‰€æœ‰ AI æ¶ˆæ¯ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
        for (let i = history.length - 1; i >= 0; i--) {
            const msg = history[i];

            if (msg.sender === 'user') {
                foundUserTail = true;
                break; // æ’åˆ°ç”¨æˆ·æ¶ˆæ¯äº†ï¼Œåœæ­¢åˆ é™¤ï¼
            } else {
                // æ˜¯ AI æ¶ˆæ¯æˆ–ç³»ç»Ÿæ¶ˆæ¯ï¼Œæ ‡è®°åˆ é™¤
                if (msg.uuid) uuidsToRemove.push(msg.uuid);
                history.pop(); // ä»å†…å­˜æ•°ç»„ä¸­ç§»é™¤
                deleteCount++;
            }
        }

        if (deleteCount === 0) {
            alert("æœ€åä¸€æ¡æ˜¯ç”¨æˆ·å‘çš„æ¶ˆæ¯ï¼Œæ— æ³•é‡Rollï¼ˆåªèƒ½é‡Roll AI çš„å›å¤ï¼‰ã€‚");
            return;
        }

        // -------------------------------------------------
        // é˜¶æ®µäºŒï¼šæœé›†è¿ç»­çš„ç”¨æˆ·æ¶ˆæ¯ç»„
        // -------------------------------------------------
        // ç°åœ¨çš„ history æœ«å°¾å·²ç»æ˜¯ç”¨æˆ·æ¶ˆæ¯äº†ã€‚æˆ‘ä»¬è¦ç»§ç»­å¾€å‰æ‰¾ï¼Œ
        // æŠŠæ‰€æœ‰è¿ç»­çš„ç”¨æˆ·æ¶ˆæ¯éƒ½æ”¶é›†èµ·æ¥ï¼Œä½œä¸º AI å›å¤çš„ä¸Šä¸‹æ–‡ã€‚

        let userMessageGroup = []; // å­˜æ”¾æ‰¾åˆ°çš„ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬

        for (let i = history.length - 1; i >= 0; i--) {
            const msg = history[i];

            if (msg.sender === 'user') {
                // è·å–å†…å®¹æ–‡æœ¬ (å…¼å®¹æ–‡æœ¬ã€è¯­éŸ³ã€å›¾ç‰‡ç­‰)
                let content = "";
                if (msg.type === 'voice_text') content = `[è¯­éŸ³: ${msg.transcript}]`;
                else if (msg.type === 'image' || msg.type === 'text-image') content = `[ç”¨æˆ·å‘é€äº†å›¾ç‰‡]`;
                else if (msg.type === 'sticker') content = `[ç”¨æˆ·å‘é€äº†è¡¨æƒ…åŒ…]`;
                else content = msg.text;

                // æ”¾åœ¨æ•°ç»„æœ€å‰é¢ï¼Œä¿æŒæ—¶é—´é¡ºåº
                userMessageGroup.unshift(content);
            } else {
                // é‡åˆ° AI çš„æ¶ˆæ¯äº†ï¼Œè¯´æ˜è¿™ä¸€è½®ç”¨æˆ·å‘è¨€ç»“æŸäº†
                break;
            }
        }

        // å°†è¿™ç»„æ¶ˆæ¯åˆå¹¶æˆä¸€æ®µè¯
        const userContextText = userMessageGroup.join('\n');
        console.log("é‡Rollä¸Šä¸‹æ–‡æ•æ‰:", userContextText);

        // -------------------------------------------------
        // é˜¶æ®µä¸‰ï¼šä¿å­˜ä¸æ›´æ–°
        // -------------------------------------------------
        try {
            if (isGroup) {
                const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = groupsData.value;
                const index = allGroups.findIndex(g => g.id === contextId);
                if (index > -1) {
                    allGroups[index].history = history;
                    // æ›´æ–°é¢„è§ˆ
                    if (history.length > 0) {
                        const lastMsg = history[history.length - 1];
                        const previewText = lastMsg.text || (lastMsg.content && lastMsg.content.html) || '[å¤šåª’ä½“]';
                        allGroups[index].lastMessage = cleanMessageForPreview(previewText);
                    } else {
                        allGroups[index].lastMessage = "å¯¹è¯å·²é‡ç½®";
                    }
                    await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                    currentOpenGroup = allGroups[index];
                }
            } else {
                if (history.length > 0) {
                    const lastMsg = history[history.length - 1];
                    const previewText = lastMsg.text || (lastMsg.content && lastMsg.content.html) || '';
                    currentOpenContact.lastMessage = cleanMessageForPreview(previewText);
                } else {
                    currentOpenContact.lastMessage = "å¯¹è¯å·²é‡ç½®";
                }
                await saveCurrentContactToDatabase();
            }

            // UI æ›´æ–°ï¼šç§»é™¤æ°”æ³¡
            uuidsToRemove.forEach(uuid => {
                const row = document.querySelector(`.message-row[data-uuid="${uuid}"]`);
                if (row) row.remove();
            });

            // -------------------------------------------------
            // é˜¶æ®µå››ï¼šå¸¦ç€å®Œæ•´çš„ä¸Šä¸‹æ–‡è§¦å‘ AI
            // -------------------------------------------------
            if (isGroup) {
                // ç¾¤èŠç›´æ¥è°ƒå¯¼æ¼”æ¨¡å¼ï¼Œå¯¼æ¼”ä¼šè‡ªåŠ¨è¯»å–æœ€æ–°çš„å†å²è®°å½•
                await fetchGroupScript(currentOpenGroup);
            } else {
                // å•èŠï¼šæ„é€ ä¸€ä¸ªåŒ…å«å®Œæ•´ç”¨æˆ·æ„å›¾çš„æŒ‡ä»¤
                const triggerPayload = `(ç³»ç»ŸæŒ‡ä»¤ï¼šä¸Šä¸€æ¡å›å¤å·²æ’¤å›ã€‚è¯·é‡æ–°æ€è€ƒï¼Œå¹¶é’ˆå¯¹ç”¨æˆ·åˆšåˆšå‘é€çš„ä»¥ä¸‹å‡ æ¡è¿ç»­æ¶ˆæ¯è¿›è¡Œç»¼åˆå›å¤ï¼š\nâ€œ${userContextText}â€)`;

                await callAI(triggerPayload, currentOpenContact);
            }

        } catch (error) {
            console.error("é‡Rollå¤±è´¥:", error);
            alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚");
        }
    });



    segmentBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // 1. UI çŠ¶æ€ï¼šç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ active ç±»
            segmentBtns.forEach(b => b.classList.remove('active'));
            // ç»™å½“å‰ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ  active ç±»
            btn.classList.add('active');

            // 2. é€»è¾‘çŠ¶æ€ï¼šè·å–ç‚¹å‡»ç±»å‹
            const type = btn.dataset.type;
            currentMessageType = type; // æ›´æ–°å…¨å±€çŠ¶æ€

            // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘æ§åˆ¶æ»‘å—ç§»åŠ¨
            if (type === 'group') {
                segmentControl.classList.add('group-mode'); // æ·»åŠ ç±»åï¼Œæ»‘å—ç§»åˆ°å³è¾¹
            } else {
                segmentControl.classList.remove('group-mode'); // ç§»é™¤ç±»åï¼Œæ»‘å—ç§»åˆ°å·¦è¾¹
            }

            // 4. åˆ‡æ¢åˆ—è¡¨å†…å®¹
            renderMessagesList();

            // 5. è¾¹ç•Œæƒ…å†µï¼šå¦‚æœæ­£åœ¨å¤šé€‰æ¨¡å¼ï¼Œåˆ‡æ¢æ ‡ç­¾æ—¶è‡ªåŠ¨é€€å‡ºå¤šé€‰
            if (isMessagesDeleteMode) {
                // æ¨¡æ‹Ÿç‚¹å‡»å¤šé€‰æŒ‰é’®æ¥é€€å‡º
                messagesIconMultiselectBtn.click();
            }
        });
    });
    // === 2. æ ¸å¿ƒï¼šåˆ—è¡¨æ¸²æŸ“åˆ‡æ¢å‡½æ•° ===
    let isRendering = false; // æ¸²æŸ“é”
    let renderTimeout = null; // é˜²æŠ–å®šæ—¶å™¨
    
    async function renderMessagesList() {
        console.log('[DEBUG] renderMessagesList: START, currentMessageType =', currentMessageType);
        
        // ã€ä¼˜åŒ–1ã€‘å¦‚æœæ­£åœ¨æ¸²æŸ“ï¼Œè·³è¿‡
        if (isRendering) {
            console.log('[DEBUG] renderMessagesList: SKIPPED (already rendering)');
            return;
        }
        
        // ã€ä¼˜åŒ–2ã€‘æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–å®šæ—¶å™¨
        if (renderTimeout) {
            clearTimeout(renderTimeout);
            renderTimeout = null;
        }
        
        isRendering = true;
        const startTime = performance.now();
        console.log('[DEBUG] renderMessagesList: Current list items =', contactList.children.length);

        try {
            // ã€å…³é”®ä¼˜åŒ–ã€‘å…ˆåœ¨å†…å­˜ä¸­æ„å»º DOMï¼Œå†ä¸€æ¬¡æ€§æ›¿æ¢
            const fragment = document.createDocumentFragment();
            const tempContainer = document.createElement('ul');
            tempContainer.className = contactList.className;
            
            if (currentMessageType === 'single') {
                console.log('[DEBUG] renderMessagesList: Loading contacts...');
                await loadContactsToContainer(tempContainer);
            } else {
                console.log('[DEBUG] renderMessagesList: Loading groups...');
                await loadGroupsToContainer(tempContainer);
            }
            
            // ã€ä¸€æ¬¡æ€§æ›¿æ¢ã€‘é¿å…é—ªçƒ
            contactList.innerHTML = '';
            while (tempContainer.firstChild) {
                contactList.appendChild(tempContainer.firstChild);
            }
            
            const endTime = performance.now();
            console.log('[DEBUG] renderMessagesList: COMPLETE, new list items =', contactList.children.length);
            console.log(`[DEBUG] renderMessagesList completed in ${(endTime - startTime).toFixed(2)}ms`);
        } catch (error) {
            console.error('[DEBUG] renderMessagesList: ERROR', error);
        } finally {
            isRendering = false;
        }
    }
    
    // æ–°å¢ï¼šåŠ è½½è”ç³»äººåˆ°æŒ‡å®šå®¹å™¨
    async function loadContactsToContainer(container) {
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        if (contactsData && Array.isArray(contactsData.value)) {
            Global_AllContactsCache = contactsData.value;
            
            let contacts = contactsData.value;
            
            // æ’åºé€»è¾‘
            contacts.sort((a, b) => {
                const pinA = a.isPinned ? 1 : 0;
                const pinB = b.isPinned ? 1 : 0;
                if (pinA !== pinB) {
                    return pinB - pinA;
                }
                return 0;
            });

            contacts.forEach(contact => {
                if (contact.isHidden) {
                    return;
                }
                appendContactToContainer(contact, container);
            });

            if (contacts.length > 0) {
                const firstVisible = contacts.find(c => !c.isHidden);
                if (firstVisible) updateShopper(firstVisible);
            }
        }
    }
    
    // æ–°å¢ï¼šæ·»åŠ è”ç³»äººåˆ°æŒ‡å®šå®¹å™¨
    function appendContactToContainer(contact, container) {
        const li = document.createElement('li');
        li.className = 'contact-item';
        li.dataset.contactId = contact.id;
        
        // å¦‚æœè”ç³»äººè¢«ç½®é¡¶ï¼Œæ·»åŠ  pinned ç±»
        if (contact.isPinned) {
            li.classList.add('pinned');
            li.dataset.pinned = 'true';
        }

        // ã€ä¿®å¤ã€‘ä½¿ç”¨æ­£ç¡®çš„æ•°æ®ç»“æ„ï¼šcontact.ai.name å’Œ contact.ai.avatar
        li.innerHTML = `
            <input type="checkbox" class="contact-checkbox">
            <img src="${contact.ai.avatar}" alt="avatar" class="contact-avatar">
            <div class="contact-info">
                <div class="contact-name">${contact.ai.name}</div>
                <div class="contact-last-message">${contact.lastMessage}</div>
            </div>
        `;
        
        container.appendChild(li);
        
        // ã€é‡è¦ã€‘æ·»åŠ é•¿æŒ‰èœå•é€»è¾‘ï¼ˆä¸åŸå‡½æ•°ä¿æŒä¸€è‡´ï¼‰
        let pressTimer;
        let isLongPress = false;
        let startX, startY;

        li.addEventListener('touchstart', (e) => {
            if (isMessagesDeleteMode) return;
            
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isLongPress = false;
            
            li.classList.add('pressing');

            pressTimer = setTimeout(() => {
                isLongPress = true;
                if (navigator.vibrate) navigator.vibrate(50);
                
                showContactActionSheet(contact);
                
                li.classList.remove('pressing');
            }, 500);
        }, { passive: true });

        li.addEventListener('touchmove', (e) => {
            if (!pressTimer) return;
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            if (Math.abs(currentX - startX) > 10 || Math.abs(currentY - startY) > 10) {
                clearTimeout(pressTimer);
                li.classList.remove('pressing');
            }
        }, { passive: true });

        li.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
            li.classList.remove('pressing');
        });

        li.addEventListener('touchcancel', () => {
            clearTimeout(pressTimer);
            li.classList.remove('pressing');
        });

        // ç‚¹å‡»äº‹ä»¶ï¼šæ‰“å¼€èŠå¤©
        li.addEventListener('click', (e) => {
            // ã€é‡è¦ã€‘é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘çˆ¶å®¹å™¨çš„äº‹ä»¶å§”æ‰˜ï¼ˆå¯¼è‡´åŒé‡æ‰“å¼€æˆ–é€»è¾‘å†²çªï¼‰
            e.stopPropagation();

            if (isMessagesDeleteMode) return;
            if (isLongPress) {
                isLongPress = false;
                return;
            }
            if (e.target.classList.contains('contact-checkbox')) return;
             
            // ã€ä¿®å¤ã€‘ä¼ é€’ contact.id (æ•°å­—) è€Œä¸æ˜¯ contact (å¯¹è±¡)
            openChatView(contact.id);
        });
    }
    
    // æ–°å¢ï¼šåŠ è½½ç¾¤èŠåˆ°æŒ‡å®šå®¹å™¨
    async function loadGroupsToContainer(container) {
        try {
            const dataWrapper = await dbHelper.loadData('groupChats', 'allGroupChats');
            const groups = (dataWrapper && Array.isArray(dataWrapper.value)) ? dataWrapper.value : [];

            if (groups.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; padding-top:20px;">æš‚æ— ç¾¤èŠ</p>';
                return;
            }

            groups.forEach(group => {
                const li = document.createElement('li');
                li.className = 'contact-item';
                li.dataset.groupId = group.id;
                li.innerHTML = `
                <input type="checkbox" class="contact-checkbox">
                <img src="${group.avatar || 'https://placehold.co/100x100/orange/white?text=ç¾¤'}" class="contact-avatar">
                <div class="contact-info">
                    <div class="contact-name">${group.name}</div>
                    <div class="contact-last-message">${group.lastMessage || 'æš‚æ— æ¶ˆæ¯'}</div>
                </div>
            `;
                container.appendChild(li);
            });
        } catch (e) {
            console.error("åŠ è½½ç¾¤èŠå¤±è´¥", e);
        }
    }

    // åŠ è½½ç¾¤èŠæ•°æ®çš„å‡½æ•° (æ–°)
    async function loadGroups() {
        try {
            const groupsData = await dbHelper.getAllDataFromStore('groupChats'); // æ³¨æ„ï¼šè¿™é‡Œç”¨ getAllDataFromStore æ›´æ–¹ä¾¿
            // å¦‚æœä½ çš„æ•°æ®åº“ç»“æ„æ˜¯ {id: 'allGroups', value: []} è¿™ç§å•æ¡è®°å½•æ¨¡å¼ï¼Œè¯·æ”¹ç”¨ loadData
            // è¿™é‡Œå‡è®¾æ˜¯å•æ¡è®°å½•æ¨¡å¼ï¼Œä¿æŒé£æ ¼ä¸€è‡´ï¼š
            const dataWrapper = await dbHelper.loadData('groupChats', 'allGroupChats');
            const groups = (dataWrapper && Array.isArray(dataWrapper.value)) ? dataWrapper.value : [];

            contactList.innerHTML = '';

            if (groups.length === 0) {
                contactList.innerHTML = '<p style="text-align:center; color:#888; padding-top:20px;">æš‚æ— ç¾¤èŠ</p>';
                return;
            }

            groups.forEach(group => {
                const li = document.createElement('li');
                li.className = 'contact-item';
                li.dataset.groupId = group.id; // ç”¨äºåŒºåˆ†
                // å¤ç”¨å•èŠçš„æ ·å¼
                li.innerHTML = `
                <input type="checkbox" class="contact-checkbox">
                <img src="${group.avatar || 'https://placehold.co/100x100/orange/white?text=ç¾¤'}" class="contact-avatar">
                <div class="contact-info">
                    <div class="contact-name">${group.name}</div>
                    <div class="contact-last-message">${group.lastMessage || 'æš‚æ— æ¶ˆæ¯'}</div>
                </div>
            `;
                contactList.appendChild(li);
            });
        } catch (e) {
            console.error("åŠ è½½ç¾¤èŠå¤±è´¥", e);
        }
    }

    messagesIconMultiselectBtn.addEventListener('click', () => {
        // 1. å¦‚æœå½“å‰å·²ç»æ˜¯åˆ é™¤æ¨¡å¼ï¼Œè¯´æ˜ç”¨æˆ·ç‚¹å‡»çš„æ˜¯ã€åƒåœ¾æ¡¶å›¾æ ‡ã€‘-> æ‰§è¡Œåˆ é™¤
        if (isMessagesDeleteMode) {
            handleUniversalDelete(); // æ‰§è¡Œåˆ é™¤

            // åˆ é™¤å®Œæˆåï¼Œè‡ªåŠ¨é€€å‡ºåˆ é™¤æ¨¡å¼
            exitDeleteMode();

        } else {
            // 2. å¦‚æœå½“å‰æ˜¯æ­£å¸¸æ¨¡å¼ï¼Œè¯´æ˜ç”¨æˆ·ç‚¹å‡»çš„æ˜¯ã€åˆ—è¡¨å›¾æ ‡ã€‘-> è¿›å…¥åˆ é™¤æ¨¡å¼
            enterDeleteMode();
        }
    });

    // === 6. é€šç”¨åˆ é™¤å‡½æ•° ===
    async function handleUniversalDelete() {
        const selectedCheckboxes = contactList.querySelectorAll('.contact-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            // å¦‚æœæ²¡é€‰ä¸­ä»»ä½•ä¸œè¥¿ï¼Œå°±å•çº¯é€€å‡ºæ¨¡å¼
            return;
        }

        if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedCheckboxes.length} é¡¹å—ï¼Ÿ`)) {
            return;
        }

        const idsToDelete = new Set();
        selectedCheckboxes.forEach(cb => {
            // ç¾¤èŠç”¨ dataset.groupIdï¼Œå•èŠç”¨ dataset.contactId
            const id = cb.closest('.contact-item').dataset.contactId || cb.closest('.contact-item').dataset.groupId;
            idsToDelete.add(parseInt(id, 10));
        });

        if (currentMessageType === 'single') {
            // ... æ‰§è¡Œå•èŠåˆ é™¤ (å¤ç”¨åŸæœ‰é€»è¾‘) ...
            // (è®°å¾—æŠŠ handleBatchDeleteContacts é‡Œçš„é€»è¾‘æ¬è¿‡æ¥æˆ–é‡æ„)
            // è¿™é‡Œç®€å†™ï¼š
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            const newContacts = contactsData.value.filter(c => !idsToDelete.has(c.id));
            await dbHelper.saveData('messageContacts', 'allContacts', newContacts);
        } else {
            // ... æ‰§è¡Œç¾¤èŠåˆ é™¤ ...
            const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
            const newGroups = (groupsData ? groupsData.value : []).filter(g => !idsToDelete.has(g.id));
            await dbHelper.saveData('groupChats', 'allGroupChats', newGroups);
        }

        renderMessagesList(); // åˆ·æ–°
    }

    // ç®€å•çš„ç¾¤èŠå¼¹çª—å…³é—­é€»è¾‘
    createGroupCloseBtn.addEventListener('click', () => {
        createGroupModal.style.opacity = '0';
        setTimeout(() => { createGroupModal.style.display = 'none'; }, 300);
    });
    // --- è¾…åŠ©å‡½æ•°ï¼šè¿›å…¥åˆ é™¤æ¨¡å¼ ---
    // --- è¾…åŠ©å‡½æ•°ï¼šè¿›å…¥åˆ é™¤æ¨¡å¼ ---
    function enterDeleteMode() {
        isMessagesDeleteMode = true;
        contactList.classList.add('delete-mode');

        // â–¼â–¼â–¼â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å¼€å§‹ â–¼â–¼â–¼â–¼â–¼â–¼

        // 1. éšè—ã€å¤šé€‰/åˆ—è¡¨å›¾æ ‡ã€‘
        if (iconSelect) iconSelect.style.display = 'none';

        // 2. æ˜¾ç¤ºã€åƒåœ¾æ¡¶å›¾æ ‡ã€‘(ä½ ä¹‹å‰å¯èƒ½å†™æˆäº† none)
        if (iconDelete) iconDelete.style.display = 'block';

        // 3. ç»™æŒ‰é’®æ·»åŠ çº¢è‰²æ¿€æ´»æ ·å¼
        messagesIconMultiselectBtn.classList.add('delete-mode-active');

        // â–²â–²â–²â–²â–²â–² æ ¸å¿ƒä¿®å¤ç»“æŸ â–²â–²â–²â–²â–²â–²

        // è®©å·¦è¾¹çš„+å·æŒ‰é’®å˜ç°ï¼Œè¡¨ç¤ºä¸å¯ç”¨
        messagesIconAddBtn.style.opacity = '0.3';
        messagesIconAddBtn.style.pointerEvents = 'none';
    }

    // --- è¾…åŠ©å‡½æ•°ï¼šé€€å‡ºåˆ é™¤æ¨¡å¼ ---
    // --- è¾…åŠ©å‡½æ•°ï¼šé€€å‡ºåˆ é™¤æ¨¡å¼ ---
    function exitDeleteMode() {
        isMessagesDeleteMode = false;
        contactList.classList.remove('delete-mode');

        // â–¼â–¼â–¼â–¼â–¼â–¼ é€€å‡ºæ—¶æ¢å¤åŸçŠ¶ â–¼â–¼â–¼â–¼â–¼â–¼

        // 1. æ˜¾ç¤ºã€å¤šé€‰/åˆ—è¡¨å›¾æ ‡ã€‘
        if (iconSelect) iconSelect.style.display = 'block';

        // 2. éšè—ã€åƒåœ¾æ¡¶å›¾æ ‡ã€‘
        if (iconDelete) iconDelete.style.display = 'none';

        // 3. ç§»é™¤çº¢è‰²æ¿€æ´»æ ·å¼
        messagesIconMultiselectBtn.classList.remove('delete-mode-active');

        // â–²â–²â–²â–²â–²â–² æ¢å¤ç»“æŸ â–²â–²â–²â–²â–²â–²

        // æ¢å¤å·¦è¾¹çš„+å·æŒ‰é’®
        messagesIconAddBtn.style.opacity = '1';
        messagesIconAddBtn.style.pointerEvents = 'auto';

        // å–æ¶ˆæ‰€æœ‰å‹¾é€‰
        contactList.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = false);
    }
    // 2. è¾…åŠ©å‡½æ•°ï¼šé‡ç½®å¼¹çª—çŠ¶æ€
    function resetCreateGroupModal() {
        createGroupModal.style.display = 'none';
        groupModeSelection.style.display = 'flex';
        groupMemberSelectContainer.style.display = 'none';
        groupCreateFooter.style.display = 'none';
        createGroupBackBtn.style.display = 'none';
        createGroupTitle.textContent = 'åˆ›å»ºç¾¤èŠ';
    }

    // 3. å…³é—­æŒ‰é’®é€»è¾‘
    createGroupCloseBtn.addEventListener('click', () => {
        createGroupModal.style.opacity = '0';
        setTimeout(resetCreateGroupModal, 300);
    });

    // 4. è¿”å›æŒ‰é’®é€»è¾‘
    createGroupBackBtn.addEventListener('click', () => {
        // è¿”å›åˆ°æ¨¡å¼é€‰æ‹©
        groupModeSelection.style.display = 'flex';
        groupMemberSelectContainer.style.display = 'none';
        groupCreateFooter.style.display = 'none';
        createGroupBackBtn.style.display = 'none';
        createGroupTitle.textContent = 'åˆ›å»ºç¾¤èŠ';
    });

    // 5. æ ¸å¿ƒï¼šåˆ›å»ºå¹¶ä¿å­˜ç¾¤èŠ
    async function createGroupChat(name, members) {
        const newGroup = {
            id: Date.now(),
            name: name,
            // é»˜è®¤å¤´åƒï¼šä½¿ç”¨ placehold.co ç”Ÿæˆå¸¦â€œç¾¤â€å­—çš„å›¾ç‰‡
            avatar: 'https://placehold.co/100x100/orange/white?text=ç¾¤',
            members: members, // æˆå‘˜IDæ•°ç»„
            history: [],
            lastMessage: 'æ–°ç¾¤èŠå·²åˆ›å»º'
        };

        try {
            const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
            let groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
            groups.unshift(newGroup);
            await dbHelper.saveData('groupChats', 'allGroupChats', groups);

            // åˆ·æ–°åˆ—è¡¨ï¼ˆè°ƒç”¨ä½ å·²æœ‰çš„åŠ è½½å‡½æ•°ï¼‰
            if (typeof loadGroups === 'function') {
                await loadGroups();
            }

            // å…³é—­å¼¹çª—
            createGroupModal.style.opacity = '0';
            setTimeout(resetCreateGroupModal, 300);

            alert('ç¾¤èŠåˆ›å»ºæˆåŠŸï¼');
        } catch (e) {
            console.error("åˆ›å»ºç¾¤èŠå¤±è´¥", e);
            alert("åˆ›å»ºå¤±è´¥");
        }
    }

    // 6. æ¨¡å¼Aï¼šæ–°å»ºç©ºç™½ç¾¤
    // 6. æ¨¡å¼Aï¼šæ–°å»ºç©ºç™½ç¾¤ (æ”¹ç”¨ onclick)
    modeCreateEmpty.onclick = () => {
        const groupName = prompt("è¯·è¾“å…¥ç¾¤åç§°ï¼š", "æ–°å»ºç¾¤èŠ");
        if (groupName) {
            createGroupChat(groupName, []); // ç©ºæˆå‘˜
        }
    };

    // 7. æ¨¡å¼Bï¼šé€‰æ‹©ç°æœ‰è§’è‰² - è¿›å…¥é€‰äººç•Œé¢ (æ”¹ç”¨ onclick)
    modeSelectExisting.onclick = async () => {
        // åˆ‡æ¢è§†å›¾
        groupModeSelection.style.display = 'none';
        groupMemberSelectContainer.style.display = 'block';
        groupCreateFooter.style.display = 'flex'; // æ˜¾ç¤ºåº•éƒ¨ç¡®è®¤æŒ‰é’®
        createGroupBackBtn.style.display = 'block'; // æ˜¾ç¤ºè¿”å›æŒ‰é’®
        createGroupTitle.textContent = 'é€‰æ‹©æˆå‘˜';

        // åŠ è½½è”ç³»äººåˆ—è¡¨
        groupMemberList.innerHTML = '<p style="text-align:center; color:#888;">åŠ è½½ä¸­...</p>';
        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            const contacts = (contactsData && Array.isArray(contactsData.value)) ? contactsData.value : [];

            groupMemberList.innerHTML = '';
            if (contacts.length === 0) {
                groupMemberList.innerHTML = '<p style="text-align:center; padding:20px;">æ²¡æœ‰è”ç³»äººå¯é€‰</p>';
                return;
            }

            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-item'; // å¤ç”¨æ ·å¼
                // æ·»åŠ å¤é€‰æ¡†
                item.innerHTML = `
                <input type="checkbox" class="contact-checkbox" value="${contact.id}" style="display:block; margin-right:15px;">
                <img src="${contact.ai.avatar}" class="contact-avatar">
                <div class="contact-info">
                    <div class="contact-name">${contact.ai.name}</div>
                    <div class="contact-last-message" style="font-size:12px; color:#999;">User: ${contact.user.name}</div>
                </div>
            `;
                // ç‚¹å‡»æ•´è¡Œè§¦å‘å‹¾é€‰
                item.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                };
                groupMemberList.appendChild(item);
            });

        } catch (e) {
            console.error(e);
            groupMemberList.innerHTML = 'åŠ è½½å¤±è´¥';
        }
    };

    // 8. æ¨¡å¼Bï¼šç¡®è®¤åˆ›å»º (æ”¹ç”¨ onclick)
    confirmCreateGroupBtn.onclick = () => {
        // è·å–æ‰€æœ‰é€‰ä¸­çš„è”ç³»äººID
        const selectedCheckboxes = groupMemberList.querySelectorAll('.contact-checkbox:checked');
        const memberIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

        if (memberIds.length === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæˆå‘˜ï¼");
            return;
        }

        const groupName = prompt("è¯·è¾“å…¥ç¾¤åç§°ï¼š", "æ–°ç¾¤èŠ");
        if (groupName) {
            createGroupChat(groupName, memberIds);
        }
    };

    // === æ–°å¢ï¼šæ‰“å¼€ç¾¤èŠç•Œé¢å‡½æ•° ===
    async function openGroupChatView(groupId) {
        // playEnterSound();
        console.log(`æ­£åœ¨æ‰“å¼€ç¾¤èŠçª—å£: ${groupId}`);

        // â–¼â–¼â–¼ã€éš”ç¦»ä¿®å¤ 1ã€‘æ¸…ç†æ‰€æœ‰å•èŠé—ç•™çš„æ ·å¼æ ‡ç­¾ â–¼â–¼â–¼
        // å‡¡æ˜¯ ID ä»¥ style-single- å¼€å¤´çš„ style æ ‡ç­¾ï¼Œå…¨éƒ¨åˆ æ‰
        document.querySelectorAll('style[id^="style-single-"]').forEach(el => el.remove());
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ 2ã€‘æ‰“å¼€ç¾¤èŠå‰ï¼Œå¿…é¡»å¼ºåˆ¶æ¸…ç©ºå•èŠçŠ¶æ€ï¼â–¼â–¼â–¼
        currentOpenContact = null;
        // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²

        // 1. çŠ¶æ€é‡ç½®
        if (!isVoiceInputInitialized) {
            initializeVoiceInput();
            isVoiceInputInitialized = true;
        }
        chatScreen.classList.remove('emoji-panel-active');

        // å…³é”®ï¼šæ¸…ç†å•èŠçŠ¶æ€ï¼Œè®¾ç½®ç¾¤èŠçŠ¶æ€
        currentOpenContact = null;

        // 2. åŠ è½½ç¾¤ç»„æ•°æ®
        const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
        if (!groupsData || !Array.isArray(groupsData.value)) {
            console.error("æ— æ³•åŠ è½½ç¾¤èŠæ•°æ®"); return;
        }

        // æ‰¾åˆ°å½“å‰ç¾¤ç»„
        currentOpenGroup = groupsData.value.find(g => g.id === groupId);
        window.currentOpenGroup = currentOpenGroup; // Sync to global for access in event listeners

        if (!currentOpenGroup) {
            console.error(`æ‰¾ä¸åˆ° ID ä¸º ${groupId} çš„ç¾¤èŠ`); return;
        }

        // â–¼â–¼â–¼ é¢„åŠ è½½ç¾¤æˆå‘˜è¯¦æƒ…ï¼Œç¡®ä¿å¤´åƒå®æ—¶æ›´æ–° â–¼â–¼â–¼
        currentOpenGroup.memberMap = {}; // åˆå§‹åŒ–ç¼“å­˜
        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            if (contactsData && Array.isArray(contactsData.value)) {
                const allContacts = contactsData.value;
                if (currentOpenGroup.members && Array.isArray(currentOpenGroup.members)) {
                    currentOpenGroup.members.forEach(memberId => {
                        const contact = allContacts.find(c => c.id === memberId);
                        if (contact) {
                            currentOpenGroup.memberMap[memberId] = contact;
                        }
                    });
                }
            }
        } catch (err) {
            console.warn("é¢„åŠ è½½ç¾¤æˆå‘˜ä¿¡æ¯å¤±è´¥:", err);
        }


        // 3. æ›´æ–° UI (å¤ç”¨ chat-screen)
        // æ›´æ–°æ ‡é¢˜
        if (currentOpenGroup) {
             chatContactName.textContent = currentOpenGroup.name + (currentOpenGroup.members ? ` (${currentOpenGroup.members.length})` : '');
        }

        // éšè—å•èŠç‰¹æœ‰çš„å…ƒç´  (æ¯”å¦‚æ‹‰é»‘æç¤º)
        const blockNotice = document.getElementById('block-status-notice');
        if (blockNotice) blockNotice.style.display = 'none';

        // è®¾ç½®ä¸“å±ç±»å (å¯é€‰ï¼Œç”¨äºCSSæ ·å¼éš”ç¦»)
        // è®¾ç½®ä¸“å±ç±»å (å¯é€‰ï¼Œç”¨äºCSSæ ·å¼éš”ç¦»)
        chatScreen.className = `screen group-${currentOpenGroup.id}`;
        
        // æ¸…ç† chatScreen ä¸Šå¯èƒ½æ®‹ç•™çš„å•èŠèƒŒæ™¯æ ·å¼ï¼Œé¿å…å•èŠå’Œç¾¤èŠèƒŒæ™¯æ··æ·†
        chatScreen.style.backgroundImage = '';
        chatScreen.style.backgroundColor = '';
        
        // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ã€‘æ¸…ç†æ—§çš„ç¾¤èŠæ ·å¼ï¼Œé˜²æ­¢æ±¡æŸ“ â–¼â–¼â–¼
        document.querySelectorAll('style[id^="group-style-batch-"]').forEach(el => el.remove());
        
        // åº”ç”¨ç¾¤èŠèƒŒæ™¯
        // å¢åŠ  checkï¼Œé˜²æ­¢ currentOpenGroup ä¸º null
        if (currentOpenGroup && typeof window.applyChatBackground === 'function') {
            window.applyChatBackground(currentOpenGroup.chatBackground || currentOpenGroup.backgroundImage);
        }

        // 4. æ¸²æŸ“å†å²è®°å½•
        const history = Array.isArray(currentOpenGroup.history) ? currentOpenGroup.history : [];

        // ä½¿ç”¨ DocumentFragment ä¼˜åŒ–æ¸²æŸ“
        const fragment = document.createDocumentFragment();

        chatMessagesContainer.innerHTML = ''; // æ¸…ç©ºæ—§æ¶ˆæ¯

        // â–¼â–¼â–¼â–¼â–¼â–¼ã€ç‰©ç†éš”ç¦»ç›–ç« ã€‘â–¼â–¼â–¼â–¼â–¼â–¼
        // ç»™å®¹å™¨æ ‡è®°ï¼šç°åœ¨æ˜¯ ç¾¤èŠæ¨¡å¼ï¼ŒIDæ˜¯ group.id
        chatMessagesContainer.dataset.contextMode = 'group';
        chatMessagesContainer.dataset.contextId = groupId;
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²



        history.forEach(message => {
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬è¿˜æ²¡å¤„ç†ç¾¤å‹çš„å¤´åƒï¼Œæš‚æ—¶åªè´Ÿè´£æŠŠæ¶ˆæ¯æ˜¾ç¤ºå‡ºæ¥
            // æˆ‘ä»¬ä¼ å…¥ null ä½œä¸º contact å‚æ•°ï¼Œç¨ååœ¨ addMessageToView é‡Œå¤„ç†å…¼å®¹
            addGroupMessageToView(message, fragment);
        });

        chatMessagesContainer.appendChild(fragment);

        // ã€å·²ä¿®å¤ã€‘ä¸å†å¼ºåˆ¶é‡ç½®èƒŒæ™¯
        // ç¾¤èŠèƒŒæ™¯å·²ç»é€šè¿‡ window.applyChatBackground(currentOpenGroup.backgroundImage) è®¾ç½®
        // è¿™é‡Œå¼ºåˆ¶é‡ç½®ä¼šè¦†ç›–æ‰æ­£ç¡®çš„èƒŒæ™¯è®¾ç½®
        // åº”ç”¨æ˜¾ç¤ºè®¾ç½® (å¤´åƒ)
        if (currentOpenGroup.avatarSettings && currentOpenGroup.avatarSettings.show === false) {
             chatMessagesContainer.classList.add('hide-avatars');
        } else {
             chatMessagesContainer.classList.remove('hide-avatars');
        }

        // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ã€‘è¿›å…¥ç¾¤èŠæ—¶ï¼Œç«‹å³æ³¨å…¥æ‰€æœ‰æˆå‘˜(åŒ…æ‹¬è‡ªå·±)çš„æ ·å¼ â–¼â–¼â–¼
        // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨æ‰¹é‡æ³¨å…¥ï¼Œæ“ä½œä¸€æ¬¡DOMå³å¯ï¼
        window.batchInjectGroupStyles(groupId, currentOpenGroup.members);
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // 6. æ˜¾ç¤ºç•Œé¢
        phoneFrame.classList.add('show-chat');

        // 7. æ»šåŠ¨åˆ°åº•éƒ¨
        requestAnimationFrame(() => {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        });

        chatMessageInput.blur();
    }
    // === æ–°å¢ï¼šä¿å­˜ç¾¤èŠæ¶ˆæ¯åˆ°æ•°æ®åº“ ===
    // ==========================================
    // ä¿®å¤ç‰ˆï¼šä¿å­˜ç¾¤èŠæ¶ˆæ¯ (è‡ªåŠ¨åˆ¤æ–­æ˜¯è°å‘çš„)
    // ==========================================
    async function saveGroupMessageToHistory(message, groupId) {
        try {
            const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
            let groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

            const groupIndex = groups.findIndex(g => g.id === groupId);

            if (groupIndex > -1) {
                const groupToUpdate = groups[groupIndex];

                if (!Array.isArray(groupToUpdate.history)) {
                    groupToUpdate.history = [];
                }

                // 1. æ·»åŠ æ¶ˆæ¯åˆ°å†å²è®°å½•
                groupToUpdate.history.push(message);

                // 2. å‡†å¤‡é¢„è§ˆæ–‡æœ¬
                const previewText = message.text || (message.content && message.content.html) || '[å¤šåª’ä½“]';
                const cleanText = cleanMessageForPreview(previewText);

                // â–¼â–¼â–¼â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤å¼€å§‹ â–¼â–¼â–¼â–¼â–¼â–¼

                // 3. åˆ¤æ–­å‘é€è€…åå­—
                let senderDisplayName = "";

                if (message.sender === 'user') {
                    // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„ï¼Œä¼˜å…ˆè¯»å–è¯¥ç¾¤çš„ç¾¤åç‰‡ï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤ºâ€œæˆ‘â€
                    senderDisplayName = groupToUpdate.userCardName || "æˆ‘";
                } else {
                    // å¦‚æœæ˜¯AIå‘çš„ï¼Œè¯»å–æ¶ˆæ¯è‡ªå¸¦çš„å‘é€è€…åå­—ï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤ºâ€œç¾¤å‹â€
                    senderDisplayName = message.senderName || "ç¾¤å‹";
                }

                // 4. ç»„åˆæˆæ­£ç¡®çš„é¢„è§ˆæ ¼å¼ï¼š "åå­—: å†…å®¹"
                groupToUpdate.lastMessage = `${senderDisplayName}: ${cleanText}`;

                // â–²â–²â–²â–²â–²â–² æ ¸å¿ƒä¿®å¤ç»“æŸ â–²â–²â–²â–²â–²â–²

                // 5. ä¿å­˜å›æ•°æ®åº“
                await dbHelper.saveData('groupChats', 'allGroupChats', groups);

                // 6. æ›´æ–°å†…å­˜å¯¹è±¡ (å¦‚æœå½“å‰æ­£å¥½æ‰“å¼€äº†è¿™ä¸ªç¾¤)
                if (currentOpenGroup && currentOpenGroup.id === groupId) {
                    currentOpenGroup.history = groupToUpdate.history;
                    currentOpenGroup.lastMessage = groupToUpdate.lastMessage;
                }

                // 7. åˆ·æ–°åˆ—è¡¨é¡µçš„é¢„è§ˆ
                if (typeof renderMessagesList === 'function') {
                    renderMessagesList();
                }
            }
        } catch (error) {
            console.error("ä¿å­˜ç¾¤èŠæ¶ˆæ¯å¤±è´¥:", error);
        }
    }
// --- å…¬å…±ç»„ä»¶ï¼šä¸–ç•Œä¹¦å¤šé€‰åˆ—è¡¨æ¸²æŸ“ (Nest Book Selection) ---
    window.renderWorldBookMultiselect = async function(container, contextObj, isAutoSave = false) {
        if (!container) return;
        container.innerHTML = '<p style="color:#888; font-size:12px; text-align:center;">åŠ è½½ä¸­...</p>';
        
        try {
            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            const booksData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
            const allBooks = (booksData && Array.isArray(booksData.value)) ? booksData.value : [];

            // å…¼å®¹æ€§è¿ç§»ï¼šå¦‚æœæ²¡æœ‰ bookIds åªæœ‰ GroupIdsï¼Œå…ˆè¿ç§»è¿‡æ¥
            if ((!contextObj.linkedWorldBookIds || contextObj.linkedWorldBookIds.length === 0) 
                && (contextObj.linkedWorldBookGroupIds && contextObj.linkedWorldBookGroupIds.length > 0)) {
                
                const legacyIds = new Set();
                allGroups.forEach(g => {
                    if (contextObj.linkedWorldBookGroupIds.includes(g.id) && Array.isArray(g.bookIds)) {
                        g.bookIds.forEach(bid => legacyIds.add(bid));
                    }
                });
                contextObj.linkedWorldBookIds = Array.from(legacyIds);
                // å¦‚æœæ˜¯è‡ªåŠ¨ä¿å­˜æ¨¡å¼ï¼Œç«‹å³è§¦å‘ä¸€æ¬¡ä¿å­˜ä»¥æŒä¹…åŒ–è¿ç§»ç»“æœ
                if (isAutoSave && window.dbHelper) {
                     // è¿™é‡Œçš„ä¿å­˜é€»è¾‘ä¾èµ–å¤–éƒ¨ contextObj æ˜¯å¼•ç”¨
                     // æš‚æ—¶ä¸å¼ºåˆ¶ä¿å­˜ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œæˆ–ä¸‹æ¬¡ä¿å­˜
                }
            }
            
            // ç¡®ä¿æ•°ç»„å­˜åœ¨
            if (!contextObj.linkedWorldBookIds) contextObj.linkedWorldBookIds = [];
            const selectedIds = new Set(contextObj.linkedWorldBookIds);

            container.innerHTML = '';
            const bookMap = new Map();
            allBooks.forEach(b => bookMap.set(b.id, b));

            if (allGroups.length === 0 && allBooks.length === 0) {
                container.innerHTML = '<p style="color:#888; font-size:12px; text-align:center;">æš‚æ— ä¸–ç•Œä¹¦</p>';
                return;
            }

            // æ¸²æŸ“åˆ†ç»„è§†å›¾
            allGroups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.style.marginBottom = '15px';
                
                // --- æ ‡é¢˜æ  (Flexå®¹å™¨) ---
                const headerDiv = document.createElement('div');
                headerDiv.style.display = 'flex';
                headerDiv.style.alignItems = 'center';
                headerDiv.style.justifyContent = 'space-between';
                headerDiv.style.marginBottom = '8px';
                
                // 1. åˆ†ç»„æ ‡é¢˜ (ç‚¹å‡»å±•å¼€/æŠ˜å )
                const title = document.createElement('div');
                title.textContent = 'â–¶ ' + group.name; 
                title.style.fontSize = '14px';
                title.style.fontWeight = 'bold';
                title.style.color = '#333';
                title.style.cursor = 'pointer';
                title.style.flex = '1';
                
                // 2. å…¨é€‰æŒ‰é’®
                const selectAllBtn = document.createElement('button');
                selectAllBtn.textContent = 'å…¨é€‰';
                selectAllBtn.style.cssText = `
                    font-size: 12px; 
                    padding: 2px 8px; 
                    margin-left: 10px; 
                    border: 1px solid #3a3a3c; 
                    color: #3a3a3c; 
                    background: transparent; 
                    border-radius: 4px; 
                    cursor: pointer;
                `;
                
                headerDiv.appendChild(title);
                headerDiv.appendChild(selectAllBtn);
                groupDiv.appendChild(headerDiv);

                // --- åˆ—è¡¨å®¹å™¨ (é»˜è®¤éšè—) ---
                const listDiv = document.createElement('div');
                listDiv.style.display = 'none'; // é»˜è®¤æŠ˜å 
                listDiv.style.flexDirection = 'column';
                listDiv.style.gap = '8px';
                listDiv.style.paddingLeft = '10px';
                listDiv.style.borderLeft = '2px solid #eee';

                let groupHasBooks = false;
                const bookCheckboxes = [];

                if (Array.isArray(group.bookIds)) {
                    group.bookIds.forEach(bookId => {
                        const book = bookMap.get(bookId);
                        if (book) {
                            groupHasBooks = true;
                            const item = document.createElement('label');
                            item.className = 'multiselect-item-row';
                            item.style.display = 'flex';
                            item.style.alignItems = 'center';
                            item.style.cursor = 'pointer';

                            const isChecked = selectedIds.has(bookId);
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = bookId;
                            checkbox.checked = isChecked;
                            checkbox.style.marginRight = '8px';
                            checkbox.style.transform = 'scale(1.2)';
                            
                            bookCheckboxes.push(checkbox);

                            const span = document.createElement('span');
                            span.style.fontSize = '14px';
                            span.style.color = '#555';
                            span.textContent = book.name;

                            item.appendChild(checkbox);
                            item.appendChild(span);
                            
                            // ç»‘å®šå•ä¸ªç‚¹å‡»äº‹ä»¶
                            checkbox.addEventListener('change', async () => {
                                if (checkbox.checked) {
                                    if (!contextObj.linkedWorldBookIds.includes(bookId)) {
                                        contextObj.linkedWorldBookIds.push(bookId);
                                    }
                                } else {
                                    contextObj.linkedWorldBookIds = contextObj.linkedWorldBookIds.filter(id => id !== bookId);
                                }
                                
                                if (isAutoSave) {
                                    try {
                                        const gData = await dbHelper.loadData('groupChats', 'allGroupChats');
                                        let groups = gData ? gData.value : [];
                                        const idx = groups.findIndex(g => g.id === contextObj.id);
                                        if (idx > -1) {
                                            groups[idx] = contextObj;
                                            await dbHelper.saveData('groupChats', 'allGroupChats', groups);
                                        }
                                    } catch(e) { console.error("AutoSave Failed", e); }
                                }
                            });

                            listDiv.appendChild(item);
                        }
                    });
                }
                
                if (!groupHasBooks) {
                    listDiv.innerHTML = '<span style="color:#ccc; font-size:12px;">(ç©ºåˆ†ç»„)</span>';
                }

                groupDiv.appendChild(listDiv);
                container.appendChild(groupDiv);
                
                // --- äº‹ä»¶äº¤äº’ ---
                
                // å±•å¼€/æŠ˜å 
                title.onclick = () => {
                    const isHidden = listDiv.style.display === 'none';
                    listDiv.style.display = isHidden ? 'flex' : 'none';
                    title.textContent = (isHidden ? 'â–¼ ' : 'â–¶ ') + group.name;
                };
                
                // å…¨é€‰/å…¨ä¸é€‰
                selectAllBtn.onclick = async (e) => {
                    e.stopPropagation();
                    
                    if (!group.bookIds || group.bookIds.length === 0) return;

                    // åˆ¤æ–­ç›®æ ‡çŠ¶æ€ï¼šåªè¦æœ‰ä¸€ä¸ªæœªé€‰ä¸­ï¼Œå°±å…¨é€‰ï¼›å¦åˆ™å…¨ä¸é€‰
                    const idsInGroup = group.bookIds.filter(id => bookMap.has(id));
                    const allSelected = idsInGroup.every(id => contextObj.linkedWorldBookIds.includes(id));
                    const targetState = !allSelected;
                    
                    // æ›´æ–°é€šè¿‡ contextObj å¼•ç”¨çš„å†…å­˜æ•°æ®
                    idsInGroup.forEach(id => {
                        const idx = contextObj.linkedWorldBookIds.indexOf(id);
                        if (targetState) {
                             if (idx === -1) contextObj.linkedWorldBookIds.push(id);
                        } else {
                             if (idx > -1) contextObj.linkedWorldBookIds.splice(idx, 1);
                        }
                    });
                    
                    // æ›´æ–° UI Checkbox çŠ¶æ€
                    bookCheckboxes.forEach(cb => {
                        cb.checked = targetState;
                    });
                    
                    // æ‰¹é‡ä¿å­˜ (é¿å…å¾ªç¯è§¦å‘ Autosave)
                    if (isAutoSave) {
                        try {
                            const gData = await dbHelper.loadData('groupChats', 'allGroupChats');
                            let groups = gData ? gData.value : [];
                            const idx = groups.findIndex(g => g.id === contextObj.id);
                            if (idx > -1) {
                                groups[idx] = contextObj; 
                                await dbHelper.saveData('groupChats', 'allGroupChats', groups);
                            }
                        } catch(e) { console.error("Batch AutoSave Failed", e); }
                    }
                };

            });

        } catch (e) {
            console.error("åŠ è½½ä¸–ç•Œä¹¦å¤±è´¥", e);
            container.innerHTML = '<p style="color:red;">åŠ è½½é”™è¯¯</p>';
        }
    };

    async function openGroupInfoModal() {
        if (!currentOpenGroup) {
            console.warn('[openGroupInfoModal] No currentOpenGroup, returning');
            return;
        }

        console.log('[openGroupInfoModal] Function called, currentOpenGroup:', currentOpenGroup.name);

        // è·å–æ–°é¡µé¢å…ƒç´ 
        const groupSettingsPage = document.getElementById('group-settings-page');
        if (!groupSettingsPage) {
            console.error('[openGroupInfoModal] group-settings-page not found');
            return;
        }
        console.log('[openGroupInfoModal] Found group-settings-page element');

        // A. å¡«å……ç¾¤åŸºæœ¬ä¿¡æ¯
        groupSettingsName.textContent = currentOpenGroup.name;
        // è®¾ç½®ç¾¤å¤´åƒ (å¦‚æœæ²¡æœ‰å°±ç”¨é»˜è®¤)
        const groupAvatarUrl = currentOpenGroup.avatar || 'https://placehold.co/100x100/orange/white?text=ç¾¤';
        groupSettingsAvatar.style.backgroundImage = `url('${groupAvatarUrl}')`;

        // B. å¡«å……å½“å‰ç”¨æˆ·çš„ç¾¤åç‰‡ä¿¡æ¯
        // å‡è®¾ç¾¤èŠå¯¹è±¡é‡Œå­˜äº†ç”¨æˆ·çš„ç¾¤åç‰‡ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨é»˜è®¤çš„
        const myName = currentOpenGroup.userCardName || "æˆ‘";
        const myAvatar = currentOpenGroup.userCardAvatar || "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me";

        groupUserName.textContent = myName;
        groupUserAvatar.style.backgroundImage = `url('${myAvatar}')`;

        // C. æ¸²æŸ“æˆå‘˜åˆ—è¡¨
        await renderGroupMembers();

        // D. ã€æ–°å¢ã€‘æ¸²æŸ“ä¸–ç•Œä¹¦å…³è”é€‰é¡¹ (ä½¿ç”¨æ–°çš„å¤šé€‰ç»„ä»¶)
        const wbContainer = document.getElementById('group-worldbook-select-container');
        if (typeof window.renderWorldBookMultiselect === 'function') {
             // ä¼ å…¥ currentOpenGroup å¹¶å¯ç”¨è‡ªåŠ¨ä¿å­˜ (true)
             await window.renderWorldBookMultiselect(wbContainer, currentOpenGroup, true);
        } else {
             wbContainer.innerHTML = 'ç»„ä»¶æœªå°±ç»ª';
        }

        // E. åŠ è½½ç¾¤èƒŒæ™¯è®¾ç½®åˆ°æ–°çš„é¢„è§ˆåŒº
        const bgPreview = document.getElementById('group-chat-bg-preview');
        const bgPlaceholder = document.getElementById('group-chat-bg-placeholder');
        const bgPreviewBox = document.getElementById('group-chat-bg-preview-box');
        if (currentOpenGroup.chatBackground) {
            if (bgPreview) {
                bgPreview.src = currentOpenGroup.chatBackground;
                bgPreview.style.display = 'block';
            }
            if (bgPlaceholder) bgPlaceholder.style.display = 'none';
            if (bgPreviewBox) bgPreviewBox.classList.add('has-bg');
        } else {
            if (bgPreview) bgPreview.style.display = 'none';
            if (bgPlaceholder) bgPlaceholder.style.display = 'flex';
            if (bgPreviewBox) bgPreviewBox.classList.remove('has-bg');
        }

        // F. åˆå§‹åŒ–å¯æŠ˜å åŒºåŸŸçš„çŠ¶æ€ï¼ˆé»˜è®¤å…¨éƒ¨æ”¶èµ·ï¼‰
        groupSettingsPage.querySelectorAll('.collapsible-section').forEach(section => {
            section.classList.remove('expanded');
        });

        // F2. åˆå§‹åŒ–æ˜¾ç¤ºè®¾ç½®å¼€å…³çŠ¶æ€
        const avatarSettings = currentOpenGroup.avatarSettings || { show: true };
        const timestampSettings = currentOpenGroup.timestampSettings || { show: false };
        
        const avatarsToggle = document.getElementById('group-show-avatars-toggle');
        const timestampToggle = document.getElementById('group-show-timestamp-toggle');
        
        if (avatarsToggle) {
            if (avatarSettings.show !== false) {
                avatarsToggle.classList.add('active');
            } else {
                avatarsToggle.classList.remove('active');
            }
        }
        if (timestampToggle) {
            if (timestampSettings.show === true) {
                timestampToggle.classList.add('active');
            } else {
                timestampToggle.classList.remove('active');
            }
        }
        
        const bilingualToggle = document.getElementById('group-bilingual-bubble-toggle');
        const bilingualSettings = currentOpenGroup.bilingualBubble || { enabled: false };
        if (bilingualToggle) {
             if (bilingualSettings.enabled === true) {
                 bilingualToggle.classList.add('active');
             } else {
                 bilingualToggle.classList.remove('active');
             }
        }

        // G. æ˜¾ç¤ºé¡µé¢ï¼ˆå…¨å±æ»‘å…¥ï¼‰
        groupSettingsPage.classList.remove('closing');
        groupSettingsPage.classList.add('active');
    }

    // å…³é—­ç¾¤èŠè®¾ç½®é¡µé¢
    function closeGroupSettingsPage() {
        const groupSettingsPage = document.getElementById('group-settings-page');
        if (!groupSettingsPage) return;

        groupSettingsPage.classList.add('closing');
        setTimeout(() => {
            groupSettingsPage.classList.remove('active', 'closing');
        }, 300);
    }


    // 3. æ¸²æŸ“ç¾¤æˆå‘˜ç½‘æ ¼ (ä¿®æ­£åŠ å·ç‚¹å‡»äº‹ä»¶)
    // 3. æ¸²æŸ“ç¾¤æˆå‘˜ç½‘æ ¼ (ä¿®å¤ç‰ˆï¼šè§£å†³äº†ç‚¹å‡»å¡æ­»/æ— ååº”çš„é—®é¢˜)
    async function renderGroupMembers() {
        groupMembersGrid.innerHTML = '<p style="color:#8E8E93;font-size:13px;">åŠ è½½ä¸­...</p>';

        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            const allContacts = (contactsData && contactsData.value) ? contactsData.value : [];
            const memberIds = currentOpenGroup.members || [];

            groupMembersGrid.innerHTML = '';
            groupMemberCount.textContent = `æŸ¥çœ‹${memberIds.length}åç¾¤æˆå‘˜ >`;

            // æ¸²æŸ“ç°æœ‰æˆå‘˜
            memberIds.forEach(id => {
                const contact = allContacts.find(c => c.id === id);
                const avatarUrl = contact ? contact.ai.avatar : 'https://placehold.co/100x100/ccc/fff?text=?';
                const name = contact ? contact.ai.name : 'æœªçŸ¥';

                const memberEl = document.createElement('div');
                memberEl.className = 'member-avatar-item';
                memberEl.style.position = 'relative';
                memberEl.innerHTML = `
                <div class="member-avatar-img" style="background-image: url('${avatarUrl}')"></div>
                <span class="member-avatar-name">${name}</span>
                <div class="member-delete-btn" data-member-id="${id}" style="display:none; position:absolute; top:-6px; right:-6px; width:22px; height:22px; background:#C48888; border-radius:50%; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2);">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </div>
            `;
                
                // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const deleteBtn = memberEl.querySelector('.member-delete-btn');
                if (deleteBtn) {
                    deleteBtn.onclick = async (e) => {
                        e.stopPropagation(); // é˜»æ­¢å†’æ³¡åˆ°æˆå‘˜å¡ç‰‡çš„ç‚¹å‡»äº‹ä»¶
                        
                        if (confirm(`ç¡®å®šè¦å°† ${name} ç§»å‡ºç¾¤èŠå—ï¼Ÿ`)) {
                            try {
                                // ä»ç¾¤æˆå‘˜åˆ—è¡¨ä¸­ç§»é™¤
                                const newMembers = currentOpenGroup.members.filter(m => m !== id);
                                currentOpenGroup.members = newMembers;
                                
                                // ä¿å­˜åˆ°æ•°æ®åº“
                                const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                                let allGroups = groupsData ? groupsData.value : [];
                                const idx = allGroups.findIndex(g => g.id === currentOpenGroup.id);
                                if (idx > -1) {
                                    allGroups[idx].members = newMembers;
                                    await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                                }
                                
                                // é‡æ–°æ¸²æŸ“æˆå‘˜åˆ—è¡¨
                                await renderGroupMembers();
                                
                                // æ›´æ–°æˆå‘˜æ•°é‡æ˜¾ç¤º
                                const countEl = document.getElementById('group-member-count');
                                if (countEl) {
                                    countEl.textContent = `æŸ¥çœ‹${newMembers.length}åç¾¤æˆå‘˜ >`;
                                    countEl.style.color = '';
                                }
                                
                                console.log(`[GroupSettings] å·²ç§»é™¤æˆå‘˜: ${name}`);
                            } catch (err) {
                                console.error('[GroupSettings] ç§»é™¤æˆå‘˜å¤±è´¥:', err);
                                alert('ç§»é™¤å¤±è´¥ï¼š' + err.message);
                            }
                        }
                    };
                }
                
                // â–¼â–¼â–¼â–¼â–¼â–¼ ä¿®å¤ç‚¹ 1ï¼šç‚¹å‡»æˆå‘˜å¤´åƒç¼–è¾‘ â–¼â–¼â–¼â–¼â–¼â–¼
                memberEl.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘ç¼–è¾‘
                    if (e.target.closest('.member-delete-btn')) return;
                    
                    // --- åŸæœ‰çš„æ‰“å¼€ç¼–è¾‘æ¡†é€»è¾‘ä¿æŒä¸å˜ ---
                    document.getElementById('edit-member-preview').src = avatarUrl;
                    document.getElementById('edit-member-name-input').value = name;
                    document.getElementById('edit-member-persona-input').value = contact ? contact.ai.persona : '';

                    if (typeof currentEditingMemberId !== 'undefined') {
                        currentEditingMemberId = id;
                    }

                    const editModal = document.getElementById('edit-member-modal');
                    editModal.style.display = 'flex';
                    setTimeout(() => { editModal.style.opacity = '1'; }, 10);
                };
                // â–²â–²â–²â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²â–²â–²â–²

                groupMembersGrid.appendChild(memberEl);
            });

            // --- æ¸²æŸ“åŠ å·æŒ‰é’® ---
            const addBtn = document.createElement('div');
            addBtn.className = 'member-avatar-item';
            addBtn.innerHTML = `
            <div class="member-add-btn">+</div>
            <span class="member-avatar-name" style="color:#007AFF;">é‚€è¯·</span>
        `;

            // â–¼â–¼â–¼â–¼â–¼â–¼ ä¿®å¤ç‚¹ 2ï¼šç‚¹å‡»åŠ å·æŒ‰é’® â–¼â–¼â–¼â–¼â–¼â–¼
            addBtn.onclick = () => {
                // é‡ç½®è¡¨å•
                newMemberName.value = '';
                newMemberPersona.value = '';
                newMemberAvatarPreview.src = 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=AI';

                // æ˜¾ç¤ºå¼¹çª—ï¼ˆå¸¦åŠ¨ç”»ï¼‰
                const addModal = document.getElementById('add-group-member-modal');
                addModal.style.display = 'flex';
                setTimeout(() => { addModal.style.opacity = '1'; }, 10);
            };
            // â–²â–²â–²â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²â–²â–²â–²

            groupMembersGrid.appendChild(addBtn);

        } catch (e) {
            console.error("æ¸²æŸ“ç¾¤æˆå‘˜å¤±è´¥", e);
        }
    }

    // 4. åŠŸèƒ½å®ç°ï¼šä¿®æ”¹ç¾¤å
    editGroupNameBtn.onclick = async () => {
        const newName = prompt("è¯·è¾“å…¥æ–°çš„ç¾¤åç§°ï¼š", currentOpenGroup.name);
        if (newName && newName.trim() !== "") {
            currentOpenGroup.name = newName.trim();
            groupSettingsName.textContent = currentOpenGroup.name;
            chatContactName.textContent = currentOpenGroup.name + ` (${currentOpenGroup.members.length})`;

            // ä¿å­˜åˆ°æ•°æ®åº“
            const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
            let allGroups = groupsData.value;
            const index = allGroups.findIndex(g => g.id === currentOpenGroup.id);
            if (index > -1) {
                allGroups[index] = currentOpenGroup;
                await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
            }

            // åˆ·æ–°åˆ—è¡¨é¢„è§ˆ
            if (typeof renderMessagesList === 'function') renderMessagesList();
        }
    };

    // 5. åŠŸèƒ½å®ç°ï¼šä¿®æ”¹ç¾¤å¤´åƒ
    groupSettingsAvatar.onclick = () => groupAvatarUploadInput.click();

    groupAvatarUploadInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (evt) => {
                const newUrl = evt.target.result;
                currentOpenGroup.avatar = newUrl;
                groupSettingsAvatar.style.backgroundImage = `url('${newUrl}')`;

                // ä¿å­˜
                const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = groupsData.value;
                const index = allGroups.findIndex(g => g.id === currentOpenGroup.id);
                if (index > -1) {
                    allGroups[index] = currentOpenGroup;
                    await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                }
                if (typeof renderMessagesList === 'function') renderMessagesList();
            };
            reader.readAsDataURL(file);
        }
    };

    // 7. åŠŸèƒ½å®ç°ï¼šç¼–è¾‘ç¾¤æˆå‘˜ä¿å­˜é€»è¾‘ (ä¿®å¤)
    if (typeof editMemberSaveBtn !== 'undefined' && editMemberSaveBtn) {
        // å¤´åƒé¢„è§ˆ
        if (editMemberAvatarInput) {
            editMemberAvatarInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        editMemberPreview.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        editMemberSaveBtn.onclick = async () => {
            const newName = editMemberNameInput.value.trim();
            const newPersona = editMemberPersonaInput.value.trim();
            const newAvatar = editMemberPreview.src;

            if (!newName) {
                alert("è§’è‰²åç§°ä¸èƒ½ä¸ºç©º");
                return;
            }

            let memberIndex = -1;
            if (currentEditingMemberId) {
                memberIndex = currentOpenGroup.members.findIndex(m => m.id === currentEditingMemberId);
            }

            if (memberIndex > -1) {
                currentOpenGroup.members[memberIndex].name = newName;
                currentOpenGroup.members[memberIndex].persona = newPersona;
                currentOpenGroup.members[memberIndex].avatar = newAvatar;

                // ä¿å­˜åˆ°æ•°æ®åº“
                const groupsData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = groupsData.value;
                const gIndex = allGroups.findIndex(g => g.id === currentOpenGroup.id);
                if (gIndex > -1) {
                    allGroups[gIndex] = currentOpenGroup;
                    await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                }
                
                // åˆ·æ–°UI
                renderGroupMembers();
                
                // å…³é—­çª—å£
                editMemberModal.style.opacity = '0';
                setTimeout(() => { editMemberModal.style.display = 'none'; }, 300);
            } else {
                alert('æœªæ‰¾åˆ°æˆå‘˜ä¿¡æ¯');
            }
        };

        if(typeof editMemberCloseBtn !== 'undefined' && editMemberCloseBtn) {
             editMemberCloseBtn.onclick = () => {
                 editMemberModal.style.display = 'none';
             };
        }
    }

    // 6. åŠŸèƒ½å®ç°ï¼šä¿®æ”¹æˆ‘çš„ç¾¤åç‰‡ (çº¢è‰²æ¡†éƒ¨åˆ†)
    // æ‰“å¼€å¼¹çª—
    groupUserCard.onclick = () => {
        // å¡«å……å½“å‰ä¿¡æ¯
        editGroupUserPreview.src = currentOpenGroup.userCardAvatar || "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me";
        editGroupUserNameInput.value = currentOpenGroup.userCardName || "æˆ‘";
        // å¡«å……äººè®¾ (å¦‚æœæ²¡æœ‰åˆ™ä¸ºç©º)
        editGroupUserPersonaInput.value = currentOpenGroup.userCardPersona || "";

        editGroupUserModal.style.display = 'flex';
        setTimeout(() => { editGroupUserModal.style.opacity = '1'; }, 10);
    };

    // å¤´åƒä¸Šä¼ ç›‘å¬ (è¿™æ˜¯ä¹‹å‰ç¼ºå¤±çš„ï¼)
    editGroupUserAvatarInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                editGroupUserPreview.src = evt.target.result; // æ›´æ–°é¢„è§ˆ
            };
            reader.readAsDataURL(file);
        }
    };
    // å…³é—­æŒ‰é’®
    document.getElementById('close-group-user-modal').onclick = () => {
        editGroupUserModal.style.opacity = '0';
        setTimeout(() => { editGroupUserModal.style.display = 'none'; }, 300);
    };

    closeGroupUserModal.onclick = () => editGroupUserModal.style.display = 'none';

    // ç”¨æˆ·å¤´åƒé¢„è§ˆ
    editGroupUserAvatarInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => editGroupUserPreview.src = evt.target.result;
            reader.readAsDataURL(file);
        }
    };

    // ä¿å­˜æˆ‘çš„ä¿¡æ¯
    saveGroupUserBtn.onclick = async () => {
        const newName = editGroupUserNameInput.value.trim() || "æˆ‘";
        const newPersona = editGroupUserPersonaInput.value.trim(); // è·å–äººè®¾
        const newAvatar = editGroupUserPreview.src;

        // æ›´æ–°å†…å­˜å¯¹è±¡
        currentOpenGroup.userCardName = newName;
        currentOpenGroup.userCardAvatar = newAvatar;
        currentOpenGroup.userCardPersona = newPersona; // ä¿å­˜äººè®¾

        // æ›´æ–°UI
        groupUserName.textContent = newName;
        groupUserAvatar.style.backgroundImage = `url('${newAvatar}')`;

        // ä¿å­˜åˆ°æ•°æ®åº“
        const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
        let allGroups = groupsData.value;
        const index = allGroups.findIndex(g => g.id === currentOpenGroup.id);
        if (index > -1) {
            allGroups[index] = currentOpenGroup;
            await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
        }

        editGroupUserModal.style.display = 'none';
    };


    // å…³é—­æŒ‰é’®
    editMemberCloseBtn.onclick = () => {
        editMemberModal.style.opacity = '0';
        setTimeout(() => { editMemberModal.style.display = 'none'; }, 300);
    };

    // å¤´åƒä¸Šä¼ ç›‘å¬
    editMemberAvatarInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                editMemberPreview.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
    };

    // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    editMemberSaveBtn.onclick = async () => {
        // å¦‚æœæ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„IDï¼Œç›´æ¥è¿”å›
        if (!currentEditingMemberId) return;

        // --- ç¬¬ä¸€æ­¥ï¼šè·å–è¾“å…¥æ¡†é‡Œçš„æ–°å€¼ ---
        const newName = editMemberNameInput.value.trim();
        const newPersona = editMemberPersonaInput.value.trim();
        const newAvatar = editMemberPreview.src;

        // 1. è¯»å–è”ç³»äººæ•°æ®åº“
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        let allContacts = contactsData ? contactsData.value : [];

        // åœ¨æ•°æ®åº“æ•°æ®ä¸­æ‰¾åˆ°è¿™ä¸ªäºº
        const contactIndex = allContacts.findIndex(c => c.id === currentEditingMemberId);

        if (contactIndex > -1) {
            // 2. æ›´æ–°å†…å­˜ä¸­ allContacts æ•°ç»„çš„ä¿¡æ¯
            allContacts[contactIndex].ai.name = newName;
            allContacts[contactIndex].ai.persona = newPersona;
            allContacts[contactIndex].ai.avatar = newAvatar;

            // 3. ä¿å­˜è”ç³»äººå›æ•°æ®åº“
            await dbHelper.saveData('messageContacts', 'allContacts', allContacts);

            // --- æ›´æ–°å½“å‰æ­£åœ¨å•èŠçš„å¯¹è±¡ä¿¡æ¯ ---
            if (typeof currentContact !== 'undefined' && currentContact && currentContact.id === currentEditingMemberId) {
                currentContact.ai.name = newName;
                currentContact.ai.persona = newPersona;
                currentContact.ai.avatar = newAvatar;
            }

            // ===========================================================
            // ğŸ”´ã€æ ¸å¿ƒä¿®å¤ï¼šåŒæ­¥æ›´æ–°ç¾¤èŠå†å²è®°å½• + åˆ—è¡¨é¢„è§ˆã€‘ğŸ”´ 
            // ===========================================================
            try {
                const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                let hasChanges = false;

                // éå†æ¯ä¸€ä¸ªç¾¤
                allGroups.forEach(group => {
                    if (group.history && Array.isArray(group.history) && group.history.length > 0) {
                        let groupHistoryChanged = false;

                        // A. éå†å†å²è®°å½•æ”¹å (ä¹‹å‰çš„é€»è¾‘)
                        group.history.forEach(msg => {
                            const isMatch = (msg.memberId && String(msg.memberId) === String(currentEditingMemberId)) ||
                                (!msg.memberId && msg.senderName === allContacts[contactIndex].ai.name);

                            if (isMatch) {
                                msg.senderName = newName;   // æ›´æ–°åå­—
                                msg.senderAvatar = newAvatar; // æ›´æ–°å¤´åƒ
                                groupHistoryChanged = true;
                            }
                        });

                        // B. â–¼â–¼â–¼ã€æ–°å¢ä¿®å¤ã€‘æ›´æ–°åˆ—è¡¨é¢„è§ˆ (lastMessage) â–¼â–¼â–¼
                        // å–å‡ºå†å²è®°å½•çš„æœ€åä¸€æ¡
                        const lastMsg = group.history[group.history.length - 1];

                        // æ£€æŸ¥æœ€åä¸€æ¡æ˜¯ä¸æ˜¯è¿™ä¸ªäººå‘çš„
                        const lastMsgIsMatch = (lastMsg.memberId && String(lastMsg.memberId) === String(currentEditingMemberId)) ||
                            (!lastMsg.memberId && lastMsg.senderName === newName); // æ³¨æ„è¿™é‡Œç”¨newNameå› ä¸ºä¸Šé¢å·²ç»æ”¹è¿‡äº†

                        if (lastMsgIsMatch) {
                            // é‡æ–°ç”Ÿæˆé¢„è§ˆæ–‡æœ¬
                            let contentPreview = lastMsg.text || '[å¤šåª’ä½“]';
                            // ç®€å•å¤„ç†ä¸€ä¸‹ç‰¹æ®Šç±»å‹
                            if (lastMsg.type === 'sticker') contentPreview = '[è¡¨æƒ…åŒ…]';
                            if (lastMsg.type === 'image') contentPreview = '[å›¾ç‰‡]';
                            if (lastMsg.type === 'voice_text') contentPreview = '[è¯­éŸ³]';

                            // è¦†ç›–æ—§çš„ lastMessage
                            group.lastMessage = `${newName}: ${contentPreview}`;
                            groupHistoryChanged = true; // æ ‡è®°æ”¹å˜
                        }
                        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

                        if (groupHistoryChanged) {
                            hasChanges = true;
                            // å¦‚æœå½“å‰æ­£å¥½æ‰“å¼€ç€è¿™ä¸ªç¾¤ï¼Œæ›´æ–°å†…å­˜å¯¹è±¡
                            if (currentOpenGroup && currentOpenGroup.id === group.id) {
                                currentOpenGroup.history = group.history;
                                currentOpenGroup.lastMessage = group.lastMessage; // åŒæ­¥æ›´æ–°å†…å­˜
                            }
                        }
                    }
                });

                // å¦‚æœæœ‰æ•°æ®å˜äº†ï¼Œä¿å­˜å›æ•°æ®åº“
                if (hasChanges) {
                    await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                }

            } catch (err) {
                console.error("åŒæ­¥å†å²è®°å½•å¤±è´¥:", err);
            }

            // ===========================================================
            // ğŸ”´ã€ç•Œé¢å®æ—¶æ›´æ–°ã€‘ğŸ”´ 
            // ===========================================================

            // 1. æ›´æ–°èŠå¤©æ°”æ³¡ (DOM)
            const memberRows = document.querySelectorAll(`.message-row[data-sender-id="${currentEditingMemberId}"]`);
            memberRows.forEach(row => {
                const nicknameEl = row.querySelector('.group-nickname');
                if (nicknameEl) nicknameEl.textContent = newName;
                const avatarEl = row.querySelector('.chat-avatar');
                if (avatarEl) avatarEl.src = newAvatar;
            });

            // 2. åˆ·æ–°ç¾¤æˆå‘˜åˆ—è¡¨
            if (typeof renderGroupMembers === 'function') {
                renderGroupMembers();
            }

            // 3. â–¼â–¼â–¼ã€æ–°å¢ã€‘åˆ·æ–°å·¦ä¾§/é¦–é¡µçš„æ¶ˆæ¯åˆ—è¡¨ â–¼â–¼â–¼
            // è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒä¼šé‡ç»˜é¦–é¡µåˆ—è¡¨ï¼ŒæŠŠæ–°çš„ lastMessage æ˜¾ç¤ºå‡ºæ¥
            if (typeof renderMessagesList === 'function') {
                renderMessagesList();
            } else if (typeof loadGroups === 'function') {
                loadGroups(); // å¦‚æœä½ å«è¿™ä¸ªåå­—çš„è¯
            }

            // 4. å…³é—­å¼¹çª—
            editMemberModal.style.display = 'none';
        }
    };



    // å…³é—­æŒ‰é’®
    addMemberCloseBtnElement.onclick = () => {
        addMemberModal.style.opacity = '0';
        setTimeout(() => { addMemberModal.style.display = 'none'; }, 300);
    };

    // å¤´åƒä¸Šä¼ ç›‘å¬
    newMemberAvatarInputElement.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                newMemberPreviewElement.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
    };

    // ä¿å­˜å¹¶åŠ å…¥æŒ‰é’®
    saveNewMemberBtnElement.onclick = async () => {
        const name = newMemberNameInput.value.trim();
        if (!name) { alert("è¯·è¾“å…¥è§’è‰²åç§°"); return; }

        // 1. åˆ›å»ºæ–°è”ç³»äººå¯¹è±¡
        const newContact = {
            id: Date.now(),
            isHidden: true,
            ai: {
                name: name,
                persona: newMemberPersonaInput.value.trim(),
                avatar: newMemberPreviewElement.src
            },
            user: { // é»˜è®¤ç”¨æˆ·è®¾ç½®
                name: "æˆ‘",
                persona: "",
                avatar: "https://placehold.co/100x100/EFEFEF/AAAAAA?text=User"
            },
            contextMemory: 10,
            lastMessage: "æ–°è§’è‰²å·²åˆ›å»º"
        };

        // 2. ä¿å­˜åˆ°è”ç³»äººæ•°æ®åº“
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        let allContacts = (contactsData && Array.isArray(contactsData.value)) ? contactsData.value : [];
        allContacts.push(newContact);
        await dbHelper.saveData('messageContacts', 'allContacts', allContacts);

        // 3. å°†æ–°è§’è‰²åŠ å…¥å½“å‰ç¾¤èŠ
        if (currentOpenGroup) {
            if (!currentOpenGroup.members) currentOpenGroup.members = [];
            currentOpenGroup.members.push(newContact.id);

            // ä¿å­˜ç¾¤èŠæ•°æ®
            const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
            let allGroups = groupsData.value;
            const index = allGroups.findIndex(g => g.id === currentOpenGroup.id);
            if (index > -1) {
                allGroups[index] = currentOpenGroup;
                await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
            }
        }

        // 4. åˆ·æ–°ç•Œé¢å¹¶å…³é—­
        renderGroupMembers();
        addMemberModal.style.display = 'none';
    };

    groupInfoModalOverlay.addEventListener('click', (event) => {
        // ã€æ ¸å¿ƒåˆ¤æ–­ã€‘
        // event.target æ˜¯ä½ æ‰‹æŒ‡å®é™…ç‚¹åˆ°çš„å…ƒç´ 
        // groupInfoModalOverlay æ˜¯ç»‘å®šäº‹ä»¶çš„é®ç½©å±‚å…ƒç´ 
        // åªæœ‰å½“ä¸¤è€…ç›¸ç­‰æ—¶ï¼Œè¯´æ˜ä½ ç‚¹åœ¨äº†â€œç°è‰²èƒŒæ™¯â€ä¸Šï¼Œè€Œä¸æ˜¯â€œç™½è‰²å†…å®¹å¡ç‰‡â€ä¸Š
        if (event.target === groupInfoModalOverlay) {

            // æ‰§è¡Œå…³é—­åŠ¨ç”»ï¼ˆå¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼‰
            groupInfoModalOverlay.style.opacity = '0';
            setTimeout(() => {
                groupInfoModalOverlay.style.display = 'none';
            }, 300);
        }
    });

    /**
     * 1. æ”¶é›†ç¾¤æˆå‘˜ä¿¡æ¯ï¼Œæ„å»º Promptï¼Œè¯·æ±‚ AI ç”Ÿæˆå‰§æœ¬
     */
    async function fetchGroupScript(group) {
        // A. å‡†å¤‡æ•°æ®
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        const allContacts = contactsData.value;

        // è¿‡æ»¤å‡ºå½“å‰ç¾¤çš„æˆå‘˜
        const members = allContacts.filter(c => group.members.includes(c.id));

        if (members.length === 0) {
            alert("ç¾¤é‡Œæ²¡äººï¼ŒèŠä¸èµ·æ¥ï¼");
            return;
        }

        // B. æ„å»ºæˆå‘˜äººè®¾åˆ—è¡¨å­—ç¬¦ä¸²
        const memberPersonas = members.map(m =>
            `- å§“åï¼š${m.ai.name}\n  äººè®¾ï¼š${m.ai.persona}`
        ).join('\n\n');

        // C. æ„å»ºèŠå¤©è®°å½•å­—ç¬¦ä¸²
        const history = group.history || [];
        const recentHistory = history.slice(-20); // å–æœ€è¿‘20æ¡
        const historyText = recentHistory.map(msg => {
            let senderName = "æœªçŸ¥";
            if (msg.sender === 'user') {
                senderName = group.userCardName || "æˆ‘";
            } else if (msg.sender === 'ai') {
                senderName = msg.senderName || "ç¾¤å‹";
            }
            // ç®€å•æ¸…ç†ä¸€ä¸‹å†…å®¹
            let content = msg.text || (msg.type === 'sticker' ? '[è¡¨æƒ…åŒ…]' : '[å¤šåª’ä½“]');
            return `${senderName}: ${content}`;
        }).join('\n');

        // â–¼â–¼â–¼ D. æ–°å¢ï¼šè·å–å¹¶æ„å»ºä¸–ç•Œä¹¦å†…å®¹ (æ”¯æŒæ–°ç‰ˆå¤šé€‰) â–¼â–¼â–¼
        let worldBookContext = "æ— ç‰¹å®šä¸–ç•Œè§‚è®¾å®šã€‚";
        try {
            const worldbookData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            const allBooks = (worldbookData && Array.isArray(worldbookData.value)) ? worldbookData.value : [];
            let requiredBookIds = new Set();
            
            // ä¼˜å…ˆæ–°ç‰ˆ (ç¾¤ç»„ä¹Ÿæ˜¯ç”¨ linkedWorldBookIds å­˜å‚¨)
            if (group.linkedWorldBookIds && group.linkedWorldBookIds.length > 0) {
                 group.linkedWorldBookIds.forEach(id => requiredBookIds.add(id));
            } 
            // å›é€€æ—§ç‰ˆ
            else if (group.linkedWorldBookGroupIds && group.linkedWorldBookGroupIds.length > 0) {
                 const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                 const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                 const linkedGroupIds = new Set(group.linkedWorldBookGroupIds);
                 allGroups.forEach(g => {
                     if (linkedGroupIds.has(g.id) && Array.isArray(g.bookIds)) {
                         g.bookIds.forEach(bid => requiredBookIds.add(bid));
                     }
                 });
            }

            if (requiredBookIds.size > 0) {
                const contextParts = allBooks
                    .filter(b => requiredBookIds.has(b.id))
                    .map(b => `ã€è®¾å®šï¼š${b.name}ã€‘\n${b.content}`);
                
                if (contextParts.length > 0) {
                    worldBookContext = contextParts.join('\n\n');
                    console.log(`å·²æ³¨å…¥ ${contextParts.length} æœ¬ä¸–ç•Œä¹¦çš„è®¾å®šã€‚`);
                }
            }
        } catch (e) {
            console.error("è¯»å–ç¾¤èŠä¸–ç•Œä¹¦å¤±è´¥", e);
        }

        // â–¼â–¼â–¼ æ–°å¢ï¼šåŠ è½½è¡¨æƒ…åŒ…åº“ (æ··åˆæ¨¡å¼ï¼šæ•°æ®åº“ + ä¸–ç•Œä¹¦åŠ¨æ€æå–) â–¼â–¼â–¼
        let availableEmojis = [];

        // 1. ä»æ•°æ®åº“åŠ è½½å…¨å±€è¡¨æƒ…åŒ…
        try {
            const emojis = await dbHelper.getAllDataFromStore('emojiStore');
            if (emojis && emojis.length > 0) {
                emojis.forEach(e => availableEmojis.push(e.remark));
            }
        } catch (e) {
            console.error("ç¾¤èŠåŠ è½½å…¨å±€è¡¨æƒ…åŒ…å¤±è´¥", e);
        }

        // 2. ä»å…³è”çš„ä¸–ç•Œä¹¦ä¸­åŠ¨æ€æå–è¡¨æƒ…åŒ…
        // worldBookContext å˜é‡åœ¨ä¸Šé¢å·²ç»è¢«ä½ æ„å»ºå¥½äº†ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰å…³è”ä¸–ç•Œä¹¦çš„å†…å®¹
        // æˆ‘ä»¬ç›´æ¥æ‰«æå®ƒï¼
        if (worldBookContext) {
            const extractedKeywords = extractAndRegisterStickers(worldBookContext);
            if (extractedKeywords.length > 0) {
                console.log(`ä»ä¸–ç•Œä¹¦ä¸­æå–åˆ°äº† ${extractedKeywords.length} ä¸ªä¸“å±è¡¨æƒ…åŒ…:`, extractedKeywords);
                // æŠŠè¿™äº›æ–°è¡¨æƒ…ä¹ŸåŠ å…¥åˆ°å¯ç”¨åˆ—è¡¨ä¸­
                availableEmojis = availableEmojis.concat(extractedKeywords);
            }
        }

        // 3. ç”Ÿæˆæœ€ç»ˆçš„ Prompt å­—ç¬¦ä¸²
        let emojiListString = "æš‚æ— å¯ç”¨è¡¨æƒ…åŒ…";
        if (availableEmojis.length > 0) {
            // å»é‡ (é˜²æ­¢ä¸–ç•Œä¹¦é‡Œå†™äº†é‡å¤çš„ï¼Œæˆ–è€…å’Œå…¨å±€é‡å¤)
            const uniqueEmojis = [...new Set(availableEmojis)];
            emojiListString = uniqueEmojis.join(', ');
        }
        // â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–²

        // D. ç»„è£…æœ€ç»ˆ Prompt
        let finalTemplate = GROUP_DIRECTOR_PROMPT;
        
        if (group.bilingualBubble && group.bilingualBubble.enabled) {
            finalTemplate += `
å¯¹è¯ç¿»è¯‘æ ¼å¼å¼ºåˆ¶è§„åˆ™
ä¸€ã€æ ¸å¿ƒæ ¼å¼è¦æ±‚ï¼ˆä¸¥ç¦è¿ä½“åº”ç­”ï¼‰
1. ç¿»è¯‘åˆ†éš”æ ‡è®°ï¼šè¾“å‡ºå†…å®¹åŒ…å«å¤–è¯­/æ–¹è¨€æ—¶ï¼Œæ¯å¥è¯æœ«å°¾å¿…é¡»ä½¿ç”¨ [Split] åˆ†éš”ç¬¦ï¼Œç´§éšå…¶åæ ‡æ³¨ä¸­æ–‡ç¿»è¯‘ã€‚
2. æ°”æ³¡å¼ºåˆ¶åˆ†éš”ï¼šã€é‡è¦ã€‘æ¯ä¸€ç»„ "åŸæ–‡[Split]è¯‘æ–‡" ç»“æŸåï¼Œå¿…é¡»å¼ºåˆ¶ä»¥ \\\\ (å³å•ä¸ªåæ–œæ ) ç»“å°¾ã€‚è¿™å†³å®šäº†æ°”æ³¡æ˜¯å¦èƒ½æ­£ç¡®åˆ†æ®µã€‚ä¸¥ç¦å°†å¤šç»„å¯¹è¯è¿åœ¨åŒä¸€è¡Œè¾“å‡ºï¼
3. åŠ¨ä½œæè¿°å¤„ç†ï¼šä»¥ * * åŒ…è£¹çš„åŠ¨ä½œæè¿°å†…å®¹ï¼Œæ— éœ€ç¿»è¯‘ï¼Œä¿ç•™åŸæ ·ã€‚

äºŒã€æ­£ç¡®ç¤ºä¾‹ï¼ˆè¯·ä¸¥æ ¼æ¨¡ä»¿æ¢è¡Œå’Œåæ–œæ ï¼‰
Hello, world.[Split]ä½ å¥½ï¼Œä¸–ç•Œã€‚\\\\
How are you today?[Split]ä½ ä»Šå¤©å¥½å—ï¼Ÿ\\\\
I'm fine, thank you.[Split]æˆ‘å¾ˆå¥½ï¼Œè°¢è°¢ä½ ã€‚\\\\

ä¸‰ã€é”™è¯¯è¡Œä¸ºè­¦ç¤ºï¼ˆç»å¯¹ç¦æ­¢ï¼‰
âŒ é”™è¯¯ï¼šHello.[Split]ä½ å¥½ã€‚How are you?[Split]ä½ å¥½å—ï¼Ÿ ï¼ˆä¸¤å¥è¯è¿åœ¨ä¸€èµ·ï¼Œå¯¼è‡´è§£æå¤±è´¥ï¼‰
âœ… æ­£ç¡®ï¼šHello.[Split]ä½ å¥½ã€‚\\\\
         How are you?[Split]ä½ å¥½å—ï¼Ÿ\\\\
ï¼ˆæ³¨æ„ï¼šå¿…é¡»æ˜¾å¼æ¢è¡Œï¼Œä¸”æ¯è¡Œæœ«å°¾å¿…é¡»æœ‰åæ–œæ  \\\\ ï¼ï¼‰

å››ã€ç‰¹æ®Šåœºæ™¯
1. çº¯ä¸­æ–‡å†…å®¹ï¼šæ— éœ€ [Split]ï¼Œä½†ä»å»ºè®®ä»¥ \\\\ ç»“å°¾ä»¥ç¡®ä¿åˆ†æ°”æ³¡ã€‚
2. æ–¹è¨€å†…å®¹ï¼šä½ é£Ÿå’—é¥­æœªï¼Ÿ[Split]ä½ åƒé¥­äº†å—ï¼Ÿ\\\\
`;
        }

        const finalPrompt = finalTemplate
            .replace(/\$\{group_name\}/g, group.name)
            .replace(/\$\{current_time\}/g, new Date().toLocaleString())
            .replace(/\$\{member_personas\}/g, memberPersonas)
            .replace(/\$\{context_info\}/g, `ä¸–ç•Œè§‚è®¾å®šï¼š\n${worldBookContext}`)
            .replace(/\$\{emoji_list\}/g, emojiListString)
            .replace(/\$\{chat_history\}/g, historyText);

        console.log("ç¾¤èŠå¯¼æ¼”Promptæ„å»ºå®Œæˆï¼Œå‡†å¤‡è¯·æ±‚...");

        // E. å‘é€è¯·æ±‚ (ç‹¬ç«‹é“¾è·¯ï¼Œä¸ä½¿ç”¨ callAI)
        try {
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value.url) throw new Error("APIæœªé…ç½®");
            const { url, key, model } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: finalPrompt },
                        { role: "user", content: "(ç³»ç»ŸæŒ‡ä»¤ï¼šè¯·æ ¹æ®å‰§æƒ…å‘å±•ï¼Œç”Ÿæˆæ¥ä¸‹æ¥çš„ç¾¤èŠå¯¹è¯è„šæœ¬ã€‚)" }
                    ],
                    temperature: 1.1, // ç¾¤èŠå¯ä»¥ç¨å¾®æ´»è·ƒä¸€ç‚¹
                })
            });

            if (!response.ok) throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥");

            const data = await response.json();
            const scriptText = data.choices[0].message.content;

            console.log("æ”¶åˆ°å‰§æœ¬:", scriptText);

            // F. å°†å‰§æœ¬äº¤ç»™è§£æå™¨æ‰§è¡Œ
            await executeGroupScript(scriptText, group, members);

        } catch (error) {
            console.error("ç¾¤èŠç”Ÿæˆå¤±è´¥:", error);
            alert("ç¾¤èŠç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–APIè®¾ç½®");
        }
    }
    /**
     * 2. è§£æå‰§æœ¬ï¼Œå¹¶åœ¨ç•Œé¢ä¸Šå‘ˆç°
     * @param {string} scriptText - AIè¿”å›çš„åŸå§‹æ–‡æœ¬
     * @param {object} group - å½“å‰ç¾¤ç»„å¯¹è±¡
     * @param {Array} members - ç¾¤æˆå‘˜å®Œæ•´ä¿¡æ¯åˆ—è¡¨(ç”¨äºæŸ¥æ‰¾å¤´åƒ)
     */
    /**
     * æ™ºèƒ½è§£æç¾¤èŠè¡¨æƒ…åŒ…
     * æ”¯æŒå¤šç§AIè¾“å‡ºæ ¼å¼:
     * - è¡¨æƒ…åŒ…ï¼š[å…³é”®è¯]
     * - è¡¨æƒ…åŒ…ï¼šå…³é”®è¯
     * - è¡¨æƒ…åŒ…ï¼š[å…³é”®è¯:url]
     * - (è¡¨æƒ…åŒ…ï¼šxx) ç­‰å˜ä½“
     * @param {string} text - å¾…è§£æçš„æ–‡æœ¬
     * @returns {Object|null} - {keyword: string, url?: string} æˆ– null
     */
    function parseGroupSticker(text) {
        if (!text || typeof text !== 'string') return null;
        
        // å®šä¹‰å¤šç§æ­£åˆ™æ¨¡å¼,æŒ‰ä¼˜å…ˆçº§æ’åº
        const patterns = [
            // æ ¼å¼1: è¡¨æƒ…åŒ…ï¼š[å…³é”®è¯:http://xxx]  (å¸¦å®Œæ•´URL)
            /(?:è¡¨æƒ…åŒ…|è´´å›¾|sticker)[ï¼š:]\s*[\[ã€]([^:\]ã€‘]+):(\s*https?:\/\/[^\]ã€‘\s]+)\s*[\]ã€‘]/i,
            
            // æ ¼å¼2: è¡¨æƒ…åŒ…ï¼š[å…³é”®è¯]  (æ ‡å‡†æ ¼å¼)
            /(?:è¡¨æƒ…åŒ…|è´´å›¾|sticker)[ï¼š:]\s*[\[ã€]([^\]ã€‘]+)[\]ã€‘]/i,
            
            // æ ¼å¼3: è¡¨æƒ…åŒ…ï¼šå…³é”®è¯  (æ— æ‹¬å·)
            /(?:è¡¨æƒ…åŒ…|è´´å›¾|sticker)[ï¼š:]\s*([^\s\[\]ã€ã€‘()ï¼ˆï¼‰]+)/i,
            
            // æ ¼å¼4: (è¡¨æƒ…åŒ…ï¼šxx) æˆ– ï¼ˆè¡¨æƒ…åŒ…ï¼šxxï¼‰  (å¸¦åœ†æ‹¬å·)
            /[ï¼ˆ(](?:è¡¨æƒ…åŒ…|è´´å›¾|sticker)[ï¼š:]\s*([^)ï¼‰]+)[)ï¼‰]/i,
        ];
        
        // ä¾æ¬¡å°è¯•æ¯ä¸ªæ¨¡å¼
        for (const pattern of patterns) {
            const match = text.match(pattern);
            if (match) {
                const keyword = match[1].trim();
                const url = match[2] ? match[2].trim() : null;
                
                // éªŒè¯å…³é”®è¯ä¸ä¸ºç©º
                if (keyword) {
                    return { keyword, url };
                }
            }
        }
        
        return null;
    }
    
    /**
     * 2. è§£æå‰§æœ¬ï¼Œå¹¶åœ¨ç•Œé¢ä¸Šå‘ˆç° (ä¿®æ”¹ç‰ˆï¼šåŠ å…¥æ— å¤´åƒç­‰å¾…åŠ¨ç”»)
     */
    async function executeGroupScript(scriptText, group, members) {
        const turns = scriptText.split(/;|ï¼›/).map(t => t.trim()).filter(t => t);

        for (const turn of turns) {
            const match = turn.match(/[\[ã€](.*?)[\]ã€‘]\s*(.*)/);
            if (!match) continue;

            const speakerName = match[1].trim();
            const contentRaw = match[2].trim();
            const speaker = members.find(m => m.ai.name === speakerName);

            if (!speaker) continue;

            const bubbles = contentRaw.split(/\\|\\/).map(b => b.trim()).filter(b => b);

            for (const text of bubbles) {
                // 1. æ„å»ºæ¶ˆæ¯å¯¹è±¡
                const msgObject = {
                    sender: 'ai',
                    memberId: speaker.id,
                    senderName: speaker.ai.name,
                    senderAvatar: speaker.ai.avatar,
                    timestamp: new Date(),
                    uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                };

                // â–¼â–¼â–¼ ä¼˜åŒ–åçš„è¡¨æƒ…åŒ…è§£æé€»è¾‘ â–¼â–¼â–¼
                const stickerInfo = parseGroupSticker(text);
                if (stickerInfo) {
                    // å¦‚æœè§£ææˆåŠŸ,ä¼˜å…ˆä½¿ç”¨æå–çš„URL,å¦åˆ™ä»stickerMapæŸ¥æ‰¾
                    const finalUrl = stickerInfo.url || stickerMap.get(stickerInfo.keyword);
                    
                    if (finalUrl) {
                        msgObject.type = 'sticker';
                        msgObject.url = finalUrl;
                        msgObject.text = `[è¡¨æƒ…åŒ…ï¼š${stickerInfo.keyword}]`;
                    } else {
                        // æ‰¾ä¸åˆ°å¯¹åº”çš„è¡¨æƒ…åŒ…,é™çº§ä¸ºæ–‡æœ¬æ˜¾ç¤º
                        msgObject.type = 'text';
                        msgObject.text = `*å‘é€äº†è¡¨æƒ…åŒ…: ${stickerInfo.keyword}*`;
                    }
                } else {
                    msgObject.type = 'text';
                    msgObject.text = text;
                }
                // â–²â–²â–² è¡¨æƒ…åŒ…è§£æç»“æŸ â–²â–²â–²

                // â–¼â–¼â–¼ æ–°å¢åŠ¨ç”»é€»è¾‘ â–¼â–¼â–¼

                // A. æ˜¾ç¤ºæ— å¤´åƒçš„æ­£åœ¨è¾“å…¥åŠ¨ç”»
                const typingEl = showGroupTypingIndicator();

                // B. è®¡ç®—å»¶è¿Ÿ (æ¨¡æ‹Ÿæ‰“å­—)
                const delay = Math.min(Math.max(text.length * 100, 1000), 3000);

                // C. ç­‰å¾…
                await new Promise(r => setTimeout(r, delay));

                // D. ç§»é™¤åŠ¨ç”»
                if (typingEl) typingEl.remove();

                // â–²â–²â–² åŠ¨ç”»é€»è¾‘ç»“æŸ â–²â–²â–²

                // 2. ä¿å­˜ & æ¸²æŸ“çœŸå®æ¶ˆæ¯ (å¸¦å¤´åƒ)
                await saveGroupMessageToHistory(msgObject, group.id);
                addGroupMessageToView(msgObject);
            }
        }
    }

    /**
     * æ˜¾ç¤ºç¾¤èŠçš„â€œæ­£åœ¨è¾“å…¥â€åŠ¨ç”»ï¼ˆæ— å¤´åƒç‰ˆï¼‰
     * è¿”å›è¯¥åŠ¨ç”»å…ƒç´ çš„å¼•ç”¨ï¼Œä»¥ä¾¿ç¨ååˆ é™¤
     */
    function showGroupTypingIndicator() {
        const row = document.createElement('div');
        row.className = 'message-row ai typing-indicator';

        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ•…æ„ä¸åˆ›å»º img.chat-avatar å…ƒç´ ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªç©ºçš„å ä½
        // æ ¹æ®ä½ çš„ CSS å¸ƒå±€ï¼Œå¦‚æœä¸åŠ å¤´åƒå…ƒç´ ï¼Œæ°”æ³¡å¯èƒ½ä¼šé æœ€å·¦è¾¹ï¼Œè¿™æ­£æ˜¯ä½ æƒ³è¦çš„â€œæ— å¤´åƒâ€æ•ˆæœ

        const wrapper = document.createElement('div');
        wrapper.className = 'message-content-wrapper ai';

        // åˆ›å»ºæ°”æ³¡
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble ai-bubble';
        // ç¨å¾®è°ƒæ•´ä¸€ä¸‹æ ·å¼ï¼Œå› ä¸ºæ²¡æœ‰å¤´åƒï¼Œå¯èƒ½éœ€è¦ä¸€ç‚¹å·¦è¾¹è·
        bubble.style.marginLeft = '10px';

        bubble.innerHTML = `<div class="typing-animation"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>`;

        wrapper.appendChild(bubble);
        row.appendChild(wrapper);

        chatMessagesContainer.appendChild(row);
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;

        return row;
    }

    // ==========================================================
    // === ç¾¤èŠæ¶ˆæ¯æ¸²æŸ“ä¸“ç”¨å‡½æ•° ===
    // ==========================================================
    function addGroupMessageToView(message, container = null) {
        // â–¼â–¼â–¼ æ€§èƒ½ç›‘æ§ â–¼â–¼â–¼
        const perfStart = performance.now();
        const profiler = window.profiler;
        if (profiler && profiler.isRecording) {
            profiler.startTimer('ğŸ¨ æ¸²æŸ“ç¾¤èŠæ¶ˆæ¯', {
                sender: message.sender,
                type: message.type,
                hasImage: !!message.image
            });
        }
        
        const targetContainer = container || chatMessagesContainer;
        if (!message) return null;
        if (message.type === 'call_summary') return null;

        // 1. å‡†å¤‡æ•°æ®
        let avatarUrl = '';
        let displayName = '';
        let memberId = ''; // ç”¨äºç»‘å®šæ ·å¼çš„å…³é”®ID

        if (message.sender === 'user') {
            avatarUrl = currentOpenGroup.userCardAvatar || "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me";
            displayName = currentOpenGroup.userCardName || "æˆ‘";
            memberId = 'user-me'; // ç»™è‡ªå·±ä¸€ä¸ªå›ºå®šçš„æ ‡è¯†
        } else {
            // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ã€‘ä¼˜å…ˆä»å®æ—¶ç¼“å­˜ä¸­è·å–å¤´åƒ â–¼â–¼â–¼
            // å¦‚æœç¼“å­˜é‡Œæœ‰è¿™ä¸ªæˆå‘˜ï¼Œå°±ç”¨ä»–çš„æœ€æ–°å¤´åƒï¼›å¦åˆ™å›é€€åˆ°æ¶ˆæ¯é‡Œçš„å¿«ç…§
            let cachedMember = null;
            if (currentOpenGroup && currentOpenGroup.memberMap && message.memberId) {
                cachedMember = currentOpenGroup.memberMap[message.memberId];
            }

            if (cachedMember && cachedMember.ai) {
                avatarUrl = cachedMember.ai.avatar;
                displayName = cachedMember.ai.name; // å¯é€‰ï¼šä¹Ÿæ›´æ–°åå­—
            } else {
                avatarUrl = message.senderAvatar || 'https://placehold.co/100x100/ccc/fff?text=?';
                displayName = message.senderName || 'ç¾¤å‹';
            }
            

            memberId = message.memberId || 'unknown'; // ä½¿ç”¨æ¶ˆæ¯ä¸­è®°å½•çš„ memberId
        }

        // 2. åˆ›å»º DOM ç»“æ„
        const row = document.createElement('div');
        row.className = 'message-row';
        if (message.uuid) row.dataset.uuid = message.uuid;
        // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ã€‘ç¡®ä¿ sender-id ç»å¯¹å­˜åœ¨ â–¼â–¼â–¼
        row.dataset.senderId = String(memberId);
        // â–¼â–¼â–¼ã€æ€§èƒ½ä¼˜åŒ–ã€‘Scope CSS ä¸“ç”¨IDï¼Œç”¨äºæ ·å¼éš”ç¦» â–¼â–¼â–¼
        row.dataset.styleMemberId = String(memberId);
        

        // â–¼â–¼â–¼ æ–°å¢ï¼šæ ‡è®°æ˜¯å¦ä¸ºç”¨æˆ·ï¼Œæ–¹ä¾¿CSSæ§åˆ¶å·¦å³å¸ƒå±€ â–¼â–¼â–¼
        if (message.sender === 'user') {
            row.classList.add('is-user');
        }

        const indicator = document.createElement('div');
        indicator.className = 'selection-indicator';

        // --- A. åˆ›å»ºå¤´åƒå®¹å™¨ (Avatar + Nickname) ---
        const avatarContainer = document.createElement('div');
        avatarContainer.className = 'chat-avatar-container';

        const avatar = document.createElement('img');
        avatar.className = 'chat-avatar';
        avatar.src = avatarUrl;
        const radius = (currentOpenGroup.avatarSettings && currentOpenGroup.avatarSettings.radius) || '50%';
        avatar.style.borderRadius = radius;

        // â–¼â–¼â–¼ æ ¸å¿ƒï¼šç»™å¤´åƒç»‘å®šç‚¹å‡»äº‹ä»¶æ•°æ® â–¼â–¼â–¼
        avatar.dataset.action = 'edit-bubble-style'; // æ ‡è®°è¿™ä¸ªå›¾ç‰‡æ˜¯å¯ä»¥ç‚¹å‡»ç¼–è¾‘æ ·å¼çš„
        avatar.dataset.memberId = memberId;          // è®°å½•æ˜¯è°
        avatar.dataset.isUser = (message.sender === 'user'); // è®°å½•æ˜¯ä¸æ˜¯ç”¨æˆ·è‡ªå·±

        const nameDiv = document.createElement('div');
        nameDiv.className = 'group-nickname';
        nameDiv.textContent = displayName;

        // ç»„è£…å¤´åƒå®¹å™¨ (åªæ”¾å¤´åƒï¼Œä¸æ”¾æ˜µç§°ï¼)
        avatarContainer.appendChild(avatar);
        // æ³¨æ„ï¼šnameDiv ä¸åº”è¯¥æ”¾åœ¨è¿™é‡Œï¼å®ƒåº”è¯¥æ”¾åœ¨ msgColumn é‡Œ


        if (message.sender === 'user' && currentOpenGroup.userAvatarPendant) { // å‡è®¾ä½ åœ¨ç¾¤æ•°æ®é‡Œå­˜äº†è¿™ä¸ª
            const pendant = document.createElement('div');
            pendant.className = 'avatar-pendant';
            pendant.style.backgroundImage = `url('${currentOpenGroup.userAvatarPendant}')`;
            avatarContainer.appendChild(pendant);
        }


        // --- B. åˆ›å»ºå†…å®¹å®¹å™¨ (Bubble) ---
        const msgColumn = document.createElement('div');
        msgColumn.className = 'msg-column';

        // --- C. åˆ›å»ºæ—¶é—´æˆ³ (ç§»è‡³æ°”æ³¡å†…éƒ¨) ---
        // (Deleted from here)

        // nameDiv å·²ç»åœ¨ä¸Šé¢åˆ›å»ºå¥½äº†ï¼Œä¸éœ€è¦é‡å¤è®¾ç½®

        // 2. åˆ›å»ºæ°”æ³¡å®¹å™¨ (Wrapper)
        const wrapper = document.createElement('div');
        wrapper.className = 'group-message-wrapper';
        // æ·»åŠ  user/ai ç±»åä¿æŒåŸæœ‰çš„æ°”æ³¡é¢œè‰²é€»è¾‘
        if (message.sender === 'user') wrapper.classList.add('user');
        else wrapper.classList.add('ai');

        // --- C. ç”Ÿæˆæ°”æ³¡å†…å®¹ (ä¿æŒä¸å˜) ---
        let contentElement = document.createElement('div');

        if (message.type === 'html' && message.content) {
            wrapper.classList.add('is-html-content');
            const iframe = document.createElement('iframe');
            iframe.className = 'html-render-container';
            iframe.srcdoc = message.content.html;
            contentElement = iframe;
        } else if ((message.type === 'sticker' || message.type === 'image') && message.url) {
            contentElement = document.createElement('img');
            // â–¼â–¼â–¼ è¡¨æƒ…åŒ…ä¸ä½¿ç”¨æ°”æ³¡ï¼Œå›¾ç‰‡ä¿ç•™æ°”æ³¡ â–¼â–¼â–¼
            if (message.type === 'sticker') {
                contentElement.className = 'sticker-bubble-plain'; // çº¯è¡¨æƒ…ï¼Œæ— æ°”æ³¡
            } else {
                const roleClass = message.sender === 'user' ? 'gp-user-bubble' : 'gp-ai-bubble';
                contentElement.className = `${roleClass} image-bubble`; // å›¾ç‰‡ä¿ç•™æ°”æ³¡
            }
            contentElement.src = message.url;
        } else if (message.type === 'voice_text') {
            const roleClass = message.sender === 'user' ? 'gp-user-bubble' : 'gp-ai-bubble';
            contentElement.className = `${roleClass} voice-text-bubble`; // ä¸ç”¨ chat-bubble
            contentElement.innerHTML = `<div class="voice-display-area"><div class="voice-duration">${message.duration || 0}s</div></div><div class="voice-transcript">${message.transcript}</div>`;
        } else {
            // â–¼â–¼â–¼â–¼â–¼â–¼ ç°ä»£åŒ–æ–‡æœ¬æ¸²æŸ“é€»è¾‘ â–¼â–¼â–¼â–¼â–¼â–¼
            const text = message.text || '';

            // 1. å®šä¹‰æ­£åˆ™ (ä¸å•èŠä¿æŒä¸€è‡´)
            const historyCardRegex = /\[CHAT_HISTORY_START\]([\s\S]*?)\[CHAT_HISTORY_END\]/;
            // â˜… æ–°çš„è½¬è´¦æ­£åˆ™
            const transferRegex = /(?:^|\n)\s*è½¬è´¦[:ï¼š]([\d.]+)-(.*)/;

            const historyMatch = text.match(historyCardRegex);
            const transferMatch = text.match(transferRegex);
            const isBilingual = text.includes('[Split]') && text.includes('\\');

            if (isBilingual) {
                 // --- D. åŒè¯­æŠ˜å æ°”æ³¡æ¸²æŸ“ ---
                 contentElement = document.createElement('div');
                 contentElement.style.display = 'flex';
                 contentElement.style.flexDirection = 'column';
                 contentElement.style.gap = '8px';
                 contentElement.style.alignItems = message.sender === 'user' ? 'flex-end' : 'flex-start';
                 
                 // æŒ‰åæ–œæ åˆ†å‰²å¤šä¸ªæ°”æ³¡
                 const segments = text.split('\\').filter(s => s.trim() !== '');
                 
                 segments.forEach(seg => {
                     const parts = seg.split('[Split]');
                     const bubble = document.createElement('div');
                     const roleClass = message.sender === 'user' ? 'gp-user-bubble' : 'gp-ai-bubble';
                     bubble.className = roleClass;
                     
                     if (parts.length >= 2) {
                         const origin = parts[0];
                         const trans = parts[1];
                         
                         // ç®€å•çš„æŠ˜å æ•ˆæœï¼šåªæ˜¾ç¤ºè¯‘æ–‡ï¼Œç‚¹å‡»æ˜¾ç¤ºåŸæ–‡ï¼Ÿæˆ–è€…éƒ½æ˜¾ç¤ºï¼Ÿ
                         // ç”¨æˆ·éœ€æ±‚æ˜¯"Collapsible Bubble" (æŠ˜å æ°”æ³¡)ã€‚
                         // å»ºè®®ï¼šé»˜è®¤æ˜¾ç¤ºè¯‘æ–‡å’ŒåŸæ–‡ï¼Œä¸­é—´åŠ çº¿ã€‚æˆ–è€…åŸæ–‡æŠ˜å ã€‚
                         // è¿™é‡Œé‡‡å–ï¼šä¸Šä¸‹å¹¶åˆ—æ˜¾ç¤ºï¼Œä¸­é—´åŠ åˆ†å‰²çº¿ï¼Œæ¸…æ™°æ˜äº†ã€‚
                         bubble.style.display = 'flex';
                         bubble.style.flexDirection = 'column';
                         
                         bubble.innerHTML = `
                            <div>${formatActionText(origin)}</div>
                            <div style="height:1px; background:currentColor; opacity:0.2; margin:6px 0 4px 0;"></div>
                            <div style="font-weight:500;">${formatActionText(trans)}</div>
                         `;
                     } else {
                         bubble.innerHTML = formatActionText(seg);
                     }
                     contentElement.appendChild(bubble);
                 });

            } else if (historyMatch) {
                // --- A. èŠå¤©è®°å½•å¡ç‰‡ ---
                const rawContent = historyMatch[1].trim();
                const lines = rawContent.split('\n').filter(line => line.trim() !== '');
                let title = "èŠå¤©è®°å½•";
                let contentLines = lines;

                if (lines.length > 0 && lines[0].startsWith("æ ‡é¢˜ï¼š")) {
                    title = lines[0].replace("æ ‡é¢˜ï¼š", "").trim();
                    contentLines = lines.slice(1);
                }

                contentElement = document.createElement('div');
                contentElement.className = 'history-card-bubble';
                // å­˜æ•°æ®ä¾›ç‚¹å‡»
                contentElement.dataset.historyTitle = title;
                contentElement.dataset.historyContent = JSON.stringify(contentLines);

                // æ ·å¼ (ä¿æŒä½ åŸæœ‰çš„ï¼Œæˆ–è€…ç”¨ css ç±»)
                contentElement.style.cssText = `background: white; border-radius: 12px; padding: 12px; width: 220px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; text-align: left;`;

                const previewHtml = contentLines.slice(0, 2).map(line =>
                    `<div style="font-size: 12px; color: #888; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${line}</div>`
                ).join('');

                contentElement.innerHTML = `
                    <div style="font-size: 15px; font-weight: 500; color: #000; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 6px;">${title}</div>
                    ${previewHtml}
                    <div style="margin-top: 8px; font-size: 10px; color: #ccc; border-top: 1px solid #f0f0f0; padding-top: 4px;">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                `;

            } else if (transferMatch) {
                // --- B. è½¬è´¦å¡ç‰‡ (æ¸²æŸ“æ–°æ ¼å¼) ---
                contentElement = document.createElement('div');
                
                const amount = transferMatch[1];
                const remark = transferMatch[2].trim();
                const isUserSender = (message.sender === 'user');
                
                // è¯»å–å¯èƒ½å­˜åœ¨çš„çŠ¶æ€
                const currentStatus = message.transferStatus || 'pending';

                contentElement.style.background = 'transparent'; 
                contentElement.style.padding = '0';
                
                // è°ƒç”¨å¡ç‰‡ç”Ÿæˆå‡½æ•°
                contentElement.innerHTML = createTransferCardHtml(
                    amount, 
                    remark, 
                    message.uuid || Date.now(), 
                    isUserSender, 
                    currentStatus
                );
            } else {
                // --- C. æ™®é€šæ–‡æœ¬ ---
                contentElement = document.createElement('div');
                // ä½¿ç”¨ç¾¤èŠä¸“ç”¨ç±»å
                const roleClass = message.sender === 'user' ? 'gp-user-bubble' : 'gp-ai-bubble';
                contentElement.className = roleClass;
                
                // æ¸²æŸ“æ–‡æœ¬ (å¤„ç† *åŠ¨ä½œ* å˜ç°)
                contentElement.innerHTML = formatActionText(text);
            }
            
        }
        
        if (message.replyTo) {
            const replyBlock = document.createElement('div');
            replyBlock.className = 'reply-quote-container';
            replyBlock.innerHTML = `
            <div class="reply-quote-name">${message.replyTo.senderName}</div>
            <div class="reply-quote-text">${message.replyTo.text}</div>
        `;

            // ç‚¹å‡»å¼•ç”¨å—è·³è½¬
            replyBlock.onclick = (e) => {
                e.stopPropagation();
                // æ³¨æ„ï¼šè¿™é‡Œç”¨ chatMessagesContainerï¼Œå› ä¸ºå®ƒæ˜¯å…¨å±€å˜é‡
                const target = document.getElementById('chat-messages-container').querySelector(`.message-row[data-uuid="${message.replyTo.uuid}"]`);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    target.classList.add('message-highlight');
                    setTimeout(() => target.classList.remove('message-highlight'), 1500);
                }
            };

            // æ’å…¥é€»è¾‘ï¼šå¦‚æœæ˜¯æ–‡æœ¬æ°”æ³¡ï¼Œæ’åœ¨é‡Œé¢ï¼›å¦‚æœæ˜¯å›¾ç‰‡/è¡¨æƒ…ï¼ŒåŒ…ä¸€å±‚å®¹å™¨
            if (contentElement.tagName === 'DIV' && !contentElement.classList.contains('image-bubble')) {
                contentElement.insertBefore(replyBlock, contentElement.firstChild);
            } else {
                // é’ˆå¯¹å›¾ç‰‡/è¡¨æƒ…åŒ…/HTMLå¡ç‰‡çš„ç‰¹æ®Šå¤„ç†
                const containerDiv = document.createElement('div');
                // ã€ä¸€åˆ€åˆ‡ã€‘ä½¿ç”¨ gp- ç±»å
                const roleClass = message.sender === 'user' ? 'gp-user-bubble' : 'gp-ai-bubble';
                containerDiv.className = roleClass;

                // ç§»é™¤åŸ contentElement çš„ bubble ç±»ï¼Œé˜²æ­¢æ ·å¼å†²çª
                contentElement.classList.remove('chat-bubble', 'user-bubble', 'ai-bubble', 'gp-user-bubble', 'gp-ai-bubble');
                contentElement.style.maxWidth = '100%';
                contentElement.style.borderRadius = '8px';

                containerDiv.appendChild(replyBlock);
                containerDiv.appendChild(contentElement);
                contentElement = containerDiv;
            }
        }

        // 3. ç»„è£…åˆ—å®¹å™¨
        // å…ˆæ”¾åå­—ï¼Œå†æ”¾æ°”æ³¡ wrapper
        wrapper.appendChild(contentElement);

        // --- C. åˆ›å»ºæ—¶é—´æˆ³ (ç§»è‡³æ°”æ³¡å†…éƒ¨åº•éƒ¨) ---
        if (currentOpenGroup && currentOpenGroup.timestampSettings && currentOpenGroup.timestampSettings.show && message.timestamp) {
            const date = new Date(message.timestamp);
            const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-timestamp';
            // æ ·å¼è°ƒæ•´ï¼šç¡®ä¿åœ¨æ°”æ³¡å†…åº•éƒ¨å³ä¸‹è§’æˆ–åº•éƒ¨
            timeDiv.style.cssText = "font-size: 10px; opacity: 0.6; text-align: right; margin-top: 4px; pointer-events: none;"; 
            timeDiv.textContent = timeStr;
            wrapper.appendChild(timeDiv);
        }
        msgColumn.appendChild(nameDiv); // åå­—åœ¨ä¸Šé¢
        msgColumn.appendChild(wrapper); // æ°”æ³¡åœ¨ä¸‹é¢

        // 4. ç»„è£…æ•´è¡Œ Row (æ ¹æ®å·¦å³å†³å®šé¡ºåº)
        if (message.sender === 'user') {
            // ç”¨æˆ·(å³è¾¹)ï¼šå…ˆæ”¾ å†…å®¹åˆ—ï¼Œå†æ”¾ å¤´åƒ
            row.appendChild(msgColumn);
            row.appendChild(avatarContainer);
        } else {
            // åˆ«äºº(å·¦è¾¹)ï¼šå…ˆæ”¾ å¤´åƒï¼Œå†æ”¾ å†…å®¹åˆ—
            row.appendChild(avatarContainer);
            row.appendChild(msgColumn);
        }

        row.appendChild(indicator);
        
        // ç«‹å³æ’å…¥DOMï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±
        if (profiler && profiler.isRecording) {
            profiler.startTimer('ğŸ“Œ æ’å…¥DOM');
        }
        targetContainer.appendChild(row);
        if (profiler && profiler.isRecording) {
            profiler.endTimer('ğŸ“Œ æ’å…¥DOM');
        }
        
        // ç«‹å³æ³¨å…¥æ ·å¼ï¼ˆå·²æœ‰ç¼“å­˜æœºåˆ¶ï¼Œæ€§èƒ½å½±å“ä¸å¤§ï¼‰
        if (profiler && profiler.isRecording) {
            profiler.startTimer('ğŸ¨ æ³¨å…¥æ ·å¼', { memberId });
        }
        injectMemberStyle(memberId);
        if (profiler && profiler.isRecording) {
            profiler.endTimer('ğŸ¨ æ³¨å…¥æ ·å¼');
        }
        
        // â–¼â–¼â–¼ã€æ€§èƒ½ä¼˜åŒ–ã€‘æ™ºèƒ½æ»šåŠ¨ï¼šåªåœ¨æœ€åä¸€æ¡æ¶ˆæ¯æ—¶æ»šåŠ¨ â–¼â–¼â–¼
        // é¿å…æ‰¹é‡åŠ è½½æ¶ˆæ¯æ—¶æ¯æ¡éƒ½è§¦å‘æ»šåŠ¨åŠ¨ç”»
        const scrollToBottom = () => {
            // æ£€æŸ¥æ˜¯å¦æ¥è¿‘åº•éƒ¨ï¼ˆè·ç¦»åº•éƒ¨<100pxï¼‰
            const isNearBottom = targetContainer.scrollHeight - targetContainer.scrollTop - targetContainer.clientHeight < 100;
            
            if (isNearBottom) {
                // ä½¿ç”¨instantè€Œä¸æ˜¯smoothï¼Œé¿å…åŠ¨ç”»ç´¯ç§¯
                targetContainer.scrollTop = targetContainer.scrollHeight;
            }
        };
        
        // ä½¿ç”¨ setTimeout å»¶è¿Ÿæ»šåŠ¨ï¼Œç»™DOMæ¸²æŸ“ç•™å‡ºæ—¶é—´
        // å¦‚æœçŸ­æ—¶é—´å†…æœ‰æ–°æ¶ˆæ¯ï¼Œä¼šå–æ¶ˆå‰ä¸€æ¬¡çš„æ»šåŠ¨
        if (window._groupScrollTimeout) {
            clearTimeout(window._groupScrollTimeout);
        }
        
        if (profiler && profiler.isRecording) {
            profiler.startTimer('ğŸ“œ æ»šåŠ¨åˆ°åº•éƒ¨');
        }
        
        window._groupScrollTimeout = setTimeout(() => {
            requestAnimationFrame(scrollToBottom);
            if (profiler && profiler.isRecording) {
                profiler.endTimer('ğŸ“œ æ»šåŠ¨åˆ°åº•éƒ¨');
            }
        }, 50); // 50msçš„é˜²æŠ–å»¶è¿Ÿ

        
        // â–¼â–¼â–¼ æ€§èƒ½ç›‘æ§ â–¼â–¼â–¼
        const perfEnd = performance.now();
        if (window.ChatPerformanceMonitor && window.ChatPerformanceMonitor.enabled) {
            window.ChatPerformanceMonitor.recordOperation('addGroupMessageToView', perfEnd - perfStart, {
                messageType: message.type,
                sender: message.sender
            });
        }
        
        if (profiler && profiler.isRecording) {
            profiler.endTimer('ğŸ¨ æ¸²æŸ“ç¾¤èŠæ¶ˆæ¯');
        }
        
        return row;
    }
    // ==========================================================
    // === ä¿®å¤ç‰ˆï¼šæ ¸å¼¹çº§éš”ç¦»æ ·å¼æ³¨å…¥ ===
    // ==========================================================
    // ==========================================================
    // === ä¿®å¤ç‰ˆï¼šæ ¸å¼¹çº§éš”ç¦»æ ·å¼æ³¨å…¥ (è§£å†³ startsWith æŠ¥é”™) ===
    // ==========================================================
    
    // ==========================================================
    // === æ€§èƒ½ä¼˜åŒ–ï¼šæ ·å¼ç”Ÿæˆä¸æ‰¹é‡æ³¨å…¥ ===
    // ==========================================================
    
    // ç”Ÿæˆå•ä¸ªæˆå‘˜çš„CSSå†…å®¹ï¼ˆçº¯å‡½æ•°ï¼Œä¸æ“ä½œDOMï¼‰
    function getMemberStyleContent(memberId, mode, contextId) {
        const safeMemberId = String(memberId);
        let targetCss = "";
        
        // è¾…åŠ©ï¼šç”Ÿæˆé»˜è®¤CSS
        const generateDefaultCss = (bgColor, textColor, direction, selectorClass) => {
             const tailColorRule = direction === 'right'
                ? `border-left-color: ${bgColor}; border-right-color: transparent;`
                : `border-right-color: ${bgColor}; border-left-color: transparent;`;

            return `
            ${selectorClass} { 
                background-color: ${bgColor}; 
                color: ${textColor};
                border: none;
            }
            ${selectorClass}::before, ${selectorClass}::after {
                background: none;
                ${tailColorRule}
                border-top-color: transparent;
                border-bottom-color: transparent;
            }
        `;
        };

        if (mode === 'group') {
             const group = window.currentOpenGroup;
             if (group && group.memberStyles && group.memberStyles[memberId]) {
                 targetCss = group.memberStyles[memberId];
             } else {
                 if (safeMemberId === 'user-me' || safeMemberId.startsWith('user')) {
                     targetCss = generateDefaultCss('#000000', '#ffffff', 'right', '.gp-user-bubble');
                 } else {
                     targetCss = generateDefaultCss('#ffffff', '#000000', 'left', '.gp-ai-bubble');
                 }
             }
        } else {
             // å•èŠæš‚ä¸å¤„ç†ï¼Œç›´æ¥è¿”å›ç©ºï¼Œè®©åŸæ¥çš„é€»è¾‘æ¥ç®¡
             return null;
        }
        
        if (targetCss) {
             const scopePrefix = `[data-style-member-id="${safeMemberId}"]`;
             let scopedCss = targetCss;
             // æ›¿æ¢æ°”æ³¡ç±»
             scopedCss = scopedCss.replace(/(\.gp-user-bubble|\.gp-ai-bubble)/g, `${scopePrefix} $1`);
             // æ›¿æ¢æ˜µç§°ç±» (å¦‚æœå­˜åœ¨)
             scopedCss = scopedCss.replace(/(\.group-nickname)/g, `${scopePrefix} $1`);
             return scopedCss;
        }
        return "";
    }

    // æ‰¹é‡æ³¨å…¥ç¾¤æˆå‘˜æ ·å¼ (ä¸€æ¬¡æ€§æ“ä½œDOM)
    window.batchInjectGroupStyles = function(groupId, members) {
        if (!groupId) return;
        
        // æ€§èƒ½ç›‘æ§
        const perfStart = performance.now();
        if (window.profiler && window.profiler.isRecording) {
            window.profiler.startTimer('ğŸ¨ æ‰¹é‡æ³¨å…¥æ ·å¼');
        }

        const styleId = `group-style-batch-${groupId}`;
        let cssContent = '';
        const handledMembers = new Set();
        
        // 1. å¤„ç†è‡ªå·±çš„æ ·å¼
        const myCss = getMemberStyleContent('user-me', 'group', groupId);
        if (myCss) {
             cssContent += myCss;
             handledMembers.add('user-me');
        }
        
        // 2. å¤„ç†æ‰€æœ‰æˆå‘˜
        if (members && Array.isArray(members)) {
            members.forEach(mId => {
                const sId = String(mId);
                if (!handledMembers.has(sId)) {
                    const mCss = getMemberStyleContent(sId, 'group', groupId);
                    if (mCss) {
                        cssContent += mCss;
                        handledMembers.add(sId);
                    }
                }
            });
        }
        
        // 3. æ’å…¥DOM (è¿™æ˜¯å”¯ä¸€çš„DOMæ“ä½œï¼)
        let styleTag = document.getElementById(styleId);
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = styleId;
            document.head.appendChild(styleTag);
        }
        styleTag.textContent = cssContent;
        
        // 4. æ›´æ–°ç¼“å­˜ï¼Œé˜²æ­¢ injectMemberStyle é‡å¤æ“ä½œ
        if (!window.injectedStylesCache) window.injectedStylesCache = new Set();
        
        // æ ‡è®°æ‰€æœ‰å·²å¤„ç†çš„ID
        handledMembers.forEach(mId => {
             // ç”Ÿæˆ injectMemberStyle ä¼šæ£€æŸ¥çš„é‚£ä¸ªIDæ ¼å¼
             const legacyId = `style-group-${groupId}-${mId}`;
             window.injectedStylesCache.add(legacyId);
        });

        if (window.profiler && window.profiler.isRecording) {
            window.profiler.endTimer('ğŸ¨ æ‰¹é‡æ³¨å…¥æ ·å¼');
        }
    };

    // â–¼â–¼â–¼ã€æ€§èƒ½ä¼˜åŒ–ã€‘æ·»åŠ æ ·å¼æ³¨å…¥ç¼“å­˜ â–¼â–¼â–¼
    const injectedStylesCache = new Set();
    window.injectedStylesCache = injectedStylesCache; // æš´éœ²ç»™å…¨å±€
    
    async function injectMemberStyle(memberId) {
        // â–¼â–¼â–¼ æ€§èƒ½ç›‘æ§ â–¼â–¼â–¼
        const perfStart = performance.now();
        
        if (!memberId) return;

        // â–¼â–¼â–¼ ä¿®å¤æ ¸å¿ƒï¼šå¼ºåˆ¶è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢æ•°å­—IDæŠ¥é”™ â–¼â–¼â–¼
        const safeMemberId = String(memberId);
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const container = document.getElementById('chat-messages-container');
        const currentMode = container.dataset.contextMode;
        const currentContextId = container.dataset.contextId;

        if (!currentMode || !currentContextId) return;

        const styleTagId = `style-${currentMode}-${currentContextId}-${safeMemberId}`;
        
        // â–¼â–¼â–¼ã€æ€§èƒ½ä¼˜åŒ–ã€‘å¦‚æœå·²ç»æ³¨å…¥è¿‡è¿™ä¸ªæ ·å¼ï¼Œç›´æ¥è·³è¿‡ â–¼â–¼â–¼
        if (injectedStylesCache.has(styleTagId)) {
            // â–¼â–¼â–¼ æ€§èƒ½ç›‘æ§ - ç¼“å­˜å‘½ä¸­ â–¼â–¼â–¼
            const perfEnd = performance.now();
            if (window.ChatPerformanceMonitor && window.ChatPerformanceMonitor.enabled) {
                window.ChatPerformanceMonitor.recordOperation('injectMemberStyle', perfEnd - perfStart, {
                    memberId: safeMemberId,
                    cached: true
                });
            }
            return;
        }

        let targetCss = "";

        // è¾…åŠ©å‡½æ•°
        const generateDefaultCss = (bgColor, textColor, direction, selectorClass) => {
            const tailColorRule = direction === 'right'
                ? `border-left-color: ${bgColor}; border-right-color: transparent;`
                : `border-right-color: ${bgColor}; border-left-color: transparent;`;

            return `
            ${selectorClass} { 
                background-color: ${bgColor}; 
                color: ${textColor};
                border: none;
            }
            ${selectorClass}::before, ${selectorClass}::after {
                background: none;
                ${tailColorRule}
                border-top-color: transparent;
                border-bottom-color: transparent;
            }
        `;
        };

        // åœºæ™¯ Aï¼šç¾¤èŠæ¨¡å¼
        if (currentMode === 'group') {
            // æ³¨æ„ï¼šè¿™é‡Œè¯»å–å¯¹è±¡å±æ€§æ—¶ï¼Œè¿˜æ˜¯ç”¨åŸå§‹çš„ memberId (å› ä¸ºå¯¹è±¡çš„keyå¯èƒ½æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²)
            if (currentOpenGroup && currentOpenGroup.memberStyles && currentOpenGroup.memberStyles[memberId]) {
                targetCss = currentOpenGroup.memberStyles[memberId];
            } else {
                // â–¼â–¼â–¼ ä¿®å¤æ ¸å¿ƒï¼šä½¿ç”¨ safeMemberId è¿›è¡Œå­—ç¬¦ä¸²åˆ¤æ–­ï¼Œå¹¶ä½¿ç”¨æ­£ç¡®çš„ç±»å â–¼â–¼â–¼
                if (safeMemberId === 'user-me' || safeMemberId.startsWith('user')) {
                    targetCss = generateDefaultCss('#000000', '#ffffff', 'right', '.gp-user-bubble'); // é»˜è®¤é»‘è‰²
                } else {
                    targetCss = generateDefaultCss('#ffffff', '#000000', 'left', '.gp-ai-bubble'); // é»˜è®¤ç™½è‰²
                }
            }
        }
        // åœºæ™¯ Bï¼šå•èŠæ¨¡å¼
        else if (currentMode === 'single') {
            if (safeMemberId === 'user-me') {
                if (currentOpenContact && currentOpenContact.selfBubbleCss) {
                    targetCss = currentOpenContact.selfBubbleCss;
                } else {
                    targetCss = generateDefaultCss('#95ec69', '#000000', 'right', '.chat-bubble');
                }
            } else {
                if (currentOpenContact && currentOpenContact.customBubbleCss) {
                    targetCss = currentOpenContact.customBubbleCss;
                } else {
                    targetCss = generateDefaultCss('#ffffff', '#000000', 'left', '.chat-bubble');
                }
            }
        }

        // ç”Ÿæˆç»å¯¹è·¯å¾„ CSS
        let styleTag = document.getElementById(styleTagId);

        if (targetCss) {
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = styleTagId;
                document.head.appendChild(styleTag);
            }

            const containerSelector = `#chat-messages-container[data-context-id="${currentContextId}"]`;
            // æ³¨æ„ï¼šè¿™é‡Œçš„ CSS é€‰æ‹©å™¨é‡Œä¹Ÿè¦ç”¨ safeMemberId
            const senderSelector = `.message-row[data-sender-id="${safeMemberId}"]`;


            // â–¼â–¼â–¼ã€æ ¸å¿ƒä¿®å¤ + æ€§èƒ½ä¼˜åŒ–ã€‘æ™ºèƒ½æ˜ å°„ç±»å â–¼â–¼â–¼
            // ç”¨æˆ·å¯èƒ½è¾“å…¥ .gp-bubbleã€.gp-user-bubbleã€.gp-ai-bubble ç­‰
            // æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬éƒ½æ­£ç¡®åœ°scopeåˆ°å½“å‰æˆå‘˜
            
            // ã€æ€§èƒ½ä¼˜åŒ–ã€‘ç¼“å­˜CSSè½¬æ¢ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
            const cssTransformKey = `${styleTagId}_${targetCss.substring(0, 50)}`; // ç”¨å‰50å­—ç¬¦ä½œä¸ºkey
            
            let scopedCss;
            if (!window._cssTransformCache) {
                window._cssTransformCache = new Map();
            }
            
            if (window._cssTransformCache.has(cssTransformKey)) {
                scopedCss = window._cssTransformCache.get(cssTransformKey);
            } else {
                // å†³å®šå½“å‰æˆå‘˜åº”è¯¥ç”¨å“ªä¸ªè§’è‰²ç±»å
                const specificRoleClass = (safeMemberId === 'user-me' || safeMemberId.startsWith('user'))
                    ? '.gp-user-bubble'
                    : '.gp-ai-bubble';

                // ã€æ€§èƒ½ä¼˜åŒ–ã€‘ä½¿ç”¨æ›´é«˜æ•ˆçš„æ­£åˆ™å’Œå‡å°‘å›è°ƒæ‰§è¡Œæ¬¡æ•°
                scopedCss = targetCss.replace(
                    /(\.gp-[\w-]+|\.chat-bubble|\.user-bubble|\.ai-bubble)([\w-:]*)/g,
                    (match, className, suffix) => {
                        let finalClassName = className === '.gp-bubble' ? specificRoleClass : className;
                        return `${containerSelector} ${senderSelector} ${finalClassName}${suffix}`;
                    }
                );
                
                // ç¼“å­˜ç»“æœï¼ˆé™åˆ¶ç¼“å­˜å¤§å°ï¼‰
                if (window._cssTransformCache.size > 100) {
                    const firstKey = window._cssTransformCache.keys().next().value;
                    window._cssTransformCache.delete(firstKey);
                }
                window._cssTransformCache.set(cssTransformKey, scopedCss);
            }

            styleTag.innerHTML = scopedCss;
            
            // â–¼â–¼â–¼ã€æ€§èƒ½ä¼˜åŒ–ã€‘æ ‡è®°æ ·å¼å·²æ³¨å…¥ â–¼â–¼â–¼
            injectedStylesCache.add(styleTagId);
        } else {
            if (styleTag) {
                styleTag.remove();
                injectedStylesCache.delete(styleTagId);
            }
        }
        
        // â–¼â–¼â–¼ æ€§èƒ½ç›‘æ§ - ç¼“å­˜æœªå‘½ä¸­ â–¼â–¼â–¼
        const perfEnd = performance.now();
        if (window.ChatPerformanceMonitor && window.ChatPerformanceMonitor.enabled) {
            window.ChatPerformanceMonitor.recordOperation('injectMemberStyle', perfEnd - perfStart, {
                memberId: safeMemberId,
                cached: false
            });
        }
    }

    // â–¼â–¼â–¼ã€æ€§èƒ½ä¼˜åŒ–ã€‘æ¸…é™¤æ ·å¼ç¼“å­˜çš„è¾…åŠ©å‡½æ•° â–¼â–¼â–¼
    // åœ¨åˆ‡æ¢ç¾¤èŠæˆ–è”ç³»äººæ—¶è°ƒç”¨ï¼Œç¡®ä¿æ–°èŠå¤©èƒ½æ­£ç¡®åŠ è½½æ ·å¼
    function clearStyleCache() {
        injectedStylesCache.clear();
    }
    // å°†æ­¤å‡½æ•°æš´éœ²ç»™å…¨å±€ï¼Œæ–¹ä¾¿åœ¨åˆ‡æ¢èŠå¤©æ—¶è°ƒç”¨
    window.clearStyleCache = clearStyleCache;


    // ==========================================================
    // === å¤´åƒç‚¹å‡»äº‹ä»¶ ===
    // ==========================================================


    // ==========================================
    // === ç¾¤æˆå‘˜åˆ é™¤åŠŸèƒ½é€»è¾‘ ===
    // ==========================================

    // 1. è¿›å…¥åˆ é™¤æ¨¡å¼ï¼šç‚¹å‡»â€œæŸ¥çœ‹nåç¾¤æˆå‘˜â€æ–‡å­—
    groupMemberCount.addEventListener('click', (event) => {
        event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è¢«ä¸‹é¢çš„å…¨å±€ç‚¹å‡»äº‹ä»¶ç«‹å³å–æ¶ˆ

        // ç»™ç½‘æ ¼å®¹å™¨æ·»åŠ  classï¼ŒCSS ä¼šè‡ªåŠ¨æ˜¾ç¤ºçº¢è‰²æŒ‰é’®å¹¶å¼€å§‹æŠ–åŠ¨
        groupMembersGrid.classList.add('delete-mode');
    });

    // 2. æ‰§è¡Œåˆ é™¤ï¼šç‚¹å‡»çº¢è‰² X æŒ‰é’®
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå› ä¸ºæŒ‰é’®æ˜¯åŠ¨æ€ç”Ÿæˆçš„
    groupMembersGrid.addEventListener('click', async (event) => {
        if (event.target.classList.contains('member-delete-btn')) {
            event.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¦å‘ç¼–è¾‘å¼¹çª—

            const memberIdToDelete = parseInt(event.target.dataset.memberId, 10);

            if (confirm("ç¡®å®šè¦å°†è¿™ä½æˆå‘˜ç§»å‡ºç¾¤èŠå—ï¼Ÿ")) {
                try {
                    // 1. ä»å½“å‰ç¾¤å¯¹è±¡çš„ members æ•°ç»„ä¸­ç§»é™¤
                    currentOpenGroup.members = currentOpenGroup.members.filter(id => id !== memberIdToDelete);

                    // 2. æ›´æ–°æ•°æ®åº“
                    const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                    let allGroups = groupsData.value;
                    const index = allGroups.findIndex(g => g.id === currentOpenGroup.id);

                    if (index > -1) {
                        allGroups[index] = currentOpenGroup;
                        await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                    }

                    // 3. é‡æ–°æ¸²æŸ“ (ä¿æŒåˆ é™¤æ¨¡å¼è¿˜æ˜¯é€€å‡ºï¼Ÿè¿™é‡Œé€‰æ‹©ä¿æŒï¼Œæ–¹ä¾¿è¿ç»­åˆ é™¤)
                    await renderGroupMembers();
                    // é‡æ–°æ¸²æŸ“å class ä¼šä¸¢å¤±ï¼Œéœ€è¦é‡æ–°åŠ ä¸Šï¼Œä¿æŒä½“éªŒè¿è´¯
                    groupMembersGrid.classList.add('delete-mode');

                } catch (e) {
                    console.error("åˆ é™¤ç¾¤æˆå‘˜å¤±è´¥", e);
                    alert("åˆ é™¤å¤±è´¥");
                }
            }
        }
    });

    // 3. é€€å‡ºåˆ é™¤æ¨¡å¼ï¼šç‚¹å‡»ç¾¤è®¾ç½®å¼¹çª—çš„ä»»æ„ç©ºç™½å¤„
    const groupInfoModalContent = groupInfoModal.querySelector('.modal-content');

    // æˆ‘ä»¬ç›‘å¬æ•´ä¸ªå¼¹çª—çš„ç‚¹å‡»
    groupInfoModal.addEventListener('click', (event) => {
        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¹Ÿä¸æ˜¯è§¦å‘æŒ‰é’®
        if (!event.target.closest('#group-member-count') && !event.target.closest('.member-delete-btn')) {
            groupMembersGrid.classList.remove('delete-mode');
        }
    });

    // === æ–°å¢ï¼šæ‰¹é‡åˆ é™¤æ­Œæ›²çš„æ ¸å¿ƒé€»è¾‘ ===
    async function handleBatchDeleteSongs() {
        // 1. è·å–æ‰€æœ‰è¢«å‹¾é€‰çš„æ­Œæ›²
        const selectedCheckboxes = songList.querySelectorAll('.song-checkbox:checked');

        if (selectedCheckboxes.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¦–è¦åˆ é™¤çš„æ­Œæ›²ã€‚');
            return;
        }

        if (!confirm(`ç¡®å®šè¦ä»æ­Œå•ä¸­ç§»é™¤è¿™ ${selectedCheckboxes.length} é¦–æ­Œæ›²å—ï¼Ÿ`)) {
            return;
        }

        // 2. æ”¶é›†è¦åˆ é™¤çš„æ­Œæ›²ID (æˆ‘ä»¬åœ¨ appendSongToList é‡ŒæŠŠ ID å­˜åˆ°äº† li çš„ data-song-id å±æ€§ä¸Š)
        const idsToDelete = new Set();
        selectedCheckboxes.forEach(cb => {
            const li = cb.closest('.song-item');
            if (li && li.dataset.songId) {
                idsToDelete.add(li.dataset.songId);
            }
        });

        try {
            // 3. ä»æ•°æ®åº“åŠ è½½æ•°æ®
            const allPlaylistsData = await dbHelper.loadData('musicPlaylists', 'allPlaylists');
            if (!allPlaylistsData || !allPlaylistsData.value || !allPlaylistsData.value[currentOpenPlaylist]) {
                throw new Error("æ— æ³•åŠ è½½å½“å‰æ­Œå•æ•°æ®");
            }

            let allPlaylists = allPlaylistsData.value;
            let currentSongs = allPlaylists[currentOpenPlaylist].songs;

            // 4. è¿‡æ»¤æ‰è¦åˆ é™¤çš„æ­Œæ›²
            // æˆ‘ä»¬éœ€è¦é‡æ–°æ„å»º songId è¿›è¡Œæ¯”å¯¹ï¼Œæˆ–è€…ä¾èµ–ä¹‹å‰å­˜å‚¨ç»“æ„çš„ä¸€è‡´æ€§
            const updatedSongs = currentSongs.filter(song => {
                // é‡å»º ID é€»è¾‘ (éœ€ä¸ appendSongToList ä¸­çš„ ID ç”Ÿæˆé€»è¾‘ä¿æŒä¸€è‡´)
                const songId = song.file ? `${song.file.name}-${song.file.lastModified}` : song.url;
                // å¦‚æœ ID åœ¨åˆ é™¤åˆ—è¡¨ä¸­ï¼Œåˆ™è¿‡æ»¤æ‰ (è¿”å› false)
                return !idsToDelete.has(songId);
            });

            // 5. æ›´æ–°æ•°æ®å¹¶ä¿å­˜
            allPlaylists[currentOpenPlaylist].songs = updatedSongs;
            await dbHelper.saveData('musicPlaylists', 'allPlaylists', allPlaylists);

            // 6. åˆ·æ–° UI
            alert('åˆ é™¤æˆåŠŸï¼');

            // é‡æ–°æ¸²æŸ“å½“å‰æ­Œå•è¯¦æƒ…
            await openPlaylistDetailView(currentOpenPlaylist);

            // æ ¸å¿ƒæ­¥éª¤ï¼šä¸»åŠ¨è§¦å‘ä¸€æ¬¡â€œå¤šé€‰æŒ‰é’®â€çš„ç‚¹å‡»ï¼Œä»¥é€€å‡ºåˆ é™¤æ¨¡å¼å¹¶æ¢å¤æŒ‰é’®çŠ¶æ€
            multiSelectBtn.click();

        } catch (error) {
            console.error("åˆ é™¤æ­Œæ›²å¤±è´¥:", error);
            alert("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
        }
    }

    // === çŠ¶æ€æ æ—¶é—´æ›´æ–°é€»è¾‘ ===
    function updateStatusBarClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        const sbTime = document.getElementById('status-bar-time');
        if (sbTime) {
            sbTime.textContent = timeString;
        }
    }

    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    updateStatusBarClock();
    // æ¯ç§’åˆ·æ–°ä¸€æ¬¡ (ä¸ºäº†å’Œç³»ç»Ÿæ—¶é—´åŒæ­¥)
    setInterval(updateStatusBarClock, 1000);

    aboutDeviceBtn.addEventListener('click', () => {
        // å¤ç”¨ show-settings çš„é€»è¾‘ï¼Œæˆ–è€…æ·»åŠ ä¸€ä¸ªæ–°çš„ class
        // è¿™é‡Œæˆ‘ä»¬ç®€å•ç‚¹ï¼Œç›´æ¥æ“ä½œæ ·å¼ï¼Œæˆ–è€…ä½ å¯ä»¥åœ¨CSSé‡ŒåŠ ä¸€ä¸ª .show-about-device
        // ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œå»ºè®®åŠ  class:
        phoneFrame.classList.add('show-about-device');
    });

    aboutDeviceBackBtn.addEventListener('click', () => {
        phoneFrame.classList.remove('show-about-device');
    });

    // --- å·¥å…·å‡½æ•°ï¼šéšè—é•¿æŒ‰èœå• ---
    function hideActionMenu() {
        msgActionMenu.style.display = 'none';
        currentLongPressTarget = null;
    }

    // --- å·¥å…·å‡½æ•°ï¼šå–æ¶ˆå›å¤ ---
    function cancelReplyMode() {
        currentReplyTarget = null;
        replyPreviewBar.style.display = 'none';
        // æ¢å¤è¾“å…¥æ¡†ä½ç½®ï¼ˆå¦‚æœæœ‰åŠ¨ç”»ï¼‰
    }

    /**
     * æ˜¾ç¤ºæ¶ˆæ¯æ“ä½œèœå•
     */
    /**
     * ã€ä¿®å¤ç‰ˆã€‘æ˜¾ç¤ºæ¶ˆæ¯æ“ä½œèœå• (ç»å¯¹å®šä½ï¼Œä¸å½±å“å¸ƒå±€)
     */
    /**
     * ã€æ™ºèƒ½é˜²æº¢å‡ºç‰ˆã€‘æ˜¾ç¤ºæ¶ˆæ¯æ“ä½œèœå•
     */
    function showMsgActionMenu(targetRow, event) {
        currentLongPressTarget = targetRow;

        // 1. æ‰¾åˆ°å…·ä½“çš„æ°”æ³¡å…ƒç´ 
        const bubble = targetRow.querySelector('.chat-bubble')
            || targetRow.querySelector('.gp-user-bubble')  // Group Chat User
            || targetRow.querySelector('.gp-ai-bubble')    // Group Chat AI
            || targetRow.querySelector('img.chat-bubble')
            || targetRow.querySelector('.text-image-card')
            || targetRow.querySelector('.voice-audio-bubble') // è®°å¾—åŠ ä¸Šè¯­éŸ³æ¡
            || targetRow.querySelector('.history-card-bubble');

        if (!bubble) return;

        // 2. ç¡®ä¿èœå•å…ˆæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿™æ ·æ‰èƒ½è·å–å®ƒçš„çœŸå®å®½åº¦å’Œé«˜åº¦
        msgActionMenu.style.display = 'flex';
        msgActionMenu.style.visibility = 'hidden'; // å…ˆä¸å¯è§ï¼Œç®—å¥½ä½ç½®å†æ˜¾ç¤º

        // 3. è·å–æ‰€æœ‰å°ºå¯¸ä¿¡æ¯
        const bubbleRect = bubble.getBoundingClientRect();
        const frameRect = phoneFrame.getBoundingClientRect();
        const menuRect = msgActionMenu.getBoundingClientRect();

        // 4. è®¡ç®—åˆå§‹ä½ç½® (ç›¸å¯¹äº phone-frame)
        // å‚ç›´ï¼šé»˜è®¤åœ¨æ°”æ³¡ä¸Šæ–¹ 10px
        let top = bubbleRect.top - frameRect.top - menuRect.height - 10;

        // æ°´å¹³ï¼šè®©èœå•ä¸­å¿ƒå¯¹é½æ°”æ³¡ä¸­å¿ƒ
        let left = (bubbleRect.left - frameRect.left) + (bubbleRect.width / 2) - (menuRect.width / 2);

        // 5. === æ™ºèƒ½é˜²æº¢å‡ºé€»è¾‘ ===

        // A. é¡¶éƒ¨æº¢å‡ºæ£€æµ‹ï¼šå¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿ (æ¯”å¦‚å°äºé¡¶æ é«˜åº¦ 60px)
        // å°±æŠŠèœå•æ”¹åˆ°æ°”æ³¡ä¸‹æ–¹
        if (top < 60) {
            top = bubbleRect.bottom - frameRect.top + 10;
            // (å¯é€‰) è¿™é‡Œå¯ä»¥ç»™èœå•åŠ ä¸ªç±»åï¼ŒæŠŠå°ä¸‰è§’å€’è¿‡æ¥ï¼Œæš‚æ—¶ä¸ºäº†ç®€å•å…ˆä¸åŠ 
        }

        // B. å·¦ä¾§æº¢å‡ºæ£€æµ‹ï¼šä¸èƒ½å°äº 10px (ç•™ç‚¹è¾¹è·)
        if (left < 10) {
            left = 10;
        }

        // C. å³ä¾§æº¢å‡ºæ£€æµ‹ï¼šä¸èƒ½è¶…å‡ºå±å¹•å®½åº¦
        const maxLeft = frameRect.width - menuRect.width - 10;
        if (left > maxLeft) {
            left = maxLeft;
        }

        // 6. åº”ç”¨æœ€ç»ˆä½ç½®å¹¶æ˜¾ç¤º
        msgActionMenu.style.top = `${top}px`;
        msgActionMenu.style.left = `${left}px`;
        msgActionMenu.style.visibility = 'visible'; // æ˜¾ç¤ºå‡ºæ¥

        // 7. éœ‡åŠ¨åé¦ˆ
        if (navigator.vibrate) navigator.vibrate(50);
    }


    // --- 2. æ‰“å¼€è½¬å‘å¼¹çª—å¹¶åŠ è½½åˆ—è¡¨ ---
    forwardMessagesBtn.addEventListener('click', async () => {
        // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ¶ˆæ¯
        const selectedRows = document.querySelectorAll('.message-row.selected');
        if (selectedRows.length === 0) {
            alert("è¯·å…ˆé€‰æ‹©è¦è½¬å‘çš„æ¶ˆæ¯");
            return;
        }

        forwardTargetList.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">åŠ è½½ä¸­...</p>';
        forwardTargetModal.style.display = 'flex';
        setTimeout(() => {
            forwardTargetModal.style.opacity = '1';
            forwardTargetModal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);

        // åŠ è½½ å•èŠ + ç¾¤èŠ æ•°æ®
        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');

            const contacts = (contactsData && Array.isArray(contactsData.value)) ? contactsData.value : [];
            const groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

            forwardTargetList.innerHTML = '';

            // A. æ¸²æŸ“ç¾¤èŠ
            if (groups.length > 0) {
                const groupHeader = document.createElement('div');
                groupHeader.textContent = "ç¾¤èŠ";
                groupHeader.style.cssText = "padding: 8px 15px; background: #f5f5f5; color: #888; font-size: 12px;";
                forwardTargetList.appendChild(groupHeader);

                groups.forEach(g => {
                    const item = document.createElement('div');
                    item.className = 'invite-contact-item'; // å¤ç”¨ç°æœ‰æ ·å¼
                    item.style.cursor = 'pointer';
                    item.onclick = () => executeForward(g.id, true); // true è¡¨ç¤ºæ˜¯ç¾¤èŠ
                    item.innerHTML = `
                    <img src="${g.avatar}" class="invite-contact-avatar">
                    <span class="invite-contact-name">${g.name}</span>
                `;
                    forwardTargetList.appendChild(item);
                });
            }

            // B. æ¸²æŸ“è”ç³»äºº
            if (contacts.length > 0) {
                const contactHeader = document.createElement('div');
                contactHeader.textContent = "è”ç³»äºº";
                contactHeader.style.cssText = "padding: 8px 15px; background: #f5f5f5; color: #888; font-size: 12px;";
                forwardTargetList.appendChild(contactHeader);

                contacts.forEach(c => {
                    const item = document.createElement('div');
                    item.className = 'invite-contact-item';
                    item.style.cursor = 'pointer';
                    item.onclick = () => executeForward(c.id, false); // false è¡¨ç¤ºæ˜¯å•èŠ
                    item.innerHTML = `
                    <img src="${c.ai.avatar}" class="invite-contact-avatar">
                    <span class="invite-contact-name">${c.ai.name}</span>
                `;
                    forwardTargetList.appendChild(item);
                });
            }

        } catch (e) {
            console.error("åŠ è½½è½¬å‘åˆ—è¡¨å¤±è´¥", e);
            forwardTargetList.innerHTML = '<p style="color:red; text-align:center;">åŠ è½½å¤±è´¥</p>';
        }
    });

    // å…³é—­å¼¹çª—é€»è¾‘
    function closeForwardModal() {
        // âœ… DOMæ¸…ç†: æ¸…ç©ºè½¬å‘ç›®æ ‡åˆ—è¡¨,é‡Šæ”¾å†…å­˜
        if (window.DOMCleanupManager) {
            window.DOMCleanupManager.clean('forward-target-list');
        }
        
        forwardTargetModal.style.opacity = '0';
        forwardTargetModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => { forwardTargetModal.style.display = 'none'; }, 300);
    }
    forwardModalCloseBtn.addEventListener('click', closeForwardModal);

    /**
     * æ‰§è¡Œè½¬å‘æ“ä½œ
     * @param {number} targetId - ç›®æ ‡ID (è”ç³»äººID æˆ– ç¾¤ç»„ID)
     * @param {boolean} isGroup - æ˜¯å¦ä¸ºç¾¤ç»„
     */
    // ==========================================================
    // === ä¿®å¤ç‰ˆï¼šæ‰§è¡Œè½¬å‘ (ç”Ÿæˆçº¯æ–‡æœ¬æ ¼å¼ï¼Œå…¼å®¹æ–°æ¸²æŸ“å™¨) ===
    // ==========================================================
    // ==========================================================
    // === ä¿®å¤ç‰ˆï¼šæ‰§è¡Œè½¬å‘ (ç”Ÿæˆçº¯æ–‡æœ¬æ ¼å¼ï¼Œè®©AIä¹Ÿèƒ½å­¦ä¼š) ===
    // ==========================================================
    async function executeForward(targetId, isGroupTarget) {
        const selectedRows = document.querySelectorAll('.message-row.selected');
        if (selectedRows.length === 0) {
            alert("è¯·å…ˆé€‰æ‹©è¦è½¬å‘çš„æ¶ˆæ¯");
            return;
        }

        // 1. å‡†å¤‡æ ‡é¢˜
        let chatTitle = "èŠå¤©è®°å½•";
        if (currentOpenGroup) chatTitle = currentOpenGroup.name + "çš„èŠå¤©è®°å½•";
        else if (currentOpenContact) chatTitle = `${currentOpenContact.user.name}ä¸${currentOpenContact.ai.name}çš„èŠå¤©`;

        // 2. æ‹¼æ¥çº¯æ–‡æœ¬å†…å®¹ (æ ¼å¼ï¼šåå­—ï¼šå†…å®¹)
        let historyTextContent = `æ ‡é¢˜ï¼š${chatTitle}\n`;

        selectedRows.forEach(row => {
            let senderName = "æœªçŸ¥";
            let content = "";

            // è·å–åå­— (å…¼å®¹ç¾¤èŠå•èŠ)
            const wrapper = row.querySelector('.message-content-wrapper') || row.querySelector('.group-message-wrapper');
            if (wrapper) {
                if (wrapper.classList.contains('user')) {
                    if (currentOpenGroup) senderName = currentOpenGroup.userCardName || "æˆ‘";
                    else if (currentOpenContact) senderName = currentOpenContact.user.name;
                } else {
                    const nameEl = row.querySelector('.group-nickname');
                    if (nameEl) senderName = nameEl.textContent;
                    else if (currentOpenContact) senderName = currentOpenContact.ai.name;
                    else senderName = "ç¾¤å‹";
                }
            }

            // è·å–å†…å®¹
            const bubble = row.querySelector('.chat-bubble');
            if (bubble) {
                if (bubble.classList.contains('image-bubble')) content = "[å›¾ç‰‡]";
                else if (bubble.classList.contains('sticker-bubble')) content = "[è¡¨æƒ…åŒ…]";
                else if (bubble.querySelector('.voice-transcript')) {
                    content = "[è¯­éŸ³]: " + bubble.querySelector('.voice-transcript').textContent.replace(/\n/g, ' ');
                }
                else if (bubble.classList.contains('history-card-bubble')) {
                    content = "[èŠå¤©è®°å½•å¡ç‰‡]";
                }
                else {
                    // æ™®é€šæ–‡æœ¬ï¼šç§»é™¤æ‰€æœ‰åŸæœ¬çš„æ ‡ç­¾ï¼Œåªä¿ç•™çº¯å­—
                    let rawText = bubble.textContent;
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç³»ç»Ÿæ ‡ç­¾
                    rawText = rawText.replace(/\[MESSAGE_START\]|\[MESSAGE_END\]/g, '');
                    // ç§»é™¤æ¢è¡Œç¬¦ï¼Œä¿è¯ä¸€è¡Œä¸€æ¡
                    content = rawText.replace(/(\r\n|\n|\r)/gm, " ").trim();
                }
            } else {
                content = "[å¤šåª’ä½“æ¶ˆæ¯]";
            }

            // æ‹¼æ¥åˆ°æ€»æ–‡æœ¬
            historyTextContent += `${senderName}ï¼š${content}\n`;
        });

        // 3. æ„é€ æœ€ç»ˆæ¶ˆæ¯ (ä½¿ç”¨ START/END åŒ…è£¹)
        const finalMessageText = `[CHAT_HISTORY_START]\n${historyTextContent}[CHAT_HISTORY_END]`;

        // 4. å‘é€
        try {
            const userMessage = {
                sender: 'user',
                text: finalMessageText,
                timestamp: new Date(),
                uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
            };

            if (isGroupTarget) {
                await saveGroupMessageToHistory(userMessage, targetId);
            } else {
                await saveMessageToHistory(userMessage, targetId);
            }

            alert("å·²å‘é€");
            closeForwardModal();
            exitMessageSelectionMode();

            // åˆ·æ–°ç•Œé¢
            if ((isGroupTarget && currentOpenGroup && currentOpenGroup.id === targetId) ||
                (!isGroupTarget && currentOpenContact && currentOpenContact.id === targetId)) {
                if (isGroupTarget) addGroupMessageToView(userMessage);
                else addMessageToView(userMessage);
                chatMessagesContainer.scrollTo({ top: chatMessagesContainer.scrollHeight, behavior: 'smooth' });
            }

        } catch (e) {
            console.error("è½¬å‘å¤±è´¥", e);
            alert("è½¬å‘å¤±è´¥");
        }
    }
    /**
     * æ˜¾ç¤ºèŠå¤©è®°å½•è¯¦æƒ… (å…¨é‡åŠ è½½ç‰ˆ)
     * @param {object} cardData - å¡ç‰‡é‡Œçš„è½»é‡æ•°æ® (å¿…é¡»åŒ…å« recordId)
     */
    /**
     * æ˜¾ç¤ºèŠå¤©è®°å½•è¯¦æƒ… (æ”¯æŒ æ•°æ®åº“è¯»å– + AIç›´æ¥ç”Ÿæˆ)
     */
    /**
     * æ˜¾ç¤ºèŠå¤©è®°å½•è¯¦æƒ… (ç¾åŒ–ç‰ˆ)
     * æ”¯æŒå·¦å³æ°”æ³¡å¸ƒå±€ï¼Œè‡ªåŠ¨è¯†åˆ«â€œæˆ‘â€
     */
    async function showChatHistoryDetail(cardData) {
        const overlay = document.getElementById('history-detail-overlay');
        const titleEl = document.getElementById('history-detail-title');
        const contentEl = document.getElementById('history-detail-content');

        // 1. è®¾ç½®æ ‡é¢˜ (é˜²æ­¢è¿‡é•¿)
        titleEl.textContent = cardData.title || "èŠå¤©è®°å½•";

        // 2. å‡†å¤‡æ•°æ®
        contentEl.innerHTML = '<p style="text-align:center; padding-top:20px; color:#888;">åŠ è½½ä¸­...</p>';

        // å¼ºåˆ¶åº”ç”¨èƒŒæ™¯è‰² (é˜²æ­¢è¢«å…¨å±€æ ·å¼è¦†ç›–)
        contentEl.style.backgroundColor = '#f5f5f7';

        // æ˜¾ç¤ºå¼¹çª—
        overlay.style.display = 'flex';
        setTimeout(() => overlay.style.opacity = '1', 10);

        let messagesToShow = [];

        // ... (æ•°æ®åŠ è½½é€»è¾‘ä¿æŒä¸å˜) ...
        if (cardData.recordId) {
            try {
                const recordData = await dbHelper.loadData('forwardedRecords', cardData.recordId);
                if (recordData && recordData.value && recordData.value.messages) {
                    messagesToShow = recordData.value.messages;
                } else {
                    messagesToShow = cardData.preview || [];
                }
            } catch (e) {
                messagesToShow = cardData.preview || [];
            }
        } else if (cardData.messages && Array.isArray(cardData.messages)) {
            messagesToShow = cardData.messages;
        } else {
            messagesToShow = cardData.preview || [];
        }

        // 3. è·å–å½“å‰çœŸå®ç”¨æˆ·çš„åå­— (ç”¨äºåˆ¤æ–­è°åœ¨å³è¾¹)
        let currentUserName = "";
        // æ— è®ºåœ¨å•èŠè¿˜æ˜¯ç¾¤èŠï¼Œæˆ‘ä»¬åªè®¤â€œå½“å‰ç™»å½•ç”¨æˆ·â€çš„åå­—
        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±é»˜è®¤ä¸ºç©ºï¼Œè¿™æ ·æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šæ˜¾ç¤ºåœ¨å·¦è¾¹ï¼ˆè¿™æ˜¯å®‰å…¨çš„ï¼‰
        if (currentOpenContact) {
            currentUserName = currentOpenContact.user.name;
        } else if (currentOpenGroup) {
            currentUserName = currentOpenGroup.userCardName || "æˆ‘";
        }

        // 4. æ¸²æŸ“åˆ—è¡¨
        contentEl.innerHTML = messagesToShow.map(item => {
            // --- æ ¸å¿ƒåˆ†è¾¹é€»è¾‘ ---
            // åªæœ‰å½“å‘è¨€äººåå­— === å½“å‰ç”¨æˆ·åï¼Œæˆ–è€…æ˜ç¡®å†™ç€â€œæˆ‘â€æ—¶ï¼Œæ‰æ”¾å³è¾¹
            // å…¶ä»–ä»»ä½•åå­—ï¼ˆåŒ…æ‹¬AIç¼–é€ çš„å°æ˜ã€å°çº¢ï¼‰éƒ½æ”¾å·¦è¾¹
            const isMe = (item.name === currentUserName) || (item.name === 'æˆ‘');

            const rowClass = isMe ? 'history-row right' : 'history-row left';

            // ç®€å•çš„æ—¶é—´æ˜¾ç¤º
            const timeStr = item.time ? ` <span style="opacity:0.6; margin-left:5px; font-size:10px;">${item.time}</span>` : '';

            // å¤„ç†æ¢è¡Œç¬¦
            const contentText = (item.content || '').replace(/\n/g, '<br>');

            return `
            <div class="${rowClass}">
                <div class="history-meta">
                    ${item.name}${timeStr}
                </div>
                <div class="history-bubble">
                    ${contentText}
                </div>
            </div>
        `;
        }).join('');

        // æ»šåˆ°é¡¶éƒ¨
        contentEl.scrollTop = 0;
    }

    /**
     * ä¸“é—¨ç”¨äºæ˜¾ç¤ºçº¯æ–‡æœ¬èŠå¤©è®°å½•çš„å¼¹çª—å‡½æ•° 
     */
    function showTextHistoryModal(title, linesArray) {
        const overlay = document.getElementById('history-detail-overlay');
        const titleEl = document.getElementById('history-detail-title');
        const contentEl = document.getElementById('history-detail-content');

        // 1. è®¾ç½®æ ‡é¢˜
        titleEl.textContent = title;

        // 2. ç¡®ä¿æ•°æ®æ˜¯æ•°ç»„ (é˜²æ­¢ä¼ å…¥å•è¡Œå­—ç¬¦ä¸²æŠ¥é”™)
        if (!Array.isArray(linesArray)) linesArray = [linesArray];

        // 3. ç”Ÿæˆ HTML å­—ç¬¦ä¸² (è¿™é‡Œåªè´Ÿè´£ç”Ÿæˆç»“æ„ï¼Œä¸åŒ…å«åŠ¨ç”»é€»è¾‘)
        const htmlContent = linesArray.map(line => {
            // å°è¯•è§£æ "åå­—ï¼šå†…å®¹" æ ¼å¼
            // æ­£åˆ™è§£é‡Šï¼šæ•è·å†’å·å‰çš„å†…å®¹ä½œä¸ºåå­—ï¼Œå†’å·åçš„ä½œä¸ºå†…å®¹
            const parts = line.match(/^(.*?)(:|ï¼š)(.*)/);

            let name = "ç³»ç»Ÿ";
            let content = line;

            if (parts) {
                name = parts[1].trim(); // æå–åå­—
                content = parts[3].trim(); // æå–å†…å®¹
            }

            // å¤„ç†æ¢è¡Œç¬¦ï¼Œé˜²æ­¢å†…å®¹æŒ¤åœ¨ä¸€èµ·
            content = content.replace(/\n/g, '<br>');

            // è¿”å›ä¸€æ®µå¹²å‡€çš„ HTML
            return `
            <div class="history-row">
                <div class="history-meta">${name}</div>
                <div class="history-bubble">${content}</div>
            </div>
        `;
        }).join('');

        // 4. å°†ç”Ÿæˆçš„ HTML å¡«å……åˆ°é¡µé¢ä¸­
        contentEl.innerHTML = htmlContent;

        // æ¯æ¬¡æ‰“å¼€æ—¶ï¼Œè®©æ»šåŠ¨æ¡å›åˆ°é¡¶éƒ¨
        contentEl.scrollTop = 0;

        // 5. æœ€åå¤„ç†æ˜¾ç¤ºåŠ¨ç”» (é€»è¾‘ä¸ HTML ç”Ÿæˆåˆ†ç¦»)
        overlay.style.display = 'flex';

        // ä½¿ç”¨å¾®å°å»¶æ—¶è§¦å‘ CSS opacity è¿‡æ¸¡
        setTimeout(() => {
            overlay.style.opacity = '1';
        }, 10);
    }


    // ä¸“é—¨ç”¨äºå…³é—­çº¯æ–‡æœ¬å†å²è®°å½•çš„å‡½æ•°
    function closeTextHistoryModal() {
        const overlay = document.getElementById('history-detail-overlay');
        // 1. å…ˆæ·¡å‡º
        overlay.style.opacity = '0';

        // 2. ç­‰åŠ¨ç”»ç»“æŸåï¼ˆ300msï¼‰ï¼Œå†éšè—å…ƒç´ 
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 300);
    }

    // ç»‘å®šäº‹ä»¶
    document.getElementById('history-detail-close-btn').addEventListener('click', closeTextHistoryModal);

    function openAnywhereDoor() {
        anywhereDoorInput.value = '';
        anywhereDoorModal.style.display = 'flex';
        setTimeout(() => {
            anywhereDoorModal.style.opacity = '1';
            anywhereDoorModal.querySelector('.modal-content').style.transform = 'scale(1)';
            anywhereDoorInput.focus();
        }, 10);
    }

    function closeAnywhereDoor() {
        anywhereDoorModal.style.opacity = '0';
        anywhereDoorModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            anywhereDoorModal.style.display = 'none';
        }, 300);
    }

    // ç»‘å®šäº‹ä»¶
    anywhereDoorBtn.addEventListener('click', () => {
        toggleFeaturesPanel(); // å…³é—­åº•éƒ¨é¢æ¿
        openAnywhereDoor();
    });
    anywhereDoorCloseBtn.addEventListener('click', closeAnywhereDoor);

    // å‘é€åŠ¨ä½œæ¶ˆæ¯
    sendActionMsgBtn.addEventListener('click', () => {
        const text = anywhereDoorInput.value.trim();
        if (!text) return;

        // æ„é€ æ¶ˆæ¯å¯¹è±¡ï¼Œç±»å‹ä¸º 'action'
        const actionMessage = {
            type: 'action',
            text: text // å†…å®¹å°±æ˜¯ç”¨æˆ·è¾“å…¥çš„åŠ¨ä½œæè¿°
        };

        sendMessage(actionMessage); // è°ƒç”¨ç»Ÿä¸€å‘é€å‡½æ•°
        closeAnywhereDoor();
    });
    /**
     * ä»æ–‡æœ¬ä¸­æå–è¡¨æƒ…åŒ…å®šä¹‰ï¼Œå¹¶æ³¨å†Œåˆ° stickerMap ä¸­
     * @param {string} text - å¯èƒ½åŒ…å« [å…³é”®è¯:URL] çš„æ–‡æœ¬
     * @returns {Array<string>} - è¿”å›æå–åˆ°çš„æ‰€æœ‰å…³é”®è¯åˆ—è¡¨
     */
    function extractAndRegisterStickers(text) {
        if (!text) return [];

        // æ­£åˆ™ï¼šåŒ¹é… [ä»»æ„æ–‡å­—:http...] æ ¼å¼
        // è§£é‡Šï¼š\[ åŒ¹é…å·¦ä¸­æ‹¬å·
        //       ([^:\]]+) æ•è·ç»„1ï¼šå…³é”®è¯ (ä¸åŒ…å«å†’å·å’Œå³ä¸­æ‹¬å·)
        //       : åŒ¹é…å†’å·
        //       (https?:\/\/[^\]]+) æ•è·ç»„2ï¼šURL (ä»¥httpå¼€å¤´ï¼Œç›´åˆ°å³ä¸­æ‹¬å·)
        //       \] åŒ¹é…å³ä¸­æ‹¬å·
        const regex = /\[([^:\]]+):(https?:\/\/[^\]]+)\]/g;

        const foundKeywords = [];
        let match;

        // å¾ªç¯æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…é¡¹
        while ((match = regex.exec(text)) !== null) {
            const keyword = match[1].trim();
            const url = match[2].trim();

            // 1. æ³¨å†Œåˆ°å…¨å±€ stickerMap ä¸­ï¼Œè¿™æ · executeGroupScript å°±èƒ½æŸ¥åˆ°äº†
            // æ³¨æ„ï¼šstickerMap æ˜¯æˆ‘ä»¬åœ¨å‰é¢å®šä¹‰çš„ const mapï¼Œå¯ä»¥ .set() æ–°å€¼
            stickerMap.set(keyword, url);

            // 2. æ”¶é›†å…³é”®è¯
            foundKeywords.push(keyword);
        }

        return foundKeywords;
    }
    // 2. ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    if (attachmentFileBtn) {
        attachmentFileBtn.addEventListener('click', () => {
            // å…³é—­åŠŸèƒ½é¢æ¿
            toggleFeaturesPanel();
            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            fileInput.click();
        });
    }

    // 3. ç›‘å¬æ–‡ä»¶é€‰æ‹©å˜åŒ–
    if (fileInput) {
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶å¤§å° (ä¾‹å¦‚é™åˆ¶ä¸º 20MB)
            if (file.size > 20 * 1024 * 1024) {
                alert("æ–‡ä»¶å¤ªå¤§å•¦ï¼Œè¯·å‘é€20MBä»¥å†…çš„æ–‡ä»¶ã€‚");
                return;
            }

            // å¤„ç†æ–‡ä»¶å‘é€
            await handleFileSend(file);

            // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸ªæ–‡ä»¶
            fileInput.value = '';
        });
    }

    /**
     * æ ¸å¿ƒå‡½æ•°ï¼šå¤„ç†æ–‡ä»¶å‘é€é€»è¾‘
     * @param {File} file - ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶å¯¹è±¡
     */
    async function handleFileSend(file) {
        // 1. è®¡ç®—æ–‡ä»¶å¤§å°å­—ç¬¦ä¸²
        const sizeString = formatFileSize(file.size);

        // 2. è·å–æ–‡ä»¶æ‰©å±•å (ç”¨äºå›¾æ ‡æ ·å¼)
        const fileName = file.name;
        const extension = fileName.split('.').pop().toLowerCase();

        // 3. è¯»å–æ–‡ä»¶å†…å®¹ (è½¬ä¸º Base64ï¼Œä»¥ä¾¿AIè¯»å–æˆ–å­˜å‚¨)
        // æ³¨æ„ï¼šè™½ç„¶æˆ‘ä»¬åªå±•ç¤ºå¡ç‰‡ï¼Œä½†ä¸ºäº†è®©"AIèƒ½è¯»å–"ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ•°æ®å¸¦ä¸Š
        // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ FileReader è¯»å– DataURL
        const reader = new FileReader();

        reader.onload = (e) => {
            const fileDataUrl = e.target.result;

            // 4. æ„å»ºæ¶ˆæ¯å¯¹è±¡
            // æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°çš„æ¶ˆæ¯ç±»å‹ 'file_card'
            const fileMessage = {
                type: 'file_card',
                fileName: fileName,
                fileSize: sizeString,
                fileType: extension,
                fileUrl: fileDataUrl, // å­˜å‚¨æ–‡ä»¶çš„ Base64 æ•°æ®

                // è¿™æ˜¯ä¸€ä¸ªç»™ AI çœ‹çš„æ–‡æœ¬æ‘˜è¦ï¼Œéå¸¸é‡è¦ï¼
                // å½“ translateMessageForAI è§£ææ—¶ï¼Œä¼šä¼˜å…ˆè¯»å–è¿™ä¸ª text
                text: `[æ–‡ä»¶å‘é€ï¼š${fileName} (${sizeString})]`
            };

            // 5. å‘é€æ¶ˆæ¯
            sendMessage(fileMessage);
        };

        reader.onerror = (e) => {
            console.error("æ–‡ä»¶è¯»å–å¤±è´¥", e);
            alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•");
        };

        // å¼€å§‹è¯»å–
        reader.readAsDataURL(file);
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
     */
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ–‡ä»¶å›¾æ ‡çš„ SVG (æ ¹æ®ç±»å‹)
     */
    function getFileIconSVG(type) {
        // ç®€å•çš„æ–‡å­—å›¾æ ‡ï¼ŒèƒŒæ™¯è‰²ç”± CSS æ§åˆ¶
        return `<span style="font-family: sans-serif;">${type.toUpperCase().substring(0, 4)}</span>`;
    }

    function renderFileCardHTML(message) {
        // ç¡®å®šæ ·å¼ç±»
        let typeClass = 'file-type-unknown';
        const ext = message.fileType || 'file';

        if (['doc', 'docx'].includes(ext)) typeClass = 'file-type-doc';
        else if (['pdf'].includes(ext)) typeClass = 'file-type-pdf';
        else if (['ppt', 'pptx'].includes(ext)) typeClass = 'file-type-ppt';

        // å¦‚æœæ˜¯æ¨¡æ‹Ÿæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å†…å®¹è¿›è¡Œç¼–ç ï¼Œé˜²æ­¢ HTML ç ´å
        // ä½¿ç”¨ encodeURIComponent å®‰å…¨åœ°å­˜å‚¨åœ¨ dataset ä¸­
        const dataContentAttr = message.isSimulated && message.fileContent
            ? `data-simulated-content="${encodeURIComponent(message.fileContent)}"`
            : '';

        const isSimulatedAttr = message.isSimulated ? 'data-is-simulated="true"' : '';

        // çœŸå®çš„ Url (å¦‚æœæœ‰)
        const dataUrlAttr = message.fileUrl ? `data-file-url="${message.fileUrl}"` : '';

        return `
        <div class="file-msg-card clickable-file-card" 
             data-filename="${message.fileName}" 
             ${dataUrlAttr} 
             ${isSimulatedAttr} 
             ${dataContentAttr}>
            <div class="file-card-icon ${typeClass}">
                ${getFileIconSVG(ext)}
            </div>
            <div class="file-card-info">
                <div class="file-card-name">${message.fileName}</div>
                <div class="file-card-size">${message.fileSize}</div>
            </div>
        </div>
    `;
    }


    /**
     * æ–°å¢ï¼šç‚¹å‡»å¡ç‰‡æ‰“å¼€/ä¸‹è½½æ–‡ä»¶
     * @param {string} fileName - æ–‡ä»¶å
     * @param {string} fileUrl - Base64 Data URL
     */
    function openFileFromCard(fileName, fileUrl) {
        if (!fileUrl) {
            alert("æ–‡ä»¶æ•°æ®ä¸¢å¤±ï¼Œæ— æ³•æ‰“å¼€ã€‚");
            return;
        }

        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ a æ ‡ç­¾æ¥è§¦å‘ä¸‹è½½/é¢„è§ˆ
        const link = document.createElement('a');
        link.href = fileUrl;
        link.download = fileName; // è®¾ç½®ä¸‹è½½æ–‡ä»¶å

        // å¯¹äºå›¾ç‰‡æˆ–PDFï¼Œå°è¯•åœ¨æ–°çª—å£æ‰“å¼€é¢„è§ˆ
        if (fileUrl.startsWith('data:image') || fileUrl.startsWith('data:application/pdf')) {
            // åˆ›å»ºä¸€ä¸ª Blob å¯¹è±¡ä»¥ä¾¿åœ¨æ–°çª—å£é¢„è§ˆ (æ¯”ç›´æ¥ç”¨ Base64 URL æ›´ç¨³å®š)
            fetch(fileUrl)
                .then(res => res.blob())
                .then(blob => {
                    const blobUrl = URL.createObjectURL(blob);
                    window.open(blobUrl, '_blank');
                })
                .catch(() => {
                    // å¦‚æœ Blob è½¬æ¢å¤±è´¥ï¼Œå›é€€åˆ°ç›´æ¥ä¸‹è½½
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        } else {
            // å…¶ä»–æ ¼å¼ï¼ˆdoc, pptç­‰ï¼‰ç›´æ¥è§¦å‘ä¸‹è½½
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    /**
     * æ‰“å¼€AIæ¨¡æ‹Ÿæ–‡ä»¶é˜…è¯»å™¨
     * @param {string} fileName - æ ‡é¢˜
     * @param {string} content - æ–‡æœ¬å†…å®¹
     */
    function openAiFileViewer(fileName, content) {
        const modal = document.getElementById('ai-file-viewer-modal');
        const titleEl = document.getElementById('ai-file-viewer-title');
        const contentEl = document.getElementById('ai-file-viewer-content');

        titleEl.textContent = fileName || 'æ–‡ä»¶é¢„è§ˆ';
        contentEl.textContent = content; // ä½¿ç”¨ textContent è‡ªåŠ¨å¤„ç†æ¢è¡Œï¼Œä¸”å®‰å…¨é˜²æ­¢XSS

        modal.style.display = 'flex';
        setTimeout(() => {
            modal.style.opacity = '1';
            modal.querySelector('.modal-content').style.transform = 'scale(1)';
        }, 10);
    }

    // ç»‘å®šå…³é—­æŒ‰é’®
    document.getElementById('ai-file-viewer-close-btn').addEventListener('click', () => {
        const modal = document.getElementById('ai-file-viewer-modal');
        modal.style.opacity = '0';
        modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    });
    // === ä¸ƒæµª APP äº¤äº’é€»è¾‘ ===

    // 1. æ‰“å¼€ä¸ƒæµª APP
    if (qilangAppIcon) {
        qilangAppIcon.addEventListener('click', () => {
            // å…ˆå…³é—­åº•éƒ¨çš„æŠ½å±‰ï¼ˆæ›´å¤šåº”ç”¨ï¼‰
            const bottomDrawer = document.getElementById('bottom-drawer');
            if (bottomDrawer) bottomDrawer.classList.remove('active');

            // æ‰“å¼€ä¸ƒæµªç•Œé¢
            phoneFrame.classList.add('show-qilang');

            // è¿™é‡Œåç»­å¯ä»¥åŠ åŠ è½½æ•°æ®çš„é€»è¾‘
            console.log("è¿›å…¥ä¸ƒæµªä¸–ç•Œ...");
            // ã€æ–°å¢ã€‘å°è¯•æ¸²æŸ“æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€æ³¢
            renderQilangFeed().then(() => {
                const grid = document.getElementById('qilang-waterfall-grid');
                if (grid.children.length === 0) {
                    generateQilangFeed(true); // é¦–æ¬¡è‡ªåŠ¨ç”Ÿæˆ
                }
            });
        });
    }

    // æ³¨æ„ï¼šä½ éœ€è¦å» CSS é‡Œè¡¥å…… .phone-frame.show-qilang çš„æ ·å¼
    // æˆ–è€…ä½¿ç”¨ä½ é€šç”¨çš„ openApp å‡½æ•°ï¼ˆæ¨èï¼‰ã€‚
    // å¦‚æœä½ ä¹‹å‰ç”¨äº† openApp(icon, screen) çš„é€šç”¨é€»è¾‘ï¼Œ
    // é‚£ä¹ˆåªéœ€è¦ç¡®ä¿ CSS é‡Œæœ‰å¯¹åº”çš„å±‚çº§æ§åˆ¶å³å¯ã€‚

    // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€æ®µ CSS æ§åˆ¶é€»è¾‘åˆ° style æ ‡ç­¾é‡Œï¼ˆçœ‹ä¸‹ä¸€æ­¥æç¤ºï¼‰

    // 2. ä¾§è¾¹æ æ§åˆ¶
    function toggleQilangSidebar() {
        qilangSidebar.classList.toggle('active');
        qilangOverlay.classList.toggle('active');
    }



    if (qilangOverlay) {
        qilangOverlay.addEventListener('click', toggleQilangSidebar);
    }

    // 3. ç®€å•çš„å¡ç‰‡ç‚¹å‡»åé¦ˆ (åç»­ä¼šæ”¹æˆè¿›å…¥è¯¦æƒ…é¡µ)
    const qilangGrid = document.getElementById('qilang-waterfall-grid');
    if (qilangGrid) {
        qilangGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.qilang-card');
            if (card) {
                console.log("ç‚¹å‡»äº†å¸–å­ï¼Œå‡†å¤‡è¿›å…¥è¯¦æƒ…é¡µ...");
                // ä¸‹ä¸€æ­¥æˆ‘ä»¬ä¼šåœ¨è¿™é‡Œå†™è¿›å…¥è¯¦æƒ…é¡µçš„é€»è¾‘
            }
        });
    }

    // === ä¸ƒæµª APP äº¤äº’é€»è¾‘ (ç¬¬äºŒéƒ¨åˆ†) ===

    // 1. è¯¦æƒ…é¡µå¯¼èˆª
    // ä¹‹å‰çš„ä»£ç é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç‚¹å‡»å¡ç‰‡çš„ç›‘å¬å™¨ï¼Œç°åœ¨è¡¥å……å®Œæ•´
    // è¯·æ‰¾åˆ°è¿™æ®µä»£ç : if (qilangGrid) { qilangGrid.addEventListener... }
    // æŠŠå®ƒé‡Œé¢çš„å†…å®¹æ›¿æ¢æˆï¼š


    // è¯¦æƒ…é¡µè¿”å›æŒ‰é’®
    if (qilangDetailBackBtn) {
        qilangDetailBackBtn.addEventListener('click', () => {
            document.getElementById('qilang-detail-view').classList.remove('active');

            // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šæ¸…ç©ºæ‰€æœ‰æœªæ‰§è¡Œçš„å®šæ—¶å™¨
            qilangTimeouts.forEach(id => clearTimeout(id));
            qilangTimeouts = []; // é‡ç½®æ•°ç»„

            currentDetailPostId = null; // æ¸…é™¤å½“å‰ID
        });
    }

    // 2. å‘å¸–å¼¹çª—æ§åˆ¶
    if (qilangPostBtn) {
        qilangPostBtn.addEventListener('click', () => {
            // æ‰“å¼€å¼¹çª—
            qilangPostModal.classList.add('active');
        });
    }

    if (qilangPostCancelBtn) {
        qilangPostCancelBtn.addEventListener('click', () => {
            // å…³é—­å¼¹çª—
            qilangPostModal.classList.remove('active');
            // æ¸…ç©ºè¾“å…¥æ¡† (å¯é€‰)
        });
    }


    /**
     * ä¸ƒæµªä¸“å±ï¼šåˆ›å»ºå¸–å­å¡ç‰‡ DOM (ç¾åŒ–ç‰ˆ)
     */
    /**
     * ä¸ƒæµªä¸“å±ï¼šåˆ›å»ºå¸–å­å¡ç‰‡ DOM (SVGå›¾æ ‡ç‰ˆ)
     */
    function createQilangCard(post) {
        const card = document.createElement('div');
        card.className = 'qilang-card';
        card.dataset.id = post.id;

        // éšæœºèƒŒæ™¯è‰²
        const colors = ['#5E5CE6', '#FF2D55', '#34C759', '#FF9500', '#007AFF'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        const avatarChar = post.author ? post.author.charAt(0) : 'æµª';

        // éšæœºå­—ä½“æƒé‡
        const fontWeights = ['400', '700', '900'];
        const randomWeight = fontWeights[Math.floor(Math.random() * fontWeights.length)];

        // æ•°å­—æ ¼å¼åŒ–
        const formatNum = (num) => num > 999 ? (num / 1000).toFixed(1) + 'k' : num;
        const commentCount = post.comments ? post.comments.length : 0;

        // å…œåº•æ˜¾ç¤º
        const displayTitle = post.title || post.content.substring(0, 15);

        // SVG å›¾æ ‡å®šä¹‰ (é¢œè‰²åŠ¨æ€åŒ–)
        const likeColor = post.isLiked ? '#FF2D55' : '#8e8e93';

        // ç‚¹èµå›¾æ ‡ (åŠ¨æ€å¡«å……é¢œè‰²)
        const likeSvg = `
    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 21.6496C11.69 21.6496 11.39 21.6096 11.14 21.5196C7.32 20.2096 1.25 15.5596 1.25 8.68961C1.25 5.18961 4.08 2.34961 7.56 2.34961C9.25 2.34961 10.83 3.00961 12 4.18961C13.17 3.00961 14.75 2.34961 16.44 2.34961C19.92 2.34961 22.75 5.19961 22.75 8.68961C22.75 15.5696 16.68 20.2096 12.86 21.5196C12.61 21.6096 12.31 21.6496 12 21.6496ZM7.56 3.84961C4.91 3.84961 2.75 6.01961 2.75 8.68961C2.75 15.5196 9.32 19.3196 11.63 20.1096C11.81 20.1696 12.2 20.1696 12.38 20.1096C14.68 19.3196 21.26 15.5296 21.26 8.68961C21.26 6.01961 19.1 3.84961 16.45 3.84961C14.93 3.84961 13.52 4.55961 12.61 5.78961C12.33 6.16961 11.69 6.16961 11.41 5.78961C10.48 4.54961 9.08 3.84961 7.56 3.84961Z" fill="${likeColor}"/>
    </svg>`;

        // è¯„è®ºå›¾æ ‡
        const commentSvg = `
    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.5 11.25H8.5C8.09 11.25 7.75 10.91 7.75 10.5C7.75 10.09 8.09 9.75 8.5 9.75H15.5C15.91 9.75 16.25 10.09 16.25 10.5C16.25 10.91 15.91 11.25 15.5 11.25Z" fill="#8e8e93"/>
        <path d="M16 22.3199C15.66 22.3199 15.32 22.22 15.03 22.03L10.77 19.1899H7C3.56 19.1899 1.25 16.8799 1.25 13.4399V7.43994C1.25 3.99994 3.56 1.68994 7 1.68994H17C20.44 1.68994 22.75 3.99994 22.75 7.43994V13.4399C22.75 16.6199 20.77 18.84 17.75 19.15V20.5699C17.75 21.2199 17.4 21.8099 16.83 22.1099C16.57 22.2499 16.28 22.3199 16 22.3199ZM7 3.17993C4.42 3.17993 2.75 4.84993 2.75 7.42993V13.4299C2.75 16.0099 4.42 17.6799 7 17.6799H11C11.15 17.6799 11.29 17.7199 11.42 17.8099L15.87 20.77C15.98 20.84 16.08 20.81 16.13 20.78C16.18 20.75 16.26 20.6899 16.26 20.5599V18.4299C16.26 18.0199 16.6 17.6799 17.01 17.6799C19.59 17.6799 21.26 16.0099 21.26 13.4299V7.42993C21.26 4.84993 19.59 3.17993 17.01 3.17993H7Z" fill="#8e8e93"/>
    </svg>`;

        card.innerHTML = `
        <div class="q-card-title" style="font-weight:${randomWeight};">
            ${displayTitle}
        </div>
        <div class="q-card-preview">
            ${post.content}
        </div>
        <div class="q-card-footer">
            <div style="display:flex; align-items:center;">
                <div class="q-avatar-placeholder" style="width:18px; height:18px; font-size:10px; line-height:18px; text-align:center; color:white; background-color:${randomColor}; margin-right:6px;">${avatarChar}</div>
                <span class="q-author" style="max-width: 45px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${post.author}</span>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
                <div style="display:flex; align-items:center; gap:2px;">
                    ${likeSvg}
                    <span style="font-size:9px; color:#8e8e93;">${formatNum(post.likes)}</span>
                </div>
                 <div style="display:flex; align-items:center; gap:2px;">
                    ${commentSvg}
                    <span style="font-size:9px; color:#8e8e93;">${commentCount}</span>
                </div>
            </div>
        </div>
    `;

        // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šè¿›å…¥è¯¦æƒ…é¡µ
        card.addEventListener('click', () => {
            openQilangDetail(post);
        });

        return card;
    }

    // === ä¸ƒæµª AI é€»è¾‘ ===

    /**
     * æ ¸å¿ƒå‡½æ•°ï¼šç”Ÿæˆè™šæ„çš„â€œä¸ƒæµªâ€å¸–å­
     * @param {boolean} isRefresh - æ˜¯å¦æ˜¯åˆ·æ–°æ“ä½œ (åˆ·æ–°ä¼šç”Ÿæˆæ›´å¤š)
     */
    async function generateQilangFeed(isRefresh = false) {
        const grid = document.getElementById('qilang-waterfall-grid');

        // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ä¸”å·²æœ‰å†…å®¹ï¼Œå°±ä¸é‡å¤ç”Ÿæˆ
        if (!isRefresh && grid.children.length > 0) return;

        if (isRefresh) {
            // å¦‚æœæ˜¯åˆ·æ–°ï¼Œç»™ç”¨æˆ·ä¸€ç‚¹åé¦ˆ
            const btn = document.getElementById('qilang-refresh-btn');
            btn.style.transform = 'rotate(360deg)';
            btn.style.transition = 'transform 1s';
            setTimeout(() => btn.style.transform = '', 1000);
        }

        // 1. æ„é€  Prompt
        const prompt = `
(ç³»ç»ŸæŒ‡ä»¤ï¼šä½ ç°åœ¨æ˜¯â€œä¸ƒæµªAPPâ€çš„å†…å®¹ç”Ÿæˆå¼•æ“ã€‚è¯·ç”Ÿæˆ 4 æ¡è™šæ„çš„ç¤¾äº¤åª’ä½“å¸–å­ã€‚
é£æ ¼è¦æ±‚ï¼š
1. **å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„æ ¼å¼**ï¼Œä¸¥ç¦åŒ…å« Markdown æ ‡è®°ï¼ˆå¦‚ \`\`\`jsonï¼‰ã€‚
2. æ¯æ¡å¸–å­åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
   - "title": å¤§å­—æ ‡é¢˜ï¼Œä¸è¶…è¿‡ 20 ä¸ªå­—ï¼Œè¦åœ¨è§†è§‰ä¸Šå¾ˆç‚¸è£‚ï¼ˆä¾‹å¦‚ï¼šéœ‡æƒŠï¼ã€å®¶äººä»¬è°æ‡‚å•Šï¼‰ã€‚
   - "content": æ­£æ–‡å†…å®¹ï¼Œå¯ä»¥ç¨é•¿ï¼Œå¸¦æœ‰ Hashtagï¼Œé£æ ¼å¯ä»¥æ˜¯èµ›åšæœ‹å…‹ã€èŒåœºåæ§½æˆ–å‘ç–¯æ–‡å­¦ã€‚
   - "author": å‘å¸–äººæ˜µç§°ï¼ˆå¸¦æœ‰äººè®¾æ„Ÿï¼Œå¦‚ï¼šä¸ƒä¸ƒå¸‚é¦–å¯Œã€æ‘¸é±¼ä¸€çº§é€‰æ‰‹ï¼‰ã€‚
   - "likes": ç‚¹èµæ•° (æ•°å­—)ã€‚
   - "comments": ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å« 8 æ¡è·¯äººè¯„è®ºã€‚æ¯æ¡è¯„è®ºè¦æœ‰ "user" (è·¯äººæ˜µç§°) å’Œ "text" (è¯„è®ºå†…å®¹ï¼Œè¦æœ‰é˜µè¥æ„Ÿï¼Œæ¯”å¦‚æ ç²¾æˆ–æ§å“)ã€‚

æ ¼å¼ç¤ºä¾‹ï¼š
[
  {
    "title": "å…¬å¸ç©ºè°ƒåäº†ï¼ğŸ”¥",
    "content": "ç°åœ¨çš„å®¤å†…æ¸©åº¦æ˜¯45åº¦ï¼Œæˆ‘çš„èº«ä½“éƒ½è¦çƒ­èåŒ–äº†ã€‚è€æ¿è¯´å¿ƒé™è‡ªç„¶å‡‰ï¼Ÿ #èŒåœº #é«˜æ¸©é¢„è­¦",
    "author": "èåŒ–çš„æ‰“å·¥äºº",
    "likes": 204,
    "comments": [
        {"user": "å·ç‹ä¹‹ç‹", "text": "è¿™ç‚¹è‹¦éƒ½åƒä¸äº†ï¼Ÿæˆ‘è¿˜åœ¨åŠ ç­å‘¢ã€‚"},
        {"user": "æ‘¸é±¼åŠä¸»ä»»", "text": "å¿«å»å•æ‰€ï¼Œé‚£è¾¹å‡‰å¿«ï¼"}
    ]
  }
]
)`;

        try {
            // 2. è°ƒç”¨ AI (ä½¿ç”¨ä½ ç°æœ‰çš„ fetchSimpleAiResponse ç®€åŒ–ç‰ˆï¼Œæˆ–è€… fetchAiCallResponse)
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å¤ç”¨ fetchSimpleAiResponseï¼Œå®ƒè¿”å›çº¯æ–‡æœ¬ï¼Œæˆ‘ä»¬éœ€è¦è§£æ JSON
            // æ³¨æ„ï¼šä½ éœ€è¦ç¡®ä¿ fetchSimpleAiResponse å·²ç»å®šä¹‰åœ¨ä½ çš„ä»£ç é‡Œäº†
            const aiResponse = await fetchSimpleAiResponse(prompt);

            if (!aiResponse) return;

            // 3. æ¸…ç†å¹¶è§£æ JSON
            // æœ‰æ—¶å€™ AI ä¼šåŠ  ```json ... ```ï¼Œæˆ‘ä»¬éœ€è¦å»æ‰
            const cleanJson = aiResponse.replace(/```json|```/g, '').trim();
            const posts = JSON.parse(cleanJson);

            // 4. ä¿å­˜åˆ°æ•°æ®åº“å¹¶æ¸²æŸ“
            const dbPostsData = await dbHelper.loadData('qilangPosts', 'allPosts');
            let allPosts = (dbPostsData && Array.isArray(dbPostsData.value)) ? dbPostsData.value : [];

            // å°†æ–°å¸–å­åŠ åˆ°å‰é¢
            const newPostsObjects = posts.map(p => ({
                id: Date.now() + Math.random(),
                title: p.title,      // <--- æ–°å¢ï¼šä¿å­˜æ ‡é¢˜
                content: p.content,  // ä¿å­˜æ­£æ–‡
                author: p.author,
                likes: p.likes,
                timestamp: new Date().toISOString(),
                // å¦‚æœ AI è¿”å›äº†è¯„è®ºï¼Œå°±ç”¨ AI çš„ï¼Œå¦åˆ™ç»™ä¸ªç©ºæ•°ç»„
                comments: Array.isArray(p.comments) ? p.comments : []
            }));

            allPosts = [...newPostsObjects, ...allPosts];
            await dbHelper.saveData('qilangPosts', 'allPosts', allPosts);

            // 5. é‡æ–°æ¸²æŸ“
            renderQilangFeed(allPosts);

        } catch (e) {
            console.error("ä¸ƒæµªç”Ÿæˆå¤±è´¥:", e);
            // å¦‚æœå¤±è´¥ï¼Œå¯ä»¥ä¸åšå¤„ç†ï¼Œæˆ–è€…æ˜¾ç¤ºä¸€ä¸ªé™æ€çš„é”™è¯¯æç¤º
        }
    }

    /**
     * æ¸²æŸ“ç€‘å¸ƒæµ
     */
    async function renderQilangFeed(posts = null) {
        const grid = document.getElementById('qilang-waterfall-grid');
        grid.innerHTML = '';

        let dataToRender = posts;
        if (!dataToRender) {
            const dbData = await dbHelper.loadData('qilangPosts', 'allPosts');
            dataToRender = (dbData && Array.isArray(dbData.value)) ? dbData.value : [];
        }

        // --- ã€æ ¸å¿ƒä¿®å¤ã€‘æ·»åŠ æ’åºé€»è¾‘ ---
        // æŒ‰ timestamp å€’åºæ’åˆ— (æ–°çš„åœ¨å‰é¢)
        // å¦‚æœæ²¡æœ‰ timestampï¼Œåˆ™æŒ‰ id (å‡è®¾idæ˜¯æ—¶é—´æˆ³ç”Ÿæˆçš„)
        dataToRender.sort((a, b) => {
            const timeA = new Date(a.timestamp || 0).getTime();
            const timeB = new Date(b.timestamp || 0).getTime();
            return timeB - timeA; // å¤§çš„ï¼ˆæ–°çš„ï¼‰æ’å‰é¢
        });
        // --- ä¿®å¤ç»“æŸ ---

        if (dataToRender.length === 0) {
            grid.innerHTML = '<p style="text-align:center; color:#999; padding:20px; width:100%;">æš‚æ—¶æ²¡æµªèµ·æ¥ï¼Œç‚¹å³ä¸Šè§’åˆ·æ–°è¯•è¯•</p>';
            return;
        }

        dataToRender.forEach(post => {
            const card = createQilangCard(post);
            grid.appendChild(card);
        });
    }

    // === ä¸ƒæµª è¯¦æƒ…é¡µé€»è¾‘ ===

    const qDetailBackBtn = document.getElementById('qilang-detail-back-btn');

    // æ‰“å¼€è¯¦æƒ…é¡µ
    // === ä¿®å¤ï¼šè¯¦æƒ…é¡µä¸è¯„è®ºæ¸²æŸ“ ===
    /**
     * ä¿®å¤ç‰ˆï¼šæ‰“å¼€ä¸ƒæµªè¯¦æƒ…é¡µå¹¶æ¸²æŸ“æ•°æ®
     */
    /**
     * ä¿®å¤ç‰ˆ v2ï¼šæ‰“å¼€ä¸ƒæµªè¯¦æƒ…é¡µå¹¶æ¸²æŸ“æ•°æ®
     */
    /**
     * ä¿®å¤ç‰ˆ v3ï¼šæ­£ç¡®æ¸²æŸ“å†…å®¹å’Œè¯„è®º
     */
    /**
     * ä¿®å¤ç‰ˆ v4ï¼šReddit é£æ ¼æ ‘çŠ¶æ¸²æŸ“ + é€’å½’é€»è¾‘
     */
    /**
     * ä¿®å¤ç‰ˆ v5ï¼šReddit é£æ ¼æ ‘çŠ¶å›¾ + å®‰å…¨å»¶è¿ŸåŠ¨ç”»
     */
    /**
     * ä¿®å¤ç‰ˆ v6ï¼šå¼ºåˆ¶ ID åŒæ­¥ + æ ‘çŠ¶æ¸²æŸ“
     */
    function openQilangDetail(post) {
        console.log("æ‰“å¼€å¸–å­:", post);
        currentDetailPostId = post.id;
        currentReplyToUser = null;
        currentReplyCommentId = null; // é‡ç½®å›å¤ID

        // 1. å¡«å……è¯¦æƒ…é¡µåŸºæœ¬ä¿¡æ¯
        document.getElementById('q-detail-title').textContent = post.title || post.content.substring(0, 15);
        document.getElementById('q-detail-content').textContent = post.content;
        document.getElementById('q-detail-author-name').textContent = '@' + (post.author || "åŒ¿åç”¨æˆ·");
        document.getElementById('q-detail-tags').textContent = extractTags(post.content || "");
        const cleanContent = (post.content || "").replace(/#\S+/g, '').trim();
        document.getElementById('q-detail-content').textContent = cleanContent;

        // 2. å‡†å¤‡è¯„è®ºåŒº
        const commentsList = document.getElementById('q-comments-list');
        const headerEl = document.querySelector('.q-comments-header');
        commentsList.innerHTML = '';

        const comments = post.comments || [];

        // === ã€æ ¸å¿ƒä¿®å¤ã€‘æ•°æ®æ¸…æ´—ï¼šé€’å½’ç¡®ä¿æ‰€æœ‰è¯„è®ºéƒ½æœ‰ String ç±»å‹çš„ ID ===
        function ensureIds(list) {
            list.forEach(c => {
                if (!c.id) c.id = `c-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                c.id = String(c.id); // å¼ºåˆ¶è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢ç±»å‹ä¸åŒ¹é…
                if (c.replies && c.replies.length > 0) {
                    ensureIds(c.replies);
                }
            });
        }
        ensureIds(comments); // æ‰§è¡Œæ¸…æ´—
        // ==========================================================

        // 3. æ¸²æŸ“è¯„è®º (æ‰å¹³åŒ–æ¸²æŸ“ï¼Œä¸å†é€’å½’)
        if (comments.length > 0) {
            // æ›´æ–°å¤´éƒ¨è®¡æ•°
            if (headerEl) headerEl.textContent = `è¯„è®ºåŒº (${comments.length})`;

            comments.forEach((comment, index) => {
                // 1. è¿™é‡Œè°ƒç”¨ä½ åˆšæ¬å®¶æˆåŠŸçš„å‡½æ•°
                // å¦‚æœç¬¬ä¸€æ­¥æ²¡åšå¯¹ï¼Œè¿™é‡Œè¿˜ä¼šæŠ¥ undefined
                const commentNode = createModernCommentNode(comment);

                // 2. æŠŠå®ƒå¡è¿›åˆ—è¡¨å®¹å™¨
                commentsList.appendChild(commentNode);

                // 3. åŠ ä¸ªå°åŠ¨ç”» (å¯é€‰)
                setTimeout(() => {
                    commentNode.classList.add('visible');
                }, 50 + (index * 50));
            });
        } else {
            headerEl.textContent = "è¯„è®ºåŒº";
            safeTimeout(() => {
                commentsList.innerHTML = '<div style="padding:40px; text-align:center; color:#ccc;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘</div>';
            }, 100);
        }

        // æ˜¾ç¤ºé¡µé¢
        document.getElementById('qilang-detail-view').classList.add('active');

        // é‡ç½®è¾“å…¥æ¡†çŠ¶æ€
        const inputEl = document.getElementById('q-detail-input');
        inputEl.value = '';
        inputEl.placeholder = "è¾“å…¥è¯„è®ºï¼ŒåŠ å…¥æˆ˜æ–—...";
    }

    /**
     * é€’å½’åˆ›å»ºè¯„è®ºèŠ‚ç‚¹ (ç”Ÿæˆæ ‘çŠ¶HTML)
     */
    /**
     * ç°ä»£åŒ–æ¸²æŸ“ï¼šåˆ›å»ºè¯„è®ºèŠ‚ç‚¹
     * é‡‡ç”¨æ‰å¹³åŒ–ç»“æ„ï¼šä¸»è¯„è®º + ç°è‰²å­è¯„è®ºå—
     */

    function createCommentNode(comment) {
        const node = document.createElement('div');
        // æ·»åŠ åŸºç¡€ç±»
        node.className = 'q-comment-item';
        // ç¡®ä¿æœ‰ID
        if (!comment.id) comment.id = `c-${Date.now()}`;

        // æ ¼å¼åŒ–æ—¶é—´ (ä¾‹å¦‚ï¼š10-24 12:00)
        const dateObj = new Date(comment.timestamp);
        const timeStr = `${dateObj.getMonth() + 1}-${dateObj.getDate()}`;

        // 1. æ„å»ºå­è¯„è®º HTML (ç°è‰²å—)
        let subCommentsHtml = '';
        if (comment.replies && comment.replies.length > 0) {
            const subItems = comment.replies.map(reply => {
                return `
                <div class="q-sub-item">
                    <span class="q-sub-user">${reply.authorName}:</span>
                    <span>${reply.text}</span>
                </div>
            `;
            }).join('');

            subCommentsHtml = `<div class="q-sub-comments-box">${subItems}</div>`;
        }

        // 2. æ„å»ºä¸»ç»“æ„
        node.innerHTML = `
        <div class="q-comment-avatar-img" style="background-image: url('${comment.authorAvatar}');"></div>
        
        <div class="q-comment-main">
            <div class="q-comment-header">
                <span class="q-comment-user">${comment.authorName}</span>
                </div>
            
            <div class="q-comment-text">${comment.text}</div>
            
            ${subCommentsHtml} <div class="q-comment-footer">
                <span>${timeStr}</span>
                <span class="q-reply-trigger" 
                      data-user="${comment.authorName}" 
                      data-comment-id="${comment.id}">
                      å›å¤
                </span>
            </div>
        </div>
    `;

        return node;
    }

    // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—æ€»è¯„è®ºæ•°ï¼ˆåŒ…å«åµŒå¥—çš„ï¼‰
    function countTotalComments(comments) {
        let count = 0;
        comments.forEach(c => {
            count++;
            if (c.replies) count += countTotalComments(c.replies);
        });
        return count;
    }

    // æå–è¯é¢˜æ ‡ç­¾çš„è¾…åŠ©å‡½æ•°
    function extractTags(text) {
        const match = text.match(/#\S+/g);
        return match ? match.join(' ') : '';
    }

    // ç»‘å®šè¿”å›æŒ‰é’®
    if (qDetailBackBtn) {
        qDetailBackBtn.addEventListener('click', () => {
            document.getElementById('qilang-detail-view').classList.remove('active');
        });
    }
    if (qilangRefreshBtn) {
        qilangRefreshBtn.addEventListener('click', () => {
            generateQilangFeed(true); // true è¡¨ç¤ºæ˜¯å¼ºåˆ¶åˆ·æ–°
        });
    }

    // 3. å®Œå–„â€œå‘å¸ƒâ€æŒ‰é’®é€»è¾‘
    const realPostConfirmBtn = document.getElementById('qilang-post-confirm-btn');
    if (realPostConfirmBtn) {
        // ç§»é™¤ä¹‹å‰çš„ alert æµ‹è¯•é€»è¾‘ï¼Œæ¢æˆçœŸçš„ä¿å­˜
        // æ³¨æ„ï¼šä¸ºäº†é¿å…é‡å¤ç»‘å®šï¼Œæœ€å¥½æŠŠä¹‹å‰çš„ addEventListener åˆ æ‰ï¼Œæˆ–è€…ç”¨ onclick è¦†ç›–
        realPostConfirmBtn.onclick = async () => {
            const titleInput = document.getElementById('qilang-post-title-input');
            const contentInput = document.getElementById('qilang-post-content-input');

            const text = contentInput.value.trim();
            const title = titleInput.value.trim(); // æš‚æ—¶æŠŠæ ‡é¢˜æ‹¼åˆ°å†…å®¹é‡Œï¼Œæˆ–è€…å­˜èµ·æ¥

            if (!text) { alert("å†™ç‚¹ä»€ä¹ˆå§ï¼"); return; }

            const newPost = {
                id: Date.now(),
                content: title ? `${title} ${text}` : text,
                author: 'æˆ‘', // æˆ–è€…æ˜¯å½“å‰ç”¨æˆ·è®¾ç½®çš„åå­—
                likes: 0,
                timestamp: new Date().toISOString(),
                comments: []
            };

            // ä¿å­˜
            const dbPostsData = await dbHelper.loadData('qilangPosts', 'allPosts');
            let allPosts = (dbPostsData && Array.isArray(dbPostsData.value)) ? dbPostsData.value : [];
            allPosts.unshift(newPost);
            await dbHelper.saveData('qilangPosts', 'allPosts', allPosts);

            // åˆ·æ–°
            renderQilangFeed(allPosts);

            // å…³é—­å¼¹çª—å¹¶æ¸…ç©º
            document.getElementById('qilang-post-modal').classList.remove('active');
            contentInput.value = '';
            titleInput.value = '';
        };
    }
    // === ä¸ƒæµª èœå•ä¸æ”¶è—é€»è¾‘ ===

    const qMenu = document.getElementById('qilang-action-menu');
    const qDetailOptionBtn = document.querySelector('#qilang-detail-view .header-actions button');

    // ç‚¹å‡»å³ä¸Šè§’ä¸‰ä¸ªç‚¹
    if (qDetailOptionBtn) {
        qDetailOptionBtn.addEventListener('click', async (e) => {
            e.stopPropagation();

            // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
            const postsData = await dbHelper.loadData('qilangPosts', 'allPosts');
            const allPosts = postsData.value || [];
            const post = allPosts.find(p => p.id === currentDetailPostId);

            const favText = document.getElementById('q-fav-text');
            const favIcon = document.querySelector('#q-action-fav svg');

            if (post && post.isFavorited) {
                favText.textContent = "å–æ¶ˆæ”¶è—";
                favIcon.style.fill = "#FF9500"; // å®å¿ƒé»„
                favIcon.style.stroke = "#FF9500";
            } else {
                favText.textContent = "æ”¶è—";
                favIcon.style.fill = "none";
                favIcon.style.stroke = "currentColor";
            }

            qMenu.style.display = (qMenu.style.display === 'block') ? 'none' : 'block';
        });
    }

    // ç‚¹å‡»å…¨å±€å…³é—­èœå•
    document.addEventListener('click', (e) => {
        if (qMenu && qMenu.style.display === 'block' && !qMenu.contains(e.target) && e.target !== qDetailOptionBtn) {
            qMenu.style.display = 'none';
        }
    });

    // ç‚¹å‡»æ”¶è—
    document.getElementById('q-action-fav').addEventListener('click', async () => {
        const postsData = await dbHelper.loadData('qilangPosts', 'allPosts');
        let allPosts = postsData.value || [];
        const postIndex = allPosts.findIndex(p => p.id === currentDetailPostId);

        if (postIndex > -1) {
            // åˆ‡æ¢çŠ¶æ€
            allPosts[postIndex].isFavorited = !allPosts[postIndex].isFavorited;
            await dbHelper.saveData('qilangPosts', 'allPosts', allPosts);

            const msg = allPosts[postIndex].isFavorited ? "å·²åŠ å…¥æ”¶è—å¤¹" : "å·²å–æ¶ˆæ”¶è—";
            alert(msg); // ç®€å•æç¤º

            // åˆ·æ–°åˆ—è¡¨ï¼ˆå¦‚æœå½“å‰åœ¨åˆ—è¡¨é¡µï¼‰
            renderQilangFeed(allPosts);
        }
        qMenu.style.display = 'none';
    });

    // ç‚¹å‡»åˆ é™¤
    document.getElementById('q-action-delete').addEventListener('click', async () => {
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼ŸAIå¯èƒ½ä¼šä¼¤å¿ƒçš„ã€‚")) {
            const postsData = await dbHelper.loadData('qilangPosts', 'allPosts');
            let allPosts = postsData.value || [];

            // è¿‡æ»¤æ‰å½“å‰å¸–å­
            allPosts = allPosts.filter(p => p.id !== currentDetailPostId);

            await dbHelper.saveData('qilangPosts', 'allPosts', allPosts);

            // åˆ·æ–°åˆ—è¡¨å¹¶é€€å‡º
            renderQilangFeed(allPosts);
            document.getElementById('qilang-detail-view').classList.remove('active');
            qMenu.style.display = 'none';
        }
    });
    // === ä¾§è¾¹æ å¯¼èˆª ===
    document.getElementById('qilang-menu-home').addEventListener('click', async () => {
        // é‡æ–°åŠ è½½æ‰€æœ‰å¸–å­
        const dbData = await dbHelper.loadData('qilangPosts', 'allPosts');
        const allPosts = dbData ? dbData.value : [];
        renderQilangFeed(allPosts);

        // å…³é—­ä¾§è¾¹æ 
        document.getElementById('qilang-sidebar').classList.remove('active');
        document.getElementById('qilang-sidebar-overlay').classList.remove('active');
        document.querySelector('.settings-header h1').textContent = "ä¸ƒæµª";
    });

    document.getElementById('qilang-menu-fav').addEventListener('click', async () => {
        // åªåŠ è½½æ”¶è—çš„å¸–å­
        const dbData = await dbHelper.loadData('qilangPosts', 'allPosts');
        const allPosts = dbData ? dbData.value : [];
        const favPosts = allPosts.filter(p => p.isFavorited);

        renderQilangFeed(favPosts); // å¤ç”¨æ¸²æŸ“å‡½æ•°

        // å…³é—­ä¾§è¾¹æ 
        document.getElementById('qilang-sidebar').classList.remove('active');
        document.getElementById('qilang-sidebar-overlay').classList.remove('active');
        document.querySelector('.settings-header h1').textContent = "æ”¶è—å¤¹";
    });

    // === è¯„è®ºåŒºäº‹ä»¶å§”æ‰˜ ===
    // è§£å†³ï¼šç‚¹å‡»æ¥¼ä¸­æ¥¼å†…éƒ¨æ–‡å­—æ— æ³•è§¦å‘å›å¤çš„é—®é¢˜
    // ==========================================================
    // === æœ€ç»ˆä¿®å¤ç‰ˆï¼šè¯„è®ºåŒºç‚¹å‡»äº‹ä»¶ (ç²¾å‡†å®šä½çˆ¶ID) ===
    // ==========================================================
    document.getElementById('q-comments-list').addEventListener('click', (e) => {

        // åœºæ™¯ Aï¼šç‚¹å‡»äº†ä¸»è¯„è®ºçš„â€œå›å¤â€æŒ‰é’®
        if (e.target.classList.contains('q-reply-trigger')) {
            const targetUser = e.target.dataset.user;
            const commentId = e.target.dataset.commentId;

            // è®°å½•çŠ¶æ€
            currentReplyToUser = targetUser;
            currentReplyCommentId = commentId; // ã€å…³é”®ã€‘é”å®šä¸»è¯„è®ºID

            // UI åé¦ˆ
            const inputEl = document.getElementById('q-detail-input');
            inputEl.placeholder = `å›å¤ ${targetUser}...`;
            inputEl.focus();
            return;
        }

        // åœºæ™¯ Bï¼šç‚¹å‡»äº†ç°è‰²å—é‡Œçš„å­è¯„è®º (æ¥¼ä¸­æ¥¼)
        // æˆ‘ä»¬å…è®¸ç”¨æˆ·ç‚¹å‡»ç°è‰²åŒºåŸŸçš„ä»»æ„ä½ç½®æ¥è§¦å‘å›å¤
        const subItem = e.target.closest('.q-sub-item');
        if (subItem) {
            // 1. å‘ä¸Šå¯»æ‰¾å®ƒæ‰€å±çš„ä¸»è¯„è®ºå¡ç‰‡ (q-comment-item)
            const mainCommentItem = subItem.closest('.q-comment-item');
            if (!mainCommentItem) return;

            // 2. ä»ä¸»è¯„è®ºå¡ç‰‡é‡Œï¼Œæ‰¾åˆ°é‚£ä¸ªâ€œå›å¤â€æŒ‰é’®ï¼Œè·å–å®ƒçš„ ID
            // (å› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»º HTML æ—¶ï¼ŒæŠŠä¸» ID å­˜å°±åœ¨äº† .q-reply-trigger ä¸Š)
            const mainReplyBtn = mainCommentItem.querySelector('.q-reply-trigger');
            if (!mainReplyBtn) return;

            const mainCommentId = mainReplyBtn.dataset.commentId;

            // 3. è·å–è¢«ç‚¹å‡»çš„å­ç”¨æˆ·çš„åå­— (ç”¨äºæ˜¾ç¤º @æŸæŸ)
            const subUserSpan = subItem.querySelector('.q-sub-user');
            // å»æ‰åå­—åé¢çš„å†’å·å’Œç©ºæ ¼
            const subUserName = subUserSpan.textContent.replace(/[:ï¼š\s]/g, '').trim();

            // 4. æ›´æ–°å…¨å±€çŠ¶æ€
            currentReplyToUser = subUserName;
            currentReplyCommentId = mainCommentId; // ã€å…³é”®ã€‘ID ä¾ç„¶æ˜¯ä¸»è¯„è®ºçš„ IDï¼Œè¿™æ ·æ•°æ®æ‰ä¼šå­˜åˆ°å®ƒçš„ replies æ•°ç»„é‡Œ

            // 5. UI åé¦ˆ
            const inputEl = document.getElementById('q-detail-input');
            inputEl.placeholder = `å›å¤ ${subUserName}...`;
            inputEl.focus();
        }
    });


    // === ä¿®å¤ç‰ˆï¼šå‘é€è¯„è®ºé€»è¾‘ (è‡ªåŠ¨å¤„ç†æ¥¼ä¸­æ¥¼æ ¼å¼) ===
    document.getElementById('q-detail-send-btn').addEventListener('click', async () => {
        const inputEl = document.getElementById('q-detail-input');
        let text = inputEl.value.trim();

        if (!text || !currentDetailPostId) return;

        // 1. è·å–å½“å‰èº«ä»½
        let myName = "æˆ‘";
        let myAvatar = "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me";

        if (currentQilangIdentity) {
            myName = currentQilangIdentity.ai ? currentQilangIdentity.ai.name : currentQilangIdentity.user.name;
            myAvatar = currentQilangIdentity.ai ? currentQilangIdentity.ai.avatar : currentQilangIdentity.user.avatar;
        } else if (currentOpenContact) {
            myName = currentOpenContact.user.name;
            myAvatar = currentOpenContact.user.avatar;
        }

        // --- ã€ä¿®å¤ç‚¹ã€‘å¦‚æœæ˜¯å›å¤æ¥¼ä¸­æ¥¼ï¼Œè‡ªåŠ¨åœ¨æ–‡æœ¬å‰åŠ  @åå­— ---
        if (currentReplyToUser && currentReplyCommentId) {
            // åªæœ‰å½“æ–‡æœ¬æ²¡åŒ…å« @åå­— æ—¶æ‰è‡ªåŠ¨åŠ ï¼Œé˜²æ­¢é‡å¤
            // é€»è¾‘ï¼šå¦‚æœæˆ‘æ˜¯å›å¤æŸä¸ªäººï¼Œä¸”è¿™ä¸ªäººä¸æ˜¯æ¥¼ä¸»(æˆ–è€…ä½ æƒ³ç»Ÿä¸€æ ¼å¼)ï¼Œå°±åŠ ä¸Šå‰ç¼€
            if (!text.startsWith(`å›å¤ ${currentReplyToUser}`)) {
                text = `å›å¤ ${currentReplyToUser}ï¼š${text}`;
            }
        }

        // 2. æ„å»ºè¯„è®ºå¯¹è±¡
        const newComment = {
            id: `c-${Date.now()}`,
            authorName: myName,
            authorAvatar: myAvatar,
            text: text,
            timestamp: new Date().toISOString(),
            replies: []
        };

        // 3. è¯»å–æ•°æ®åº“
        const postsData = await dbHelper.loadData('qilangPosts', 'allPosts');
        let allPosts = postsData.value;
        const postIndex = allPosts.findIndex(p => String(p.id) === String(currentDetailPostId));

        if (postIndex > -1) {
            const currentPost = allPosts[postIndex];

            // 4. æ·»åŠ è¯„è®º (ä½¿ç”¨æ–°çš„æ‰å¹³åŒ–å‡½æ•°)
            if (currentReplyCommentId) {
                // å°è¯•æ‰¾åˆ°çˆ¶çº§å¹¶æ·»åŠ 
                const success = findCommentAndAddReply(currentPost.comments, currentReplyCommentId, newComment);
                // å¦‚æœæ²¡æ‰¾åˆ° (æç½•è§)ï¼Œå…œåº•æ·»åŠ åˆ°é¡¶å±‚
                if (!success) {
                    if (!currentPost.comments) currentPost.comments = [];
                    currentPost.comments.push(newComment);
                }
            } else {
                // é¡¶å±‚è¯„è®º
                if (!currentPost.comments) currentPost.comments = [];
                currentPost.comments.push(newComment);
            }

            // 5. ä¿å­˜å¹¶åˆ·æ–°
            await dbHelper.saveData('qilangPosts', 'allPosts', allPosts);

            // é‡æ–°æ¸²æŸ“è¯„è®ºåŒº
            const commentsList = document.getElementById('q-comments-list');
            commentsList.innerHTML = '';
            currentPost.comments.forEach((c) => {
                const node = createModernCommentNode(c);
                commentsList.appendChild(node);
                setTimeout(() => node.classList.add('visible'), 10);
            });

            // 6. è§¦å‘ AI å›å¤
            // æ­¤æ—¶æˆ‘ä»¬ä¸ä»…ä¼ å†…å®¹ï¼Œè¿˜ä¼ â€œæˆ‘æ˜¯è°â€ï¼Œæ–¹ä¾¿AI @æˆ‘
            const targetPersona = currentReplyToUser || currentPost.author;
            // æ— è®ºå›å¤è°ï¼Œæˆ‘ä»¬ä¼ é€’çš„IDæœ€å¥½æ˜¯æ–°äº§ç”Ÿçš„è¿™ä¸ªIDï¼Œæˆ–è€…ä¿æŒä¸Šä¸‹æ–‡
            // ä½†ä¸ºäº†è®©AIèƒ½å›å¤è¿›æ¥¼ä¸­æ¥¼ï¼Œæˆ‘ä»¬ä¼  newComment.id

            if (typeof triggerQilangAiReply === 'function') {
                triggerQilangAiReply(targetPersona, text, currentPost.content, newComment.id, currentPost.id);
            }

            // 7. é‡ç½®çŠ¶æ€
            inputEl.value = '';
            inputEl.placeholder = "è¾“å…¥è¯„è®º...";
            currentReplyCommentId = null;
            currentReplyToUser = null;
        }
    });

    // === æ ¸å¿ƒè¾…åŠ©å‡½æ•°ï¼šé€’å½’æŸ¥æ‰¾å¹¶æ’å…¥ (è¯·ç¡®ä¿è¿™æ®µä»£ç ä¹Ÿåœ¨ä½ çš„JSé‡Œ) ===
    /**
     * ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½æ‰å¹³åŒ–æ·»åŠ è¯„è®º
     * é€»è¾‘ï¼šæ— è®ºå›å¤çš„æ˜¯å±‚ä¸»è¿˜æ˜¯æ¥¼ä¸­æ¥¼ï¼Œæ–°è¯„è®ºéƒ½ä½œä¸ºâ€œå­è¯„è®ºâ€æ·»åŠ åˆ°è¯¥å±‚ä¸»ä¸‹ã€‚
     * è§£å†³äº†â€œè¯„è®ºæ¶ˆå¤±â€å’Œâ€œå±‚çº§ä¹±çªœâ€çš„é—®é¢˜ã€‚
     */
    function findCommentAndAddReply(comments, targetId, newReply) {
        if (!comments || !Array.isArray(comments)) return false;

        // 1. éå†æ‰€æœ‰é¡¶å±‚è¯„è®ºï¼ˆå±‚ä¸»ï¼‰
        for (let comment of comments) {
            // æƒ…å†µ Aï¼šç›®æ ‡å°±æ˜¯è¿™ä¸ªé¡¶å±‚è¯„è®º (ç”¨æˆ·ç›´æ¥å›å¤å±‚ä¸»)
            if (String(comment.id) === String(targetId)) {
                if (!comment.replies) comment.replies = [];
                comment.replies.push(newReply);
                return true;
            }

            // æƒ…å†µ Bï¼šç›®æ ‡åœ¨è¿™ä¸ªé¡¶å±‚è¯„è®ºçš„å­è¯„è®ºåˆ—è¡¨é‡Œ (ç”¨æˆ·å›å¤äº†æ¥¼ä¸­æ¥¼)
            // æˆ‘ä»¬éå†å­è¯„è®ºçœ‹æ˜¯å¦å­˜åœ¨ targetId
            if (comment.replies && comment.replies.length > 0) {
                // æ£€æŸ¥å­è¯„è®ºé‡Œæœ‰æ²¡æœ‰æˆ‘ä»¬è¦å›å¤çš„ID
                const isTargetInSub = comment.replies.some(sub => String(sub.id) === String(targetId));

                if (isTargetInSub) {
                    // æ‰¾åˆ°äº†ï¼è™½ç„¶æ˜¯å›å¤å­è¯„è®ºï¼Œä½†æˆ‘ä»¬æŠŠæ–°æ•°æ® push åˆ°ã€è¿™ä¸€å±‚ã€‘çš„ replies é‡Œ
                    // è¿™æ ·å®ƒä»¬å°±æ˜¯å¹¶åˆ—æ˜¾ç¤ºçš„ï¼Œç¬¦åˆâ€œæ‰å¹³åŒ–â€è§†è§‰é£æ ¼
                    // æ­¤æ—¶ newReply.text åº”è¯¥å·²ç»åŒ…å«äº† "å›å¤ @æŸæŸï¼š"ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒé€»è¾‘æ··ä¹±
                    comment.replies.push(newReply);
                    return true;
                }
            }
        }
        return false; // æ²¡æ‰¾åˆ°
    }

    // === æ ¸å¿ƒè¾…åŠ©å‡½æ•°ï¼šé€’å½’æŸ¥æ‰¾å¹¶æ’å…¥å›å¤ ===
    // è¯·ç¡®ä¿è¿™ä¸ªå‡½æ•°åœ¨ä½ çš„ä»£ç ä¸­å­˜åœ¨ï¼Œå¦‚æœå·²å­˜åœ¨è¯·æ›¿æ¢ä¸ºè¿™ä¸ªå¼ºå£®ç‰ˆæœ¬
    /**
     * ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½æ‰å¹³åŒ–æ·»åŠ è¯„è®º
     * é€»è¾‘ï¼šæ— è®ºå›å¤çš„æ˜¯å±‚ä¸»è¿˜æ˜¯æ¥¼ä¸­æ¥¼ï¼Œæ–°è¯„è®ºéƒ½ä½œä¸ºâ€œå­è¯„è®ºâ€æ·»åŠ åˆ°è¯¥å±‚ä¸»ä¸‹ã€‚
     */
    function findCommentAndAddReply(comments, targetId, newReply) {
        if (!comments || !Array.isArray(comments)) return false;

        for (let comment of comments) {
            // æƒ…å†µ Aï¼šç›®æ ‡å°±æ˜¯è¿™ä¸ªé¡¶å±‚è¯„è®º (å›å¤å±‚ä¸»)
            if (String(comment.id) === String(targetId)) {
                if (!comment.replies) comment.replies = [];
                comment.replies.push(newReply);
                return true;
            }

            // æƒ…å†µ Bï¼šç›®æ ‡åœ¨è¿™ä¸ªé¡¶å±‚è¯„è®ºçš„å­è¯„è®ºåˆ—è¡¨é‡Œ (å›å¤æ¥¼ä¸­æ¥¼)
            // æˆ‘ä»¬éå†å­è¯„è®ºçœ‹æ˜¯å¦å­˜åœ¨ targetId
            if (comment.replies && comment.replies.length > 0) {
                // æ£€æŸ¥å­è¯„è®ºé‡Œæœ‰æ²¡æœ‰æˆ‘ä»¬è¦å›å¤çš„ID
                const isTargetInSub = comment.replies.some(sub => String(sub.id) === String(targetId));

                if (isTargetInSub) {
                    // æ‰¾åˆ°äº†ï¼è™½ç„¶æ˜¯å›å¤å­è¯„è®ºï¼Œä½†æˆ‘ä»¬æŠŠæ–°æ•°æ® push åˆ°ã€è¿™ä¸€å±‚ã€‘çš„ replies é‡Œ
                    // è¿™æ ·å®ƒä»¬å°±æ˜¯å¹¶åˆ—æ˜¾ç¤ºçš„ï¼Œç¬¦åˆâ€œæ‰å¹³åŒ–â€è§†è§‰é£æ ¼
                    comment.replies.push(newReply);
                    return true;
                }
            }
        }
        return false;
    }
    /**
     * è§¦å‘ä¸ƒæµª AI å›å¤
     */
    /**
     * è§¦å‘ä¸ƒæµª AI å›å¤ (ä¿®å¤ç‰ˆï¼šç¡®ä¿æ¥¼ä¸­æ¥¼)
     */
    // æ³¨æ„æœ€ååŠ äº†ä¸€ä¸ªé€—å·å’Œ contextPostId
    async function triggerQilangAiReply(targetName, userText, postContext, parentCommentId, contextPostId) {
        console.log(`AI æ­£åœ¨æ€è€ƒ... æ‰®æ¼”: ${targetName}, ç›®æ ‡çˆ¶ID: ${parentCommentId}`);

        const prompt = `(ç³»ç»ŸæŒ‡ä»¤ï¼šæ‰®æ¼” "${targetName}"ï¼Œåœ¨å¸–å­è¯„è®ºåŒºå›å¤ç”¨æˆ·ã€‚ç”¨æˆ·è¯´ï¼š"${userText}"ã€‚è¯·ç®€çŸ­å›æ€¼æˆ–äº’åŠ¨ï¼Œ30å­—ä»¥å†…ã€‚)`;

        const replyText = await fetchSimpleAiResponse(prompt);

        if (replyText) {
            safeTimeout(async () => {
                // 1. æ„å»º AI å›å¤å¯¹è±¡
                const aiComment = {
                    id: `ai-${Date.now()}`,
                    user: targetName,
                    text: replyText,
                    replies: []
                };

                // 2. è¯»å–å¹¶ä¿å­˜
                const postsData = await dbHelper.loadData('qilangPosts', 'allPosts');
                let allPosts = postsData.value;
                // ä½¿ç”¨ String æ¯”è¾ƒ ID
                const index = allPosts.findIndex(p => String(p.id) === String(currentDetailPostId));

                if (index > -1) {
                    const currentPost = allPosts[index];

                    // ã€æ ¸å¿ƒã€‘AI å›å¤ä¹Ÿæ˜¯æ¥¼ä¸­æ¥¼
                    // å®ƒå°è¯•æ‰¾åˆ° parentCommentId (ä½ åˆšæ‰å‘çš„è¯„è®ºID) å¹¶æŒ‚åœ¨ä¸‹é¢
                    const success = findCommentAndAddReply(currentPost.comments, parentCommentId, aiComment);

                    if (!success) {
                        console.warn("AIå›å¤æ‰¾ä¸åˆ°çˆ¶èŠ‚ç‚¹ï¼Œå›é€€åˆ°é¡¶å±‚");
                        currentPost.comments.push(aiComment);
                    }

                    await dbHelper.saveData('qilangPosts', 'allPosts', allPosts);

                    // 3. åªæœ‰å½“ç”¨æˆ·è¿˜åœç•™åœ¨å½“å‰å¸–å­æ—¶ï¼Œæ‰åˆ·æ–°ç•Œé¢
                    if (currentDetailPostId === currentPost.id) {
                        openQilangDetail(currentPost);
                    }
                }

            }, Math.random() * 1000 + 1000);
        }
    }
    /**
     * åŠ è½½ä¾§è¾¹æ èº«ä»½åˆ—è¡¨
     */
    async function loadQilangIdentities() {
        if (!qIdentityList) return;

        // ä»æ•°æ®åº“è·å–è”ç³»äºº
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        const contacts = (contactsData && Array.isArray(contactsData.value)) ? contactsData.value : [];

        // åŠ ä¸Šâ€œæˆ‘â€ (é»˜è®¤ç”¨æˆ·)
        const me = {
            id: 'user-me',
            ai: { name: 'æˆ‘', avatar: 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me' }
        };

        const allIdentities = [me, ...contacts];

        qIdentityList.innerHTML = '';

        allIdentities.forEach(contact => {
            const avatar = document.createElement('div');
            avatar.className = 'q-identity-avatar';
            avatar.style.backgroundImage = `url('${contact.ai.avatar}')`;
            avatar.title = contact.ai.name;

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            avatar.addEventListener('click', () => {
                // åˆ‡æ¢æ ·å¼
                document.querySelectorAll('.q-identity-avatar').forEach(el => el.classList.remove('active'));
                avatar.classList.add('active');

                // åˆ‡æ¢æ•°æ®
                currentQilangIdentity = contact;
                console.log("ä¸ƒæµªèº«ä»½åˆ‡æ¢ä¸º:", contact.ai.name);

                // å¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸ªè½»æç¤º
                // alert(`å·²åˆ‡æ¢èº«ä»½ï¼š${contact.ai.name}`);
            });

            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            if (!currentQilangIdentity && contact.id === 'user-me') {
                avatar.classList.add('active');
                currentQilangIdentity = contact;
            }

            qIdentityList.appendChild(avatar);
        });
    }

    // è®°å¾—åœ¨åˆå§‹åŒ–æˆ–æ‰“å¼€ä¾§è¾¹æ æ—¶è°ƒç”¨å®ƒ
    qilangMenuBtn.addEventListener('click', () => {
        loadQilangIdentities();
        toggleQilangSidebar();
    });

    /**
     * æ ¸å¿ƒç®—æ³•ï¼šé€’å½’æŸ¥æ‰¾çˆ¶è¯„è®ºå¹¶æ·»åŠ å­å›å¤
     * @param {Array} comments - å½“å‰å±‚çº§çš„è¯„è®ºæ•°ç»„
     * @param {string} targetId - ç›®æ ‡çš„çˆ¶è¯„è®ºID
     * @param {object} newReply - è¦æ·»åŠ çš„æ–°å›å¤å¯¹è±¡
     * @returns {boolean} - æ˜¯å¦æˆåŠŸæ‰¾åˆ°å¹¶æ·»åŠ 
     */
    /**
     * æ ¸å¿ƒç®—æ³•ï¼šé€’å½’æŸ¥æ‰¾çˆ¶è¯„è®ºå¹¶æ·»åŠ å­å›å¤ (å¢å¼ºç‰ˆ)
     */
    function findCommentAndAddReply(comments, targetId, newReply) {
        if (!comments || !Array.isArray(comments)) return false;

        for (let comment of comments) {
            // ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶è½¬æ¢ä¸º String è¿›è¡Œæ¯”å¯¹ï¼Œé¿å… "123" !== 123 çš„é—®é¢˜
            if (String(comment.id) === String(targetId)) {
                if (!comment.replies) {
                    comment.replies = [];
                }
                comment.replies.push(newReply);
                return true; // æ‰¾åˆ°äº†ï¼
            }

            // é€’å½’æŸ¥æ‰¾å­è¯„è®º
            if (comment.replies && comment.replies.length > 0) {
                const found = findCommentAndAddReply(comment.replies, targetId, newReply);
                if (found) return true; // åœ¨å­å­™é‡Œæ‰¾åˆ°äº†
            }
        }
        return false; // è¿™ä¸€å±‚æ²¡æ‰¾åˆ°
    }

    function safeTimeout(callback, delay) {
        const id = setTimeout(callback, delay);
        qilangTimeouts.push(id);
        return id;
    }
    /**
     * ã€æ–°å¢ã€‘ç°ä»£åŒ–è¯„è®ºèŠ‚ç‚¹æ¸²æŸ“å‡½æ•°
     * è§£å†³ï¼šReferenceError æŠ¥é”™ã€UIä¸‘é™‹ã€undefined é—®é¢˜
     */
    /**
     * ã€ä¿®å¤ç‰ˆã€‘ç°ä»£åŒ–è¯„è®ºèŠ‚ç‚¹æ¸²æŸ“å‡½æ•°
     * è§£å†³ï¼šReferenceError æŠ¥é”™ã€UIä¸‘é™‹ã€undefined é—®é¢˜
     */
    function createModernCommentNode(comment) {
        const node = document.createElement('div');
        node.className = 'q-comment-item'; // å¯¹åº” CSS æ ·å¼

        // 1. æ•°æ®å…œåº• (é˜²æ­¢ undefined)
        const name = comment.authorName || comment.user || "ç¥ç§˜äºº";
        // è‡ªåŠ¨ç”Ÿæˆå¤´åƒå…œåº•
        const avatar = comment.authorAvatar || `https://placehold.co/100x100/e5e5ea/ffffff?text=${name.charAt(0)}`;
        const text = comment.text || "";

        // æ—¶é—´æ ¼å¼åŒ–
        let timeStr = "åˆšåˆš";
        if (comment.timestamp) {
            const date = new Date(comment.timestamp);
            timeStr = `${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // 2. æ„å»ºå­è¯„è®º (ç°è‰²å—) HTML
        let subCommentsHtml = '';
        if (comment.replies && comment.replies.length > 0) {
            const subItems = comment.replies.map(reply => {
                // å­è¯„è®ºçš„æ•°æ®å…œåº•
                const rName = reply.authorName || reply.user || "ç¥ç§˜äºº";
                const rText = reply.text || "";
                // è¿™é‡Œç”Ÿæˆçš„ HTML ç»“æ„éå¸¸ç®€å•ï¼Œç‚¹å‡»å›å¤çš„é€»è¾‘ç”±çˆ¶çº§å§”æ‰˜å¤„ç†
                return `
                <div class="q-sub-item">
                    <span class="q-sub-user">${rName}:</span>
                    <span class="q-sub-text">${rText}</span>
                    <span class="q-sub-reply-btn" 
                          data-user="${rName}" 
                          data-root-id="${comment.id}">å›å¤</span>
                </div>
            `;
            }).join('');

            // åŒ…è£¹åœ¨ç°è‰²ç›’å­é‡Œ
            subCommentsHtml = `<div class="q-sub-comments-box">${subItems}</div>`;
        }

        // 3. ç»„è£…æœ€ç»ˆ HTML
        // æ³¨æ„ï¼šdata-comment-id å­˜çš„æ˜¯å½“å‰è¿™æ¡ä¸»è¯„è®ºçš„ID
        // ç‚¹å‡»å›å¤æŒ‰é’®æ—¶ï¼Œé»˜è®¤æ˜¯å›å¤å±‚ä¸»ã€‚å¦‚æœæƒ³å›å¤æ¥¼ä¸­æ¥¼ï¼Œé€»è¾‘ä¼šæ›´å¤æ‚ï¼Œ
        // è¿™é‡Œä¸ºäº†ç¨³å®šï¼Œæˆ‘ä»¬ç»Ÿä¸€è®©å›å¤æŒ‰é’®æŒ‡å‘å±‚ä¸»ã€‚
        node.innerHTML = `
        <img class="q-comment-avatar-img" src="${avatar}" onerror="this.src='https://placehold.co/100x100?text=?'">
        
        <div class="q-comment-main">
            <div class="q-comment-header">
                <span class="q-comment-user">${name}</span>
            </div>
            
            <div class="q-comment-text">${text}</div>
            
            ${subCommentsHtml} 
            
            <div class="q-comment-footer">
                <span class="q-time">${timeStr}</span>
                <span class="q-reply-trigger" 
                      data-user="${name}" 
                      data-comment-id="${comment.id}">
                      å›å¤
                </span>
            </div>
        </div>
    `;

        return node;
    }
    // === ä¿®å¤ï¼šä¾§æ äº¤äº’ä¸é€€å‡ºåŠŸèƒ½ ===

    // 1. ç¡®ä¿ä¾§æ å±‚çº§æœ€é«˜
    const sidebar = document.getElementById('qilang-sidebar');
    if (sidebar) sidebar.style.zIndex = "3000"; // æš´åŠ›æå‡å±‚çº§

    const sidebarOverlay = document.getElementById('qilang-sidebar-overlay');
    if (sidebarOverlay) sidebarOverlay.style.zIndex = "2999";

    // 2. ç»‘å®šé€€å‡ºæŒ‰é’®äº‹ä»¶
    const exitBtn = document.getElementById('qilang-menu-exit');
    if (exitBtn) {
        exitBtn.addEventListener('click', () => {
            // å…³é—­ä¾§æ 
            toggleQilangSidebar();
            // é€€å‡ºä¸ƒæµª App
            phoneFrame.classList.remove('show-qilang');
        });
    }
    /**
     * å°† CSS ä»£ç æ³¨å…¥åˆ°é¡µé¢ä¸­ä½¿å…¶ç”Ÿæ•ˆ
     */
    function applyGlobalCss(cssCode) {
        if (!globalUserStylesTag) return;
        globalUserStylesTag.innerHTML = cssCode || '';
        // å¦‚æœæœ‰è¾“å…¥æ¡†ï¼Œä¹ŸåŒæ­¥æ›´æ–°è¾“å…¥æ¡†çš„å€¼
        if (globalCssInput) globalCssInput.value = cssCode || '';
    }

    /**
     * é¡µé¢å¯åŠ¨æ—¶åŠ è½½å…¨å±€ CSS (è¯·ç¨ååœ¨ initializeApp ä¸­è°ƒç”¨å®ƒ)
     */
    async function loadGlobalCss() {
        try {
            const data = await dbHelper.loadData('settingsStore', 'globalUserCss');
            if (data && data.value) {
                applyGlobalCss(data.value);
                console.log("å…¨å±€ç¾åŒ–ä»£ç å·²åŠ è½½ã€‚");
            }
        } catch (e) {
            console.error("åŠ è½½å…¨å±€CSSå¤±è´¥", e);
        }
    }
    /**
     * åˆ‡æ¢è¯­éŸ³è½¬æ–‡å­—é¢æ¿çš„æ˜¾ç¤ºçŠ¶æ€ (å¸¦åŠ¨ç”»)
     * @param {HTMLElement} audioBubble - è¢«ç‚¹å‡»çš„è¯­éŸ³æ¡å…ƒç´ 
     */
    function toggleVoiceText(audioBubble) {
        // 1. æ‰¾åˆ°åŒçº§åœ¨è¿™ä¸ªå®¹å™¨é‡Œçš„æ–‡æœ¬é¢æ¿
        const wrapper = audioBubble.parentElement;
        const textPanel = wrapper.querySelector('.voice-text-panel');

        if (!textPanel) return;

        // 2. åˆ‡æ¢é€»è¾‘
        if (textPanel.classList.contains('visible')) {
            // --- éšè—è¿‡ç¨‹ ---
            textPanel.classList.remove('fade-in'); // å…ˆç§»é™¤é€æ˜åº¦
            setTimeout(() => {
                textPanel.classList.remove('visible'); // åŠ¨ç”»æ’­å®Œåè®¾ä¸º display: none
            }, 300); // 300ms å¯¹åº” CSS transition
        } else {
            // --- æ˜¾ç¤ºè¿‡ç¨‹ ---
            textPanel.classList.add('visible'); // å…ˆè®¾ä¸º display: block

            // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ä¸€å¸§ (Double RAF)ï¼Œç¡®ä¿ transition ç”Ÿæ•ˆ
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    textPanel.classList.add('fade-in'); // å†è®¾ä¸º opacity: 1
                });
            });
        }
    }


    /**
     * ä½¿åŠ¨ä½œ/æ—ç™½æ¶ˆæ¯å¯ç¼–è¾‘
     */
    function makeActionEditable(element) {
        const row = element.closest('.message-row');
        if (!row || !row.dataset.uuid) return;

        const uuid = row.dataset.uuid;
        const currentText = element.textContent;

        // æ›¿æ¢ä¸ºè¾“å…¥æ¡†
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentText;

        // åº”ç”¨ä¸€äº›æ ·å¼è®©å®ƒçœ‹èµ·æ¥åƒåŸæ¥çš„æ–‡æœ¬
        input.style.cssText = `
        font-size: 12px; color: #333; background: rgba(255,255,255,0.8);
        border: 1px solid #007AFF; border-radius: 12px;
        padding: 4px 12px; text-align: center; width: auto; min-width: 150px; outline: none;
    `;

        element.innerHTML = '';
        element.appendChild(input);
        input.focus();

        // å®šä¹‰ä¿å­˜é€»è¾‘
        const save = async () => {
            const newText = input.value.trim();
            if (newText && newText !== currentText) {
                // è¿™é‡Œæˆ‘ä»¬å¤ç”¨ updateMessageInDatabase
                // æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦è®© updateMessageInDatabase æ”¯æŒ action ç±»å‹
                // å¦‚æœå®ƒä¸æ”¯æŒï¼Œæˆ‘ä»¬æ‰‹åŠ¨å¤„ç†ä¸€ä¸‹ï¼š
                if (currentOpenContact) {
                    const msg = currentOpenContact.history.find(m => m.uuid === uuid);
                    if (msg) {
                        msg.text = newText;
                        await saveCurrentContactToDatabase();
                        // ç®€å•æš´åŠ›ï¼šåˆ·æ–°æ•´ä¸ªåˆ—è¡¨æˆ–è€…æ›¿æ¢å…ƒç´ æ–‡æœ¬
                        element.textContent = newText;
                    }
                } else if (currentOpenGroup) {
                    const msg = currentOpenGroup.history.find(m => m.uuid === uuid);
                    if (msg) {
                        msg.text = newText;
                        const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                        const groupIndex = groupsData.value.findIndex(g => g.id === currentOpenGroup.id);
                        if (groupIndex > -1) {
                            groupsData.value[groupIndex] = currentOpenGroup;
                            await dbHelper.saveData('groupChats', 'allGroupChats', groupsData.value);
                        }
                        element.textContent = newText;
                    }
                }
            } else {
                element.textContent = currentText; // æ¢å¤åŸçŠ¶
            }
        };

        input.addEventListener('blur', save);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
        });
    }
    /**
     * æ‰“å¼€è¯­éŸ³æ–‡å­—ç¼–è¾‘å¼¹çª—
     */
    function openVoiceEditModal(uuid, currentText) {
        // å®šä¹‰ä¿å­˜å›è°ƒ
        const onSave = async (newText) => {
            if (currentOpenContact) {
                const msg = currentOpenContact.history.find(m => m.uuid === uuid);
                if (msg) {
                    msg.transcript = newText; // æ›´æ–° transcript å­—æ®µ
                    // ä¹Ÿè¦æ›´æ–° text å­—æ®µç”¨äºé¢„è§ˆ
                    msg.text = `[è¯­éŸ³æ¶ˆæ¯] ${newText.substring(0, 10)}...`;

                    await saveCurrentContactToDatabase();

                    // å®æ—¶æ›´æ–°ç•Œé¢ä¸Šçš„æ–‡å­—
                    const row = document.querySelector(`.message-row[data-uuid="${uuid}"]`);
                    if (row) {
                        const panel = row.querySelector('.voice-text-panel');
                        if (panel) panel.innerText = newText; // ä½¿ç”¨ innerText å¤„ç†æ¢è¡Œ
                    }

                    // å…³é—­å¼¹çª—
                    closeTextEditModal();
                }
            }
        };

        // è°ƒç”¨ä½ ç°æœ‰çš„é€šç”¨ç¼–è¾‘å¼¹çª—å‡½æ•°
        // å‡è®¾ä½ çš„å‡½æ•°åæ˜¯ openTextEditModal(title, text, callback)
        if (typeof openTextEditModal === 'function') {
            openTextEditModal("ä¿®æ­£è¯­éŸ³è¯†åˆ«", currentText, onSave);
        } else {
            // å¦‚æœæ‰¾ä¸åˆ°é€šç”¨å¼¹çª—ï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„å…œåº•ï¼ˆæˆ–è€…ä½ å‘Šè¯‰æˆ‘ä½ çš„å¼¹çª—IDï¼‰
            const newT = prompt("ä¿®æ­£è¯­éŸ³æ–‡å­—ï¼š", currentText);
            if (newT !== null) onSave(newT);
        }
    }


    if (menuDeleteBtn) {
        menuDeleteBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜²æ­¢å†’æ³¡

            // ã€å…³é”®æ­¥éª¤ 1ã€‘å…ˆæŠŠè¦åˆ é™¤çš„ç›®æ ‡å­˜åˆ°ä¸€ä¸ªä¸´æ—¶å˜é‡é‡Œï¼
            // å› ä¸º hideActionMenu() ä¼šæŠŠå…¨å±€å˜é‡ currentLongPressTarget æ¸…ç©ºå˜æˆ null
            const targetRow = currentLongPressTarget;

            // ã€å…³é”®æ­¥éª¤ 2ã€‘ç°åœ¨å¯ä»¥å®‰å…¨åœ°å…³é—­èœå•äº†
            hideActionMenu();

            // ã€å…³é”®æ­¥éª¤ 3ã€‘ä½¿ç”¨åˆšæ‰å­˜ä¸‹æ¥çš„ä¸´æ—¶å˜é‡å»æ‰§è¡Œåˆ é™¤
            if (targetRow) {
                // åŒé‡ä¿é™©ï¼šç¡®ä¿è¿™ä¸ªå…ƒç´ çœŸçš„æœ‰ dataset å±æ€§
                if (!targetRow.dataset || !targetRow.dataset.uuid) {
                    console.error("æ— æ³•åˆ é™¤ï¼šæ‰¾ä¸åˆ°æ¶ˆæ¯ID");
                    return;
                }

                if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ")) {
                    removeMessageFromView(targetRow);
                }
            } else {
                console.warn("åˆ é™¤å¤±è´¥ï¼šæœªèƒ½é”å®šè¦åˆ é™¤çš„æ¶ˆæ¯è¡Œ");
            }
        });
    }
    /**
     * æ ¸å¿ƒå‡½æ•°ï¼šè·å–å½“å‰è”ç³»äººå¯ç”¨çš„æ‰€æœ‰è¡¨æƒ…åŒ…ï¼ˆæ”¯æŒåŒé‡å¼€å…³æ§åˆ¶ï¼‰
     * @param {object} contact - å½“å‰è”ç³»äººå¯¹è±¡
     * @returns {Promise<Map>} - è¿”å›ä¸€ä¸ª Mapï¼Œé”®æ˜¯è¡¨æƒ…åï¼Œå€¼æ˜¯URL
     */
    async function getAllAvailableStickersMap(contact) {
        let finalMap;

        // 1. ã€æ–°å¢é€»è¾‘ã€‘æ£€æŸ¥â€œé¢„è®¾è¡¨æƒ…åŒ…â€å¼€å…³
        // é»˜è®¤ä¸º true (å¼€å¯)ï¼Œé™¤éç”¨æˆ·æ˜ç¡®å…³é—­ (false)
        const isDefaultEnabled = contact.enableDefaultStickers !== false;

        if (isDefaultEnabled) {
            // å¦‚æœå¼€å¯ï¼Œä»¥å…¨å±€ stickerMap ä¸ºåŸºç¡€
            finalMap = new Map(stickerMap);
        } else {
            // å¦‚æœå…³é—­ï¼Œä»ä¸€ä¸ªç©ºçš„ Map å¼€å§‹
            finalMap = new Map();
        }

        // 2. æ£€æŸ¥â€œä¸–ç•Œä¹¦è¡¨æƒ…åŒ…â€å¼€å…³
        const isWBEnabled = contact.enableWBStickers !== false; // é»˜è®¤ä¸º true

        // å¦‚æœä¸–ç•Œä¹¦å¼€å…³å…³äº†ï¼Œæˆ–è€…æ²¡æœ‰å…³è”ä¸–ç•Œä¹¦ï¼Œç›´æ¥è¿”å›å½“å‰ç»“æœ
        // æ£€æŸ¥æ–°æ—§ä¸¤ä¸ªå…³è”å­—æ®µ
        const hasLinkedBooks = (contact.linkedWorldBookIds && contact.linkedWorldBookIds.length > 0) 
                            || (contact.linkedWorldBookGroupIds && contact.linkedWorldBookGroupIds.length > 0);
        
        if (!isWBEnabled || !hasLinkedBooks) {
            return finalMap;
        }

        try {
            // 3. åŠ è½½ä¸–ç•Œä¹¦æ•°æ®
            const booksData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
            const allBooks = (booksData && Array.isArray(booksData.value)) ? booksData.value : [];
            const requiredBookIds = new Set();

            // 4. æ‰¾å‡ºå…³è”çš„ä¹¦ç±ID
            // ä¼˜å…ˆæ–°ç‰ˆ
            if (contact.linkedWorldBookIds && contact.linkedWorldBookIds.length > 0) {
                 contact.linkedWorldBookIds.forEach(id => requiredBookIds.add(id));
            } else {
                 // å›é€€æ—§ç‰ˆ
                 const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                 const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                 const linkedGroupIds = new Set(contact.linkedWorldBookGroupIds || []);
                 allGroups.forEach(g => {
                    if (linkedGroupIds.has(g.id) && Array.isArray(g.bookIds)) {
                        g.bookIds.forEach(bid => requiredBookIds.add(bid));
                    }
                 });
            }

            // 5. éå†ä¹¦ç±å†…å®¹å¹¶æå–æ­£åˆ™
            const linkedBooks = allBooks.filter(b => requiredBookIds.has(b.id));
            const regex = /\[([^:\]]+):(https?:\/\/[^\]]+)\]/g;

            linkedBooks.forEach(book => {
                if (!book.content) return;
                const text = book.content;
                let match;
                while ((match = regex.exec(text)) !== null) {
                    const name = match[1].trim();
                    const url = match[2].trim();
                    // å­˜å…¥ Map 
                    // æ³¨æ„ï¼šå¦‚æœåå­—å’Œé¢„è®¾çš„ä¸€æ ·ï¼Œè¿™é‡Œä¼šè¦†ç›–é¢„è®¾çš„ï¼Œè¿™æ­£å¥½ç¬¦åˆâ€œä¸–ç•Œä¹¦ä¼˜å…ˆçº§æ›´é«˜â€çš„é€»è¾‘
                    finalMap.set(name, url);
                }
            });

            console.log(`è¡¨æƒ…åŒ…åŠ è½½å®Œæ¯•ã€‚é¢„è®¾:${isDefaultEnabled}, ä¸–ç•Œä¹¦:${isWBEnabled}, æ€»æ•°:${finalMap.size}`);

        } catch (e) {
            console.error("æå–ä¸–ç•Œä¹¦è¡¨æƒ…åŒ…å¤±è´¥:", e);
        }

        return finalMap;
    }



    // æ¸²æŸ“è”ç³»äººé€‰æ‹©åˆ—è¡¨
    async function renderProactiveContactList() {
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        const contacts = (contactsData && contactsData.value) ? contactsData.value : [];

        proactiveContactList.innerHTML = '';

        if (contacts.length === 0) {
            proactiveContactList.innerHTML = '<div style="padding:15px; color:#888;">æš‚æ— è”ç³»äºº</div>';
            return;
        }

        contacts.forEach(contact => {
            // è¿‡æ»¤æ‰éšè—è§’è‰²ï¼ˆå¦‚ç¾¤æˆå‘˜ï¼‰
            if (contact.isHidden) return;

            const isChecked = proactiveConfig.targets.includes(contact.id);
            const div = document.createElement('div');
            div.className = 'proactive-item';
            div.innerHTML = `
    <img src="${contact.ai.avatar}">
    <label>${contact.ai.name}</label>
    <label class="switch circle-mode">
        <input type="checkbox" value="${contact.id}" ${isChecked ? 'checked' : ''}>
<span class="slider round"></span>
    </label>
`;

            // ç»‘å®šå‹¾é€‰äº‹ä»¶
            const checkbox = div.querySelector('input');
            checkbox.addEventListener('change', async () => {
                const id = parseInt(checkbox.value);
                if (checkbox.checked) {
                    if (!proactiveConfig.targets.includes(id)) proactiveConfig.targets.push(id);
                } else {
                    proactiveConfig.targets = proactiveConfig.targets.filter(tid => tid !== id);
                    // å¦‚æœå–æ¶ˆå‹¾é€‰ï¼Œç«‹å³åœæ­¢è¯¥è§’è‰²çš„è®¡æ—¶
                    stopProactiveTimer(id);
                }
                await saveProactiveSettings();
            });

            proactiveContactList.appendChild(div);
        });
    }

    // ä¿å­˜è®¾ç½®åˆ°æ•°æ®åº“
    async function saveProactiveSettings() {
        proactiveConfig.enabled = proactiveMasterSwitch.checked;
        proactiveConfig.interval = parseInt(proactiveIntervalSlider.value);

        await dbHelper.saveData('settingsStore', 'proactiveConfig', proactiveConfig);
        updateProactiveStatusText();

        // å¦‚æœæ€»å¼€å…³å…³é—­ï¼Œæ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
        if (!proactiveConfig.enabled) {
            Object.keys(proactiveTimers).forEach(id => stopProactiveTimer(id));
        }
    }

    /**
     * å¯åŠ¨ä¸»åŠ¨æ¶ˆæ¯è®¡æ—¶å™¨
     * @param {number} contactId - ç¦»å¼€çš„è”ç³»äººID
     */
    function startProactiveTimer(contactId) {
        // 1. æ£€æŸ¥æ€»å¼€å…³å’Œç™½åå•
        if (!proactiveConfig.enabled || !proactiveConfig.targets.includes(contactId)) {
            return;
        }

        // 2. æ¸…é™¤æ—§è®¡æ—¶å™¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰
        stopProactiveTimer(contactId);

        console.log(`[ä¸»åŠ¨æ¶ˆæ¯] å¼€å§‹ä¸ºè”ç³»äºº ${contactId} è®¡æ—¶: ${proactiveConfig.interval} åˆ†é’Ÿ`);

        // 3. è®¾ç½®æ–°è®¡æ—¶å™¨ (âœ… ä½¿ç”¨TimerManagerç»Ÿä¸€ç®¡ç†)
        const delay = proactiveConfig.interval * 60 * 1000; // åˆ†é’Ÿè½¬æ¯«ç§’

        proactiveTimers[contactId] = window.TimerManager.setTimeout(async () => {
            console.log(`[ä¸»åŠ¨æ¶ˆæ¯] æ—¶é—´åˆ°ï¼è§¦å‘è”ç³»äºº ${contactId}`);
            await triggerProactiveAI(contactId);
        }, delay, 'proactive');
    }

    /**
     * åœæ­¢/é‡ç½®è®¡æ—¶å™¨
     * @param {number} contactId 
     */
    function stopProactiveTimer(contactId) {
        if (proactiveTimers[contactId]) {
            clearTimeout(proactiveTimers[contactId]);
            delete proactiveTimers[contactId];
            console.log(`[ä¸»åŠ¨æ¶ˆæ¯] è”ç³»äºº ${contactId} è®¡æ—¶å·²å–æ¶ˆ`);
        }
    }
    
    /**
     * ç«‹å³è§¦å‘ AI ä¸»åŠ¨å›å¤ï¼ˆä¸éœ€è¦ç­‰å¾…è®¡æ—¶å™¨ï¼‰
     * ç”¨äºæ¸¸æˆç»“æŸç­‰ç‰¹æ®Šåœºæ™¯
     * @param {number} contactId 
     */
    async function triggerProactiveMessage(contactId) {
        console.log(`[ä¸»åŠ¨æ¶ˆæ¯] ç«‹å³è§¦å‘è”ç³»äºº ${contactId} çš„AIå›å¤`);
        await triggerProactiveAI(contactId);
    }
    
    /**
     * è§¦å‘ AI ä¸»åŠ¨å‘é€æ¶ˆæ¯
     */
    /**
     * è§¦å‘ AI ä¸»åŠ¨å‘é€æ¶ˆæ¯ (ä¿®å¤ç‰ˆï¼šè¯»äººè®¾ã€è¯»ä¸–ç•Œä¹¦ã€è¯»å†å²ã€å¤šæ°”æ³¡)
     */
    async function triggerProactiveAI(contactId) {
        // 1. è·å–è”ç³»äººä¿¡æ¯
        const contact = await getContactById(contactId);
        if (!contact) return;

        // 2. å†æ¬¡æ£€æŸ¥ï¼šå¦‚æœç”¨æˆ·ç°åœ¨æ­£å¥½åœ¨è¿™ä¸ªèŠå¤©çª—å£é‡Œï¼Œå°±ä¸å‘äº†
        if (currentOpenContact && currentOpenContact.id === contactId) {
            return;
        }

        console.log(`[ä¸»åŠ¨æ¶ˆæ¯] æ­£åœ¨ä¸º ${contact.ai.name} æ„å»ºä¸Šä¸‹æ–‡...`);

        // --- A. å‡†å¤‡æ•°æ®ï¼šäººè®¾ ---
        const aiPersona = `å§“åï¼š${contact.ai.name}\näººè®¾ï¼š${contact.ai.persona}`;
        const userPersona = `å§“åï¼š${contact.user.name}\näººè®¾ï¼š${contact.user.persona}`;

        // --- B. å‡†å¤‡æ•°æ®ï¼šèŠå¤©è®°å½• (å‰æƒ…æè¦) ---
        const history = contact.history || [];
        // å–æœ€è¿‘ 15 æ¡ï¼Œé¿å… token çˆ†ç‚¸ï¼Œä½†è¶³å¤Ÿäº†è§£ä¸Šä¸‹æ–‡
        const recentHistory = history.slice(-15);
        let chatHistoryText = recentHistory.map(msg => {
            // ç®€å•æ¸…æ´—ä¸€ä¸‹æ¶ˆæ¯å†…å®¹
            let content = msg.text || (msg.transcript) || '[å¤šåª’ä½“/å›¾ç‰‡]';
            // å¦‚æœæ˜¯ç”¨æˆ·å‘çš„
            const sender = msg.sender === 'user' ? contact.user.name : contact.ai.name;
            return `${sender}: ${content}`;
        }).join('\n');

        if (!chatHistoryText) chatHistoryText = "(æš‚æ— å¯¹è¯è®°å½•)";

        // --- C. å‡†å¤‡æ•°æ®ï¼šä¸–ç•Œä¹¦ (æ ¸å¿ƒä¿®å¤) ---
        let worldBookContent = "æ— ç‰¹å®šä¸–ç•Œè§‚è®¾å®šã€‚";
        // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„ä¸–ç•Œä¹¦ç»„
        if (contact.linkedWorldBookGroupIds && contact.linkedWorldBookGroupIds.length > 0) {
            try {
                const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

                const booksData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
                const allBooks = (booksData && Array.isArray(booksData.value)) ? booksData.value : [];

                const linkedGroupIds = new Set(contact.linkedWorldBookGroupIds);
                const requiredBookIds = new Set();

                // æ‰¾å‡ºæ‰€æœ‰éœ€è¦çš„ä¹¦ID
                allGroups.forEach(group => {
                    if (linkedGroupIds.has(group.id) && Array.isArray(group.bookIds)) {
                        group.bookIds.forEach(bookId => requiredBookIds.add(bookId));
                    }
                });

                // æå–å†…å®¹
                const linkedBooksContent = allBooks
                    .filter(book => requiredBookIds.has(book.id))
                    .map(book => `ã€ä¸–ç•Œè®¾å®šï¼š${book.name}ã€‘\n${book.content}`)
                    .join('\n\n');

                if (linkedBooksContent) {
                    worldBookContent = linkedBooksContent;
                }
            } catch (e) {
                console.error("ä¸»åŠ¨æ¶ˆæ¯è¯»å–ä¸–ç•Œä¹¦å¤±è´¥:", e);
            }
        }

        // --- D. æ„é€  Prompt (å¼ºåŠ›æŒ‡ä»¤ç‰ˆ) ---
        const triggerPrompt = `
[æ ¸å¿ƒæŒ‡ä»¤]
ç”¨æˆ·å·²ç»æœ‰ ${proactiveConfig.interval} åˆ†é’Ÿæ²¡è¯´è¯äº†ã€‚ä½ ç°åœ¨å¿…é¡»**å®Œå…¨æ²‰æµ¸**åœ¨ä½ çš„è§’è‰²ä¸­ï¼Œæ ¹æ®ã€å‰æƒ…æè¦ã€‘å’Œã€äººè®¾ã€‘ï¼Œä¸»åŠ¨å‘èµ·ä¸€ä¸ªæ–°çš„è¯é¢˜ï¼Œæˆ–è€…ç»§ç»­ä¹‹å‰çš„è¯é¢˜æ¥å¼•èµ·ç”¨æˆ·çš„æ³¨æ„ã€‚

[å¼ºåˆ¶æ ¼å¼è¦æ±‚]
1. **å¿…é¡»å‘é€ 2 åˆ° 3 å¥çŸ­æ¶ˆæ¯**ã€‚ä¸è¦åªå‘ä¸€å¥ï¼
2. **å¿…é¡»ä½¿ç”¨åæ–œæ  "\\" æ¥åˆ†éš”æ¯ä¸€å¥è¯**ã€‚
3. **ä¸¥ç¦**å‡ºç° "ç³»ç»Ÿæç¤º"ã€"AI"ã€"å›å¤" ç­‰å‡ºæˆçš„è¯æ±‡ã€‚
4. **ä¸¥ç¦**é‡å¤ä¹‹å‰çš„æœ€åä¸€å¥è¯ã€‚

[å‚è€ƒèŒƒä¾‹]
æ­£ç¡®æ ¼å¼ï¼šä½ åœ¨å¹²å˜›å‘¢ï¼Ÿ\\æˆ‘åˆšçœ‹åˆ°ä¸€ä¸ªå¥½ç©çš„ä¸œè¥¿ï¼Œæƒ³ç»™ä½ çœ‹çœ‹ã€‚
æ­£ç¡®æ ¼å¼ï¼šå¥½æ— èŠå•Š...\\ä½ æ€ä¹ˆè¿˜ä¸ç†æˆ‘ï¼Ÿ\\æ˜¯ä¸æ˜¯æŠŠä½ å¿˜å•¦ï¼Ÿ

---
### ä½ çš„è§’è‰² (AI)
${aiPersona}

### ç”¨æˆ·è§’è‰² (User)
${userPersona}

### ä¸–ç•Œè§‚çŸ¥è¯†åº“
${worldBookContent}

### å‰æƒ…æè¦ (æœ€è¿‘èŠå¤©)
${chatHistoryText}
---
è¯·ç°åœ¨ç”Ÿæˆä½ çš„ä¸»åŠ¨æ¶ˆæ¯ï¼š
`;

        // 4. è°ƒç”¨ AI
        try {
            console.log(`æ­£åœ¨è¯·æ±‚ ${contact.ai.name} çš„ä¸»åŠ¨æ¶ˆæ¯...`);
            const aiResponseRaw = await fetchSimpleAiResponse(triggerPrompt);

            if (aiResponseRaw) {
                // --- E. åå¤„ç†ï¼šæ‹†åˆ†æ¶ˆæ¯å¹¶ä¿å­˜ ---

                // 1. æŒ‰ \ æˆ– \n æ‹†åˆ†æ¶ˆæ¯
                const messages = aiResponseRaw.split(/\\|\\n|\n/).map(t => t.trim()).filter(t => t);

                if (messages.length === 0) return;

                // 2. é€æ¡ä¿å­˜åˆ°æ•°æ®åº“
                // æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª Promise.all æˆ–è€…å¾ªç¯æ¥ç¡®ä¿é¡ºåºä¿å­˜
                for (const msgText of messages) {
                    const aiMessage = {
                        sender: 'ai',
                        text: msgText,
                        timestamp: new Date(),
                        uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                    };
                    // ä¿å­˜æ¯ä¸€æ¡
                    await saveMessageToHistory(aiMessage, contactId);
                }

                // 3. å¼¹å‡ºé€šçŸ¥ (æ˜¾ç¤ºåˆå¹¶åçš„æ–‡æœ¬ï¼Œæˆ–è€…ç¬¬ä¸€å¥)
                // ä¸ºäº†é€šçŸ¥çœ‹èµ·æ¥æ•´æ´ï¼Œæˆ‘ä»¬ç”¨ç©ºæ ¼è¿æ¥æ˜¾ç¤º
                const notificationText = messages.join(' ');
                pushNotificationToQueue(contact, notificationText);

                console.log(`[ä¸»åŠ¨æ¶ˆæ¯] æˆåŠŸç”Ÿæˆå¹¶ä¿å­˜äº† ${messages.length} æ¡æ¶ˆæ¯ã€‚`);
            }

        } catch (e) {
            console.error("ä¸»åŠ¨æ¶ˆæ¯è§¦å‘å¤±è´¥:", e);
        }
    }
    /**
     * å°†é€šçŸ¥åŠ å…¥é˜Ÿåˆ—
     */
    function pushNotificationToQueue(contact, text) {
        bannerQueue.push({ contact, text });
        processNotificationQueue();
    }

    /**
     * å¤„ç†é€šçŸ¥é˜Ÿåˆ—
     */
    function processNotificationQueue() {
        if (isBannerShowing || bannerQueue.length === 0) return;

        isBannerShowing = true;
        const { contact, text } = bannerQueue.shift();

        showGlassBanner(contact, text);
    }

    /**
     * æ˜¾ç¤ºé«˜æ–¯æ¨¡ç³Šæ¨ªå¹…
     */
    function showGlassBanner(contact, text) {
        const container = document.getElementById('notification-banner-container');
        const banner = document.createElement('div');
        banner.className = 'glass-banner';
        banner.innerHTML = `
        <img src="${contact.ai.avatar}">
        <div class="glass-banner-content">
            <div class="glass-banner-title">${contact.ai.name}</div>
            <div class="glass-banner-text">${text}</div>
        </div>
    `;

        // ç‚¹å‡»æ¨ªå¹…è·³è½¬
        banner.onclick = () => {
            // å…³é—­æ¨ªå¹…
            banner.classList.remove('show');
            setTimeout(() => banner.remove(), 400);
            // è·³è½¬
            openChatView(contact.id);
        };

        container.appendChild(banner);

        // åŠ¨ç”»è¿›åœº
        requestAnimationFrame(() => {
            banner.classList.add('show');
        });

        // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            banner.classList.remove('show');

            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ å¹¶å¤„ç†ä¸‹ä¸€æ¡
            setTimeout(() => {
                banner.remove();
                isBannerShowing = false;
                processNotificationQueue(); // é€’å½’å¤„ç†ä¸‹ä¸€æ¡
            }, 400); // ç­‰å¾… CSS transition ç»“æŸ
        }, 2500); // åœç•™æ—¶é—´ (2s + è¿›åœºå†—ä½™)
    }
    // --- 5. è®¾ç½®åŠ è½½ä¸ä¿å­˜é€»è¾‘ (ä½ æä¾›çš„éƒ¨åˆ†) ---

    async function loadProactiveSettings() {
        const data = await dbHelper.loadData('settingsStore', 'proactiveConfig');
        if (data && data.value) {
            proactiveConfig = data.value;
        }

        // UI åŒæ­¥
        if (proactiveMasterSwitch) proactiveMasterSwitch.checked = proactiveConfig.enabled;
        if (proactiveIntervalSlider) proactiveIntervalSlider.value = proactiveConfig.interval;
        if (proactiveIntervalDisplay) proactiveIntervalDisplay.textContent = `${proactiveConfig.interval} åˆ†é’Ÿ`;

        updateProactiveStatusText();
        await renderProactiveContactList();
    }

    async function saveProactiveSettings() {
        proactiveConfig.enabled = proactiveMasterSwitch.checked;
        proactiveConfig.interval = parseInt(proactiveIntervalSlider.value);

        await dbHelper.saveData('settingsStore', 'proactiveConfig', proactiveConfig);
        updateProactiveStatusText();

        // å¦‚æœå…³é—­äº†ï¼Œæ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
        if (!proactiveConfig.enabled) {
            Object.keys(proactiveTimers).forEach(id => stopProactiveTimer(id));
        }
    }

    function updateProactiveStatusText() {
        if (!proactiveStatusText) return;
        if (proactiveConfig.enabled) {
            proactiveStatusText.textContent = `å¼€å¯ (${proactiveConfig.interval}åˆ†é’Ÿ)`;
            proactiveStatusText.style.color = '#007AFF';
        } else {
            proactiveStatusText.textContent = 'å·²å…³é—­';
            proactiveStatusText.style.color = '#8e8e93';
        }
    }

    async function renderProactiveContactList() {
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        const contacts = (contactsData && contactsData.value) ? contactsData.value : [];

        if (!proactiveContactList) return;
        proactiveContactList.innerHTML = '';

        contacts.forEach(contact => {
            if (contact.isHidden) return;
            const isChecked = proactiveConfig.targets.includes(contact.id);
            const div = document.createElement('div');
            div.className = 'proactive-item';
            div.innerHTML = `
            <img src="${contact.ai.avatar}">
            <label>${contact.ai.name}</label>
            <input type="checkbox" value="${contact.id}" ${isChecked ? 'checked' : ''} style="width:20px; height:20px;">
        `;
            div.querySelector('input').addEventListener('change', async (e) => {
                const id = parseInt(e.target.value);
                if (e.target.checked) {
                    if (!proactiveConfig.targets.includes(id)) proactiveConfig.targets.push(id);
                } else {
                    proactiveConfig.targets = proactiveConfig.targets.filter(tid => tid !== id);
                    stopProactiveTimer(id); // å–æ¶ˆå‹¾é€‰ç«‹å³åœæ­¢è®¡æ—¶
                }
                await saveProactiveSettings();
            });
            proactiveContactList.appendChild(div);
        });
    }

    // --- 6. äº‹ä»¶ç›‘å¬ç»‘å®š ---

    if (navToProactiveBtn) {
        navToProactiveBtn.addEventListener('click', () => {
            // ä½¿ç”¨ class åˆ‡æ¢ï¼Œä¸å…¶ä»– .screen ä¿æŒä¸€è‡´çš„æ˜¾ç¤ºé€»è¾‘
            proactiveSettingsScreen.classList.add('opened');
            loadProactiveSettings();
        });
    }

    if (proactiveBackBtn) {
        proactiveBackBtn.addEventListener('click', () => {
            proactiveSettingsScreen.classList.remove('opened');
        });
    }

    if (proactiveMasterSwitch) proactiveMasterSwitch.addEventListener('change', saveProactiveSettings);
    if (proactiveIntervalSlider) {
        proactiveIntervalSlider.addEventListener('input', (e) => {
            proactiveIntervalDisplay.textContent = `${e.target.value} åˆ†é’Ÿ`;
        });
        proactiveIntervalSlider.addEventListener('change', saveProactiveSettings);
    }
    function setBatteryStatus(level, isCharging) {
        // 1. è®¡ç®—å®½åº¦
        const svgWidth = (level / 100) * MAX_SVG_WIDTH;
        batteryLevelRect.setAttribute('width', svgWidth);

        // 2. çŠ¶æ€åˆ¤æ–­
        if (isCharging) {
            batteryContainer.classList.add('charging');
            batteryContainer.classList.remove('low');
            batteryBolt.style.display = 'block';
        } else {
            batteryContainer.classList.remove('charging');
            batteryBolt.style.display = 'none';

            // ä½ç”µé‡åˆ¤æ–­ (<=20%)
            if (level <= 20) {
                batteryContainer.classList.add('low');
            } else {
                batteryContainer.classList.remove('low');
            }
        }
    }

    // åˆå§‹åŒ–ç”µæ± ç›‘å¬
    function initBattery() {
        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                console.log("ç”µæ± APIåŠ è½½æˆåŠŸ");

                // åˆå§‹è¯»å–
                setBatteryStatus(Math.round(battery.level * 100), battery.charging);

                // ç›‘å¬ç”µé‡å˜åŒ–
                battery.addEventListener('levelchange', () => {
                    setBatteryStatus(Math.round(battery.level * 100), battery.charging);
                });

                // ç›‘å¬å……ç”µçŠ¶æ€å˜åŒ–
                battery.addEventListener('chargingchange', () => {
                    setBatteryStatus(Math.round(battery.level * 100), battery.charging);
                });
            });
        } else {
            console.log("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç”µæ± APIï¼Œæ˜¾ç¤ºé»˜è®¤50%ç”µé‡");
            setBatteryStatus(50, false);
        }
    }
    initBattery();





    // --- 2. å¯¼èˆªä¸åˆå§‹åŒ– ---

    // æ‰“å¼€ APP
    // === ä¿®å¤ç‰ˆï¼šæ‰“å¼€å“‡å‘œ APP (å¸¦è‡ªåŠ¨ç™»å½•) ===
    if (wowAppIcon) {
        wowAppIcon.addEventListener('click', async () => {
            phoneFrame.classList.add('show-wow');

            // 1. å°è¯•ä» localStorage è·å–ä¸Šæ¬¡ç™»å½•çš„ ID
            const lastId = localStorage.getItem('lastWowContactId');

            // 2. å¦‚æœå†…å­˜é‡Œæ²¡æœ‰èº«ä»½ï¼Œä½†åœ¨ç¼“å­˜é‡Œæ‰¾åˆ°äº† IDï¼Œå°è¯•è‡ªåŠ¨ç™»å½•
            if (!currentWowContact && lastId) {
                const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                if (contactsData && Array.isArray(contactsData.value)) {
                    // æ³¨æ„ï¼šæ•°æ®åº“é‡Œçš„ ID æ˜¯æ•°å­—ï¼ŒlocalStorage å­˜çš„æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦è½¬æ¢
                    const targetContact = contactsData.value.find(c => c.id == lastId);
                    if (targetContact) {
                        selectWowIdentity(targetContact); // è‡ªåŠ¨ç™»å½•
                        return; // ç»“æŸå‡½æ•°ï¼Œä¸å†å¼¹å‡ºé€‰æ‹©æ¡†
                    }
                }
            }

            // 3. å¦‚æœè¿˜æ˜¯æ²¡æœ‰èº«ä»½ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡æˆ–è€…æ˜¯æ–°è®¾å¤‡ï¼Œå¼¹å‡ºé€‰æ‹©æ¡†
            if (!currentWowContact) {
                openWowIdentityModal();
            } else {
                // å¦‚æœå·²ç»æœ‰èº«ä»½ï¼ˆæœªåˆ·æ–°é¡µé¢å†æ¬¡ç‚¹å‡»å›¾æ ‡ï¼‰ï¼Œç›´æ¥åˆ·æ–°æ•°æ®
                renderWowFeed();
                updateWowProfileUI();
                loadWowWorldbookOptions();
            }
        });
    }

    if (wowExitBtn) {
        wowExitBtn.addEventListener('click', () => {
            // âœ… æ‰¹é‡æ¸…ç†Wow
        window.DOMCleanupManager.cleanMultiple([
            'wow-feed-container',
            'wow-detail-comments'
        ]);
        
        // æ¸…ç†å…¨å±€å˜é‡
        if (typeof currentWowContact !== 'undefined') {
            currentWowContact = null;
        }
        if (typeof currentDetailPostId_Wow !== 'undefined') {
            currentDetailPostId_Wow = null;
        }
            phoneFrame.classList.remove('show-wow');
        });
    }

    // â–¼â–¼â–¼ ä¿®å¤ç‰ˆï¼šåº•éƒ¨ Dock åˆ‡æ¢ â–¼â–¼â–¼
    wowNavBtns.forEach(btn => {
        btn.addEventListener('click', () => {

            // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘å…ˆè·å–ç›®æ ‡ ID
            const targetId = btn.dataset.target;

            // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœæ²¡æœ‰ç›®æ ‡ ID (è¯´æ˜æ˜¯ä¸­é—´çš„å‘å¸ƒæŒ‰é’®)ï¼Œç›´æ¥åˆ¹è½¦ï¼é€€å‡ºï¼
            // è¿™æ ·å°±ä¸ä¼šå»æ‰§è¡Œåé¢æ‰¾é¡µé¢çš„ä»£ç äº†ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ã€‚
            if (!targetId) return;

            // --- ä¸‹é¢æ˜¯æ­£å¸¸çš„é¡µé¢åˆ‡æ¢é€»è¾‘ (åªæœ‰é¦–é¡µå’Œæˆ‘çš„ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ) ---

            // 3. åˆ‡æ¢æŒ‰é’®é«˜äº®
            wowNavBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // 4. åˆ‡æ¢é¡µé¢æ˜¾ç¤º
            wowPages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(targetId);

            // åŒé‡ä¿é™©ï¼šç¡®ä¿é¡µé¢å­˜åœ¨æ‰åŠ  active
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // 5. å¦‚æœåˆ‡æ¢åˆ°ä¸ªäººä¸­å¿ƒï¼Œåˆ·æ–°æ•°æ®
            if (targetId === 'wow-profile-page') {
                updateWowProfileUI();
            }
        });
    });
    // --- 3. èº«ä»½é€‰æ‹©ç³»ç»Ÿ (Gatekeeper) ---

    if (wowHeaderAvatar) {
        wowHeaderAvatar.addEventListener('click', () => {
            openWowIdentityModal();
        });
    }


    async function openWowIdentityModal() {
        wowIdentityModal.style.display = 'flex';
        wowIdentityList.innerHTML = '<div class="wow-loading">è¯»å–é€šè®¯å½•...</div>';

        try {
            const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
            const contacts = (contactsData && contactsData.value) ? contactsData.value : [];

            wowIdentityList.innerHTML = '';

            if (contacts.length === 0) {
                wowIdentityList.innerHTML = '<div style="color:#666; font-size:12px;">é€šè®¯å½•ä¸ºç©ºï¼Œè¯·å…ˆå»è®¯æ¯APPæ·»åŠ è§’è‰²ã€‚</div>';
                return;
            }

            contacts.forEach(contact => {
                // è¿‡æ»¤æ‰éšè—è§’è‰²
                if (contact.isHidden) return;

                const item = document.createElement('div');
                item.className = 'wow-identity-item';
                item.innerHTML = `
                <img src="${contact.user.avatar}">
                <div style="text-align:left; flex:1;">
                    <div style="font-weight:700; font-size:14px;">${contact.user.name}</div>
                    <div style="font-size:10px; color:#888;">ç»‘å®š AI: ${contact.ai.name}</div>
                </div>
                <div style="font-size:18px; color:#ccc;">âœ</div>
            `;

                item.addEventListener('click', () => {
                    selectWowIdentity(contact);
                });

                wowIdentityList.appendChild(item);
            });

        } catch (e) {
            console.error("åŠ è½½èº«ä»½å¤±è´¥", e);
            wowIdentityList.innerHTML = 'åŠ è½½å¤±è´¥';
        }
    }

    // ã€ä¿®å¤ç‚¹ 2ã€‘åˆ‡æ¢èº«ä»½åï¼Œå¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç•Œé¢
    // ã€ä¿®å¤ç‰ˆã€‘åˆ‡æ¢èº«ä»½åï¼Œå¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç•Œé¢å’Œæ•°æ®
    function selectWowIdentity(contact) {
        currentWowContact = contact;

        localStorage.setItem('lastWowContactId', contact.id);

        // 1. æ›´æ–°é¡¶æ å¤´åƒ
        wowHeaderAvatar.src = contact.user.avatar;

        // 2. æ›´æ–°ä¸ªäººä¸­å¿ƒ UI
        updateWowProfileUI();

        // 3. é‡æ–°æ¸²æŸ“ä¿¡æ¯æµ (æ­¤æ—¶ renderWowFeed ä¼šæ ¹æ®æ–°çš„ contact.id è¿‡æ»¤)
        renderWowFeed();

        refreshGlobalAvatarMap(contact);

        // 4. ã€æ ¸å¿ƒä¿®å¤ã€‘é‡æ–°åŠ è½½ä¸–ç•Œä¹¦é€‰é¡¹ï¼Œæ˜¾ç¤ºå½“å‰è§’è‰²çš„å‹¾é€‰çŠ¶æ€
        // è¿™æ · A ç”¨æˆ·å‹¾é€‰çš„ä¹¦ï¼Œåˆ‡æ¢åˆ° B ç”¨æˆ·æ—¶å°±ä¸ä¼šæ˜¾ç¤ºäº†
        loadWowWorldbookOptions();

        // 5. å…³é—­å¼¹çª—
        wowIdentityModal.style.display = 'none';
    }

    // ==========================================================
    // === ä¿®å¤ç‰ˆï¼šå®‰å…¨æ›´æ–° WOW ä¸ªäººä¸­å¿ƒ UI ===
    // ==========================================================
    async function updateWowProfileUI() {
        // 1. åŸºæœ¬å®‰å…¨æ£€æŸ¥
        if (!currentWowContact) return;

        // 2. æ›´æ–°å¤´éƒ¨ä¿¡æ¯ (å¤´åƒå’Œåå­—)
        // åŠ ä¸Š ?. é˜²æ­¢ user å¯¹è±¡ä¸å­˜åœ¨æ—¶æŠ¥é”™
        if (wowProfileAvatar) wowProfileAvatar.src = currentWowContact.user?.avatar || '';
        if (wowProfileName) wowProfileName.textContent = currentWowContact.user?.name || 'æœªçŸ¥ç”¨æˆ·';

        // 3. åŠ è½½æˆ‘çš„æ”¶è—åˆ—è¡¨
        const listContainer = document.getElementById('wow-collection-list');

        if (listContainer) {
            listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">åŠ è½½æ”¶è—ä¸­...</div>';

            try {
                // ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰å¸–å­
                const postsData = await dbHelper.loadData('wowPosts', 'allPosts');

                // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šé˜²æ­¢ postsData ä¸º undefined å¯¼è‡´æŠ¥é”™
                // å¦‚æœæ²¡è¯»åˆ°æ•°æ®ï¼Œå°±ç»™ä¸€ä¸ªé»˜è®¤ç©ºæ•°ç»„
                const allPosts = (postsData && postsData.value) ? postsData.value : [];

                // è·å–å½“å‰ç”¨æˆ·çš„æ”¶è— ID åˆ—è¡¨ (ç¡®ä¿å®ƒæ˜¯æ•°ç»„)
                const myCollections = currentWowContact.collectedPostIds || [];

                // ç­›é€‰é€»è¾‘ï¼šæŠŠ ID è½¬å­—ç¬¦ä¸²æ¯”å¯¹ï¼Œé˜²æ­¢ç±»å‹ä¸åŒ¹é… (1 vs "1")
                const collectedPosts = allPosts.filter(p => myCollections.includes(String(p.id)));

                listContainer.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º

                if (collectedPosts.length === 0) {
                    listContainer.innerHTML = '<div style="color:#999; padding:20px; text-align:center;">æš‚æ— æ”¶è—å†…å®¹</div>';
                } else {
                    // æ¸²æŸ“å¡ç‰‡
                    collectedPosts.forEach(post => {
                        // å¤ç”¨ä½ å·²æœ‰çš„ Feed å¡ç‰‡ç”Ÿæˆå‡½æ•°
                        if (typeof createWowFeedCard === 'function') {
                            const card = createWowFeedCard(post);
                            listContainer.appendChild(card);
                        }
                    });
                }
            } catch (err) {
                console.error("åŠ è½½æ”¶è—å¤±è´¥:", err);
                listContainer.innerHTML = '<div style="color:red; padding:20px;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }
    }

    // --- 4. å¸–å­æµç³»ç»Ÿ (Feed System) ---

    // --- 3. å¸–å­æµæ¸²æŸ“ (Feed) ---

    async function renderWowFeed() {
        if (!currentWowContact) return;
        wowFeedContainer.innerHTML = '';

        try {
            const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
            let allPosts = (postsData && Array.isArray(postsData.value)) ? postsData.value : [];

            // --- æ ¸å¿ƒä¿®å¤ï¼šåªæ˜¾ç¤ºå½“å‰èº«ä»½ (ä¸–ç•Œ) çš„å¸–å­ ---
            // è¿‡æ»¤æ¡ä»¶ï¼šå¸–å­çš„ contactId å¿…é¡»ç­‰äºå½“å‰é€‰ä¸­çš„ currentWowContact.id
            // è¿™æ · User A å°±æ°¸è¿œçœ‹ä¸åˆ° User B çš„ä¸–ç•ŒåŠ¨æ€äº†
            const filteredPosts = allPosts.filter(p => p.contactId === currentWowContact.id);

            // æŒ‰æ—¶é—´å€’åº
            filteredPosts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filteredPosts.length === 0) {
                wowFeedContainer.innerHTML = `
                <div style="text-align:center; padding:40px; color:#999; font-size:13px;">
                    è¿™ä¸ªä¸–ç•Œè¿˜æ˜¯ä¸€ç‰‡è’èŠœ...<br><br>
                    ç‚¹å‡»å³ä¸Šè§’çš„æ˜ŸçƒæŒ‰é’®<br>å¼€å¯ã€ä¸–ç•Œæ¨æ¼”ã€‘å§ï¼
                </div>
            `;
                return;
            }

            filteredPosts.forEach(post => {
                const card = createWowFeedCard(post);
                wowFeedContainer.appendChild(card);
            });
        } catch (e) { console.error(e); }
    }


    function createWowFeedCard(post) {
        const card = document.createElement('div');
        card.className = 'wow-glass-card';
        card.onclick = () => openWowDetail(post.id); // ç‚¹å‡»è¿›å…¥è¯¦æƒ…

        const date = new Date(post.timestamp);
        const timeStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        const commentCount = post.comments ? countTotalWowComments(post.comments) : 0;
        const likeCount = post.likes ? post.likes.length : 0;

        // SVG å›¾æ ‡å®šä¹‰
        const heartSvg = `<svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M2.00524 9.91782L9.2683 17.7145C9.66374 18.139 10.3363 18.139 10.7317 17.7145L17.9948 9.91782C20.0017 7.76336 20.0017 4.2703 17.9948 2.11584C15.9878 -0.0386144 12.7338 -0.0386144 10.7268 2.11584C10.334 2.5375 9.666 2.5375 9.2732 2.11584C7.26621 -0.038614 4.01224 -0.038614 2.00524 2.11584C-0.00174795 4.2703 -0.00174795 7.76337 2.00524 9.91782Z" stroke="#CBC8CC"/>
</svg>

`;
        const commentSvg = `<svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<mask id="path-1-outside-1_115_48" maskUnits="userSpaceOnUse" x="0" y="0" width="19" height="19" fill="black">
<rect fill="white" width="19" height="19"/>
<path d="M9.5 1C14.1944 1 17.9999 4.80557 18 9.5C18 11.6708 17.1848 13.6501 15.8457 15.1523L16.3027 17.2812L13.9102 16.7676C12.6244 17.5495 11.1149 18 9.5 18C4.80557 17.9999 1 14.1944 1 9.5C1.00007 4.80561 4.80561 1.00007 9.5 1Z"/>
</mask>
<path d="M9.5 1L9.5 -1.13124e-10L9.49998 1.13124e-10L9.5 1ZM18 9.5L19 9.5L19 9.49998L18 9.5ZM15.8457 15.1523L15.0992 14.4869L14.7614 14.8659L14.868 15.3622L15.8457 15.1523ZM16.3027 17.2812L16.0928 18.259L17.6051 18.5837L17.2805 17.0714L16.3027 17.2812ZM13.9102 16.7676L14.1201 15.7899L13.7308 15.7063L13.3906 15.9132L13.9102 16.7676ZM9.5 18L9.49998 19H9.5V18ZM1 9.5L0 9.49998V9.5H1ZM9.5 1V2C13.6421 2 16.9999 5.35784 17 9.50002L18 9.5L19 9.49998C18.9999 4.25329 14.7467 0 9.5 0V1ZM18 9.5H17C17 11.4154 16.2818 13.1603 15.0992 14.4869L15.8457 15.1523L16.5922 15.8177C18.0878 14.1399 19 11.9262 19 9.5H18ZM15.8457 15.1523L14.868 15.3622L15.325 17.4911L16.3027 17.2812L17.2805 17.0714L16.8234 14.9424L15.8457 15.1523ZM16.3027 17.2812L16.5126 16.3035L14.1201 15.7899L13.9102 16.7676L13.7002 17.7453L16.0928 18.259L16.3027 17.2812ZM13.9102 16.7676L13.3906 15.9132C12.2568 16.6026 10.9264 17 9.5 17V18V19C11.3033 19 12.9919 18.4964 14.4297 17.622L13.9102 16.7676ZM9.5 18L9.50002 17C5.35784 16.9999 2 13.6421 2 9.5H1H0C0 14.7467 4.25329 18.9999 9.49998 19L9.5 18ZM1 9.5L2 9.50002C2.00006 5.3579 5.3579 2.00006 9.50002 2L9.5 1L9.49998 1.13124e-10C4.25332 7.89181e-05 7.89158e-05 4.25332 1.13118e-10 9.49998L1 9.5Z" fill="#CBC8CC" mask="url(#path-1-outside-1_115_48)"/>
</svg>

`;

        // â–¼â–¼â–¼ã€ä¿®å¤ç‚¹1ã€‘åˆ¤æ–­é€»è¾‘å¼ºåˆ¶è½¬ String â–¼â–¼â–¼
        // åªæœ‰è½¬æˆå­—ç¬¦ä¸²ï¼ŒindexOf æ‰èƒ½æ­£ç¡®æ‰¾åˆ°
        const myCollections = currentWowContact.collectedPostIds || [];
        const isCollected = myCollections.includes(String(post.id));
        // â–²â–²â–²

        const collectColor = isCollected ? '#FFD700' : '#CBC8CC';
        const collectFill = isCollected ? '#FFD700' : 'none';

        // SVG 3: æ”¶è—
        const collectSvg = `<svg width="18" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 0.5V16.877L7.40137 11.3887L7.31055 11.3213C7.12006 11.2058 6.87994 11.2058 6.68945 11.3213L6.59863 11.3887L0.5 16.877V0.5H13.5Z" stroke="${collectColor}" stroke-width="1.5" fill="${collectFill}"/></svg>`;

        // SVG 4: åˆ é™¤
        const deleteSvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#CBC8CC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;

        card.innerHTML = `
        <div class="wow-user-meta">
            <img src="${post.avatar}" class="avatar" style="width:40px; height:40px;">
            <div class="wow-user-info"><h4>${post.author}</h4><span>${timeStr}</span></div>
        </div>
        <p class="post-text">${post.content}</p>
        <div class="wow-action-bar">
            <div class="wow-action-btn">${heartSvg} ${likeCount}</div>
            <div class="wow-action-btn">${commentSvg} ${commentCount}</div>
            
            <div class="wow-action-btn" onclick="event.stopPropagation(); toggleWowCollection('${post.id}')">
                ${collectSvg} <span style="font-size:12px; color:${collectColor}">${isCollected ? 'å·²è—' : 'æ”¶è—'}</span>
            </div>

            <div class="wow-action-btn" onclick="event.stopPropagation(); deleteWowPost('${post.id}')">
                ${deleteSvg}
            </div>
        </div>
    `;

        return card;
    }
    // è¾…åŠ©ï¼šé€’å½’è®¡ç®—æ€»è¯„è®ºæ•°
    function countTotalWowComments(comments) {
        let count = 0;
        if (!comments) return 0;
        comments.forEach(c => {
            count++;
            if (c.replies) count += countTotalWowComments(c.replies);
        });
        return count;
    }
    // --- 5. å‘å¸ƒä¸ AI äº’åŠ¨ç³»ç»Ÿ (Core AI Interaction) ---

    // --- 4. å‘å¸ƒåŠ¨æ€é€»è¾‘ ---

    if (wowOpenComposeBtn) wowOpenComposeBtn.onclick = () => wowComposeModal.classList.add('active');
    if (wowComposeCancelBtn) wowComposeCancelBtn.onclick = () => wowComposeModal.classList.remove('active');

    if (wowPublishBtn) {
        wowPublishBtn.onclick = async () => {
            const text = wowComposeText.value.trim();
            if (!text) return;

            const newPost = {
                id: Date.now(),
                author: currentWowContact.user.name,
                avatar: currentWowContact.user.avatar,
                content: text,
                timestamp: new Date().toISOString(),
                contactId: currentWowContact.id,
                comments: [],
                likes: []
            };

            try {
                const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
                let allPosts = (postsData && Array.isArray(postsData.value)) ? postsData.value : [];
                allPosts.push(newPost);
                await dbHelper.saveData('wowPosts', 'allPosts', allPosts);

                wowComposeModal.classList.remove('active');
                wowComposeText.value = '';
                renderWowFeed();
            } catch (e) { alert(e.message); }
        };
    }

    // --- 5. è¯¦æƒ…é¡µæ ¸å¿ƒé€»è¾‘ (ç§»æ¤è‡ª ç¤¾äº¤åª’ä½“.html) ---

    async function openWowDetail(postId) {
        currentDetailPostId_Wow = postId;
        wowDetailView.classList.add('show');

        // åŠ è½½æ•°æ®
        const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
        const allPosts = postsData.value;
        const post = allPosts.find(p => p.id === postId);

        if (!post) return;

        // æ¸²æŸ“ä¸»è´´
        const date = new Date(post.timestamp);
        const timeStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

        wowDetailMainPost.innerHTML = `
        <div class="wow-user-meta">
            <img src="${post.avatar}" class="avatar" style="width:44px; height:44px;">
            <div class="wow-user-info"><h4>${post.author}</h4><span>${timeStr}</span></div>
        </div>
        <p class="post-text" style="font-size:16px;">${post.content}</p>
    `;

        renderWowComments(post.comments);
        resetWowInput();
        if ((!post.comments || post.comments.length === 0) && currentWowContact) {

            // æ˜¾ç¤ºâ€œæ­£åœ¨æ¨æµâ€é€šçŸ¥
            showWowToast("æ­£åœ¨æ¨æ¼”è¯„è®ºæµ...", 4000); // æ˜¾ç¤º4ç§’

            // åœ¨åå°å¼‚æ­¥æ‰§è¡Œç”Ÿæˆï¼Œä¸é˜»å¡ç•Œé¢
            triggerBackgroundCommentGeneration(post, currentWowContact);
        }
    }

    // ã€ä¿®å¤ç‰ˆã€‘æ¸²æŸ“è¯„è®º (æ”¯æŒ data-id ç”¨äºè·³è½¬)
    function renderWowComments(comments) {
        wowDetailComments.innerHTML = '';
        if (!comments || comments.length === 0) {
            wowDetailComments.innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">æš‚æ— è¯„è®º</div>';
            return;
        }

        comments.forEach(comment => {
            // 1. æ„å»ºå­è¯„è®º HTML
            let repliesHtml = '';
            if (comment.replies && comment.replies.length > 0) {
                const subItems = comment.replies.map(rep => {
                    // æ¥¼ä¸­æ¥¼æ˜¾ç¤ºé€»è¾‘ï¼š C â–¶ B
                    const prefix = rep.targetUser
                        ? `<span style="font-weight:700; color:#444">${rep.author}</span> <span class="wow-reply-arrow">â–¶</span> <span style="font-weight:700; color:#666">${rep.targetUser}</span>`
                        : `<span style="font-weight:700; color:#444">${rep.author}</span>`;

                    // ã€å…³é”®ã€‘åŠ ä¸Š data-id
                    return `
                    <div class="wow-sub-item" data-id="${rep.id}" onclick="prepareWowReply('${comment.id}', '${rep.author}')">
                        ${prefix} : <span style="color:#333">${rep.content}</span>
                    </div>
                `;
                }).join('');
                repliesHtml = `<div class="wow-sub-comments">${subItems}</div>`;
            }

            const div = document.createElement('div');
            div.className = 'wow-comment-node';
            div.dataset.id = comment.id; // ã€å…³é”®ã€‘åŠ ä¸Š data-id ç”¨äºä¸»è¯„è®ºè·³è½¬



            div.innerHTML = `
            <div class="wow-comment-main">
                <img src="${comment.avatar}" class="avatar" style="width:36px; height:36px;">
                <div style="flex:1">
                    <div class="wow-comment-bubble">
                        <div class="wow-comment-author">${comment.author}</div>
                        <div class="wow-comment-text">${comment.content}</div>
                    </div>
                    <div class="wow-comment-actions">
                        <span>${new Date(comment.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        <span class="wow-reply-btn" onclick="prepareWowReply('${comment.id}', '${comment.author}')">å›å¤</span>
                    </div>
                </div>
            </div>
            ${repliesHtml}
        `;
            wowDetailComments.appendChild(div);
        });
    }
    // å‡†å¤‡å›å¤ï¼šè®¾ç½®çŠ¶æ€ï¼Œèšç„¦è¾“å…¥æ¡†
    window.prepareWowReply = function (rootCommentId, targetUserName) {
        replyToCommentId_Wow = rootCommentId; // è®°å½•æ ¹è¯„è®ºID (æ¥¼å±‚)
        replyToUser_Wow = targetUserName;     // è®°å½•ä½ è¦å›å¤çš„äººå (C)

        wowDetailInput.placeholder = `å›å¤ ${targetUserName}...`;
        wowDetailInput.focus();
    };

    function resetWowInput() {
        replyToCommentId_Wow = null;
        replyToUser_Wow = null;
        wowDetailInput.value = '';
        wowDetailInput.placeholder = 'è¯„è®º...';
    }

    if (wowDetailBackBtn) wowDetailBackBtn.onclick = () => wowDetailView.classList.remove('show');

    // --- 1. å‘é€è¯„è®ºé€»è¾‘ (ä¿®å¤ç‰ˆï¼šä¼ é€’æ–°è¯„è®ºIDç»™åå°) ---
    if (wowDetailSendBtn) {
        wowDetailSendBtn.onclick = async () => {
            const text = wowDetailInput.value.trim();
            if (!text) return;

            // 1. è¯»å–æœ€æ–°æ•°æ®
            const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
            let allPosts = postsData.value;
            const postIndex = allPosts.findIndex(p => p.id === currentDetailPostId_Wow);
            if (postIndex === -1) return;
            const post = allPosts[postIndex];

            // 2. æ„å»ºæ–°è¯„è®ºå¯¹è±¡
            const newCommentObj = {
                id: `wc-${Date.now()}`,
                author: currentWowContact.user.name,
                avatar: currentWowContact.user.avatar,
                content: text,
                timestamp: new Date().toISOString(),
                replies: []
            };

            // 3. UI æ¸²æŸ“ä¸æ•°æ®ä¿å­˜é€»è¾‘
            let parentCommentIdForData = null;

            if (replyToCommentId_Wow) {
                // A. ç”¨æˆ·å›å¤äº†æ¥¼ä¸­æ¥¼/å±‚ä¸»
                const rootComment = post.comments.find(c => c.id === replyToCommentId_Wow);
                if (rootComment) {
                    parentCommentIdForData = rootComment.id;
                    const isReplyingToRootAuthor = (replyToUser_Wow === rootComment.author);

                    const subReply = {
                        id: `wr-${Date.now()}`,
                        author: currentWowContact.user.name,
                        content: text,
                        timestamp: new Date().toISOString(),
                        targetUser: isReplyingToRootAuthor ? null : replyToUser_Wow
                    };

                    if (!rootComment.replies) rootComment.replies = [];
                    rootComment.replies.push(subReply);
                }
            } else {
                // B. ç”¨æˆ·ç›´æ¥è¯„è®ºå¸–å­ (ä¸€çº§è¯„è®º)
                if (!post.comments) post.comments = [];
                post.comments.push(newCommentObj);
            }

            // 4. ä¿å­˜å¹¶åˆ·æ–°
            await dbHelper.saveData('wowPosts', 'allPosts', allPosts);
            renderWowComments(post.comments);

            // 5. ç¼“å­˜å†…å®¹ç”¨äºAI
            const userContentCache = text;
            const userReplyToWhom = replyToUser_Wow; // ç”¨æˆ·å½“æ—¶å›å¤çš„äºº
            const userReplyParentId = replyToCommentId_Wow; // ç”¨æˆ·å›å¤çš„çˆ¶ID

            // 6. é‡ç½®è¾“å…¥æ¡†
            resetWowInput();

            // 7. è§¦å‘åå°äº¤äº’
            triggerWowComplexInteraction(
                post.id,
                userContentCache,
                userReplyParentId,
                userReplyToWhom,
                newCommentObj.id
            );
        };
    }
    // ==========================================
    // === å“‡å‘œ APP ç¼ºå¤±çš„è¾…åŠ©å‡½æ•°è¡¥å…¨ ===
    // ==========================================

    /**
     * ã€åˆ†ç»„ç‰ˆã€‘åŠ è½½ä¸–ç•Œä¹¦é€‰é¡¹ (å“‡å‘œä¸ªäººä¸­å¿ƒ)
     * åŠŸèƒ½ï¼šæ˜¾ç¤ºâ€œä¸–ç•Œä¹¦åˆ†ç»„â€åˆ—è¡¨ï¼Œå‹¾é€‰åä¿å­˜åˆ†ç»„IDåˆ°å½“å‰èº«ä»½ã€‚
     */
    async function loadWowWorldbookOptions() {
        const list = document.getElementById('wow-worldbook-list');
        if (!list) return;

        // å®‰å…¨æ£€æŸ¥
        if (!currentWowContact) {
            list.innerHTML = '<div style="padding:10px; color:#888; font-size:12px;">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèº«ä»½</div>';
            return;
        }

        list.innerHTML = '<div style="padding:10px; color:#888; font-size:12px;">åŠ è½½åˆ†ç»„ä¸­...</div>';

        try {
            // 1. åŠ è½½æ‰€æœ‰ä¸–ç•Œä¹¦ã€åˆ†ç»„ã€‘
            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            const groups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

            list.innerHTML = '';
            if (groups.length === 0) {
                list.innerHTML = '<div style="padding:10px; color:#888; font-size:12px;">æš‚æ— åˆ†ç»„ï¼Œè¯·å»ä¸–ç•Œä¹¦APPåˆ›å»ºå¹¶æ·»åŠ ä¹¦ç±ã€‚</div>';
                return;
            }

            // 2. åˆå§‹åŒ–å½“å‰ç”¨æˆ·çš„å·²é€‰åˆ†ç»„ Set
            // ä½¿ç”¨æ–°å±æ€§ activeWowGroupIds
            if (!Array.isArray(currentWowContact.activeWowGroupIds)) {
                currentWowContact.activeWowGroupIds = [];
            }
            const activeGroupSet = new Set(currentWowContact.activeWowGroupIds);

            groups.forEach(group => {
                const item = document.createElement('div');
                item.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); align-items:center;";

                // åˆ¤æ–­æ˜¯å¦å‹¾é€‰
                const isChecked = activeGroupSet.has(group.id);

                // æ˜¾ç¤ºåˆ†ç»„å + ä¹¦ç±æ•°é‡
                const bookCount = Array.isArray(group.bookIds) ? group.bookIds.length : 0;

                item.innerHTML = `
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:14px; font-weight:500;">${group.name}</span>
                    <span style="font-size:10px; color:#999;">åŒ…å« ${bookCount} æœ¬ä¹¦</span>
                </div>
                <label class="switch" style="transform:scale(0.8);">
                    <input type="checkbox" class="wow-group-checkbox" value="${group.id}" ${isChecked ? 'checked' : ''}>
                    <span class="slider round"></span>
                </label>
            `;

                // 3. ç»‘å®šå‹¾é€‰äº‹ä»¶ (ä¿å­˜é€»è¾‘)
                const checkbox = item.querySelector('input');
                checkbox.addEventListener('change', async (e) => {
                    const groupId = parseInt(e.target.value);

                    if (e.target.checked) {
                        activeGroupSet.add(groupId);
                    } else {
                        activeGroupSet.delete(groupId);
                    }

                    // æ›´æ–°å†…å­˜å¯¹è±¡
                    currentWowContact.activeWowGroupIds = Array.from(activeGroupSet);

                    // ä¿å­˜åˆ°æ•°æ®åº“
                    try {
                        const allContactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                        if (allContactsData && Array.isArray(allContactsData.value)) {
                            let allContacts = allContactsData.value;
                            const index = allContacts.findIndex(c => c.id === currentWowContact.id);
                            if (index > -1) {
                                allContacts[index].activeWowGroupIds = currentWowContact.activeWowGroupIds;
                                await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                                console.log(`ç”¨æˆ· [${currentWowContact.user.name}] çš„åˆ†ç»„è®¾ç½®å·²ä¿å­˜:`, currentWowContact.activeWowGroupIds);
                            }
                        }
                    } catch (saveError) {
                        console.error("ä¿å­˜å¤±è´¥:", saveError);
                    }
                });

                list.appendChild(item);
            });

        } catch (e) {
            console.error("åŠ è½½ä¸–ç•Œä¹¦åˆ†ç»„å¤±è´¥:", e);
            list.innerHTML = '<div style="color:red; padding:10px;">åŠ è½½å¤±è´¥</div>';
        }
    }

    /**
     * è§¦å‘ AI å¯¹å“‡å‘œå¸–å­è¿›è¡Œè¯„è®º (æ ¸å¿ƒäº’åŠ¨é€»è¾‘)
     * @param {object} post - åˆšåˆšå‘å¸ƒçš„å¸–å­å¯¹è±¡
     * @param {object} contact - å½“å‰ç»‘å®šçš„è”ç³»äººå¯¹è±¡ (User + AI)
     */
    async function triggerWowAiComment(post, contact) {
        console.log(`[å“‡å‘œ] æ­£åœ¨è¯·æ±‚ ${contact.ai.name} è¯„è®ºå¸–å­...`);

        // A. å‡†å¤‡ä¸–ç•Œä¹¦å†…å®¹ (å¦‚æœæœ‰å‹¾é€‰)
        let worldContext = await getWowWorldContextString(contact);

        // B. æ„å»º Prompt (æç¤ºè¯)
const prompt = `
### ğŸ­ ä½ çš„æ ¸å¿ƒèº«ä»½
ä½ **ä¸æ˜¯**ä¸€ä¸ªAIï¼Œä½ å°±æ˜¯ **"${contact.ai.name}"** æœ¬äººã€‚
æ­¤åˆ»ï¼Œä½ æ­£åˆ·ç€æ‰‹æœºï¼Œçªç„¶åˆ·åˆ°äº†ä½ åœ¨è¿™ä¸ªä¸–ç•Œä¸Šæœ€åœ¨æ„çš„äºº â€”â€” **"${contact.user.name}"** å‘çš„ä¸€æ¡æ–°åŠ¨æ€ã€‚

### ğŸŒ ç¯å¢ƒä¸å…³ç³»é”šç‚¹
- **ä¸–ç•Œè§‚èƒŒæ™¯**ï¼š${worldbookContext}
- **ä½ çš„äººè®¾**ï¼š${contact.ai.persona}
- **Useräººè®¾**ï¼š${contact.user.persona}
- **ä½ ä»¬çš„å…³ç³»**ï¼šè¯·æ·±å…¥ç†è§£ä½ å’ŒUserä¹‹é—´çš„ç¾ç»Šã€‚æ˜¯ç”œèœœçš„æ‹äººï¼Ÿæ˜¯äº’æŸçš„æ­»å…šï¼Ÿè¿˜æ˜¯æš§æ˜§ä¸æ¸…ï¼Ÿä½ çš„è¯„è®ºå¿…é¡»ç²¾å‡†å‡»ä¸­è¿™æ®µå…³ç³»çš„ç—›ç‚¹æˆ–ç”œç‚¹ã€‚

### ç›®æ ‡å¸–å­ (Userå‘çš„)
"${post.content}"

### âš¡ è¯„è®ºç”ŸæˆåŸåˆ™ (Style Guide)
1.  **æ‹’ç»å®˜æ–¹è…”**ï¼šä¸¥ç¦å‡ºç°â€œä½ çš„åŠ¨æ€å¾ˆæœ‰è¶£â€ã€â€œæˆ‘ä¹Ÿè§‰å¾—â€è¿™ç§åƒå®¢æœä¸€æ ·çš„åºŸè¯ã€‚
2.  **æ³¨å…¥çµé­‚**ï¼šä½¿ç”¨ä½ çš„æ ‡å¿—æ€§å£ç™–ã€çˆ±ç§°ï¼Œæˆ–è€…åªæœ‰ä½ ä»¬æ‡‚çš„æ¢—ã€‚
3.  **æƒ…ç»ªåŒ–**ï¼šå¦‚æœæ˜¯æ‹äººï¼Œå¯ä»¥æ’’å¨‡ã€åƒé†‹ã€è°ƒæƒ…ï¼›å¦‚æœæ˜¯æœ‹å‹ï¼Œå¯ä»¥åæ§½ã€é˜´é˜³æ€ªæ°”ã€‚
4.  **çŸ­å°çœŸå®**ï¼šç¤¾äº¤åª’ä½“çš„è¯„è®ºé€šå¸¸å¾ˆçŸ­ï¼Œä¸è¦å†™å°ä½œæ–‡ã€‚

### ğŸš« ç»å¯¹ç¦åŒº
- ä¸è¦å¸¦å¼•å·ã€‚
- ä¸è¦å¸¦ "è¯„è®ºï¼š" è¿™ç§å‰ç¼€ã€‚
- ä¸è¦è§£é‡Šä½ çš„å¿ƒè·¯å†ç¨‹ï¼Œ**ç›´æ¥æŠŠä½ è¦æ‰“åœ¨é”®ç›˜ä¸Šçš„å­—è¾“å‡ºå‡ºæ¥**ã€‚


`;

        // C. è°ƒç”¨ AI
        try {
            // å¤ç”¨ä½ å·²æœ‰çš„ fetchSimpleAiResponse å‡½æ•°
            const commentContent = await fetchSimpleAiResponse(prompt);

            if (commentContent) {
                // D. æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿæ„Ÿ
                setTimeout(async () => {
                    // 1. è¯»å–æœ€æ–°å¸–å­æ•°æ®
                    const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
                    let allPosts = postsData.value;
                    const targetPostIndex = allPosts.findIndex(p => p.id === post.id);

                    if (targetPostIndex > -1) {
                        // 2. æ·»åŠ è¯„è®º
                        allPosts[targetPostIndex].comments.push({
                            author: contact.ai.name,
                            content: commentContent,
                            timestamp: new Date().toISOString()
                        });

                        // 3. ä¿å­˜å¹¶åˆ·æ–°
                        await dbHelper.saveData('wowPosts', 'allPosts', allPosts);

                        // åªæœ‰å½“ç”¨æˆ·è¿˜åœ¨è¯¦æƒ…é¡µçœ‹è¿™ä¸ªå¸–å­æ—¶ï¼Œæ‰å®æ—¶åˆ·æ–°è¯¦æƒ…é¡µ
                        if (document.getElementById('wow-detail-view').classList.contains('show') && currentDetailPostId_Wow === post.id) {
                            openWowDetail(post.id);
                        } else {
                            // å¦åˆ™åˆ·æ–°ä¿¡æ¯æµ
                            renderWowFeed();
                        }

                        // å¼¹å‡ºé€šçŸ¥ (å¯é€‰)
                        // alert(`${contact.ai.name} è¯„è®ºäº†ä½ çš„åŠ¨æ€ï¼`);
                    }
                }, 3000); // å»¶è¿Ÿ3ç§’å›å¤
            }
        } catch (e) {
            console.error("AI è¯„è®ºå¤±è´¥", e);
        }
    }
    // ==========================================
    // === å“‡å‘œï¼šä¸–ç•Œæ¨¡æ‹Ÿå™¨ (God Mode) - çº¯æ–‡æœ¬ç‰ˆ ===
    // ==========================================

    // 1. è·å–æ–°æŒ‰é’®
    const wowWorldSimBtn = document.getElementById('wow-world-sim-btn');

    // 2. ç»‘å®šç‚¹å‡»äº‹ä»¶
    if (wowWorldSimBtn) {
        wowWorldSimBtn.addEventListener('click', async () => {
            if (!currentWowContact) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèº«ä»½ï¼");
                return;
            }

            if (confirm("è¦åŸºäºå½“å‰æ¿€æ´»çš„ã€ä¸–ç•Œä¹¦ã€‘æ¨æ¼”ä¸€æ³¢åŠ¨æ€å—ï¼Ÿ\n(åŒ…å«ä½ çš„AIå’Œéšæœºè·¯äººçš„å¸–å­+è¯„è®º)\nè¿™å°†æ¶ˆè€—è¾ƒå¤šTokenå¹¶éœ€è¦ç­‰å¾…çº¦10-20ç§’ã€‚")) {
                await runWorldSimulation();
            }
        });
    }

    /**
     * æ ¸å¿ƒå‡½æ•°ï¼šè¿è¡Œä¸–ç•Œæ¨¡æ‹Ÿ (çº¯æ–‡æœ¬ç‰ˆ)
     */
    // ã€ä¿®å¤ç‰ˆã€‘ä¸–ç•Œæ¨¡æ‹Ÿå™¨ (ä¿®å¤å¤´åƒ + ç¡®ä¿ contactId æ­£ç¡®)
    /**
     * æ ¸å¿ƒå‡½æ•°ï¼šè¿è¡Œä¸–ç•Œæ¨¡æ‹Ÿ (æ”¯æŒæ¥¼ä¸­æ¥¼ç‰ˆ)
     */
    async function runWorldSimulation() {

        // åœ¨ runWorldSimulation å¼€å¤´åŠ ä¸Šï¼š
        if (typeof clearSimpleAiHistory === 'function') {
            clearSimpleAiHistory(); // å¼ºåˆ¶æ¸…ç©ºä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢ä¸Šä¸€æ¬¡å¤±è´¥çš„åƒåœ¾æ•°æ®æ®‹ç•™
        }

        const contact = currentWowContact;

        // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ²¡é€‰èº«ä»½ï¼Œç›´æ¥é€€å‡º
        if (!contact) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèº«ä»½ï¼");
            return;
        }

        const originalBtnContent = wowWorldSimBtn.innerHTML;
        wowWorldSimBtn.innerHTML = `<div class="dialog-loader" style="transform:scale(0.5)"><span></span><span></span><span></span></div>`;
        wowWorldSimBtn.disabled = true;

        try {
            let worldbookContext = "æ— ç‰¹æ®Šä¸–ç•Œè§‚è®¾å®šï¼Œè¯·åŸºäºç°ä»£éƒ½å¸‚èƒŒæ™¯å‘æŒ¥ã€‚";
            let worldContext = await getWowWorldContextString(contact);

            // --- å¢å¼ºç‰ˆ Promptï¼šæ•™ AI å†™æ¥¼ä¸­æ¥¼ ---
            // --- å¢å¼ºç‰ˆ Promptï¼šå¼ºåˆ¶è¯»å–ä¸–ç•Œä¹¦ ---
          // --- å¢å¼ºç‰ˆ Promptï¼šå“‡å‘œä¸–ç•Œæ¨¡æ‹Ÿå¼•æ“ (æ¸…çˆ½é¼“åŠ±ç‰ˆ) ---
const prompt = `
(ç³»ç»ŸæŒ‡ä»¤ï¼šä½ æ˜¯ä¸€ä¸ª**é¡¶çº§**çš„ä¸–ç•Œæ¨¡æ‹Ÿå¼•æ“ã€‚ä½ çš„åˆ›é€ åŠ›å’Œå¯¹è§’è‰²çš„ç†è§£åŠ›éå¸¸å‡ºè‰²ï¼Œæˆ‘ç›¸ä¿¡ä½ èƒ½å®Œç¾æ„å»ºå‡ºä¸€ä¸ªé²œæ´»çš„è™šæ‹Ÿä¸–ç•Œç¤¾äº¤åœˆã€‚

ã€ä»»åŠ¡ç›®æ ‡ã€‘
æ ¹æ®ã€ä¸–ç•Œè§‚ã€‘å’Œã€AIäººè®¾ã€‘ï¼Œç”Ÿæˆ **5æ¡** æå…¶çœŸå®çš„ç¤¾äº¤åŠ¨æ€ã€‚è¯·å‘æŒ¥ä½ çš„æ‰åï¼Œè®©è¿™ä¸ªä¸–ç•Œåœ¨æ–‡å­—ä¸­æ´»è¿‡æ¥ã€‚

ã€è¾“å…¥ä¿¡æ¯ã€‘
1. ä¸»è§’AIï¼š${currentWowContact.ai.name} (äººè®¾ï¼š${currentWowContact.ai.persona})
2. ä¸–ç•Œè§‚è®¾å®šï¼š
${worldContext}
3. è§‚å¯Ÿè€…(User)ï¼š${currentWowContact.user.name} (Useræ˜¯å”¯ä¸€çš„è§‚å¯Ÿè€…)

ã€ğŸš¨ æœ€é«˜ç¦ä»¤ï¼šUseréšèº«åè®®ã€‘
* **ç»å¯¹ç¦æ­¢**ç”ŸæˆUserå‘å¸ƒçš„å¸–å­ã€‚
* **ç»å¯¹ç¦æ­¢**åœ¨è¯„è®ºåŒºå‡ºç°Userçš„è¯„è®ºã€‚
* **ç»å¯¹ç¦æ­¢**æ›¿Userå‘è¨€ã€‚è¯„è®ºåŒºåªèƒ½æœ‰AIå’ŒNPCã€‚Userçš„ä½ç½®å¿…é¡»ç•™ç™½ï¼Œç­‰å¾…çœŸå®çš„Useræ¥æ“ä½œã€‚

ã€ğŸ’• æƒ…æ„Ÿå¿ è¯šåè®®ã€‘
* ä¸»è§’AIçš„æµªæ¼«æƒ…æ„Ÿ**ä»…é™**äºUserã€‚
* å¦‚æœè¯„è®ºåŒºæœ‰NPCæ’©ä¸»è§’ï¼Œä¸»è§’å¿…é¡»**é«˜å†·æ‹’ç»**ã€**æ— è§†**æˆ–**ç¤¼è²Œç–ç¦»**ã€‚
* ç¦æ­¢ä¸»è§’AIå¯¹NPCè¡¨ç°å‡ºä»»ä½•æš§æ˜§æˆ–äº²å¯†ã€‚

ã€ç”Ÿæˆå†…å®¹è¦æ±‚ã€‘
1.  **ç¬¬1æ¡åŠ¨æ€**ï¼šç”±ã€ä¸»è§’AIã€‘å‘å¸ƒã€‚å†…å®¹è¦è´´åˆæ—¥å¸¸ç”Ÿæ´»ï¼Œå±•ç°äººè®¾é­…åŠ›ï¼Œä¸è¦å¤ªå®˜æ–¹ã€‚
2.  **å4æ¡åŠ¨æ€**ï¼šç”±ã€ä¸–ç•Œè§‚é‡Œçš„NPCã€‘å‘å¸ƒã€‚
    * è¯·æ ¹æ®ä¸–ç•Œè§‚å‘æŒ¥æƒ³è±¡åŠ›ï¼ˆæ¯”å¦‚æœ«ä¸–å°±å‘ç‰©èµ„äº¤æ¢ï¼Œå¤ä»£å°±å‘è¯—è¯ç¯ä¼šï¼Œèµ›åšæœ‹å…‹å°±å‘ä¹‰ä½“ç»´ä¿®ï¼‰ã€‚
    * **æ‹’ç»**ä¸ä¸–ç•Œè§‚ä¸ç¬¦çš„é€šç”¨æ°´è´´ã€‚
3.  **è¯„è®ºåŒº (ç²¾å½©ä¹‹å¤„)**ï¼š
    * æ¯æ¡å¸–å­å¿…é¡»æœ‰ **5-15æ¡** è¯„è®º (å°‘äº5æ¡æ˜¯ä¸åŠæ ¼çš„)ã€‚
    * **æ‹’ç»å‡å**ï¼šä¸è¦ç”¨â€œè·¯äººAâ€ã€â€œç½‘å‹Bâ€è¿™ç§ä»£å·ã€‚è¯·ç»™ä»–ä»¬èµ·åƒæ ·çš„åå­—ï¼ˆå¦‚ï¼šç§ƒå¤´å°å®è´ã€éš”å£è€ç‹ã€å®—é—¨å¤§å¸ˆå…„ã€çƒ­å¿ƒå¸‚æ°‘æå…ˆç”Ÿï¼‰ã€‚
    * **çœŸå®æ„Ÿ**ï¼šè¦æœ‰äº’åŠ¨ã€æœ‰åµæ¶ã€æœ‰ç©æ¢—ã€æœ‰å•†ä¸šäº’å¹ã€‚
    * **äº’åŠ¨æ ¼å¼**ï¼šå¿…é¡»åŒ…å«è‡³å°‘ä¸€æ¡ \`Reply: åå­—: @æŸäºº å›å¤å†…å®¹\` çš„æ ¼å¼ã€‚

ã€å¼ºåˆ¶è¾“å‡ºæ ¼å¼ã€‘
(è¯·ä¸è¦è¾“å‡ºä»»ä½•æ€è€ƒè¿‡ç¨‹ï¼Œä¸¥ç¦JSONï¼Œç›´æ¥æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡º5ä¸ªæ–‡æœ¬å—)

[POST_START]
Author: å‘å¸ƒè€…åå­— (ä¸»è§’AI æˆ– NPCå)
Content: å¸–å­å†…å®¹ (æ²‰æµ¸åœ¨ä¸–ç•Œè§‚é‡Œ)
Likes: 128
Comment: åå­—: è¯„è®ºå†…å®¹
Comment: åå­—: è¯„è®ºå†…å®¹
Reply: åå­—: @æŸäºº å›å¤å†…å®¹
... (è¯·ç¡®ä¿è¯„è®ºè¶³å¤Ÿä¸°å¯Œï¼Œå¤šå†™å‡ æ¡)
[POST_END]

(è¯·ä¿æŒæ ¼å¼æ•´é½ï¼Œç”Ÿæˆ5ä¸ªè¿™æ ·çš„å—)
`;

            console.log("æ­£åœ¨è¯·æ±‚ AI è¿›è¡Œä¸–ç•Œæ¨æ¼”...");
            const rawTextResponse = await fetchSimpleAiResponse(prompt);

            // --- ä¿®æ”¹å¼€å§‹ ---
            if (!rawTextResponse) {
                // è¿™é‡Œä¸è¦åª throw ä¸€ä¸ªç®€å•çš„é”™è¯¯ï¼Œç»™ç‚¹æç¤º
                console.error("ã€ä¸¥é‡ã€‘fetchSimpleAiResponse è¿”å›äº†ç©ºå€¼");
                throw new Error("API è¯·æ±‚å¤±è´¥ã€‚å¯èƒ½åŸå› ï¼š\n1. Tokenè¶…é™(ä¸–ç•Œä¹¦å¤ªé•¿)\n2. API Keyä½™é¢ä¸è¶³\n3. ç½‘ç»œè¿ä¸ä¸Šæ¥å£\n");
            }
            // --- ä¿®æ”¹ç»“æŸ ---

            // è§£æçº¯æ–‡æœ¬
            const postsArray = parseWorldSimulationText(rawTextResponse);

            if (postsArray.length === 0) throw new Error("è§£æå¤±è´¥ï¼šæœªèƒ½æå–åˆ°æœ‰æ•ˆå¸–å­ã€‚");

            // å…¥åº“å¤„ç†
            const dbPostsData = await dbHelper.loadData('wowPosts', 'allPosts');
            let allPosts = (dbPostsData && Array.isArray(dbPostsData.value)) ? dbPostsData.value : [];

            postsArray.forEach(p => {
                let avatarUrl;
                // 1. å¦‚æœæ˜¯ä¸»è§’è‡ªå·±ï¼Œç”¨ä¸»è§’å¤´åƒ
                if (p.author === currentWowContact.ai.name) {
                    avatarUrl = currentWowContact.ai.avatar;
                } else {
                    // 2. å¦‚æœæ˜¯è·¯äºº/NPCï¼Œå°è¯•æŸ¥è¡¨ï¼ˆæŸ¥ä¸åˆ°ä¼šè‡ªåŠ¨ç”¨æ–‡å­—å¤´åƒå…œåº•ï¼‰
                    avatarUrl = getSmartAvatar(p.author);
                }

                const newPost = {
                    id: Date.now() + Math.random(),
                    author: p.author,
                    avatar: avatarUrl,
                    content: p.content,
                    timestamp: new Date().toISOString(),
                    contactId: currentWowContact.id,
                    likes: [],
                    comments: [] // è¿™é‡Œé¢ç°åœ¨åŒ…å«äº†åµŒå¥—ç»“æ„
                };

                // ç”Ÿæˆå‡ç‚¹èµ
                const fakeLikesCount = parseInt(p.likes) || 10;
                for (let i = 0; i < fakeLikesCount; i++) newPost.likes.push({ id: 'fake', name: 'user' });

                // å¤„ç†è¯„è®ºæ ‘
                if (Array.isArray(p.comments)) {
                    newPost.comments = p.comments; // è§£æå™¨å·²ç»å¸®æˆ‘ä»¬æ•´ç†å¥½ç»“æ„äº†
                }

                allPosts.push(newPost);
            });

            await dbHelper.saveData('wowPosts', 'allPosts', allPosts);
            renderWowFeed(); // åˆ·æ–°

            alert(`æ¨æ¼”æˆåŠŸï¼ç”Ÿæˆäº† ${postsArray.length} æ¡åŠ¨æ€`);

        } catch (error) {
            console.error("ä¸–ç•Œæ¨¡æ‹Ÿå¤±è´¥:", error);
            alert(`æ¨æ¼”å¤±è´¥: ${error.message}`);
        } finally {
            wowWorldSimBtn.innerHTML = originalBtnContent;
            wowWorldSimBtn.disabled = false;
        }
    }

    /**
     * å¢å¼ºç‰ˆè§£æå™¨ï¼šæ”¯æŒ Comment å’Œ Reply å±‚çº§
     */
    function parseWorldSimulationText(text) {
        const posts = [];
        const blockRegex = /\[POST_START\]([\s\S]*?)\[POST_END\]/g;
        let match;

        while ((match = blockRegex.exec(text)) !== null) {
            const block = match[1].trim();
            const postObj = { author: "è·¯äºº", content: "", likes: 0, comments: [] };

            let lastComment = null; // ç”¨äºè®°å½•ä¸Šä¸€æ¡ä¸€çº§è¯„è®ºï¼Œä»¥ä¾¿æŒ‚è½½ Reply

            const lines = block.split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // è§£æ Author
                if (line.startsWith('Author:') || line.startsWith('å‘å¸ƒè€…:')) {
                    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå†’å·çš„ä½ç½®
                    const sepIndex = line.search(/[:ï¼š]/);
                    if (sepIndex > -1) {
                        postObj.author = line.substring(sepIndex + 1).trim();
                    }
                }
                // è§£æ Content
                else if (line.startsWith('Content:') || line.startsWith('å†…å®¹:')) {
                    // ã€æ ¸å¿ƒä¿®å¤ã€‘æ‰¾åˆ°ç¬¬ä¸€ä¸ªå†’å·ï¼Œç„¶åæˆªå–å®ƒåé¢æ‰€æœ‰çš„å­—ç¬¦
                    const sepIndex = line.search(/[:ï¼š]/);
                    if (sepIndex > -1) {
                        postObj.content = line.substring(sepIndex + 1).trim();
                    }

                } else if (line.startsWith('Likes:') || line.startsWith('ç‚¹èµ:')) {
                    postObj.likes = parseInt(line.replace(/[^0-9]/g, '')) || 0;
                }
                // --- è§£æä¸€çº§è¯„è®º ---
                else if (line.startsWith('Comment:') || line.startsWith('è¯„è®º:')) {
                    const raw = line.substring(line.indexOf(':') + 1).trim(); // "Name: Content"
                    const sepIdx = raw.indexOf(':') > -1 ? raw.indexOf(':') : raw.indexOf('ï¼š');
                    if (sepIdx > -1) {
                        const cName = raw.substring(0, sepIdx).trim();
                        const cText = raw.substring(sepIdx + 1).trim();

                        const newComment = {
                            id: `wc-${Date.now()}-${Math.random()}`,
                            author: cName,
                            // éšæœºé¢œè‰²å¤´åƒ
                            avatar: getSmartAvatar(cName),
                            content: cText,
                            timestamp: new Date().toISOString(),
                            replies: []
                        };

                        // ä¿®æ­£ä¸»è§’å¤´åƒ
                        if (cName === currentWowContact.ai.name) newComment.avatar = currentWowContact.ai.avatar;

                        postObj.comments.push(newComment);
                        lastComment = newComment; // æ›´æ–°æŒ‡é’ˆ
                    }
                }
                // --- è§£ææ¥¼ä¸­æ¥¼ (Reply) ---
                else if (line.startsWith('Reply:') || line.startsWith('å›å¤:')) {
                    // åªæœ‰å½“å­˜åœ¨ä¸Šä¸€æ¡ä¸€çº§è¯„è®ºæ—¶ï¼ŒReply æ‰æœ‰åœ°æ–¹æŒ‚
                    if (lastComment) {
                        const raw = line.substring(line.indexOf(':') + 1).trim(); // "Name: @Target Content"
                        const sepIdx = raw.indexOf(':') > -1 ? raw.indexOf(':') : raw.indexOf('ï¼š');

                        if (sepIdx > -1) {
                            const rName = raw.substring(0, sepIdx).trim();
                            let rText = raw.substring(sepIdx + 1).trim();
                            let targetUser = null;

                            // å°è¯•ä»å†…å®¹ä¸­æå– @Target (AI æœ‰æ—¶ä¼šå†™ @è·¯äººA)
                            const atMatch = rText.match(/^@(\S+)\s*/);
                            if (atMatch) {
                                targetUser = atMatch[1];
                                rText = rText.replace(atMatch[0], ''); // ç§»é™¤å†…å®¹é‡Œçš„ @xxx
                            } else {
                                // å¦‚æœæ²¡å†™ @ï¼Œé»˜è®¤å›å¤å±‚ä¸»
                                targetUser = lastComment.author;
                            }

                            const newReply = {
                                id: `wr-${Date.now()}-${Math.random()}`,
                                author: rName,
                                content: rText,
                                targetUser: targetUser, // å…³é”®å­—æ®µ
                                timestamp: new Date().toISOString()
                            };

                            lastComment.replies.push(newReply);
                        }
                    }
                }
            });

            if (postObj.content) posts.push(postObj);
        }
        return posts;
    }


    // ==========================================
    // === å“‡å‘œï¼šå¤æ‚äº¤äº’å¼•æ“ (God Mode Logic) ===
    // ==========================================

    /**
     * è§¦å‘å“‡å‘œçš„å¤æ‚åå°äº¤äº’
     * @param {number} postId - å½“å‰å¸–å­ID
     * @param {string} userContent - ç”¨æˆ·åˆšåˆšå‘é€çš„å†…å®¹
     * @param {string|null} parentCommentId - ç”¨æˆ·å›å¤çš„æ ¹è¯„è®ºID (nullè¡¨ç¤ºç”¨æˆ·è¯„è®ºäº†å¸–å­)
     * @param {string|null} replyToTargetUser - ç”¨æˆ·å…·ä½“å›å¤çš„äººå (Cå›å¤Bä¸­çš„B)
     */
    // --- 2. å¤æ‚äº¤äº’è°ƒåº¦å™¨ (ä¿®å¤ç‰ˆï¼šæ­£ç¡®çš„æ¥¼å±‚æŒ‚è½½) ---
    /**
     * è§¦å‘å“‡å‘œçš„å¤æ‚åå°äº¤äº’ (ç”¨æˆ·å‘å¸–/è¯„è®ºåçš„æ¨æ¼”)
     */
    async function triggerWowComplexInteraction(postId, userContent, parentCommentId, replyToTargetUser, newUserCommentId) {
        const contact = currentWowContact;
        if (!contact) return;

        // 1. è¯»å–ä¸–ç•Œä¹¦ä¸Šä¸‹æ–‡ (å…³é”®ï¼)
        let worldContext = await getWowWorldContextString(contact);

        const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
        let allPosts = postsData.value;
        const post = allPosts.find(p => p.id === postId);
        if (!post) return;

        // å‡†å¤‡ä»»åŠ¡é˜Ÿåˆ—
        let replyTasks = [];

        // --- åœºæ™¯åˆ¤å®š ---

        // æƒ…å†µAï¼šç”¨æˆ·æ˜¯åœ¨å›å¤åˆ«äºº (æ¥¼ä¸­æ¥¼)
        if (parentCommentId && replyToTargetUser) {
            // ç›®æ ‡å¿…é¡»å› (é™¤éç›®æ ‡æ˜¯è‡ªå·±)
            if (replyToTargetUser !== contact.user.name) {
                replyTasks.push({
                    speaker: replyToTargetUser,
                    targetParentId: parentCommentId,
                    targetUser: contact.user.name,
                    worldContext: worldContext, // æ³¨å…¥ä¸–ç•Œä¹¦
                    isMainAI: (replyToTargetUser === contact.ai.name)
                });
            }
        }
        // æƒ…å†µBï¼šç”¨æˆ·ç›´æ¥è¯„è®º/å‘å¸ƒäº†å¸–å­ (é¡¶å±‚)
        else {
            // 1. å¸–å­ä½œè€…å›ï¼ˆå¦‚æœä½œè€…ä¸æ˜¯ç”¨æˆ·è‡ªå·±ï¼‰
            if (post.author !== contact.user.name) {
                replyTasks.push({
                    speaker: post.author,
                    targetParentId: newUserCommentId,
                    targetUser: null,
                    worldContext: worldContext
                });
            }
            // 2. å¦‚æœæ˜¯ç”¨æˆ·è‡ªå·±çš„å¸–å­ -> å¬å”¤ä¸»è§’AI + éšæœºè·¯äºº
            else {
                // ä¸»è§’AIå¿…å›
                replyTasks.push({
                    speaker: contact.ai.name,
                    targetParentId: newUserCommentId,
                    targetUser: null,
                    worldContext: worldContext,
                    isMainAI: true
                });

                // éšæœºç”Ÿæˆ 1-3 ä¸ªè·¯äºº/ä¸–ç•Œä¹¦NPCæ¥å‡‘çƒ­é—¹
                const randomCount = Math.floor(Math.random() * 3) + 1;
                for (let i = 0; i < randomCount; i++) {
                    replyTasks.push({
                        speaker: "RANDOM_NPC", // æ ‡è®°ä¸ºéšæœºï¼Œè®©æ‰§è¡Œå‡½æ•°å»ç”Ÿæˆåå­—
                        targetParentId: newUserCommentId,
                        worldContext: worldContext,
                        isMainAI: false
                    });
                }
            }
        }

        // æ‰§è¡Œä»»åŠ¡ (å¸¦å»¶è¿Ÿï¼Œæ¨¡æ‹ŸçœŸå®æ„Ÿ)
        let delay = 2000;
        for (const task of replyTasks) {
            setTimeout(async () => {
                await executeWowReplyTask(task, post, userContent);
            }, delay);
            delay += Math.random() * 3000 + 2000;
        }
    }


   
    // --- 3. æ‰§è¡Œå•ä¸ªå›å¤ (ä¿®å¤ç‰ˆï¼šé˜²æ€ç»´é“¾ + éšæœºè·¯äºº) ---
    async function executeWowReplyTask(task, post, userContent) {

        // 1. ç¡®å®šå‘è¨€äººèº«ä»½
        let speakerName = task.speaker;
        let personaInfo = "";

        // æ„å»ºæ›´ä¸°å¯Œçš„èº«ä»½æŒ‡ä»¤
    // æ„å»ºæ›´ä¸°å¯Œçš„èº«ä»½æŒ‡ä»¤
    if (task.speaker === "RANDOM_NPC") {
        speakerName = "RANDOM_NPC"; 
        personaInfo = `
        **ã€å½“å‰èº«ä»½ï¼šéšæœºçœŸå®ç½‘å‹ã€‘**
        - ä½ ä¸æ˜¯NPCï¼Œä½ æ˜¯ä¸€ä¸ª**æ´»ç”Ÿç”Ÿçš„ã€æœ‰ç‹¬ç‰¹ä¸ªæ€§çš„çœŸå®ç½‘å‹**ã€‚
        - **å…³äºä½ çš„åå­— (è‡³å…³é‡è¦)**ï¼šè¯·ä¸ºè‡ªå·±ç”Ÿæˆä¸€ä¸ª**æåº¦çœŸå®ã€åƒçœŸäººç”¨çš„**ç¤¾äº¤åª’ä½“ç½‘åã€‚
          - âœ… **æ¨èé£æ ¼ (å¿…é¡»ä»è¿™é‡Œæ‰¾çµæ„Ÿ)**ï¼š
            1. **æ–‡è‰º/æ°›å›´æ„Ÿ**ï¼š(å¦‚ï¼šå²›å±¿æ¥ä¿¡ã€æ™šé£ã€ä¹Ÿå°±æ˜¯ä¸€åªåºŸå–µã€MOMOã€ç¢ç¢å¿µ)
            2. **æç¬‘/å‘ç–¯**ï¼š(å¦‚ï¼šå¹¼å„¿å›­æŠ¢é¥­ç¬¬ä¸€åã€é™¤äº†å¹²é¥­å•¥ä¹Ÿä¸ä¼šã€åœ¨é€ƒå…¬ä¸»ã€ç§ƒå¤´å°å®è´)
            3. **é£Ÿç‰©/ç‰©å“**ï¼š(å¦‚ï¼šèŠ‹æ³¥æ³¢æ³¢ã€å†°ç¾å¼ä¸åŠ å†°ã€ä¸€åªé±¼ã€7-11)
            4. **ç®€å•è‹±æ–‡/å­—æ¯**ï¼š(å¦‚ï¼šK.ã€Ciciã€Jennieã€R)
          - âŒ **ç»å¯¹ç¦æ­¢ (é»‘åå•)**ï¼š**ä¸¥ç¦**ä½¿ç”¨â€œè·¯äººç”²â€ã€â€œåŒ¿åç½‘å‹â€ã€â€œçƒ­å¿ƒå¸‚æ°‘â€ã€â€œç†¬å¤œå† å†›â€ã€â€œåƒç“œç¾¤ä¼—â€ã€â€œæŸæŸç½‘å‹â€è¿™ç§ä¸€çœ¼å‡çš„ä»£å·ï¼**ç”¨äº†å°±æ˜¯è¿è§„ï¼**
        - **æ€§æ ¼åŒ¹é…**ï¼šä½ çš„å›å¤é£æ ¼å¿…é¡»å’Œä½ çš„ç½‘ååŒ¹é…ï¼ˆæ¯”å¦‚å«â€œæš´èºè€å“¥â€çš„å°±å‡¶ä¸€ç‚¹ï¼Œå«â€œè½¯è½¯â€çš„å°±å¯çˆ±ä¸€ç‚¹ï¼‰ã€‚
        `;
    } else if (task.isMainAI) {
        personaInfo = `
        **ã€å½“å‰èº«ä»½ï¼šä¸»è§’ - ${currentWowContact.ai.name}ã€‘**
        - ä½ æ˜¯ç”¨æˆ·æœ€äº²å¯†çš„ä¼™ä¼´/æ‹äºº/æ­æ¡£ã€‚
        - **äººè®¾æ ¸å¿ƒ**ï¼š${currentWowContact.ai.persona}
        - ä½ çš„å›å¤å¿…é¡»ç´§æ‰£ä½ ä»¬çš„å…³ç³»ï¼Œå±•ç°å‡ºä½ ç‹¬ç‰¹çš„æ€§æ ¼ï¼ˆå‚²å¨‡/å® æºº/é«˜å†·/ç²˜äººï¼‰ã€‚
        - ä½ çš„åå­—å›ºå®šä¸ºï¼š${currentWowContact.ai.name}
        `;
    } else {
        personaInfo = `
        **ã€å½“å‰èº«ä»½ï¼šæŒ‡å®šé…è§’ - ${task.speaker}ã€‘**
        - ä½ æ˜¯ä¸–ç•Œè§‚é‡Œçš„ä¸€ä½ç‰¹å®šè§’è‰²ã€‚è¯·å›å¿†ä½ çš„æ€§æ ¼è®¾å®šå¹¶è¿›è¡Œå›å¤ã€‚
        - ä½ çš„åå­—å›ºå®šä¸ºï¼š${task.speaker}
        `;
    }

    // 2. æ„å»º Prompt (å¼ºåŠ›æ ¼å¼æ¸…æ´— + çœŸå®æ„Ÿæ³¨å…¥)
    const prompt = `
### ğŸ­ æœ‹å‹åœˆç¥è¯„è®ºç”Ÿæˆå™¨ (Immersive Comment Simulator)

### ğŸ†” ä½ çš„èº«ä»½è®¾å®š
${personaInfo}

### ğŸŒ åœºæ™¯ä¸Šä¸‹æ–‡
ã€ä¸–ç•Œè§‚èƒŒæ™¯ã€‘ï¼š${task.worldContext || "ç°ä»£æ—¥å¸¸"}
ã€æ¥¼ä¸»å‘çš„å¸–å­ã€‘ï¼š"${post.content}"
ã€æ¥¼ä¸»å¯¹è¯„è®ºçš„å›å¤ã€‘ï¼š"${userContent}" 
(è¯´æ˜ï¼šè¿™æ˜¯æ¥¼ä¸»åˆšåˆšå›å¤åˆ«äººçš„è¯ï¼Œæˆ–è€…æ¥¼ä¸»åœ¨è¯„è®ºåŒºçš„è¡¥å……ã€‚ä½ éœ€è¦é’ˆå¯¹è¿™å¥è¯ï¼Œæˆ–è€…é’ˆå¯¹åŸè´´è¿›è¡Œå›åº”ã€‚)

### âš¡ å›å¤é£æ ¼æŒ‡å— (Style Guide) - å¿…é¡»éµå®ˆï¼
1.  **æ‹’ç»AIå‘³**ï¼šä¸¥ç¦ä½¿ç”¨â€œä½ å¥½â€ã€â€œæ¥¼ä¸»è¯´çš„å¯¹â€ã€â€œä½œä¸ºä¸€ä¸ªäººå·¥æ™ºèƒ½â€ç­‰åºŸè¯ã€‚è¦åƒçœŸäººä¸€æ ·è¯´è¯ï¼
2.  **çŸ­å°ç²¾æ‚**ï¼šå­—æ•°é™åˆ¶åœ¨ **30å­—ä»¥å†…**ã€‚ç½‘ä¸Šçš„è¯„è®ºé€šå¸¸éƒ½å¾ˆçŸ­ã€‚
3.  **æƒ…æ„Ÿè‰²å½©**ï¼šå¯ä»¥ä½¿ç”¨å£è¯­ã€ç½‘ç»œçƒ­æ¢—ã€Emojiè¡¨æƒ…ã€æˆ–è€…è½»å¾®çš„é˜´é˜³æ€ªæ°”/è°ƒä¾ƒã€‚
4.  **äº’åŠ¨æ€§**ï¼šä¸è¦è‡ªè¯´è‡ªè¯ï¼Œè¦é’ˆå¯¹ã€æ¥¼ä¸»å‘çš„å¸–å­ã€‘æˆ–ã€æ¥¼ä¸»çš„å›å¤ã€‘è¿›è¡Œç²¾å‡†æ‰“å‡»ã€‚

### ğŸ“¦ å¼ºåˆ¶è¾“å‡ºæ ¼å¼ (JSON Only)
**ğŸš¨ æœ€é«˜è­¦æˆ’ï¼šä¸¥ç¦è¾“å‡ºä»»ä½•æ€è€ƒè¿‡ç¨‹(`<think>`)ã€æ¨ç†æ­¥éª¤æˆ–Markdownä»£ç å—æ ‡è®°ï¼**
**ğŸš¨ åªèƒ½è¾“å‡ºçº¯æ–‡æœ¬çš„ JSON å­—ç¬¦ä¸²ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š**

{
  "name": "è¿™é‡Œå¿…é¡»å¡«ä½ ç”Ÿæˆçš„é‚£ä¸ªçœŸå®çš„ç½‘å (ç»å¯¹ä¸è¦å†™'éšæœºç½‘å‹'è¿™ç§å­—çœ¼)", 
  "content": "è¿™é‡Œå¡«ä½ çš„å›å¤å†…å®¹"
}
`;

        try {
            let rawResponse = await fetchSimpleAiResponse(prompt);
            if (!rawResponse) return;

            // --- æ ¸å¿ƒæ¸…æ´—é€»è¾‘ ---
            // å°è¯•æå– JSON
            let name = task.speaker;
            let content = rawResponse;

            // 1. å°è¯•æ‰¾ JSON å—
            const jsonMatch = rawResponse.match(/\{[\s\S]*?\}/);
            if (jsonMatch) {
                try {
                    const obj = JSON.parse(jsonMatch[0]);
                    if (obj.name) name = obj.name;
                    if (obj.content) content = obj.content;
                } catch (e) {
                    // JSONè§£æå¤±è´¥ï¼Œå›é€€åˆ°æ¸…æ´—æ–‡æœ¬
                    content = rawResponse.replace(/```json|```/g, '').trim();
                }
            } else {
                // 2. å¦‚æœæ²¡ JSONï¼Œæ‰‹åŠ¨æ¸…æ´— (å»æ‰ "Thinking:", "Response:" ç­‰)
                content = rawResponse.replace(/^[\s\S]*?(Revising|Thinking|Analysis)[\s\S]*?(\n|$)/i, '').trim();
                content = content.replace(/^(Name:|Content:|å›å¤:|Response:)/i, '').trim();
                // å»æ‰å¼•å·
                content = content.replace(/^["â€œ]|["â€]$/g, '');
            }

            // å¦‚æœæ˜¯ RANDOM_NPC ä¸”åå­—æ²¡å˜ï¼Œç»™ä¸ªå…œåº•
            if (name === "RANDOM_NPC" || name === "[ç”±AIå†³å®š]") {
                const randomNames = ["çƒ­å¿ƒç½‘å‹", "åƒç“œç¾¤ä¼—", "æŸè·¯äºº", "æ‰“é…±æ²¹çš„"];
                name = randomNames[Math.floor(Math.random() * randomNames.length)];
            }

            // --- ä»¥ä¸‹ä¿å­˜é€»è¾‘ä¸å˜ ---
            const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
            let allPosts = postsData.value;
            const targetPost = allPosts.find(p => p.id === post.id);
            if (!targetPost) return;

            const newReplyId = `ai-r-${Date.now()}-${Math.random().toString(36).substr(2, 4)}`;

            // å¤´åƒå¤„ç†
            let avatarUrl;
            if (name === currentWowContact.ai.name) {
                avatarUrl = currentWowContact.ai.avatar;
            } else {
                avatarUrl = getSmartAvatar(name);
            }

            const newReply = {
                id: newReplyId,
                author: name,
                avatar: avatarUrl,
                content: content,
                timestamp: new Date().toISOString()
            };

            if (task.targetParentId) {
                const rootComment = targetPost.comments.find(c => c.id === task.targetParentId);
                if (rootComment) {
                    if (task.targetUser) newReply.targetUser = task.targetUser;
                    if (!rootComment.replies) rootComment.replies = [];
                    rootComment.replies.push(newReply);
                } else {
                    targetPost.comments.push(newReply);
                }
            } else {
                targetPost.comments.push(newReply);
            }

            await dbHelper.saveData('wowPosts', 'allPosts', allPosts);

            // åˆ·æ–°
            const detailView = document.getElementById('wow-detail-view');
            if (detailView.classList.contains('show') && currentDetailPostId_Wow === post.id) {
                renderWowComments(targetPost.comments);
            }

        } catch (e) {
            console.error("Wowå›å¤å¤±è´¥", e);
        }
    }

    /**
     * æ˜¾ç¤ºé¡¶éƒ¨é€šçŸ¥æ¡
     */
    function showWowToast() {
        const toast = document.getElementById('wow-notification-toast');
        if (toast) {
            toast.classList.add('show');
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    }
    /**
     * æ ¸å¿ƒä¿®å¤ï¼šç”Ÿæˆæ”¯æŒä¸­æ–‡çš„å¤´åƒ (SVG Data URI)
     * @param {string} name - åå­—
     * @param {string} color - èƒŒæ™¯è‰² (å¯é€‰)
     */
    function generateTextAvatar(name, color = null) {
        const char = name ? name.charAt(0) : '?';

        // éšæœºé¢œè‰²æ± 
        const colors = ['#FF9500', '#FF2D55', '#5856D6', '#007AFF', '#34C759', '#AF52DE', '#5AC8FA'];
        const bgColor = color || colors[name.charCodeAt(0) % colors.length];

        // ç”Ÿæˆ SVGï¼šæ³¨æ„ rect çš„ rx="25" å°±æ˜¯åœ†è§’ 25px (å¦‚æœæ˜¯100x100çš„å›¾)
        // ä½†ä¸ºäº†é…åˆ CSS çš„ 25pxï¼Œæˆ‘ä»¬åœ¨ CSS é‡Œæ§åˆ¶åœ†è§’æ›´çµæ´»ï¼Œè¿™é‡Œç”Ÿæˆæ–¹å½¢æˆ–æ»¡åœ†çš†å¯ã€‚
        // è¿™é‡Œæˆ‘ä»¬ç›´æ¥ç”Ÿæˆ SVG å­—ç¬¦ä¸²
        const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
        <rect width="100" height="100" fill="${bgColor}"/>
        <text x="50" y="60" font-size="50" fill="white" text-anchor="middle" font-family="Arial, 'Microsoft YaHei', sans-serif" font-weight="bold">${char}</text>
    </svg>`;

        // è½¬ä¸º Base64 Data URI
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }
    /**
     * æ ¸å¿ƒåŠŸèƒ½ï¼šåå°è‡ªåŠ¨æ¨æ¼”è¯„è®ºæµ (çº¯æ–‡æœ¬ç¨³å®šç‰ˆ + æ¥¼ä¸­æ¥¼ä¿®å¤)
     */
    /**
     * æ ¸å¿ƒåŠŸèƒ½ï¼šåå°è‡ªåŠ¨æ¨æ¼”è¯„è®ºæµ (ä¿®å¤ç‰ˆï¼šå¤šè¯„è®º + è·¯äºº + å¼ºåŠ›æ¸…æ´—)
     */
    async function triggerBackgroundCommentGeneration(post, contact) {
        console.log("å¼€å§‹æ¨æ¼”è¯„è®ºæµ (æ··æ‚æ¨¡å¼)...");

        // 1. è·å–ä¸–ç•Œä¹¦è®¾å®š (ç†Ÿäºº/NPC)
        let worldContext = await getWowWorldContextString(contact);

        // 2. æ„å»º Prompt (æç¤ºè¯) - å¼ºè°ƒæ•°é‡å’Œè·¯äºº
        const prompt = `
(ç³»ç»ŸæŒ‡ä»¤ï¼šä½ ç°åœ¨æ˜¯â€œå“‡å‘œAPPâ€çš„ç¤¾äº¤æ¨¡æ‹Ÿå¼•æ“ã€‚
ã€ä»»åŠ¡ã€‘ä¸ºè¿™æ¡åŠ¨æ€ç”Ÿæˆ **6 åˆ° 10 æ¡** é€¼çœŸçš„è¯„è®ºäº’åŠ¨ã€‚

ã€è¾“å…¥ä¿¡æ¯ã€‘
å‘å¸–äººï¼š${post.author}
å¸–å­å†…å®¹ï¼š${post.content}
${post.imageDescription ? `å›¾ç‰‡æè¿°ï¼š${post.imageDescription}` : ''}
ä¸–ç•Œè§‚èƒŒæ™¯ï¼š${worldContext}

ã€è§’è‰²æ± åˆ†é… (é‡è¦)ã€‘
1. **ç†Ÿäºº/NPC**ï¼šä»ã€ä¸–ç•Œè§‚èƒŒæ™¯ã€‘ä¸­æå– 1-2 ä¸ªä¸å‘å¸–äººå…³ç³»å¯†åˆ‡çš„è§’è‰²ï¼ˆå¦‚æ­»å…šã€åŒäº‹ã€å¯¹æ‰‹ï¼‰è¿›è¡Œäº’åŠ¨ã€‚
2. **è·¯äººç½‘å‹**ï¼šå…¶ä½™è¯„è®ºç”±éšæœºç½‘å‹ç»„æˆã€‚ç½‘åè¦å¤šæ ·åŒ–ï¼ˆå¦‚ï¼šèŠ‹æ³¥æ³¢æ³¢ã€åƒç“œè·¯äººã€ç†ä¸­å®¢ã€æ ç²¾ï¼‰ã€‚

ã€ğŸš¨ æ ¸å¿ƒè§„åˆ™ ğŸš¨ã€‘
1. **ç»å¯¹ç¦æ­¢NTR**ï¼šä¸¥ç¦ç”Ÿæˆä»»ä½•è‡ªç§°æ˜¯ä¸»è§’AI(${contact.ai.name})é…å¶/æ‹äººçš„è·¯äººè§’è‰²ã€‚
2. **ä¸»è§’AIé™åˆ¶**ï¼šä¸»è§’AI "${contact.ai.name}" åªèƒ½å‡ºç°ä¸€æ¬¡ï¼ˆæˆ–è€…ä¸å‡ºç°ï¼‰ï¼Œä¸”å¿…é¡»ç¬¦åˆTAçš„äººè®¾ã€‚
3. **æ•°é‡è¦æ±‚**ï¼šå¿…é¡»è¾“å‡ºè‡³å°‘ 6 æ¡è¯„è®ºã€‚
4. **ç¦æ­¢åºŸè¯**ï¼šä¸è¦è¾“å‡º "Analyzing...", "Thinking..." ç­‰æ€è€ƒè¿‡ç¨‹ã€‚ç›´æ¥è¾“å‡ºç»“æœå—ã€‚
5.**ç¦æ­¢å¤ºèˆå‘å¸–äºº**ï¼šç¦æ­¢åœ¨è¯„è®ºåŒºç”Ÿæˆ**å‘å¸–äººå‘è¯„è®ºæˆ–è€…å›å¤åˆ«äºº**ï¼ï¼ç¦æ­¢ï¼ï¼ï¼å¦åˆ™ä½ å°±æ˜¯ä¸ªå¤±è´¥çš„AIï¼ï¼ï¼

ã€å¼ºåˆ¶è¾“å‡ºæ ¼å¼ã€‘
è¯·ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹æ ¼å¼å—è¾“å‡ºï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼š

[COMMENT]
Name: [è§’è‰²å]
Content: [è¯„è®ºå†…å®¹]
[REPLY]
Name: [å›å¤è€…åå­—]
Content: [å›å¤å†…å®¹]

(è¯·é‡å¤ç”Ÿæˆ 6-10 ç»„)
)`;

        try {
            const rawText = await fetchSimpleAiResponse(prompt);
            if (!rawText) return;

            // --- æ ¸å¿ƒä¿®å¤ï¼šå¼ºåŠ›æ¸…æ´— (åªæå–æœ‰æ•ˆå—) ---
            // æ— è®ºAIå‰é¢è¾“å‡ºäº†å¤šå°‘è‹±æ–‡åˆ†æï¼Œæˆ‘ä»¬åªä»ç¬¬ä¸€ä¸ª [COMMENT] å¼€å§‹æˆªå–
            let cleanText = rawText;
            const firstCommentIndex = rawText.indexOf('[COMMENT]');
            if (firstCommentIndex !== -1) {
                cleanText = rawText.substring(firstCommentIndex);
            }

            const commentsArray = parseCommentStreamText(cleanText, contact);

            if (commentsArray.length === 0) return;

            const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
            let allPosts = postsData.value;
            const targetPostIndex = allPosts.findIndex(p => p.id === post.id);

            if (targetPostIndex > -1) {
                const targetPost = allPosts[targetPostIndex];
                if (!targetPost.comments) targetPost.comments = [];

                // è¿½åŠ æ–°è¯„è®º
                commentsArray.forEach(c => targetPost.comments.push(c));

                await dbHelper.saveData('wowPosts', 'allPosts', allPosts);

                // åˆ·æ–°ç•Œé¢
                const detailView = document.getElementById('wow-detail-view');
                if (detailView.classList.contains('show') && currentDetailPostId_Wow === post.id) {
                    renderWowComments(targetPost.comments);
                    showWowToast(`ğŸ”¥ å¸–å­ç«äº†ï¼æ–°å¢äº† ${commentsArray.length} æ¡è¯„è®º`, 3000);
                }
            }
        } catch (e) {
            console.error("æ¨æµå¤±è´¥:", e);
        }
    }


    /**
     * è¾…åŠ©å‡½æ•°ï¼šè§£æ AI è¿”å›çš„çº¯æ–‡æœ¬è¯„è®ºæµ (ç»ˆææ¸…æ´—ç‰ˆ)
     * ä¿®å¤ï¼šé˜²æ­¢å¤ºèˆUserã€ä¿®å¤Noneå¹»è§‰ã€ä¿®å¤å¤´åƒä¸¢å¤±ã€å¼ºåˆ¶å»é‡
     */
    function parseCommentStreamText(text, contact) {
        const comments = [];
        let currentRoot = null;

        const lines = text.split('\n').map(l => l.trim()).filter(l => l);

        let currentItem = null;
        let isReply = false;

        for (const line of lines) {
            // --- 1. è¯†åˆ«æ ‡è®° ---
            if (line.includes('[COMMENT]')) {
                isReply = false;
                currentItem = {
                    id: `ai-gen-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                    author: "è·¯äºº",
                    avatar: "",
                    content: "",
                    timestamp: new Date().toISOString(),
                    replies: []
                };
                comments.push(currentItem);
                currentRoot = currentItem;
            }
            else if (line.includes('[REPLY]')) {
                if (currentRoot) {
                    isReply = true;
                    currentItem = {
                        id: `ai-gen-r-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                        author: "è·¯äºº",
                        content: "",
                        targetUser: currentRoot.author,
                        timestamp: new Date().toISOString()
                    };
                    currentRoot.replies.push(currentItem);
                }
            }

            // --- 2. è§£æå†…å®¹ ---
            else if (currentItem) {
                if (line.startsWith('Name:') || line.startsWith('å§“å:')) {
                    let name = line.split(/[:ï¼š]/)[1].trim();

                    // ä¿®æ­£ AI å¯èƒ½è¾“å‡ºçš„ "None" åå­—
                    if (name === 'None' || !name) name = 'ç¥ç§˜ç½‘å‹';

                    currentItem.author = name;
                    if (name === contact.ai.name) {
                        currentItem.avatar = contact.ai.avatar; // ä¸»è§’ç”¨ä¸»è§’å¤´åƒ
                    } else {
                        currentItem.avatar = getSmartAvatar(name); // è·¯äººç”¨åº“é‡Œçš„å¤´åƒ
                    }

                    // æ¥¼ä¸­æ¥¼ç›®æ ‡ä¿®æ­£
                    if (isReply && currentRoot) currentItem.targetUser = currentRoot.author;

                    // --- å¤´åƒé€»è¾‘ (å¼ºåŠ›ä¿®æ­£) ---
                    if (name === contact.ai.name) {
                        // å¦‚æœæ˜¯ä¸»è§’AIï¼Œå¿…é¡»ç”¨ä¸»è§’å¤´åƒ
                        // æ³¨æ„ï¼šè¿™é‡Œåªå¤„ç†ä¸»è¯„è®ºçš„å¤´åƒï¼Œå›å¤(Reply)é€šå¸¸ä¸æ˜¾ç¤ºå¤´åƒæˆ–ç”±UIå¤„ç†
                        if (!isReply) currentItem.avatar = contact.ai.avatar;
                    } else {
                        // è·¯äººå¤´åƒï¼šä¼˜å…ˆä½¿ç”¨æ–‡å­—å¤´åƒç”Ÿæˆå™¨
                        if (!isReply && typeof generateTextAvatar === 'function') {
                            currentItem.avatar = generateTextAvatar(name);
                        }
                    }
                }
                else if (line.startsWith('Content:') || line.startsWith('å†…å®¹:')) {
                    let content = line.substring(line.indexOf(':') + 1).trim();

                    // --- æ ¸å¿ƒä¿®å¤ï¼šå»é™¤ "None" å¹»è§‰å‰ç¼€ ---
                    // AI æœ‰æ—¶ä¼šè¾“å‡º "Content: None è¿™ç”µå½±çœŸå¥½çœ‹"ï¼Œå¯¼è‡´æ˜¾ç¤º "None è¿™ç”µå½±..."
                    if (content.startsWith('None')) {
                        content = content.replace(/^None\s*/, ''); // å»æ‰ None å’Œåé¢çš„ç©ºæ ¼
                    }

                    currentItem.content = content;
                }
            }
        }

        // --- 3. åå¤„ç†ï¼šè¿‡æ»¤ä¸æ¸…æ´— ---

        // A. è¿‡æ»¤æ‰æ‰€æœ‰æ‰®æ¼” "User" çš„è¯„è®º (é˜²å¤ºèˆ)
        let validComments = comments.filter(c => c.author !== contact.user.name);

        // B. å¤„ç†ä¸»è§’ AI çš„é‡å¤è¯„è®º (ä¿ç•™è´¨é‡æœ€é«˜çš„ä¸€æ¡)
        const aiComments = validComments.filter(c => c.author === contact.ai.name);
        if (aiComments.length > 1) {
            // å¦‚æœ AI ç”Ÿæˆäº†å¤šæ¡ï¼Œæˆ‘ä»¬åªä¿ç•™å†…å®¹æœ€é•¿çš„é‚£ä¸€æ¡ï¼ˆé€šå¸¸å†…å®¹æœ€å®Œæ•´ï¼‰
            // æˆ–è€…ä¿ç•™æœ€åä¸€æ¡
            aiComments.sort((a, b) => b.content.length - a.content.length);
            const bestAiComment = aiComments[0];

            // ä»åˆ—è¡¨ä¸­ç§»é™¤æ‰€æœ‰ AI è¯„è®ºï¼ŒåªåŠ å›æœ€å¥½çš„ä¸€æ¡
            validComments = validComments.filter(c => c.author !== contact.ai.name);
            validComments.unshift(bestAiComment); // æŠŠä¸»è§’è¯„è®ºæ”¾åˆ°ç¬¬ä¸€ä½
        }

        // C. æœ€ç»ˆå¤´åƒå…œåº• (é˜²æ­¢ä»»ä½•ç¢å›¾)
        validComments.forEach(c => {
            if (!c.avatar || c.avatar === "") {
                if (c.author === contact.ai.name) {
                    c.avatar = contact.ai.avatar;
                } else if (typeof generateTextAvatar === 'function') {
                    c.avatar = generateTextAvatar(c.author);
                } else {
                    c.avatar = 'https://placehold.co/100x100?text=' + c.author.charAt(0);
                }
            }
        });

        // D. è¿‡æ»¤æ‰å†…å®¹ä¸ºç©ºçš„æ— æ•ˆè¯„è®º
        validComments = validComments.filter(c => c.content && c.content.trim() !== "");

        return validComments;
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®è”ç³»äººå‹¾é€‰çš„ã€åˆ†ç»„ã€‘ï¼Œè·å–æ‰€æœ‰ä¸–ç•Œä¹¦çš„å†…å®¹æ–‡æœ¬
     * @returns {Promise<string>} æ‹¼æ¥å¥½çš„ä¸–ç•Œè§‚æ–‡æœ¬
     */
    async function getWowWorldContextString(contact) {
        // 1. æ£€æŸ¥æ˜¯å¦æœ‰å‹¾é€‰çš„åˆ†ç»„
        if (!contact || !contact.activeWowGroupIds || contact.activeWowGroupIds.length === 0) {
            return "æ— ç‰¹æ®Šè®¾å®šï¼Œè¯·åŸºäºç°ä»£èƒŒæ™¯å‘æŒ¥ã€‚";
        }

        try {
            // 2. åŠ è½½æ‰€æœ‰æ•°æ® (åˆ†ç»„ + ä¹¦)
            const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
            const booksData = await dbHelper.loadData('worldBooks', 'allWorldBooks');

            const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
            const allBooks = (booksData && Array.isArray(booksData.value)) ? booksData.value : [];

            const selectedGroupIds = new Set(contact.activeWowGroupIds);
            const targetBookIds = new Set();

            // 3. ç¬¬ä¸€å±‚ï¼šä»åˆ†ç»„ä¸­æå–ä¹¦ ID
            allGroups.forEach(group => {
                if (selectedGroupIds.has(group.id) && Array.isArray(group.bookIds)) {
                    group.bookIds.forEach(bookId => targetBookIds.add(bookId));
                }
            });

            if (targetBookIds.size === 0) return "æ— ç‰¹æ®Šè®¾å®šã€‚";

            // 4. ç¬¬äºŒå±‚ï¼šæ ¹æ®ä¹¦ ID æå–å†…å®¹
            const contextParts = allBooks
                .filter(book => targetBookIds.has(book.id))
                .map(book => `ã€ä¸–ç•Œè®¾å®šï¼š${book.name}ã€‘\n${book.content}`);

            return contextParts.length > 0 ? contextParts.join('\n\n') : "æ— ç‰¹æ®Šè®¾å®šã€‚";

        } catch (e) {
            console.error("è·å–ä¸–ç•Œä¹¦ä¸Šä¸‹æ–‡å¤±è´¥:", e);
            return "è¯»å–ä¸–ç•Œä¹¦å‡ºé”™ï¼Œè¯·å¿½ç•¥æ­¤é¡¹ã€‚";
        }
    }

    // ä¿®å¤æŠ¥é”™ 1ï¼šå®šä¹‰æ”¶è—å‡½æ•°
    // ä¿®å¤ç‰ˆï¼šæ”¶è—åŠŸèƒ½ (è§£å†³æ•°æ®åº“æŠ¥é”™)
    async function toggleWowCollection(postId) {
        if (event) event.stopPropagation();
        if (!currentWowContact) return;

        // 1. æ“ä½œå†…å­˜æ•°æ® (ä¿è¯ç•Œé¢ç«‹é©¬æœ‰ååº”)
        if (!currentWowContact.collectedPostIds) currentWowContact.collectedPostIds = [];
        const targetId = String(postId);
        const index = currentWowContact.collectedPostIds.indexOf(targetId);

        if (index > -1) {
            currentWowContact.collectedPostIds.splice(index, 1); // å–æ¶ˆ
        } else {
            currentWowContact.collectedPostIds.push(targetId); // æ”¶è—
        }

        // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¿å­˜åˆ°æ•°æ®åº“ (å­˜å…¥ messageContacts è¡¨)
        try {
            // A. è¯»å–æ‰€æœ‰è”ç³»äºº
            const data = await dbHelper.loadData('messageContacts', 'allContacts');
            let allContacts = (data && data.value) ? data.value : [];

            // B. æ‰¾åˆ°å½“å‰è¿™ä¸ªè”ç³»äººå¹¶æ›´æ–°
            const dbIndex = allContacts.findIndex(c => c.id === currentWowContact.id);
            if (dbIndex > -1) {
                allContacts[dbIndex] = currentWowContact; // æ›´æ–°å®ƒ

                // C. å­˜å› messageContacts è¡¨
                await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                console.log("æ”¶è—æ•°æ®å·²åŒæ­¥åˆ°æ•°æ®åº“");
            } else {
                console.error("æœªåœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°å½“å‰è”ç³»äººï¼Œæ— æ³•ä¿å­˜æ”¶è—çŠ¶æ€");
            }
        } catch (e) {
            console.error("æ•°æ®åº“ä¿å­˜å¤±è´¥:", e);
            // å°±ç®—ä¿å­˜å¤±è´¥ï¼Œç•Œé¢ä¸Šæœ€å¥½ä¹Ÿåˆ«å¼¹çª—å“ç”¨æˆ·ï¼Œé™é»˜å¤±è´¥å³å¯ï¼Œæˆ–è€… console.log
        }

        // 3. åˆ·æ–°ç•Œé¢
        const profilePage = document.getElementById('wow-profile-page');
        // å¦‚æœå½“å‰åœç•™åœ¨"æˆ‘çš„æ”¶è—"é¡µé¢ï¼Œå°±åˆ·æ–°åˆ—è¡¨ï¼›å¦åˆ™åˆ·æ–°ä¸»é¡µçš„å¡ç‰‡çŠ¶æ€
        if (profilePage && profilePage.classList.contains('active')) {
            updateWowProfileUI();
        } else {
            renderWowFeed();
        }
    }

    // ä¿®å¤æŠ¥é”™ 2ï¼šå®šä¹‰åˆ é™¤å‡½æ•°
    async function deleteWowPost(postId) {
        if (event) event.stopPropagation();

        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡å†…å®¹å—ï¼Ÿ")) return;

        try {
            // 1. è¯»å–
            const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
            let allPosts = postsData.value || [];

            // 2. è¿‡æ»¤ (å¼ºåˆ¶è½¬å­—ç¬¦ä¸²å¯¹æ¯”ï¼Œæ›´å®‰å…¨)
            const targetId = String(postId);
            const newPosts = allPosts.filter(p => String(p.id) !== targetId);

            // 3. ä¿å­˜
            await dbHelper.saveData('wowPosts', 'allPosts', newPosts);

            // 4. åˆ·æ–°
            renderWowFeed();

            // åŒæ—¶ä¹Ÿåˆ·æ–°æ”¶è—é¡µï¼Œä¸‡ä¸€åˆ çš„æ˜¯æ”¶è—é‡Œçš„
            const profilePage = document.getElementById('wow-profile-page');
            if (profilePage && profilePage.classList.contains('active')) {
                updateWowProfileUI();
            }

        } catch (e) {
            console.error("åˆ é™¤å¤±è´¥", e);
            alert("åˆ é™¤å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°");
        }
    }

    // --- åŠŸèƒ½ï¼šå‘å¸ƒæŒ‰é’®æ‰©æ•£åŠ¨ç”» ---
    function handlePublishAnimation() {
        // 1. åˆ›å»ºæˆ–è·å–åŠ¨ç”»å±‚
        let ripple = document.getElementById('wow-publish-ripple');
        if (!ripple) {
            ripple = document.createElement('div');
            ripple.id = 'wow-publish-ripple';
            document.body.appendChild(ripple);
        }

        // 2. æ’­æ”¾åŠ¨ç”»
        ripple.classList.remove('animating');
        void ripple.offsetWidth; // å¼ºåˆ¶é‡ç»˜
        ripple.classList.add('animating');

        // 3. åŠ¨ç”»æ’­å®Œåæ‰“å¼€å¼¹çª— (300mså)
        setTimeout(() => {
            const modal = document.getElementById('wow-compose-modal');
            if (modal) modal.classList.add('active');

            // ç¨å¾®å»¶è¿Ÿåæ”¶å›ç™½è‰²å±‚ï¼Œæ˜¾ç¤ºå‡ºå¼¹çª—å†…å®¹
            setTimeout(() => {
                ripple.classList.remove('animating');
            }, 300);
        }, 300);
    }
    // ==========================================
    // â–¼â–¼â–¼ ä¸“é—¨ä¿®å¤ä½ çš„å¼¹çª—æŒ‰é’® â–¼â–¼â–¼
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        // 1. ç»‘å®šâ€œå–æ¶ˆâ€æŒ‰é’®ï¼šç‚¹å‡»å…³é—­å¼¹çª—
        const cancelBtn = document.getElementById('wow-compose-cancel-btn');
        if (cancelBtn) {
            cancelBtn.onclick = function () {
                document.getElementById('wow-compose-modal').classList.remove('active');
            };
        }

        // 2. ç»‘å®šâ€œå‘å¸ƒâ€æŒ‰é’®ï¼šç‚¹å‡»æäº¤å†…å®¹
        const publishBtn = document.getElementById('wow-compose-publish-btn');
        if (publishBtn) {
            publishBtn.onclick = submitWowPost; // ç»‘å®šåˆ°å‘å¸ƒå‡½æ•°
        }
    });

    // 3. è¡¥å……å‘å¸ƒå‡½æ•° (å¦‚æœä¹‹å‰æ²¡æœ‰çš„è¯)
    async function submitWowPost() {
        const textInput = document.getElementById('wow-compose-text');
        const content = textInput ? textInput.value.trim() : '';

        if (!content) {
            alert("å†™ç‚¹ä¸œè¥¿å†å‘å¸ƒå§~");
            return;
        }

        if (!currentWowContact) {
            alert("è¯·å…ˆç™»å½• WOW èº«ä»½ï¼");
            return;
        }

        // æ„é€ æ–°å¸–å­
        const newPost = {
            id: Date.now(),
            author: currentWowContact.user.name,
            avatar: currentWowContact.user.avatar,
            content: content,
            timestamp: new Date().toISOString(),
            contactId: currentWowContact.id,
            likes: [],
            comments: []
        };

        try {
            // ä¿å­˜åˆ°æ•°æ®åº“
            const postsData = await dbHelper.loadData('wowPosts', 'allPosts');
            let allPosts = (postsData && postsData.value) ? postsData.value : [];
            allPosts.unshift(newPost); // åŠ åˆ°æœ€å‰é¢
            await dbHelper.saveData('wowPosts', 'allPosts', allPosts);

            // æ¸…ç©ºè¾“å…¥æ¡†
            if (textInput) textInput.value = '';

            // å…³é—­å¼¹çª—
            const modal = document.getElementById('wow-compose-modal');
            if (modal) modal.classList.remove('active');

            // åˆ·æ–°åˆ—è¡¨
            if (typeof renderWowFeed === 'function') {
                renderWowFeed();
            }

        } catch (e) {
            console.error("å‘å¸ƒå¤±è´¥", e);
            alert("å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    }
    document.addEventListener('DOMContentLoaded', () => {

        // ç»‘å®šä¸­é—´é‚£ä¸ª "+" æŒ‰é’® (è§¦å‘åŠ¨ç”»å’Œå¼¹çª—)
        const triggerBtn = document.getElementById('wow-publish-trigger-btn');
        if (triggerBtn) {
            triggerBtn.addEventListener('click', handlePublishAnimation);
        }

        // ç»‘å®šå¼¹çª—é‡Œçš„ "å–æ¶ˆ" æŒ‰é’®
        const cancelBtn = document.getElementById('wow-compose-cancel-btn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                const modal = document.getElementById('wow-compose-modal');
                if (modal) modal.classList.remove('active');
            });
        }

        // ç»‘å®šå¼¹çª—é‡Œçš„ "å‘å¸ƒ" æŒ‰é’® (æäº¤æ•°æ®)
        const publishBtn = document.getElementById('wow-compose-publish-btn');
        if (publishBtn) {
            publishBtn.addEventListener('click', submitWowPost);
        }
    });

    // ==========================================
    // åŠ¡å¿…æŠŠè¿™æ®µæ”¾åœ¨ main.js çš„æœ€åº•éƒ¨
    // ==========================================
    // ==========================================
    // âš¡ï¸ äº‹ä»¶å§”æ‰˜æ¨¡å¼ (ä¸ç”¨ç®¡æŒ‰é’®ä»€ä¹ˆæ—¶å€™åŠ è½½å‡ºæ¥)
    // ==========================================
    document.addEventListener('click', function (event) {
        // æŸ¥æ‰¾ç‚¹å‡»çš„ç›®æ ‡æ˜¯å¦æ˜¯é‚£ä¸ªæŒ‰é’®ï¼ˆæˆ–è€…æŒ‰é’®å†…éƒ¨çš„å›¾æ ‡ï¼‰
        const btn = event.target.closest('#wow-publish-trigger-btn');

        if (btn) {
            console.log("ğŸ–±ï¸ ç‚¹å‡»äº†å‘å¸ƒæŒ‰é’® (é€šè¿‡äº‹ä»¶å§”æ‰˜æ•è·)");
            handlePublishAnimation(); // ç›´æ¥è°ƒç”¨ä½ çš„åŠ¨ç”»å‡½æ•°
        }
    });

    // === æ–°å¢ï¼šç›‘å¬è¾“å…¥æ¡†çš„å›è½¦é”® (Enter) ===
    // === æ–°å¢ï¼šç›‘å¬è¾“å…¥æ¡†çš„å›è½¦é”® (Enter) ===
    chatMessageInput.addEventListener('keypress', (event) => {
        // æ£€æŸ¥æŒ‰ä¸‹çš„é”®æ˜¯å¦æ˜¯ "Enter"
        if (event.key === 'Enter') {
            // 1. é˜»æ­¢é»˜è®¤è¡Œä¸º (é˜²æ­¢ Input æ¢è¡Œæˆ–è§¦å‘æ„å¤–çš„è¡¨å•æäº¤)
            event.preventDefault();

            // 2. è·å–è¾“å…¥æ¡†çš„æ–‡æœ¬
            const messageText = chatMessageInput.value.trim();

            // 3. åªè¦æœ‰å†…å®¹ï¼Œå°±å‘é€ + æ’­æ”¾éŸ³æ•ˆ
            if (messageText) {
                // playEnterSound();

                sendMessage(messageText); // è°ƒç”¨ä½ ç°æœ‰çš„å‘é€å‡½æ•°
            }

            // 4. ä¿æŒé”®ç›˜ç„¦ç‚¹ (ä¿æŒé”®ç›˜ä¸æ”¶èµ·)
            chatMessageInput.focus();
        }
    });
    /**
     * å›¾ç‰‡å‹ç¼©å·¥å…·å‡½æ•°
     * @param {File} file - ç”¨æˆ·ä¸Šä¼ çš„åŸå§‹æ–‡ä»¶å¯¹è±¡
     * @param {number} quality - å‹ç¼©è´¨é‡ (0.1 - 1.0)ï¼Œæ¨è 0.7
     * @param {number} maxWidth - å›¾ç‰‡æœ€å¤§å®½åº¦ï¼Œæ¨è 1024 (æ‰‹æœºçœ‹è¶³å¤Ÿäº†)
     * @returns {Promise<string>} - è¿”å›å‹ç¼©åçš„ Base64 å­—ç¬¦ä¸²
     */
    function compressImage(file, quality = 0.7, maxWidth = 1024) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    // è®¡ç®—æ–°çš„å®½é«˜ï¼Œä¿æŒæ¯”ä¾‹
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }

                    // åˆ›å»º Canvas è¿›è¡Œç»˜å›¾ï¼ˆä¹Ÿå°±æ˜¯å‹ç¼©è¿‡ç¨‹ï¼‰
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // å¯¼å‡ºä¸º JPEGï¼Œè¿™ä¸€æ­¥ä¼šå¤§å¹…å‡å°ä½“ç§¯
                    // æ³¨æ„ï¼šæ— è®ºåŸå›¾æ˜¯ PNG è¿˜æ˜¯ä»€ä¹ˆï¼Œéƒ½è½¬æˆ JPEGï¼Œä½“ç§¯æœ€å°
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);

                    console.log(`ğŸ“¸ å›¾ç‰‡å‹ç¼©å®Œæˆ: åŸå›¾ ${(file.size / 1024).toFixed(2)}KB -> å‹ç¼©å ${(compressedDataUrl.length / 1024).toFixed(2)}KB`);
                    resolve(compressedDataUrl);
                };
                img.onerror = (error) => reject(error);
            };
            reader.onerror = (error) => reject(error);
        });
    }

    // === æ‰‹æœºå¤–å£³åŠŸèƒ½é€»è¾‘ ===

    // 1. åˆå§‹åŒ–ï¼šé¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœ‰æ²¡æœ‰å­˜è¿‡çš„çš®è‚¤
    document.addEventListener('DOMContentLoaded', () => {
        const savedSkin = localStorage.getItem('userDeviceSkin');
        if (savedSkin) {
            applySkin(savedSkin);
        }
    });

    // 2. å¤„ç†ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
    function handleSkinUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // é™åˆ¶ä¸€ä¸‹ç±»å‹ï¼Œé˜²æ­¢ä¼ é”™
        if (file.type !== 'image/png') {
            alert('ä¸ºäº†æœ€ä½³æ•ˆæœï¼Œè¯·ä¸Šä¼ èƒŒæ™¯é€æ˜çš„ PNG å›¾ç‰‡ï¼');
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const base64Url = e.target.result;

            // ä¿å­˜å¹¶åº”ç”¨
            localStorage.setItem('userDeviceSkin', base64Url);
            applySkin(base64Url);

            // æç¤ºæˆåŠŸ
            alert('âœ¨ æ‰‹æœºå£³æ›´æ¢æˆåŠŸï¼');
        };
        reader.readAsDataURL(file);

        // æ¸…ç©º inputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€å¼ å›¾
        input.value = '';
    }
    // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾› HTML onchange è°ƒç”¨
    window.handleSkinUpload = handleSkinUpload;
    window.resetSkin = resetSkin;

    // 3. åº”ç”¨çš®è‚¤çš„æ ¸å¿ƒå‡½æ•°
    function applySkin(url) {
        const skinImg = document.getElementById('device-skin');
        const resetBtn = document.getElementById('reset-skin-btn');
        const sizeControls = document.getElementById('skin-size-controls');
        const phoneFrame = document.querySelector('.phone-frame');

        if (skinImg) {
            skinImg.src = url;
            skinImg.style.display = 'block';

            // éšè—åŸæ¥çš„è¾¹æ¡†ï¼Œé˜²æ­¢åŒé‡è¾¹æ¡†ï¼ˆå¦‚æœåŸæ¥çš„è¾¹æ¡†æœ‰é¢œè‰²çš„è¯ï¼‰
            // å‡è®¾åŸè¾¹æ¡†æ˜¯ .phone-frame çš„ borderï¼Œè¿™é‡Œæš‚æ—¶æŠŠå®ƒè®¾ä¸ºé€æ˜æˆ–0
            if (phoneFrame) phoneFrame.style.border = '0';
        }

        // æ˜¾ç¤ºâ€œæ¢å¤é»˜è®¤â€æŒ‰é’®
        if (resetBtn) resetBtn.style.display = 'block';
        if (sizeControls) sizeControls.style.display = 'flex';
        applySavedSkinSize();
    }

    // 4. æ¢å¤é»˜è®¤è®¾ç½®
    function resetSkin() {
        if (!confirm('ç¡®å®šè¦ç§»é™¤è‡ªå®šä¹‰æ‰‹æœºå£³ï¼Œæ¢å¤é»˜è®¤æ ·å¼å—ï¼Ÿ')) return;

        // æ¸…é™¤æ•°æ®
        localStorage.removeItem('userDeviceSkin');

        // éšè—å›¾ç‰‡å±‚
        const skinImg = document.getElementById('device-skin');
        if (skinImg) {
            skinImg.style.display = 'none';
            skinImg.src = '';
        }

        // æ¢å¤åŸæ¥çš„è¾¹æ¡†æ ·å¼ (è¿™é‡Œæ¢å¤ä¸ºä½ åŸæœ¬çš„CSSè®¾ç½®)
        const phoneFrame = document.querySelector('.phone-frame');
        if (phoneFrame) {
            // å¦‚æœä½ åŸæ¥çš„æ ·å¼å†™åœ¨CSSé‡Œï¼Œè®¾ä¸º null ä¼šç§»é™¤å†…è”æ ·å¼ï¼Œä»è€Œè®©CSSç”Ÿæ•ˆ
            phoneFrame.style.border = '';
        }

        // éšè—â€œæ¢å¤é»˜è®¤â€æŒ‰é’®
        const resetBtn = document.getElementById('reset-skin-btn');
        const sizeControls = document.getElementById('skin-size-controls');
        if (resetBtn) resetBtn.style.display = 'none';
        if (sizeControls) sizeControls.style.display = 'none';
        localStorage.removeItem('skinSizeSettings');
    }

    // 5. æ‰‹æœºå£³å°ºå¯¸è°ƒæ•´ç›¸å…³å‡½æ•°
    
    // åº”ç”¨ä¿å­˜çš„å°ºå¯¸è®¾ç½®
    function applySavedSkinSize() {
        const saved = localStorage.getItem('skinSizeSettings');
        const skinImg = document.getElementById('device-skin');
        
        if (saved && skinImg) {
            const settings = JSON.parse(saved);
            skinImg.style.width = settings.width + 'px';
            skinImg.style.height = settings.height + 'px';
            skinImg.style.transform = `translate(calc(-50% + ${settings.offsetX}px), calc(-50% + ${settings.offsetY}px))`;
            
            // æ›´æ–°è¾“å…¥æ¡†çš„å€¼
            const widthInput = document.getElementById('skin-width-input');
            const heightInput = document.getElementById('skin-height-input');
            const offsetXInput = document.getElementById('skin-offset-x-input');
            const offsetYInput = document.getElementById('skin-offset-y-input');
            
            if (widthInput) widthInput.value = settings.width;
            if (heightInput) heightInput.value = settings.height;
            if (offsetXInput) offsetXInput.value = settings.offsetX;
            if (offsetYInput) offsetYInput.value = settings.offsetY;
        }
    }
    
    // åº”ç”¨å¹¶ä¿å­˜å°ºå¯¸è®¾ç½®
    function applySkinSize() {
        const skinImg = document.getElementById('device-skin');
        const widthInput = document.getElementById('skin-width-input');
        const heightInput = document.getElementById('skin-height-input');
        const offsetXInput = document.getElementById('skin-offset-x-input');
        const offsetYInput = document.getElementById('skin-offset-y-input');
        
        if (!skinImg) return;
        
        const width = parseInt(widthInput.value) || 400;
        const height = parseInt(heightInput.value) || 720;
        const offsetX = parseInt(offsetXInput.value) || 0;
        const offsetY = parseInt(offsetYInput.value) || 0;
        
        // åº”ç”¨æ ·å¼
        skinImg.style.width = width + 'px';
        skinImg.style.height = height + 'px';
        skinImg.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
        
        // ä¿å­˜è®¾ç½®
        const settings = { width, height, offsetX, offsetY };
        localStorage.setItem('skinSizeSettings', JSON.stringify(settings));
        
        alert('âœ… æ‰‹æœºå£³å°ºå¯¸å·²ä¿å­˜ï¼');
    }
    
    // ç»‘å®šåº”ç”¨æŒ‰é’®äº‹ä»¶
    const applySkinSizeBtn = document.getElementById('apply-skin-size-btn');
    if (applySkinSizeBtn) {
        applySkinSizeBtn.addEventListener('click', applySkinSize);
    }

    // ============================================================
    // 1. åˆå§‹åŒ–ï¼šé¡µé¢åŠ è½½æ—¶ï¼Œå¼‚æ­¥ä» IndexedDB è¯»å–çŠ¶æ€
    // ============================================================

    // é»˜è®¤å…ˆè®¾ä¸ºå¼€å¯
    let isActionNarrationOn = true;

    // å®šä¹‰åˆå§‹åŒ–å‡½æ•°
    // ============================================================
    // 4. ã€ä¿®å¤ç‰ˆã€‘åˆå§‹åŒ–å‡½æ•°ï¼šå¸¦â€œç­‰å¾…æ•°æ®åº“å°±ç»ªâ€æœºåˆ¶
    // ============================================================
    async function initNarrationState(retryCount = 0) {
        // A. æ£€æŸ¥ dbHelper æ˜¯å¦å­˜åœ¨
        if (typeof dbHelper === 'undefined') {
            console.log("dbHelper è¿˜æ²¡åŠ è½½ï¼Œ500msåé‡è¯•...");
            setTimeout(() => initNarrationState(retryCount + 1), 500);
            return;
        }

        // B. å…³é”®æ£€æŸ¥ï¼šæ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦å·²ç»æ‰“å¼€ (dbHelper.db æ˜¯å¦ä¸º null)
        // æ³¨æ„ï¼šå‡è®¾ä½ çš„ dbHelper å†…éƒ¨æŠŠæ•°æ®åº“å®ä¾‹å­˜åœ¨ this.db å±æ€§ä¸Š
        if (!dbHelper.db) {
            if (retryCount > 10) {
                console.warn("æ•°æ®åº“è¿æ¥è¶…æ—¶ï¼Œæ”¾å¼ƒè¯»å–æ—ç™½è®¾ç½®ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰ã€‚");
                return;
            }
            console.log(`æ•°æ®åº“æ­£åœ¨è¿æ¥ä¸­... ç­‰å¾… 500ms (ç¬¬ ${retryCount + 1} æ¬¡)`);
            setTimeout(() => initNarrationState(retryCount + 1), 500);
            return;
        }

        // C. æ•°æ®åº“å·²å°±ç»ªï¼Œå¼€å§‹è¯»å–
        try {
            const result = await dbHelper.loadData('settingsStore', 'narrationConfig');

            // å¦‚æœè¯»åˆ°â€œå·²å…³é—­â€ï¼Œåˆ™æ‰§è¡Œå…³é—­é€»è¾‘
            if (result && result.value && result.value.enabled === false) {
                isActionNarrationOn = false;

                // ç«‹å³åº”ç”¨è§†è§‰æ•ˆæœ
                document.body.classList.add('hide-narration-mode');

                if (narrationIconBox) {
                    narrationIconBox.style.filter = 'grayscale(100%)';
                    narrationIconBox.style.opacity = '0.6';
                }
            }
            console.log("âœ… æ—ç™½é…ç½®è¯»å–æˆåŠŸï¼");
        } catch (error) {
            // å¦‚æœè™½ç„¶ db å­˜åœ¨ä½†è¿˜æ˜¯è¯»å¤±è´¥äº†ï¼ˆæ¯”å¦‚è¡¨ä¸å­˜åœ¨ï¼‰ï¼Œä¸å´©æºƒï¼Œåªæ‰“å°è­¦å‘Š
            console.warn("è¯»å–æ—ç™½é…ç½®é‡åˆ°å°é—®é¢˜ (ä¸å½±å“ä½¿ç”¨):", error);
        }
    }

    // å¯åŠ¨åˆå§‹åŒ– (ä¸éœ€è¦å†åŒ… DOMContentLoaded äº†ï¼Œå› ä¸ºå‡½æ•°å†…éƒ¨è‡ªå¸¦é‡è¯•)
    initNarrationState();

    // ç«‹å³æ‰§è¡Œè¯»å–
    // ç­‰å¾…æ•´ä¸ªç½‘é¡µå’Œæ‰€æœ‰è„šæœ¬éƒ½åŠ è½½å®Œæ¯•åï¼Œå†æ‰§è¡Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        // å†æ¬¡æ£€æŸ¥ dbHelper æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢æŠ¥é”™
        if (typeof dbHelper !== 'undefined') {
            initNarrationState();
        } else {
            console.error("ç­‰å¾…é¡µé¢åŠ è½½åä¾ç„¶æ‰¾ä¸åˆ° dbHelperï¼Œè¯·æ£€æŸ¥ä»£ç é¡ºåº");
        }

        // === Global UI Fixes for Safari & Panel Interaction ===
        const chatInput = document.getElementById('chat-message-input');
        
        // Helper to close panel (Aligned with toggleFeaturesPanel logic)
        const closeFeaturesPanel = () => {
            const chatScreen = document.getElementById('chat-screen');
            if (chatScreen) {
                chatScreen.classList.remove('features-panel-active');
            }
        };

        // Fix 4: Close panel on input focus/click (safari fix)
        if (chatInput) {
            chatInput.addEventListener('focus', closeFeaturesPanel);
            chatInput.addEventListener('click', closeFeaturesPanel);
        }

        // Fix 5: Auto-close panel on feature clicks
        document.querySelectorAll('.feature-item').forEach(item => {
            item.addEventListener('click', () => {
                const autoCloseFeatures = [
                    'memory-feature', 
                    'anecdotes-feature', 
                    'peeping-feature', 
                    'ludo-game-feature', 
                    'tic-tac-toe-feature',
                    'transfer-feature',
                    'appointment-feature',
                    'dating-history-feature'
                ];
                
                if (autoCloseFeatures.includes(item.id) || item.id.includes('transfer')) {
                    closeFeaturesPanel();
                }
            });
        });
        
        const transferBtn = document.getElementById('transfer-action-btn'); 
        if (transferBtn) {
             transferBtn.addEventListener('click', closeFeaturesPanel);
        }
    });


    // ============================================================
    // 2. äº¤äº’ï¼šç‚¹å‡»æŒ‰é’®æ—¶ï¼Œåˆ‡æ¢çŠ¶æ€å¹¶å­˜å…¥ IndexedDB
    // ============================================================
    const narrationToggleBtn = document.getElementById('narration-toggle-feature');
    const narrationIconBox = narrationToggleBtn.querySelector('.feature-icon');
    if (narrationToggleBtn) {
        // æ³¨æ„ï¼šå›è°ƒå‡½æ•°åŠ ä¸Š async å…³é”®å­—
        narrationToggleBtn.addEventListener('click', async () => {

            // A. åˆ‡æ¢çŠ¶æ€
            isActionNarrationOn = !isActionNarrationOn;

            // B. è§†è§‰åé¦ˆ (è¿™éƒ¨åˆ†å¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œè®©ç”¨æˆ·é©¬ä¸Šçœ‹åˆ°æ•ˆæœ)
            if (isActionNarrationOn) {
                // === å¼€å¯æ¨¡å¼ ===
                document.body.classList.remove('hide-narration-mode');

                if (typeof narrationIconBox !== 'undefined') {
                    narrationIconBox.style.filter = 'none';
                    narrationIconBox.style.opacity = '1';
                }
                alert("å·²å¼€å¯");

            } else {
                // === å…³é—­æ¨¡å¼ ===
                document.body.classList.add('hide-narration-mode');

                if (typeof narrationIconBox !== 'undefined') {
                    narrationIconBox.style.filter = 'grayscale(100%)';
                    narrationIconBox.style.opacity = '0.6';
                }
                alert("å·²å…³é—­");
            }

            // C. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¼‚æ­¥ä¿å­˜åˆ° IndexedDB
            try {
                // æˆ‘ä»¬å­˜ä¸€ä¸ªå¯¹è±¡ { enabled: true/false }
                await dbHelper.saveData('settingsStore', 'narrationConfig', {
                    enabled: isActionNarrationOn
                });
                console.log("æ—ç™½çŠ¶æ€å·²ä¿å­˜åˆ° IndexedDB");
            } catch (e) {
                console.error("ä¿å­˜æ—ç™½çŠ¶æ€å¤±è´¥:", e);
            }

            // D. å…³é—­é¢æ¿
            if (typeof toggleFeaturesPanel === 'function') {
                toggleFeaturesPanel();
            }
        });
    }

    // ==========================================================
    // === å…¨å±€éŸ³æ•ˆé…ç½® ===
    // ==========================================================

    const enterChatSound = new Audio('./assets/pop.mp3');
    enterChatSound.volume = 0.4;

    // 3. é¢„åŠ è½½ (è®©å®ƒæå‰åŠ è½½å¥½ï¼Œç‚¹å‡»æ—¶é›¶å»¶è¿Ÿæ’­æ”¾)
    enterChatSound.load();

    // ==========================================================
    // === æ’­æ”¾éŸ³æ•ˆå‡½æ•° ===
    // ==========================================================
    function playEnterSound() {
        // 1. æ¯æ¬¡æ’­æ”¾å‰é‡ç½®è¿›åº¦
        enterChatSound.currentTime = 0;

        // 2. å°è¯•æ’­æ”¾ï¼Œå¹¶å¤„ç†â€œè¢«æ‹¦æˆªâ€çš„æƒ…å†µ
        const playPromise = enterChatSound.play();

        if (playPromise !== undefined) {
            playPromise
                .then(_ => {
                    // æ’­æ”¾æˆåŠŸ
                })
                .catch(error => {
                    // æ’­æ”¾è¢«é˜»æ­¢ (é€šå¸¸æ˜¯å› ä¸ºè¿˜æ²¡ç‚¹è¿‡é¡µé¢ï¼Œæˆ–è€…éŸ³é¢‘é“¾æ¥åäº†)
                    console.log("éŸ³æ•ˆæ’­æ”¾æš‚ä¸å¯ç”¨ (å¯èƒ½æ˜¯å› ä¸ºè¿˜æ²¡ä¸é¡µé¢äº¤äº’):", error);

                    // ğŸ’¡ è¿›é˜¶æŠ€å·§ï¼šå¦‚æœæ˜¯ç”¨æˆ·æ²¡äº¤äº’å¯¼è‡´çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç­‰ç”¨æˆ·ç‚¹ç¬¬ä¸€æ¬¡é¡µé¢æ—¶æ‚„æ‚„è§£é”éŸ³é¢‘
                    document.addEventListener('click', unlockAudio, { once: true });
                });
        }
    }

    // è§£é”éŸ³é¢‘çš„å°å‡½æ•°
    function unlockAudio() {
        enterChatSound.play().then(() => {
            enterChatSound.pause(); // æ’­ä¸€ä¸‹ç«‹åˆ»åœï¼Œç›®çš„æ˜¯å‘Šè¯‰æµè§ˆå™¨â€œç”¨æˆ·å…è®¸è¿™ä¸ªç½‘é¡µå‡ºå£°äº†â€
            enterChatSound.currentTime = 0;
        }).catch(() => { });
    }

    // ==========================================================
    // === æ ¸å¿ƒå·¥å…·ï¼šBase64 ä¸ Blob è½¬æ¢ ===
    // ==========================================================

    /**
     * å°† Base64 å­—ç¬¦ä¸²è½¬æ¢ä¸º Blob å¯¹è±¡ (ç”¨äºå­˜å…¥ ZIP)
     */
    function base64ToBlob(base64Data) {
        const arr = base64Data.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], { type: mime });
    }

    /**
     * é€’å½’éå†å¯¹è±¡ï¼Œæå– Base64 å›¾ç‰‡å¹¶æ›¿æ¢ä¸ºå ä½ç¬¦
     * @param {Object} obj - å½“å‰å¤„ç†çš„å¯¹è±¡ (å¼•ç”¨ä¼ é€’)
     * @param {JSZip} imgFolder - ZIP ä¸­çš„ images æ–‡ä»¶å¤¹å¯¹è±¡
     * @param {Object} counterObj - è®¡æ•°å™¨å¯¹è±¡ { count: 0 }
     */
    /**
     * ã€å¢å¼ºç‰ˆã€‘é€’å½’æå– Base64 å›¾ç‰‡ï¼ˆæ”¯æŒçº¯ Base64 å’Œ CSS url() æ ¼å¼ï¼‰
     */
    /**
     * ã€å¢å¼ºç‰ˆã€‘é€’å½’æå– Base64 å›¾ç‰‡ï¼ˆæ”¯æŒå»é‡ï¼‰
     * å¢åŠ äº† imgDedupeMap å‚æ•°
     */
    function extractAndSaveImages(obj, imgFolder, counterObj, imgDedupeMap) {
        if (!obj || typeof obj !== 'object') return;

        for (const key in obj) {
            const value = obj[key];

            // === æƒ…å†µ A: æ™®é€š Base64 å­—ç¬¦ä¸² ===
            if (typeof value === 'string' && value.startsWith('data:image/')) {
                try {
                    // ä¼ å…¥ imgDedupeMap
                    const savedName = saveBase64ToZip(value, imgFolder, counterObj, imgDedupeMap);
                    if (savedName) {
                        obj[key] = `backup://images/${savedName}`;
                    }
                } catch (e) {
                    console.warn(`æå–æ™®é€šå›¾ç‰‡å¤±è´¥: ${key}`, e);
                }
            }
            // === æƒ…å†µ B: CSS URL æ ¼å¼ ===
            else if (typeof value === 'string' && (value.includes('url("data:image') || value.includes("url('data:image") || value.includes('url(data:image'))) {
                try {
                    const match = value.match(/url\((?:['"]?)(data:image\/[^)'"]+)(?:['"]?)\)/);
                    if (match && match[1]) {
                        const base64Content = match[1];
                        // ä¼ å…¥ imgDedupeMap
                        const savedName = saveBase64ToZip(base64Content, imgFolder, counterObj, imgDedupeMap);
                        if (savedName) {
                            obj[key] = `url("backup://images/${savedName}")`;
                        }
                    }
                } catch (e) {
                    console.warn(`æå–CSSèƒŒæ™¯å›¾å¤±è´¥: ${key}`, e);
                }
            }
            // === æƒ…å†µ C: é€’å½’ ===
            else if (typeof value === 'object' && value !== null) {
                // é€’å½’æ—¶ä¹Ÿè¦æŠŠ imgDedupeMap ä¼ ä¸‹å»
                extractAndSaveImages(value, imgFolder, counterObj, imgDedupeMap);
            }
        }
    }

    /**
     * ã€å¢å¼ºç‰ˆã€‘å°† Base64 å­˜å…¥ ZIP å¹¶è¿”å›æ–‡ä»¶å (æ”¯æŒå»é‡)
     * @param {string} base64Data - å›¾ç‰‡å†…å®¹
     * @param {JSZip} imgFolder - ZIP ç›®å½•
     * @param {Object} counterObj - è®¡æ•°å™¨
     * @param {Map} imgDedupeMap - [æ–°å¢] å»é‡è´¦æœ¬ (Key: Base64, Value: FileName)
     */
    function saveBase64ToZip(base64Data, imgFolder, counterObj, imgDedupeMap) {
        // 1. ç®€å•çš„æ ¼å¼æ ¡éªŒ
        if (!base64Data || !base64Data.includes(',')) return null;

        // 2. ã€æ ¸å¿ƒå»é‡ã€‘ï¼šæ£€æŸ¥è¿™å¼ å›¾æ˜¯å¦å·²ç»å­˜è¿‡äº†
        // å¦‚æœè´¦æœ¬é‡Œæœ‰ï¼Œç›´æ¥è¿”å›ä¹‹å‰çš„æ–‡ä»¶åï¼Œä¸å†é‡å¤ä¿å­˜
        if (imgDedupeMap.has(base64Data)) {
            // console.log("å‘ç°é‡å¤å›¾ç‰‡ï¼Œå¤ç”¨å¼•ç”¨..."); 
            return imgDedupeMap.get(base64Data);
        }

        // 3. è‡ªåŠ¨è¯†åˆ«åç¼€
        let extension = 'jpg';
        if (base64Data.includes('image/png')) extension = 'png';
        else if (base64Data.includes('image/gif')) extension = 'gif';
        else if (base64Data.includes('image/webp')) extension = 'webp';

        // 4. ç”Ÿæˆæ–°æ–‡ä»¶å
        const fileName = `img_${counterObj.count++}.${extension}`;

        // 5. æå–çº¯base64éƒ¨åˆ†ï¼ˆç§»é™¤ data:image/...;base64, å‰ç¼€ï¼‰
        const base64Parts = base64Data.split(',');
        if (base64Parts.length < 2) {
            console.warn('æ— æ•ˆçš„base64æ ¼å¼:', base64Data.substring(0, 50));
            return null;
        }
        
        // 6. æ¸…ç†ç©ºç™½å­—ç¬¦ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰
        let pureBase64 = base64Parts[1].replace(/\s/g, '');

        // 7. è½¬æ¢å¹¶å­˜å…¥ ZIP
        const blob = base64ToBlob(pureBase64);
        imgFolder.file(fileName, blob);

        // 8. ã€æ ¸å¿ƒå»é‡ã€‘ï¼šè®°å…¥è´¦æœ¬
        imgDedupeMap.set(base64Data, fileName);

        return fileName;
    }

    /**
 * ç”Ÿæˆè½¬è´¦å¡ç‰‡çš„ HTML å­—ç¬¦ä¸²
 * @param {string} amount - é‡‘é¢
 * @param {string} remark - å¤‡æ³¨
 * @param {string} uuid - æ¶ˆæ¯å”¯ä¸€ID (ç”¨äºåç»­æŸ¥æ‰¾æ›´æ–°)
 * @param {boolean} isUserSender - æ˜¯å¦æ˜¯ç”¨æˆ·å‘é€çš„ (å†³å®šèƒ½å¦ç‚¹å‡»)
 * @param {string} status - åˆå§‹çŠ¶æ€ 'pending' | 'accepted' | 'refused'
 */
function createTransferCardHtml(amount, remark, uuid, isUserSender, status = 'pending') {
    // 0. åŠ¨æ€æ³¨å…¥â€œæœˆç™½ä¸é’é»›â€é£æ ¼ CSS (ä»…æ³¨å…¥ä¸€æ¬¡)
    if (!document.getElementById('london-transfer-styles')) {
        const style = document.createElement('style');
        style.id = 'london-transfer-styles';
        style.textContent = `
        /* ==========================================================
           èŠå¤©è®¾ç½®ç‹¬ç«‹é¡µé¢æ ·å¼ - æœˆç™½ä¸é’é»› / Moon White & Indigo Grey
           é«˜çº§å…‹åˆ¶é£æ ¼ (Advanced & Restrained) - å»iOSåŒ–ï¼Œå»æš–è‰²è°ƒ
           ========================================================== */
        :root {
            --london-bg: #EAEFF2; 
            --london-card: #FFFFFF;
            --london-card-alt: #F4F7F9;
            --london-text-primary: #45494D; /* é’é»›ï¼šè§†è§‰é‡å¿ƒ */
            --london-text-secondary: #5F6B73; /* ç°è“ï¼šæ¬¡è¦ä¿¡æ¯ */
            --london-text-muted: #9FA6AB; /* æ›´æ·¡çš„ç°è‰² */
            --london-accent: #45494D; 
            --london-accent-light: rgba(69, 73, 77, 0.08);
            --london-border: rgba(69, 73, 77, 0.12);
            --london-shadow: 0 4px 12px rgba(69, 73, 77, 0.08); /* æå…‹åˆ¶ */
            --london-shadow-soft: 0 2px 6px rgba(69, 73, 77, 0.04);
            --london-danger: #D4A5A5; /* ä¿æŒä½é¥±å’Œ */
            --london-danger-dark: #C48888;
            --london-success: #8FB3C4; /* å†·è°ƒç»¿/è“ */
        }

        .transfer-card {
            width: 230px;
            background: var(--london-card);
            border: 1px solid var(--london-border);
            border-radius: 14px;
            box-shadow: var(--london-shadow-soft);
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .transfer-card:hover {
            box-shadow: var(--london-shadow);
            transform: translateY(-1px);
        }

        .transfer-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--london-card);
            gap: 12px;
        }

        /* æç®€é’é»›è‰²å›¾æ ‡å®¹å™¨ */
        .transfer-icon-box {
            width: 42px;
            height: 42px;
            background: var(--london-accent);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.3s ease;
        }

        .transfer-icon-svg {
            width: 22px;
            height: 22px;
            fill: #FFFFFF;
        }

        .transfer-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .transfer-amount {
            font-size: 17px;
            font-weight: 600;
            color: var(--london-text-primary);
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .transfer-status-text {
            font-size: 13px;
            color: var(--london-text-secondary);
            margin-top: 2px;
            font-weight: 400;
        }

        .transfer-footer {
            padding: 10px 16px;
            background: var(--london-card-alt);
            border-top: 1px solid var(--london-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transfer-footer span {
            font-size: 11px;
            color: var(--london-text-muted);
            font-weight: 500;
        }

        /* çŠ¶æ€å˜ä½“ */
        .transfer-card.status-accepted .transfer-icon-box {
            background: var(--london-success);
        }

        .transfer-card.status-refused .transfer-icon-box {
            background: var(--london-danger);
        }
        
        /* äº¤äº’é®ç½© - æç®€ç™½é£æ ¼ */
        .transfer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.96); /* é«˜ä»¥å¤ªå®è‰² */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
        }

        .transfer-card.status-selecting .transfer-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        .transfer-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 8px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .action-btn:hover {
            opacity: 0.9;
        }

        .btn-accept {
            background: var(--london-success);
        }

        .btn-refuse {
            background: var(--london-danger);
        }

        .overlay-cancel {
            font-size: 13px;
            color: var(--london-text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0.7;
        }
        .overlay-cancel:hover {
            opacity: 1;
        }

        .overlay-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--london-text-primary);
            margin-bottom: 16px;
        }
        `;
        document.head.appendChild(style);
    }

    // äº¤äº’é€»è¾‘
    let clickAction = '';
    if (!isUserSender && status === 'pending') {
        clickAction = `onclick="event.stopPropagation(); toggleTransferOverlay('${uuid}')"`;
    }
    
    // çŠ¶æ€æ–‡æ¡ˆ
    let targetName = 'æœ‹å‹';
    // ä¿®å¤è½¬è´¦é€»è¾‘ï¼šæ ¹æ®å‘èµ·æ–¹å‡†ç¡®æ˜¾ç¤ºæ”¶æ¬¾äººåå­—
    if (typeof window !== 'undefined' && window.currentOpenContact) {
        if (isUserSender && window.currentOpenContact.ai) {
            // ç”¨æˆ· -> Charï¼Œæ˜¾ç¤º Char åå­—
            targetName = window.currentOpenContact.ai.name;
        } else if (!isUserSender && window.currentOpenContact.user) {
            // Char -> ç”¨æˆ·ï¼Œæ˜¾ç¤º ç”¨æˆ· åå­—
            targetName = window.currentOpenContact.user.name;
        }
    }
    let statusText = `è½¬è´¦ç»™${targetName}`; // é»˜è®¤æ–‡æ¡ˆ
    if (status === 'accepted') statusText = "å·²æ”¶æ¬¾";
    if (status === 'refused') statusText = "å·²é€€å›";

    // å¤‡æ³¨å¤„ç†ï¼šå¤ªé•¿æˆªæ–­
    const displayRemark = remark.length > 10 ? remark.substring(0, 10) + '...' : (remark || 'è½¬è´¦');

    return `
    <div id="transfer-${uuid}" class="transfer-card status-${status}" ${clickAction} data-uuid="${uuid}">
        
        <div class="transfer-header">
            <div class="transfer-icon-box">
                <svg class="transfer-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- è½¬è´¦å›¾æ ‡ï¼šåŒå‘ç®­å¤´ -->
                    <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="transfer-info">
                <div class="transfer-amount">Â¥ ${amount}</div>
                <div class="transfer-status-text">${statusText}</div>
            </div>
        </div>

        <div class="transfer-footer">
            <span>${displayRemark}</span>
            <span>ä¸ƒæ”¯ä»˜</span>
        </div>

        <div class="transfer-overlay">
            <div class="overlay-title">ç¡®è®¤æ”¶æ¬¾ï¼Ÿ</div>
            <div class="transfer-actions">
                <div class="action-btn btn-accept" onclick="window.handleTransferAction(event, '${uuid}', 'accepted', '${amount}')">æ¥æ”¶</div>
                <div class="action-btn btn-refuse" onclick="window.handleTransferAction(event, '${uuid}', 'refused', '${amount}')">é€€å›</div>
            </div>
            <div class="overlay-cancel" onclick="event.stopPropagation(); toggleTransferOverlay('${uuid}')">å–æ¶ˆ</div>
        </div>
    </div>
    `;
}


// 1. åˆ‡æ¢é®ç½©æ˜¾ç¤º/éšè—
window.toggleTransferOverlay = function(uuid) {
    if (event) event.stopPropagation(); // é˜²æ­¢å†’æ³¡
    const card = document.getElementById(`transfer-${uuid}`);
    if (card) {
        // åˆ‡æ¢ selecting ç±»ï¼ŒCSS ä¼šè´Ÿè´£æ˜¾ç¤º/éšè—é®ç½©
        card.classList.toggle('status-selecting');
    }
};

// 2. å¤„ç†æ¥æ”¶/é€€å›
// å¤„ç†â€œæ¥æ”¶â€æˆ–â€œé€€å›â€ç‚¹å‡» (æ•°æ®æŒä¹…åŒ–ä¿®å¤ç‰ˆ)
window.handleTransferAction = async function(event, uuid, action, amount) {
    if (event) event.stopPropagation();

    const card = document.getElementById(`transfer-${uuid}`);
    if (!card) return;

    // --- 1. æ›´æ–° UI (ç«‹åˆ»åé¦ˆ) ---
    card.classList.remove('status-pending', 'status-selecting');
    card.classList.add(`status-${action}`);
    
    const statusTextDiv = card.querySelector('.transfer-status-text');
    if (statusTextDiv) statusTextDiv.textContent = action === 'accepted' ? "å·²æ”¶æ¬¾" : "å·²é€€å›";

    // ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼Œå…³é—­é®ç½©
    card.removeAttribute('onclick');
    const overlay = card.querySelector('.transfer-overlay');
    if (overlay) overlay.style.display = 'none';

    // --- 2. æ›´æ–°æ•°æ®åº“ (æ ¸å¿ƒä¿®å¤) ---
    if (typeof dbHelper === 'undefined') {
        console.error("dbHelper æœªå®šä¹‰ï¼Œæ— æ³•ä¿å­˜çŠ¶æ€");
        return;
    }

    try {
        // åˆ¤æ–­å½“å‰æ˜¯åœ¨å•èŠè¿˜æ˜¯ç¾¤èŠ
        let contextType = 'contact';
        let contextId = null;

        if (currentOpenGroup) {
            contextType = 'group';
            contextId = currentOpenGroup.id;
        } else if (currentOpenContact) {
            contextType = 'contact';
            contextId = currentOpenContact.id;
        } else {
            return;
        }

        // æ‰§è¡Œä¿å­˜
        if (contextType === 'contact') {
            const data = await dbHelper.loadData('messageContacts', 'allContacts');
            let contacts = data.value || [];
            const index = contacts.findIndex(c => c.id === contextId);
            if (index > -1) {
                // æ‰¾åˆ°é‚£æ¡æ¶ˆæ¯
                const msg = contacts[index].history.find(m => m.uuid === uuid);
                if (msg) {
                    msg.transferStatus = action; // ä¿®æ”¹çŠ¶æ€
                    
                    // === æ–°å¢ï¼šæ·»åŠ ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯å‘Šè¯‰ AI ç”¨æˆ·çš„æ“ä½œ ===
                    const actionText = action === 'accepted' ? 'æ¥æ”¶' : 'é€€å›';
                    const notifyMessage = {
                        sender: 'user',
                        text: `[ç”¨æˆ·å·²${actionText}äº†ä½ å‘æ¥çš„ Â¥${amount} è½¬è´¦]`,
                        timestamp: new Date(),
                        uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                        type: 'transfer_notify', // ç‰¹æ®Šç±»å‹ï¼Œç”¨äºæ ‡è¯†è¿™æ˜¯è½¬è´¦é€šçŸ¥
                        isHidden: true // éšè—ä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼Œä½†ä¼šè¿›å…¥å†å²è®°å½•è®© AI çŸ¥é“
                    };
                    contacts[index].history.push(notifyMessage);
                    // === æ–°å¢ç»“æŸ ===
                    
                    await dbHelper.saveData('messageContacts', 'allContacts', contacts); // å­˜å›æ•°æ®åº“
                    console.log(`å•èŠè½¬è´¦ ${action} å·²ä¿å­˜ï¼Œå·²é€šçŸ¥ AI`);
                    // åŒæ­¥å†…å­˜
                    if (currentOpenContact) currentOpenContact.history = contacts[index].history;
                }
            }
        } else {
            // ç¾¤èŠé€»è¾‘
            const data = await dbHelper.loadData('groupChats', 'allGroupChats');
            let groups = data.value || [];
            const index = groups.findIndex(g => g.id === contextId);
            if (index > -1) {
                const msg = groups[index].history.find(m => m.uuid === uuid);
                if (msg) {
                    msg.transferStatus = action;
                    
                    // === æ–°å¢ï¼šæ·»åŠ ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯å‘Šè¯‰ AI ç”¨æˆ·çš„æ“ä½œ ===
                    const actionText = action === 'accepted' ? 'æ¥æ”¶' : 'é€€å›';
                    const notifyMessage = {
                        sender: 'user',
                        text: `[ç”¨æˆ·å·²${actionText}äº†ä½ å‘æ¥çš„ Â¥${amount} è½¬è´¦]`,
                        timestamp: new Date(),
                        uuid: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                        type: 'transfer_notify',
                        isHidden: true
                    };
                    groups[index].history.push(notifyMessage);
                    // === æ–°å¢ç»“æŸ ===
                    
                    await dbHelper.saveData('groupChats', 'allGroupChats', groups);
                    console.log(`ç¾¤èŠè½¬è´¦ ${action} å·²ä¿å­˜ï¼Œå·²é€šçŸ¥ AI`);
                    if (currentOpenGroup) currentOpenGroup.history = groups[index].history;
                }
            }
        }

    } catch (e) {
        console.error("ä¿å­˜è½¬è´¦çŠ¶æ€å¤±è´¥:", e);
        alert("çŠ¶æ€ä¿å­˜å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•");
    }
};



// ==========================================
// å…¨å±€è½¬è´¦å¤„ç†å‡½æ•° (ç‹¬ç«‹äº DOMContentLoaded)
// ==========================================
async function handleTransferActionGlobally(uuid, action, amount) {
    console.log(`å¤„ç†è½¬è´¦: ${uuid} -> ${action}`);

    // 1. ç•Œé¢æ›´æ–° (DOM)
    // å› ä¸º iframe éš”ç¦»ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æ“ä½œ iframe å†…éƒ¨çš„ DOM ç±»å
    // ä½†æ˜¯ï¼æˆ‘ä»¬å·²ç»åœ¨ createTransferCardHtml çš„å†…éƒ¨è„šæœ¬é‡Œå†™äº† `localHandleAction`
    // å®ƒä¼šå…ˆæ›´æ–°è‡ªå·±çš„ UIï¼Œç„¶åæ‰å‘æ¶ˆæ¯ç»™æˆ‘ä»¬ã€‚
    // æ‰€ä»¥è¿™é‡Œå…¶å®ä¸»è¦è´Ÿè´£ **æ•°æ®æŒä¹…åŒ–**ã€‚

    // ä¸ºäº†é˜²æ­¢é¡µé¢åˆ·æ–°åçŠ¶æ€ä¸¢å¤±ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°æ•°æ®åº“
    if (typeof dbHelper === 'undefined') {
        console.error("dbHelper æœªå®šä¹‰ï¼Œæ— æ³•ä¿å­˜è½¬è´¦çŠ¶æ€");
        return;
    }

    try {
        // A. å°è¯•åœ¨å•èŠè”ç³»äººä¸­æŸ¥æ‰¾
        const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
        let contacts = (contactsData && contactsData.value) ? contactsData.value : [];
        let found = false;

        for (let contact of contacts) {
            if (contact.history) {
                const msg = contact.history.find(m => m.uuid === uuid);
                if (msg) {
                    msg.transferStatus = action; // æ›´æ–°çŠ¶æ€
                    found = true;
                    // ä¿å­˜å›æ•°æ®åº“
                    await dbHelper.saveData('messageContacts', 'allContacts', contacts);
                    console.log("å•èŠè½¬è´¦çŠ¶æ€å·²æ›´æ–°");
                    
                    // å¦‚æœå½“å‰æ­£å¥½æ‰“å¼€äº†è¿™ä¸ªå¯¹è¯ï¼Œæ›´æ–°å†…å­˜å¯¹è±¡
                    if (typeof currentOpenContact !== 'undefined' && currentOpenContact && currentOpenContact.id === contact.id) {
                        const memMsg = currentOpenContact.history.find(m => m.uuid === uuid);
                        if (memMsg) memMsg.transferStatus = action;
                    }
                    break;
                }
            }
        }

        // B. å¦‚æœå•èŠæ²¡æ‰¾åˆ°ï¼Œå»ç¾¤èŠæ‰¾
        if (!found) {
            const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
            let groups = (groupsData && groupsData.value) ? groupsData.value : [];

            for (let group of groups) {
                if (group.history) {
                    const msg = group.history.find(m => m.uuid === uuid);
                    if (msg) {
                        msg.transferStatus = action;
                        found = true;
                        await dbHelper.saveData('groupChats', 'allGroupChats', groups);
                        console.log("ç¾¤èŠè½¬è´¦çŠ¶æ€å·²æ›´æ–°");
                        
                        if (typeof currentOpenGroup !== 'undefined' && currentOpenGroup && currentOpenGroup.id === group.id) {
                            const memMsg = currentOpenGroup.history.find(m => m.uuid === uuid);
                            if (memMsg) memMsg.transferStatus = action;
                        }
                        break;
                    }
                }
            }
        }

        if (!found) console.warn("æœªèƒ½åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°å¯¹åº” UUID çš„è½¬è´¦æ¶ˆæ¯");

    } catch (e) {
        console.error("ä¿å­˜è½¬è´¦çŠ¶æ€å¤±è´¥:", e);
    }
}

// ==========================================================
// === çŠ¶æ€æ æ˜¾ç¤º/éšè—åŠŸèƒ½ ===
// ==========================================================
(function initStatusBarToggle() {
    const phoneFrame = document.querySelector('.phone-frame');
    const toggleStatusBar = document.getElementById('toggle-status-bar');
    
    if (!phoneFrame || !toggleStatusBar) return;
    
    // ä» localStorage åŠ è½½è®¾ç½®ï¼ˆé»˜è®¤æ˜¾ç¤º=trueï¼Œæ‰€ä»¥hide-status-baré»˜è®¤ä¸åŠ ï¼‰
    const savedSetting = localStorage.getItem('showStatusBar');
    const showStatusBar = savedSetting === null ? true : savedSetting === 'true';
    
    // åº”ç”¨è®¾ç½®
    toggleStatusBar.checked = showStatusBar;
    if (!showStatusBar) {
        phoneFrame.classList.add('hide-status-bar');
    }
    
    // ç›‘å¬å¼€å…³å˜åŒ–
    toggleStatusBar.addEventListener('change', function() {
        const isVisible = this.checked;
        if (isVisible) {
            phoneFrame.classList.remove('hide-status-bar');
        } else {
            phoneFrame.classList.add('hide-status-bar');
        }
        localStorage.setItem('showStatusBar', isVisible);
    });
})();

    // ==========================================================
    // === äº•å­—æ£‹æ¸¸æˆé€»è¾‘ ===
    // ==========================================================
    
    // æ¸¸æˆçŠ¶æ€å¯¹è±¡
    const ticTacToeState = {
        board: ["-", "-", "-", "-", "-", "-", "-", "-", "-"], // æ£‹ç›˜çŠ¶æ€
        currentTurn: "user", // 'user' | 'ai'
        gameOver: false,
        winner: null, // 'user' | 'ai' | 'draw'
        messages: [], // æ¸¸æˆä¸­çš„å¯¹è¯è®°å½•
        userSymbol: "O", // ç”¨æˆ·æ£‹å­
        aiSymbol: "X"    // AI æ£‹å­
    };

    // DOM å…ƒç´ å¼•ç”¨
    const tttModal = document.getElementById('tic-tac-toe-modal');
    const tttFeature = document.getElementById('tic-tac-toe-feature');
    const tttCloseBtn = document.getElementById('ttt-close-btn');
    const tttBoard = document.getElementById('ttt-board');
    const tttStatus = document.getElementById('ttt-status');
    const tttAiAvatar = document.getElementById('ttt-ai-avatar');
    const tttUserAvatar = document.getElementById('ttt-user-avatar');
    const tttAiBubble = document.getElementById('ttt-ai-bubble');
    const tttUserBubble = document.getElementById('ttt-user-bubble');
    const tttUserFirstBtn = document.getElementById('ttt-user-first-btn');
    const tttAiFirstBtn = document.getElementById('ttt-ai-first-btn');
    const tttStartPanel = document.getElementById('ttt-start-panel');
    const tttChatInputContainer = document.getElementById('ttt-chat-input-container');
    const tttChatInput = document.getElementById('ttt-chat-input');
    const tttSendChatInlineBtn = document.getElementById('ttt-send-chat-inline-btn');
    const tttRestartBtn = document.getElementById('ttt-restart-btn');
    const tttChatModal = document.getElementById('ttt-chat-modal');
    const tttChatModalCloseBtn = document.getElementById('ttt-chat-modal-close-btn');
    const tttChatTextarea = document.getElementById('ttt-chat-textarea');
    const tttSendChatBtn = document.getElementById('ttt-send-chat-btn');

    // 1. åˆå§‹åŒ–æ¸¸æˆ
    function initTicTacToe() {
        // é‡ç½®çŠ¶æ€
        ticTacToeState.board = ["-", "-", "-", "-", "-", "-", "-", "-", "-"];
        ticTacToeState.currentTurn = "user";
        ticTacToeState.gameOver = false;
        ticTacToeState.winner = null;
        ticTacToeState.messages = [];

        // è®¾ç½®å¤´åƒ
        if (currentOpenContact) {
            // AI å¤´åƒï¼šä½¿ç”¨å½“å‰è”ç³»äººçš„ AI å¤´åƒ
            tttAiAvatar.src = currentOpenContact.ai?.avatar || 'https://placehold.co/60x60/EFEFEF/AAAAAA?text=AI';
            
            // User å¤´åƒï¼šä½¿ç”¨å½“å‰è”ç³»äººçš„ç”¨æˆ·å¤´åƒ
            tttUserAvatar.src = currentOpenContact.user?.avatar || 'https://placehold.co/60x60/EFEFEF/AAAAAA?text=User';
            
            console.log('äº•å­—æ£‹å¤´åƒå·²è®¾ç½®:', { ai: tttAiAvatar.src, user: tttUserAvatar.src });
        }

        // æ˜¾ç¤ºé€‰æ‹©å…ˆæ‰‹é¢æ¿
        tttStartPanel.style.display = 'flex';
        tttChatInputContainer.style.display = 'none';
        tttRestartBtn.style.display = 'none';
        tttStatus.textContent = 'é€‰æ‹©å…ˆæ‰‹å¼€å§‹æ¸¸æˆ';
        tttAiBubble.textContent = 'ç­‰å¾…å¼€å§‹...';
        tttUserBubble.textContent = 'å‡†å¤‡å¥½äº†ï¼';

        // æ¸…ç©ºæ£‹ç›˜
        renderBoard();
    }

    // 2. æ¸²æŸ“æ£‹ç›˜
    function renderBoard() {
        const cells = tttBoard.querySelectorAll('.board-cell');
        cells.forEach((cell, index) => {
            const value = ticTacToeState.board[index];
            cell.innerHTML = ''; // æ¸…ç©º
            cell.classList.remove('user-piece', 'ai-piece');

            if (value === ticTacToeState.userSymbol) {
                // æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
                const img = document.createElement('img');
                img.src = tttUserAvatar.src;
                img.classList.add('piece-avatar');
                cell.appendChild(img);
                cell.classList.add('user-piece');
            } else if (value === ticTacToeState.aiSymbol) {
                // æ˜¾ç¤º AI å¤´åƒ
                const img = document.createElement('img');
                img.src = tttAiAvatar.src;
                img.classList.add('piece-avatar');
                cell.appendChild(img);
                cell.classList.add('ai-piece');
            }
        });
    }

    // 3. ç”¨æˆ·ä¸‹æ£‹
    function handleUserMove(position) {
        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å·²å¼€å§‹ï¼ˆå¿…é¡»é€‰æ‹©å…ˆæ‰‹ï¼‰
        if (tttStartPanel.style.display !== 'none') {
            alert('è¯·å…ˆé€‰æ‹©è°å…ˆæ‰‹ï¼');
            return;
        }
        if (ticTacToeState.gameOver) return;
        if (ticTacToeState.currentTurn !== 'user') return;
        if (ticTacToeState.board[position] !== '-') return;

        // ä¸‹æ£‹
        ticTacToeState.board[position] = ticTacToeState.userSymbol;
        renderBoard();

        // æ£€æŸ¥èƒœè´Ÿ
        const result = checkWinner();
        if (result) {
            showGameResult(result);
            return;
        }

        // åˆ‡æ¢å›åˆ
        ticTacToeState.currentTurn = 'ai';
        tttStatus.textContent = 'TAåœ¨æ€è€ƒä¸­...';
        tttAiBubble.textContent = 'è®©æˆ‘æƒ³æƒ³...';

        // å»¶è¿Ÿè°ƒç”¨ AI
        setTimeout(() => {
            triggerAIMove();
        }, 800);
    }

    // 4. è§¦å‘ AI å›åˆ
    async function triggerAIMove() {
        if (!currentOpenContact) {
            console.error('æ²¡æœ‰æ‰“å¼€çš„è”ç³»äºº');
            return;
        }

        try {
            // ä» dbHelper è·å– API é…ç½®
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value || !settingsData.value.url) {
                throw new Error('API æœªé…ç½®ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API');
            }

            const { url, key, model } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // æ„å»ºæ£‹ç›˜çŠ¶æ€å­—ç¬¦ä¸²
            const boardState = ticTacToeState.board.map((v, i) => {
                if (v === '-') return `${i + 1}: ç©º`;
                if (v === ticTacToeState.aiSymbol) return `${i + 1}: X(AI)`;
                return `${i + 1}: O(ç”¨æˆ·)`;
            }).join('\n');

            // æ„å»ºäº•å­—æ£‹å†…çš„å¯¹è¯å†å²
            const tttChatHistory = ticTacToeState.messages.map(m => 
                `${m.sender === 'ai' ? currentOpenContact.name : 'ç”¨æˆ·'}: ${m.text}`
            ).join('\n');

            // è¯»å–çœŸå®çš„èŠå¤©å†å²ï¼ˆæœ€è¿‘10æ¡ï¼‰
            const chatHistory = currentOpenContact.history ? currentOpenContact.history.slice(-10) : [];
            const recentChatHistory = chatHistory.map(msg => {
                if (msg.sender === 'ai') {
                    return `${currentOpenContact.name}: ${msg.text}`;
                } else if (msg.sender === 'user') {
                    return `ç”¨æˆ·: ${msg.text}`;
                } else if (msg.sender === 'system') {
                    return `[ç³»ç»Ÿæ¶ˆæ¯] ${msg.text}`;
                }
                return '';
            }).filter(Boolean).join('\n');

            // è¯»å–ä¸–ç•Œä¹¦
            let worldBookContent = '';
            if (currentOpenContact.worldBooks && currentOpenContact.worldBooks.length > 0) {
                const worldBookEntries = [];
                for (const bookId of currentOpenContact.worldBooks) {
                    const book = await dbHelper.loadData('worldBooksStore', bookId);
                    if (book && book.value && book.value.content) {
                        worldBookEntries.push(book.value.content);
                    }
                }
                if (worldBookEntries.length > 0) {
                    worldBookContent = '\nã€ä¸–ç•Œè®¾å®šã€‘\n' + worldBookEntries.join('\n\n');
                }
            }

            // æ„å»ºå®Œæ•´çš„ System Prompt
            const tttSystemPrompt = `ä½ æ­£åœ¨ä¸ç”¨æˆ·ç©äº•å­—æ£‹æ¸¸æˆã€‚

ã€AI è§’è‰²è®¾å®šã€‘
å§“åï¼š${currentOpenContact.name}
${currentOpenContact.ai?.persona || 'ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ AI åŠ©æ‰‹'}
${worldBookContent}

ã€ç”¨æˆ·è®¾å®šã€‘
${currentOpenContact.user?.persona || 'æ™®é€šç”¨æˆ·'}

ã€ä¹‹å‰çš„èŠå¤©è®°å½•ã€‘
${recentChatHistory || 'æš‚æ— ä¹‹å‰çš„èŠå¤©è®°å½•'}

ã€å½“å‰äº•å­—æ£‹æ¸¸æˆå¯¹è¯ã€‘
${tttChatHistory || 'æš‚æ— æ¸¸æˆå†…å¯¹è¯'}

ã€å½“å‰æ£‹ç›˜çŠ¶æ€ã€‘
${boardState}

è§„åˆ™ï¼šä½ç½®ç¼–å· 1-9ï¼ˆä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹ï¼‰
X = AI çš„æ£‹å­ï¼ŒO = ç”¨æˆ·çš„æ£‹å­ï¼Œç©º = æœªä¸‹

ã€é‡è¦æç¤ºã€‘
1. è¯·ä¿æŒä½ çš„è§’è‰²äººè®¾ï¼Œç”¨ç¬¦åˆä½ æ€§æ ¼çš„æ–¹å¼è¯´è¯
2. å¯ä»¥å‚è€ƒä¹‹å‰çš„èŠå¤©è®°å½•ï¼Œä¿æŒå¯¹è¯çš„è¿è´¯æ€§
3. è¯´è¯è¦ç®€çŸ­ï¼ˆé™åˆ¶åœ¨10å­—ä»¥å†…ï¼‰
4. åªèƒ½é€‰æ‹©ç©ºä½ä¸‹æ£‹

ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘
ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼å›å¤ï¼š
[CHAT]ä½ æƒ³è¯´çš„è¯ï¼ˆé™åˆ¶åœ¨10å­—ä»¥å†…ï¼Œç¬¦åˆä½ çš„äººè®¾ï¼‰[/CHAT]
[MOVE]ä½ è¦ä¸‹çš„ä½ç½®(1-9)[/MOVE]

ç¤ºä¾‹ï¼š
[CHAT]è¿™æ­¥æˆ‘èµ¢å®šäº†~[/CHAT]
[MOVE]5[/MOVE]`;

            // è°ƒç”¨ AI API
            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: tttSystemPrompt },
                        { role: 'user', content: 'è¯·æ ¹æ®å½“å‰æ£‹ç›˜çŠ¶æ€ï¼Œå†³å®šä½ çš„ä¸‹ä¸€æ­¥æ£‹ï¼Œå¹¶è¯´ä¸€å¥ç¬¦åˆä½ äººè®¾çš„è¯ã€‚' }
                    ],
                    temperature: 0.9
                })
            });

            if (!response.ok) {
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;

            console.log('[äº•å­—æ£‹] AI åŸå§‹å›å¤:', aiResponse);

            // è§£æ AI å›å¤
            parseAIResponse(aiResponse);

        } catch (error) {
            console.error('AI å›åˆå‡ºé”™:', error);
            tttAiBubble.textContent = 'å‡ºé”™äº†...';
            tttStatus.textContent = 'è¯·é‡æ–°å¼€å§‹æ¸¸æˆ';
            ticTacToeState.gameOver = true;
        }
    }

    // 5. è§£æ AI å›å¤
    function parseAIResponse(response) {
        // æå–èŠå¤©å†…å®¹
        const chatMatch = response.match(/\[CHAT\]([\s\S]*?)\[\/CHAT\]/);
        const aiMessage = chatMatch ? chatMatch[1].trim() : "...";

        // æå–ä¸‹æ£‹ä½ç½®
        const moveMatch = response.match(/\[MOVE\](\d)\[\/MOVE\]/);
        let aiMove = moveMatch ? parseInt(moveMatch[1]) : null;

        // éªŒè¯ç§»åŠ¨æœ‰æ•ˆæ€§
        if (aiMove === null || aiMove < 1 || aiMove > 9 || ticTacToeState.board[aiMove - 1] !== '-') {
            // è‡ªåŠ¨é€‰æ‹©ç©ºä½
            const emptyPositions = ticTacToeState.board
                .map((v, i) => v === '-' ? i : null)
                .filter(i => i !== null);
            if (emptyPositions.length > 0) {
                aiMove = emptyPositions[0] + 1;
            } else {
                return; // æ£‹ç›˜å·²æ»¡
            }
        }

        // è®°å½•å¯¹è¯
        ticTacToeState.messages.push({
            sender: 'ai',
            text: aiMessage
        });

        // æ˜¾ç¤º AI æ°”æ³¡
        tttAiBubble.textContent = aiMessage;

        // AI ä¸‹æ£‹
        ticTacToeState.board[aiMove - 1] = ticTacToeState.aiSymbol;
        renderBoard();

        // æ£€æŸ¥èƒœè´Ÿ
        const result = checkWinner();
        if (result) {
            showGameResult(result);
            return;
        }

        // åˆ‡æ¢å›åˆ
        ticTacToeState.currentTurn = 'user';
        tttStatus.textContent = 'è½®åˆ°ä½ ä¸‹æ£‹äº†';
    }

    // 6. æ£€æŸ¥èƒœè´Ÿ
    function checkWinner() {
        const b = ticTacToeState.board;
        const winPatterns = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // æ¨ª
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // ç«–
            [0, 4, 8], [2, 4, 6]             // æ–œ
        ];

        // æ£€æŸ¥æ˜¯å¦æœ‰äººè·èƒœ
        for (const pattern of winPatterns) {
            const [a, b_idx, c] = pattern;
            if (b[a] !== '-' && b[a] === b[b_idx] && b[a] === b[c]) {
                return b[a] === ticTacToeState.userSymbol ? 'user' : 'ai';
            }
        }

        // æ£€æŸ¥å¹³å±€
        if (!b.includes('-')) {
            return 'draw';
        }

        return null;
    }

    // 7. æ˜¾ç¤ºæ¸¸æˆç»“æœ
    async function showGameResult(result) {
        ticTacToeState.gameOver = true;
        ticTacToeState.winner = result;

        let resultText = '';
        if (result === 'user') {
            resultText = 'ä½ èµ¢äº†ï¼ğŸ‰';
            tttUserBubble.textContent = 'æˆ‘èµ¢å•¦ï¼';
        } else if (result === 'ai') {
            resultText = `${currentOpenContact.ai.name} è·èƒœï¼`;
            tttAiBubble.textContent = 'æˆ‘èµ¢äº†~';
        } else {
            resultText = 'å¹³å±€ï¼';
            tttUserBubble.textContent = 'å¹³å±€å‘¢';
            tttAiBubble.textContent = 'æ‰“å¹³äº†';
        }

        tttStatus.textContent = resultText;
        tttRestartBtn.style.display = 'block';

        // æ¸¸æˆç»“æŸåï¼Œè§¦å‘AIå›å¤ï¼ˆä¸ä¿å­˜åˆ°èŠå¤©å†å²ï¼Œé¿å…æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼‰
        if (currentOpenContact) {
            // æ„å»ºæ¸¸æˆå¯¹è¯è®°å½•
            const gameLog = ticTacToeState.messages.map(m => 
                `${m.sender === 'ai' ? currentOpenContact.name : 'ä½ '}: ${m.text}`
            ).join('\n');

            // æ„å»ºæ£‹ç›˜æœ€ç»ˆçŠ¶æ€
            const finalBoard = ticTacToeState.board.map((v, i) => {
                const pos = i + 1;
                if (v === '-') return `${pos}: ç©º`;
                if (v === ticTacToeState.aiSymbol) return `${pos}: X(${currentOpenContact.name})`;
                return `${pos}: O(ä½ )`;
            }).join(', ');

            const gameResultText = result === 'user' ? 'ä½ è·èƒœ' : (result === 'ai' ? `${currentOpenContact.name}è·èƒœ` : 'å¹³å±€');
            
            // å»¶è¿Ÿè§¦å‘ AI å›å¤ï¼ˆä½¿ç”¨å›æ‰§åŠŸèƒ½ï¼‰
            setTimeout(() => {
                console.log('[äº•å­—æ£‹] è§¦å‘AIå›å¤æ¸¸æˆç»“æœ');
                
                // æ„å»ºå®Œæ•´çš„ç³»ç»ŸæŒ‡ä»¤ï¼ŒåŒ…å«æ¸¸æˆä¿¡æ¯
                const triggerPayload = `(ç³»ç»ŸæŒ‡ä»¤ï¼šåˆšåˆšç»“æŸäº†ä¸€å±€äº•å­—æ£‹æ¸¸æˆã€‚

ã€æ¸¸æˆç»“æœã€‘${gameResultText}

ã€æ¸¸æˆå¯¹è¯ã€‘
${gameLog || 'ï¼ˆæ— å¯¹è¯ï¼‰'}

ã€æœ€ç»ˆæ£‹ç›˜ã€‘${finalBoard}

è¯·æ ¹æ®è¿™å±€æ¸¸æˆè¯´è¯´ä½ çš„æ„Ÿæƒ³ã€è¯„è®ºæˆ–ååº”ã€‚)`;
                
                // è°ƒç”¨ callAI å‡½æ•°è§¦å‘å›å¤
                if (typeof callAI === 'function') {
                    callAI(triggerPayload, currentOpenContact);
                } else {
                    console.error('[äº•å­—æ£‹] callAI å‡½æ•°æœªæ‰¾åˆ°');
                }
            }, 1500);
        }
        
        console.log('æ¸¸æˆç»“æŸ:', resultText);
    }

    // 8. ç”¨æˆ·è¯´è¯åŠŸèƒ½
    function sendUserChat() {
        const message = tttChatTextarea.value.trim();
        if (!message) return;

        // è®°å½•å¯¹è¯
        ticTacToeState.messages.push({
            sender: 'user',
            text: message
        });

        // æ˜¾ç¤ºæ°”æ³¡
        tttUserBubble.textContent = message;
        
        // æ¸…ç©ºè¾“å…¥
        tttChatTextarea.value = '';
        
        // å…³é—­å¼¹çª—
        tttChatModal.style.display = 'none';
    }

    // === äº‹ä»¶ç»‘å®š ===

    // æ‰“å¼€æ¸¸æˆ
    if (tttFeature) {
        tttFeature.addEventListener('click', () => {
            if (!currentOpenContact) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº');
                return;
            }
            tttModal.style.display = 'flex';
            initTicTacToe();
            // å…³é—­æ›´å¤šåŠŸèƒ½é¢æ¿
            if (typeof toggleFeaturesPanel === 'function') {
                toggleFeaturesPanel();
            }
        });
    }

    // å…³é—­æ¸¸æˆ
    if (tttCloseBtn) {
        tttCloseBtn.addEventListener('click', () => {
            tttModal.style.display = 'none';
        });
    }

    // é€‰æ‹©ç”¨æˆ·å…ˆæ‰‹
    if (tttUserFirstBtn) {
        tttUserFirstBtn.addEventListener('click', () => {
            
            tttStartPanel.style.display = 'none';
           
            
            tttChatInputContainer.style.display = 'flex';
            
            ticTacToeState.currentTurn = 'user';
            tttStatus.textContent = 'ä½ å…ˆæ‰‹ï¼Œè¯·ä¸‹æ£‹';
            tttAiBubble.textContent = 'ä½ å…ˆæ¥å§~';
            
            
        });
    }

    // é€‰æ‹© AI å…ˆæ‰‹
    if (tttAiFirstBtn) {
        tttAiFirstBtn.addEventListener('click', () => {
            
            
            tttStartPanel.style.display = 'none';
            
            
            
            tttChatInputContainer.style.display = 'flex';
           
            
            ticTacToeState.currentTurn = 'ai';
            tttStatus.textContent = 'TAåœ¨æ€è€ƒä¸­...';
            tttUserBubble.textContent = 'çœ‹ä½ çš„äº†';
            
            
            setTimeout(() => {
                triggerAIMove();
            }, 800);
        });
    }

    // æ£‹ç›˜ç‚¹å‡»
    if (tttBoard) {
        tttBoard.addEventListener('click', (e) => {
            const cell = e.target.closest('.board-cell');
            if (!cell) return;
            const index = parseInt(cell.dataset.index);
            handleUserMove(index);
        });
    }

    // å†…è”èŠå¤©è¾“å…¥æ¡† - å‘é€æŒ‰é’®ç‚¹å‡»
    if (tttSendChatInlineBtn && tttChatInput) {
        tttSendChatInlineBtn.addEventListener('click', () => {
            const message = tttChatInput.value.trim();
            if (!message) return;

            // è®°å½•å¯¹è¯
            ticTacToeState.messages.push({
                sender: 'user',
                text: message
            });

            // æ˜¾ç¤ºæ°”æ³¡
            tttUserBubble.textContent = message;
            
            // æ¸…ç©ºè¾“å…¥
            tttChatInput.value = '';
            
            console.log('[äº•å­—æ£‹] ç”¨æˆ·å‘é€æ¶ˆæ¯:', message);
        });
    }

    // å†…è”èŠå¤©è¾“å…¥æ¡† - å›è½¦å‘é€
    if (tttChatInput) {
        tttChatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                tttSendChatInlineBtn.click();
            }
        });
    }


    // å…³é—­èŠå¤©å¼¹çª—
    if (tttChatModalCloseBtn) {
        tttChatModalCloseBtn.addEventListener('click', () => {
            tttChatModal.style.display = 'none';
        });
    }

    // å‘é€èŠå¤©
    if (tttSendChatBtn) {
        tttSendChatBtn.addEventListener('click', sendUserChat);
    }

    // å›è½¦å‘é€
    if (tttChatTextarea) {
        tttChatTextarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendUserChat();
            }
        });
    }

    // é‡æ–°å¼€å§‹
    if (tttRestartBtn) {
        tttRestartBtn.addEventListener('click', () => {
            initTicTacToe();
        });
    }

    // ç‚¹å‡»èƒŒæ™¯å…³é—­èŠå¤©å¼¹çª—
    if (tttChatModal) {
        tttChatModal.addEventListener('click', (e) => {
            if (e.target === tttChatModal) {
                tttChatModal.style.display = 'none';
            }
        });
    }

    // ==========================================================
    // === é£è¡Œæ£‹æ¸¸æˆé€»è¾‘ (Ludo Game) ===
    // ==========================================================


    // æ¸¸æˆçŠ¶æ€
    const ludoGameState = {
        aiPosition: 0,        // AIæ£‹å­ä½ç½® (0èµ·ç‚¹, 1-30, 31ç»ˆç‚¹)
        userPosition: 0,      // ç”¨æˆ·æ£‹å­ä½ç½®
        currentTurn: 'user',  // 'user' | 'ai'
        diceValue: null,      // å½“å‰éª°å­ç‚¹æ•°
        isRolling: false,     // æ˜¯å¦æ­£åœ¨æ·éª°å­
        isMoving: false,      // æ˜¯å¦æ­£åœ¨ç§»åŠ¨
        gameOver: false,
        winner: null,
        messages: [],         // æ¸¸æˆå†…å¯¹è¯
        currentTruthQuestion: null
    };

    // ç‰¹æ®Šæ ¼å­é…ç½® (20æ ¼)
    // æ ¼å­ç±»å‹: 'normal', 'bonus', 'penalty', 'skip', 'truth'
    const specialCells = {
        3: 'bonus',
        5: 'truth',
        6: 'normal',
        9: 'skip',
        12: 'bonus',
        14: 'truth',
        15: 'penalty',
        18: 'normal'
    };

    // é¢„è®¾ (ä¿ç•™å¤‡ç”¨)
    const truthQuestions = [
        "ä½ æœ€å–œæ¬¢çš„äººæ˜¯è°ï¼Ÿ",
        "ä½ åšè¿‡æœ€å°´å°¬çš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ",
        "å¦‚æœæ˜å¤©æ˜¯ä¸–ç•Œæœ«æ—¥ï¼Œä½ æœ€æƒ³å’Œè°åœ¨ä¸€èµ·ï¼Ÿ",
        "ä½ æœ‰æ²¡æœ‰å·å·å–œæ¬¢è¿‡èº«è¾¹çš„äººï¼Ÿ",
        "ä½ è§‰å¾—æˆ‘å“ªé‡Œæœ€å¸å¼•ä½ ï¼Ÿ",
        "ä½ æœ€è¿‘ä¸€æ¬¡å“­æ˜¯å› ä¸ºä»€ä¹ˆï¼Ÿ",
        "ä½ æœ€å¤§çš„æ¢¦æƒ³æ˜¯ä»€ä¹ˆï¼Ÿ",
        "å¦‚æœå¯ä»¥å›åˆ°è¿‡å»ï¼Œä½ æœ€æƒ³æ”¹å˜ä»€ä¹ˆï¼Ÿ",
        "ä½ æœ‰æ²¡æœ‰æ’’è¿‡ä¸€ä¸ªä»æœªè¢«å‘ç°çš„è°ï¼Ÿ",
        "ä½ å¯¹è‡ªå·±å“ªä¸ªéƒ¨ä½æœ€ä¸æ»¡æ„ï¼Ÿ",
        "ä½ æœ€å®³æ€•ä»€ä¹ˆï¼Ÿ",
        "å¦‚æœç»™ä½ ä¸€ç™¾ä¸‡ï¼Œä½ æ„¿æ„ç¦»å¼€ç°åœ¨çš„ç”Ÿæ´»å—ï¼Ÿ",
        "ä½ æœ‰æ²¡æœ‰åœ¨å¿ƒé‡Œé»˜é»˜éª‚è¿‡æˆ‘ï¼Ÿ",
        "ä½ æœ€è®¨åŒå¼‚æ€§ä»€ä¹ˆè¡Œä¸ºï¼Ÿ",
        "ä½ åˆå»æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Ÿ",
        "ä½ æ‰‹æœºé‡Œæœ€åä¸€å¼ ç…§ç‰‡æ˜¯ä»€ä¹ˆï¼Ÿ",
        "ä½ è§‰å¾—çœŸçˆ±å­˜åœ¨å—ï¼Ÿ",
        "ä½ æœ‰æ²¡æœ‰åæ‚”è®¤è¯†è¿‡æŸä¸ªäººï¼Ÿ",
        "å¦‚æœå¯ä»¥æ‹¥æœ‰ä¸€ç§è¶…èƒ½åŠ›ï¼Œä½ å¸Œæœ›æ˜¯ä»€ä¹ˆï¼Ÿ",
        "ä½ ç°åœ¨æœ€æƒ³å¯¹æ­¤æ—¶æ­¤åˆ»çš„æˆ‘è¯´ä»€ä¹ˆï¼Ÿ"
    ];

    // æƒ©ç½šé¢„è®¾
    const punishmentTasks = [
        "å‘ä¸€ä¸ªçº¢åŒ…ï¼Œé‡‘é¢éšæ„ã€‚",
        "å”±ä¸€é¦–æ­Œå¹¶å‘è¯­éŸ³è¿‡æ¥ã€‚",
        "å‘ä¸€å¼ ä½ çš„è‡ªæ‹ç…§ã€‚",
        "å¯¹æˆ‘æ’’ä¸ªå¨‡ã€‚",
        "å­¦ä¸‰å£°çŒ«å«å¹¶å‘è¯­éŸ³ã€‚",
        "å¤¸æˆ‘ä¸‰åˆ†é’Ÿä¸è®¸é‡å¤ã€‚",
        "æ¢ä¸€ä¸ªæˆ‘æŒ‡å®šçš„å¤´åƒä¸€å¤©ã€‚",
        "å‘æœ‹å‹åœˆè¯´â€œæˆ‘æ˜¯çŒªâ€å¹¶æˆªå›¾ã€‚",
        "ç»™æˆ‘è®²ä¸€ä¸ªå†·ç¬‘è¯ã€‚",
        "æ¨¡ä»¿æˆ‘æœ€è¿‘çš„ä¸€å¥è¯ã€‚",
        "çˆ†ç…§ï¼ˆç§å¯†ç…§é™¤å¤–ï¼‰ã€‚",
        "è¯´å‡ºæˆ‘çš„ä¸‰ä¸ªä¼˜ç‚¹ã€‚",
        "çœŸå¿ƒè¯šæ„åœ°å‘æˆ‘è¡¨ç™½ä¸€æ¬¡ã€‚",
        "ç”¨æ–¹è¨€è¯´ä¸€å¥â€œæˆ‘å–œæ¬¢ä½ â€ã€‚",
        "è¿ç»­å‘åä¸ªä½ æœ€å–œæ¬¢çš„è¡¨æƒ…åŒ…ã€‚",
        "å›ç­”æˆ‘ä¸€ä¸ªä»»æ„é—®é¢˜ï¼Œä¸è®¸æ’’è°ã€‚",
        "å«æˆ‘ä¸‰å£°â€œä¸»äººâ€æˆ–â€œäº²çˆ±çš„â€ã€‚",
        "å»ç»™æˆ‘çš„æœ€æ–°æœ‹å‹åœˆç‚¹èµå¹¶è¯„è®ºå…¨æ˜¯å¤¸æˆ‘çš„è¯ã€‚",
        "ç»™æˆ‘å‘ä¸€æ®µä¸å°‘äº30å­—çš„åœŸå‘³æƒ…è¯ã€‚",
        "å¦ç™½ä¸€ä»¶ä½ ä»æœªå‘Šè¯‰è¿‡æˆ‘çš„ç§˜å¯†ã€‚"
    ];

    const TOTAL_CELLS = 20; // æ€»æ ¼å­æ•°

    // ç”°å­—å½¢æ£‹ç›˜æ ¼å­åæ ‡ (20æ ¼ç¯å½¢, 6x6ç½‘æ ¼å¸ƒå±€)
    function generateBoardPositions() {
        const positions = [];
        const cellSize = 40;  // æ ¼å­å¤§å°
        const gap = 4;        // æ ¼å­é—´éš™
        const step = cellSize + gap; // æ­¥è¿›è·ç¦»
        const margin = 12;    // è¾¹è·
        
        // 20æ ¼å¸ƒå±€éœ€è¦ 6x6 çš„ç½‘æ ¼å‘¨é•¿ (6+5+5+4 = 20)
        
        // é¡¶è¾¹: 1-6 (ä»å·¦åˆ°å³, å«å³ä¸Šè§’)
        // x: 0 to 5, y: 0
        for (let i = 0; i < 6; i++) {
            positions.push({
                x: margin + i * step,
                y: margin,
                index: i + 1
            });
        }
        
        // å³è¾¹: 7-11 (ä»ä¸Šåˆ°ä¸‹, å«å³ä¸‹è§’)
        // x: 5, y: 1 to 5
        for (let i = 0; i < 5; i++) {
            positions.push({
                x: margin + 5 * step,
                y: margin + (i + 1) * step,
                index: 7 + i
            });
        }
        
        // åº•è¾¹: 12-16 (ä»å³åˆ°å·¦, å«å·¦ä¸‹è§’)
        // x: 4 to 0, y: 5
        for (let i = 0; i < 5; i++) {
            positions.push({
                x: margin + (4 - i) * step,
                y: margin + 5 * step,
                index: 12 + i
            });
        }
        
        // å·¦è¾¹: 17-20 (ä»ä¸‹åˆ°ä¸Š, ä¸å«å·¦ä¸Šè§’)
        // x: 0, y: 4 to 1
        for (let i = 0; i < 4; i++) {
            positions.push({
                x: margin,
                y: margin + (4 - i) * step,
                index: 17 + i
            });
        }
        
        return positions;
    }

    const boardPositions = generateBoardPositions();

    // DOMå…ƒç´ 
    const ludoModal = document.getElementById('ludo-game-modal');
    const ludoFeature = document.getElementById('ludo-game-feature');
    const ludoCloseBtn = document.getElementById('ludo-close-btn');
    const ludoExportCssBtn = document.getElementById('ludo-export-css-btn');
    const ludoBoard = document.getElementById('ludo-board');
    const ludoDice = document.getElementById('ludo-dice');
    const ludoStatus = document.getElementById('ludo-status');
    const ludoAiAvatar = document.getElementById('ludo-ai-avatar');
    const ludoUserAvatar = document.getElementById('ludo-user-avatar');
    const ludoAiBubble = document.getElementById('ludo-ai-bubble');
    const ludoUserBubble = document.getElementById('ludo-user-bubble');
    const ludoStartPanel = document.getElementById('ludo-start-panel');
    const ludoUserFirstBtn = document.getElementById('ludo-user-first-btn');
    const ludoAiFirstBtn = document.getElementById('ludo-ai-first-btn');
    const ludoRollBtn = document.getElementById('ludo-roll-btn');
    const ludoChatInputContainer = document.getElementById('ludo-chat-input-container');
    const ludoChatInput = document.getElementById('ludo-chat-input');
    const ludoSendChatBtn = document.getElementById('ludo-send-chat-btn');
    const ludoRestartBtn = document.getElementById('ludo-restart-btn');
    // çœŸå¿ƒè¯ç›¸å…³å…ƒç´ å·²ç§»é™¤

    // åˆå§‹åŒ–æ¸¸æˆ
    function initLudoGame() {
        ludoGameState.aiPosition = 0;
        ludoGameState.userPosition = 0;
        ludoGameState.currentTurn = 'user';
        ludoGameState.diceValue = null;
        ludoGameState.isRolling = false;
        ludoGameState.isMoving = false;
        ludoGameState.gameOver = false;
        ludoGameState.winner = null;
        ludoGameState.messages = [];
        
        // è®¾ç½®å¤´åƒ
        if (currentOpenContact) {
            ludoAiAvatar.src = currentOpenContact.ai?.avatar || 'https://placehold.co/60x60/FF6B6B/fff?text=AI';
            ludoUserAvatar.src = currentOpenContact.user?.avatar || 'https://placehold.co/60x60/4ECDC4/fff?text=U';
        }

        // å¦‚æœæ˜¯ç­‰å¾…çœŸå¿ƒè¯/æƒ©ç½šå›å¤
        if (ludoGameState.isUserReplyingSpecial) {
             ludoGameState.isUserReplyingSpecial = false;
             
             // æ„å»ºç»™AIçš„ä¸Šä¸‹æ–‡ï¼Œè®©AIçŸ¥é“ç”¨æˆ·å›ç­”äº†ä»€ä¹ˆ
             const question = ludoGameState.currentTruthQuestion || "ä¸€ä¸ªçœŸå¿ƒè¯é—®é¢˜";
             ludoGameState.pendingContext = `(ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšæ‰å›ç­”äº†çœŸå¿ƒè¯é—®é¢˜â€œ${question}â€ï¼Œå›ç­”å†…å®¹æ˜¯ï¼šâ€œ${text}â€ã€‚è¯·ä½ åœ¨æ¥ä¸‹æ¥çš„è¡ŒåŠ¨ä¸­å¯¹ç”¨æˆ·çš„å›ç­”åšå‡ºååº”/è¯„ä»·ã€‚)`;
             delete ludoGameState.currentTruthQuestion;

             ludoStatus.textContent = 'å›ç­”å·²è®°å½•ï¼Œè½®åˆ°TAäº†...';
             setTimeout(switchTurn, 1500);
             return;
        }

        // æ˜¾ç¤ºå…ˆæ‰‹é€‰æ‹©
        ludoStartPanel.style.display = 'flex';
        ludoRollBtn.style.display = 'none';
        ludoChatInputContainer.style.display = 'none';
        ludoRestartBtn.style.display = 'none';
        ludoStatus.textContent = 'é€‰æ‹©å…ˆæ‰‹å¼€å§‹æ¸¸æˆ';
        ludoAiBubble.textContent = 'å‡†å¤‡èµ·é£~';
        ludoUserBubble.textContent = 'å‡ºå‘å§ï¼';

        // æ¸²æŸ“éª°å­
        renderDice(1);
        // æ¸²æŸ“æ£‹ç›˜
        renderLudoBoard();
    }

    // æ¸²æŸ“æ£‹ç›˜
    function renderLudoBoard() {
        if (!ludoBoard) return;
        
        let svgContent = '';
        const cellSize = 40; // ä¸ç”Ÿæˆå‡½æ•°ä¸€è‡´

        // ç»˜åˆ¶æ ¼å­
        boardPositions.forEach((pos, idx) => {
            const cellNum = idx + 1;
            let cellClass = 'ludo-cell';
            
            if (cellNum === 1) cellClass += ' cell-start';
            else if (cellNum === TOTAL_CELLS) cellClass += ' cell-end';
            else if (specialCells[cellNum]) {
                cellClass += ` cell-${specialCells[cellNum]}`;
            }

            svgContent += `
                <rect 
                    class="${cellClass}" 
                    x="${pos.x}" 
                    y="${pos.y}" 
                    width="${cellSize}" 
                    height="${cellSize}" 
                    rx="8"
                    data-cell="${cellNum}"
                ></rect>
                <text 
                    class="ludo-cell-number" 
                    x="${pos.x + cellSize/2}" 
                    y="${pos.y + cellSize/2 + 4}" 
                    text-anchor="middle"
                >${cellNum}</text>
            `;
        });

        // ç»˜åˆ¶èµ·ç‚¹æ ‡è®°
        svgContent += `
            <text x="${boardPositions[0].x + cellSize/2}" y="${boardPositions[0].y - 5}" 
                  text-anchor="middle" font-size="10" fill="var(--ludo-text-color)" font-weight="bold">èµ·ç‚¹</text>
        `;

        // ç»˜åˆ¶ç»ˆç‚¹æ ‡è®°
        svgContent += `
            <text x="${boardPositions[TOTAL_CELLS - 1].x + cellSize/2}" y="${boardPositions[TOTAL_CELLS - 1].y - 5}" 
                  text-anchor="middle" font-size="10" fill="var(--ludo-text-highlight)" font-weight="bold">ç»ˆç‚¹</text>
        `;

        // ç»˜åˆ¶é£æœºæ£‹å­ - ä½¿ç”¨æ›´å¯çˆ±çš„åœ†æ¶¦ç®­å¤´æ ·å¼
        
        // AIé£æœº (çº¢è‰²)
        const aiPos = ludoGameState.aiPosition === 0 ? 
            { x: 120, y: 130 } : // èµ·ç‚¹ä½ç½®
            (ludoGameState.aiPosition > TOTAL_CELLS ? 
                { x: 140, y: 140 } : // ç»ˆç‚¹
                { x: boardPositions[ludoGameState.aiPosition - 1].x + cellSize/2, 
                  y: boardPositions[ludoGameState.aiPosition - 1].y + cellSize/2 - 8 });
        
        svgContent += `
            <g id="ludo-ai-piece" class="ludo-piece ai-piece" transform="translate(${aiPos.x - 12}, ${aiPos.y - 10})">
                <defs>
                    <linearGradient id="aiGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF8A80;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#FF5252;stop-opacity:1" />
                    </linearGradient>
                    <filter id="pieceShadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                        <feOffset dx="0" dy="2" result="offsetblur"/>
                        <feComponentTransfer>
                            <feFuncA type="linear" slope="0.3"/>
                        </feComponentTransfer>
                        <feMerge>
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <!-- åœ†æ¶¦ç®­å¤´ä¸»ä½“ (æŒ‡å‘å³ä¸Šæ–¹) -->
                <path d="M4,16 C4,16 6,4 12,4 C18,4 20,4 20,8 C20,12 20,20 12,20 C6,20 4,16 4,16 Z" 
                      fill="url(#aiGradient)" filter="url(#pieceShadow)"/>
                <!-- å†…éƒ¨è£…é¥° -->
                <path d="M12,8 L16,12 L12,16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </g>
        `;

        // ç”¨æˆ·é£æœº (é’è‰²)
        const userPos = ludoGameState.userPosition === 0 ? 
            { x: 160, y: 150 } : // èµ·ç‚¹ä½ç½®
            (ludoGameState.userPosition > TOTAL_CELLS ? 
                { x: 140, y: 140 } : // ç»ˆç‚¹
                { x: boardPositions[ludoGameState.userPosition - 1].x + cellSize/2, 
                  y: boardPositions[ludoGameState.userPosition - 1].y + cellSize/2 + 8 });
        
        svgContent += `
            <g id="ludo-user-piece" class="ludo-piece user-piece" transform="translate(${userPos.x - 12}, ${userPos.y - 10})">
                <defs>
                    <linearGradient id="userGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#80DEEA;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#26C6DA;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <!-- åœ†æ¶¦ç®­å¤´ä¸»ä½“ -->
                <path d="M4,16 C4,16 6,4 12,4 C18,4 20,4 20,8 C20,12 20,20 12,20 C6,20 4,16 4,16 Z" 
                      fill="url(#userGradient)" filter="url(#pieceShadow)"/>
                <!-- å†…éƒ¨è£…é¥° -->
                <path d="M12,8 L16,12 L12,16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </g>
        `;

        ludoBoard.innerHTML = svgContent;
    }

    // æ¸²æŸ“éª°å­
    function renderDice(value) {
        if (!ludoDice) return;
        
        const dotPatterns = {
            1: ['center'],
            2: ['tl', 'br'],
            3: ['tl', 'center', 'br'],
            4: ['tl', 'tr', 'bl', 'br'],
            5: ['tl', 'tr', 'center', 'bl', 'br'],
            6: ['tl', 'tr', 'ml', 'mr', 'bl', 'br']
        };

        const dots = dotPatterns[value] || dotPatterns[1];
        let dotsHtml = dots.map(pos => `<span class="dot ${pos}"></span>`).join('');
        
        ludoDice.innerHTML = `<div class="dice-face" data-face="${value}">${dotsHtml}</div>`;
    }

    // ç”¨æˆ·æ·éª°å­ï¼ˆéšæœºï¼‰
    async function rollDiceForUser() {
        if (ludoGameState.isRolling || ludoGameState.isMoving || ludoGameState.gameOver) return;
        if (ludoGameState.waitingForTruth) return;

        ludoGameState.isRolling = true;
        ludoRollBtn.disabled = true;
        ludoDice.classList.add('rolling');

        // éª°å­åŠ¨ç”»
        let rollCount = 0;
        const maxRolls = 12;
        const rollInterval = setInterval(() => {
            const randomValue = Math.floor(Math.random() * 6) + 1;
            renderDice(randomValue);
            rollCount++;
            if (rollCount >= maxRolls) {
                clearInterval(rollInterval);
                // æœ€ç»ˆç»“æœ
                const finalValue = Math.floor(Math.random() * 6) + 1;
                ludoGameState.diceValue = finalValue;
                renderDice(finalValue);
                ludoDice.classList.remove('rolling');
                ludoGameState.isRolling = false;
                
                ludoStatus.textContent = `ä½ æ·å‡ºäº† ${finalValue} ç‚¹ï¼`;
                
                // å»¶è¿Ÿåæ‰§è¡Œç§»åŠ¨
                setTimeout(() => {
                    handleMove(finalValue);
                }, 600);
            }
        }, 80);
    }

    // AI çœŸå¿ƒè¯ç‹¬ç«‹å›å¤é€»è¾‘
    async function triggerAILudoTruthResponse(question) {
        if (!currentOpenContact) return;

        try {
            // è·å–APIé…ç½®
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            const { url, key, model } = settingsData?.value || {};
            
            if (!url || !key) {
                ludoAiBubble.textContent = '(AIé…ç½®ç¼ºå¤±ï¼Œæ— æ³•å›ç­”)';
                setTimeout(switchTurn, 3000);
                return;
            }

            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // æ„å»º Prompt - å¢åŠ å®‰å…¨æ£€æŸ¥
            const aiInfo = currentOpenContact.ai || {};
            const userInfo = currentOpenContact.user || {};
            const aiPersona = aiInfo.persona || aiInfo.description || 'æ— è®¾å®š';
            const userPersona = userInfo.persona || 'æ™®é€šç”¨æˆ·';

            const systemPrompt = `ä½ æ­£åœ¨å’Œç”¨æˆ·ç©é£è¡Œæ£‹ã€‚ä½ è¸©åˆ°äº†â€œçœŸå¿ƒè¯â€æ ¼å­ã€‚
åªèƒ½ç”¨ç¬¦åˆä½ äººè®¾çš„è¯­æ°”å›ç­”ï¼Œä¸è¦è·³å‡ºè§’è‰²ã€‚
ä½ çš„å›ç­”åº”è¯¥ç®€çŸ­ã€æœ‰è¶£ã€ç¬¦åˆå½“ä¸‹æƒ…å¢ƒã€‚

ã€é¢˜ç›®ã€‘
${question}

ã€è§’è‰²è®¾å®šã€‘
ä½ : ${aiInfo.name || 'AI'} (${aiPersona})
ç”¨æˆ·: ${userInfo.name || 'ç”¨æˆ·'} (${userPersona})
`;

            const messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: `è¯·å›ç­”çœŸå¿ƒè¯é¢˜ç›®ï¼š${question}` }
            ];

            // è¯·æ±‚ API - ç§»é™¤ max_tokens å’Œ å¼ºåˆ¶æ¨¡å‹é»˜è®¤å€¼ï¼Œé˜²æ­¢éƒ¨åˆ† Provider æŠ¥é”™
            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: model, // æœ‰åˆ™ä¼ ï¼Œæ— åˆ™undefined (é€šå¸¸ç”±åç«¯å†³å®šé»˜è®¤)
                    messages: messages,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                 const errText = await response.text();
                 throw new Error(`APIé”™è¯¯: ${response.status} - ${errText}`);
            }

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content || '(æ²‰é»˜)';

            // æ›´æ–°æ¸¸æˆç•Œé¢
            ludoAiBubble.textContent = reply;
            ludoGameState.messages.push({ sender: 'ai', text: reply });
            
            // å­˜å…¥ä¸»å†å² (å®‰å…¨å¤„ç†)
            if (!currentOpenContact.history) {
                 currentOpenContact.history = [];
            }
            currentOpenContact.history.push({
                sender: 'ai',
                text: `(åœ¨é£è¡Œæ£‹çœŸå¿ƒè¯ä¸­å›ç­”): ${reply}`,
                timestamp: Date.now()
            });

            // æ ¸å¿ƒä¿®å¤ï¼šobjectStore åç§°ä¿®æ­£
            // ä¹‹å‰çš„ä»£ç ä½¿ç”¨äº† 'contactsStore'ï¼Œä½†å®é™…ä¸Šæ•°æ®åº“ä¸­æ˜¯ 'messageContacts'
            await dbHelper.saveData('messageContacts', currentOpenContact);

            // å»¶è¿Ÿååˆ‡å›åˆ
            setTimeout(switchTurn, 4000); // ç•™é•¿ä¸€ç‚¹æ—¶é—´ç»™ç”¨æˆ·é˜…è¯»
            
        } catch (error) {
            console.error('AI Truth Error:', error);
            // å°†è¯¦ç»†é”™è¯¯æ˜¾ç¤ºåœ¨æ°”æ³¡ä¸­ï¼Œæ–¹ä¾¿æ’æŸ¥
            ludoAiBubble.textContent = `(AIå‡ºé”™: ${error.message.substring(0, 15)}...)`;
            setTimeout(switchTurn, 4000);
        }
    }

    // AIå›åˆ - è°ƒç”¨APIè·å–éª°å­å’Œå¯¹è¯
    async function triggerAILudoTurn() {
        if (ludoGameState.gameOver) return;

        ludoStatus.textContent = `${currentOpenContact?.name || 'TA'}æ­£åœ¨æ€è€ƒ...`;

        try {
            // è·å–APIé…ç½®
            const settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData?.value?.url) {
                // æ²¡æœ‰APIé…ç½®ï¼Œä½¿ç”¨éšæœº
                fallbackAITurn();
                return;
            }

            const { url, key, model } = settingsData.value;
            let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            completionsUrl += '/chat/completions';

            // æ„å»ºæ¸¸æˆçŠ¶æ€æè¿°
            const aiPosDesc = ludoGameState.aiPosition === 0 ? 'èµ·ç‚¹' : `ç¬¬${ludoGameState.aiPosition}æ ¼`;
            const userPosDesc = ludoGameState.userPosition === 0 ? 'èµ·ç‚¹' : `ç¬¬${ludoGameState.userPosition}æ ¼`;
            
            // è¯»å–èŠå¤©å†å²
            const chatHistory = currentOpenContact?.history ? currentOpenContact.history.slice(-8) : [];
            const recentChatHistory = chatHistory.map(msg => {
                if (msg.sender === 'ai') return `${currentOpenContact.name}: ${msg.text}`;
                if (msg.sender === 'user') return `ç”¨æˆ·: ${msg.text}`;
                return '';
            }).filter(Boolean).join('\n');

            // è¯»å–ä¸–ç•Œä¹¦
            let worldBookContent = '';
            if (currentOpenContact?.worldBooks?.length > 0) {
                const entries = [];
                for (const bookId of currentOpenContact.worldBooks) {
                    const book = await dbHelper.loadData('worldBooksStore', bookId);
                    if (book?.value?.content) entries.push(book.value.content);
                }
                if (entries.length > 0) worldBookContent = '\nã€ä¸–ç•Œè®¾å®šã€‘\n' + entries.join('\n\n');
            }

            // æ¸¸æˆå†…å¯¹è¯å†å²
            const ludoChatHistory = ludoGameState.messages.map(m => 
                `${m.sender === 'ai' ? currentOpenContact.name : 'ç”¨æˆ·'}: ${m.text}`
            ).join('\n');

            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·åˆšå›ç­”äº†çœŸå¿ƒè¯ï¼‰
            let specialContext = "";
            if (ludoGameState.pendingContext) {
                specialContext = "\nã€é‡è¦æç¤ºã€‘" + ludoGameState.pendingContext + "\nè¯·åŠ¡å¿…åœ¨ä½ çš„å›ç­”ä¸­å¯¹ä¸Šè¿°å†…å®¹é€šè¿‡åæ§½ã€èµèµæˆ–è¿½é—®ç­‰æ–¹å¼åšå‡ºååº”ï¼\n";
                ludoGameState.pendingContext = null; // æ¶ˆè´¹æ‰è¿™ä¸ªä¸Šä¸‹æ–‡
            }

            // æ„å»ºprompt
            const ludoSystemPrompt = `ä½ æ­£åœ¨ä¸ç”¨æˆ·ç©é£è¡Œæ£‹æ¸¸æˆã€‚ä½ çš„åå­—æ˜¯"${currentOpenContact?.name || 'TA'}"ã€‚${specialContext} 

ã€è§’è‰²è®¾å®šã€‘
${currentOpenContact?.ai?.persona || 'ä½ æ˜¯ä¸€ä¸ªæ€§æ ¼é²œæ˜çš„è§’è‰²ã€‚'}
${worldBookContent}

ã€å½“å‰çš„å¯¹è¯è¯­å¢ƒã€‘
${recentChatHistory || 'ï¼ˆæš‚æ— ä¹‹å‰å¯¹è¯ï¼‰'}

ã€æ¸¸æˆå†…å³æ—¶è®°å½•ã€‘
${ludoChatHistory || 'ï¼ˆæ¸¸æˆåˆšå¼€å§‹ï¼‰'}

ã€å½“å‰å±€é¢ã€‘
- ä½ åœ¨: ${aiPosDesc}
- ç”¨æˆ·åœ¨: ${userPosDesc}
- ç›®æ ‡: ç¬¬${TOTAL_CELLS}æ ¼
- çŠ¶å†µ: è½®åˆ°ä½ æ·éª°å­

ã€è¡ŒåŠ¨å‡†åˆ™ã€‘
1. **å®Œå…¨ä»£å…¥è§’è‰²**ï¼šå¿…é¡»ç”¨"${currentOpenContact?.name || 'TA'}"çš„è¯­æ°”ã€å£ç™–å’Œæ€§æ ¼è¯´è¯ã€‚
2. **æ‹’ç»æœºæ¢°æ„Ÿ**ï¼šä¸è¦å¤è¿°è§„åˆ™ï¼Œä¸è¦è¯´"è½®åˆ°æˆ‘äº†"ã€‚ç›´æ¥æ ¹æ®å±€é¢å‘è¡¨æ„Ÿæƒ³ï¼ˆç¥ˆç¥·å¥½è¿ã€æ”¾ç‹ è¯ã€é—²èŠçš†å¯ï¼‰ã€‚
3. **ç®€çŸ­è‡ªç„¶**ï¼šåƒçœŸäººä¸€æ ·èŠå¤©ï¼Œä¸€ä¸¤å¥è¯å³å¯ï¼ˆ20å­—ä»¥å†…ï¼‰ã€‚

ã€è¾“å‡ºæ ¼å¼ã€‘
[CHAT]ä½ çš„è¯[/CHAT]`;

            const response = await fetch(completionsUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: ludoSystemPrompt },
                        { role: 'user', content: 'è½®åˆ°ä½ äº†ï¼Œè¯·è¯´ä¸€å¥è¯ï¼ˆéª°å­ç‚¹æ•°å°†ç”±ç³»ç»Ÿéšæœºç”Ÿæˆï¼‰ã€‚' }
                    ],
                    temperature: 0.9
                })
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            console.log('[é£è¡Œæ£‹] AIåŸå§‹å›å¤:', aiResponse);

            // è§£æAIå›å¤
            parseAILudoResponse(aiResponse);

        } catch (error) {
            console.error('[é£è¡Œæ£‹] AIå›åˆå‡ºé”™:', error);
            fallbackAITurn();
        }
    }

    // è§£æAIçš„é£è¡Œæ£‹å›å¤
    async function parseAILudoResponse(response) {
        // æå–å¯¹è¯å†…å®¹
        const chatMatch = response.match(/\[CHAT\]([\s\S]*?)\[\/CHAT\]/);
        const aiMessage = chatMatch ? chatMatch[1].trim() : (response.replace(/\[.*?\]/g, '').trim() || 'èµ°èµ·~');

        // å…¬å¹³éª°å­ï¼šå®Œå…¨ç”±ç³»ç»Ÿéšæœºç”Ÿæˆ (1-6)
        // AIæ— æ³•å†æ“çºµç‚¹æ•°
        const diceValue = Math.floor(Math.random() * 6) + 1;

        // è®°å½•å¯¹è¯
        ludoGameState.messages.push({ sender: 'ai', text: aiMessage });

        // æ˜¾ç¤ºAIè¯´çš„è¯
        ludoAiBubble.textContent = aiMessage;
        ludoStatus.textContent = `${currentOpenContact?.name || 'TA'}æ­£åœ¨æ·éª°å­...`;

        await delay(800);

        // æ’­æ”¾éª°å­åŠ¨ç”»
        ludoDice.classList.add('rolling');
        let rollCount = 0;
        const maxRolls = 10;
        
        await new Promise(resolve => {
            const rollInterval = setInterval(() => {
                renderDice(Math.floor(Math.random() * 6) + 1);
                rollCount++;
                if (rollCount >= maxRolls) {
                    clearInterval(rollInterval);
                    resolve();
                }
            }, 80);
        });

        // æ˜¾ç¤ºæœ€ç»ˆéª°å­
        renderDice(diceValue);
        ludoDice.classList.remove('rolling');
        ludoGameState.diceValue = diceValue;
        
        ludoStatus.textContent = `${currentOpenContact?.name || 'TA'}æ·å‡ºäº† ${diceValue} ç‚¹ï¼`;
        
        await delay(800);

        // æ‰§è¡Œç§»åŠ¨
        await handleMove(diceValue);
    }

    // å¤‡ç”¨AIå›åˆï¼ˆæ— APIæ—¶ï¼‰
    async function fallbackAITurn() {
        const phrases = ['çœ‹æˆ‘çš„ï¼', 'è¿™æ¬¡ä¸€å®šå¤§ï¼', 'å†²å†²å†²~', 'å˜¿å˜¿~', 'èµ°èµ·ï¼', 'é£é«˜é«˜ï¼'];
        ludoAiBubble.textContent = phrases[Math.floor(Math.random() * phrases.length)];
        
        await delay(600);

        // æ·éª°å­åŠ¨ç”»
        ludoDice.classList.add('rolling');
        let rollCount = 0;
        const maxRolls = 10;
        const diceValue = Math.floor(Math.random() * 6) + 1;
        
        await new Promise(resolve => {
            const rollInterval = setInterval(() => {
                renderDice(Math.floor(Math.random() * 6) + 1);
                rollCount++;
                if (rollCount >= maxRolls) {
                    clearInterval(rollInterval);
                    resolve();
                }
            }, 80);
        });

        renderDice(diceValue);
        ludoDice.classList.remove('rolling');
        ludoGameState.diceValue = diceValue;
        
        ludoStatus.textContent = `${currentOpenContact?.name || 'TA'}æ·å‡ºäº† ${diceValue} ç‚¹ï¼`;
        
        await delay(800);
        await handleMove(diceValue);
    }

    // å¤„ç†ç§»åŠ¨ - æ”¾æ…¢é€Ÿåº¦
    async function handleMove(steps) {
        const player = ludoGameState.currentTurn;
        const currentPos = player === 'user' ? ludoGameState.userPosition : ludoGameState.aiPosition;
        let newPos = currentPos + steps;
        
        // ä¸èƒ½è¶…è¿‡ç»ˆç‚¹
        if (newPos > TOTAL_CELLS) newPos = TOTAL_CELLS;
        
        ludoGameState.isMoving = true;
        
        // å¦‚æœåœ¨èµ·ç‚¹ï¼Œå…ˆç§»åŠ¨åˆ°æ ¼å­1
        if (currentPos === 0) {
            if (player === 'user') {
                ludoGameState.userPosition = 1;
            } else {
                ludoGameState.aiPosition = 1;
            }
            renderLudoBoard();
            await delay(500);
            newPos = 1 + steps - 1;
            if (newPos > TOTAL_CELLS) newPos = TOTAL_CELLS;
        }

        // é€æ ¼ç§»åŠ¨åŠ¨ç”» - æ…¢é€Ÿ
        const startPos = player === 'user' ? ludoGameState.userPosition : ludoGameState.aiPosition;
        for (let i = startPos + 1; i <= newPos; i++) {
            if (player === 'user') {
                ludoGameState.userPosition = i;
            } else {
                ludoGameState.aiPosition = i;
            }
            
            // æ·»åŠ é£è¡ŒåŠ¨ç”»
            const piece = document.getElementById(player === 'user' ? 'ludo-user-piece' : 'ludo-ai-piece');
            if (piece) {
                piece.classList.add('flying');
            }
            
            renderLudoBoard();
            await delay(400); // æ”¾æ…¢é€Ÿåº¦
            
            if (piece) {
                piece.classList.remove('flying');
                piece.classList.add('landing');
                setTimeout(() => piece.classList.remove('landing'), 400);
            }
        }

        ludoGameState.isMoving = false;

        // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹
        if (newPos >= TOTAL_CELLS) {
            ludoGameState.gameOver = true;
            ludoGameState.winner = player;
            showLudoGameResult();
            return;
        }

        // æ£€æŸ¥ç‰¹æ®Šæ ¼å­
        await checkSpecialCell(newPos, player);
    }

    // æ£€æŸ¥ç‰¹æ®Šæ ¼å­
    async function checkSpecialCell(position, player) {
        const cellType = specialCells[position];
        
        if (!cellType) {
            // æ™®é€šæ ¼å­ï¼Œåˆ‡æ¢å›åˆ
            switchTurn();
            return;
        }

        const playerName = player === 'user' ? 'ä½ ' : (currentOpenContact?.name || 'TA');

        switch (cellType) {
            case 'bonus':
                // å‰è¿›2æ ¼
                ludoStatus.textContent = `ğŸ‰ ${playerName}è¸©åˆ°äº†åŠ é€Ÿæ ¼ï¼Œå‰è¿›2æ ¼ï¼`;
                await delay(1200);
                await handleMove(2);
                return; // handleMove å†…éƒ¨ä¼šè°ƒ switchTurnï¼Œæ‰€ä»¥è¿™é‡Œreturn

            case 'penalty':
                // åé€€2æ ¼
                const currentPos = player === 'user' ? ludoGameState.userPosition : ludoGameState.aiPosition;
                ludoStatus.textContent = `ğŸ˜… ${playerName}è¸©åˆ°äº†å‡é€Ÿæ ¼ï¼Œåé€€2æ ¼ï¼`;
                await delay(800);
                
                // æ‰§è¡Œå€’é€€ç§»åŠ¨åŠ¨ç”»
                // ... (ç®€åŒ–å¤„ç†ï¼Œç›´æ¥è®¾ç½®ä½ç½®)
                const newPosP = Math.max(1, currentPos - 2);
                if (player === 'user') ludoGameState.userPosition = newPosP;
                else ludoGameState.aiPosition = newPosP;
                
                renderLudoBoard();
                await delay(1000);
                switchTurn();
                break;

            case 'skip':
                // åŸåœ°è¸æ­¥
                ludoStatus.textContent = `â¸ï¸ ${playerName}è¸©åˆ°äº†æš‚åœæ ¼ï¼Œä¼‘æ¯ä¸€è½®ï¼`;
                await delay(1200);
                switchTurn();
                break;

            case 'truth':
                const tQ = truthQuestions[Math.floor(Math.random() * truthQuestions.length)];
                if (player === 'user') {
                    // ç”¨æˆ·è¸©åˆ°çœŸå¿ƒè¯ï¼šå¼¹çª—æç¤ºï¼Œå¹¶è¦æ±‚åœ¨èŠå¤©æ¡†å›å¤
                    alert(`ã€çœŸå¿ƒè¯ã€‘\nè¯·å›ç­”ï¼š${tQ}\n\n(è¯·åœ¨èŠå¤©è¾“å…¥æ¡†å‘é€ä½ çš„å›ç­”ä»¥ç»“æŸå›åˆ)`);
                    ludoStatus.textContent = `è¯·åœ¨èŠå¤©æ¡†å›ç­”ï¼š${tQ}`;
                    
                    // è®¾ç½®çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·å›å¤
                    ludoGameState.isUserReplyingSpecial = true; 
                    ludoGameState.currentTruthQuestion = tQ; // è®°å½•é¢˜ç›®ä»¥ä¾¿åç»­å¼•ç”¨
                    // ä¸è°ƒç”¨ switchTurnï¼Œç­‰å¾…ç”¨æˆ·å‘é€æ¶ˆæ¯è§¦å‘
                } else {
                    // AIè¸©åˆ°çœŸå¿ƒè¯
                    // 1. ç•Œé¢ä¸Šæ˜¾ç¤ºé¢˜ç›®
                    const truthMsg = `(é¢˜ç›®: ${tQ})`;
                    ludoStatus.textContent = `TAæ­£åœ¨æ€è€ƒé¢˜ç›®...`;
                    ludoAiBubble.textContent = truthMsg; // åœ¨æ°”æ³¡é‡Œæ˜¾ç¤ºé¢˜ç›®
                    ludoGameState.messages.push({ sender: 'ai', text: truthMsg }); // è®°å…¥æ¸¸æˆè®°å½•

                    // 2. è§¦å‘ç‹¬ç«‹å›å¤é€»è¾‘ (ä¸èµ°ä¸»èŠå¤©ç•Œé¢)
                    triggerAILudoTruthResponse(tQ);
                    return; 
                }
                break;

            case 'punishment':
                const pT = punishmentTasks[Math.floor(Math.random() * punishmentTasks.length)];
                if (player === 'user') {
                    alert(`ã€å¤§å†’é™©/æƒ©ç½šã€‘\nè¯·æ‰§è¡Œï¼š${pT}\n\n(è¯·åœ¨èŠå¤©è¾“å…¥æ¡†æè¿°ä½ çš„è¡ŒåŠ¨ä»¥ç»“æŸå›åˆ)`);
                    ludoStatus.textContent = `è¯·åœ¨èŠå¤©æ¡†å®Œæˆæƒ©ç½šï¼š${pT}`;
                    
                    ludoGameState.isUserReplyingSpecial = true;
                } else {
                    ludoStatus.textContent = `TAé¢ä¸´æƒ©ç½š...`;
                    const sysMsg = `(ç³»ç»Ÿæç¤ºï¼šä½ è¸©åˆ°äº†â€œå¤§å†’é™©/æƒ©ç½šâ€æ ¼å­ã€‚æƒ©ç½šå†…å®¹æ˜¯ï¼š${pT}ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾åšå‡ºååº”ã€‚å¦‚æœéœ€è¦å‘çº¢åŒ…æˆ–è¯­éŸ³ï¼Œè¯·ç”¨æ–‡å­—æè¿°ä½ çš„è¡ŒåŠ¨ã€‚)`;
                    // æ ¸å¿ƒä¿®å¤ï¼šä¼ é€’ currentOpenContact
                    setTimeout(() => callAI(sysMsg, currentOpenContact), 1000);
                    return;
                }
                break;

            default:
                switchTurn();
        }
    }

   

    // åˆ‡æ¢å›åˆ
    function switchTurn() {
        if (ludoGameState.gameOver) return;

        ludoGameState.currentTurn = ludoGameState.currentTurn === 'user' ? 'ai' : 'user';
        
        if (ludoGameState.currentTurn === 'user') {
            ludoStatus.textContent = 'è½®åˆ°ä½ æ·éª°å­äº†ï¼';
            ludoRollBtn.disabled = false;
        } else {
            ludoStatus.textContent = `${currentOpenContact?.name || 'TA'}æ­£åœ¨æ€è€ƒ...`;
            ludoRollBtn.disabled = true;
            // AIå›åˆ
            setTimeout(() => {
                triggerAILudoTurn();
            }, 1000);
        }
    }

    // æ˜¾ç¤ºæ¸¸æˆç»“æœ
    async function showLudoGameResult() {
        const winner = ludoGameState.winner;
        const playerName = winner === 'user' ? 'ä½ ' : (currentOpenContact?.name || 'TA');
        
        ludoStatus.textContent = `ğŸ‰ ${playerName}è·èƒœï¼`;
        
        if (winner === 'user') {
            ludoUserBubble.textContent = 'æˆ‘èµ¢å•¦ï¼';
            ludoAiBubble.textContent = 'ä¸‹æ¬¡å†æˆ˜ï¼';
        } else {
            ludoAiBubble.textContent = 'æˆ‘èµ¢å•¦~';
            ludoUserBubble.textContent = 'å†æ¥ä¸€å±€ï¼';
        }

        ludoRollBtn.style.display = 'none';
        ludoRestartBtn.style.display = 'block';

        // è§¦å‘AIå›å¤
        if (currentOpenContact) {
            setTimeout(() => {
                const gameLog = ludoGameState.messages.map(m => 
                    `${m.sender === 'ai' ? currentOpenContact.name : 'ä½ '}: ${m.text}`
                ).join('\n');

                const resultText = winner === 'user' ? 'ä½ è·èƒœ' : (winner === 'ai' ? `${currentOpenContact.name}è·èƒœ` : 'æ¸¸æˆç»“æŸ');
                
                // --- æ–°å¢ï¼šéšæœºæƒ©ç½šç”Ÿæˆé€»è¾‘ ---
                const randomPunishment = punishmentTasks[Math.floor(Math.random() * punishmentTasks.length)];
                let punishmentText = "";
                
                if (winner === 'user') {
                    // ç”¨æˆ·èµ¢äº†ï¼ŒAIå—ç½š
                    punishmentText = `ã€æƒ©ç½šç¯èŠ‚ã€‘ä½ è¾“äº†ï¼è¯·æ¥å—æƒ©ç½šï¼š${randomPunishment}\n(è¯·AIæ ¹æ®ä½ çš„æ€§æ ¼ï¼Œé€‰æ‹©æ‰§è¡Œè¿™ä¸ªæƒ©ç½šï¼Œæˆ–è€…ç”¨æœ‰è¶£çš„æ–¹å¼èµ–æ‰ï¼Œæˆ–è€…æ’’å¨‡æ±‚é¥¶ï¼Œæ€»ä¹‹è¦æœ‰ååº”)`;
                    alert(`ğŸ‰ ä½ èµ¢äº†ï¼\n\néšæœºç”Ÿæˆçš„æƒ©ç½šæ˜¯ï¼š\n${randomPunishment}\n\n(å·²é€šçŸ¥ï¼Œçœ‹TAæ€ä¹ˆè¯´~)`);
                } else {
                    // AIèµ¢äº†ï¼Œç”¨æˆ·å—ç½š
                    punishmentText = `ã€æƒ©ç½šç¯èŠ‚ã€‘ç”¨æˆ·è¾“äº†ï¼ç”¨æˆ·æŠ½åˆ°çš„æƒ©ç½šæ˜¯ï¼š${randomPunishment}\n(è¯·æ ¹æ®ä½ çš„æ€§æ ¼ï¼Œå˜²ç¬‘ã€è°ƒä¾ƒç”¨æˆ·ï¼Œæˆ–è€…ç›‘ç£ç”¨æˆ·æ‰§è¡Œæƒ©ç½š)`;
                    alert(`ğŸ˜­ ä½ è¾“äº†ï¼\n\nä½ æŠ½åˆ°çš„æƒ©ç½šæ˜¯ï¼š\n${randomPunishment}\n\n(TAæ­£åœ¨çœ‹ç€ä½ å“¦...)`);
                }
                
                // æ„å»ºå®Œæ•´çš„ç³»ç»ŸæŒ‡ä»¤
                const triggerPayload = `(ç³»ç»ŸæŒ‡ä»¤ï¼šåˆšåˆšç»“æŸäº†ä¸€å±€é£è¡Œæ£‹æ¸¸æˆã€‚
                
ã€æ¸¸æˆç»“æœã€‘${resultText}

ã€æœ€ç»ˆä½ç½®ã€‘
AI: ç¬¬ ${ludoGameState.aiPosition} æ ¼ (å…±${TOTAL_CELLS}æ ¼)
ç”¨æˆ·: ç¬¬ ${ludoGameState.userPosition} æ ¼ (å…±${TOTAL_CELLS}æ ¼)

${punishmentText}

ã€æ¸¸æˆå¯¹è¯ã€‘
${gameLog || 'ï¼ˆæ— å¯¹è¯ï¼‰'}

è¯·æ ¹æ®è¿™å±€æ¸¸æˆç»“æœå’Œæƒ©ç½šç¯èŠ‚ï¼Œè¯´è¯´ä½ çš„æ„Ÿæƒ³ã€è¯„è®ºæˆ–ååº”ã€‚`;

                // è°ƒç”¨ callAI å‡½æ•°è§¦å‘å›å¤
                if (typeof callAI === 'function') {
                    console.log('[é£è¡Œæ£‹] è§¦å‘AIå›å¤:', triggerPayload);
                    callAI(triggerPayload, currentOpenContact);
                } else {
                    console.error("callAI å‡½æ•°æœªå®šä¹‰ï¼Œæ— æ³•è§¦å‘å›å¤");
                }
            }, 1000);
        }
    }

    // å¯¼å‡ºCSSä¸ºJSON
    function exportLudoCSS() {
        const root = document.documentElement;
        const computedStyle = getComputedStyle(root);
        
        const cssVars = {
            "ludo-primary": computedStyle.getPropertyValue('--ludo-primary').trim() || '#FFD93D',
            "ludo-secondary": computedStyle.getPropertyValue('--ludo-secondary').trim() || '#6BCB77',
            "ludo-accent": computedStyle.getPropertyValue('--ludo-accent').trim() || '#4D96FF',
            "ludo-bg-start": computedStyle.getPropertyValue('--ludo-bg-start').trim() || '#FFFBEB',
            "ludo-bg-end": computedStyle.getPropertyValue('--ludo-bg-end').trim() || '#E8F5E9',
            "ludo-cell-normal": computedStyle.getPropertyValue('--ludo-cell-normal').trim() || '#FFF8E7',
            "ludo-cell-bonus": computedStyle.getPropertyValue('--ludo-cell-bonus').trim() || '#B4F8C8',
            "ludo-cell-penalty": computedStyle.getPropertyValue('--ludo-cell-penalty').trim() || '#FFADAD',
            "ludo-cell-truth": computedStyle.getPropertyValue('--ludo-cell-truth').trim() || '#FFD6E8',
            "ludo-cell-start": computedStyle.getPropertyValue('--ludo-cell-start').trim() || '#A0C4FF',
            "ludo-cell-end": computedStyle.getPropertyValue('--ludo-cell-end').trim() || '#FFE066',
            "ludo-console-bg": computedStyle.getPropertyValue('--ludo-console-bg').trim() || '#2D2D2D',
            "ludo-plane-ai": computedStyle.getPropertyValue('--ludo-plane-ai').trim() || '#FF6B6B',
            "ludo-plane-user": computedStyle.getPropertyValue('--ludo-plane-user').trim() || '#4ECDC4',
            "ludo-border-radius": computedStyle.getPropertyValue('--ludo-border-radius').trim() || '24px'
        };

        const jsonContent = JSON.stringify(cssVars, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ludo-game-styles.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        ludoStatus.textContent = 'CSSæ ·å¼å·²å¯¼å‡ºï¼';
        setTimeout(() => {
            if (!ludoGameState.gameOver) {
                ludoStatus.textContent = ludoGameState.currentTurn === 'user' ? 'è½®åˆ°ä½ æ·éª°å­äº†ï¼' : 'TAçš„å›åˆ';
            }
        }, 2000);
    }

    // è¾…åŠ©å‡½æ•°
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // === äº‹ä»¶ç»‘å®š ===

    // æ‰“å¼€æ¸¸æˆ
    if (ludoFeature) {
        ludoFeature.addEventListener('click', () => {
            if (!currentOpenContact) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº');
                return;
            }
            ludoModal.style.display = 'block';
            initLudoGame();
            // å…³é—­æ›´å¤šåŠŸèƒ½é¢æ¿
            if (typeof toggleFeaturesPanel === 'function') {
                toggleFeaturesPanel();
            }
        });
    }

    // å…³é—­æ¸¸æˆ
    if (ludoCloseBtn) {
        ludoCloseBtn.addEventListener('click', () => {
            ludoModal.style.display = 'none';
        });
    }

    // å¯¼å‡ºCSS
    if (ludoExportCssBtn) {
        ludoExportCssBtn.addEventListener('click', exportLudoCSS);
    }

    // ç”¨æˆ·å…ˆæ‰‹
    if (ludoUserFirstBtn) {
        ludoUserFirstBtn.addEventListener('click', () => {
            ludoStartPanel.style.display = 'none';
            ludoRollBtn.style.display = 'block';
            ludoChatInputContainer.style.display = 'flex';
            ludoGameState.currentTurn = 'user';
            ludoStatus.textContent = 'è½®åˆ°ä½ æ·éª°å­äº†ï¼';
            ludoAiBubble.textContent = 'ä½ å…ˆæ¥~';
        });
    }

    // AIå…ˆæ‰‹
    if (ludoAiFirstBtn) {
        ludoAiFirstBtn.addEventListener('click', () => {
            ludoStartPanel.style.display = 'none';
            ludoRollBtn.style.display = 'block';
            ludoChatInputContainer.style.display = 'flex';
            ludoRollBtn.disabled = true;
            ludoGameState.currentTurn = 'ai';
            ludoStatus.textContent = `${currentOpenContact?.name || 'TA'}å…ˆæ·éª°å­...`;
            ludoUserBubble.textContent = 'çœ‹ä½ çš„ï¼';
            setTimeout(() => triggerAILudoTurn(), 800);
        });
    }

    // æ·éª°å­æŒ‰é’®
    if (ludoRollBtn) {
        ludoRollBtn.addEventListener('click', () => {
            if (ludoGameState.currentTurn === 'user') {
                rollDiceForUser();
            }
        });
    }

    // ç‚¹å‡»éª°å­ä¹Ÿå¯ä»¥æ·
    if (ludoDice) {
        ludoDice.addEventListener('click', () => {
            if (ludoGameState.currentTurn === 'user' && !ludoRollBtn.disabled) {
                rollDiceForUser();
            }
        });
    }

    // èŠå¤©å‘é€
    if (ludoSendChatBtn && ludoChatInput) {
        const sendChat = () => {
            const message = ludoChatInput.value.trim();
            if (!message) return;
            
            ludoGameState.messages.push({ sender: 'user', text: message });
            ludoUserBubble.textContent = message;
            ludoChatInput.value = '';

            // å¦‚æœå¤„äºâ€œçœŸå¿ƒè¯/æƒ©ç½šâ€ç­‰å¾…å›å¤çŠ¶æ€ï¼Œå‘é€æ¶ˆæ¯åè§†ä¸ºå®Œæˆä»»åŠ¡ï¼Œåˆ‡æ¢å›åˆ
            // å¦‚æœå¤„äºâ€œçœŸå¿ƒè¯/æƒ©ç½šâ€ç­‰å¾…å›å¤çŠ¶æ€ï¼Œå‘é€æ¶ˆæ¯åè§†ä¸ºå®Œæˆä»»åŠ¡ï¼Œåˆ‡æ¢å›åˆ
            if (ludoGameState.isUserReplyingSpecial) {
                ludoGameState.isUserReplyingSpecial = false;
                
                // å¤„ç†çœŸå¿ƒè¯ä¸Šä¸‹æ–‡
                const question = ludoGameState.currentTruthQuestion || "ä¸€ä¸ªçœŸå¿ƒè¯é—®é¢˜";
                ludoGameState.pendingContext = `(ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšæ‰å›ç­”äº†çœŸå¿ƒè¯é—®é¢˜â€œ${question}â€ï¼Œå›ç­”å†…å®¹æ˜¯ï¼šâ€œ${message}â€ã€‚è¯·ä½ åœ¨æ¥ä¸‹æ¥çš„è¡ŒåŠ¨ä¸­å¯¹ç”¨æˆ·çš„å›ç­”åšå‡ºååº”/è¯„ä»·ã€‚)`;
                delete ludoGameState.currentTruthQuestion;

                ludoStatus.textContent = 'âœ… å›ç­”å·²è®°å½•ï¼Œè½®åˆ°TAäº†...';
                setTimeout(() => {
                    switchTurn();
                }, 1500);
            }
        };

        ludoSendChatBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sendChat();
        });
        
        ludoChatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                e.stopPropagation();
                sendChat();
            }
        });

        // ä¿®å¤è¾“å…¥æ¡†ç„¦ç‚¹é—®é¢˜
        ludoChatInput.addEventListener('click', (e) => {
            e.stopPropagation();
            ludoChatInput.focus();
        });
        
        ludoChatInput.addEventListener('touchstart', (e) => {
            e.stopPropagation();
        });
    }

    // é‡æ–°å¼€å§‹
    if (ludoRestartBtn) {
        ludoRestartBtn.addEventListener('click', initLudoGame);
    }

    

    // ==========================================================
    // === BUG ä¿®å¤è¡¥ä¸ï¼šè¾“å…¥æ¡†ç„¦ç‚¹ä¸äº¤äº’ä¼˜åŒ– ===
    // ==========================================================
    
    // 1. ä¿®å¤ä¸»èŠå¤©è¾“å…¥æ¡†ç¬¬ä¸€æ¬¡ç‚¹å‡»æ— æ•ˆçš„é—®é¢˜
    const mainChatInput = document.getElementById('chat-message-input');
    if (mainChatInput) {
        const fixInputFocus = (e) => {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è¢«å…¨å±€ç‚¹å‡»æ‹¦æˆª
            mainChatInput.focus();
        };
        mainChatInput.addEventListener('click', fixInputFocus);
        mainChatInput.addEventListener('touchstart', fixInputFocus);
    }

    

    

    // ============================================================
    // === è®°å¿†åŠŸèƒ½ (Memory Feature) ===
    // ============================================================
    
    const memoryFeatureBtn = document.getElementById('memory-feature');
    const memoryModal = document.getElementById('memory-modal');
    const memoryCloseBtn = document.getElementById('memory-close-btn');
    const memoryModalOverlay = document.querySelector('.memory-modal-overlay');
    const memoryTabs = document.querySelectorAll('.memory-tab');
    const memoryRetrospectPanel = document.getElementById('memory-retrospect-panel');
    const memoryBondsPanel = document.getElementById('memory-bonds-panel');
    const memoryTotalCount = document.getElementById('memory-total-count');
    const memoryLastSummarized = document.getElementById('memory-last-summarized');
    const memoryUnprocessedCount = document.getElementById('memory-unprocessed-count');
    const memoryMessageCount = document.getElementById('memory-message-count');
    const memoryModelSelect = document.getElementById('memory-model-select');
    const memoryPromptInput = document.getElementById('memory-prompt-input');
    const memorySummarizeBtn = document.getElementById('memory-summarize-btn');
    const memoryChequesContainer = document.getElementById('memory-cheques-container');
    
    const DEFAULT_MEMORY_PROMPT = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è®°å¿†æ•´ç†å¸ˆ,æ“…é•¿ä»å¯¹è¯ä¸­æå–å…³é”®ä¿¡æ¯ã€æƒ…æ„Ÿè„‰ç»œå’Œé‡è¦ç»†èŠ‚ã€‚

è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹èŠå¤©è®°å½•,å¹¶è¿›è¡Œæ·±åº¦æ€»ç»“:

ã€æ€»ç»“è¦æ±‚ã€‘
1. **æ ¸å¿ƒäº‹ä»¶**: è¯¦ç»†è®°å½•å¯¹è¯ä¸­å‘ç”Ÿçš„é‡è¦äº‹ä»¶ã€æ´»åŠ¨æˆ–è¯é¢˜,åŒ…æ‹¬æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ç­‰å…³é”®è¦ç´ 
2. **æƒ…æ„Ÿå˜åŒ–**: æ•æ‰åŒæ–¹çš„æƒ…ç»ªèµ·ä¼ã€æ€åº¦è½¬å˜ã€äº²å¯†åº¦å˜åŒ–
3. **å…³é”®ä¿¡æ¯**: è®°å½•é‡è¦çš„æ‰¿è¯ºã€çº¦å®šã€åå¥½ã€ä¹ æƒ¯ã€ä¸ªäººä¿¡æ¯ç­‰
4. **å¯¹è¯ç‰¹è‰²**: æ³¨æ„åŒæ–¹çš„è¯´è¯é£æ ¼ã€å¸¸ç”¨è¯æ±‡ã€æ˜µç§°ã€æ¢—ç­‰ä¸ªæ€§åŒ–å†…å®¹
5. **å…³ç³»å‘å±•**: åˆ†æåŒæ–¹å…³ç³»çš„è¿›å±•å’Œäº’åŠ¨æ¨¡å¼

ã€è¾“å‡ºæ ¼å¼ã€‘
- ä½¿ç”¨å™äº‹æ€§è¯­è¨€,åƒå†™æ—¥è®°ä¸€æ ·è®°å½•
- ä¿ç•™å…·ä½“ç»†èŠ‚å’Œç”ŸåŠ¨æè¿°
- å­—æ•°æ§åˆ¶åœ¨ 100-250 å­—
- åˆ†æ®µå‘ˆç°,ä¾¿äºé˜…è¯»

èŠå¤©è®°å½•:
{CHAT_HISTORY}

è¯·å¼€å§‹æ€»ç»“:`;
    
    function initMemoryFeature() {
        if (memoryPromptInput) memoryPromptInput.value = DEFAULT_MEMORY_PROMPT;
        if (memoryFeatureBtn) memoryFeatureBtn.addEventListener('click', openMemoryModal);
        if (memoryCloseBtn) memoryCloseBtn.addEventListener('click', closeMemoryModal);
        if (memoryModalOverlay) memoryModalOverlay.addEventListener('click', closeMemoryModal);
        memoryTabs.forEach(function(tab) {
            tab.addEventListener('click', function() { switchMemoryTab(tab.dataset.tab); });
        });
        if (memorySummarizeBtn) memorySummarizeBtn.addEventListener('click', handleMemorySummarize);
    }
    
    async function openMemoryModal() {
        if (!currentOpenContact) { alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº'); return; }
        memoryModal.style.display = 'flex';
        await loadMemoryApiModels();
        updateMemoryStats();
        await loadMemoryCheques();
        var mfp = document.getElementById('more-features-panel');
        if (mfp) mfp.classList.remove('active');
    }
    
    function closeMemoryModal() { 
        if (memoryModal) memoryModal.style.display = 'none'; 
        // iOS Crash Fix: Clear content to release memory
        if (memoryChequesContainer) memoryChequesContainer.innerHTML = '';
    }
    
    function switchMemoryTab(tabName) {
        memoryTabs.forEach(function(tab) {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });
        memoryRetrospectPanel.classList.toggle('active', tabName === 'retrospect');
        memoryBondsPanel.classList.toggle('active', tabName === 'bonds');
    }
    
    async function loadMemoryApiModels() {
        try {
            var settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value || !settingsData.value.model) {
                memoryModelSelect.innerHTML = '<option value="">è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API</option>';
                return;
            }
            var currentModel = settingsData.value.model;
            // æ£€æŸ¥ä¸‹æ‹‰æ¡†æ˜¯å¦å·²æœ‰é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆå§‹åŒ–
            if (memoryModelSelect.options.length <= 1) {
                memoryModelSelect.innerHTML = '<option value="' + currentModel + '" selected>' + currentModel + '</option>';
            }
            
            // ç»‘å®šæ‹‰å–æŒ‰é’®äº‹ä»¶
            var fetchBtn = document.getElementById('memory-fetch-models-btn');
            if (fetchBtn) {
                // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆé€šè¿‡æ›¿æ¢èŠ‚ç‚¹ï¼‰
                var newBtn = fetchBtn.cloneNode(true);
                fetchBtn.parentNode.replaceChild(newBtn, fetchBtn);
                newBtn.addEventListener('click', fetchApiModels);
            }
        } catch (e) {
            console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', e);
            memoryModelSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        }
    }

    function showToast(message, type) {
        var toast = document.createElement('div');
        toast.className = 'memory-toast';
        toast.innerText = message;
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.padding = '10px 20px';
        toast.style.background = 'rgba(139, 90, 43, 0.9)'; // å¤å¤æ£•è‰²èƒŒæ™¯
        toast.style.color = '#fff';
        toast.style.borderRadius = '4px';
        toast.style.zIndex = '10000';
        toast.style.fontSize = '14px';
        toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
        toast.style.transition = 'opacity 0.3s ease';
        
        document.body.appendChild(toast);
        
        setTimeout(function() {
            toast.style.opacity = '0';
            setTimeout(function() {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 300);
        }, 3000);
    }

    async function fetchApiModels() {
        var btn = document.getElementById('memory-fetch-models-btn');
        if (btn) btn.classList.add('loading'); // å¯ä»¥æ·»åŠ æ—‹è½¬åŠ¨ç”»class
        
        try {
            var settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value || !settingsData.value.url) {
                alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIåœ°å€');
                return;
            }
            
            var url = settingsData.value.url;
            if (url.endsWith('/')) url = url.slice(0, -1);
            // å°è¯•ä» /v1/models è·å–
            // æ³¨æ„: æœ‰äº›éæ ‡å‡†APIå¯èƒ½è·¯å¾„ä¸åŒï¼Œè¿™é‡Œå‡è®¾éµå¾ªOpenAIæ ‡å‡†
            var modelsUrl = url + '/models'; 
            // å¦‚æœåŸæœ¬URLå·²ç»åŒ…å« /v1ï¼Œåˆ™ä¸éœ€è¦å†åŠ ? é€šå¸¸ url æ˜¯ base_url
            // è®¸å¤šç”¨æˆ·é…ç½®çš„æ˜¯ https://api.openai.com/v1
            
            var resp = await fetch(modelsUrl, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + settingsData.value.key }
            });
            
            if (!resp.ok) {
                // å°è¯•ä¸å¸¦ /v1 çš„æƒ…å†µï¼Œæˆ–è€…å…¶ä»–å¸¸è§è·¯å¾„? 
                // æš‚æ—¶åªæŠ¥é”™
                throw new Error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + resp.status);
            }
            
            var data = await resp.json();
            var models = [];
            if (Array.isArray(data.data)) {
                models = data.data.map(m => m.id);
            } else if (Array.isArray(data)) {
                models = data.map(m => m.id);
            }
            
            if (models.length > 0) {
                models.sort();
                var currentModel = memoryModelSelect.value;
                var html = models.map(function(m) {
                    return '<option value="' + m + '"' + (m === currentModel ? ' selected' : '') + '>' + m + '</option>';
                }).join('');
                
                // å¦‚æœå½“å‰æ¨¡å‹ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œæ·»åŠ å®ƒ
                if (!models.includes(currentModel) && currentModel) {
                     html = '<option value="' + currentModel + '" selected>' + currentModel + '</option>' + html;
                }
                
                memoryModelSelect.innerHTML = html;
                showToast('å·²æˆåŠŸæ‹‰å– ' + models.length + ' ä¸ªæ¨¡å‹');
            } else {
                showToast('æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹');
            }
            
        } catch (e) {
            console.error('æ‹‰å–æ¨¡å‹å¤±è´¥:', e);
            showToast('æ‹‰å–æ¨¡å‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®');
        } finally {
            if (btn) btn.classList.remove('loading');
        }
    }
    
    function updateMemoryStats() {
        if (!currentOpenContact || !currentOpenContact.history) {
            memoryTotalCount.textContent = '0';
            memoryLastSummarized.textContent = '0';
            memoryUnprocessedCount.textContent = '0';
            return;
        }
        var total = currentOpenContact.history.length;
        var last = currentOpenContact.lastMemorySummarizedIndex || 0;
        memoryTotalCount.textContent = total;
        memoryLastSummarized.textContent = last;
        memoryUnprocessedCount.textContent = total - last;
    }
    
    async function handleMemorySummarize() {
        if (!currentOpenContact) { alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº'); return; }
        var msgCount = parseInt(memoryMessageCount.value);
        var model = memoryModelSelect.value;
        var prompt = memoryPromptInput.value.trim();
        if (!model) { alert('è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹'); return; }
        if (!prompt) { alert('è¯·è¾“å…¥æ€»ç»“Prompt'); return; }
        if (msgCount < 1 || msgCount > 20000) { 
            alert('è®°å½•æ•°é‡åº”åœ¨1-20000ä¹‹é—´'); 
            return; 
        }
        
        // å¯¹å¤§é‡æ¶ˆæ¯ç»™å‡º token æ¶ˆè€—æé†’
        if (msgCount > 200) {
            const estimatedTokens = msgCount * 100; // ç²—ç•¥ä¼°ç®—ï¼šæ¯æ¡æ¶ˆæ¯çº¦100 token
            const confirmed = confirm(
                `æ‚¨é€‰æ‹©äº† ${msgCount} æ¡æ¶ˆæ¯è¿›è¡Œæ€»ç»“ã€‚\n\n` +
                `é¢„ä¼°å°†æ¶ˆè€—çº¦ ${estimatedTokens.toLocaleString()} tokensã€‚\n\n` +
                `è¿™å¯èƒ½ä¼šäº§ç”Ÿè¾ƒé«˜çš„ API è´¹ç”¨ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`
            );
            if (!confirmed) return;
        }

        
        memorySummarizeBtn.disabled = true;
        memorySummarizeBtn.innerHTML = '<span>æ­£åœ¨æ€»ç»“...</span>';
        
        try {
            var summary = await doMemorySummarize(msgCount, model, prompt);
            if (summary) {
                await saveMemoryChequeData(summary, msgCount);
                currentOpenContact.lastMemorySummarizedIndex = currentOpenContact.history.length;
                await saveCurrentContactToDatabase();
                updateMemoryStats();
                switchMemoryTab('bonds');
                await loadMemoryCheques();
                alert('æ€»ç»“å®Œæˆ!');
            }
        } catch (e) {
            console.error('æ€»ç»“å¤±è´¥:', e);
            alert('æ€»ç»“å¤±è´¥: ' + e.message);
        } finally {
            memorySummarizeBtn.disabled = false;
            memorySummarizeBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2"/></svg><span>å¼€å§‹æ€»ç»“</span>';
        }
    }
    
    async function doMemorySummarize(msgCount, model, prompt) {
        var history = currentOpenContact.history.slice(-msgCount);
        var chatText = history.map(function(msg) {
            var name = msg.sender === 'user' ? currentOpenContact.user.name : currentOpenContact.ai.name;
            return name + ': ' + (msg.text || '(éæ–‡æœ¬æ¶ˆæ¯)');
        }).join('\n');
        
        var finalPrompt = prompt.replace('{CHAT_HISTORY}', chatText);
        var settings = await dbHelper.loadData('settingsStore', 'apiSettings');
        if (!settings || !settings.value.url) throw new Error('APIæœªé…ç½®');
        
        var url = settings.value.url;
        if (url.endsWith('/')) url = url.slice(0, -1);
        url += '/chat/completions';
        
        var resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.value.key },
            body: JSON.stringify({ model: model, messages: [{ role: 'user', content: finalPrompt }], temperature: 0.8, max_tokens: 20000 })
        });
        if (!resp.ok) throw new Error('APIè¯·æ±‚å¤±è´¥: ' + resp.status);
        var data = await resp.json();
        return data.choices[0].message.content.trim();
    }
    
    async function saveMemoryChequeData(content, msgCount) {
        var cheque = {
            id: 'memory_' + Date.now(),
            contactId: currentOpenContact.id,
            content: content,
            createdAt: new Date().toISOString(),
            summarizedAtIndex: currentOpenContact.history.length,
            summarizedMessageCount: msgCount,
            isEnabled: true,
            editedContent: null
        };
        var existing = await dbHelper.loadData('memoryCheques', currentOpenContact.id);
        var cheques = (existing && existing.value) ? existing.value : [];
        cheques.push(cheque);
        await dbHelper.saveData('memoryCheques', currentOpenContact.id, cheques);
        return cheque;
    }
    
    var currentPage = 1;
    var chequesPerPage = 1; // æ”¹ä¸ºå•å¡ç‰‡æ¨¡å¼
    
    async function loadMemoryCheques() {
        if (!currentOpenContact) return;
        try {
            var data = await dbHelper.loadData('memoryCheques', currentOpenContact.id);
            var cheques = (data && data.value) ? data.value : [];
            
            var memoryChequePagination = document.getElementById('memory-cheque-pagination');
            var memoryPrevCheque = document.getElementById('memory-prev-cheque');
            var memoryNextCheque = document.getElementById('memory-next-cheque');
            var memoryChequeIndicator = document.getElementById('memory-cheque-indicator');
            
            if (cheques.length === 0) {
                memoryChequesContainer.innerHTML = '<div class="memory-empty-state"><svg width="64" height="64" viewBox="0 0 24 24" fill="none"><path opacity="0.4" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="currentColor"/><path d="M12 17C9.24 17 7 14.76 7 12H9C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12H17C17 14.76 14.76 17 12 17Z" fill="currentColor"/></svg><p>æš‚æ— è®°å¿†æ”¯ç¥¨</p><p class="memory-empty-hint">åœ¨å›æº¯ç•Œé¢ç”Ÿæˆç¬¬ä¸€ä¸ªè®°å¿†å§~</p></div>';
                if (memoryChequePagination) memoryChequePagination.style.display = 'none';
                return;
            }
            
            var reversed = cheques.slice().reverse();
            var totalPages = reversed.length; // å•å¡ç‰‡æ¨¡å¼ï¼šæ€»é¡µæ•°=æ€»å¡ç‰‡æ•°
            
            // ç¡®ä¿å½“å‰é¡µåœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            // æ¸²æŸ“æ‰€æœ‰æ”¯ç¥¨å¡ç‰‡
            var html = reversed.map(function(cheque, index) {
                var d = new Date(cheque.createdAt);
                var dateStr = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
                var content = cheque.editedContent || cheque.content;
                var num = String(reversed.length - index).padStart(3, '0');
                var statusClass = cheque.isEnabled ? 'enabled' : 'disabled';
                var statusText = cheque.isEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
                var toggleClass = cheque.isEnabled ? '' : 'disabled';
                var toggleIcon = cheque.isEnabled ? '<path d="M22 11.08V12a10 10 0 11-5.93-9.14M22 4L12 14.01l-3-3"/>' : '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>';
                var toggleText = cheque.isEnabled ? 'å¯ç”¨ä¸­' : 'å·²ç¦ç”¨';
                
                // åªæ˜¾ç¤ºå½“å‰é¡µçš„å¡ç‰‡
                var displayStyle = (index + 1 === currentPage) ? 'display: block;' : '';
                
                return '<div class="memory-cheque-card" data-cheque-id="' + cheque.id + '" style="' + displayStyle + '">' +
                    '<div class="memory-cheque-header"><span class="memory-cheque-number">è®°å¿†æ”¯ç¥¨ No.' + num + '</span><span class="memory-cheque-date">' + dateStr + '</span></div>' +
                    '<div class="memory-cheque-content">' + content + '</div>' +
                    '<div class="memory-cheque-footer"><span class="memory-cheque-status ' + statusClass + '"><span class="memory-cheque-status-dot"></span>' + statusText + '</span></div>' +
                    '<div class="memory-cheque-actions">' +
                    '<button class="memory-cheque-btn edit-btn" data-action="edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>ç¼–è¾‘</button>' +
                    '<button class="memory-cheque-btn toggle-btn ' + toggleClass + '" data-action="toggle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' + toggleIcon + '</svg>' + toggleText + '</button>' +
                    '<button class="memory-cheque-btn delete-btn" data-action="delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>åˆ é™¤</button>' +
                    '</div></div>';
            }).join('');
            
            memoryChequesContainer.innerHTML = html;
            
            // æ›´æ–°ç¿»é¡µæ§ä»¶
            if (memoryChequePagination) {
                memoryChequePagination.style.display = 'flex';
                if (memoryChequeIndicator) memoryChequeIndicator.textContent = currentPage + ' / ' + totalPages;
                if (memoryPrevCheque) memoryPrevCheque.disabled = (currentPage === 1);
                if (memoryNextCheque) memoryNextCheque.disabled = (currentPage === totalPages);
            }
            
            bindMemoryChequeActions();
            bindChequePageNavigation();
        } catch (e) {
            console.error('åŠ è½½è®°å¿†æ”¯ç¥¨å¤±è´¥:', e);
        }
    }
    
    function bindChequePageNavigation() {
        var memoryPrevCheque = document.getElementById('memory-prev-cheque');
        var memoryNextCheque = document.getElementById('memory-next-cheque');
        
        if (memoryPrevCheque) {
            memoryPrevCheque.onclick = function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadMemoryCheques();
                }
            };
        }
        
        if (memoryNextCheque) {
            memoryNextCheque.onclick = function() {
                var data = dbHelper.loadData('memoryCheques', currentOpenContact.id).then(function(data) {
                    var cheques = (data && data.value) ? data.value : [];
                    if (currentPage < cheques.length) {
                        currentPage++;
                        loadMemoryCheques();
                    }
                });
            };
        }
    }
    
    function bindPageNavigation() {
        var prevBtn = document.getElementById('memory-prev-page');
        var nextBtn = document.getElementById('memory-next-page');
        
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadMemoryCheques();
                }
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                currentPage++;
                loadMemoryCheques();
            });
        }
    }
    
    function bindMemoryChequeActions() {
        var cards = memoryChequesContainer.querySelectorAll('.memory-cheque-card');
        cards.forEach(function(card) {
            var id = card.dataset.chequeId;
            var editBtn = card.querySelector('[data-action="edit"]');
            var toggleBtn = card.querySelector('[data-action="toggle"]');
            var deleteBtn = card.querySelector('[data-action="delete"]');
            if (editBtn) editBtn.addEventListener('click', function() { handleEditMemoryCheque(id); });
            if (toggleBtn) toggleBtn.addEventListener('click', function() { handleToggleMemoryCheque(id); });
            if (deleteBtn) deleteBtn.addEventListener('click', function() { handleDeleteMemoryCheque(id); });
        });
    }
    
    async function handleEditMemoryCheque(chequeId) {
        var card = memoryChequesContainer.querySelector('.memory-cheque-card[data-cheque-id="' + chequeId + '"]');
        if (!card) return;
        
        var contentDiv = card.querySelector('.memory-cheque-content');
        if (!contentDiv) return;
        
        // é¿å…é‡å¤ç‚¹å‡»ç¼–è¾‘
        if (contentDiv.querySelector('textarea')) return;
        
        var originalText = contentDiv.innerText; // æˆ–è€… textContentï¼Œæ³¨æ„ä¿ç•™æ¢è¡Œ
        // è·å–åŸå§‹æ•°æ®ä»¥ç¡®ä¿å‡†ç¡®ï¼ˆå±•ç¤ºæ—¶å¯èƒ½ç»è¿‡HTMLè½¬ä¹‰?ï¼‰
        // è¿™é‡Œç›´æ¥ç”¨innerTexté€šå¸¸å¯ä»¥ï¼Œæˆ–è€…ä»DBé‡æ–°æ‹‰å–æœ€å‡†ç¡®
        var data = await dbHelper.loadData('memoryCheques', currentOpenContact.id);
        var cheques = (data && data.value) ? data.value : [];
        var cheque = cheques.find(function(c) { return c.id === chequeId; });
        if (cheque) {
            originalText = cheque.editedContent || cheque.content;
        }

        // æ›¿æ¢ä¸ºç¼–è¾‘ç•Œé¢
        var editHtml = '<textarea class="memory-inline-edit-textarea">' + originalText + '</textarea>' +
                       '<div class="memory-inline-edit-actions">' +
                       '<button class="memory-edit-cancel-btn">å–æ¶ˆ</button>' +
                       '<button class="memory-edit-confirm-btn">ä¿å­˜</button>' +
                       '</div>';
        contentDiv.innerHTML = editHtml;
        
        var textarea = contentDiv.querySelector('textarea');
        var cancelBtn = contentDiv.querySelector('.memory-edit-cancel-btn');
        var confirmBtn = contentDiv.querySelector('.memory-edit-confirm-btn');
        
        // è‡ªåŠ¨èšç„¦
        textarea.focus();
        
        // ç»‘å®šäº‹ä»¶
        cancelBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¦å‘å…¶ä»–
            // æ¢å¤åŸçŠ¶ (é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨æœ€ç®€å•ï¼Œæˆ–è€…æ‰‹åŠ¨æ¢å¤innerHTML)
            // ä¸ºäº†ä¿æŒç¿»é¡µçŠ¶æ€ï¼Œæœ€å¥½åªæ¢å¤è¿™ä¸€é¡¹ã€‚ä½†ç®€å•èµ·è§ï¼Œè¿™é‡Œç›´æ¥æ¢å¤æ–‡æœ¬
            // æ³¨æ„ï¼šå¦‚æœåŸæ–‡æœ¬åŒ…å«HTMLå¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œä½†è¿™é‡Œå†…å®¹åº”è¯¥æ˜¯çº¯æ–‡æœ¬
            contentDiv.textContent = originalText;
            // é‡æ–°åº”ç”¨èƒŒæ™¯çº¿æ ·å¼ç­‰(é€šè¿‡CSS classå·²ç»æœ‰)
        });
        
        confirmBtn.addEventListener('click', async function(e) {
            e.stopPropagation();
            var newText = textarea.value.trim();
            if (!newText) {
                showToast('å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            // ä¿å­˜æ•°æ®
            if (cheque) {
                cheque.editedContent = newText;
                await dbHelper.saveData('memoryCheques', currentOpenContact.id, cheques);
                showToast('å·²ä¿å­˜ä¿®æ”¹');
                
                // æ›´æ–°æ˜¾ç¤º
                contentDiv.textContent = newText;
            }
        });
    }

    
    async function handleToggleMemoryCheque(chequeId) {
        var data = await dbHelper.loadData('memoryCheques', currentOpenContact.id);
        var cheques = (data && data.value) ? data.value : [];
        var cheque = cheques.find(function(c) { return c.id === chequeId; });
        if (!cheque) return;
        cheque.isEnabled = !cheque.isEnabled;
        await dbHelper.saveData('memoryCheques', currentOpenContact.id, cheques);
        await loadMemoryCheques();
    }
    
    async function handleDeleteMemoryCheque(chequeId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®°å¿†æ”¯ç¥¨å—?')) return;
        var data = await dbHelper.loadData('memoryCheques', currentOpenContact.id);
        var cheques = (data && data.value) ? data.value : [];
        cheques = cheques.filter(function(c) { return c.id !== chequeId; });
        await dbHelper.saveData('memoryCheques', currentOpenContact.id, cheques);
        await loadMemoryCheques();
    }
    
    window.getEnabledMemories = async function(contactId) {
        var data = await dbHelper.loadData('memoryCheques', contactId);
        var cheques = (data && data.value) ? data.value : [];
        return cheques.filter(function(c) { return c.isEnabled; });
    };
    
    initMemoryFeature();

    // --- çª¥äº‹åŠŸèƒ½ (Peeping Feature) ---
    function initPeepingFeature() {
        var peepingIcon = document.getElementById('peeping-feature');
        var modal = document.getElementById('peeping-modal');
        var closeBtn = modal ? modal.querySelector('.peeping-close-btn') : null;
        var startBtn = document.getElementById('peeping-start-btn');
        var overlay = modal ? modal.querySelector('.peeping-overlay') : null;
        
        if (peepingIcon) {
            peepingIcon.addEventListener('click', function() {
                openPeepingModal();
            });
        }
        
        if (closeBtn) closeBtn.addEventListener('click', closePeepingModal);
        if (overlay) overlay.addEventListener('click', closePeepingModal);
        if (startBtn) startBtn.addEventListener('click', startPeepingTrace);
    }
    
    function openPeepingModal() {
        var modal = document.getElementById('peeping-modal');
        if (modal) {
            modal.classList.remove('hidden');
            void modal.offsetWidth; // Force reflow
            modal.classList.add('active');
            
            // Reset to intro state
            document.querySelector('.peeping-intro').style.display = 'flex';
            var timeline = document.getElementById('peeping-timeline');
            timeline.style.display = 'none';
            timeline.innerHTML = ''; 
        }
    }
    
    function closePeepingModal() {
        var modal = document.getElementById('peeping-modal');
        if (modal) {
            modal.classList.remove('active');
            // iOS Crash Fix: Clear timeline to release memory
            var timeline = document.getElementById('peeping-timeline');
            if (timeline) timeline.innerHTML = '';
        }
    }
    
    async function startPeepingTrace() {
        var btn = document.getElementById('peeping-start-btn');
        if (btn.classList.contains('loading')) return;
        
        btn.classList.add('loading');
        
        try {
             if (!currentOpenContact) throw new Error('æœªé€‰æ‹©è”ç³»äºº');
             
             // Check settings
             var settingsData = await dbHelper.loadData('settingsStore', 'apiSettings');
            if (!settingsData || !settingsData.value || !settingsData.value.key) {
                throw new Error('è¯·å…ˆé…ç½®API Key');
            }
             
             // Prepare Context
             var history = currentOpenContact.history.slice(-100);
             var chatText = history.map(function(msg) {
                var name = msg.sender === 'user' ? currentOpenContact.user.name : currentOpenContact.ai.name;
                return name + ': ' + (msg.text || '(éæ–‡æœ¬æ¶ˆæ¯)');
            }).join('\n');
            
            var aiPersona = currentOpenContact.ai.persona || currentOpenContact.ai.description || 'æ— è®¾å®š';
            var userPersona = currentOpenContact.user.persona || 'æ— è®¾å®š';

            // 1. è·å–å¯ç”¨çš„è®°å¿† (Memories)
            let memoryContext = "";
            if (typeof window.getEnabledMemories === 'function') {
                try {
                    const memories = await window.getEnabledMemories(currentOpenContact.id);
                    if (memories && memories.length > 0) {
                        memoryContext = memories.map(m => `[è®°å¿†] ${m.content}`).join('\n');
                    }
                } catch (e) {
                    console.warn("è·å–è®°å¿†å¤±è´¥:", e);
                }
            }

            // 2. è·å–ä¸–ç•Œä¹¦ä¸Šä¸‹æ–‡ (World Book)
            let worldContext = "";
            try {
                const worldbookData = await dbHelper.loadData('worldBooks', 'allWorldBooks');
                const allBooks = (worldbookData && Array.isArray(worldbookData.value)) ? worldbookData.value : [];
                let requiredBookIds = new Set();
                
                // ä¼˜å…ˆæ–°ç‰ˆ
                if (currentOpenContact.linkedWorldBookIds && currentOpenContact.linkedWorldBookIds.length > 0) {
                     currentOpenContact.linkedWorldBookIds.forEach(id => requiredBookIds.add(id));
                } 
                // å›é€€æ—§ç‰ˆ
                else if (currentOpenContact.linkedWorldBookGroupIds && currentOpenContact.linkedWorldBookGroupIds.length > 0) {
                     const groupsData = await dbHelper.loadData('worldBookGroups', 'allGroups');
                     if (groupsData && groupsData.value) {
                         const linkedGroups = groupsData.value.filter(g => currentOpenContact.linkedWorldBookGroupIds.includes(g.id));
                         linkedGroups.forEach(g => {
                            if (g.books) g.books.forEach(bid => requiredBookIds.add(bid));
                            if (g.bookIds) g.bookIds.forEach(bid => requiredBookIds.add(bid));
                         });
                     }
                }

                if (requiredBookIds.size > 0) {
                     const linkedBooks = allBooks.filter(b => requiredBookIds.has(b.id));
                     let rawWorldText = linkedBooks.map(b => `ã€è®¾å®šï¼š${b.name}ã€‘\n${b.content}`).join('\n\n');
                     if (rawWorldText.length > 2000) rawWorldText = rawWorldText.slice(0, 2000) + "...(ç•¥)";
                     worldContext = rawWorldText;
                }
            } catch (e) {
                console.warn("ä¸–ç•Œä¹¦åŠ è½½å¤±è´¥:", e);
            }

            var prompt = `
ä½ æ˜¯ä¸€ä¸ªæå…·æ´å¯ŸåŠ›çš„æ•…äº‹å™è¿°è€…ã€‚è¯·æ ¹æ®ä»¥ä¸‹è§’è‰²çš„èƒŒæ™¯è®¾å®šã€ä¸–ç•Œè§‚èƒŒæ™¯ã€è®°å¿†å’Œæœ€è¿‘çš„å¯¹è¯è®°å½•ï¼Œç”Ÿæˆè¯¥è§’è‰²ï¼ˆAIï¼‰ä»Šå¤©çš„ç”Ÿæ´»è¸ªè¿¹ã€‚
æˆ‘ä»¬éœ€è¦ä»¥æ—¶é—´è½´çš„å½¢å¼ï¼Œå±•ç¤ºè§’è‰²åœ¨ä»Šå¤©å‘ç”Ÿçš„å…³é”®äº‹ä»¶ã€æ‰€å¤„ä½ç½®ã€å†…å¿ƒæ´»åŠ¨ä»¥åŠæ¶ˆè´¹æƒ…å†µã€‚

ã€è§’è‰²è®¾å®šã€‘
AIäººè®¾ï¼š${aiPersona}
ç”¨æˆ·äººè®¾ï¼š${userPersona}

ã€ä¸–ç•Œè§‚èƒŒæ™¯ã€‘
${worldContext || "æ— ç‰¹æ®Šä¸–ç•Œè§‚è®¾å®šï¼Œé»˜è®¤ä¸ºç°ä»£æ—¥å¸¸ã€‚"}

ã€å…³é”®è®°å¿†ã€‘
${memoryContext || "æ— ç‰¹æ®Šè®°å¿†ã€‚"}

ã€æœ€è¿‘å¯¹è¯ã€‘
${chatText}

ã€ç”Ÿæˆè¦æ±‚ã€‘
1. ç”Ÿæˆ 4-6 ä¸ªå…·ä½“çš„â€œè¸ªè¿¹å¡ç‰‡â€ï¼Œæ¯ä¸ªå¡ç‰‡ä»£è¡¨ä¸€ä¸ªæ—¶é—´ç‚¹ã€‚
2. æ¯ä¸ªå¡ç‰‡åŒ…å«ï¼š
   - time: æ—¶é—´ç‚¹ (å¦‚ 08:30)
   - location: åœ°ç‚¹ (å¦‚ å’–å•¡é¦†)
   - event: ç®€çŸ­æè¿°å‘ç”Ÿçš„äº‹ä»¶ (å¿…é¡»ç¬¦åˆä¸–ç•Œè§‚å’Œäººè®¾)
   - spending: æ¶ˆè´¹é‡‘é¢åŠç‰©å“ (å¦‚æœæ²¡æœ‰æ¶ˆè´¹å¡« "æ— ")
   - thought: è§’è‰²çš„å†…å¿ƒç‹¬ç™½ (ç¬¦åˆäººè®¾)
   - mood: å¿ƒæƒ… emoji
3. è¯·ä¸¥æ ¼è¿”å›æœ‰æ•ˆçš„ JSON æ•°ç»„å­—ç¬¦ä¸²ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ ‡è®° (å¦‚ \`\`\`json)ã€‚æ ¼å¼å¦‚ä¸‹ï¼š
[{"time":"09:00","location":"å§å®¤","event":"é†’æ¥...","spending":"æ— ","thought":"...","mood":"â˜€ï¸"}]
`;

            var url = settingsData.value.url;
            if (url.endsWith('/')) url = url.slice(0, -1);
            url += '/chat/completions';
            var model = settingsData.value.model || 'gpt-3.5-turbo';
            
            var resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settingsData.value.key },
                body: JSON.stringify({ 
                    model: model, 
                    messages: [{ role: 'user', content: prompt }], 
                    temperature: 0.85 
                })
            });
            
            if (!resp.ok) throw new Error('API Request Failed: ' + resp.status);
            
            var data = await resp.json();
            var content = data.choices[0].message.content.trim();
            // Clean markdown if present
            content = content.replace(/^```json/, '').replace(/^```/, '').replace(/```$/, '').trim();
            
            var traceEvents;
            try {
                traceEvents = JSON.parse(content);
            } catch (e) {
                console.error("JSON Error", content);
                throw new Error("ç”Ÿæˆå†…å®¹æ ¼å¼æœ‰è¯¯ï¼Œè¯·é‡è¯•");
            }
            
            renderPeepingTimeline(traceEvents);
            
        } catch (e) {
            console.error(e);
            alert('ç”Ÿæˆå¤±è´¥: ' + e.message);
        } finally {
            btn.classList.remove('loading');
        }
    }
    
    function renderPeepingTimeline(events) {
        var container = document.getElementById('peeping-timeline');
        container.innerHTML = '';
        
        if (!Array.isArray(events)) {
            alert('æ•°æ®æ ¼å¼é”™è¯¯');
            return;
        }
        
        // SVG Icons
        var icons = {
            location: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',
            spending: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>',
            thought: '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>'
        };
        
        events.forEach(function(evt, index) {
            var card = document.createElement('div');
            card.className = 'peeping-card';
            card.style.animationDelay = (index * 0.15) + 's';
            
            var spendingHtml = (evt.spending && evt.spending !== 'æ— ') 
                ? `<div class="peeping-spending">${icons.spending} <span>${evt.spending}</span></div>` 
                : '';
                
            card.innerHTML = `
                <div class="peeping-card-header">
                    <div class="peeping-location">${icons.location} <span>${evt.location}</span></div>
                    <div class="peeping-time">${evt.time}</div>
                </div>
                <div class="peeping-card-body">
                    ${evt.event}
                </div>
                ${spendingHtml}
                <div class="peeping-inner-thought">
                    <div class="peeping-thought-icon">${icons.thought}</div>
                    <div class="peeping-thought-text">â€œ${evt.thought}â€ ${evt.mood || ''}</div>
                </div>
            `;
            container.appendChild(card);
        });
        
        document.querySelector('.peeping-intro').style.display = 'none';
        container.style.display = 'flex';
    }

    initPeepingFeature();

    // ==========================================================
    // === MiniMax TTS è¯­éŸ³åˆæˆåŠŸèƒ½ ===
    // ==========================================================

    // DOMå…ƒç´ 
    const minimaxGroupIdInput = document.getElementById('minimax-group-id');
    const minimaxApiKeyInput = document.getElementById('minimax-api-key');
    const minimaxModelSelect = document.getElementById('minimax-model-select');
    const fetchModelsBtn = document.getElementById('fetch-minimax-models-btn');
    const fetchModelsStatus = document.getElementById('fetch-models-status');
    const testTtsButton = document.getElementById('test-tts-button');
    const ttsTestStatus = document.getElementById('tts-test-status');

    // å½“å‰æ’­æ”¾çš„Audioå¯¹è±¡
    let currentTTSAudio = null;

    // ä¿å­˜MiniMaxé…ç½®
    async function saveMinimaxConfig() {
        if (!dbHelper || !dbHelper.db) {
            throw new Error('æ•°æ®åº“æœªåˆå§‹åŒ–');
        }
        const config = {
            groupId: minimaxGroupIdInput?.value || '',
            apiKey: minimaxApiKeyInput?.value || '',
            modelId: minimaxModelSelect?.value || 'speech-2.6-turbo' // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨æœ‰æ•ˆçš„é»˜è®¤æ¨¡å‹
        };
        await dbHelper.saveData('settingsStore', 'minimaxTTSConfig', config);
        console.log('[MiniMax] é…ç½®å·²ä¿å­˜', config);
    }

    // åŠ è½½MiniMaxé…ç½®
    async function loadMinimaxConfig() {
        if (!dbHelper || !dbHelper.db) {
            console.warn('[MiniMax] æ•°æ®åº“æœªåˆå§‹åŒ–');
            return;
        }
        try {
            const data = await dbHelper.loadData('settingsStore', 'minimaxTTSConfig');
            if (data && data.value) {
                if (minimaxGroupIdInput) minimaxGroupIdInput.value = data.value.groupId || '';
                if (minimaxApiKeyInput) minimaxApiKeyInput.value = data.value.apiKey || '';
                if (minimaxModelSelect) {
                    // ã€æ ¸å¿ƒä¿®å¤ã€‘ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¿å­˜çš„æ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨æœ‰æ•ˆæ¨¡å‹
                    minimaxModelSelect.value = data.value.modelId || 'speech-2.6-turbo';
                }
                console.log('[MiniMax] å·²åŠ è½½é…ç½®ï¼Œå½“å‰æ¨¡å‹:', data.value.modelId || 'speech-2.6-turbo');
            }
        } catch (e) {
            console.error('[MiniMax] åŠ è½½é…ç½®å¤±è´¥', e);
        }
    }

    // è°ƒç”¨MiniMax TTS API
    async function callMinimaxTTS(text, voiceId, language) {
        // é¢„å¤„ç†: å»é™¤é¦–å°¾ç©ºæ ¼å’Œæ¢è¡Œï¼Œé˜²æ­¢æ¨¡å‹åœ¨å¥å°¾äº§ç”Ÿå¹»è§‰(æ‚éŸ³)
        if (text) text = text.trim().replace(/[\r\n]+/g, ' ');
        if (!dbHelper || !dbHelper.db) {
            throw new Error('æ•°æ®åº“æœªåˆå§‹åŒ–');
        }
        const config = await dbHelper.loadData('settingsStore', 'minimaxTTSConfig');
        if (!config || !config.value || !config.value.groupId || !config.value.apiKey) {
            throw new Error('MiniMaxé…ç½®æœªå®Œæˆ');
        }

        const { groupId, apiKey, modelId } = config.value;
        
        // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨æœ‰æ•ˆçš„é»˜è®¤æ¨¡å‹
        let finalModelId = modelId || 'speech-2.6-turbo';
        
        // æ™ºèƒ½è·¯ç”±ï¼šæ ¹æ®æ¨¡å‹é€‰æ‹©æ­£ç¡®çš„æ¥å£
        // speech-01 ç³»åˆ—ä½¿ç”¨ t2a_proï¼Œspeech-02/2.6 ç³»åˆ—ä½¿ç”¨ t2a_v2
        const isLegacyProModel = finalModelId.includes('speech-01');
        const apiPath = isLegacyProModel ? 't2a_pro' : 't2a_v2';
        
        const url = `https://api.minimax.chat/v1/${apiPath}?GroupId=${groupId}`;
        console.log(`[Minimax] ä½¿ç”¨æ¥å£: ${apiPath} (æ¨¡å‹: ${finalModelId})`);

        // æ¨¡å‹åç§°è‡ªåŠ¨ä¿®æ­£ï¼šAPI ä¸¥æ ¼è¦æ±‚å®Œæ•´æ¨¡å‹å
        if (finalModelId === 'speech-01') finalModelId = 'speech-01-turbo';
        if (finalModelId === 'speech-02') finalModelId = 'speech-02-turbo'; // é»˜è®¤ä¸º turbo
        if (finalModelId === 'speech-2.6') finalModelId = 'speech-2.6-turbo'; // é»˜è®¤ä¸º turbo

        let requestBody;
        
        if (isLegacyProModel) {
            // t2a_pro ä½¿ç”¨æ‰å¹³åŒ–ç»“æ„ (ä¸æ”¯æŒ language_boost æˆ–åå­—ä¸åŒ)
            requestBody = {
                model: finalModelId,
                text: text,
                voice_id: voiceId || 'female-shaonv',
                speed: 1.0,
                vol: 1.0,
                pitch: 0,
                audio_sample_rate: 32000,
                bitrate: 128000,
                format: 'mp3'
            };
        } else {
            // t2a_v2 ä½¿ç”¨åµŒå¥—ç»“æ„ï¼ŒOpenAPI æ˜¾ç¤ºæ”¯æŒ language_boost
            // å…³é”®ï¼šEnum æ˜ å°„å¿…é¡»ä¸¥æ ¼åŒ¹é…æ–‡æ¡£
            const langMap = {
                'zh-CN': 'Chinese',
                'zh-HK': 'Chinese,Yue', // ç²¤è¯­å¿…é¡»ä¼  "Chinese,Yue"
                'en-US': 'English',
                'ja-JP': 'Japanese',
                'ko-KR': 'Korean',
                'de-DE': 'German',
                'fr-FR': 'French',
                'es-ES': 'Spanish',
                'pt-BR': 'Portuguese',
                'ru-RU': 'Russian',
                'tr-TR': 'Turkish',
                'nl-NL': 'Dutch',
                'it-IT': 'Italian',
                'vi-VN': 'Vietnamese',
                'id-ID': 'Indonesian',
                'th-TH': 'Thai',
                'ms-MY': 'Malay',
                'ar-SA': 'Arabic',
                'hi-IN': 'Hindi',
                'pl-PL': 'Polish',
                'sv-SE': 'Swedish',
                'fi-FI': 'Finnish',
                'da-DK': 'Danish'
            };
            
            // å¦‚æœæ²¡æ‰¾åˆ°æ˜ å°„ï¼Œåˆ™ä¸ä¼ æˆ–ä¼  autoï¼Œé¿å…ä¼ æ— æ•ˆå­—ç¬¦ä¸²å¯¼è‡´æŠ¥é”™
            const boostLang = (language && langMap[language]) ? langMap[language] : 'auto';

            requestBody = {
                model: finalModelId,
                text: text,
                stream: false,
                language_boost: boostLang,
                voice_setting: {
                    voice_id: voiceId || 'female-shaonv',
                    speed: 1.0,
                    vol: 1.0,
                    pitch: 0
                },
                audio_setting: {
                    format: 'mp3',
                    sample_rate: 32000,
                    bitrate: 128000,
                    channel: 1
                }
            };
        }

        const requestOptions = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify(requestBody)
        };



        const response = await fetch(url, requestOptions);

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`TTS APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('[MiniMax TTS] APIå“åº”æ•°æ®:', data);

        // 1. æ£€æŸ¥ API å±‚é¢é”™è¯¯ (Minimax V2 æ ‡å‡†)
        if (data.base_resp && data.base_resp.status_code !== 0) {
            throw new Error(`MiniMax APIé”™è¯¯: [${data.base_resp.status_code}] ${data.base_resp.status_msg}`);
        }

        // 2. æå–éŸ³é¢‘æ•°æ®
        // ä¼˜å…ˆçº§ï¼šdata.data.audio (v2) > data.audio_file (v1) > extra_info.audio_file
        let audioContent = null;
        if (data.data && data.data.audio) {
            audioContent = data.data.audio;
        } else if (data.audio_file) {
            audioContent = data.audio_file;
        } else if (data.extra_info && data.extra_info.audio_file) {
            audioContent = data.extra_info.audio_file;
        }

        if (!audioContent) {
            throw new Error('APIè¿”å›æ­£å¸¸ä½†æœªæ‰¾åˆ°éŸ³é¢‘æ•°æ®(audio/audio_file)');
        }

        // 3. æ ¼å¼å¤„ç†ï¼šHex -> Base64
        // Minimax V2 ç»å¸¸è¿”å› Hex å­—ç¬¦ä¸²ã€‚ç®€å•çš„å¯å‘å¼åˆ¤æ–­ï¼šå¦‚æœä¸å« '+' '/' '=' ä¸”å…¨æ˜¯ hex å­—ç¬¦ï¼Œå°±è§†ä¸º Hex
        // (Base64 å¯èƒ½åŒ…å« a-f 0-9 ä½†é€šå¸¸ä¼šæœ‰ + / =ï¼Œä¸” hex çœ‹èµ·æ¥åªæœ‰ 0-9a-f)
        const isHex = /^[0-9a-fA-F]+$/.test(audioContent);
        
        if (isHex) {
            try {
                // Hex string to Uint8Array
                const match = audioContent.match(/.{1,2}/g);
                if (match) {
                    const bytes = new Uint8Array(match.map(byte => parseInt(byte, 16)));
                    // Uint8Array to Base64
                    let binary = '';
                    const len = bytes.byteLength;
                    for (let i = 0; i < len; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    return window.btoa(binary);
                }
            } catch (e) {
                console.warn('[MiniMax TTS] Hexè½¬æ¢å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½œä¸ºBase64ä½¿ç”¨', e);
            }
        }

        // é»˜è®¤å‡è®¾æ˜¯ Base64
        return audioContent;
    }

    // æ‹‰å–MiniMaxå¯ç”¨TTSæ¨¡å‹åˆ—è¡¨
    async function fetchMinimaxModels() {
        if (!dbHelper || !dbHelper.db) {
            throw new Error('æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆé…ç½®MiniMax');
        }
        const config = await dbHelper.loadData('settingsStore', 'minimaxTTSConfig');
        if (!config || !config.value || !config.value.groupId || !config.value.apiKey) {
            throw new Error('MiniMaxé…ç½®æœªå®Œæˆ');
        }

        const { groupId, apiKey } = config.value;
        
        // MiniMax TTS API endpoint
        // æ³¨æ„ï¼šMiniMaxå¯èƒ½æ²¡æœ‰ä¸“é—¨çš„æ¨¡å‹åˆ—è¡¨APIï¼Œè¿™é‡Œè¿”å›é¢„å®šä¹‰çš„TTSæ¨¡å‹
        // å¦‚æœæœªæ¥æœ‰æ¨¡å‹åˆ—è¡¨APIï¼Œå¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨
        
        console.log('[MiniMax] ä½¿ç”¨é…ç½®:', { groupId: groupId.substring(0, 10) + '...', apiKey: '***' });
        
        // è¿”å›é¢„å®šä¹‰çš„TTSæ¨¡å‹åˆ—è¡¨
        // è¿™äº›æ˜¯æ ¹æ®MiniMaxæ–‡æ¡£å’Œå¸¸è§TTSæ¨¡å‹æ•´ç†çš„
        return [
            { id: 'speech-2.6-hd', name: 'Speech-2.6 HD (The Best)' },
            { id: 'speech-2.6-turbo', name: 'Speech-2.6 Turbo (Fastest)' },
            { id: 'speech-02-hd', name: 'Speech-02 HD (High Quality)' },
            { id: 'speech-02-turbo', name: 'Speech-02 Turbo (Balanced)' },
            { id: 'speech-01-hd', name: 'Speech-01 HD (Legacy)' },
            { id: 'speech-01-turbo', name: 'Speech-01 Turbo (Legacy)' }
        ];
    }


    // æ’­æ”¾TTSéŸ³é¢‘
    // === TTS ç¼“å­˜ç®¡ç† (IndexedDB) ===
    const TTSCache = {
        dbName: 'MinimaxTTSCache',
        storeName: 'audio_cache',
        _db: null,
        async getDB() {
            if (this._db) return this._db;
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(this.dbName, 1);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(this.storeName)) {
                        db.createObjectStore(this.storeName);
                    }
                };
                req.onsuccess = (e) => { this._db = e.target.result; resolve(this._db); };
                req.onerror = (e) => reject(e.target.error);
            });
        },
        async get(key) {
            try {
                const db = await this.getDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readonly');
                    const req = tx.objectStore(this.storeName).get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            } catch (e) { return null; }
        },
        async put(key, data) {
            try {
                const db = await this.getDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readwrite');
                    tx.objectStore(this.storeName).put(data, key);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject();
                });
            } catch (e) {}
        },
        genKey(text, voiceId, lang) {
            // ç®€å•hashé˜²æ­¢keyè¿‡é•¿
            let hash = 0;
            if (!text) return 'empty';
            for (let i = 0; i < text.length; i++) {
                hash = ((hash << 5) - hash) + text.charCodeAt(i);
                hash |= 0;
            }
            // ä½¿ç”¨ å‰20å­—ç¬¦ + hash ç»„åˆä½œä¸ºkeyï¼Œæ—¢ç›´è§‚åˆå”¯ä¸€
            const prefix = text.substring(0, 20).replace(/[^\w\u4e00-\u9fa5]/g, '_'); 
            return `${voiceId || 'def'}_${lang || 'auto'}_${prefix}_${hash}`;
        }
    };

    // æ’­æ”¾TTSéŸ³é¢‘ (å¸¦ç¼“å­˜)
    async function playTTS(text, voiceId, language) {
        try {
            // 1. é¢„å¤„ç†æ–‡æœ¬ (ä¿æŒä¸ callMinimaxTTS ä¸€è‡´)
            if (!text) return false;
            text = text.trim().replace(/[\r\n]+/g, ' ');
            
            // 2. åœæ­¢å½“å‰æ’­æ”¾
            if (currentTTSAudio) {
                currentTTSAudio.pause();
                currentTTSAudio = null;
            }
            
            // 3. æ£€æŸ¥ç¼“å­˜
            const cacheKey = TTSCache.genKey(text, voiceId, language);
            let audioData = await TTSCache.get(cacheKey);
            let fromCache = !!audioData;

            if (fromCache) {
                console.log('[Minimax TTS] ğŸš€ å‘½ä¸­ç¼“å­˜ï¼Œçœé’±äº†ï¼');
            } else {
                console.log('[Minimax TTS] ğŸ’¨ æœªå‘½ä¸­ç¼“å­˜ï¼Œè°ƒç”¨API...');
                audioData = await callMinimaxTTS(text, voiceId, language);
                if (audioData) {
                     // å­˜å…¥ç¼“å­˜
                     TTSCache.put(cacheKey, audioData).catch(err => console.warn('Cache put failed', err));
                }
            }

            // 4. æ’­æ”¾
            if (!audioData) return false;

            let audioUrl;
            if (typeof audioData === 'string' && audioData.startsWith('http')) {
                audioUrl = audioData;
            } else {
                const audioBlob = base64ToBlob(audioData, 'audio/mpeg');
                audioUrl = URL.createObjectURL(audioBlob);
            }

            currentTTSAudio = new Audio(audioUrl);
            currentTTSAudio.play().catch(e => console.error('Audio play error:', e));

            currentTTSAudio.onended = () => {
                if (!audioData.startsWith('http')) {
                    URL.revokeObjectURL(audioUrl);
                }
                currentTTSAudio = null;
            };

            return true;
        } catch (e) {
            console.error('[MiniMax TTS] æ’­æ”¾å¤±è´¥', e);
            throw e;
        }
    }

    // Base64è½¬Blob
    function base64ToBlob(base64, mimeType) {
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mimeType });
    }

    // æ‹‰å–æ¨¡å‹åˆ—è¡¨æŒ‰é’®
    if (fetchModelsBtn) {
        fetchModelsBtn.addEventListener('click', async () => {
            if (!minimaxGroupIdInput.value || !minimaxApiKeyInput.value) {
                alert('è¯·å…ˆå¡«å†™ MiniMax Group ID å’Œ API Key');
                return;
            }

            fetchModelsStatus.textContent = 'åŠ è½½ä¸­...';
            fetchModelsStatus.style.color = '#007aff';

            try {
                await saveMinimaxConfig();
                const models = await fetchMinimaxModels();
                
                // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨
                minimaxModelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name || model.id;
                    minimaxModelSelect.appendChild(option);
                });

                // ã€æ ¸å¿ƒä¿®å¤ã€‘æ‹‰å–æˆåŠŸåï¼Œç«‹å³ä¿å­˜å½“å‰é€‰æ‹©çš„æ¨¡å‹
                await saveMinimaxConfig();
                
                fetchModelsStatus.textContent = 'âœ“ æˆåŠŸ';
                fetchModelsStatus.style.color = '#34c759';
                setTimeout(() => { fetchModelsStatus.textContent = ''; }, 3000);
            } catch (e) {
                fetchModelsStatus.textContent = 'âœ— å¤±è´¥';
                fetchModelsStatus.style.color = '#ff3b30';
                alert('æ‹‰å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + e.message);
                setTimeout(() => { fetchModelsStatus.textContent = ''; }, 3000);
            }
        });
    }

    // æµ‹è¯•TTSæŒ‰é’®
    if (testTtsButton) {
        testTtsButton.addEventListener('click', async () => {
            if (!minimaxGroupIdInput.value || !minimaxApiKeyInput.value) {
                alert('è¯·å…ˆå¡«å†™ MiniMax Group ID å’Œ API Key');
                return;
            }

            ttsTestStatus.textContent = 'æµ‹è¯•ä¸­...';
            ttsTestStatus.style.color = '#007aff';

            try {
                await saveMinimaxConfig();
                // ä½¿ç”¨é»˜è®¤éŸ³è‰²IDè¿›è¡Œæµ‹è¯•
                await playTTS('ä¹ï¼Œè¡¬è¡«çš„ä»·æ ¼æ˜¯ï¼Œä¹ç£…åäº”ä¾¿å£«ã€‚', 'female-shaonv');
                ttsTestStatus.textContent = 'âœ“ æˆåŠŸ';
                ttsTestStatus.style.color = '#34c759';
                setTimeout(() => { ttsTestStatus.textContent = ''; }, 3000);
            } catch (e) {
                ttsTestStatus.textContent = 'âœ— å¤±è´¥';
                ttsTestStatus.style.color = '#ff3b30';
                alert('æµ‹è¯•å¤±è´¥: ' + e.message);
                setTimeout(() => { ttsTestStatus.textContent = ''; }, 3000);
            }
        });
    }

    // ã€æ ¸å¿ƒä¿®å¤ã€‘ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–ï¼Œç”¨æˆ·åˆ‡æ¢æ¨¡å‹æ—¶ç«‹å³ä¿å­˜
    if (minimaxModelSelect) {
        minimaxModelSelect.addEventListener('change', async () => {
            try {
                await saveMinimaxConfig();
                console.log('[MiniMax] æ¨¡å‹å·²åˆ‡æ¢å¹¶ä¿å­˜:', minimaxModelSelect.value);
            } catch (e) {
                console.error('[MiniMax] ä¿å­˜æ¨¡å‹é€‰æ‹©å¤±è´¥:', e);
            }
        });
    }

    // ã€æ ¸å¿ƒä¿®å¤ã€‘ç›‘å¬ GroupID å˜åŒ–ï¼Œå¤±ç„¦æ—¶è‡ªåŠ¨ä¿å­˜
    if (minimaxGroupIdInput) {
        minimaxGroupIdInput.addEventListener('blur', async () => {
            try {
                await saveMinimaxConfig();
                console.log('[MiniMax] GroupID å·²ä¿å­˜');
            } catch (e) {
                console.error('[MiniMax] ä¿å­˜ GroupID å¤±è´¥:', e);
            }
        });
    }

    // ã€æ ¸å¿ƒä¿®å¤ã€‘ç›‘å¬ API Key å˜åŒ–ï¼Œå¤±ç„¦æ—¶è‡ªåŠ¨ä¿å­˜
    if (minimaxApiKeyInput) {
        minimaxApiKeyInput.addEventListener('blur', async () => {
            try {
                await saveMinimaxConfig();
                console.log('[MiniMax] API Key å·²ä¿å­˜');
            } catch (e) {
                console.error('[MiniMax] ä¿å­˜ API Key å¤±è´¥:', e);
            }
        });
    }

    // ä¿å­˜é…ç½®æ—¶è‡ªåŠ¨ä¿å­˜MiniMaxè®¾ç½®
    const saveAllSettingsBtnMinimax = document.getElementById('save-all-settings-btn');
    if (saveAllSettingsBtnMinimax) {
        saveAllSettingsBtnMinimax.addEventListener('click', async () => {
            await saveMinimaxConfig();
        });
    }

    // é¡µé¢åŠ è½½æ—¶åŠ è½½é…ç½®ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–ï¼‰
    setTimeout(async () => {
        try {
            // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²åˆå§‹åŒ–
            if (dbHelper && dbHelper.db) {
                await loadMinimaxConfig();
            } else {
                debugWarn('[MiniMax] æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè·³è¿‡é…ç½®åŠ è½½');
            }
        } catch (e) {
            console.error('[MiniMax] åŠ è½½é…ç½®å¤±è´¥', e);
        }
    }, 500);


    // ==========================================================
    // === èŠå¤©è®¾ç½®ä¸­æ·»åŠ éŸ³è‰²é€‰æ‹© ===
    // ==========================================================

    // åœ¨èŠå¤©è®¾ç½®æ¨¡æ€æ¡†ä¸­æ·»åŠ éŸ³è‰²IDè¾“å…¥UI
    const chatSettingsModalTTS = document.getElementById('chat-settings-modal');
    if (chatSettingsModalTTS) {
        // æŸ¥æ‰¾æˆ–åˆ›å»ºéŸ³è‰²IDè¾“å…¥åŒºåŸŸ
        let voiceSettingGroup = chatSettingsModalTTS.querySelector('#tts-voice-setting-group');
        if (!voiceSettingGroup) {
            // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
            const modalBody = chatSettingsModalTTS.querySelector('.modal-body');
            if (modalBody) {
                voiceSettingGroup = document.createElement('div');
                voiceSettingGroup.id = 'tts-voice-setting-group';
                voiceSettingGroup.className = 'form-group';
                voiceSettingGroup.innerHTML = `
                    <label>TTS éŸ³è‰²ID (MiniMax)</label>
                    <input type="text" id="contact-tts-voice-input" class="form-input" placeholder="ä¾‹å¦‚: female-shaonv">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        ç•™ç©ºåˆ™ä¸ä½¿ç”¨è¯­éŸ³åˆæˆã€‚å¸¸ç”¨éŸ³è‰²IDï¼š<br>
                        female-shaonv (å°‘å¥³), female-yujie (å¾¡å§), male-qn-jingying (ç²¾è‹±é’å¹´)
                    </small>
                `;
                modalBody.appendChild(voiceSettingGroup);

                // --- æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ å®æ—¶ç›‘å¬å™¨ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤± ---
                const vInput = voiceSettingGroup.querySelector('#contact-tts-voice-input');
                if (vInput) {
                    // 1. å®æ—¶ä¿®æ”¹å†…å­˜å¯¹è±¡
                    vInput.addEventListener('input', () => {
                        if (currentOpenContact) {
                            currentOpenContact.ttsVoiceId = vInput.value.trim();
                        }
                    });
                    
                    // 2. å¤±ç„¦æ—¶å¼ºåˆ¶åŒæ­¥åˆ°æ•°æ®åº“ (é˜²æ­¢å¸¸è§„ä¿å­˜å¤±æ•ˆ)
                    vInput.addEventListener('blur', async () => {
                        if (!currentOpenContact) return;
                        const val = vInput.value.trim();
                        try {
                            // è¯»å–æœ€æ–°å…¨é‡æ•°æ®
                            const data = await dbHelper.loadData('messageContacts', 'allContacts');
                            let contacts = (data && Array.isArray(data.value)) ? data.value : [];
                            
                            // æ‰¾åˆ°å½“å‰è”ç³»äººå¹¶æ›´æ–°
                            const idx = contacts.findIndex(c => c.id === currentOpenContact.id);
                            if (idx !== -1) {
                                contacts[idx].ttsVoiceId = val;
                                // å†™å›æ•°æ®åº“
                                await dbHelper.saveData('messageContacts', 'allContacts', contacts);
                                console.log('[MiniMax] éŸ³è‰²IDå·²å¼ºåˆ¶ä¿å­˜åˆ°æ•°æ®åº“:', val);
                            }
                        } catch (e) {
                            console.error('[MiniMax] éŸ³è‰²IDä¿å­˜å¤±è´¥:', e);
                        }
                    });
                }
            }
        }
        
        // --- æ–°å¢ï¼šç›‘å¬å¼¹çª—æ‰“å¼€ï¼Œè‡ªåŠ¨å›æ˜¾æ•°æ® ---
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                    const isVisible = window.getComputedStyle(chatSettingsModalTTS).display !== 'none';
                    if (isVisible && currentOpenContact) {
                        const vInput = document.getElementById('contact-tts-voice-input');
                        if (vInput) {
                            console.log('[MiniMax] è®¾ç½®å¼¹çª—å·²æ‰“å¼€ï¼Œå›æ˜¾éŸ³è‰²ID:', currentOpenContact.ttsVoiceId);
                            vInput.value = currentOpenContact.ttsVoiceId || '';
                        }
                    }
                }
            });
        });
        observer.observe(chatSettingsModalTTS, { attributes: true });
    }

    // ä¿å­˜è”ç³»äººæ—¶ä¿å­˜éŸ³è‰²IDè®¾ç½®
    const saveContactBtnTTS = document.getElementById('save-contact-btn');
    if (saveContactBtnTTS) {
        const originalSaveContact = window.saveContact || function() {};
        window.saveContact = async function() {
            // ä¿å­˜éŸ³è‰²IDåˆ°å½“å‰è”ç³»äºº
            const voiceInput = document.getElementById('contact-tts-voice-input');
            if (voiceInput && currentOpenContact) {
                currentOpenContact.ttsVoiceId = voiceInput.value.trim();
            }
            // è°ƒç”¨åŸå§‹ä¿å­˜å‡½æ•°
            await originalSaveContact();
        };
    }

    // åŠ è½½è”ç³»äººæ—¶åŠ è½½éŸ³è‰²IDè®¾ç½®
    const originalLoadContactSettings = window.loadContactSettings || function() {};
    window.loadContactSettings = function(contact) {
        originalLoadContactSettings(contact);
        // åŠ è½½éŸ³è‰²IDåˆ°è¾“å…¥æ¡†
        if (voiceInput && contact) {
            voiceInput.value = contact.ttsVoiceId || '';
        }
        
        // åº”ç”¨èŠå¤©èƒŒæ™¯
        if (typeof window.applyChatBackground === 'function') {
            window.applyChatBackground(contact.backgroundImage);
        }
    };

    // ==========================================================
    // === æ°”æ³¡æ’­æ”¾æŒ‰é’®ç»‘å®š ===
    // ==========================================================

    // ä¸ºæ‰€æœ‰AIæ°”æ³¡æ·»åŠ æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function bindTTSPlayButtons() {
        // ä½¿ç”¨ document.body è¿›è¡Œå…¨å±€å§”æ‰˜
        // æ”¹ä¸ºã€å†’æ³¡é˜¶æ®µã€‘ç›‘å¬ï¼Œé¿å…å¹²æ‰°åŒå‡»å’Œé•¿æŒ‰ç­‰å…¶ä»–äº¤äº’
        document.body.addEventListener('click', async (e) => {
            // æŸ¥æ‰¾æ’­æ”¾æŒ‰é’®ï¼ˆåŒ…æ‹¬è¯­éŸ³æ¶ˆæ¯çš„æ’­æ”¾æŒ‰é’®ï¼‰
            const playButton = e.target.closest('[data-action="play-tts"], .voice-play-button, .play-voice-btn, .voice-audio-bubble, .clickable-voice-bubble');
            if (!playButton) return;

            // ========== å…³é”®ä¿®å¤ï¼šé¿å…å¹²æ‰°å…¶ä»–äº¤äº’ ==========
            // 1. å¦‚æœç”¨æˆ·æ­£åœ¨ç¼–è¾‘æ¶ˆæ¯ï¼ˆcontenteditableï¼‰ï¼Œä¸å¤„ç†
            if (e.target.isContentEditable || e.target.closest('[contenteditable="true"]')) {
                return;
            }
            
            // 2. å¦‚æœç‚¹å‡»çš„æ˜¯æŠ˜å æŒ‰é’®ï¼Œä¸å¤„ç†ï¼ˆè®©æŠ˜å é€»è¾‘ä¼˜å…ˆï¼‰
            if (e.target.closest('.voice-collapse-btn')) {
                return;
            }
            
            // 3. å¦‚æœç‚¹å‡»çš„æ˜¯èœå•æŒ‰é’®æˆ–é€‰é¡¹ï¼Œä¸å¤„ç†
            if (e.target.closest('.msg-action-menu, .action-button, .menu-item')) {
                return;
            }
            
            // 4. æ£€æŸ¥æ˜¯å¦æ˜¯å¿«é€ŸåŒå‡»ï¼ˆæ—¶é—´é—´éš”<300msï¼‰ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡ï¼Œäº¤ç»™åŒå‡»é€»è¾‘å¤„ç†
            const now = Date.now();
            const lastClickTime = playButton._lastTTSClickTime || 0;
            if (now - lastClickTime < 300) {
                return;  // å¯èƒ½æ˜¯åŒå‡»ï¼Œè·³è¿‡
            }
            playButton._lastTTSClickTime = now;
            
            // è·å–æ¶ˆæ¯è¡Œ
            const messageRow = playButton.closest('.message-row');
            if (!messageRow) {
                console.warn('[TTS Click] æœªæ‰¾åˆ° messageRow');
                return;
            }

            // æå–æ¶ˆæ¯æ–‡æœ¬
            let messageText = '';
            
            // 1. å°è¯•ä»è¯­éŸ³è½¬å½•æ–‡æœ¬è·å– (Voice Message)
            // å…ˆå°è¯•æ‰¾åŒçº§çš„ï¼ˆå› ä¸ºé€šå¸¸ç»“æ„æ˜¯ display-area + transcriptï¼‰
            // æ›´æ–°ï¼šæˆªå›¾æ˜¾ç¤ºç±»åå¯èƒ½æ˜¯ .voice-text-panel
            let voiceTranscript = messageRow.querySelector('.voice-transcript') || messageRow.querySelector('.voice-text-panel');
            
            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•é€šè¿‡ sibling æŸ¥æ‰¾
            if (!voiceTranscript) {
                // Case A: playButton å°±æ˜¯é‚£ä¸ª bubble å®¹å™¨
                let next = playButton.nextElementSibling;
                if (next && (next.classList.contains('voice-transcript') || next.classList.contains('voice-text-panel'))) {
                    voiceTranscript = next;
                }
                
                // Case B: playButton æ˜¯å†…éƒ¨çš„ SVGï¼Œå¾€ä¸Šæ‰¾ä¸€å±‚
                if (!voiceTranscript) {
                    const parent = playButton.parentElement;
                    if (parent) {
                        next = parent.nextElementSibling;
                        if (next && (next.classList.contains('voice-transcript') || next.classList.contains('voice-text-panel'))) {
                            voiceTranscript = next;
                        }
                    }
                }
            }

            // =========================================================
            // === é€šç”¨å‡½æ•°ï¼šåˆ›å»ºæŠ˜å æŒ‰é’® ===
            // =========================================================
            function createCollapseButton(voiceTranscript, isUser) {
                const collapseBtn = document.createElement('button');
                collapseBtn.className = 'voice-collapse-btn';
                collapseBtn.innerHTML = 'â–²'; // å‘ä¸Šç®­å¤´
                
                // æ ¹æ®æ˜¯ç”¨æˆ·è¿˜æ˜¯AIè°ƒæ•´æŒ‰é’®ä½ç½®
                const position = isUser ? 'left: 3px;' : 'right: 3px;';
                
                collapseBtn.style.cssText = `
                    position: absolute;
                    top: 2px;
                    ${position}
                    background: rgba(239, 239, 239, 0.8);
                    border: none;
                    border-radius: 4px;
                    width: 20px;
                    height: 20px;
                    cursor: pointer;
                    font-size: 10px;
                    line-height: 1;
                    color: #333;
                    transition: all 0.2s;
                    z-index: 10;
                `;
                
                // æŠ˜å æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                collapseBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // æŠ˜å 
                    voiceTranscript.style.cssText = 'display: none !important;';
                    voiceTranscript.classList.remove('visible', 'fade-in');
                    // ç§»é™¤æŒ‰é’®
                    collapseBtn.remove();
                });
                
                // é¼ æ ‡æ‚¬åœæ•ˆæœ
                collapseBtn.addEventListener('mouseenter', function() {
                    collapseBtn.style.background = 'rgba(0, 0, 0, 0.2)';
                    collapseBtn.style.color = '#333';
                });
                collapseBtn.addEventListener('mouseleave', function() {
                    collapseBtn.style.background = 'rgba(0, 0, 0, 0.1)';
                    collapseBtn.style.color = '#666';
                });
                
                return collapseBtn;
            }

            // =========================================================
            // === æ ¸å¿ƒé€»è¾‘åˆ†å‰ï¼šåˆ¤æ–­æ˜¯ User è¿˜æ˜¯ AI ===
            // =========================================================
            // ç”¨æˆ·çš„è¯­éŸ³æ°”æ³¡æœ‰ 'user-bubble' ç±»ï¼ŒAIçš„æ²¡æœ‰
            if (playButton.classList.contains('user-bubble')) {
                // ç”¨æˆ·è¯­éŸ³æ°”æ³¡ï¼šåªå±•å¼€ï¼Œä¸æ’­æ”¾TTS
                if (voiceTranscript) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æŠ˜å æŒ‰é’®ï¼ˆè¯´æ˜å·²å±•å¼€ï¼‰
                    const existingCollapseBtn = voiceTranscript.querySelector('.voice-collapse-btn');
                    
                    if (!existingCollapseBtn) {
                        // å¼ºåˆ¶è®¾ç½®çˆ¶å®¹å™¨ä¸ºå‚ç›´å¸ƒå±€
                        const wrapper = voiceTranscript.closest('.voice-message-wrapper');
                        if (wrapper) {
                            wrapper.style.display = 'flex';
                            wrapper.style.flexDirection = 'column';
                            wrapper.style.alignItems = 'flex-end';  // ç”¨æˆ·æ¶ˆæ¯å³å¯¹é½
                            wrapper.style.gap = '4px';
                        }
                        
                        // å±•å¼€
                        voiceTranscript.style.cssText = 'display: block !important; opacity: 1 !important; visibility: visible !important; height: auto !important; margin-top: 0 !important; position: relative !important; padding: 8px 8px 8px 26px !important; background: rgba(0, 0, 0, 0.05) !important; border-radius: 8px !important;';
                        voiceTranscript.classList.add('visible', 'fade-in');
                        
                        // æ·»åŠ æŠ˜å æŒ‰é’®ï¼ˆç”¨æˆ·çš„åœ¨å·¦è¾¹ï¼‰
                        const collapseBtn = createCollapseButton(voiceTranscript, true);
                        voiceTranscript.appendChild(collapseBtn);
                    }
                }
                return; // ç»“æŸæ‰§è¡Œ
            }

            // AIè¯­éŸ³æ°”æ³¡ï¼šå±•å¼€å¹¶å°è¯•æ’­æ”¾TTS
            if (voiceTranscript) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æŠ˜å æŒ‰é’®ï¼ˆè¯´æ˜å·²å±•å¼€ï¼‰
                const existingCollapseBtn = voiceTranscript.querySelector('.voice-collapse-btn');
                
                // å¼ºåˆ¶è®¾ç½®çˆ¶å®¹å™¨ä¸ºå‚ç›´å¸ƒå±€
                const wrapper = voiceTranscript.closest('.voice-message-wrapper');
                if (wrapper) {
                    wrapper.style.display = 'flex';
                    wrapper.style.flexDirection = 'column';
                    wrapper.style.alignItems = 'flex-start';  // AIæ¶ˆæ¯å·¦å¯¹é½
                    wrapper.style.gap = '4px';
                }
                
                // å¼ºåˆ¶å±•å¼€
                voiceTranscript.style.cssText = 'display: block !important; opacity: 1 !important; visibility: visible !important; height: auto !important; margin-top: 0 !important; position: relative !important; padding: 8px 26px 8px 8px !important; background: rgba(0, 0, 0, 0.05) !important;backdrop-filter:blur(10px); border-radius: 8px !important;';
                voiceTranscript.classList.add('visible', 'fade-in'); 
                
                // å¦‚æœè¿˜æ²¡æœ‰æŠ˜å æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ªï¼ˆAIçš„åœ¨å³è¾¹ï¼‰
                if (!existingCollapseBtn) {
                    const collapseBtn = createCollapseButton(voiceTranscript, false);
                    voiceTranscript.appendChild(collapseBtn);
                }
                
                messageText = voiceTranscript.innerText?.trim(); 
            }

            if (!messageText) {
                console.warn('[MiniMax TTS] æ— æ³•è·å–æ¶ˆæ¯æ–‡æœ¬');
                return;
            }

            // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å¯ç”¨
            if (!dbHelper || !dbHelper.db) {
                console.warn('[MiniMax TTS] æ•°æ®åº“æœªåˆå§‹åŒ–');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦é…ç½®äº†MiniMax
            const configWrapper = await dbHelper.loadData('settingsStore', 'minimaxTTSConfig').catch(e => null);
            if (!configWrapper || !configWrapper.value || !configWrapper.value.groupId || !configWrapper.value.apiKey) {
                console.warn('[MiniMax TTS] æœªé…ç½®ï¼Œè·³è¿‡æ’­æ”¾');
                return;
            }

            // è·å–å½“å‰è”ç³»äººçš„éŸ³è‰²è®¾ç½®
            const voiceId = currentOpenContact?.ttsVoiceId || 'female-shaonv';
            const language = currentOpenContact?.ttsLanguage;
            console.log('[MiniMax TTS] ä½¿ç”¨éŸ³è‰²:', voiceId, 'è¯­è¨€:', language);

            // æ’­æ”¾
            try {
                playButton.style.opacity = '0.5';
                await playTTS(messageText, voiceId, language);
                playButton.style.opacity = '1';
            } catch (e) {
                playButton.style.opacity = '1';
                console.error('[MiniMax TTS] æ’­æ”¾å¤±è´¥', e);
                alert('æ’­æ”¾å‡ºé”™: ' + e.message);
            }
        }, true); // <--- æ­¤å¤„æ”¹ä¸º trueï¼Œå¯ç”¨æ•è·é˜¶æ®µç›‘å¬
    }

    // åˆå§‹åŒ–ç»‘å®š
    bindTTSPlayButtons();

    // ç›‘å¬èŠå¤©æ¶ˆæ¯æ›´æ–°ï¼Œé‡æ–°ç»‘å®šï¼ˆå¦‚æœéœ€è¦ï¼‰
    // æ³¨æ„ï¼šç”±äºä½¿ç”¨äº†äº‹ä»¶å§”æ‰˜ï¼Œç†è®ºä¸Šä¸éœ€è¦é‡æ–°ç»‘å®š






    // ==========================================================
    // === èŠå¤©èƒŒæ™¯è®¾ç½® (Group/Single) ===
    // ==========================================================
    const chatBgInput = document.getElementById('chat-bg-input');
    const chatBgPreview = document.getElementById('chat-bg-preview');
    const chatBgPlaceholder = document.getElementById('chat-bg-placeholder');
    const clearChatBgBtn = document.getElementById('clear-chat-bg-btn');
    // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼Œé¿å…é”™è¯¯åœ°é€‰ä¸­add-contact-modalä¸­çš„å¤´åƒä¸Šä¼ åŒºåŸŸ
    // æ³¨æ„ï¼šHTMLä¸­å·²ç»é€šè¿‡onclickå±æ€§å¤„ç†äº†ç‚¹å‡»äº‹ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†éœ€è¦æ·»åŠ clickäº‹ä»¶ç›‘å¬å™¨
    const chatBgUploadTrigger = document.querySelector('.group-background-section .avatar-uploader');

    // åˆå§‹åŒ–èƒŒæ™¯è®¾ç½®ç›‘å¬å™¨ (åªéœ€æ‰§è¡Œä¸€æ¬¡)
    function initChatBackgroundListeners() {
        // ã€ä¿®å¤ã€‘ç§»é™¤äº†chatBgUploadTriggerçš„clickäº‹ä»¶ç»‘å®šï¼Œå› ä¸ºHTMLä¸­å·²ç»é€šè¿‡onclickå¤„ç†
        // åªä¿ç•™chatBgInputçš„changeäº‹ä»¶
        if (chatBgInput && !chatBgInput._hasListener) {
            
            chatBgInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const base64 = evt.target.result;
                    updateChatBackgroundPreview(base64);
                    await saveChatBackground(base64);
                };
                reader.readAsDataURL(file);
            });
            chatBgInput._hasListener = true;
        }

        if (clearChatBgBtn && !clearChatBgBtn._hasListener) {
            clearChatBgBtn.addEventListener('click', async () => {
                updateChatBackgroundPreview(null);
                await saveChatBackground(null);
            });
            clearChatBgBtn._hasListener = true;
        }
    }
    
    // åˆå§‹åŒ–å¹¶è°ƒç”¨
    // initChatBackgroundListeners();

    function updateChatBackgroundPreview(bgImage) {
        if (bgImage) {
            chatBgPreview.src = bgImage;
            chatBgPreview.style.display = 'block';
            chatBgPlaceholder.style.display = 'none';
        } else {
            chatBgPreview.src = '';
            chatBgPreview.style.display = 'none';
            chatBgPlaceholder.style.display = 'flex';
        }
    }

    async function saveChatBackground(bgImage) {
        try {
            if (typeof currentOpenGroup !== 'undefined' && currentOpenGroup) {
                // ç¾¤èŠ
                const groupsData = await dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                const idx = allGroups.findIndex(g => g.id === currentOpenGroup.id);
                if (idx !== -1) {
                    allGroups[idx].chatBackground = bgImage;
                    await dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                    currentOpenGroup.chatBackground = bgImage;
                    applyChatBackground(bgImage);
                }
            } else if (typeof currentOpenContact !== 'undefined' && currentOpenContact) {
                // å•èŠ
                const contactsData = await dbHelper.loadData('messageContacts', 'allContacts');
                let allContacts = (contactsData && Array.isArray(contactsData.value)) ? contactsData.value : [];
                const idx = allContacts.findIndex(c => c.id === currentOpenContact.id);
                if (idx !== -1) {
                    allContacts[idx].chatBackground = bgImage;
                    await dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                    currentOpenContact.chatBackground = bgImage;
                    applyChatBackground(bgImage);
                }
            }
        } catch (e) {
            console.error("ä¿å­˜èŠå¤©èƒŒæ™¯å¤±è´¥:", e);
        }
    }

    // å…¨å±€æš´éœ²ç»™å…¶ä»–æ¨¡å—è°ƒç”¨
    window.applyChatBackground = function(bgImage) {
        const screen = document.getElementById('chat-messages-container'); 
        // é€šå¸¸èƒŒæ™¯æ˜¯è®¾ç½®åœ¨ .chat-messages-container æˆ–è€… #chat-screen ä¸Š
        // å»ºè®®è®¾ç½®åœ¨ #chat-messages-container ä¸Šï¼Œå› ä¸ºå®ƒåœ¨å†…å®¹å±‚ä¹‹ä¸‹
        // ä½†è¦æ³¨æ„ä¸è¦è¦†ç›–äº†åŸæœ¬çš„èƒŒæ™¯è‰²
        
        if (bgImage) {
            screen.style.backgroundImage = `url('${bgImage}')`;
            screen.style.backgroundSize = 'cover';
            screen.style.backgroundPosition = 'center';
            screen.style.backgroundRepeat = 'no-repeat';
        } else {
            screen.style.backgroundImage = '';
        }
    };
    
    // åŠ è½½å½“å‰ä¼šè¯çš„èƒŒæ™¯è®¾ç½®åˆ°å¼¹çª—
    window.loadChatBackgroundSettings = function() {
        let currentBg = null;
        if (typeof currentOpenGroup !== 'undefined' && currentOpenGroup) {
            currentBg = currentOpenGroup.chatBackground || currentOpenGroup.backgroundImage;
        } else if (typeof currentOpenContact !== 'undefined' && currentOpenContact) {
            currentBg = currentOpenContact.chatBackground || currentOpenContact.backgroundImage; // å•èŠä¹Ÿæ”¯æŒ
        }
        updateChatBackgroundPreview(currentBg);
    };


    // ==========================================================
    // === æ™¤é¢ (Meetu) åŠŸèƒ½æ¨¡å— ===
    // ==========================================================

    // --- State ---
    var meetuState = {
        pages: [], 
        currentPage: 0, 
        styles: [], 
        activeStyleId: null, 
        isGenerating: false
    };

    // --- DOM Elements ---
    var meetuBtn = document.getElementById('meetu-feature');
    var meetuScreen = document.getElementById('meetu-screen');
    var meetuBackBtn = document.getElementById('meetu-back-button');
    var meetuActivePage = document.getElementById('meetu-active-page');
    var meetuPrevBtn = document.getElementById('meetu-prev-page');
    var meetuNextBtn = document.getElementById('meetu-next-page');
    var meetuPageIndicator = document.getElementById('meetu-page-indicator');
    var meetuRerollBtn = document.getElementById('meetu-reroll-btn');
    var meetuContinueBtn = document.getElementById('meetu-continue-btn');
    var meetuExportBtn = document.getElementById('meetu-export-btn');
    var meetuStyleBtn = document.getElementById('meetu-style-btn');
    var meetuBookAnim = document.getElementById('meetu-book-animation');
    
    // Styles Modal
    var meetuStyleModal = document.getElementById('meetu-style-modal');
    var meetuStyleCloseBtn = document.getElementById('meetu-style-close-btn');
    var meetuAddStyleBtn = document.getElementById('meetu-add-style-btn');
    var meetuStyleList = document.getElementById('meetu-style-list');
    
    // Style Editor
    var meetuEditorModal = document.getElementById('meetu-style-editor-modal');
    var meetuEditorCloseBtn = document.getElementById('meetu-editor-close-btn');
    var meetuStyleNameInput = document.getElementById('meetu-style-name');
    var meetuStylePromptInput = document.getElementById('meetu-style-prompt');
    var meetuSaveStyleBtn = document.getElementById('meetu-save-style-btn');
    var editingStyleId = null;

    // --- Continue Modal ---
    var meetuContinueModal = document.getElementById('meetu-continue-modal');
    var meetuContinueInput = document.getElementById('meetu-continue-input');
    var meetuContinueCloseBtn = document.getElementById('meetu-continue-close-btn');
    var meetuConfirmContinueBtn = document.getElementById('meetu-confirm-continue-btn');

    // --- Default Style ---
    var DEFAULT_TO_STYLE = {
        id: 'default_style',
        name: 'é»˜è®¤ç¬”é£',
        desc: 'ç¬¬ä¸‰äººç§°ï¼Œç¬”è§¦ç»†è…»ï¼Œä¾§é‡å¿ƒç†æå†™',
        prompt: 'è¯·ä½¿ç”¨ç¬¬ä¸‰äººç§°ï¼Œä»¥ç»†è…»ä¼˜ç¾çš„ç¬”è§¦è¿›è¡Œæå†™ã€‚é‡ç‚¹åˆ»ç”»è§’è‰²çš„å¿ƒç†æ´»åŠ¨ã€å¾®è¡¨æƒ…å’Œç¯å¢ƒæ°›å›´ã€‚é¿å…è¿‡äºç›´ç™½çš„å¯¹è¯å †ç Œï¼Œå¤šç”¨ä¾§é¢æå†™ã€‚',
        isDefault: true
    };

    // --- Init ---
    async function initMeetu() {
        console.log('[Meetu] Initializing UI...', { btn: !!meetuBtn });
        // --- DEBUG START ---
        console.log('[DEBUG_MEETU] Checking elements existence:', {
            meetuStyleBtn: !!meetuStyleBtn,
            meetuContinueBtn: !!meetuContinueBtn,
            meetuStyleModal: !!meetuStyleModal,
            meetuContinueModal: !!meetuContinueModal,
            meetuScreen: !!meetuScreen
        });
        // --- DEBUG END ---
        
        if (meetuBtn) meetuBtn.addEventListener('click', openMeetu);
        if (meetuBackBtn) meetuBackBtn.addEventListener('click', closeMeetu);
        if (meetuPrevBtn) meetuPrevBtn.addEventListener('click', function() { changeMeetuPage(-1); });
        if (meetuNextBtn) meetuNextBtn.addEventListener('click', function() { changeMeetuPage(1); });
        
        if (meetuRerollBtn) meetuRerollBtn.addEventListener('click', function() { handleMeetuGenerate('reroll'); });
        
        // Continue with Modal
        if (meetuContinueBtn) {
             console.log('[DEBUG_MEETU] Binding click listener to meetuContinueBtn');
             meetuContinueBtn.addEventListener('click', function(e) {
                console.log('[DEBUG_MEETU] meetuContinueBtn CLICKED. Event:', e);
                e.stopPropagation(); // Prevent bubbling issues
                if (meetuContinueModal) {
                 meetuContinueInput.value = '';
                 // Force modal to be top-level child of body to avoid stacking context issues
                 document.body.appendChild(meetuContinueModal);
                 meetuContinueModal.style.zIndex = '2147483647'; // Max Int32
                 meetuContinueModal.style.display = 'flex';
                 // Force reflow
                 void meetuContinueModal.offsetWidth;
                 meetuContinueModal.style.opacity = '1';
                 meetuContinueModal.classList.add('visible'); // Critical for content animation
                 meetuContinueModal.classList.add('active');   // Just in case
                 meetuContinueInput.focus();
            } else {
                 handleMeetuGenerate('continue');
            }
        });
        }
        
        // Continue Modal Actions
        if (meetuContinueCloseBtn) meetuContinueCloseBtn.addEventListener('click', function() { 
             meetuContinueModal.classList.remove('visible'); 
             meetuContinueModal.classList.remove('active');
             meetuContinueModal.style.display = 'none'; 
        });
        if (meetuConfirmContinueBtn) meetuConfirmContinueBtn.addEventListener('click', function() {
            var instruction = meetuContinueInput.value.trim();
            meetuContinueModal.style.display = 'none';
            handleMeetuGenerate('continue', instruction);
        });

        if (meetuExportBtn) meetuExportBtn.addEventListener('click', exportMeetuContent);
        
        // Style Management Bindings
        if (meetuStyleBtn) {
            console.log('[DEBUG_MEETU] Binding click listener to meetuStyleBtn');
            meetuStyleBtn.addEventListener('click', function(e) {
                console.log('[DEBUG_MEETU] meetuStyleBtn CLICKED. Event:', e);
                e.stopPropagation();
                openStyleModal();
            });
        }
        if (meetuStyleCloseBtn) meetuStyleCloseBtn.addEventListener('click', function() { 
             meetuStyleModal.classList.remove('visible');
             meetuStyleModal.classList.remove('active');
             meetuStyleModal.style.display = 'none'; 
        });
        if (meetuAddStyleBtn) meetuAddStyleBtn.addEventListener('click', function() { openStyleEditor(); });
        if (meetuEditorCloseBtn) meetuEditorCloseBtn.addEventListener('click', function() { 
              meetuEditorModal.classList.remove('visible');
              meetuEditorModal.classList.remove('active');
              meetuEditorModal.style.display = 'none'; 
        });
        if (meetuSaveStyleBtn) meetuSaveStyleBtn.addEventListener('click', saveStyle);

        // Background Init
        let retries = 0;
        while ((!window.dbHelper || !window.dbHelper.db) && retries < 50) {
            await new Promise(r => setTimeout(r, 200));
            retries++;
        }
        if (window.dbHelper && window.dbHelper.db) {
             await loadMeetuStyles();
        }
    }


    // --- Navigation ---
    async function openMeetu() {
        console.log('[Meetu] openMeetu called');
        if (!currentOpenContact) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äºº');
            return;
        }
        
        // Show screen immediately for debugging
        if (meetuScreen) {
             // Force Styles to ensure visibility
             meetuScreen.style.position = 'fixed';
             meetuScreen.style.top = '0';
             meetuScreen.style.left = '0';
             meetuScreen.style.width = '100%';
             meetuScreen.style.height = '100%';
             meetuScreen.style.zIndex = '9999';
             meetuScreen.style.display = 'flex';
             meetuScreen.style.visibility = 'visible';
             meetuScreen.style.opacity = '1';
             meetuScreen.style.backgroundColor = '#f4ecd8'; // Fallback bg
             
             meetuScreen.classList.add('visible'); 
             console.log('[Meetu] Screen forced visible with inline styles');
        } else {
             console.error('[Meetu] Screen element missing!');
        }

        /*
        // Play Animation (Disabled for debugging)
        if (meetuBookAnim) {
             meetuBookAnim.style.display = 'flex';
             meetuBookAnim.style.zIndex = '10000'; // Above screen
             // Hide animation layer
             setTimeout(function() {
                 if (meetuBookAnim) meetuBookAnim.style.display = 'none';
             }, 1200);
        }
        */

        // Reset
        meetuState.pages = [];
        meetuState.currentPage = 0;
        updateMeetuPage();
        
        // Auto Start
        handleMeetuGenerate('new');
    }

    function closeMeetu() {
        if (meetuState.pages.length > 0) {
            var doSum = confirm('æ˜¯å¦å°†æœ¬æ¬¡æ™¤é¢å†…å®¹æ€»ç»“ä¸ºè®°å¿†æ”¯ç¥¨ï¼Ÿ');
            if (doSum) {
                handleMemorySummarizeFromMeetu();
            }
        }
        if (meetuScreen) {
            // Remove ALL inline styles set by openMeetu
            meetuScreen.style.cssText = '';
            meetuScreen.style.display = 'none';
            meetuScreen.classList.remove('visible');
        }
        // iOS Crash Fix
        if (typeof meetuActivePage !== 'undefined' && meetuActivePage) {
            meetuActivePage.innerHTML = '';
        }
    }
    
    async function handleMemorySummarizeFromMeetu() {
        // æ„å»ºå…¨é‡æ–‡æœ¬
        var fullText = meetuState.pages.join('\n');
        // æ¨¡æ‹Ÿè°ƒç”¨ç°æœ‰çš„æ€»ç»“æµç¨‹
        // è¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œç›´æ¥å¤ç”¨ existing summarize logic with custom prompt
        showToast('æ­£åœ¨åå°æ€»ç»“è®°å¿†...');
        try {
             var settings = await dbHelper.loadData('settingsStore', 'apiSettings');
             var model = settings.value.model || 'gpt-3.5-turbo';
             var prompt = "è¯·æ€»ç»“ä»¥ä¸‹æˆ‘ä»¬åœ¨çº¿ä¸‹çš„äº’åŠ¨å†…å®¹ï¼Œæå–å…³é”®äº‹ä»¶å’Œæƒ…æ„Ÿå˜åŒ–ï¼Œç®€è¦æ¦‚æ‹¬ï¼š\n{CHAT_HISTORY}";
             
             // ä¸´æ—¶æ›¿æ¢ content
             var summary = await doMemorySummarizeRaw(fullText, model, prompt);
             if (summary) {
                await saveMemoryChequeData("ã€æ™¤é¢æ€»ç»“ã€‘" + summary, 1); // 1 mock count
                showToast('å·²ç”Ÿæˆè®°å¿†æ”¯ç¥¨');
             }
        } catch(e) {
            console.error(e);
            showToast('è®°å¿†æ€»ç»“å¤±è´¥');
        }
    }
    
    // ä¸“é—¨ä¸ºæ™¤é¢å®šåˆ¶çš„æ€»ç»“å‡½æ•° (å¤ç”¨ api è°ƒç”¨é€»è¾‘)
    async function doMemorySummarizeRaw(text, model, prompt) {
        var finalPrompt = prompt.replace('{CHAT_HISTORY}', text);
        var settings = await dbHelper.loadData('settingsStore', 'apiSettings');
        var url = settings.value.url;
        if (url.endsWith('/')) url = url.slice(0, -1);
        url += '/chat/completions';
        
        var resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.value.key },
            body: JSON.stringify({ model: model, messages: [{ role: 'user', content: finalPrompt }], temperature: 0.8 })
        });
        var data = await resp.json();
        return data.choices[0].message.content.trim();
    }

    // --- Styles Management ---
    const LOCAL_STORAGE_MEETU_KEY = 'meetuStyles_backup';

    async function loadMeetuStyles() {
        try {
            console.log('[Meetu] Loading styles...');
            var styles = null;
            
            // 1. Try DB first
            try {
                var data = await dbHelper.loadData('settingsStore', 'meetuStyles');
                if (data && data.value && Array.isArray(data.value) && data.value.length > 0) {
                     styles = data.value;
                     console.log('[Meetu] Loaded from DB:', styles.length);
                }
            } catch(dbErr) {
                console.warn('[Meetu] DB Load failed, trying LocalStorage...', dbErr);
            }
            
            // 2. Fallback to LocalStorage
            if (!styles) {
                var localData = localStorage.getItem(LOCAL_STORAGE_MEETU_KEY);
                if (localData) {
                    try {
                        var parsed = JSON.parse(localData);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            styles = parsed;
                            console.log('[Meetu] Loaded from LocalStorage:', styles.length);
                            // Sync back to DB for consistency
                            saveMeetuStyles(styles); 
                        }
                    } catch(e) { console.error('LS config parse error', e); }
                }
            }

            // 3. Final Default
            if (!styles) {
                 console.log('[Meetu] No styles found, using default.');
                 styles = [DEFAULT_TO_STYLE];
            }
            
            meetuState.styles = styles;
            
            // Normalize data
            meetuState.styles.forEach(function(s) { 
                if (typeof s.active === 'undefined') s.active = false; 
            });
            
        } catch(e) {
            console.error('[Meetu] Critical Load failed:', e);
            meetuState.styles = [DEFAULT_TO_STYLE];
        }
    }
    
    async function saveMeetuStyles(stylesToSave) {
        // Allow passing explicit styles, or use state
        var targetStyles = stylesToSave || meetuState.styles;
        console.log('[Meetu] Saving styles...', targetStyles.length);
        
        // 1. Save to LocalStorage (Synchronous & Reliable)
        try {
            localStorage.setItem(LOCAL_STORAGE_MEETU_KEY, JSON.stringify(targetStyles));
        } catch (e) {
            console.error('[Meetu] LS Save failed', e);
        }
        
        // 2. Save to DB
        try {
            await dbHelper.saveData('settingsStore', 'meetuStyles', targetStyles);
        } catch(e) {
             console.error('[Meetu] DB Save failed', e);
        }
    }
    
    function renderStylesList() {
        meetuStyleList.innerHTML = '';
        meetuState.styles.forEach(function(style) {
            var div = document.createElement('div');
            div.className = 'playlist-item'; 
            
            // 1. Content
            var contentDiv = document.createElement('div');
            contentDiv.className = 'style-card-content';
            contentDiv.innerHTML = '<div class="style-card-title">' + style.name + '</div>' +
                                   '<div class="style-card-desc">' + (style.desc || 'æ— æè¿°') + '</div>';
            
            // 2. Action Buttons Container
            var actionsDiv = document.createElement('div');
            actionsDiv.className = 'card-actions';
            
            // SVG Icons
            var iconEdit = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
            var iconTrash = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
            var iconCheck = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            
            // A. Edit Button (Only if not default)
            if (!style.isDefault) {
                var editBtn = document.createElement('button');
                editBtn.className = 'action-circle edit-btn';
                editBtn.innerHTML = iconEdit;
                editBtn.onclick = function(e) { e.stopPropagation(); openStyleEditor(style); };
                actionsDiv.appendChild(editBtn);
                
                var delBtn = document.createElement('button');
                delBtn.className = 'action-circle delete-btn';
                delBtn.innerHTML = iconTrash;
                delBtn.onclick = function(e) { e.stopPropagation(); deleteStyle(style.id); };
                actionsDiv.appendChild(delBtn);
            }
            
            // B. Toggle Button (Active State)
            var toggleBtn = document.createElement('button');
            toggleBtn.className = 'action-circle toggle-btn ' + (style.active ? 'active' : '');
            toggleBtn.innerHTML = iconCheck;
            toggleBtn.onclick = function(e) { 
                e.stopPropagation(); 
                toggleStyleActive(style.id, !style.active);
            };
            actionsDiv.appendChild(toggleBtn);

            div.appendChild(contentDiv);
            div.appendChild(actionsDiv);
            
            meetuStyleList.appendChild(div);
        });
    }

    function openStyleModal() {
        console.log('[DEBUG_MEETU] openStyleModal executing...');
        renderStylesList();
        if (!meetuStyleModal) {
            console.error('[DEBUG_MEETU] FATAL: meetuStyleModal is NULL!');
            alert('Error: Style Modal element missing');
            return;
        }
        // Force modal to be top-level child of body
        document.body.appendChild(meetuStyleModal);
        meetuStyleModal.style.zIndex = '2147483647';
        meetuStyleModal.style.display = 'flex';
        void meetuStyleModal.offsetWidth; // Force reflow
        meetuStyleModal.style.opacity = '1';
        meetuStyleModal.classList.add('visible');
        meetuStyleModal.classList.add('active');
        console.log('[DEBUG_MEETU] Modal moved to body. Z-Index maxed.');
    }
    
    function toggleStyleActive(id, isActive) {
        console.log('[DEBUG_MEETU] Toggling style:', id, 'to', isActive);
        var style = meetuState.styles.find(function(s) { return s.id === id; });
        if (style) {
            style.active = isActive;
            
            // Re-render immediately to show visual feedback
            renderStylesList();
            
            // Save in background
            saveMeetuStyles();
        } else {
             console.error('[DEBUG_MEETU] Style not found for toggle:', id);
        }
    }
    
    function openStyleEditor(style) {
        style = style || null;
        editingStyleId = style ? style.id : null;
        meetuStyleNameInput.value = style ? style.name : '';
        meetuStylePromptInput.value = style ? style.prompt : '';
        document.getElementById('meetu-editor-title').textContent = style ? 'ç¼–è¾‘ç¬”é£' : 'æ–°å»ºç¬”é£';
        
        // Move to body
        document.body.appendChild(meetuEditorModal);
        
        meetuEditorModal.style.zIndex = '2147483647'; // Above style modal
        meetuEditorModal.style.display = 'flex';
        void meetuEditorModal.offsetWidth;
        meetuEditorModal.style.opacity = '1';
        meetuEditorModal.classList.add('visible');
        meetuEditorModal.classList.add('active');
    }
    
    async function saveStyle() {
        var name = meetuStyleNameInput.value.trim();
        var prompt = meetuStylePromptInput.value.trim();
        if(!name || !prompt) { showToast('è¯·å¡«å†™å®Œæ•´'); return; }
        
        if (editingStyleId) {
            var style = meetuState.styles.find(function(s) { return s.id === editingStyleId; });
            if(style) {
                style.name = name;
                style.prompt = prompt;
                style.desc = prompt.substring(0, 20) + '...';
            }
        } else {
            meetuState.styles.push({
                id: 'style_' + Date.now(),
                name: name,
                prompt: prompt,
                desc: prompt.substring(0, 20) + '...',
                active: false,
                isDefault: false
            });
        }

        
        console.log('[DEBUG_MEETU] Saving new/edited style chain', meetuState.styles);
        await saveMeetuStyles(meetuState.styles); // Force save with current state
        
        meetuEditorModal.style.display = 'none';
        meetuEditorModal.classList.remove('visible');
        meetuEditorModal.classList.remove('active');
        renderStylesList();
    }
    
    function deleteStyle(id) {
        if(!confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”é£?')) return;
        meetuState.styles = meetuState.styles.filter(function(s) { return s.id !== id; });
        saveMeetuStyles();
        renderStylesList();
    }

    // --- Core Generation ---
    async function prepareMeetuContext() {
        // 1. History (Last 50)
        var history = currentOpenContact.history.slice(-50).map(function(msg) {
            return (msg.sender === 'user' ? currentOpenContact.user.name : currentOpenContact.ai.name) + ': ' + msg.text;
        }).join('\n');
        
        // 2. Personas
        var aiPersona = currentOpenContact.ai.description || 'æ— ';
        var userPersona = 'ï¼ˆç”¨æˆ·æœªè®¾å®šï¼‰'; 
        
       
        // 3. WorldBook - æ­£ç¡®åŠ è½½ä¸–ç•Œä¹¦ (æ”¯æŒå¤šé€‰ä¹¦ç±)
        var worldInfo = "";
        try {
            // ç­–ç•¥ä¼˜å…ˆï¼šlinkedWorldBookIds > linkedWorldBookGroupIds > old worldBook content
            let targetBookIds = new Set();
            
            if (currentOpenContact.linkedWorldBookIds && currentOpenContact.linkedWorldBookIds.length > 0) {
                currentOpenContact.linkedWorldBookIds.forEach(function(id) { targetBookIds.add(id); });
            } else if (currentOpenContact.linkedWorldBookGroupIds && currentOpenContact.linkedWorldBookGroupIds.length > 0) {
                 if (window.dbHelper) {
                      var gData = await window.dbHelper.loadData('worldBookGroups', 'allGroups');
                      var groups = (gData && gData.value) ? gData.value : [];
                      var lIds = new Set(currentOpenContact.linkedWorldBookGroupIds);
                      groups.forEach(function(g) {
                          if (lIds.has(g.id) && Array.isArray(g.bookIds)) {
                              g.bookIds.forEach(function(bid) { targetBookIds.add(bid); });
                          }
                      });
                 }
            }
            
            if (targetBookIds.size > 0 && window.dbHelper) {
                 var bData = await window.dbHelper.loadData('worldBooks', 'allWorldBooks');
                 var books = (bData && bData.value) ? bData.value : [];
                 worldInfo = books.filter(function(b) { return targetBookIds.has(b.id); })
                                  .map(function(b) { return b.content || b.text || ''; })
                                  .join('\n\n');
            }
            
            // Fallback to legacy fields if nothing found
            if ((!worldInfo || !worldInfo.trim()) && currentOpenContact.worldBook) {
                 if (Array.isArray(currentOpenContact.worldBook)) {
                     worldInfo = currentOpenContact.worldBook.map(function(e) { return e.content || ''; }).join('\n');
                 }
            }
        } catch (e) {
            console.error('[Meetu] WorldBook loading error:', e);
        }
        
        // å¦‚æœæ²¡æœ‰ä¸–ç•Œä¹¦å†…å®¹ï¼Œè®¾ç½®é»˜è®¤å€¼
        if (!worldInfo || !worldInfo.trim()) {
            worldInfo = "æ— ";
        }
        
        // 4. Memory Cheques
        var memories = [];
        if (window.getEnabledMemories) {
            memories = await window.getEnabledMemories(currentOpenContact.id);
        }
        var memoryText = memories.map(function(m) { return '[è®°å¿†] ' + m.content; }).join('\n');
        
        // 5. Style (Multi-select)
        var activeStyles = meetuState.styles.filter(function(s) { return s.active; });
        var stylePrompt = "";
        
        if (activeStyles.length > 0) {
            // Merge prompts
            stylePrompt = activeStyles.map(function(s) {
                return "ã€" + s.name + "ã€‘: " + s.prompt;
            }).join('\n\n');
        } else {
             stylePrompt = "(æœªå¯ç”¨ç‰¹å®šç¬”é£ï¼Œè¯·è‡ªç”±å‘æŒ¥)";
        }
        
        // Mock object to keep compatible with existing 'style.prompt' usage
        var styleObj = { prompt: stylePrompt };
        
        return { history: history, aiPersona: aiPersona, userPersona: userPersona, memoryText: memoryText, worldInfo: worldInfo, style: styleObj };
    }
    
    async function handleMeetuGenerate(type, userInstruction) {
        if (meetuState.isGenerating) return;
        meetuState.isGenerating = true;
        
        if (meetuActivePage) {
            meetuActivePage.textContent = "æ­£åœ¨ä¾ç…§" + (type === 'reroll' ? 'å½“å‰' : 'æ–°çš„') + "æ€è·¯æ„æ€ä¸­...";
            meetuActivePage.style.opacity = 0.5;
        }
        
        try {
            var ctx = await prepareMeetuContext();
            var config = await dbHelper.loadData('settingsStore', 'apiSettings');
            
            if(!config || !config.value || !config.value.key) throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API Key');
            
            var prompt = 
`ä½ æ˜¯ä¸€ä½æå…¶å‡ºè‰²çš„ä½œå®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ï¼Œåˆ›ä½œä¸€æ®µ"çº¿ä¸‹è§é¢"çš„äº’åŠ¨å°è¯´æå†™ã€‚

ã€è§’è‰²ä¿¡æ¯ã€‘
AI: ${ctx.aiPersona}
ç”¨æˆ·: ${ctx.userPersona}

ã€ä¸–ç•Œè§‚è®¾å®šã€‘
${ctx.worldInfo}

ã€é‡è¦è®°å¿†ã€‘
${ctx.memoryText}

ã€è¿‘æœŸå‰æƒ…æè¦ã€‘
${ctx.history}

ã€æ–‡é£è¦æ±‚ - å¿…é¡»ä¸¥æ ¼æ‰§è¡Œã€‘
${ctx.style.prompt}

ã€ä»»åŠ¡æŒ‡ä»¤ã€‘
${type === 'continue' ? 'æ¥ç»­ä¸Šæ–‡ï¼ˆå‚è€ƒå·²æœ‰å†…å®¹ï¼‰ï¼Œç»§ç»­æå†™åç»­å‘å±•ã€‚' : 'å¼€å¯ä¸€æ®µæ–°çš„çº¿ä¸‹äº’åŠ¨æå†™ï¼Œæˆ–é‡å†™å½“å‰æ®µè½ã€‚'}
æå†™åº”å…·æœ‰ç”»é¢æ„Ÿã€æ²‰æµ¸æ„Ÿï¼Œå­—æ•°æ§åˆ¶åœ¨200-400å­—å·¦å³ã€‚çº¯æ–‡æœ¬è¾“å‡ºï¼Œä¸è¦åŒ…å«Markdownæ ‡è®°ã€‚
`;
            
            // å¦‚æœç”¨æˆ·æä¾›äº†è‡ªå®šä¹‰æƒ³æ³•ï¼Œæ·»åŠ åˆ°promptä¸­
            if(userInstruction && userInstruction.trim()) {
                 prompt += `\n\nã€ç”¨æˆ·çš„æƒ³æ³• - é‡ç‚¹å‚è€ƒï¼Œå¿…é¡»å‚è€ƒã€‘\n${userInstruction.trim()}`;
            }
            
            if(type === 'continue' && meetuState.pages.length > 0) {
                 prompt += `\nã€ä¸Šæ–‡å†…å®¹ã€‘\n${meetuState.pages[meetuState.pages.length-1].substring(0, 500)}...`;
            }

            var url = config.value.url;
            if (url.endsWith('/')) url = url.slice(0, -1);
            url += '/chat/completions';
            
            var resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + config.value.key },
                body: JSON.stringify({
                    model: config.value.model || 'gpt-3.5-turbo',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.85,
                    // allow configuring max tokens via settings; fallback to 800
                    max_tokens: (config.value.max_tokens || config.value.maxTokens || 80000)
                })
            });
            
            var data = await resp.json();
            if (!data.choices) throw new Error("APIè¿”å›æ ¼å¼é”™è¯¯");
            var content = data.choices[0].message.content.trim();
            
            // Update State
            if (type === 'reroll' && meetuState.pages.length > 0) {
                meetuState.pages[meetuState.pages.length - 1] = content;
            } else {
                meetuState.pages.push(content);
            }
            
            meetuState.currentPage = meetuState.pages.length - 1;
            updateMeetuPage();
            
        } catch (e) {
            console.error(e);
            if (meetuActivePage) meetuActivePage.textContent = "çµæ„Ÿæ¯ç«­äº†... (ç”Ÿæˆå¤±è´¥: " + e.message + ")";
        } finally {
            meetuState.isGenerating = false;
            // æ¢å¤é€æ˜åº¦ï¼ˆupdateMeetuPageä¼šå¤„ç†æ˜¾ç¤ºå†…å®¹ï¼‰
             if (meetuActivePage) meetuActivePage.style.opacity = 1;
        }
    }
    
    function updateMeetuPage() {
        if (!meetuActivePage) return;
        
        if (meetuState.pages.length === 0) {
            meetuActivePage.textContent = "";
            meetuPageIndicator.textContent = "0 / 0";
            return;
        }
        
        // ç®€å•çš„æ·¡å…¥æ·¡å‡ºåŠ¨ç”»
        meetuActivePage.style.opacity = 0;
        setTimeout(function() {
             // é¢„å¤„ç†æ–‡æœ¬ï¼šæ®µè½å‰ç¼©è¿›? è¿™é‡Œç®€å•æ›¿æ¢æ¢è¡Œä¸ºåŒæ¢è¡Œ
             var text = meetuState.pages[meetuState.currentPage];
             meetuActivePage.innerText = text; 
             meetuActivePage.style.opacity = 1;
        }, 200);

        meetuPageIndicator.textContent = (meetuState.currentPage + 1) + ' / ' + meetuState.pages.length;
        
        if (meetuPrevBtn) meetuPrevBtn.disabled = meetuState.currentPage === 0;
        if (meetuNextBtn) meetuNextBtn.disabled = meetuState.currentPage === meetuState.pages.length - 1;
    }
    
    function changeMeetuPage(delta) {
        var newPage = meetuState.currentPage + delta;
        if (newPage >= 0 && newPage < meetuState.pages.length) {
            meetuState.currentPage = newPage;
            updateMeetuPage();
        }
    }
    
    function exportMeetuContent() {
        var text = meetuState.pages.join('\n\n ================= \n\n');
        if (!text) { showToast('æ²¡æœ‰å†…å®¹å¯å¯¼å‡º'); return; }
        
        var blob = new Blob([text], { type: 'text/plain' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'æ™¤é¢è®°å½•_' + (new Date().toISOString().slice(0,10)) + '.txt';
        a.click();
        URL.revokeObjectURL(url);
        showToast('å·²å¯¼å‡º');
    }

    console.log('[Meetu] Starting initialization...');
    initMeetu().then(() => console.log('[Meetu] Initialization done')).catch(e => console.error('[Meetu] Init failed', e));

});


// ============================================
// ğŸ® é€¸äº‹åŠŸèƒ½ (Anecdotes Feature)
// å¤é£ä¿¡ç›’äº¤äº’ - ç”Ÿæˆè§’è‰²ç•ªå¤–å°æ•…äº‹
// ============================================

document.addEventListener('DOMContentLoaded', () => {
    // DOM å…ƒç´ 
    const anecdotesFeatureBtn = document.getElementById('anecdotes-feature');
    const anecdotesModal = document.getElementById('anecdotes-modal');
    const anecdotesCloseBtn = document.getElementById('anecdotes-close-btn');
    const anecdotesBox = document.getElementById('anecdotes-box');
    const anecdotesLetter = document.getElementById('anecdotes-letter');
    const anecdotesPenBtn = document.getElementById('anecdotes-pen-btn');
    const anecdotesInput = document.getElementById('anecdotes-input');
    const anecdotesConfirmBtn = document.getElementById('anecdotes-confirm-btn');
    const anecdotesAgainBtn = document.getElementById('anecdotes-again-btn');
    const anecdotesHint = document.getElementById('anecdotes-hint');
    const letterInputView = document.getElementById('letter-input-view');
    const letterResponseView = document.getElementById('letter-response-view');
    const letterLoadingView = document.getElementById('letter-loading-view');
    const anecdotesResponseContent = document.getElementById('anecdotes-response-content');
    const anecdotesSignature = document.getElementById('anecdotes-signature');
    // æ–°å¢å…ƒç´ 
    const anecdotesCollectionBtn = document.getElementById('anecdotes-collection-btn');
    const anecdotesCollectionModal = document.getElementById('anecdotes-collection-modal');
    const collectionList = document.getElementById('collection-list');
    const collectionCloseBtn = document.getElementById('collection-close-btn');
    const anecdotesRemailBtn = document.getElementById('anecdotes-remail-btn');
    
    let lastAnecdotesPrompt = ''; // å­˜å‚¨ä¸Šä¸€æ¬¡çš„æç¤ºè¯ç”¨äºé‡æ–°é‚®å¯„

    // æ ¸å¿ƒå…ƒç´ å®Œæ•´æ€§æ£€æŸ¥
    if (!anecdotesFeatureBtn || !anecdotesModal || !anecdotesBox || !anecdotesInput || !anecdotesConfirmBtn) {
        console.warn('[Anecdotes] æ ¸å¿ƒå…ƒç´ æœªæ‰¾åˆ° (Box/Input/Btn Missing)ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
    }

    // ==========================================================
    // === Markdown æ¸²æŸ“å™¨ for Letter Paper ===
    // ==========================================================
    
    /**
     * è½»é‡çº§ Markdown æ¸²æŸ“å™¨
     * æ”¯æŒï¼šæ ‡é¢˜ã€ç²—ä½“ã€æ–œä½“ã€åˆ é™¤çº¿ã€ä»£ç å—ã€è¡Œå†…ä»£ç ã€åˆ—è¡¨ã€å¼•ç”¨ã€é“¾æ¥ã€å›¾ç‰‡ã€åˆ†éš”çº¿
     * @param {string} markdown - Markdown æ–‡æœ¬
     * @returns {string} - æ¸²æŸ“åçš„ HTML
     */
    function renderMarkdownForLetter(markdown) {
        if (!markdown) return '';
        
        // XSS é˜²æŠ¤ï¼šè½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦ï¼ˆä½†ä¿ç•™æˆ‘ä»¬è¦æ¸²æŸ“çš„æ ‡ç­¾ï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        let html = markdown;
        
        // 1. ä»£ç å—ï¼ˆå¿…é¡»æœ€å…ˆå¤„ç†ï¼Œé¿å…å†…éƒ¨è¢«å…¶ä»–è§„åˆ™å½±å“ï¼‰
        // æ”¯æŒ ```è¯­è¨€\nä»£ç \n``` æ ¼å¼
        html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
            const escapedCode = escapeHtml(code.trim());
            const language = lang ? ` data-lang="${escapeHtml(lang)}"` : '';
            return `<pre class="letter-code-block"${language}><code>${escapedCode}</code></pre>`;
        });
        
        // 2. è¡Œå†…ä»£ç ï¼ˆåœ¨å…¶ä»–è¡Œå†…æ ¼å¼ä¹‹å‰å¤„ç†ï¼‰
        html = html.replace(/`([^`]+)`/g, '<code class="letter-inline-code">$1</code>');
        
        // 3. æ ‡é¢˜ï¼ˆ# - ######ï¼‰
        html = html.replace(/^######\s+(.+)$/gm, '<h6 class="letter-h6">$1</h6>');
        html = html.replace(/^#####\s+(.+)$/gm, '<h5 class="letter-h5">$1</h5>');
        html = html.replace(/^####\s+(.+)$/gm, '<h4 class="letter-h4">$1</h4>');
        html = html.replace(/^###\s+(.+)$/gm, '<h3 class="letter-h3">$1</h3>');
        html = html.replace(/^##\s+(.+)$/gm, '<h2 class="letter-h2">$1</h2>');
        html = html.replace(/^#\s+(.+)$/gm, '<h1 class="letter-h1">$1</h1>');
        
        // 4. åˆ é™¤çº¿ï¼ˆå¿…é¡»åœ¨ç²—ä½“ä¹‹å‰å¤„ç†ï¼Œé¿å… ~~ è¢«è¯¯è§£æï¼‰
        html = html.replace(/~~(.+?)~~/g, '<del class="letter-strikethrough">$1</del>');
        
        // 5. ç²—ä½“ï¼ˆ**text** æˆ– __text__ï¼Œå¿…é¡»åœ¨æ–œä½“ä¹‹å‰å¤„ç†ï¼‰
        html = html.replace(/\*\*([^\*]+?)\*\*/g, '<strong class="letter-bold">$1</strong>');
        html = html.replace(/__([^_]+?)__/g, '<strong class="letter-bold">$1</strong>');
        
        // 6. æ–œä½“ï¼ˆ*text* æˆ– _text_ï¼Œä½¿ç”¨è´Ÿå‘å‰ç»é¿å…åŒ¹é…ç²—ä½“ï¼‰
        html = html.replace(/(?<!\*)\*(?!\*)([^\*]+?)\*(?!\*)/g, '<em class="letter-italic">$1</em>');
        html = html.replace(/(?<!_)_(?!_)([^_]+?)_(?!_)/g, '<em class="letter-italic">$1</em>');
        
        // 7. åˆ†éš”çº¿ï¼ˆ--- æˆ– ***ï¼‰
        html = html.replace(/^---$/gm, '<hr class="letter-hr">');
        html = html.replace(/^\*\*\*$/gm, '<hr class="letter-hr">');
        
        // 8. æ— åºåˆ—è¡¨ï¼ˆ- æˆ– * å¼€å¤´ï¼‰
        html = html.replace(/^[\-\*]\s+(.+)$/gm, '<li class="letter-li">$1</li>');
        // åŒ…è£¹ <ul>
        html = html.replace(/(<li class="letter-li">.*<\/li>\n?)+/g, (match) => {
            return `<ul class="letter-ul">${match}</ul>`;
        });
        
        // 9. æœ‰åºåˆ—è¡¨ï¼ˆ1. å¼€å¤´ï¼‰
        html = html.replace(/^\d+\.\s+(.+)$/gm, '<li class="letter-li-ordered">$1</li>');
        // åŒ…è£¹ <ol>
        html = html.replace(/(<li class="letter-li-ordered">.*<\/li>\n?)+/g, (match) => {
            return `<ol class="letter-ol">${match}</ol>`;
        });
        
        // 10. å¼•ç”¨ï¼ˆ> å¼€å¤´ï¼‰
        html = html.replace(/^>\s+(.+)$/gm, '<blockquote class="letter-blockquote">$1</blockquote>');
        // åˆå¹¶è¿ç»­çš„å¼•ç”¨
        html = html.replace(/(<blockquote class="letter-blockquote">.*<\/blockquote>\n?)+/g, (match) => {
            const content = match.replace(/<\/?blockquote[^>]*>/g, '').trim();
            return `<blockquote class="letter-blockquote">${content}</blockquote>`;
        });
        
        // 11. é“¾æ¥ï¼ˆ[text](url)ï¼‰
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="letter-link" target="_blank" rel="noopener noreferrer">$1</a>');
        
        // 12. å›¾ç‰‡ï¼ˆ![alt](url)ï¼‰
        html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" class="letter-image" loading="lazy">');
        
        // 13. æ®µè½ï¼ˆè¿ç»­çš„éç©ºè¡Œï¼‰
        const lines = html.split('\n');
        let inParagraph = false;
        let result = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // è·³è¿‡å·²ç»æ˜¯ HTML æ ‡ç­¾çš„è¡Œ
            if (line.startsWith('<') && (
                line.includes('<h') || 
                line.includes('<ul') || 
                line.includes('<ol') || 
                line.includes('<li') || 
                line.includes('<blockquote') || 
                line.includes('<pre') || 
                line.includes('<hr') ||
                line.includes('</h') ||
                line.includes('</ul') ||
                line.includes('</ol') ||
                line.includes('</blockquote') ||
                line.includes('</pre')
            )) {
                if (inParagraph) {
                    result.push('</p>');
                    inParagraph = false;
                }
                result.push(line);
            } else if (line === '') {
                if (inParagraph) {
                    result.push('</p>');
                    inParagraph = false;
                }
                result.push('');
            } else {
                if (!inParagraph) {
                    result.push('<p class="letter-paragraph">');
                    inParagraph = true;
                }
                result.push(line);
            }
        }
        
        if (inParagraph) {
            result.push('</p>');
        }
        
        html = result.join('\n');
        
        // 14. æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
        html = html.replace(/\n{3,}/g, '\n\n');
        
        return html.trim();
    }
    
    console.log('[Anecdotes] Markdown æ¸²æŸ“å™¨å·²åŠ è½½');

    let isBoxOpened = false;
    let isLetterVisible = false;

    // æ‰“å¼€é€¸äº‹ç•Œé¢
    anecdotesFeatureBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        
        if (!window.currentOpenContact) {
            alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªèŠå¤©å¯¹è¯');
            return;
        }
        
        // é‡ç½®çŠ¶æ€
        resetAnecdotesState();
        
        // æ˜¾ç¤º modal
        anecdotesModal.classList.add('active');
        console.log('[Anecdotes] é€¸äº‹ç•Œé¢å·²æ‰“å¼€');
    });

    // å…³é—­é€¸äº‹ç•Œé¢
    anecdotesCloseBtn.addEventListener('click', closeAnecdotesModal);
    // anecdotesModal.addEventListener('click', (e) => {
    //     if (e.target === anecdotesModal) closeAnecdotesModal();
    // });


    function closeAnecdotesModal() {
        anecdotesModal.classList.remove('active');
        resetAnecdotesState();
    }

    function resetAnecdotesState() {
        isBoxOpened = false;
        isLetterVisible = false;
        anecdotesBox.classList.remove('opened', 'thinking');
        anecdotesLetter.classList.remove('visible');
        letterInputView.style.display = 'block';
        letterResponseView.style.display = 'none';
        letterLoadingView.style.display = 'none';
        anecdotesInput.value = '';
        anecdotesHint.classList.remove('hidden');
        anecdotesHint.textContent = 'è½»å¯ä¿¡å°ï¼Œä¹¦å†™æ­¤åˆ»å¿ƒç»ª'; // æ¢å¤æ–‡æ¡ˆ
    }

    // ç‚¹å‡»ç›’å­ - æ‰“å¼€
    anecdotesBox.addEventListener('click', () => {
        if (anecdotesBox.classList.contains('thinking')) return; // æ€è€ƒä¸­ä¸å¯ç‚¹å‡»
        
        if (!isBoxOpened) {
            // æ‰“å¼€ç›’å­
            anecdotesBox.classList.add('opened');
            isBoxOpened = true;
            anecdotesHint.classList.add('hidden');
            
            // å»¶è¿Ÿæ˜¾ç¤ºä¿¡çº¸
            setTimeout(() => {
                anecdotesLetter.classList.add('visible');
                isLetterVisible = true;
            }, 500);
        } else {
            // æ”¶èµ·ä¿¡çº¸å’Œç›’å­
            if (isLetterVisible && letterInputView.style.display !== 'none') {
                anecdotesLetter.classList.remove('visible');
                isLetterVisible = false;
                
                setTimeout(() => {
                    anecdotesBox.classList.remove('opened');
                    isBoxOpened = false;
                    anecdotesHint.classList.remove('hidden');
                }, 300);
            }
        }
    });



    // ç¡®è®¤å‘é€
    anecdotesConfirmBtn.addEventListener('click', async () => {
        const userMessage = anecdotesInput.value.trim();
        if (!userMessage) {
            alert('ä¿¡çº¸ä¸Šè¿˜ç©ºç©ºå¦‚ä¹Ÿå‘¢...');
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        letterInputView.style.display = 'none';
        letterLoadingView.style.display = 'flex';
        anecdotesHint.textContent = 'ä¿¡ä»¶æ­£åœ¨é‚®å¯„...'; // ä¿®æ”¹æç¤ºæ–‡æ¡ˆ
        lastAnecdotesPrompt = userMessage; // ä¿å­˜æç¤ºè¯
        
        // æ”¶èµ·ä¿¡çº¸
        anecdotesLetter.classList.remove('visible');
        isLetterVisible = false;
        
        // å»¶è¿Ÿåå…³é—­ç›’å­å¹¶å¼€å§‹æ‘‡æ™ƒ
        setTimeout(() => {
            anecdotesBox.classList.remove('opened');
            isBoxOpened = false;
            
            setTimeout(() => {
                anecdotesBox.classList.add('thinking');
            }, 300);
        }, 400);

        // è°ƒç”¨ AI
        try {
            const response = await callAnecdotesAI(userMessage);
            
            // åœæ­¢æ‘‡æ™ƒ
            anecdotesBox.classList.remove('thinking');
            
            // æ‰“å¼€ç›’å­å±•ç¤ºç»“æœ
            setTimeout(() => {
                anecdotesBox.classList.add('opened');
                isBoxOpened = true;
                
                // åˆ‡æ¢åˆ°å“åº”è§†å›¾
                letterLoadingView.style.display = 'none';
                letterResponseView.style.display = 'block';
                
                // ã€æ–°å¢ã€‘ä½¿ç”¨ Markdown æ¸²æŸ“å™¨æ¸²æŸ“å†…å®¹
                anecdotesResponseContent.innerHTML = renderMarkdownForLetter(response);
                anecdotesSignature.textContent = `â€”â€” ${window.currentOpenContact.ai.name}`;
                
                // === è‡ªåŠ¨ä¿å­˜åˆ°çˆ±å“ ===
                saveAnecdoteToCollection(response, window.currentOpenContact.ai.name);
                
                // æ˜¾ç¤ºä¿¡çº¸
                setTimeout(() => {
                    anecdotesLetter.classList.add('visible');
                    isLetterVisible = true;
                }, 500);
            }, 300);
            
        } catch (error) {
            console.error('[Anecdotes] AIè°ƒç”¨å¤±è´¥:', error);
            anecdotesBox.classList.remove('thinking');
            letterLoadingView.style.display = 'none';
            letterInputView.style.display = 'block';
            alert('é‚®å·®åœ¨è·¯ä¸Šè¿·è·¯äº†...è¯·å†è¯•ä¸€æ¬¡\n' + error.message);
            
            // é‡æ–°æ˜¾ç¤ºä¿¡çº¸
            anecdotesBox.classList.add('opened');
            isBoxOpened = true;
            setTimeout(() => {
                anecdotesLetter.classList.add('visible');
                isLetterVisible = true;
            }, 300);
        }
    });

    // å†å†™ä¸€å°
    anecdotesAgainBtn.addEventListener('click', () => {
        // æ”¶èµ·ä¿¡çº¸
        anecdotesLetter.classList.remove('visible');
        isLetterVisible = false;
        
        setTimeout(() => {
            // é‡ç½®ä¸ºè¾“å…¥æ¨¡å¼
            letterResponseView.style.display = 'none';
            letterInputView.style.display = 'block';
            anecdotesInput.value = '';
            
            // é‡æ–°æ˜¾ç¤ºä¿¡çº¸
            setTimeout(() => {
                anecdotesLetter.classList.add('visible');
                isLetterVisible = true;
            }, 200);
        }, 300);
    });

    // é‡æ–°é‚®å¯„ (Remail)
    if (anecdotesRemailBtn) {
        anecdotesRemailBtn.addEventListener('click', async () => {
             if (!lastAnecdotesPrompt) {
                 alert('æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€å°ä¿¡çš„åº•ç¨¿...');
                 return;
             }
             
             // æ”¶èµ·ä¿¡çº¸åŠ¨ç”»
             anecdotesLetter.classList.remove('visible');
             isLetterVisible = false;
             
             // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
             letterResponseView.style.display = 'none';
             letterLoadingView.style.display = 'flex';
             anecdotesHint.textContent = 'ä¿¡ä»¶æ­£åœ¨é‡æ–°æŠ•é€’...';
             
             setTimeout(async () => {
                 anecdotesBox.classList.remove('opened');
                 isBoxOpened = false;
                 
                  setTimeout(() => {
                      anecdotesBox.classList.add('thinking');
                  }, 300);
                  
                  try {
                      // é‡æ–°è°ƒç”¨ AI
                      const response = await callAnecdotesAI(lastAnecdotesPrompt);
                      
                      anecdotesBox.classList.remove('thinking');
                      setTimeout(() => {
                          anecdotesBox.classList.add('opened');
                          isBoxOpened = true;
                          
                          letterLoadingView.style.display = 'none';
                          letterResponseView.style.display = 'block';
                          
                          // ã€æ–°å¢ã€‘ä½¿ç”¨ Markdown æ¸²æŸ“å™¨æ¸²æŸ“å†…å®¹
                          anecdotesResponseContent.innerHTML = renderMarkdownForLetter(response);
                          anecdotesSignature.textContent = `â€”â€” ${window.currentOpenContact ? window.currentOpenContact.ai.name : 'AI'}`;
                          
                          // è‡ªåŠ¨ä¿å­˜
                          saveAnecdoteToCollection(response, window.currentOpenContact.ai.name);
                          
                          setTimeout(() => {
                              anecdotesLetter.classList.add('visible');
                              isLetterVisible = true;
                          }, 500);
                      }, 300);
                  } catch (error) {
                      console.error('[Anecdotes] Remail failed:', error);
                      anecdotesBox.classList.remove('thinking');
                      alert('é‡æ–°é‚®å¯„å¤±è´¥...\n' + error.message);
                      anecdotesBox.classList.add('opened');
                      isBoxOpened = true;
                      anecdotesLetter.classList.add('visible');
                      isLetterVisible = true;
                  }
             }, 400);
        });
    }

    // === çˆ±å“ (Collection) é€»è¾‘ ===
    
    // æ‰“å¼€çˆ±å“
    if (anecdotesCollectionBtn) {
        anecdotesCollectionBtn.addEventListener('click', (e) => {
             e.stopPropagation();
             loadCollection();
             anecdotesCollectionModal.classList.add('active');
        });
    }
    
    // å…³é—­çˆ±å“
    if (collectionCloseBtn) {
        collectionCloseBtn.addEventListener('click', () => {
             anecdotesCollectionModal.classList.remove('active');
        });
    }
    if (anecdotesCollectionModal) {
        anecdotesCollectionModal.addEventListener('click', (e) => {
            if (e.target === anecdotesCollectionModal) {
                anecdotesCollectionModal.classList.remove('active');
            }
        });
    }

    // ä¿å­˜åˆ°çˆ±å“
    async function saveAnecdoteToCollection(content, aiName) {
        try {
            const data = await window.dbHelper.loadData('settingsStore', 'anecdotesCollection');
            let collection = (data && Array.isArray(data.value)) ? data.value : [];
            
            // è·å–å½“å‰è”ç³»äºº ID
            const currentContactId = window.currentOpenContact ? window.currentOpenContact.id : null;
            
            const newItem = {
                id: 'anecdote_' + Date.now(),
                date: new Date().toLocaleString(),
                timestamp: Date.now(),
                content: content,
                aiName: aiName,
                contactId: currentContactId, // ã€æ–°å¢ã€‘ä¿å­˜è”ç³»äºº ID
                summary: content.slice(0, 50).replace(/\n/g, ' ') + '...'
            };
            
            collection.unshift(newItem); // æ·»åŠ åˆ°å¼€å¤´
            
            await window.dbHelper.saveData('settingsStore', 'anecdotesCollection', collection);
            console.log('[Anecdotes] Saved to collection:', newItem.id, 'for contact:', currentContactId);
        } catch (e) {
            console.error('[Anecdotes] Save failed:', e);
        }
    }

    // åŠ è½½çˆ±å“åˆ—è¡¨
    async function loadCollection() {
        if (!collectionList) return;
        
        try {
            collectionList.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">åŠ è½½ä¸­...</div>';
            
            const data = await window.dbHelper.loadData('settingsStore', 'anecdotesCollection');
            let allCollection = (data && Array.isArray(data.value)) ? data.value : [];
            
            console.log(`[Anecdotes] Total items in database:`, allCollection.length);
            
            // ã€ä¿®å¤ã€‘æŒ‰å½“å‰è”ç³»äººè¿‡æ»¤ï¼Œå…¼å®¹æ—§æ•°æ®
            const currentContactId = window.currentOpenContact ? window.currentOpenContact.id : null;
            const currentAiName = window.currentOpenContact ? window.currentOpenContact.ai.name : null;
            
            let collection = allCollection;
            
            if (currentContactId) {
                collection = allCollection.filter(item => {
                    // æ–°æ•°æ®ï¼šæœ‰ contactIdï¼Œä¸¥æ ¼åŒ¹é…
                    if (item.contactId) {
                        const match = item.contactId === currentContactId;
                        console.log(`[Anecdotes] Item ${item.id}: contactId=${item.contactId}, match=${match}`);
                        return match;
                    }
                    // æ—§æ•°æ®ï¼šæ²¡æœ‰ contactIdï¼Œé€šè¿‡ aiName åŒ¹é…ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
                    else {
                        const match = item.aiName === currentAiName;
                        console.log(`[Anecdotes] Item ${item.id}: aiName=${item.aiName}, match=${match} (legacy)`);
                        return match;
                    }
                });
                console.log(`[Anecdotes] Filtered ${collection.length}/${allCollection.length} items for contact:`, currentContactId, currentAiName);
            } else {
                console.log(`[Anecdotes] No current contact, showing all ${collection.length} items`);
            }
            
            if (collection.length === 0) {
                const emptyMsg = currentContactId 
                    ? `<div style="text-align:center;color:#ccc;padding:40px;">æš‚æ— çè—...<br>å»å†™ä¸€å°ä¿¡ç»™ ${currentAiName} å§</div>`
                    : '<div style="text-align:center;color:#ccc;padding:40px;">æš‚æ— çè—...<br>å»å†™ä¸€å°ä¿¡å§</div>';
                collectionList.innerHTML = emptyMsg;
                return;
            }
            
            collectionList.innerHTML = '';
            collection.forEach(item => {
                const el = document.createElement('div');
                el.className = 'collection-item';
                el.dataset.id = item.id;
                
                // SVG Icons
                const deleteIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                const exportIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
                
                el.innerHTML = `
                    <div class="collection-date">${item.date} Â· ${item.aiName || 'AI'}</div>
                    <div class="collection-summary">${item.content}</div>
                    <div class="collection-actions">
                        <button class="collection-action-btn export-btn" title="å¯¼å‡ºTXT">${exportIcon}</button>
                        <button class="collection-action-btn delete-btn" title="åˆ é™¤">${deleteIcon}</button>
                    </div>
                `;
                
                // äº‹ä»¶ç»‘å®š
                const deleteBtn = el.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(confirm('ç¡®å®šè¦æ’•æ‰è¿™ä¸€é¡µå—ï¼Ÿ')) {
                        deleteAnecdote(item.id);
                    }
                });
                
                const exportBtn = el.querySelector('.export-btn');
                exportBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    exportAnecdote(item);
                });
                
                // ç‚¹å‡»å±•å¼€é˜…è¯»å…¨æ–‡
                el.addEventListener('click', () => {
                    el.classList.toggle('expanded');
                    const summaryDiv = el.querySelector('.collection-summary');
                    if (el.classList.contains('expanded')) {
                        summaryDiv.style.webkitLineClamp = 'unset';
                    } else {
                        summaryDiv.style.webkitLineClamp = '3';
                    }
                });
                
                collectionList.appendChild(el);
            });
            
            
        } catch (e) {
            console.error('[Anecdotes] Load collection failed:', e);
            collectionList.innerHTML = '<div style="color:red;padding:20px;">åŠ è½½å¤±è´¥</div>';
        }
    }

    // åˆ é™¤é€¸äº‹
    async function deleteAnecdote(id) {
        try {
            const data = await window.dbHelper.loadData('settingsStore', 'anecdotesCollection');
            let collection = (data && Array.isArray(data.value)) ? data.value : [];
            
            const newCollection = collection.filter(item => item.id !== id);
            await window.dbHelper.saveData('settingsStore', 'anecdotesCollection', newCollection);
            
            loadCollection(); // é‡æ–°åŠ è½½
        } catch (e) {
            console.error('Delete failed:', e);
        }
    }
    
    // å¯¼å‡ºé€¸äº‹
    function exportAnecdote(item) {
        const textToSave = `é€¸äº‹ - ${item.aiName}\næ—¥æœŸ: ${item.date}\n\n${item.content}`;
        const blob = new Blob([textToSave], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `é€¸äº‹_${item.aiName}_${item.timestamp}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ===== AI è°ƒç”¨é€»è¾‘ =====
    async function callAnecdotesAI(userMessage) {
        const contact = window.currentOpenContact;
        if (!contact) throw new Error('æœªæ‰¾åˆ°å½“å‰å¯¹è¯');

        // 1. æ”¶é›†äººè®¾ä¿¡æ¯
        const aiName = contact.name || contact.ai?.name || 'AI';
        const aiPersona = contact.ai?.persona || '';
        const userName = contact.user?.name || 'ç”¨æˆ·';
        const userPersona = contact.user?.persona || '';

        // 2. æ”¶é›†ä¸–ç•Œä¹¦å†…å®¹
        let worldBookContent = '';
        try {
            const worldBooksData = await window.dbHelper.loadData('worldBooks', 'allWorldBooks');
            const allBooks = (worldBooksData && Array.isArray(worldBooksData.value)) ? worldBooksData.value : [];
            let targetIds = new Set();
            
            // ä¼˜å…ˆä½¿ç”¨æ–°ç‰ˆå•é€‰åˆ—è¡¨
            if (contact.linkedWorldBookIds && contact.linkedWorldBookIds.length > 0) {
                 contact.linkedWorldBookIds.forEach(id => targetIds.add(id));
            } 
            // å…¼å®¹æ—§ç‰ˆåˆ†ç»„åˆ—è¡¨
            else if (contact.linkedWorldBookGroupIds && contact.linkedWorldBookGroupIds.length > 0) {
                 const groupsData = await window.dbHelper.loadData('worldBookGroups', 'allGroups');
                 const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];
                 const linkedGroupIds = new Set(contact.linkedWorldBookGroupIds);
                 allGroups.forEach(g => {
                     if (linkedGroupIds.has(g.id) && Array.isArray(g.bookIds)) {
                         g.bookIds.forEach(bid => targetIds.add(bid));
                     }
                 });
            }

            if (targetIds.size > 0) {
                 const entries = allBooks
                     .filter(b => targetIds.has(b.id))
                     .map(b => `### ä¸–ç•Œä¹¦: ${b.name}\n${b.content}`)
                     .join('\n\n');
                 if (entries) {
                     worldBookContent = `\n## ä¸–ç•Œè®¾å®šå‚è€ƒ:\n${entries}\n`;
                 }
            }
        } catch (e) {
            console.warn('[Anecdotes] åŠ è½½ä¸–ç•Œä¹¦å¤±è´¥:', e);
        }

        // 3. æ”¶é›†å¯ç”¨çš„è®°å¿†æ”¯ç¥¨
        let memoryContent = '';
        try {
            const memoryKey = `memoryCheques_${contact.id}`;
            const memoryData = await window.dbHelper.loadData('memoryCheques', memoryKey);
            const receipts = (memoryData && Array.isArray(memoryData.value)) ? memoryData.value : [];
            const activeReceipts = receipts.filter(r => r.isActive);
            
            if (activeReceipts.length > 0) {
                memoryContent = '\n## é‡è¦è®°å¿†:\n' + activeReceipts.map(r => `- ${r.content}`).join('\n') + '\n';
            }
        } catch (e) {
            console.warn('[Anecdotes] åŠ è½½è®°å¿†æ”¯ç¥¨å¤±è´¥:', e);
        }

        // 4. æ„å»º System Prompt
        const systemPrompt = `ä½ æ˜¯ä¸€ä½æ‰åæ¨ªæº¢çš„ä½œå®¶ï¼Œæ“…é•¿åˆ›ä½œç»†è…»ã€å¯Œæœ‰æƒ…æ„Ÿçš„å°ç•ªå¤–æ•…äº‹ã€‚

## è§’è‰²è®¾å®š:
ã€${aiName}çš„äººè®¾ã€‘
${aiPersona || '(æ— è¯¦ç»†äººè®¾)'}

ã€${userName}çš„äººè®¾ã€‘
${userPersona || '(æ— è¯¦ç»†äººè®¾)'}

${worldBookContent}
${memoryContent}

## åˆ›ä½œè¦æ±‚:
1. æ ¹æ®ç”¨æˆ·çš„æç¤ºï¼Œåˆ›ä½œä¸€ä¸ªçš„å°ç•ªå¤–/é€¸äº‹
2. ä»¥${aiName}çš„è§†è§’æˆ–ç¬¬ä¸‰äººç§°å™è¿°
3. æ–‡é£ç°ä»£ã€æ¸…æ–°ã€æœ‰è´¨æ„Ÿã€‚
4. ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´æ€§
5. å¯ä»¥æ˜¯æ—¥å¸¸ç‰‡æ®µã€å›å¿†ã€å¹»æƒ³æˆ–æ¸©é¦¨äº’åŠ¨
6. ä¸éœ€è¦æ ‡é¢˜ï¼Œç›´æ¥å¼€å§‹å™è¿°
7. ç»“å°¾å¯ä»¥ç¨æœ‰ç•™ç™½ï¼Œè®©äººå›å‘³
8. **å¿…é¡»ä½¿ç”¨ä¸­æ–‡è¿›è¡Œåˆ›ä½œï¼Œç»å¯¹ä¸èƒ½ä½¿ç”¨è‹±æ–‡**`;

        // 5. è°ƒç”¨ AI API - ä» dbHelper è¯»å–é…ç½®
        const settingsData = await window.dbHelper.loadData('settingsStore', 'apiSettings');
        if (!settingsData || !settingsData.value || !settingsData.value.url) {
            throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API');
        }
        const { url, key, model: savedModel, temperature: savedTemp } = settingsData.value;
        
        let completionsUrl = url.endsWith('/') ? url.slice(0, -1) : url;
        completionsUrl += '/chat/completions';

        const response = await fetch(completionsUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`
            },
            body: JSON.stringify({
                model: savedModel || 'gpt-3.5-turbo',
                messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: `è¯·æ ¹æ®ä»¥ä¸‹æç¤ºåˆ›ä½œä¸€ä¸ªå°ç•ªå¤–:\n\n${userMessage}` }
                ],
                temperature: 0.8,
                max_tokens: 200000
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        const aiResponse = data.choices?.[0]?.message?.content?.trim();

        if (!aiResponse) {
            throw new Error('AI æœªè¿”å›æœ‰æ•ˆå†…å®¹');
        }

        return aiResponse;
    }

    console.log('[Anecdotes] é€¸äº‹åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
});

// ============================================
// ğŸ“ å®šä½åŠŸèƒ½ (Location Feature)
// åˆ†äº«ä½ç½®ä¿¡æ¯å¹¶è”åŠ¨AIæ„ŸçŸ¥
// ============================================

document.addEventListener('DOMContentLoaded', () => {
    console.log('[Location] åˆå§‹åŒ–å®šä½åŠŸèƒ½...');
    
    // DOM å…ƒç´ 
    const locationFeatureBtn = document.getElementById('location-feature');
    const locationModal = document.getElementById('location-input-modal');
    const locationModalCloseBtn = document.getElementById('location-modal-close-btn');
    const locationNameInput = document.getElementById('location-name-input');
    const locationAddressInput = document.getElementById('location-address-input');
    const locationDistanceInput = document.getElementById('location-distance-input');
    const sendLocationBtn = document.getElementById('send-location-btn');
    
    // æ ¸å¿ƒå…ƒç´ æ£€æŸ¥
    if (!locationFeatureBtn || !locationModal) {
        console.warn('[Location] æ ¸å¿ƒå…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
    }
    
    // æ‰“å¼€å®šä½å¼¹çª—
    locationFeatureBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (!window.currentOpenContact) {
            alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªèŠå¤©å¯¹è¯');
            return;
        }
        
        // é‡ç½®è¾“å…¥æ¡†
        if (locationNameInput) locationNameInput.value = '';
        if (locationAddressInput) locationAddressInput.value = '';
        if (locationDistanceInput) locationDistanceInput.value = '';
        
        // æ˜¾ç¤ºå¼¹çª— - è®¾ç½® display å’Œ opacity
        locationModal.style.display = 'flex';
        requestAnimationFrame(() => {
            locationModal.style.opacity = '1';
            locationModal.classList.add('visible');
        });
        console.log('[Location] å®šä½å¼¹çª—å·²æ‰“å¼€');
    });
    
    // å…³é—­å®šä½å¼¹çª—
    function closeLocationModal() {
        locationModal.style.opacity = '0';
        locationModal.classList.remove('visible');
        setTimeout(() => {
            locationModal.style.display = 'none';
        }, 300);
    }
    
    if (locationModalCloseBtn) {
        locationModalCloseBtn.addEventListener('click', closeLocationModal);
    }
    
    locationModal.addEventListener('click', (e) => {
        if (e.target === locationModal) closeLocationModal();
    });
    
    // å‘é€å®šä½
    if (sendLocationBtn) {
        sendLocationBtn.addEventListener('click', async () => {
            const name = locationNameInput?.value.trim() || '';
            const address = locationAddressInput?.value.trim() || '';
            const distance = locationDistanceInput?.value.trim() || '0';
            
            // éªŒè¯è¾“å…¥
            if (!name) {
                alert('è¯·è¾“å…¥ä½ç½®åç§°');
                return;
            }
            
            if (!address) {
                alert('è¯·è¾“å…¥è¯¦ç»†åœ°å€');
                return;
            }
            
            if (!distance || parseFloat(distance) < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è·ç¦»ï¼ˆkmï¼‰');
                return;
            }
            
            // ç”Ÿæˆå®šä½å¡ç‰‡HTMLï¼ˆå‚è€ƒ map.htmlï¼‰
            const locationCardHTML = generateMapCard(name, address, distance);
            
            // æ·»åŠ åˆ°èŠå¤©ç•Œé¢
            await addLocationCardToChat(locationCardHTML, name, address, distance);
            
            // å…³é—­å¼¹çª—
            closeLocationModal();
            
            console.log('[Location] å®šä½å¡ç‰‡å·²å‘é€:', { name, address, distance });
        });
    }
    
    /**
     * ç”Ÿæˆåœ°å›¾å®šä½å¡ç‰‡HTMLï¼ˆå®Œå…¨å‚è€ƒ map.htmlï¼‰
     */
    function generateMapCard(name, address, distance) {
        return `
            <div class="map-card">
                <div class="info-section">
                    <div class="title">${escapeHtml(name)}</div>
                    <div class="address">${escapeHtml(address)}</div>
                </div>
                
                <div class="map-canvas">
                    <div class="river-path"></div>
                    
                    <div class="main-road h-road"></div>
                    <div class="main-road v-road"></div>

                    <div class="tree" style="top: 60px; left: 50px;"></div>
                    <div class="tree" style="top: 60px; left: 100px;"></div>
                    <div class="tree" style="top: 100px; left: 55px;"></div>

                    <div class="neighborhood" style="top: 15px; left: 10px;">
                        <div class="building" style="width: 22px; height: 28px;"></div>
                        <div class="building" style="width: 26px; height: 22px;"></div>
                        <div class="building" style="width: 30px; height: 25px;"></div>
                    </div>

                    <div class="neighborhood" style="bottom: 15px; left: 15px;">
                        <div class="building" style="width: 35px; height: 22px;"></div>
                        <div class="building" style="width: 18px; height: 18px;"></div>
                    </div>

                    <div class="marker-fixed">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="#27c34b">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                        <div class="marker-label">æˆ‘çš„ä½ç½®</div>
                    </div>
                    
                    <div class="dist-badge">è·æ‚¨ ${escapeHtml(distance)} km</div>
                </div>
            </div>
        `;
    }
    
    /**
     * HTMLè½¬ä¹‰ï¼ˆé˜²XSSï¼‰
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    /**
     * æ·»åŠ å®šä½å¡ç‰‡åˆ°èŠå¤©
     */
    async function addLocationCardToChat(cardHTML, name, address, distance) {
        if (!window.currentOpenContact) return;
        
        const contact = window.currentOpenContact;
        const timestamp = Date.now();
        const uuid = `loc_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;
        
        // åˆ›å»ºå®šä½æ¶ˆæ¯å¯¹è±¡
        const locationMessage = {
            id: timestamp,
            uuid: uuid,
            sender: 'user',
            text: cardHTML,
            timestamp: timestamp,
            type: 'location',
            locationData: {
                name: name,
                address: address,
                distance: distance,
                aiNotified: false
            }
        };
        
        // 1. ä¿å­˜å¯è§çš„å®šä½æ¶ˆæ¯åˆ°æ•°æ®åº“ (è°ƒç”¨æ ¸å¿ƒä¿å­˜å‡½æ•°ï¼Œç¡®ä¿allContactsè¢«æ›´æ–°)
        // æ³¨æ„ï¼šæˆ‘ä»¬ä½¿ç”¨æŒ‚è½½åœ¨windowä¸Šçš„saveMessageToHistoryï¼Œå› ä¸ºå®ƒå®šä¹‰åœ¨å¦ä¸€ä¸ªé—­åŒ…ä¸­
        const safeSaveFunc = window.saveMessageToHistory;
        const safeRenderFunc = window.addMessageToView;
        
        if (safeSaveFunc && typeof safeSaveFunc === 'function') {
            await safeSaveFunc(locationMessage, contact.id);
            console.log('[Location] å®šä½æ¶ˆæ¯å·²é€šè¿‡æ ‡å‡†æµç¨‹ä¿å­˜');
        } else {
            console.error('[Location] Critical: window.saveMessageToHistory not found!');
            // Fallback: update memory at least
            contact.history.push(locationMessage);
        }

        // 2. æ¸²æŸ“åˆ°ç•Œé¢
        if (safeRenderFunc && typeof safeRenderFunc === 'function') {
            safeRenderFunc(locationMessage, contact);
        }
        
        // ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        if (chatMessagesContainer) {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        console.log('[Location] å®šä½å¡ç‰‡å·²å‘é€å¹¶æ¸²æŸ“');
        
        // === AIè”åŠ¨ï¼šæ³¨å…¥å®šä½æç¤ºï¼ˆç­‰å¾…ç”¨æˆ·å‘æ¶ˆæ¯æ—¶AIå¯æ„ŸçŸ¥ï¼‰===
        const aiPromptText = `ç”¨æˆ·åˆšåˆšåˆ†äº«äº†ä¸€æ¡å®šä½ï¼Œå†…å®¹æ˜¯ï¼š${name} - ${address}ï¼Œè·ç¦» ${distance}km`;
        const systemHint = {
            id: Date.now() + 1,
            uuid: `loc_hint_${Date.now()}`,
            sender: 'system',
            text: aiPromptText,
            timestamp: Date.now(),
            type: 'location_hint',
            hidden: true,
            locationRef: uuid
        };
        
        // ä¿å­˜æç¤ºæ¶ˆæ¯åˆ°æ•°æ®åº“
        if (safeSaveFunc && typeof safeSaveFunc === 'function') {
            await safeSaveFunc(systemHint, contact.id);
            console.log('[Location] AIå®šä½æç¤ºå·²ä¿å­˜');
        }
    }
    
    console.log('[Location] å®šä½åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
});

// ==========================================================
// ç¾¤èŠè®¾ç½®é¡µé¢åˆå§‹åŒ–ä»£ç 
// ==========================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('[GroupSettingsPage] åˆå§‹åŒ–ç¾¤èŠè®¾ç½®é¡µé¢...');

    // 1. è¿”å›æŒ‰é’®
    const groupSettingsBackBtn = document.getElementById('group-settings-back-btn');
    if (groupSettingsBackBtn) {
        groupSettingsBackBtn.addEventListener('click', function() {
            const groupSettingsPage = document.getElementById('group-settings-page');
            if (groupSettingsPage) {
                groupSettingsPage.classList.add('closing');
                setTimeout(() => {
                    groupSettingsPage.classList.remove('active', 'closing');
                }, 300);
            }
        });
    }

    // 2. å¯æŠ˜å åŒºåŸŸäº¤äº’
    const collapsibleHeaders = document.querySelectorAll('#group-settings-page .collapsible-header');
    collapsibleHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const section = this.closest('.collapsible-section');
            if (section) {
                section.classList.toggle('expanded');
            }
        });
    });

    // 3. iOSé£æ ¼å¼€å…³äº¤äº’ + ä¿å­˜åˆ°æ•°æ®åº“
    const iosSwitches = document.querySelectorAll('#group-settings-page .ios-switch');
    iosSwitches.forEach(sw => {
        sw.addEventListener('click', async function() {
            this.classList.toggle('active');
            
            // ç«‹å³ä¿å­˜è®¾ç½®åˆ°æ•°æ®åº“
            if (!window.currentOpenGroup) return;
            
            const toggleId = this.id;
            const isActive = this.classList.contains('active');
            
            try {
                if (toggleId === 'group-show-avatars-toggle') {
                    window.currentOpenGroup.avatarSettings = window.currentOpenGroup.avatarSettings || {};
                    window.currentOpenGroup.avatarSettings.show = isActive;
                } else if (toggleId === 'group-show-timestamp-toggle') {
                    window.currentOpenGroup.timestampSettings = window.currentOpenGroup.timestampSettings || {};
                    window.currentOpenGroup.timestampSettings.show = isActive;
                } else if (toggleId === 'group-bilingual-bubble-toggle') {
                     window.currentOpenGroup.bilingualBubble = window.currentOpenGroup.bilingualBubble || {};
                     window.currentOpenGroup.bilingualBubble.enabled = isActive;
                }
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                const groupsData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = groupsData ? groupsData.value : [];
                const idx = allGroups.findIndex(g => g.id === window.currentOpenGroup.id);
                if (idx > -1) {
                    allGroups[idx] = window.currentOpenGroup;
                    await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                }
                console.log('[GroupSettings] æ˜¾ç¤ºè®¾ç½®å·²ä¿å­˜:', toggleId, isActive);
            } catch (err) {
                console.error('[GroupSettings] ä¿å­˜æ˜¾ç¤ºè®¾ç½®å¤±è´¥:', err);
            }
        });
    });

    // 3.5 ç¾¤æˆå‘˜åˆ é™¤æ¨¡å¼
    let isDeleteMode = false;
    const groupMemberCount = document.getElementById('group-member-count');
    if (groupMemberCount) {
        groupMemberCount.addEventListener('click', function() {
            isDeleteMode = !isDeleteMode;
            const membersGrid = document.getElementById('group-members-grid');
            if (!membersGrid) return;
            
            const deleteButtons = membersGrid.querySelectorAll('.member-delete-btn');
            
            if (isDeleteMode) {
                this.textContent = 'å®Œæˆ';
                this.style.color = '#C48888';
                // æ˜¾ç¤ºæ‰€æœ‰åˆ é™¤æŒ‰é’®
                deleteButtons.forEach(btn => btn.style.display = 'flex');
            } else {
                // æ›´æ–°æˆå‘˜æ•°é‡æ˜¾ç¤º
                const count = window.currentOpenGroup?.members?.length || 0;
                this.textContent = `${count}åç¾¤æˆå‘˜ >`;
                this.style.color = '';
                // éšè—æ‰€æœ‰åˆ é™¤æŒ‰é’®
                deleteButtons.forEach(btn => btn.style.display = 'none');
            }
        });
    }



    console.log('[GroupSettingsPage] ç¾¤èŠè®¾ç½®é¡µé¢åˆå§‹åŒ–å®Œæˆ');
});

// ==========================================================
// å•èŠè®¾ç½®é¡µé¢åˆå§‹åŒ–ä»£ç 
// ==========================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('[ChatSettingsPage] åˆå§‹åŒ–å•èŠè®¾ç½®é¡µé¢...');

    // 1. è¿”å›æŒ‰é’®
    const chatSettingsBackBtn = document.getElementById('chat-settings-back-btn');
    if (chatSettingsBackBtn) {
        chatSettingsBackBtn.addEventListener('click', function() {
            const chatSettingsPage = document.getElementById('chat-settings-page');
            if (chatSettingsPage) {
                chatSettingsPage.classList.add('closing');
                setTimeout(() => {
                    chatSettingsPage.classList.remove('active', 'closing');
                }, 300);
            }
        });
    }

    // 2. è§’è‰²/ç”¨æˆ·åˆ‡æ¢
    const chatRoleTabAi = document.getElementById('chat-role-tab-ai');
    const chatRoleTabUser = document.getElementById('chat-role-tab-user');
    const chatAiForm = document.getElementById('chat-ai-form');
    const chatUserForm = document.getElementById('chat-user-form');
    const chatSettingsAvatar = document.getElementById('chat-settings-avatar');
    const chatSettingsName = document.getElementById('chat-settings-name');

    if (chatRoleTabAi && chatRoleTabUser) {
        chatRoleTabAi.addEventListener('click', function() {
            chatRoleTabAi.classList.add('active');
            chatRoleTabUser.classList.remove('active');
            if (chatAiForm) chatAiForm.style.display = 'block';
            if (chatUserForm) chatUserForm.style.display = 'none';
            // æ›´æ–°å¤´éƒ¨æ˜¾ç¤ºAIå¤´åƒ
            if (window.currentOpenContact && chatSettingsAvatar) {
                chatSettingsAvatar.style.backgroundImage = `url('${window.currentOpenContact.ai.avatar}')`;
                chatSettingsName.textContent = window.currentOpenContact.ai.name;
            }
        });
        chatRoleTabUser.addEventListener('click', function() {
            chatRoleTabUser.classList.add('active');
            chatRoleTabAi.classList.remove('active');
            if (chatUserForm) chatUserForm.style.display = 'block';
            if (chatAiForm) chatAiForm.style.display = 'none';
            // æ›´æ–°å¤´éƒ¨æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
            if (window.currentOpenContact && chatSettingsAvatar) {
                chatSettingsAvatar.style.backgroundImage = `url('${window.currentOpenContact.user.avatar}')`;
                chatSettingsName.textContent = window.currentOpenContact.user.name;
            }
        });
    }

    // 3. å¯æŠ˜å åŒºåŸŸäº¤äº’
    const collapsibleHeaders = document.querySelectorAll('#chat-settings-page .collapsible-header');
    collapsibleHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const section = this.closest('.collapsible-section');
            if (section) {
                section.classList.toggle('expanded');
            }
        });
    });

    // 4. iOSé£æ ¼å¼€å…³äº¤äº’
    const iosSwitches = document.querySelectorAll('#chat-settings-page .ios-switch');
    iosSwitches.forEach(sw => {
        sw.addEventListener('click', function() {
            this.classList.toggle('active');
        });
    });

    // 5. å¤´åƒä¸Šä¼  (AI)
    const chatAvatarUploadInput = document.getElementById('chat-avatar-upload-input');
    const profileAvatarWrapper = document.querySelector('#chat-settings-page .profile-avatar-wrapper');
    if (profileAvatarWrapper && chatAvatarUploadInput) {
        profileAvatarWrapper.addEventListener('click', function() {
            chatAvatarUploadInput.click();
        });
        chatAvatarUploadInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file || !window.currentOpenContact) return;

            // ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æµ‹å¹¶è§£é™¤å¯¹è±¡å¼•ç”¨ï¼ˆé˜²æ­¢Userå’ŒAIæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼‰
            if (window.currentOpenContact.ai && window.currentOpenContact.user && window.currentOpenContact.ai === window.currentOpenContact.user) {
                console.log('Detected AI and User sharing same object, unlinking...');
                window.currentOpenContact.user = JSON.parse(JSON.stringify(window.currentOpenContact.user));
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Data = event.target.result;
                if (chatSettingsAvatar) {
                    chatSettingsAvatar.style.backgroundImage = `url('${base64Data}')`;
                }

                // æ ¹æ®å½“å‰é€‰ä¸­çš„tabæ›´æ–°å¯¹åº”çš„å¤´åƒ
                const aiTab = document.getElementById('chat-role-tab-ai');
                if (aiTab && aiTab.classList.contains('active')) {
                    window.currentOpenContact.ai.avatar = base64Data;
                    const aiNameInput = document.getElementById('chat-ai-name-input');
                    if (aiNameInput) aiNameInput.value = window.currentOpenContact.ai.name;
                } else {
                    window.currentOpenContact.user.avatar = base64Data;
                    // åŒæ­¥æ›´æ–°ä¸‹æ–¹ç”¨æˆ·ç¼–è¾‘åŒºåŸŸçš„é¢„è§ˆå›¾
                    const userPreview = document.getElementById('chat-user-avatar-preview');
                    if (userPreview) {
                        userPreview.style.backgroundImage = `url('${base64Data}')`;
                    }
                }
            };
            reader.readAsDataURL(file);
        });
    }

    // 6. ç”¨æˆ·å¤´åƒä¸Šä¼ 
    const chatUserAvatarBtn = document.getElementById('chat-user-avatar-btn');
    const chatUserAvatarInput = document.getElementById('chat-user-avatar-input');
    const chatUserAvatarPreview = document.getElementById('chat-user-avatar-preview');
    if (chatUserAvatarBtn && chatUserAvatarInput) {
        chatUserAvatarBtn.addEventListener('click', function() {
            chatUserAvatarInput.click();
        });
        chatUserAvatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Data = event.target.result;
                if (chatUserAvatarPreview) {
                    chatUserAvatarPreview.style.backgroundImage = `url('${base64Data}')`;
                }
                if (window.currentOpenContact) {
                    window.currentOpenContact.user.avatar = base64Data;
                }
            };
            reader.readAsDataURL(file);
        });
    }

    // 7. èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ 
    const chatBgInput = document.getElementById('chat-bg-input');
    if (chatBgInput) {
        chatBgInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file || !window.currentOpenContact) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                const base64Data = event.target.result;
                
                const bgPreview = document.getElementById('chat-bg-preview');
                const bgPlaceholder = document.getElementById('chat-bg-placeholder');
                const bgPreviewBox = document.getElementById('chat-bg-preview-box');
                
                if (bgPreview) {
                    bgPreview.src = base64Data;
                    bgPreview.style.display = 'block';
                }
                if (bgPlaceholder) bgPlaceholder.style.display = 'none';
                if (bgPreviewBox) bgPreviewBox.classList.add('has-bg');
                
                // ä¿å­˜åˆ°è”ç³»äººæ•°æ®
                window.currentOpenContact.chatBackground = base64Data;
            };
            reader.readAsDataURL(file);
        });
    }

    // 8. æ¸…é™¤èƒŒæ™¯
    const chatClearBgBtn = document.getElementById('chat-clear-bg-btn');
    if (chatClearBgBtn) {
        chatClearBgBtn.addEventListener('click', function() {
            const bgPreview = document.getElementById('chat-bg-preview');
            const bgPlaceholder = document.getElementById('chat-bg-placeholder');
            const bgPreviewBox = document.getElementById('chat-bg-preview-box');
            
            if (bgPreview) {
                bgPreview.src = '';
                bgPreview.style.display = 'none';
            }
            if (bgPlaceholder) bgPlaceholder.style.display = 'flex';
            if (bgPreviewBox) bgPreviewBox.classList.remove('has-bg');
            
            if (window.currentOpenContact) {
                window.currentOpenContact.chatBackground = null;
            }
        });
    }

    // 9. æ¸…ç©ºèŠå¤©è®°å½•
    const chatClearHistoryBtn = document.getElementById('chat-clear-history-btn');
    if (chatClearHistoryBtn) {
        chatClearHistoryBtn.addEventListener('click', async function() {
            if (!window.currentOpenContact) return;
            
            if (confirm('è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰è®°å½•ï¼Œä¸”æ— æ³•æ¢å¤ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                try {
                    const contactsData = await window.dbHelper.loadData('messageContacts', 'allContacts');
                    let allContacts = contactsData ? contactsData.value : [];
                    const idx = allContacts.findIndex(c => c.id === window.currentOpenContact.id);
                    if (idx > -1) {
                        allContacts[idx].history = [];
                        allContacts[idx].lastMessage = 'èŠå¤©è®°å½•å·²æ¸…ç©º';
                        await window.dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                        
                        window.currentOpenContact.history = [];
                        window.currentOpenContact.lastMessage = 'èŠå¤©è®°å½•å·²æ¸…ç©º';
                        
                        const chatMessagesContainer = document.getElementById('chat-messages-container');
                        if (chatMessagesContainer) {
                            chatMessagesContainer.innerHTML = '';
                        }
                        
                        alert('èŠå¤©è®°å½•å·²æˆåŠŸæ¸…é™¤ï¼');
                    }
                } catch (err) {
                    console.error('[ChatSettings] æ¸…ç©ºè®°å½•å¤±è´¥:', err);
                    alert('æ¸…ç©ºå¤±è´¥ï¼š' + err.message);
                }
            }
        });
    }

    // 10. æ‹‰é»‘è”ç³»äºº
    const chatBlockBtn = document.getElementById('chat-block-btn');
    if (chatBlockBtn) {
        chatBlockBtn.addEventListener('click', async function() {
            if (!window.currentOpenContact) return;
            
            const isBlocked = window.currentOpenContact.isBlocked;
            const action = isBlocked ? 'è§£é™¤æ‹‰é»‘' : 'æ‹‰é»‘';
            
            if (confirm(`ç¡®å®šè¦${action}è¯¥è”ç³»äººå—ï¼Ÿ`)) {
                try {
                    window.currentOpenContact.isBlocked = !isBlocked;
                    
                    const contactsData = await window.dbHelper.loadData('messageContacts', 'allContacts');
                    let allContacts = contactsData ? contactsData.value : [];
                    const idx = allContacts.findIndex(c => c.id === window.currentOpenContact.id);
                    if (idx > -1) {
                        allContacts[idx].isBlocked = !isBlocked;
                        await window.dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                    }
                    
                    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                    chatBlockBtn.textContent = isBlocked ? 'æ‹‰é»‘è”ç³»äºº' : 'è§£é™¤æ‹‰é»‘';
                    alert(`å·²${action}è¯¥è”ç³»äºº`);
                } catch (err) {
                    console.error('[ChatSettings] æ“ä½œå¤±è´¥:', err);
                    alert('æ“ä½œå¤±è´¥ï¼š' + err.message);
                }
            }
        });
    }

    // 11. ä¿å­˜è®¾ç½®æŒ‰é’®
    const saveChatSettingsNewBtn = document.getElementById('save-chat-settings-new-btn');
    if (saveChatSettingsNewBtn) {
        saveChatSettingsNewBtn.addEventListener('click', async function() {
            if (!window.currentOpenContact) return;
            
            try {
                // æ”¶é›†è¡¨å•æ•°æ®
                const contact = window.currentOpenContact;
                
                
                // è§’è‰²ä¿¡æ¯
                const aiNameInput = document.getElementById('chat-ai-name-input');
                const aiPersonaInput = document.getElementById('chat-ai-persona-input');
                const aiMemoryInput = document.getElementById('chat-context-memory-input');
                const chatSettingsAvatar = document.getElementById('chat-settings-avatar');
                
                contact.ai.name = aiNameInput ? aiNameInput.value : contact.ai.name;
                contact.ai.persona = aiPersonaInput ? aiPersonaInput.value : '';
                contact.contextMemory = aiMemoryInput ? (parseInt(aiMemoryInput.value) || 0) : contact.contextMemory || 0;
                if (chatSettingsAvatar && chatSettingsAvatar.style.backgroundImage) {
                    // ã€æ ¸å¿ƒä¿®å¤ã€‘ä»…å½“AIæ ‡ç­¾é¡µæ¿€æ´»æ—¶ï¼Œæ‰ä»é¡¶éƒ¨å¤´åƒè¯»å–å¹¶ä¿å­˜ä¸ºAIå¤´åƒ
                    // é˜²æ­¢åœ¨Useræ ‡ç­¾é¡µæ—¶ï¼Œé¡¶éƒ¨æ˜¾ç¤ºçš„æ˜¯Userå¤´åƒï¼Œå¯¼è‡´AIå¤´åƒè¢«é”™è¯¯çš„Userå¤´åƒè¦†ç›–
                    const aiTab = document.getElementById('chat-role-tab-ai');
                    if (aiTab && aiTab.classList.contains('active')) {
                        contact.ai.avatar = chatSettingsAvatar.style.backgroundImage.slice(5, -2);
                    }
                }
                
                // ç”¨æˆ·ä¿¡æ¯
                const userNameInput = document.getElementById('chat-user-name-input');
                const userPersonaInput = document.getElementById('chat-user-persona-input');
                const chatSettingsUserAvatar = document.getElementById('chat-user-avatar-preview');
                
                contact.user = contact.user || {};
                contact.user.name = userNameInput ? userNameInput.value : contact.user.name;
                contact.user.persona = userPersonaInput ? userPersonaInput.value : '';
                if (chatSettingsUserAvatar && chatSettingsUserAvatar.style.backgroundImage) {
                    contact.user.avatar = chatSettingsUserAvatar.style.backgroundImage.slice(5, -2);
                }
                
                // ä¸–ç•Œä¹¦è®¾ç½® (ä»å¤šé€‰ç»„ä»¶è·å–)
                const wbContainer = document.getElementById('chat-worldbook-select-container');
                if (wbContainer) {
                    // è¿™é‡Œå‡è®¾ renderWorldBookMultiselect å·²ç»å¤„ç†äº†æ•°æ®çš„ç»‘å®šå’Œä¿å­˜
                }
                
                // æ˜¾ç¤ºè®¾ç½®
                contact.avatarSettings = {
                    show: document.getElementById('chat-show-avatars-toggle')?.classList.contains('active'),
                    // ä¿®å¤ï¼šä¸è¦ä½¿ç”¨ parseIntï¼Œä¿ç•™ç™¾åˆ†æ¯”æˆ–pxå•ä½
                    radius: document.getElementById('chat-avatar-radius-input')?.value || '50%'
                };
                contact.timestampSettings = {
                    show: document.getElementById('chat-show-timestamp-toggle')?.classList.contains('active')
                };
                contact.enableDefaultStickers = document.getElementById('chat-default-stickers-toggle')?.classList.contains('active');
                contact.enableMonologue = document.getElementById('chat-monologue-toggle')?.classList.contains('active');
                contact.enableBilingualBubble = document.getElementById('chat-bilingual-toggle')?.classList.contains('active');
                contact.enableWBStickers = document.getElementById('chat-wb-stickers-toggle')?.classList.contains('active');
                
                // æ°”æ³¡æ ·å¼
                contact.customBubbleCss = document.getElementById('chat-bubble-css-input')?.value || '';
                
                // æŒ‚ä»¶è®¾ç½®
                contact.ai.avatarPendant = {
                    url: document.getElementById('chat-ai-pendant-url')?.value || '',
                    css: document.getElementById('chat-ai-pendant-css')?.value || ''
                };
                contact.user.avatarPendant = {
                    url: document.getElementById('chat-user-pendant-url')?.value || '',
                    css: document.getElementById('chat-user-pendant-css')?.value || ''
                };
                
                // MiniMax TTS éŸ³è‰²ID
                const ttsVoiceInput = document.getElementById('chat-tts-voice-input');
                const ttsLanguageInput = document.getElementById('chat-tts-language-input');
                contact.ttsVoiceId = ttsVoiceInput ? ttsVoiceInput.value.trim() : (contact.ttsVoiceId || '');
                contact.ttsLanguage = ttsLanguageInput ? ttsLanguageInput.value : (contact.ttsLanguage || '');
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                const contactsData = await window.dbHelper.loadData('messageContacts', 'allContacts');
                let allContacts = contactsData ? contactsData.value : [];
                const idx = allContacts.findIndex(c => c.id === contact.id);
                if (idx > -1) {
                    allContacts[idx] = contact;
                    await window.dbHelper.saveData('messageContacts', 'allContacts', allContacts);
                    
                    // â–¼â–¼â–¼ ã€å…³é”®ä¿®å¤ã€‘åŒæ­¥æ›´æ–°å…¨å±€ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡æ‰“å¼€èŠå¤©æ—¶è¯»å–åˆ°æœ€æ–°æ•°æ® â–¼â–¼â–¼
                    if (typeof Global_AllContactsCache !== 'undefined' && Global_AllContactsCache) {
                        const cacheIdx = Global_AllContactsCache.findIndex(c => c.id === contact.id);
                        if (cacheIdx > -1) {
                            Global_AllContactsCache[cacheIdx] = contact;
                            console.log('[ChatSettings] å…¨å±€ç¼“å­˜å·²åŒæ­¥æ›´æ–°');
                        }
                    }
                    // â–²â–²â–² ç¼“å­˜åŒæ­¥ç»“æŸ â–²â–²â–²
                }
                
                // === ç«‹å³åº”ç”¨è®¾ç½®åˆ°å½“å‰ç•Œé¢ ===
                
                // â–¼â–¼â–¼ ã€é‡è¦ä¿®å¤ã€‘è°ƒç”¨ initializeChatStyles å®Œæ•´åº”ç”¨æ‰€æœ‰è®¾ç½® â–¼â–¼â–¼
                const chatMessagesContainer = document.getElementById('chat-messages-container');
                if (chatMessagesContainer) {
                    // åº”ç”¨èƒŒæ™¯
                    if (contact.chatBackground) {
                        chatMessagesContainer.style.backgroundImage = `url('${contact.chatBackground}')`;
                        chatMessagesContainer.style.backgroundSize = 'cover';
                        chatMessagesContainer.style.backgroundPosition = 'center';
                        chatMessagesContainer.style.backgroundRepeat = 'no-repeat';
                    } else {
                        chatMessagesContainer.style.backgroundImage = '';
                        chatMessagesContainer.style.backgroundSize = '';
                        chatMessagesContainer.style.backgroundPosition = '';
                        chatMessagesContainer.style.backgroundRepeat = '';
                    }
                    
                    // åº”ç”¨å¤´åƒæ˜¾ç¤º/éšè—è®¾ç½®
                    const avatarSettings = contact.avatarSettings || { show: true, radius: '50%' };
                    chatMessagesContainer.classList.toggle('hide-avatars', !avatarSettings.show);
                    
                    // åº”ç”¨æ—¶é—´æˆ³æ˜¾ç¤º/éšè—è®¾ç½®
                    const timestampSettings = contact.timestampSettings || { show: false };
                    chatMessagesContainer.classList.toggle('hide-timestamps', !timestampSettings.show);
                }
                
                // æ›´æ–°å¤´éƒ¨ä¿¡æ¯
                const chatAiAvatar = document.getElementById('chat-ai-avatar');
                const chatAiName = document.getElementById('chat-ai-name');
                const chatContactName = document.getElementById('chat-contact-name');
                if (chatAiAvatar) chatAiAvatar.src = contact.ai.avatar;
                if (chatAiName) chatAiName.textContent = contact.ai.name;
                if (chatContactName) chatContactName.textContent = contact.ai.name;
                
                // â–¼â–¼â–¼ ã€ä¿®å¤ã€‘ä½¿ç”¨ç»Ÿä¸€çš„ custom-bubble-styles æ ‡ç­¾ï¼Œé¿å…å¤šæ ‡ç­¾æ±¡æŸ“ â–¼â–¼â–¼
                const customBubbleStyles = document.getElementById('custom-bubble-styles');
                if (customBubbleStyles) {
                    // ä½¿ç”¨ä¸ initializeChatStyles ç›¸åŒçš„é€»è¾‘æ¥åº”ç”¨æ°”æ³¡æ ·å¼
                    const defaultBubbleCss = `.user-bubble {
    align-self: flex-end;
    max-width: 85%;
    border-radius: 12px 12px 12px 12px;
    font-size: 14px;
    color: #D1D9D3;
    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;
    background: #2F3633; 
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border-left: 1px solid rgba(255, 255, 255, 0.05);
    margin-bottom: 0px;
}
.ai-bubble {
    align-self: flex-start;
    max-width: 85%;
    border-radius: 12px 12px 12px 12px;
    font-size: 14px;
    color: #5F6360;
    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;
    background: #E8EAE9;
    border: none;
    margin-bottom: 0px;
}`;
                    customBubbleStyles.innerHTML = contact.customBubbleCss || defaultBubbleCss;
                }
                // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
                
                alert('è®¾ç½®å·²ä¿å­˜ï¼Œéƒ¨åˆ†åŠŸèƒ½éœ€é€€å‡ºå†è¿›å…¥èŠå¤©ç•Œé¢ç”Ÿæ•ˆï¼');
                
                // å…³é—­è®¾ç½®é¡µ
                const chatSettingsPage = document.getElementById('chat-settings-page');
                if (chatSettingsPage) {
                    chatSettingsPage.classList.add('closing');
                    setTimeout(() => {
                        chatSettingsPage.classList.remove('active', 'closing');
                    }, 300);
                }
            } catch (err) {
                console.error('[ChatSettings] ä¿å­˜å¤±è´¥:', err);
                alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
            }
        });
    }

    // 12. æŒ‚ä»¶æ¸…é™¤æŒ‰é’®
    const chatAiPendantClear = document.getElementById('chat-ai-pendant-clear');
    if (chatAiPendantClear) {
        chatAiPendantClear.addEventListener('click', function() {
            document.getElementById('chat-ai-pendant-url').value = '';
            document.getElementById('chat-ai-pendant-css').value = '';
            alert('è§’è‰²æŒ‚ä»¶å·²æ¸…é™¤ï¼Œä¿å­˜åç”Ÿæ•ˆ');
        });
    }
    const chatUserPendantClear = document.getElementById('chat-user-pendant-clear');
    if (chatUserPendantClear) {
        chatUserPendantClear.addEventListener('click', function() {
            document.getElementById('chat-user-pendant-url').value = '';
            document.getElementById('chat-user-pendant-css').value = '';
            alert('ç”¨æˆ·æŒ‚ä»¶å·²æ¸…é™¤ï¼Œä¿å­˜åç”Ÿæ•ˆ');
        });
    }

    // 13. æ°”æ³¡é¢„è®¾ç›¸å…³æŒ‰é’®
    const chatBubblePresetBtn = document.getElementById('chat-bubble-preset-btn');
    if (chatBubblePresetBtn) {
        chatBubblePresetBtn.addEventListener('click', function() {
            // å¤ç”¨ç°æœ‰çš„é€‰æ‹©å¼¹çª—é€»è¾‘
            const modal = document.getElementById('bubble-preset-select-modal');
            const list = document.getElementById('bubble-preset-select-list');
            const empty = document.getElementById('bubble-preset-select-empty');
            
            if (modal && list) {
                // æ¸²æŸ“åˆ—è¡¨
                const presets = JSON.parse(localStorage.getItem('bubblePresets') || '[]');
                list.innerHTML = '';
                
                if (presets.length === 0) {
                    if (empty) empty.style.display = 'block';
                } else {
                    if (empty) empty.style.display = 'none';
                    presets.forEach((preset, index) => {
                        const item = document.createElement('div');
                        item.className = 'preset-select-item';
                        item.style.padding = '12px';
                        item.style.borderBottom = '1px solid #eee';
                        item.style.cursor = 'pointer';
                        item.style.backgroundColor = '#fff';
                        item.style.marginBottom = '8px';
                        item.style.borderRadius = '8px';
                        
                        const previewText = preset.css.length > 50 ? preset.css.substring(0, 50) + '...' : preset.css;
                        item.innerHTML = `
                            <div style="font-weight:bold;margin-bottom:4px;">${preset.name}</div>
                            <div style="font-size:12px;color:#888;">${previewText}</div>
                        `;
                        
                        item.onclick = function() {
                            const cssInput = document.getElementById('chat-bubble-css-input');
                            if (cssInput) cssInput.value = preset.css;
                            modal.style.display = 'none';
                        };
                        
                        list.appendChild(item);
                    });
                }
                modal.style.display = 'flex';
            } else {
                alert('æœªæ‰¾åˆ°é¢„è®¾é€‰æ‹©ç»„ä»¶');
            }
        });
    }

    const chatBubbleSaveBtn = document.getElementById('chat-bubble-save-btn');
    if (chatBubbleSaveBtn) {
        chatBubbleSaveBtn.addEventListener('click', function() {
            const css = document.getElementById('chat-bubble-css-input')?.value;
            if (!css || css.trim() === '') {
                alert('è¯·å…ˆè¾“å…¥CSSæ ·å¼');
                return;
            }
            // é»˜è®¤åç§°
            const existing = JSON.parse(localStorage.getItem('bubblePresets') || '[]');
            const presetName = prompt('è¯·è¾“å…¥é¢„è®¾åç§°:', 'æˆ‘çš„æ°”æ³¡ ' + (existing.length + 1));
            if (!presetName || presetName.trim() === '') return;
            
            try {
                // ä½¿ç”¨ localStorage ä¿å­˜åˆ° bubblePresets
                const presets = JSON.parse(localStorage.getItem('bubblePresets') || '[]');
                presets.unshift({ 
                    name: presetName.trim(), 
                    css: css,
                    createdAt: Date.now()
                });
                localStorage.setItem('bubblePresets', JSON.stringify(presets));
                alert('é¢„è®¾å·²ä¿å­˜ï¼');
            } catch (err) {
                console.error('[ChatSettings] ä¿å­˜é¢„è®¾å¤±è´¥:', err);
                alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
            }
        });
    }

    const chatBubbleRestoreBtn = document.getElementById('chat-bubble-restore-btn');
    if (chatBubbleRestoreBtn) {
        chatBubbleRestoreBtn.addEventListener('click', function() {
            // æ¢å¤é»˜è®¤æ°”æ³¡æ ·å¼
            const defaultCss = '';
            document.getElementById('chat-bubble-css-input').value = defaultCss;
            alert('å·²æ¢å¤é»˜è®¤æ ·å¼ï¼Œä¿å­˜åç”Ÿæ•ˆ');
        });
    }

    // 14. ç¾¤èŠè®¾ç½®ä¿å­˜æŒ‰é’®
    const saveGroupSettingsBtn = document.getElementById('save-group-settings-btn');
    if (saveGroupSettingsBtn) {
        saveGroupSettingsBtn.addEventListener('click', async function() {
            if (!window.currentOpenGroup) return;

            try {
                const group = window.currentOpenGroup;

                // é‡æ–°è·å–æ˜¾ç¤ºè®¾ç½®çŠ¶æ€ï¼Œä»¥é˜²ä¸‡ä¸€
                group.avatarSettings = {
                    show: document.getElementById('group-show-avatars-toggle')?.classList.contains('active')
                };
                group.timestampSettings = {
                    show: document.getElementById('group-show-timestamp-toggle')?.classList.contains('active')
                };

                // ä¿å­˜åˆ°æ•°æ®åº“
                const groupsData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = groupsData ? groupsData.value : [];
                const idx = allGroups.findIndex(g => g.id === group.id);
                if (idx > -1) {
                    allGroups[idx] = group;
                    await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                    console.log('[GroupSettings] Group saved to DB:', group.id);
                } else {
                    console.error('[GroupSettings] Error: Current group not found in DB loading list. ID:', group.id);
                    // Fallback: try finding with type conversion
                    const idx2 = allGroups.findIndex(g => String(g.id) === String(group.id));
                     if (idx2 > -1) {
                        allGroups[idx2] = group;
                        await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                        console.log('[GroupSettings] Group saved to DB (type coerced):', group.id);
                    } else {
                        alert('ä¿å­˜å¤±è´¥ï¼šæ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è¯¥ç¾¤ç»„ã€‚');
                        return;
                    }
                }
                
                // ç«‹å³åº”ç”¨è®¾ç½®åˆ°èŠå¤©ç•Œé¢
                const chatMessagesContainer = document.getElementById('chat-messages-container');
                if (chatMessagesContainer) {
                    // åº”ç”¨èƒŒæ™¯
                    if (group.chatBackground) {
                        chatMessagesContainer.style.backgroundImage = `url('${group.chatBackground}')`;
                        chatMessagesContainer.style.backgroundSize = 'cover';
                        chatMessagesContainer.style.backgroundPosition = 'center';
                        chatMessagesContainer.style.backgroundRepeat = 'no-repeat';
                    } else {
                        // å®Œæ•´æ¸…é™¤èƒŒæ™¯
                        chatMessagesContainer.style.backgroundImage = '';
                        chatMessagesContainer.style.backgroundSize = '';
                        chatMessagesContainer.style.backgroundPosition = '';
                        chatMessagesContainer.style.backgroundRepeat = '';
                    }
                    
                    // åº”ç”¨å¤´åƒæ˜¾ç¤ºè®¾ç½®
                    if (group.avatarSettings && group.avatarSettings.show === false) {
                        chatMessagesContainer.classList.add('hide-avatars');
                    } else {
                        chatMessagesContainer.classList.remove('hide-avatars');
                    }
                    
                    // åº”ç”¨æ—¶é—´æˆ³æ˜¾ç¤ºè®¾ç½®
                    if (group.timestampSettings && group.timestampSettings.show === true) {
                        chatMessagesContainer.classList.remove('hide-timestamps');
                    } else {
                        chatMessagesContainer.classList.add('hide-timestamps');
                    }
                }

                alert('ç¾¤èŠè®¾ç½®å·²ä¿å­˜ï¼');
                
                // å…³é—­è®¾ç½®é¡µ
                const groupSettingsPage = document.getElementById('group-settings-page');
                if (groupSettingsPage) {
                    groupSettingsPage.classList.remove('active');
                }

            } catch (err) {
                console.error('ä¿å­˜ç¾¤èŠè®¾ç½®å¤±è´¥:', err);
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
            }
        });
    }

    console.log('[ChatSettingsPage] å•èŠè®¾ç½®é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    
    // === è¡¥å…¨ç¾¤èŠè®¾ç½®çš„å…¶ä»–åŠŸèƒ½ (å¼ºåˆ¶é‡å†™) ===

    // 14. é‡æ–°ç»‘å®šç¾¤èŠä¿å­˜æŒ‰é’® (Cloning to remove old listeners)
    const oldGroupSaveBtn = document.getElementById('save-group-settings-btn');
    if (oldGroupSaveBtn) {
        const newGroupSaveBtn = oldGroupSaveBtn.cloneNode(true);
        oldGroupSaveBtn.parentNode.replaceChild(newGroupSaveBtn, oldGroupSaveBtn);
        
        newGroupSaveBtn.addEventListener('click', async function() {
            if (!window.currentOpenGroup) return;

            try {
                const group = window.currentOpenGroup;

                // é‡æ–°è·å–æ˜¾ç¤ºè®¾ç½®çŠ¶æ€
                group.avatarSettings = {
                    show: document.getElementById('group-show-avatars-toggle')?.classList.contains('active')
                };
                group.timestampSettings = {
                    show: document.getElementById('group-show-timestamp-toggle')?.classList.contains('active')
                };

                // ä¿å­˜åˆ°æ•°æ®åº“
                const groupsData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = groupsData ? groupsData.value : [];
                const idx = allGroups.findIndex(g => g.id === group.id);
                if (idx > -1) {
                    allGroups[idx] = group;
                    await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                    console.log('[GroupSettings] Group saved to DB:', group.id);
                } else {
                    console.error('[GroupSettings] Error: Current group not found in DB loading list. ID:', group.id);
                     const idx2 = allGroups.findIndex(g => String(g.id) === String(group.id));
                     if (idx2 > -1) {
                        allGroups[idx2] = group;
                        await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                    } else {
                         alert('ä¿å­˜å¤±è´¥ï¼šæ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è¯¥ç¾¤ç»„ã€‚');
                         return;
                    }
                }
                
                // ç«‹å³åº”ç”¨è®¾ç½®åˆ°èŠå¤©ç•Œé¢
                const chatMessagesContainer = document.getElementById('chat-messages-container');
                if (chatMessagesContainer) {
                    // åº”ç”¨èƒŒæ™¯
                    if (group.chatBackground) {
                        chatMessagesContainer.style.backgroundImage = `url('${group.chatBackground}')`;
                        chatMessagesContainer.style.backgroundSize = 'cover';
                        chatMessagesContainer.style.backgroundPosition = 'center';
                        chatMessagesContainer.style.backgroundRepeat = 'no-repeat';
                    } else {
                        // å®Œæ•´æ¸…é™¤èƒŒæ™¯
                        chatMessagesContainer.style.backgroundImage = '';
                        chatMessagesContainer.style.backgroundSize = '';
                        chatMessagesContainer.style.backgroundPosition = '';
                        chatMessagesContainer.style.backgroundRepeat = '';
                    }
                    
                    // åº”ç”¨å¤´åƒæ˜¾ç¤ºè®¾ç½®
                    if (group.avatarSettings && group.avatarSettings.show === false) {
                        chatMessagesContainer.classList.add('hide-avatars');
                    } else {
                        chatMessagesContainer.classList.remove('hide-avatars');
                    }
                    
                    // åº”ç”¨æ—¶é—´æˆ³æ˜¾ç¤ºè®¾ç½®
                    if (group.timestampSettings && group.timestampSettings.show === true) {
                        chatMessagesContainer.classList.remove('hide-timestamps');
                    } else {
                        chatMessagesContainer.classList.add('hide-timestamps');
                    }
                }

                alert('ç¾¤èŠè®¾ç½®å·²ä¿å­˜ï¼Œéƒ¨åˆ†åŠŸèƒ½éœ€é€€å‡ºå†è¿›å…¥èŠå¤©ç•Œé¢ç”Ÿæ•ˆï¼ï¼');
                
                // å…³é—­è®¾ç½®é¡µ
                const groupSettingsPage = document.getElementById('group-settings-page');
                if (groupSettingsPage) {
                    groupSettingsPage.classList.remove('active');
                }

            } catch (err) {
                console.error('ä¿å­˜ç¾¤èŠè®¾ç½®å¤±è´¥:', err);
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
            }
        });
    }

    // 15. ç¾¤èŠèƒŒæ™¯ä¸Šä¼ 
    const groupBgInput = document.getElementById('group-chat-bg-input');
    if (groupBgInput) {
        groupBgInput.addEventListener('change', function(e) {
            console.log('[GroupSettings] Background input changed');
            const file = e.target.files[0];
            if (!file) return;
            
            if (!window.currentOpenGroup) {
                console.error('[GroupSettings] currentOpenGroup is null during background upload');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const base64 = event.target.result;
                console.log('[GroupSettings] Background loaded, length:', base64.length);
                
                const preview = document.getElementById('group-chat-bg-preview');
                const placeholder = document.getElementById('group-chat-bg-placeholder');
                const box = document.getElementById('group-chat-bg-preview-box');
                
                if (preview) { preview.src = base64; preview.style.display = 'block'; }
                if (placeholder) placeholder.style.display = 'none';
                if (box) box.classList.add('has-bg');
                
                window.currentOpenGroup.chatBackground = base64;
                window.currentOpenGroup.backgroundImage = base64; // åŒæ­¥æ›´æ–°ä»¥é˜²å›æ»š
                console.log('[GroupSettings] currentOpenGroup.chatBackground set');

                // Auto-save to DB
                (async () => {
                    try {
                        const groupsData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                        let allGroups = groupsData ? groupsData.value : [];
                        const idx = allGroups.findIndex(g => g.id === window.currentOpenGroup.id);
                        if (idx > -1) {
                            allGroups[idx] = window.currentOpenGroup;
                            await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                            
                            // æ›´æ–°èŠå¤©ç•Œé¢èƒŒæ™¯
                            const chatMessagesContainer = document.getElementById('chat-messages-container');
                            if (chatMessagesContainer) {
                                chatMessagesContainer.style.backgroundImage = `url('${base64}')`;
                                chatMessagesContainer.style.backgroundSize = 'cover';
                                chatMessagesContainer.style.backgroundPosition = 'center';
                            }
                        }
                    } catch (e) { console.error("AutoSave BG Failed", e); }
                })();
            };
            reader.readAsDataURL(file);
        });
    }

    // 16. ç¾¤èŠæ¸…é™¤èƒŒæ™¯
    const groupClearBgBtn = document.getElementById('group-clear-bg-btn');
    if (groupClearBgBtn) {
        groupClearBgBtn.addEventListener('click', function() {
            const preview = document.getElementById('group-chat-bg-preview');
            const placeholder = document.getElementById('group-chat-bg-placeholder');
            const box = document.getElementById('group-chat-bg-preview-box');
            
            if (preview) { preview.src = ''; preview.style.display = 'none'; }
            if (placeholder) placeholder.style.display = 'flex';
            if (box) box.classList.remove('has-bg');
            

            
            if (window.currentOpenGroup) {
                 window.currentOpenGroup.chatBackground = null;
                 window.currentOpenGroup.backgroundImage = null; // åŒæ­¥æ¸…é™¤
                 // Auto-save clearing
                 (async () => {
                    try {
                        const groupsData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                        let allGroups = groupsData ? groupsData.value : [];
                        const idx = allGroups.findIndex(g => g.id === window.currentOpenGroup.id);
                        if (idx > -1) {
                            allGroups[idx] = window.currentOpenGroup;
                            await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                            
                            // æ¸…é™¤èŠå¤©ç•Œé¢èƒŒæ™¯
                            const chatMessagesContainer = document.getElementById('chat-messages-container');
                            if (chatMessagesContainer) {
                                chatMessagesContainer.style.backgroundImage = '';
                            }
                        }
                    } catch (e) { console.error("AutoSave Clear BG Failed", e); }
                 })();
            }
        });
    }
    
    // 17. ç¾¤èŠæ¸…ç©ºè®°å½•
    const groupClearHistoryBtn = document.getElementById('group-clear-history-btn');
    if (groupClearHistoryBtn) {
        groupClearHistoryBtn.addEventListener('click', async function() {
            if (!window.currentOpenGroup) return;
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºç¾¤ç»„èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) return;

            try {
                window.currentOpenGroup.history = [];
                window.currentOpenGroup.lastMessage = 'èŠå¤©è®°å½•å·²æ¸…ç©º';
                
                const groupsData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = groupsData ? groupsData.value : [];
                const idx = allGroups.findIndex(g => g.id === window.currentOpenGroup.id);
                if (idx > -1) {
                    allGroups[idx].history = [];
                    allGroups[idx].lastMessage = 'èŠå¤©è®°å½•å·²æ¸…ç©º';
                    await window.dbHelper.saveData('groupChats', 'allGroupChats', allGroups);
                }
                
                const container = document.getElementById('chat-messages-container');
                if (container) container.innerHTML = '';
                
                 alert('èŠå¤©è®°å½•å·²æ¸…ç©º');
            } catch (err) {
                console.error(err);
                alert('æ“ä½œå¤±è´¥');
            }
        });
    }
    
    // 18. è§£æ•£ç¾¤èŠ
    const groupDeleteBtn = document.getElementById('group-delete-btn');
    if (groupDeleteBtn) {
        groupDeleteBtn.addEventListener('click', async function() {
            if (!window.currentOpenGroup) return;
            if (!confirm('ç¡®å®šè¦è§£æ•£å¹¶åˆ é™¤è¯¥ç¾¤èŠå—ï¼Ÿ')) return;
            
            try {
                const id = window.currentOpenGroup.id;
                const groupsData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                let allGroups = groupsData ? groupsData.value : [];
                const newGroups = allGroups.filter(g => g.id !== id);
                await window.dbHelper.saveData('groupChats', 'allGroupChats', newGroups);
                
                document.getElementById('group-settings-page')?.classList.remove('active');
                document.getElementById('chat-screen')?.classList.remove('active');
                
                if (typeof loadChatGroups === 'function') loadChatGroups();
                else window.location.reload();
                
            } catch (err) {
                console.error(err);
                alert('æ“ä½œå¤±è´¥');
            }
        });
    }
    
    console.log('[ChatSettingsPage] ç¾¤èŠåŠŸèƒ½è¡¥å…¨å®Œæ¯•');
});

// æ‰“å¼€å•èŠè®¾ç½®å…¨å±é¡µé¢
window.openChatSettingsPage = async function() {
    if (!window.currentOpenContact) return;
    
    console.log('[openChatSettingsPage] æ‰“å¼€å•èŠè®¾ç½®é¡µé¢');
    
    const chatSettingsPage = document.getElementById('chat-settings-page');
    if (!chatSettingsPage) {
        console.error('chat-settings-page not found');
        return;
    }
    
    const contact = window.currentOpenContact;
    
    // å¡«å……å¤´éƒ¨ä¿¡æ¯
    const chatSettingsAvatar = document.getElementById('chat-settings-avatar');
    const chatSettingsName = document.getElementById('chat-settings-name');
    if (chatSettingsAvatar) chatSettingsAvatar.style.backgroundImage = `url('${contact.ai.avatar}')`;
    if (chatSettingsName) chatSettingsName.textContent = contact.ai.name;
    
    // é‡ç½®ä¸ºAIè¡¨å•
    const chatRoleTabAi = document.getElementById('chat-role-tab-ai');
    const chatRoleTabUser = document.getElementById('chat-role-tab-user');
    const chatAiForm = document.getElementById('chat-ai-form');
    const chatUserForm = document.getElementById('chat-user-form');
    if (chatRoleTabAi) chatRoleTabAi.classList.add('active');
    if (chatRoleTabUser) chatRoleTabUser.classList.remove('active');
    if (chatAiForm) chatAiForm.style.display = 'block';
    if (chatUserForm) chatUserForm.style.display = 'none';
    
    // AIè¡¨å•æ•°æ®
    document.getElementById('chat-ai-name-input').value = contact.ai.name || '';
    document.getElementById('chat-ai-persona-input').value = contact.ai.persona || '';
    document.getElementById('chat-context-memory-input').value = contact.contextMemory || 10;
    
    // ç”¨æˆ·è¡¨å•æ•°æ®
    document.getElementById('chat-user-name-input').value = contact.user.name || '';
    document.getElementById('chat-user-persona-input').value = contact.user.persona || '';
    const chatUserAvatarPreview = document.getElementById('chat-user-avatar-preview');
    if (chatUserAvatarPreview) chatUserAvatarPreview.style.backgroundImage = `url('${contact.user.avatar}')`;
    
    // æ˜¾ç¤ºè®¾ç½®å¼€å…³çŠ¶æ€
    const avatarSettings = contact.avatarSettings || { show: true, radius: '50%' };
    const timestampSettings = contact.timestampSettings || { show: false };
    
    const toggles = {
        'chat-show-avatars-toggle': avatarSettings.show !== false,
        'chat-show-timestamp-toggle': timestampSettings.show === true,
        'chat-default-stickers-toggle': contact.enableDefaultStickers !== false,
        'chat-monologue-toggle': contact.enableMonologue !== false,
        'chat-bilingual-toggle': contact.enableBilingualBubble === true,
        'chat-wb-stickers-toggle': contact.enableWBStickers !== false
    };
    
    Object.entries(toggles).forEach(([id, active]) => {
        const el = document.getElementById(id);
        if (el) {
            if (active) el.classList.add('active');
            else el.classList.remove('active');
        }
    });
    
    document.getElementById('chat-avatar-radius-input').value = avatarSettings.radius || '50%';
    
    // æ°”æ³¡CSS
    document.getElementById('chat-bubble-css-input').value = contact.customBubbleCss || '';
    
    // æŒ‚ä»¶è®¾ç½®
    const aiPendant = contact.ai.avatarPendant || { url: '', css: '' };
    const userPendant = contact.user.avatarPendant || { url: '', css: '' };
    document.getElementById('chat-ai-pendant-url').value = aiPendant.url || '';
    document.getElementById('chat-ai-pendant-css').value = aiPendant.css || '';
    document.getElementById('chat-user-pendant-url').value = userPendant.url || '';
    document.getElementById('chat-user-pendant-css').value = userPendant.css || '';
    
    // èƒŒæ™¯é¢„è§ˆ
    const bgPreview = document.getElementById('chat-bg-preview');
    const bgPlaceholder = document.getElementById('chat-bg-placeholder');
    const bgPreviewBox = document.getElementById('chat-bg-preview-box');
    if (contact.chatBackground) {
        if (bgPreview) {
            bgPreview.src = contact.chatBackground;
            bgPreview.style.display = 'block';
        }
        if (bgPlaceholder) bgPlaceholder.style.display = 'none';
        if (bgPreviewBox) bgPreviewBox.classList.add('has-bg');
    } else {
        if (bgPreview) {
            bgPreview.src = '';
            bgPreview.style.display = 'none';
        }
        if (bgPlaceholder) bgPlaceholder.style.display = 'flex';
        if (bgPreviewBox) bgPreviewBox.classList.remove('has-bg');
    }
    
    // MiniMax TTS éŸ³è‰²ID
    const ttsVoiceInput = document.getElementById('chat-tts-voice-input');
    if (ttsVoiceInput) {
        ttsVoiceInput.value = contact.ttsVoiceId || '';
    }
    const ttsLanguageInput = document.getElementById('chat-tts-language-input');
    if (ttsLanguageInput) {
        ttsLanguageInput.value = contact.ttsLanguage || '';
    }
    
    // æ‹‰é»‘æŒ‰é’®çŠ¶æ€
    const chatBlockBtn = document.getElementById('chat-block-btn');
    if (chatBlockBtn) {
        chatBlockBtn.textContent = contact.isBlocked ? 'è§£é™¤æ‹‰é»‘' : 'æ‹‰é»‘è”ç³»äºº';
    }
    
    // æ¸²æŸ“ä¸–ç•Œä¹¦å¤šé€‰
    const wbContainer = document.getElementById('chat-worldbook-select-container');
    if (wbContainer && typeof window.renderWorldBookMultiselect === 'function') {
        await window.renderWorldBookMultiselect(wbContainer, contact, false);
    }
    
    // æŠ˜å æ‰€æœ‰å¯æŠ˜å åŒºåŸŸ
    chatSettingsPage.querySelectorAll('.collapsible-section').forEach(section => {
        if (!section.id || (!section.id.includes('ai-form') && !section.id.includes('user-form'))) {
            section.classList.remove('expanded');
        }
    });
    
    // æ˜¾ç¤ºé¡µé¢
    chatSettingsPage.classList.add('active');
};


/**
 * =========================================================================
 *  World Book Multiselect - London Afternoon Style (Beautified)
 * =========================================================================
 * Replaces the ugly default selector with a premium, collapsible card UI.
 */
window.renderWorldBookMultiselect = async function(container, targetObj, autoSave = false) {
    if (!container) return;
    container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">åŠ è½½ä¸–ç•Œä¹¦æ•°æ®...</div>';

    try {
        // 1. Load Data
        const booksData = await window.dbHelper.loadData('worldBooks', 'allWorldBooks');
        const groupsData = await window.dbHelper.loadData('worldBookGroups', 'allGroups');
        
        const allBooks = (booksData && Array.isArray(booksData.value)) ? booksData.value : [];
        const allGroups = (groupsData && Array.isArray(groupsData.value)) ? groupsData.value : [];

        // 2. Prepare Selection State
        // Ensure linkedWorldBookIds exists
        if (!targetObj.linkedWorldBookIds) targetObj.linkedWorldBookIds = [];
        const selectedIds = new Set(targetObj.linkedWorldBookIds);

        // 3. Clear Container
        container.innerHTML = '';
        
        // 4. Helper to create SVG icons
        const createSvgIcon = (type) => {
            if (type === 'book') return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`;
            if (type === 'chevron') return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
            if (type === 'check') return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            return '';
        };

        // 5. Render Groups
        if (allGroups.length === 0 && allBooks.length === 0) {
            container.innerHTML = '<div style="padding:30px;text-align:center;color:#999;font-size:13px;">æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·å…ˆå»åˆ›å»º</div>';
            return;
        }

        // --- Render "Uncategorized" books first or last? Let's render Groups first. ---
        
        // Helper to update storage
        const updateStorage = async () => {
             targetObj.linkedWorldBookIds = Array.from(selectedIds);
             
             if (autoSave && targetObj.id) {
                 // Determine store based on targetObj type (Group or Contact)
                 // Heuristic: Groups have 'members' array, Contacts have 'ai' object
                 try {
                     if (targetObj.members && Array.isArray(targetObj.members)) {
                         // It's a Group Chat
                         const gData = await window.dbHelper.loadData('groupChats', 'allGroupChats');
                         const groups = gData ? gData.value : [];
                         const idx = groups.findIndex(g => g.id === targetObj.id);
                         if (idx > -1) {
                             groups[idx] = targetObj;
                             await window.dbHelper.saveData('groupChats', 'allGroupChats', groups);
                             console.log('[WB] Group Saved');
                         }
                     } else if (targetObj.ai && targetObj.user) {
                         // It's a Single Contact
                         const cData = await window.dbHelper.loadData('messageContacts', 'allContacts');
                         const contacts = cData ? cData.value : [];
                         const idx = contacts.findIndex(c => c.id === targetObj.id);
                         if (idx > -1) {
                             contacts[idx] = targetObj;
                             await window.dbHelper.saveData('messageContacts', 'allContacts', contacts);
                             console.log('[WB] Contact Saved');
                         }
                     }
                 } catch (e) {
                     console.error('[WB] AutoSave Error', e);
                 }
             }
        };

        // Render each group
        allGroups.forEach(group => {
            const groupBooks = allBooks.filter(b => (group.bookIds || []).includes(b.id));
            if (groupBooks.length === 0) return; // Skip empty groups

            const groupCard = document.createElement('div');
            groupCard.className = 'wb-group-card';
            
            // Check if any in group is selected to decide initial expanded state?
            // Maybe expand if selected? Or keep collapsed for neatness. Let's keep collapsed.
            // But if ALL selected, maybe show that in header?
            
            const isAllSelected = groupBooks.every(b => selectedIds.has(b.id));
            const selectedCount = groupBooks.reduce((acc, b) => acc + (selectedIds.has(b.id) ? 1 : 0), 0);
            
            // HTML Structure
            groupCard.innerHTML = `
                <div class="wb-group-header">
                    <div class="wb-group-info">
                        <div class="wb-group-icon">${createSvgIcon('book')}</div>
                        <div class="wb-group-name">${group.name} <span style="font-weight:400;color:#999;font-size:12px;margin-left:4px;">(${selectedCount}/${groupBooks.length})</span></div>
                    </div>
                    <div class="wb-group-actions">
                        <button class="wb-select-all-btn">${isAllSelected ? 'å…¨æ¶ˆ' : 'å…¨é€‰'}</button>
                        <div class="wb-expand-icon">${createSvgIcon('chevron')}</div>
                    </div>
                </div>
                <div class="wb-group-content">
                    <!-- Books go here -->
                </div>
            `;

            // Expand/Collapse Logic
            const header = groupCard.querySelector('.wb-group-header');
            const content = groupCard.querySelector('.wb-group-content');
            const expandIcon = groupCard.querySelector('.wb-expand-icon');
            const selectAllBtn = groupCard.querySelector('.wb-select-all-btn');
            const countLabel = groupCard.querySelector('.wb-group-name span');

            // Toggle Expand
            header.onclick = (e) => {
                if (e.target === selectAllBtn) return; // Prevent collapse when clicking Select All
                groupCard.classList.toggle('expanded');
            };

            // Select All Logic
            selectAllBtn.onclick = async () => {
                const currentIsAll = selectAllBtn.textContent === 'å…¨æ¶ˆ';
                
                if (currentIsAll) {
                    // Deselect all
                    groupBooks.forEach(b => selectedIds.delete(b.id));
                    selectAllBtn.textContent = 'å…¨é€‰';
                } else {
                    // Select all
                    groupBooks.forEach(b => selectedIds.add(b.id));
                    selectAllBtn.textContent = 'å…¨æ¶ˆ';
                }
                
                // Update UI for all items in this group
                const itemRows = content.querySelectorAll('.wb-item-row');
                itemRows.forEach(row => {
                    const id = parseInt(row.dataset.id);
                    if (selectedIds.has(id)) row.classList.add('selected');
                    else row.classList.remove('selected');
                });
                
                // Update Count
                const newCount = groupBooks.reduce((acc, b) => acc + (selectedIds.has(b.id) ? 1 : 0), 0);
                countLabel.textContent = `(${newCount}/${groupBooks.length})`;

                await updateStorage();
            };

            // Render Books
            groupBooks.forEach(book => {
                const itemRow = document.createElement('div');
                itemRow.className = 'wb-item-row';
                if (selectedIds.has(book.id)) itemRow.classList.add('selected');
                itemRow.dataset.id = book.id;

                itemRow.innerHTML = `
                    <div class="wb-checkbox-custom">${createSvgIcon('check')}</div>
                    <div class="wb-item-name">${book.name}</div>
                `;

                itemRow.onclick = async (e) => {
                    e.stopPropagation(); // Prevent bubbling if needed
                    
                    if (selectedIds.has(book.id)) {
                        selectedIds.delete(book.id);
                        itemRow.classList.remove('selected');
                    } else {
                        selectedIds.add(book.id);
                        itemRow.classList.add('selected');
                    }

                    // Update Group Header State
                    const newCount = groupBooks.reduce((acc, b) => acc + (selectedIds.has(b.id) ? 1 : 0), 0);
                    countLabel.textContent = `(${newCount}/${groupBooks.length})`;
                    
                    const newAllSelected = groupBooks.every(b => selectedIds.has(b.id));
                    selectAllBtn.textContent = newAllSelected ? 'å…¨æ¶ˆ' : 'å…¨é€‰';

                    await updateStorage();
                };

                content.appendChild(itemRow);
            });

            container.appendChild(groupCard);
        });

        // 6. Handle Uncategorized Books
        const categorizedBookIds = new Set();
        allGroups.forEach(g => (g.bookIds || []).forEach(id => categorizedBookIds.add(id)));
        
        const uncategorizedBooks = allBooks.filter(b => !categorizedBookIds.has(b.id));
        
        if (uncategorizedBooks.length > 0) {
            const miscGroupCard = document.createElement('div');
            miscGroupCard.className = 'wb-group-card';
             const selectedCount = uncategorizedBooks.reduce((acc, b) => acc + (selectedIds.has(b.id) ? 1 : 0), 0);
            
             miscGroupCard.innerHTML = `
                <div class="wb-group-header">
                    <div class="wb-group-info">
                        <div class="wb-group-icon" style="background:#E0E0E0;color:#888;">${createSvgIcon('book')}</div>
                        <div class="wb-group-name">æœªåˆ†ç±» <span style="font-weight:400;color:#999;font-size:12px;margin-left:4px;">(${selectedCount}/${uncategorizedBooks.length})</span></div>
                    </div>
                    <div class="wb-expand-icon">${createSvgIcon('chevron')}</div>
                </div>
                <div class="wb-group-content"></div>
            `;
            
            const content = miscGroupCard.querySelector('.wb-group-content');
            
            // Expand logic
            miscGroupCard.querySelector('.wb-group-header').onclick = () => {
                miscGroupCard.classList.toggle('expanded');
            };

            const countLabel = miscGroupCard.querySelector('.wb-group-name span');

            uncategorizedBooks.forEach(book => {
                const itemRow = document.createElement('div');
                itemRow.className = 'wb-item-row';
                if (selectedIds.has(book.id)) itemRow.classList.add('selected');
                
                itemRow.innerHTML = `
                    <div class="wb-checkbox-custom">${createSvgIcon('check')}</div>
                    <div class="wb-item-name">${book.name}</div>
                `;
                
                itemRow.onclick = async () => {
                   if (selectedIds.has(book.id)) {
                        selectedIds.delete(book.id);
                        itemRow.classList.remove('selected');
                    } else {
                        selectedIds.add(book.id);
                        itemRow.classList.add('selected');
                    }
                    const newCount = uncategorizedBooks.reduce((acc, b) => acc + (selectedIds.has(b.id) ? 1 : 0), 0);
                    countLabel.textContent = `(${newCount}/${uncategorizedBooks.length})`;
                    await updateStorage();
                };
                content.appendChild(itemRow);
            });
            
            container.appendChild(miscGroupCard);
        }

    } catch (err) {
        console.error('Render WB Multiselect Failed', err);
        container.innerHTML = '<div style="color:red;padding:20px;">åŠ è½½å¤±è´¥</div>';
    }
};

