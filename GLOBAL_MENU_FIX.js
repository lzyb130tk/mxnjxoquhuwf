/**
 * 群聊长按菜单修复
 * 
 * 原理：检测页面加载完成后，如果菜单不存在则动态创建
 * 这样单聊和群聊都能使用同一个菜单
 */

(function() {
    'use strict';
    
    // 等待DOM加载完成
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGlobalMenu);
    } else {
        initGlobalMenu();
    }
    
    function initGlobalMenu() {
        // 检查菜单是否已存在
        let menu = document.getElementById('msg-action-menu');
        
        if (menu) {
            // 菜单已存在，将其移到phone-frame的直接子元素
            // 这样可以在所有screen中显示
            const phoneFrame = document.querySelector('.phone-frame');
            if (phoneFrame && menu.parentElement !== phoneFrame) {
                console.log('[菜单修复] 将菜单移到全局位置');
                phoneFrame.appendChild(menu);
                menu.classList.add('global-menu');
            }
        } else {
            // 菜单不存在，创建一个
            console.log('[菜单修复] 创建全局菜单');
            createGlobalMenu();
        }
    }
    
    function createGlobalMenu() {
        const phoneFrame = document.querySelector('.phone-frame');
        if (!phoneFrame) {
            console.error('[菜单修复] 找不到phone-frame');
            return;
        }
        
        const menu = document.createElement('div');
        menu.id = 'msg-action-menu';
        menu.className = 'global-menu';
        
        menu.innerHTML = `
            <button class="action-menu-btn" id="menu-reply-btn">
              <svg width="20" height="20" viewBox="0 0 28 28" fill="none">
                <path d="M12.4492 24.4922C13.2461 24.4922 13.8203 23.9062 13.8203 23.1211V18.6445H14.1602C18.707 18.6445 21.5664 19.793 23.6172 23.625C24.0273 24.375 24.5664 24.4922 25.0586 24.4922C25.6797 24.4922 26.2656 23.9297 26.2656 22.9219C26.2656 14.2617 22.5977 8.85938 14.1602 8.85938H13.8203V4.42969C13.8203 3.64453 13.2461 3 12.4258 3C11.8516 3 11.4648 3.24609 10.8438 3.83203L1.59766 12.4805C1.14062 12.9141 1 13.3477 1 13.7461C1 14.1328 1.15234 14.5781 1.59766 15L10.8438 23.7305C11.4062 24.2578 11.875 24.4922 12.4492 24.4922ZM11.7812 21.9727C11.7109 21.9727 11.6406 21.9375 11.582 21.8672L3.22656 13.9688C3.13281 13.875 3.09766 13.8164 3.09766 13.7461C3.09766 13.6758 3.13281 13.6055 3.22656 13.5234L11.5703 5.51953C11.6289 5.47266 11.6992 5.42578 11.7695 5.42578C11.875 5.42578 11.9336 5.49609 11.9336 5.58984V10.2422C11.9336 10.5117 12.0625 10.6289 12.332 10.6289H13.9023C21.9414 10.6289 24.3672 16.207 24.6016 21.7383C24.6016 21.832 24.5664 21.8672 24.5078 21.8672C24.4609 21.8672 24.4375 21.832 24.4023 21.75C23.0195 18.8086 19.4688 16.875 13.9023 16.875H12.332C12.0625 16.875 11.9336 16.9922 11.9336 17.2617V21.7969C11.9336 21.9023 11.875 21.9727 11.7812 21.9727Z" fill="white" fill-opacity="0.85"/>
              </svg>
              <span>引用</span>
            </button>
            
            <button class="action-menu-btn" id="menu-select-btn">
              <svg width="20" height="20" viewBox="0 0 28 28" fill="none">
                <path d="M14.6055 21.5352H26.3711C26.8633 21.5352 27.2734 21.1484 27.2734 20.6562C27.2734 20.1523 26.8633 19.7656 26.3711 19.7656H14.6055C14.1133 19.7656 13.7148 20.1523 13.7148 20.6562C13.7148 21.1484 14.1133 21.5352 14.6055 21.5352Z" fill="white" fill-opacity="0.85"/>
                <path d="M6.05078 25.707C8.80469 25.707 11.1016 23.4102 11.1016 20.6562C11.1016 17.8789 8.80469 15.5938 6.05078 15.5938C3.28516 15.5938 1 17.8906 1 20.6562C1 23.4102 3.29688 25.707 6.05078 25.707ZM6.05078 23.996C4.23438 23.996 2.71094 22.4609 2.71094 20.6562C2.71094 18.8398 4.24609 17.3047 6.05078 17.3047C7.85547 17.3047 9.39062 18.8398 9.39062 20.6562C9.39062 22.4609 7.85547 23.996 6.05078 23.996Z" fill="white" fill-opacity="0.85"/>
                <path d="M14.6055 7.98828H26.3711C26.8633 7.98828 27.2734 7.60156 27.2734 7.09766C27.2734 6.60547 26.8633 6.21875 26.3711 6.21875H14.6055C14.1133 6.21875 13.7148 6.60547 13.7148 7.09766C13.7148 7.60156 14.1133 7.98828 14.6055 7.98828Z" fill="white" fill-opacity="0.85"/>
                <path d="M6.05078 12.1367C8.80469 12.1367 11.1016 9.85156 11.1016 7.09766C11.1016 4.33203 8.80469 2.03516 6.05078 2.03516C3.28516 2.03516 1 4.33203 1 7.09766C1 9.85156 3.29688 12.1367 6.05078 12.1367ZM5.45312 9.80469C5.20703 9.80469 5.04297 9.67578 4.86719 9.47656L3.55469 7.89453C3.4375 7.76562 3.40234 7.625 3.40234 7.4375C3.40234 7.09766 3.66016 6.82812 3.97656 6.82812C4.19922 6.82812 4.36328 6.92188 4.51562 7.12109L5.42969 8.28125L7.51562 4.92969C7.65625 4.71875 7.83203 4.60156 8.04297 4.60156C8.37109 4.60156 8.65234 4.85938 8.65234 5.15234C8.65234 5.31641 8.60547 5.45703 8.5 5.63281L6.05078 9.47656C5.92188 9.6875 5.71094 9.80469 5.45312 9.80469Z" fill="white" fill-opacity="0.85"/>
              </svg>
              <span>多选</span>
            </button>

            <button class="action-menu-btn" id="menu-copy-btn">
              <svg width="20" height="20" viewBox="0 0 28 30" fill="none">
                <path d="M20.1301 3.08969C19.7082 0.675623 18.302 -0.320471 15.9231 0.0896854L5.03637 2.01156C2.65746 2.43344 1.67309 3.83969 2.09496 6.26547L4.87231 22.0389C5.3059 24.4295 6.71215 25.4373 9.09106 25.0272L19.9778 23.1053C22.345 22.6834 23.3411 21.2655 22.9075 18.8514L20.1301 3.08969ZM18.2903 3.44125L21.0442 19.1444C21.2434 20.2928 20.7512 21.0545 19.5559 21.2655L8.85668 23.1522C7.66137 23.3631 6.93481 22.8241 6.72387 21.6756L3.95824 5.9725C3.75902 4.81234 4.26293 4.06234 5.45824 3.8514L16.1457 1.96469C17.3411 1.75375 18.0676 2.28109 18.2903 3.44125Z" fill="white" fill-opacity="0.85"/>
                <path d="M26.7864 9.69898C26.7864 7.24976 25.5793 6.01929 23.1536 6.01929H12.1028C9.68872 6.01929 8.46997 7.24976 8.46997 9.69898V25.7068C8.46997 28.156 9.68872 29.3865 12.1028 29.3865H23.1536C25.5676 29.3865 26.7864 28.156 26.7864 25.7068V9.69898Z" fill="white"/>
                <path d="M26.7864 9.69898C26.7864 7.24976 25.5793 6.01929 23.1536 6.01929H12.1028C9.68872 6.01929 8.46997 7.24976 8.46997 9.69898V25.7068C8.46997 28.156 9.68872 29.3865 12.1028 29.3865H23.1536C25.5676 29.3865 26.7864 28.156 26.7864 25.7068V9.69898ZM24.8996 9.73414V25.6833C24.8996 26.8318 24.2786 27.4997 23.0598 27.4997H12.2082C10.9895 27.4997 10.3567 26.8318 10.3567 25.6833V9.73414C10.3567 8.56226 10.9895 7.90601 12.2082 7.90601H23.0598C24.2786 7.90601 24.8996 8.56226 24.8996 9.73414Z" fill="white" fill-opacity="0.85"/>
              </svg>
              <span>复制</span>
            </button>
            
            <button class="action-menu-btn" id="menu-delete-btn">
              <svg width="20" height="20" viewBox="0 0 28 29" fill="none">
                <path d="M10.875 22.3242C11.3203 22.3242 11.6133 22.043 11.6016 21.6328L11.2383 9.09375C11.2266 8.68359 10.9336 8.41406 10.5117 8.41406C10.0664 8.41406 9.77344 8.69531 9.78516 9.10547L10.1367 21.6328C10.1484 22.0547 10.4414 22.3242 10.875 22.3242ZM14.3438 22.3242C14.7891 22.3242 15.1055 22.043 15.1055 21.6328V9.10547C15.1055 8.69531 14.7891 8.41406 14.3438 8.41406C13.8984 8.41406 13.5938 8.69531 13.5938 9.10547V21.6328C13.5938 22.043 13.8984 22.3242 14.3438 22.3242ZM17.8242 22.3242C18.2461 22.3242 18.5391 22.0547 18.5508 21.6328L18.9023 9.10547C18.9141 8.69531 18.6211 8.41406 18.1758 8.41406C17.7539 8.41406 17.4609 8.68359 17.4492 9.10547L17.0977 21.6328C17.0859 22.043 17.3789 22.3242 17.8242 22.3242ZM9.19922 5.35547H11.0625V2.84766C11.0625 2.17969 11.5312 1.74609 12.2344 1.74609H16.4297C17.1328 1.74609 17.6016 2.17969 17.6016 2.84766V5.35547H19.4648V2.73047C19.4648 1.03125 18.3633 0 16.5586 0H12.1055C10.3008 0 9.19922 1.03125 9.19922 2.73047V5.35547ZM3.87891 6.29297H24.8203C25.3008 6.29297 25.6875 5.88281 25.6875 5.40234C25.6875 4.92188 25.3008 4.52344 24.8203 4.52344H3.87891C3.41016 4.52344 3 4.92188 3 5.40234C3 5.89453 3.41016 6.29297 3.87891 6.29297ZM8.97656 26.0977H19.7227C21.3984 26.0977 22.5234 25.0078 22.6055 23.332L23.4258 6.07031H21.5391L20.7539 23.1328C20.7305 23.8359 20.2266 24.3281 19.5352 24.3281H9.14062C8.47266 24.3281 7.96875 23.8242 7.93359 23.1328L7.10156 6.07031H5.26172L6.09375 23.3438C6.17578 25.0195 7.27734 26.0977 8.97656 26.0977Z" fill="white" fill-opacity="1"/>
              </svg>
              <span>删除</span>
            </button>
        `;
        
        phoneFrame.appendChild(menu);
        console.log('[菜单修复] 全局菜单已创建');
    }
})();
